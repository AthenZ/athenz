


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Athenz User Guide">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.7">
    
    
      
        <title>Athenz Service Identity X.509 Certificate for AWS Lambda functions - Athenz</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.b8ac9624.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#domain-registration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Athenz" class="md-header-nav__button md-logo" aria-label="Athenz">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Athenz
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Athenz Service Identity X.509 Certificate for AWS Lambda functions
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/yahoo/athenz/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Athenz" class="md-nav__button md-logo" aria-label="Athenz">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Athenz
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/yahoo/athenz/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Getting Started
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Getting Started
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="About" class="md-nav__link">
      About
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dev_environment/" title="Development Environment" class="md-nav__link">
      Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-3" type="checkbox" id="nav-1-3">
    
    <label class="md-nav__link" for="nav-1-3">
      Local/Development Environment Setup
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Local/Development Environment Setup" data-md-level="2">
      <label class="md-nav__title" for="nav-1-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Local/Development Environment Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zms/" title="ZMS Server" class="md-nav__link">
      ZMS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zts/" title="ZTS Server" class="md-nav__link">
      ZTS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_ui/" title="UI Server" class="md-nav__link">
      UI Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-4" type="checkbox" id="nav-1-4">
    
    <label class="md-nav__link" for="nav-1-4">
      Production Environment Setup
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Production Environment Setup" data-md-level="2">
      <label class="md-nav__title" for="nav-1-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Production Environment Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zms_prod/" title="ZMS Server" class="md-nav__link">
      ZMS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zts_prod/" title="ZTS Server" class="md-nav__link">
      ZTS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_ui_prod/" title="UI Server" class="md-nav__link">
      UI Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-5" type="checkbox" id="nav-1-5">
    
    <label class="md-nav__link" for="nav-1-5">
      Service Identity Registration
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Service Identity Registration" data-md-level="2">
      <label class="md-nav__title" for="nav-1-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Service Identity Registration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials/" title="Using X.509 Certificates" class="md-nav__link">
      Using X.509 Certificates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reg_service_guide/" title="Using Public/Private Key Pairs" class="md-nav__link">
      Using Public/Private Key Pairs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Management
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Management" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../role_delegation/" title="Role Delegation" class="md-nav__link">
      Role Delegation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../token_expiration/" title="Access token Limit Expiry Support" class="md-nav__link">
      Access token Limit Expiry Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../role_cert_expiration/" title="Role Certificate Limit Expiry Support" class="md-nav__link">
      Role Certificate Limit Expiry Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../review_enabled_roles/" title="Review Enabled Roles" class="md-nav__link">
      Review Enabled Roles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../email_notifications/" title="Email Notifications" class="md-nav__link">
      Email Notifications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../member_expiration/" title="Role Member Auto Expiry and Notification Support" class="md-nav__link">
      Role Member Auto Expiry and Notification Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../member_soft_expiration/" title="Role Member Review Reminder Support" class="md-nav__link">
      Role Member Review Reminder Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../self_serve_roles/" title="Self-Served Roles" class="md-nav__link">
      Self-Served Roles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../athenz_templates/" title="Athenz Templates" class="md-nav__link">
      Athenz Templates
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Authentication
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Authentication" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Authentication
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws/" title="Athenz Service Identity X.509 Certificate for AWS EC2 instances" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS EC2 instances
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_ecs/" title="Athenz Service Identity X.509 Certificate for AWS ECS containers" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS ECS containers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_fargate/" title="Athenz Service Identity X.509 Certificate for AWS Fargate tasks" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS Fargate tasks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_eks/" title="Athenz Service Identity X.509 Certificate for AWS EKS pods" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS EKS pods
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Athenz Service Identity X.509 Certificate for AWS Lambda functions
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Athenz Service Identity X.509 Certificate for AWS Lambda functions" class="md-nav__link md-nav__link--active">
      Athenz Service Identity X.509 Certificate for AWS Lambda functions
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#domain-registration" class="md-nav__link">
    Domain Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws-account-id-registration" class="md-nav__link">
    AWS Account ID Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#athenz-service-identity-registration" class="md-nav__link">
    Athenz Service Identity Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#athenz-service-identity-authorization-role-and-policy" class="md-nav__link">
    Athenz Service Identity Authorization Role and Policy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iam-role-setup" class="md-nav__link">
    IAM Role Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#private-key-and-certificate-setup" class="md-nav__link">
    Private Key and Certificate Setup
  </a>
  
    <nav class="md-nav" aria-label="Private Key and Certificate Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    Java
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#go" class="md-nav__link">
    Go
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_access_token_guide/" title="Obtaining OAuth2 Access Tokens from ZTS" class="md-nav__link">
      Obtaining OAuth2 Access Tokens from ZTS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      AWS Setup
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="AWS Setup" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        AWS Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_temp_creds/" title="AWS Temp Credentials" class="md-nav__link">
      AWS Temp Credentials
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_athenz_setup/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_zms_setup/" title="ZMS Server" class="md-nav__link">
      ZMS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_zts_setup/" title="ZTS Server" class="md-nav__link">
      ZTS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_ui_setup/" title="UI Server" class="md-nav__link">
      UI Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Architecture
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Architecture" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../data_model/" title="Data Model" class="md-nav__link">
      Data Model
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../system_view/" title="System View" class="md-nav__link">
      System View
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../auth_flow/" title="Authorization Flow" class="md-nav__link">
      Authorization Flow
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Features
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Features" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Features
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../copper_argos/" title="Service Identity X.509 Certificates - Copper Argos" class="md-nav__link">
      Service Identity X.509 Certificates - Copper Argos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../capabilities/" title="Athenz Capabilities" class="md-nav__link">
      Athenz Capabilities
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Developer Guide
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Developer Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Developer Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cent_authz_flow/" title="Centralized Authorization Flow" class="md-nav__link">
      Centralized Authorization Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../decent_authz_flow/" title="Decentralized Authorization Flow" class="md-nav__link">
      Decentralized Authorization Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../client_side_x509_credentials/" title="Client Side Service Identity Authentication" class="md-nav__link">
      Client Side Service Identity Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../server_side_x509_credentials/" title="Server Side Service Identity Authentication" class="md-nav__link">
      Server Side Service Identity Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example_java_centralized_access/" title="Java Client/Servlet Example" class="md-nav__link">
      Java Client/Servlet Example
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example_go_centralized_access/" title="Go Client/Server Example" class="md-nav__link">
      Go Client/Server Example
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example_java_decentralized_access/" title="Java Client/Servlet Example" class="md-nav__link">
      Java Client/Servlet Example
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Customizing Athenz
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Customizing Athenz" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Customizing Athenz
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../principal_authentication/" title="Principal Authentication" class="md-nav__link">
      Principal Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../private_key_store/" title="Private Key Store" class="md-nav__link">
      Private Key Store
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cert_signer/" title="Certificate Signer" class="md-nav__link">
      Certificate Signer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../copper_argos_dev/" title="Service Identity X.509 Certificate Support Requirements - Copper Argos" class="md-nav__link">
      Service Identity X.509 Certificate Support Requirements - Copper Argos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      User Guide
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="User Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../zms_client/" title="ZMS Client Utility" class="md-nav__link">
      ZMS Client Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zpu/" title="ZPU Utility" class="md-nav__link">
      ZPU Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_rolecert/" title="ZTS Role Certificate Client Utility" class="md-nav__link">
      ZTS Role Certificate Client Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_accesstoken/" title="ZTS OAuth2 Access Token Client" class="md-nav__link">
      ZTS OAuth2 Access Token Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reg_service_guide/" title="Registering ZMS Service Identity" class="md-nav__link">
      Registering ZMS Service Identity
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      References
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="References" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        References
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../zms_api/" title="ZMS REST API" class="md-nav__link">
      ZMS REST API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_api/" title="ZTS REST API" class="md-nav__link">
      ZTS REST API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#domain-registration" class="md-nav__link">
    Domain Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws-account-id-registration" class="md-nav__link">
    AWS Account ID Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#athenz-service-identity-registration" class="md-nav__link">
    Athenz Service Identity Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#athenz-service-identity-authorization-role-and-policy" class="md-nav__link">
    Athenz Service Identity Authorization Role and Policy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iam-role-setup" class="md-nav__link">
    IAM Role Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#private-key-and-certificate-setup" class="md-nav__link">
    Private Key and Certificate Setup
  </a>
  
    <nav class="md-nav" aria-label="Private Key and Certificate Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    Java
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#go" class="md-nav__link">
    Go
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/yahoo/athenz/edit/master/docs/service_x509_credentials_aws_lambda.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                  <h1>Athenz Service Identity X.509 Certificate for AWS Lambda functions</h1>
                
                <blockquote>
<p><strong>Important:</strong> Certificate Signing is an expensive operation (both on the client and
 the server side) so if your application is going to launch large number of instances
 of your lambda function, then you must not fetch Athenz x.509 certificates directly
 within your lambda function. The recommended approach for that scenario is have one
 lambda function to fetch the Athenz X.509 Certificate Identity private key and the
 public certificate, store them in AWS Parameter Store and update those daily. Then
 have all other lambda functions authorized based on their IAM credentials to fetch
 and use that x.509 certificate.</p>
</blockquote>
<h2 id="domain-registration">Domain Registration</h2>
<p>Identify your Athenz domain before you can proceed by visiting Athenz UI.</p>
<p>Follow the <a href="../service_x509_credentials_aws/#domain-registration">instructions documented for EC2 instances</a> to register your domain if one doesn't exist already.</p>
<h2 id="aws-account-id-registration">AWS Account ID Registration</h2>
<p>To register an AWS Account with a domain, run the following command:</p>
<div class="codehilite"><pre><span></span><code><span class="err">zms-cli -d &lt;domain-name&gt; set-aws-account &lt;aws-account-id&gt;</span>
</code></pre></div>


<h2 id="athenz-service-identity-registration">Athenz Service Identity Registration</h2>
<p>Create a service identity for your AWS Lambda function in your Athenz domain. This full service identity name <code>&lt;domain&gt;.&lt;service&gt;</code> will be the IAM role name that you will need to create in AWS IAM and set up a trust relationship with your Lambda Function Execution Role.</p>
<p>In the Athenz UI, select your domain, select the <code>Services</code> tab and then choose <code>Add a Service</code>  link in the top left corner. You must provide a service name and an optional description for your service.</p>
<p><img alt="Service Identity Registration" src="../images/aws-service-register.png" /></p>
<h2 id="athenz-service-identity-authorization-role-and-policy">Athenz Service Identity Authorization Role and Policy</h2>
<p>Before ZTS can validate and issue X.509 TLS Certificates to the AWS Lambda, it must validate that the service owner has authorized its service to be launched by AWS Lambda Provider. The following role and policy must be created in your Athenz domain for this authorization:</p>
<p>When viewing your domain details, choose the <code>Roles</code> tab and select
<code>Add Role</code> link on the left side of the screen underneath the tab names.
Role details are as follows (don't forget to press the <code>Add</code> button after
specifying the role member before pressing the <code>Submit</code> button):</p>
<div class="codehilite"><pre><span></span><code><span class="err">Role Category: Regular</span>
<span class="err">Role Name: aws_lambda_launch_provider</span>
<span class="err">Add Member(s): athens.aws-lambda.*</span>
</code></pre></div>


<p>Then choose the <code>Policies</code> tab and select <code>Add Policy</code> link on the left side
of the screen underneath the tab names. Policy details are as follows
(make sure to replace <code>&lt;your-service-name&gt;</code> in the Rule Resource
with your actual service name):</p>
<div class="codehilite"><pre><span></span><code><span class="err">Policy Name: aws_lambda_launch_provider</span>
<span class="err">Rule Effect: Allow</span>
<span class="err">Rule Action: launch</span>
<span class="err">Rule Role: aws_lambda_launch_provider</span>
<span class="err">Rule Resource: service.&lt;your-service-name&gt;</span>
</code></pre></div>


<h2 id="iam-role-setup">IAM Role Setup</h2>
<p>There are two IAM roles required for instances to obtain Athenz X.509 certificates:</p>
<ul>
<li>Lambda Function Execution Role</li>
<li>Athenz Service Identity Assume Role</li>
</ul>
<p>It is assumed that at this point you have already configured the first Lambda Function Execution Role that your code will be launched with (roles created through the AWS console are created with /service-role/ path). The second Athenz Service Identity IAM Assume Role must be created and must have the <code>&lt;domain&gt;.&lt;service&gt;</code> name. This role will not have any permissions but instead will have a trust relationship with your Lambda execution role such that your Lambda execution role can assume this role.</p>
<p>In the AWS Console, select <code>IAM</code> from the Services drop down and then click on the <code>Roles</code> link in the left sidebar. Choose the <code>Create Role</code> button. Under the <code>AWS Service</code> type, select <code>Lambda</code> and choose <code>Next: Permissions</code> button in the bottom right corner.</p>
<p><img alt="IAM Lambda Role Setup_1" src="../images/iam-lambda-role-setup-1.png" /></p>
<p>In the <code>Attach permissions policy</code> screen do not choose any permissions and just click on the <code>Next: Review</code> button in the bottom right corner to continue. Specify the <code>Role name</code> in the <code>&lt;domain&gt;.&lt;service&gt;</code> format and choose <code>Create Role</code> to complete the process.</p>
<p>In the Roles list view, choose the role just created and choose the <code>Trust Relationships</code> tab.</p>
<p><img alt="IAM Lambda Role Setup_2" src="../images/iam-lambda-role-setup-2.png" /></p>
<p>Click on <code>Edit trust relationship</code> button and append a block containing the following policy to the <code>Statement</code> block Replace the <code>&lt;account-id&gt;</code> and <code>&lt;lambda-execution-role&gt;</code> values with their corresponding values for your environment. For the <code>&lt;lambda-execution-role&gt;</code> make sure to include the full path since roles created through the AWS console are created with <code>/service-role/</code> path:</p>
<div class="codehilite"><pre><span></span><code><span class="err"> {</span>
<span class="err">   &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="err">   &quot;Principal&quot;: {</span>
<span class="err">     &quot;AWS&quot;: &quot;arn:aws:iam::&lt;account-id&gt;:role/&lt;lambda-execution-role&gt;&quot;</span>
<span class="err">   },</span>
<span class="err">   &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span>
<span class="err"> }</span>
</code></pre></div>


<p>Once correctly updated, your Lambda role must appear in the <code>Trusted entities</code> table:</p>
<p><img alt="IAM Lambda Role Setup_3" src="../images/iam-lambda-role-setup-3.png" /></p>
<h2 id="private-key-and-certificate-setup">Private Key and Certificate Setup</h2>
<p>Since we're dealing with functions in this use case, we cannot have a SIA agent daemon running to generate a private key for the service and then retrieve a corresponding x.509 certificate from the ZTS Server. Instead, the function being invoked will be responsible for generating a private key and then a csr for its request. Finally, it will submit that request to the ZTS Server to retrieve its X.509 certificate which then it can use  along with its generated private key to establish TLS connections to other Verizon Media Athenz enabled services. Athenz Team provides functions/methods in Go and Java programming languages to quickly generate a private key and request its corresponding X.509 certificate from ZTS Server.</p>
<p>Important consideration when dealing with Lambda functions:</p>
<ul>
<li>The code to do this needs to prefetch and cache the certificate in a way that does not block every invocation, as minting a new certificate is somewhat expensive.</li>
<li>The short lifetime and stateless nature of the function means it cannot rotate its certificates. It just gets new ones when needed.</li>
</ul>
<h3 id="java">Java</h3>
<p>The following function is available in the Athenz ZTS Java Client:</p>
<div class="codehilite"><pre><span></span><code><span class="err">/**</span>
<span class="err"> * For AWS Lambda functions generate a new private key, request a</span>
<span class="err"> * x.509 certificate based on the requested CSR and return both to</span>
<span class="err"> * the client in order to establish tls connections with other</span>
<span class="err"> * Athenz enabled services.</span>
<span class="err"> * @param domainName name of the athenz domain</span>
<span class="err"> * @param serviceName name of the athenz service</span>
<span class="err"> * @param account AWS account name that the function runs in</span>
<span class="err"> * @param provider name of the provider service for AWS Lambda</span>
<span class="err"> * @return AWSLambdaIdentity with private key and certificate</span>
<span class="err"> */</span>
<span class="err">public AWSLambdaIdentity getAWSLambdaServiceCertificate(String domainName,</span>
<span class="err">        String serviceName, String account, String provider);</span>
</code></pre></div>


<p>For example, here is a quick program that can be compiled and packaged into lambda.jar and deployed as a Lambda function in AWS. It retrieves a private key and the corresponding x.509 certificate and returns as output.</p>
<p>First you need to update your Java project <code>pom.xml</code> file to indicate
the dependency on the Athenz zts java client libraries. Checkout the
<a href="https://bintray.com/yahoo/maven/athenz-zts-java-client/">Bintray ZTS Java Client Package</a>
pages to make sure you're using the latest release version:</p>
<div class="codehilite"><pre><span></span><code>  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.yahoo.athenz<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>athenz-zts-java-client<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>1.8.37<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div>


<p>Next, is the Lambda function handler implementation:</p>
<div class="codehilite"><pre><span></span><code><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">amazonaws</span><span class="o">.</span><span class="k">lambda</span><span class="o">.</span><span class="n">demo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.amazonaws.services.lambda.runtime.Context</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.lambda.runtime.RequestHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.yahoo.athenz.zts.AWSLambdaIdentity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.yahoo.athenz.zts.ZTSClient</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">LambdaFunctionHandler</span> <span class="n">implements</span> <span class="n">RequestHandler</span><span class="o">&lt;</span><span class="n">Object</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">String</span> <span class="n">handleRequest</span><span class="p">(</span><span class="n">Object</span> <span class="nb">input</span><span class="p">,</span> <span class="n">Context</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">final</span> <span class="n">String</span> <span class="n">athenzDomain</span> <span class="o">=</span> <span class="s2">&quot;athens&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">replace</span> <span class="n">this</span> <span class="k">with</span> <span class="n">your</span> <span class="n">domain</span> <span class="n">name</span>
        <span class="n">final</span> <span class="n">String</span> <span class="n">athenzService</span> <span class="o">=</span> <span class="s2">&quot;lambda&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">replace</span> <span class="n">this</span> <span class="k">with</span> <span class="n">your</span> <span class="n">service</span> <span class="n">name</span>
        <span class="n">final</span> <span class="n">String</span> <span class="n">awsAccount</span> <span class="o">=</span> <span class="s2">&quot;123456789&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">replace</span> <span class="n">this</span> <span class="k">with</span> <span class="n">your</span> <span class="n">account</span> <span class="n">number</span>
        <span class="n">final</span> <span class="n">String</span> <span class="n">athenzProvider</span> <span class="o">=</span> <span class="s2">&quot;&lt;lambada-name&gt;.&lt;lambada region&gt;&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">replace</span> <span class="k">with</span> <span class="n">labada</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">region</span><span class="o">.</span> <span class="k">for</span> <span class="n">example</span><span class="p">:</span> <span class="s2">&quot;athens.aws-labmda.us-west-2&quot;</span>
        <span class="n">final</span> <span class="n">String</span> <span class="n">ztsUrl</span> <span class="o">=</span> <span class="s2">&quot;https://zts-address/zts/v1&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">replace</span> <span class="n">this</span> <span class="k">with</span> <span class="n">your</span> <span class="n">zts</span> <span class="n">Url</span> <span class="p">(</span><span class="n">ending</span> <span class="k">with</span> <span class="o">/</span><span class="n">zts</span><span class="o">/</span><span class="n">v1</span><span class="p">)</span>
        <span class="n">final</span> <span class="n">String</span> <span class="n">certDn</span> <span class="o">=</span> <span class="s2">&quot;ou=Athenz,o=Oath&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">the</span> <span class="n">dn</span> <span class="n">you</span> <span class="n">want</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">cert</span>
        <span class="n">final</span> <span class="n">String</span> <span class="n">certDomain</span> <span class="o">=</span> <span class="s2">&quot;aws.cert.domain&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">cert</span> <span class="n">domain</span>

        <span class="o">//</span> <span class="n">our</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">cert</span> <span class="n">to</span> <span class="n">display</span> <span class="k">for</span> <span class="n">test</span> <span class="n">purposes</span>

        <span class="n">String</span> <span class="n">certificate</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">privateKey</span><span class="p">;</span>

        <span class="o">//</span> <span class="n">generate</span> <span class="n">a</span> <span class="n">private</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">retrieve</span> <span class="n">the</span> <span class="n">corresponding</span>
        <span class="o">//</span> <span class="n">certificate</span> <span class="kn">from</span> <span class="nn">Athenz</span> <span class="nn">ZTS</span> <span class="nn">Service</span>

        <span class="k">try</span> <span class="p">(</span><span class="n">ZTSClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ZTSClient</span><span class="p">(</span><span class="n">ztsUrl</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">ZTSClient</span><span class="o">.</span><span class="n">setX509CsrDetails</span><span class="p">(</span><span class="n">certDn</span><span class="p">,</span> <span class="n">certDomain</span><span class="p">);</span>
            <span class="n">AWSLambdaIdentity</span> <span class="n">lambdaIdentity</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getAWSLambdaServiceCertificate</span><span class="p">(</span><span class="n">athenzDomain</span><span class="p">,</span>
                    <span class="n">athenzService</span><span class="p">,</span> <span class="n">awsAccount</span><span class="p">,</span> <span class="n">athenzProvider</span><span class="p">);</span>

            <span class="n">certificate</span> <span class="o">=</span> <span class="n">lambdaIdentity</span><span class="o">.</span><span class="n">getX509Certificate</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">();</span>
            <span class="n">privateKey</span> <span class="o">=</span> <span class="n">lambdaIdentity</span><span class="o">.</span><span class="n">getPrivateKey</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="o">//</span> <span class="n">just</span> <span class="k">return</span> <span class="n">our</span> <span class="n">data</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">see</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">our</span> <span class="n">aws</span> <span class="n">console</span>

        <span class="k">return</span> <span class="s2">&quot;Lambda - Private Key: &quot;</span> <span class="o">+</span> <span class="n">privateKey</span> <span class="o">+</span> <span class="s2">&quot; Certificate: &quot;</span> <span class="o">+</span> <span class="n">certificate</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h3 id="go">Go</h3>
<p>The following function is available in the <code>/sia-ec2/util</code> package:</p>
<div class="codehilite"><pre><span></span><code><span class="err">func GetAWSLambdaServiceCertificate(ztsUrl, domain, service, account, region string) (tls.Certificate, error)</span>
</code></pre></div>


<p>Change the <code>ztsUrl</code> field with your zts (ending with <code>/zts/v1</code>). The <code>domain</code> is your Athenz domain name while <code>service</code> is the service name that your Lambda function will run as. The <code>account</code> field is the AWS account id while <code>region</code> is where this function will be running.</p>
<p>For example, here is a quick program that can be compiled and packaged into main.zip and deployed as a Lambda function in AWS. It retrieves a private key and the corresponding x.509 certificate and returns as output.</p>
<div class="codehilite"><pre><span></span><code><span class="n">package</span> <span class="n">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s2">&quot;crypto/rsa&quot;</span>
    <span class="s2">&quot;encoding/pem&quot;</span>
    <span class="s2">&quot;fmt&quot;</span>

    <span class="s2">&quot;github.com/aws/aws-lambda-go/lambda&quot;</span>
    <span class="s2">&quot;util&quot;</span>
<span class="p">)</span>

<span class="nb">type</span> <span class="n">Request</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">Zts</span>     <span class="n">string</span> <span class="sb">`json:&quot;zts&quot;`</span>
    <span class="n">Region</span>  <span class="n">string</span> <span class="sb">`json:&quot;region&quot;`</span>
    <span class="n">Domain</span>  <span class="n">string</span> <span class="sb">`json:&quot;domain&quot;`</span>
    <span class="n">Account</span> <span class="n">string</span> <span class="sb">`json:&quot;account&quot;`</span>
    <span class="n">Service</span> <span class="n">string</span> <span class="sb">`json:&quot;service&quot;`</span>
<span class="p">}</span>

<span class="nb">type</span> <span class="n">Response</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">PrivateKey</span>      <span class="n">string</span> <span class="sb">`json:&quot;privatekey&quot;`</span>
    <span class="n">X509Certificate</span> <span class="n">string</span> <span class="sb">`json:&quot;certificate&quot;`</span>
    <span class="n">Message</span>         <span class="n">string</span> <span class="sb">`json:&quot;message&quot;`</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">Handler</span><span class="p">(</span><span class="n">req</span> <span class="n">Request</span><span class="p">)</span> <span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">x509Cert</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">GetAWSLambdaServiceCertificate</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Zts</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">Domain</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">Service</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">Account</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">Region</span><span class="p">)</span>
    <span class="n">var</span> <span class="n">resp</span> <span class="n">Response</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">Message</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s2">&quot;Unable to get certificate: %v&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">PrivateKey</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">PrivatePem</span><span class="p">(</span><span class="n">x509Cert</span><span class="o">.</span><span class="n">PrivateKey</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">rsa</span><span class="o">.</span><span class="n">PrivateKey</span><span class="p">))</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">X509Certificate</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">pem</span><span class="o">.</span><span class="n">EncodeToMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pem</span><span class="o">.</span><span class="n">Block</span><span class="p">{</span><span class="n">Type</span><span class="p">:</span> <span class="s2">&quot;CERTIFICATE&quot;</span><span class="p">,</span> <span class="n">Bytes</span><span class="p">:</span> <span class="n">x509Cert</span><span class="o">.</span><span class="n">Certificate</span><span class="p">[</span><span class="mi">0</span><span class="p">]}))</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">Message</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">err</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">lambda</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">Handler</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>


<p>Here is a sample input for this function. Our domain is called athens and the service is called lambda-function-test.</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;zts&quot;: &quot;https://zts.com:4443/zts/v1&quot;,</span>
<span class="err">  &quot;region&quot;: &quot;us-west-2&quot;,</span>
<span class="err">  &quot;domain&quot;: &quot;athens&quot;,</span>
<span class="err">  &quot;service&quot;: &quot;lambda-function-test&quot;,</span>
<span class="err">  &quot;account&quot;: &quot;123456789&quot;</span>
<span class="err">}</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../service_x509_credentials_aws_eks/" title="Athenz Service Identity X.509 Certificate for AWS EKS pods" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Athenz Service Identity X.509 Certificate for AWS EKS pods
              </div>
            </div>
          </a>
        
        
          <a href="../zts_access_token_guide/" title="Obtaining OAuth2 Access Tokens from ZTS" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Obtaining OAuth2 Access Tokens from ZTS
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>