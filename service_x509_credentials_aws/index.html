


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Athenz User Guide">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.7">
    
    
      
        <title>Athenz Service Identity X.509 Certificate for AWS EC2 instances - Athenz</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.b8ac9624.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#domain-registration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Athenz" class="md-header-nav__button md-logo" aria-label="Athenz">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Athenz
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Athenz Service Identity X.509 Certificate for AWS EC2 instances
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/yahoo/athenz/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Athenz" class="md-nav__button md-logo" aria-label="Athenz">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Athenz
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/yahoo/athenz/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Getting Started
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Getting Started
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="About" class="md-nav__link">
      About
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dev_environment/" title="Development Environment" class="md-nav__link">
      Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-3" type="checkbox" id="nav-1-3">
    
    <label class="md-nav__link" for="nav-1-3">
      Local/Development Environment Setup
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Local/Development Environment Setup" data-md-level="2">
      <label class="md-nav__title" for="nav-1-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Local/Development Environment Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zms/" title="ZMS Server" class="md-nav__link">
      ZMS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zts/" title="ZTS Server" class="md-nav__link">
      ZTS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_ui/" title="UI Server" class="md-nav__link">
      UI Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-4" type="checkbox" id="nav-1-4">
    
    <label class="md-nav__link" for="nav-1-4">
      Production Environment Setup
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Production Environment Setup" data-md-level="2">
      <label class="md-nav__title" for="nav-1-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Production Environment Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zms_prod/" title="ZMS Server" class="md-nav__link">
      ZMS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zts_prod/" title="ZTS Server" class="md-nav__link">
      ZTS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_ui_prod/" title="UI Server" class="md-nav__link">
      UI Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-5" type="checkbox" id="nav-1-5">
    
    <label class="md-nav__link" for="nav-1-5">
      Service Identity Registration
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Service Identity Registration" data-md-level="2">
      <label class="md-nav__title" for="nav-1-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Service Identity Registration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials/" title="Using X.509 Certificates" class="md-nav__link">
      Using X.509 Certificates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reg_service_guide/" title="Using Public/Private Key Pairs" class="md-nav__link">
      Using Public/Private Key Pairs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Management
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Management" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../role_delegation/" title="Role Delegation" class="md-nav__link">
      Role Delegation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../token_expiration/" title="Access token Limit Expiry Support" class="md-nav__link">
      Access token Limit Expiry Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../role_cert_expiration/" title="Role Certificate Limit Expiry Support" class="md-nav__link">
      Role Certificate Limit Expiry Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../review_enabled_roles/" title="Review Enabled Roles" class="md-nav__link">
      Review Enabled Roles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../email_notifications/" title="Email Notifications" class="md-nav__link">
      Email Notifications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../member_expiration/" title="Role Member Auto Expiry and Notification Support" class="md-nav__link">
      Role Member Auto Expiry and Notification Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../member_soft_expiration/" title="Role Member Review Reminder Support" class="md-nav__link">
      Role Member Review Reminder Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../self_serve_roles/" title="Self-Served Roles" class="md-nav__link">
      Self-Served Roles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../athenz_templates/" title="Athenz Templates" class="md-nav__link">
      Athenz Templates
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Authentication
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Authentication" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Authentication
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Athenz Service Identity X.509 Certificate for AWS EC2 instances
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Athenz Service Identity X.509 Certificate for AWS EC2 instances" class="md-nav__link md-nav__link--active">
      Athenz Service Identity X.509 Certificate for AWS EC2 instances
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#domain-registration" class="md-nav__link">
    Domain Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws-account-id-registration" class="md-nav__link">
    AWS Account ID Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#athenz-service-identity-registration" class="md-nav__link">
    Athenz Service Identity Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#athenz-service-identity-authorization" class="md-nav__link">
    Athenz Service Identity Authorization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iam-role-setup" class="md-nav__link">
    IAM Role Setup
  </a>
  
    <nav class="md-nav" aria-label="IAM Role Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup-for-services-with-region-specific-instance-profile-roles" class="md-nav__link">
    Setup for Services with Region Specific Instance Profile Roles
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-sia" class="md-nav__link">
    Installing SIA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sia-configuration-setup" class="md-nav__link">
    SIA Configuration Setup
  </a>
  
    <nav class="md-nav" aria-label="SIA Configuration Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#private-key-file-ownership" class="md-nav__link">
    Private Key File Ownership
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#private-key-and-certificate-setup" class="md-nav__link">
    Private Key and Certificate Setup
  </a>
  
    <nav class="md-nav" aria-label="Private Key and Certificate Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#role-certificate-support" class="md-nav__link">
    Role Certificate Support
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-without-sia-configuration-file" class="md-nav__link">
    Setup Without SIA Configuration File
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#non-standard-instance-profile-name" class="md-nav__link">
    Non Standard Instance Profile Name
  </a>
  
    <nav class="md-nav" aria-label="Non Standard Instance Profile Name">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#independent-instance-profile-and-role-names" class="md-nav__link">
    Independent Instance Profile and Role Names
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_ecs/" title="Athenz Service Identity X.509 Certificate for AWS ECS containers" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS ECS containers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_fargate/" title="Athenz Service Identity X.509 Certificate for AWS Fargate tasks" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS Fargate tasks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_eks/" title="Athenz Service Identity X.509 Certificate for AWS EKS pods" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS EKS pods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_lambda/" title="Athenz Service Identity X.509 Certificate for AWS Lambda functions" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS Lambda functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_access_token_guide/" title="Obtaining OAuth2 Access Tokens from ZTS" class="md-nav__link">
      Obtaining OAuth2 Access Tokens from ZTS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      AWS Setup
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="AWS Setup" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        AWS Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_temp_creds/" title="AWS Temp Credentials" class="md-nav__link">
      AWS Temp Credentials
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_athenz_setup/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_zms_setup/" title="ZMS Server" class="md-nav__link">
      ZMS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_zts_setup/" title="ZTS Server" class="md-nav__link">
      ZTS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_ui_setup/" title="UI Server" class="md-nav__link">
      UI Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Architecture
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Architecture" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../data_model/" title="Data Model" class="md-nav__link">
      Data Model
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../system_view/" title="System View" class="md-nav__link">
      System View
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../auth_flow/" title="Authorization Flow" class="md-nav__link">
      Authorization Flow
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Features
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Features" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Features
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../copper_argos/" title="Service Identity X.509 Certificates - Copper Argos" class="md-nav__link">
      Service Identity X.509 Certificates - Copper Argos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../capabilities/" title="Athenz Capabilities" class="md-nav__link">
      Athenz Capabilities
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Developer Guide
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Developer Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Developer Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cent_authz_flow/" title="Centralized Authorization Flow" class="md-nav__link">
      Centralized Authorization Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../decent_authz_flow/" title="Decentralized Authorization Flow" class="md-nav__link">
      Decentralized Authorization Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../client_side_x509_credentials/" title="Client Side Service Identity Authentication" class="md-nav__link">
      Client Side Service Identity Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../server_side_x509_credentials/" title="Server Side Service Identity Authentication" class="md-nav__link">
      Server Side Service Identity Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example_java_centralized_access/" title="Java Client/Servlet Example" class="md-nav__link">
      Java Client/Servlet Example
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example_go_centralized_access/" title="Go Client/Server Example" class="md-nav__link">
      Go Client/Server Example
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example_java_decentralized_access/" title="Java Client/Servlet Example" class="md-nav__link">
      Java Client/Servlet Example
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Customizing Athenz
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Customizing Athenz" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Customizing Athenz
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../principal_authentication/" title="Principal Authentication" class="md-nav__link">
      Principal Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../private_key_store/" title="Private Key Store" class="md-nav__link">
      Private Key Store
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cert_signer/" title="Certificate Signer" class="md-nav__link">
      Certificate Signer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../copper_argos_dev/" title="Service Identity X.509 Certificate Support Requirements - Copper Argos" class="md-nav__link">
      Service Identity X.509 Certificate Support Requirements - Copper Argos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      User Guide
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="User Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../zms_client/" title="ZMS Client Utility" class="md-nav__link">
      ZMS Client Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zpu/" title="ZPU Utility" class="md-nav__link">
      ZPU Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_rolecert/" title="ZTS Role Certificate Client Utility" class="md-nav__link">
      ZTS Role Certificate Client Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_accesstoken/" title="ZTS OAuth2 Access Token Client" class="md-nav__link">
      ZTS OAuth2 Access Token Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reg_service_guide/" title="Registering ZMS Service Identity" class="md-nav__link">
      Registering ZMS Service Identity
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      References
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="References" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        References
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../zms_api/" title="ZMS REST API" class="md-nav__link">
      ZMS REST API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_api/" title="ZTS REST API" class="md-nav__link">
      ZTS REST API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#domain-registration" class="md-nav__link">
    Domain Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws-account-id-registration" class="md-nav__link">
    AWS Account ID Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#athenz-service-identity-registration" class="md-nav__link">
    Athenz Service Identity Registration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#athenz-service-identity-authorization" class="md-nav__link">
    Athenz Service Identity Authorization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iam-role-setup" class="md-nav__link">
    IAM Role Setup
  </a>
  
    <nav class="md-nav" aria-label="IAM Role Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup-for-services-with-region-specific-instance-profile-roles" class="md-nav__link">
    Setup for Services with Region Specific Instance Profile Roles
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-sia" class="md-nav__link">
    Installing SIA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sia-configuration-setup" class="md-nav__link">
    SIA Configuration Setup
  </a>
  
    <nav class="md-nav" aria-label="SIA Configuration Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#private-key-file-ownership" class="md-nav__link">
    Private Key File Ownership
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#private-key-and-certificate-setup" class="md-nav__link">
    Private Key and Certificate Setup
  </a>
  
    <nav class="md-nav" aria-label="Private Key and Certificate Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#role-certificate-support" class="md-nav__link">
    Role Certificate Support
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-without-sia-configuration-file" class="md-nav__link">
    Setup Without SIA Configuration File
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#non-standard-instance-profile-name" class="md-nav__link">
    Non Standard Instance Profile Name
  </a>
  
    <nav class="md-nav" aria-label="Non Standard Instance Profile Name">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#independent-instance-profile-and-role-names" class="md-nav__link">
    Independent Instance Profile and Role Names
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/yahoo/athenz/edit/master/docs/service_x509_credentials_aws.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                  <h1>Athenz Service Identity X.509 Certificate for AWS EC2 instances</h1>
                
                <p><img alt="AWS EC2 Setup" src="../images/aws-ec2-setup.png" /></p>
<p><strong>Bootstrapping AWS EC2 instances with Athenz Service x.509 Identities
requires the instances to have network connectivity to both Athenz ZTS
and AWS STS Services.</strong></p>
<h2 id="domain-registration">Domain Registration</h2>
<p>Identify your Athenz domain before you can proceed by using Athenz UI.</p>
<p>You may create a top-level domain or a sub domain using Athenz UI or zms-cli.
Only Athenz System Administrators can create top level domains (members of the sys.auth domain's admin role).
To create a top-level domain using zms-cli run the following:</p>
<div class="codehilite"><pre><span></span><code><span class="err">zms-cli add-domakn &lt;domain-name&gt; &lt;unique-product-id&gt; &lt;domain-admins separated by space&gt;</span>
</code></pre></div>


<p>If you already have top-level domain and need to create a sub domain using Athenz UI:
click the "Create” link next to "My Domains" label in the top right corner
and then click on “Sub Domain” tab and follow the on screen instruction.</p>
<p><img alt="Create Sub Domain" src="../images/create_sub_domain.png" /></p>
<p>Or using zms-cli:</p>
<div class="codehilite"><pre><span></span><code><span class="err">zms-cli add-doman &lt;top-doman.sub-domain-name&gt; &lt;domain-admins separated by space&gt;</span>
</code></pre></div>


<h2 id="aws-account-id-registration">AWS Account ID Registration</h2>
<p>To register an AWS Account with a domain, run the following command:</p>
<div class="codehilite"><pre><span></span><code><span class="err">zms-cli -d &lt;domain-name&gt; set-aws-account &lt;aws-account-id&gt;</span>
</code></pre></div>


<h2 id="athenz-service-identity-registration">Athenz Service Identity Registration</h2>
<p>Create a service identity for your AWS EC2 instances in your Athenz domain. This full service identity name <code>&lt;domain&gt;.&lt;service&gt;</code> will be the IAM role name that you will need to create in AWS IAM and set up a trust relationship with your EC2 Instance Role.</p>
<p>In the Athenz UI, select your domain, select the <code>Services</code> tab and then choose <code>Add a Service</code> link in the top left corner. You must provide a service name and an optional description for your service. </p>
<p><img alt="Service Identity Registration" src="../images/aws-service-register.png" /></p>
<h2 id="athenz-service-identity-authorization">Athenz Service Identity Authorization</h2>
<p>Before ZTS can validate and issue X.509 TLS Certificates to the
AWS EC2 instance, it must validate that the service owner has
authorized its service to be launched by AWS EC2 Provider. In the
Athenz UI select your service that was created in the previous
step and click on the icon in the <code>Providers</code> column:</p>
<p><img alt="Service Identity Authorization_1" src="../images/aws-service-authorize.png" /></p>
<p>Then, click on the <code>Allow</code> button to authorize your service to
be launched by AWS EC2 provider.</p>
<p><img alt="Service Identity Authorization_2" src="../images/aws-service-authorize-2.png" /></p>
<h2 id="iam-role-setup">IAM Role Setup</h2>
<p>There are two IAM roles required for instances to obtain Athenz X.509 certificates:</p>
<ul>
<li>EC2 Instance Profile Role</li>
<li>Athenz Service Identity Assume Role</li>
</ul>
<p>It is assumed that at this point you have already configured the first
EC2 Instance Profile IAM Role that your EC2 instance will be launched
with. </p>
<p>The second Athenz Service Identity IAM Assume Role must be created and
must have the <code>&lt;domain&gt;.&lt;service&gt;</code> name. This role will not have any
permissions but instead will have a trust relationship with your EC2
instance role such that your EC2 instance role can assume this role.</p>
<p>In the AWS Console, select <code>IAM</code> from the Services drop down and then
click on the <code>Roles</code> link in the left sidebar. Choose the <code>Create Role</code>
button. Under the <code>AWS Service</code> type, select <code>EC2</code>, then <code>EC2</code> again
for the use case and finally choose <code>Next: Permissions</code> button in the
bottom right corner.</p>
<p><img alt="IAM Role Setup_1" src="../images/iam-role-setup-1.png" /></p>
<p>In the <code>Attach permissions policy</code> screen do not choose any permissions
and just click on the <code>Next: Review</code> button in the bottom right corner
to continue. Specify the <code>Role name</code> in the <code>&lt;domain&gt;.&lt;service&gt;</code> format
and choose <code>Create Role</code> to complete the process.</p>
<p>In the Roles list view, choose the role just created and choose the
<code>Trust Relationships</code> tab.</p>
<p><img alt="IAM Role Setup_2" src="../images/iam-role-setup-2.png" /></p>
<p>Click on <code>Edit trust relationship</code> button and append a block containing
the following policy to the <code>Statement</code> block (Replace the <code>&lt;account-id&gt;</code>
and <code>&lt;ec2-instance-role&gt;</code> values with their corresponding values for
your environment:</p>
<div class="codehilite"><pre><span></span><code><span class="err"> {</span>
<span class="err">   &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="err">   &quot;Principal&quot;: {</span>
<span class="err">     &quot;AWS&quot;: &quot;arn:aws:iam::&lt;account-id&gt;:role/&lt;ec2-instance-role&gt;&quot;</span>
<span class="err">   },</span>
<span class="err">   &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span>
<span class="err"> }</span>
</code></pre></div>


<p>Once correctly updated, your EC2 instance role must appear in the <code>Trusted entities</code> table:</p>
<p><img alt="IAM Role Setup_3" src="../images/iam-role-setup-3.png" /></p>
<h3 id="setup-for-services-with-region-specific-instance-profile-roles">Setup for Services with Region Specific Instance Profile Roles</h3>
<p>The IAM Role setup is identical when you have the same service
being deployed in multiple regions with role names that
are specific to each region. Since IAM roles are global, you only need
to create a single Athenz IAM Role in the <code>&lt;domain&gt;.&lt;service&gt;</code> format.
Then, when you're setting up your trust relationship, you'll authorize
all your region specific profile roles to have the capability to
assume the Athenz <code>&lt;domain&gt;.&lt;service&gt;</code> role.</p>
<h2 id="installing-sia">Installing SIA</h2>
<p>The AWS SIA source is part of the Athenz project and can be found in:</p>
<div class="codehilite"><pre><span></span><code><span class="err">provider/aws/sia-ec2</span>
</code></pre></div>


<p>Follow the readme for instructions on how to install it.</p>
<h2 id="sia-configuration-setup">SIA Configuration Setup</h2>
<p>When building your image, you can include the following configuration
file called <code>sia_config</code> in the <code>/etc/sia</code> directory. It must include
the following required fields:</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="err">  &quot;service&quot;: &quot;&lt;service name&gt;&quot;,</span>
<span class="err">  &quot;accounts&quot;: [</span>
<span class="err">    {</span>
<span class="err">      &quot;domain&quot;: &quot;&lt;domain name&gt;&quot;,</span>
<span class="err">      &quot;account&quot;: &quot;&lt;aws account id associated with domain name&gt;&quot;</span>
<span class="err">    }</span>
<span class="err">  ]</span>
<span class="err">}</span>
</code></pre></div>


<p>The domain/account/service values here must match to the IAM Role
created earlier. For example, if the service identity name is <code>api</code>
in domain <code>sports</code> whose corresponding aws account id is <code>123456789</code>,
then the <code>sia_config</code> file will be as follows:</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="err">  &quot;service&quot;: &quot;api&quot;,</span>
<span class="err">  &quot;accounts&quot;: [</span>
<span class="err">    {</span>
<span class="err">      &quot;domain&quot;: &quot;sports&quot;,</span>
<span class="err">      &quot;account&quot;: &quot;123456789&quot;</span>
<span class="err">    }</span>
<span class="err">  ]</span>
<span class="err">}</span>
</code></pre></div>


<h3 id="private-key-file-ownership">Private Key File Ownership</h3>
<p>By default SIA agent runs as root and the private key is only readable
by root. If your service is running as another user, you can configure
SIA agent to automatically change the ownership of the private key file
to the configured user.
For example, if you want the private key to be owned by <code>ec2-user</code>, then
your <code>sia_config</code> configuration file would be as follows:</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="err">  &quot;service&quot;: &quot;api&quot;,</span>
<span class="err">  &quot;accounts&quot;: [</span>
<span class="err">    {</span>
<span class="err">      &quot;domain&quot;: &quot;sports&quot;,</span>
<span class="err">      &quot;account&quot;: &quot;123456789&quot;,</span>
<span class="err">      &quot;user&quot;: &quot;ec2-user&quot;</span>
<span class="err">    }</span>
<span class="err">  ]</span>
<span class="err">}</span>
</code></pre></div>


<h2 id="private-key-and-certificate-setup">Private Key and Certificate Setup</h2>
<p>By default, the private key for the service identity is available in
the <code>/var/lib/sia/keys</code> directory and has the name <code>&lt;domain&gt;.&lt;service&gt;.key.pem</code>.
The private key is in PKCS#1 format. The corresponding X.509 certificate
is in the <code>/var/lib/sia/certs</code> directory and has the name
<code>&lt;domain&gt;.&lt;service&gt;.cert.pem</code>. The certificate is valid for 30 days and will
be refreshed automatically by SIA every day. It is the responsibility of the
application owner to update their container/application to refresh and use
the latest certificate before it expires. In the same <code>/var/lib/sia/certs</code>
directory SIA will also generate the Athenz CA certificate file called <code>ca.cert.pem</code>.</p>
<h3 id="role-certificate-support">Role Certificate Support</h3>
<p>In addition to requesting Athenz service identity certificate, SIA provides
the capability to request Athenz Role Certificates as well. If you want to change the default behavior or request
SIA to automatically retrieve role certificates for your service, as part
of building your ami image, you can include the following additional fields
in the configuration file:</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="err">  &quot;service&quot;: &quot;&lt;service name&gt;&quot;,</span>
<span class="err">  &quot;accounts&quot;: [</span>
<span class="err">    {</span>
<span class="err">      &quot;domain&quot;: &quot;&lt;domain name&gt;&quot;,</span>
<span class="err">      &quot;account&quot;: &quot;&lt;aws account id associated with domain name&gt;&quot;,</span>
<span class="err">      &quot;roles&quot;: {</span>
<span class="err">        &quot;&lt;role-domain1&gt;:role.&lt;role-name1&gt;&quot;: {</span>
<span class="err">        },</span>
<span class="err">        &quot;&lt;role-domain2&gt;:role.&lt;role-name2&gt;&quot;: {</span>
<span class="err">        }</span>
<span class="err">      }</span>
<span class="err">    }</span>
<span class="err">  ]</span>
<span class="err">}</span>
</code></pre></div>


<p>The role certificates will also be stored in the <code>/var/lib/sia/certs</code> directory
and have the name of <code>&lt;role-domain1&gt;:role.&lt;role-name1&gt;.cert.pem</code>. They are also
valid for 30 days and SIA will automatically refresh them once a day.</p>
<h2 id="setup-without-sia-configuration-file">Setup Without SIA Configuration File</h2>
<p>If a property deploying their service in AWS meets the following 2 requirements:</p>
<ul>
<li>does not need any role certificates to be retrieved by SIA automatically</li>
<li>has the option to name their EC2 instance role</li>
</ul>
<p>then they have the option for a simpler setup without including a sia configuration
file in their image.</p>
<p>In this model, the property would name their EC2 instance role as
<code>&lt;domain&gt;.&lt;service&gt;-service</code>. The property must still follow the full steps as
described in the <a href="#iam-role-setup">IAM Role Setup</a> section to setup the
<code>&lt;domain&gt;.&lt;service&gt;</code> role, but the requirement to have a sia_config file is
no longer present. When SIA is running and is not able to find the sia_config
file, it will check if the instance profile arn has the <code>&lt;domain&gt;.&lt;service&gt;-service</code>
format. If it does, then it would drop <code>-service</code> part to parse the rest of the
string to extract the Athenz domain and service values and determine the assume
role name that it needs to fetch temporary credentials for before contacting ZTS Server.</p>
<h2 id="non-standard-instance-profile-name">Non Standard Instance Profile Name</h2>
<p>If a property deploying their service in AWS does not have the
capability to name their instance profile role name as
<code>&lt;domain&gt;.&lt;service&gt;-service</code> due to legacy requirements, the following
steps can be followed to configure SIA to use the non-standard
instance profile name.</p>
<ul>
<li>The property must still follow the full steps as
described in the <a href="#iam-role-setup">IAM Role Setup</a> section to setup the
<code>&lt;domain&gt;.&lt;service&gt;</code> role and the trust relationship.</li>
<li>The property must install a SIA config file <code>/etc/sia/sia_config</code>
specifying the service name that will be deployed on this instance</li>
</ul>
<h3 id="independent-instance-profile-and-role-names">Independent Instance Profile and Role Names</h3>
<p>It is possible to setup only a single role within AWS IAM in the format
<code>&lt;domain&gt;.&lt;service&gt;</code> and name the IAM profile name as <code>&lt;domain&gt;.&lt;service&gt;-service</code>
without creating a separate role. However, there is currently no support in the
AWS UI console for naming your IAM role and IAM instance profile independently.
You can do this with Cloud Formation, Ansible, TF, the AWS API, or the CLI.
Here is an example using the CLI - replace <code>&lt;domain&gt;</code>, <code>&lt;service&gt;</code> and
<code>&lt;account-id&gt;</code> parameters with their respective values for your environment:</p>
<div class="codehilite"><pre><span></span><code><span class="n">aws</span> <span class="n">iam</span> <span class="k">create</span><span class="o">-</span><span class="k">role</span> <span class="c1">--role-name &lt;domain&gt;.&lt;service&gt; --assume-role-policy-document=&#39;{&quot;Version&quot;:&quot;2012-10-17&quot;,&quot;Statement&quot;:[{&quot;Effect&quot;:&quot;Allow&quot;,&quot;Principal&quot;:{&quot;Service&quot;:&quot;ec2.amazonaws.com&quot;},&quot;Action&quot;:&quot;sts:AssumeRole&quot;}]}&#39;</span>

<span class="n">aws</span> <span class="n">iam</span> <span class="k">create</span><span class="o">-</span><span class="n">instance</span><span class="o">-</span><span class="n">profile</span> <span class="c1">--instance-profile-name &lt;domain&gt;.&lt;service&gt;-service</span>

<span class="n">aws</span> <span class="n">iam</span> <span class="k">update</span><span class="o">-</span><span class="n">assume</span><span class="o">-</span><span class="k">role</span><span class="o">-</span><span class="n">policy</span> <span class="c1">--role-name &lt;domain&gt;.&lt;service&gt; --policy-document &#39;{&quot;Version&quot;:&quot;2012-10-17&quot;,&quot;Statement&quot;:[{&quot;Effect&quot;:&quot;Allow&quot;,&quot;Principal&quot;:{&quot;Service&quot;:&quot;ec2.amazonaws.com&quot;},&quot;Action&quot;:&quot;sts:AssumeRole&quot;},{&quot;Effect&quot;:&quot;Allow&quot;,&quot;Principal&quot;:{&quot;AWS&quot;:&quot;arn:aws:iam::&lt;account-id&gt;:role/&lt;domain&gt;.&lt;service&gt;&quot;},&quot;Action&quot;:&quot;sts:AssumeRole&quot;}]}&#39;</span>

<span class="n">aws</span> <span class="n">iam</span> <span class="k">add</span><span class="o">-</span><span class="k">role</span><span class="o">-</span><span class="k">to</span><span class="o">-</span><span class="n">instance</span><span class="o">-</span><span class="n">profile</span> <span class="c1">--instance-profile-name &lt;domain&gt;.&lt;service&gt;-service --role-name &lt;domain&gt;.&lt;service&gt;</span>
</code></pre></div>


<p>However, this model is not recommended from security perspective if your
<code>&lt;domain&gt;.&lt;service&gt;</code> role has access to other AWS services. Temporary credentials
for that role are sent to Athenz ZTS service as your authentication credentials
and, as such, you do not want to expose those additional access capabilities
to the ZTS Server.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>SIA process outputs all of its messages to syslog, so if there are any issues
with your configuration, it will be reported in syslog. You can execute:
<code>sudo grep siad /var/log/messages</code> and see what operation sia was not able
to complete successfully. The agent is configured to run every 20 seconds in
case of a failure, so you'll most likely see the same block being repeated
multiple times. ZTS server allows instances to obtain x.509 certificates only
during the first 30 minutes after the initial bootstrap time so even if you
address the configuration issues, once the 30 mins have passed, the instance
will no longer be able to obtain its x.509 service identity certificate. The
only option at that time is to terminate and launch a new instance.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../athenz_templates/" title="Athenz Templates" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Athenz Templates
              </div>
            </div>
          </a>
        
        
          <a href="../service_x509_credentials_aws_ecs/" title="Athenz Service Identity X.509 Certificate for AWS ECS containers" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Athenz Service Identity X.509 Certificate for AWS ECS containers
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>