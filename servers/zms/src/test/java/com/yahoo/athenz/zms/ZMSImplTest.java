/*
 * Copyright The Athenz Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.yahoo.athenz.zms;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.base.Strings;
import com.nimbusds.jose.JOSEException;
import com.nimbusds.jose.JWSObject;
import com.nimbusds.jose.JWSVerifier;
import com.nimbusds.jose.crypto.RSASSAVerifier;
import com.nimbusds.jose.util.Base64URL;
import com.yahoo.athenz.auth.Authority;
import com.yahoo.athenz.auth.Principal;
import com.yahoo.athenz.auth.ServerPrivateKey;
import com.yahoo.athenz.auth.impl.*;
import com.yahoo.athenz.auth.token.PrincipalToken;
import com.yahoo.athenz.auth.util.Crypto;
import com.yahoo.athenz.common.config.AuthzDetailsEntity;
import com.yahoo.athenz.common.config.AuthzDetailsField;
import com.yahoo.athenz.common.messaging.DomainChangeMessage;
import com.yahoo.athenz.common.messaging.MockDomainChangePublisher;
import com.yahoo.athenz.common.metrics.Metric;
import com.yahoo.athenz.common.server.log.AuditLogMsgBuilder;
import com.yahoo.athenz.common.server.log.AuditLogger;
import com.yahoo.athenz.common.server.log.impl.DefaultAuditLogMsgBuilder;
import com.yahoo.athenz.common.server.metastore.DomainMetaStore;
import com.yahoo.athenz.common.server.notification.Notification;
import com.yahoo.athenz.common.server.notification.NotificationToEmailConverterCommon;
import com.yahoo.athenz.common.server.util.AuthzHelper;
import com.yahoo.athenz.common.server.util.ResourceUtils;
import com.yahoo.athenz.common.server.util.config.dynamic.DynamicConfigBoolean;
import com.yahoo.athenz.common.utils.SignUtils;
import com.yahoo.athenz.zms.ZMSImpl.AccessStatus;
import com.yahoo.athenz.zms.ZMSImpl.AthenzObject;
import com.yahoo.athenz.zms.config.MemberDueDays;
import com.yahoo.athenz.zms.notification.PutRoleMembershipNotificationTask;
import com.yahoo.athenz.zms.provider.ServiceProviderManager;
import com.yahoo.athenz.zms.status.MockStatusCheckerNoException;
import com.yahoo.athenz.zms.status.MockStatusCheckerThrowException;
import com.yahoo.athenz.zms.store.AthenzDomain;
import com.yahoo.athenz.zms.store.ObjectStoreConnection;
import com.yahoo.athenz.zms.utils.ZMSUtils;
import com.yahoo.rdl.Schema;
import com.yahoo.rdl.Struct;
import com.yahoo.rdl.Timestamp;
import jakarta.servlet.ServletContext;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.ws.rs.core.EntityTag;
import jakarta.ws.rs.core.Response;
import org.hamcrest.CoreMatchers;
import org.mockito.ArgumentCaptor;
import org.mockito.Mockito;
import org.testng.annotations.*;

import java.io.*;
import java.lang.reflect.Field;
import java.net.URISyntaxException;
import java.nio.charset.StandardCharsets;
import java.security.PrivateKey;
import java.security.interfaces.RSAPublicKey;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.Instant;
import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

import static com.yahoo.athenz.common.messaging.DomainChangeMessage.ObjectType.*;
import static com.yahoo.athenz.zms.ZMSConsts.*;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.containsInAnyOrder;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;
import static org.testng.Assert.*;
import static org.testng.Assert.assertNull;

public class ZMSImplTest {

    private final ZMSTestInitializer zmsTestInitializer = new ZMSTestInitializer();
    private final long fetchDomainDependencyFrequency = 1L; // For the tests, fetch every second

    @BeforeClass
    public void startMemoryMySQL() {
        zmsTestInitializer.startMemoryMySQL();
    }

    @AfterClass
    public void stopMemoryMySQL() {
        zmsTestInitializer.stopMemoryMySQL();
    }

    @BeforeMethod
    public void setUp() throws Exception {
        System.setProperty(ZMS_PROP_SERVICE_PROVIDER_MANAGER_FREQUENCY_SECONDS, String.valueOf(fetchDomainDependencyFrequency));
        zmsTestInitializer.setUp();
    }

    @AfterMethod
    public void clearConnections() throws Exception {
        zmsTestInitializer.clearConnections();
        System.clearProperty(ZMS_PROP_SERVICE_PROVIDER_MANAGER_FREQUENCY_SECONDS);
        // Reset ServiceProviderManager Singleton
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        ServiceProviderManager.getInstance(zmsImpl.dbService, zmsImpl).shutdown();
        Field instance = ServiceProviderManager.class.getDeclaredField("instance");
        instance.setAccessible(true);
        instance.set(null, null);
    }

    static class TestAuditLogger implements AuditLogger {

        final List<String> logMsgList = new ArrayList<>();

        List<String> getLogMsgList() {
            return logMsgList;
        }

        public void log(String logMsg, String msgVersionTag) {
            logMsgList.add(logMsg);
        }
        public void log(AuditLogMsgBuilder msgBldr) {
            String msg = msgBldr.build();
            logMsgList.add(msg);
        }
        @Override
        public AuditLogMsgBuilder getMsgBuilder() {
            return new DefaultAuditLogMsgBuilder();
        }
    }

    @Test
    public void testSchema() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Schema schema = zmsImpl.schema();
        assertNotNull(schema);
    }

    @Test
    public void testGetAuditLogMsgBuildauditRefer() {
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        AuditLogMsgBuilder msgBldr = ZMSUtils.getAuditLogMsgBuilder(ctx, zmsTestInitializer.getAuditLogger(),
                "mydomain", auditRef, "myapi", "PUT");
        assertNotNull(msgBldr);
    }

    @Test
    public void testGetAuditLogMsgBuilderNullCtx() {
        final String auditRef = zmsTestInitializer.getAuditRef();
        AuditLogMsgBuilder msgBldr = ZMSUtils.getAuditLogMsgBuilder(null, zmsTestInitializer.getAuditLogger(),
                "mydomain", auditRef, "myapi", "PUT");
        assertNotNull(msgBldr);
    }

    @Test
    public void testGetAuditLogMsgBuilderNullPrincipal() {
        final String auditRef = zmsTestInitializer.getAuditRef();
        ResourceContext ctx = zmsTestInitializer.createResourceContext(null);
        AuditLogMsgBuilder msgBldr = ZMSUtils.getAuditLogMsgBuilder(ctx, zmsTestInitializer.getAuditLogger(),
                "mydomain", auditRef, "myapi", "PUT");
        assertNotNull(msgBldr);
    }

    @Test
    public void testGetAuditLogMsgBuilderTokenWithSig() {
        final String auditRef = zmsTestInitializer.getAuditRef();
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String userId     = "user1";
        String signature = "ABRACADABRA";
        String unsignedCreds = "v=U1;d=user;n=user1";
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds + ";s=" + signature,
                0, principalAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds); // set unsigned creds
        ResourceContext ctx = zmsTestInitializer.createResourceContext(principal);
        AuditLogMsgBuilder msgBldr = ZMSUtils.getAuditLogMsgBuilder(ctx, zmsTestInitializer.getAuditLogger(),
                "mydomain", auditRef, "myapi", "PUT");
        assertNotNull(msgBldr);
        String who = msgBldr.who();
        assertNotNull(who);
        assertTrue(who.contains(userId));
        assertFalse(who.contains(signature), "Should not contain the signature: " + who);
    }

    @Test
    public void testGetAuditLogMsgBuilderTokenSigMissing() {
        final String auditRef = zmsTestInitializer.getAuditRef();
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String userId     = "user1";
        String unsignedCreds = "v=U1;d=user;n=user1";
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds,
                0, principalAuthority);
        ResourceContext ctx = zmsTestInitializer.createResourceContext(principal);
        AuditLogMsgBuilder msgBldr = ZMSUtils.getAuditLogMsgBuilder(ctx, zmsTestInitializer.getAuditLogger(),
                "mydomain", auditRef, "myapi", "PUT");
        assertNotNull(msgBldr);
        String who = msgBldr.who();
        assertNotNull(who);
        assertTrue(who.contains(userId));
    }

    @Test
    public void testGetAuditLogMsgBuilderNullParams() {
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        AuditLogMsgBuilder msgBldr = ZMSUtils.getAuditLogMsgBuilder(ctx, zmsTestInitializer.getAuditLogger(),
                null, null, null, null);
        assertNotNull(msgBldr);
    }

    @Test
    public void testGetDomain() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        Domain domain = zmsImpl.getDomain(ctx, "sys.auth");
        assertNotNull(domain);
    }

    @Test
    public void testGetDomainThrowException() {
        try {
            ZMSImpl zmsImpl = zmsTestInitializer.getZms();
            RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
            zmsImpl.getDomain(ctx, "wrongDomain");
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testPostDomain() {
        String domName = "olddominion";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        try {
            zmsImpl.deleteTopLevelDomain(ctx, domName, auditRef, null);
        } catch (ResourceException re) {
            assertEquals(re.getCode(), 404);
        }

        TopLevelDomain dom = new TopLevelDomain();
        dom.setName(domName);
        dom.setDescription("old virginny");
        dom.setOrg("universities");
        dom.setYpmId(1930);
        dom.setProductId("abcd-1930");

        List<String> admins = new ArrayList<>();
        admins.add(zmsTestInitializer.getAdminUser());
        admins.add(ctx.principal().getFullName());
        dom.setAdminUsers(admins);

        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        // post subdomain
        String subDomName = "extension";
        SubDomain subDom = zmsTestInitializer.createSubDomainObject(subDomName, domName,
                "old dominion extension", "education", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, domName, auditRef, null, subDom);

        // post subdomain that is too big - default length is 128
        String subDomNameBad = "extension0extension0extension0extension0";
        subDomNameBad = subDomNameBad.concat("extension0extension0extension0extension0");
        subDomNameBad = subDomNameBad.concat("extension0extension0extension0extension0");

        subDom = zmsTestInitializer.createSubDomainObject(subDomNameBad, domName,
                "old dominion extension+++", "education", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.postSubDomain(ctx, domName, auditRef, null, subDom);
            fail("requesterror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Invalid SubDomain name"));
            assertTrue(ex.getMessage().contains("name length cannot exceed"));
        }

        zmsImpl.deleteSubDomain(ctx, domName, subDomName, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domName, auditRef, null);
    }

    @Test
    public void testPostDomainNullObject() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, null);
            fail("requesterror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }
    }

    @Test
    public void testPostTopLevelDomainNoProductId() {

        // enable product id support

        System.setProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT, "true");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domName = "jabberwocky";
        try {
            zmsImpl.deleteTopLevelDomain(ctx, domName, auditRef, null);
        } catch (ResourceException re) {
            assertEquals(re.getCode(), 404);
        }

        TopLevelDomain dom = new TopLevelDomain();
        dom.setName(domName);
        dom.setDescription("mythic animal");
        dom.setOrg("animals");

        List<String> admins = new ArrayList<>();
        admins.add(zmsTestInitializer.getAdminUser());
        dom.setAdminUsers(admins);

        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);
            fail("requesterror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Product Id is required when creating top level domain"));
        }

        System.clearProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testPostTopLevelDomainReservedName() {

        // set up our configured setting for reserved domain names

        System.setProperty(ZMS_PROP_RESERVED_DOMAIN_NAMES, "athenz,system,home");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom = new TopLevelDomain();
        dom.setName("athenz");

        List<String> admins = new ArrayList<>();
        admins.add(zmsTestInitializer.getAdminUser());
        dom.setAdminUsers(admins);

        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);
            fail("request error not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Domain name is reserved"));
        }

        try {
            dom.setName("home");
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);
            fail("request error not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Domain name is reserved"));
        }

        dom.setName("not-reserved-name");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);
        zmsImpl.deleteTopLevelDomain(ctx, dom.getName(), auditRef, null);

        System.clearProperty(ZMSConsts.ZMS_PROP_RESERVED_DOMAIN_NAMES);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testPostTopLevelDomainNameTooLong() {

        // have 129 chars - default is 128

        final String domName = Strings.repeat("a", 129);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        try {
            zmsImpl.deleteTopLevelDomain(ctx, domName, auditRef, null);
        } catch (ResourceException re) {
            assertEquals(re.getCode(), 404);
        }

        TopLevelDomain dom = new TopLevelDomain();
        dom.setName(domName);
        dom.setDescription("bigun");
        dom.setOrg("bigdog");

        List<String> admins = new ArrayList<>();
        admins.add(zmsTestInitializer.getAdminUser());
        dom.setAdminUsers(admins);

        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);
            fail("requesterror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("name length cannot exceed"));
        }
    }

    @Test
    public void testPostDomainNameOnSizeLimit() {

        // set the domain size limit to 45
        System.setProperty(ZMSConsts.ZMS_PROP_DOMAIN_NAME_MAX_SIZE, "45");

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // have 45 chars
        final String domName = Strings.repeat("a", 45);

        try {
            zmsImpl.deleteTopLevelDomain(ctx, domName, auditRef, null);
        } catch (ResourceException re) {
            assertEquals(re.getCode(), 404);
        }

        TopLevelDomain dom = new TopLevelDomain();
        dom.setName(domName);
        dom.setDescription("bigun");
        dom.setOrg("bigdog");
        dom.setYpmId(999999);
        dom.setProductId("abcd-999999");

        List<String> admins = new ArrayList<>();
        admins.add(zmsTestInitializer.getAdminUser());
        admins.add(ctx.principal().getFullName());
        dom.setAdminUsers(admins);

        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        // post subdomain which will be too big by 1 char
        String subDomNameBad = "B";
        SubDomain subDom = zmsTestInitializer.createSubDomainObject(subDomNameBad, domName,
                "1 char too many", "dogs", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.postSubDomain(ctx, domName, auditRef, null, subDom);
            fail("requesterror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Invalid SubDomain name"));
            assertTrue(ex.getMessage().contains("name length cannot exceed"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domName, auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_DOMAIN_NAME_MAX_SIZE);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testPostTopLevelDomainNameReduceSizeLimitTooSmall() {

        // lower name length to 5 which should be reset internally to the default
        System.setProperty(ZMSConsts.ZMS_PROP_DOMAIN_NAME_MAX_SIZE, "5");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domName = "abcdef7890";
        try {
            zmsImpl.deleteTopLevelDomain(ctx, domName, auditRef, null);
        } catch (ResourceException re) {
            assertEquals(re.getCode(), 404);
        }

        TopLevelDomain dom = new TopLevelDomain();
        dom.setName(domName);
        dom.setDescription("bigun");
        dom.setOrg("bigdog");
        dom.setYpmId(77777);
        dom.setProductId("abcd-77777");

        List<String> admins = new ArrayList<>();
        admins.add(zmsTestInitializer.getAdminUser());
        dom.setAdminUsers(admins);

        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);
        zmsImpl.deleteTopLevelDomain(ctx, domName, auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_DOMAIN_NAME_MAX_SIZE);
        zmsImpl.objectStore.clearConnections();
    }
    
    @Test
    public void testGetDomainList() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ListDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("ListDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, null, null, null, null, null, null, null);
        assertNotNull(domList);

        assertTrue(domList.getNames().contains("ListDom1".toLowerCase()));
        assertTrue(domList.getNames().contains("ListDom2".toLowerCase()));

        zmsImpl.deleteTopLevelDomain(ctx, "ListDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "ListDom2", auditRef, null);
    }

    @Test
    public void testGetDomainListByAccount() {

        final String domainName = "lookupdomainaccount";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setAccount("1234");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                "1234", null, null, null, null, null, null, null, null, null, null);
        assertNotNull(domList.getNames());
        assertEquals(domList.getNames().size(), 1);
        assertEquals(domList.getNames().get(0), domainName);

        domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                "1235", null, null, null, null, null, null, null, null, null, null);
        assertNull(domList.getNames());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetDomainListByAzureSubscription() {

        final String domainName = "lookup-domain-azure-subscription";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1",
                "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setAzureSubscription("azure1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, "azure1", null, null, null, null, null, null);
        assertNotNull(domList.getNames());
        assertEquals(domList.getNames().size(), 1);
        assertEquals(domList.getNames().get(0), domainName);

        domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, "azure2", null, null, null, null, null, null);
        assertNull(domList.getNames());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetDomainListByGcpProject() {

        final String domainName = "lookup-domain-gcp-project";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1",
                "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setGcpProject("gcp1");
        dom1.setGcpProjectNumber("1238");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, null, "gcp1", null, null, null, null, null);
        assertNotNull(domList.getNames());
        assertEquals(domList.getNames().size(), 1);
        assertEquals(domList.getNames().get(0), domainName);

        domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, null, "gcp2", null, null, null, null, null);
        assertNull(domList.getNames());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetDomainListByBusinessService() {

        final String domainName1 = "lookup-domain-business-service1";
        final String domainName2 = "lookup-domain-business-service2";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1, "Test Domain1",
                "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setBusinessService("sports");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2, "Test Domain2",
                "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, null, null, null, null, "sports", null, null);
        assertNotNull(domList.getNames());
        assertEquals(domList.getNames().size(), 1);
        assertEquals(domList.getNames().get(0), domainName1);

        // now let's get 2 domains with same service name

        DomainMeta dm = new DomainMeta().setBusinessService("sports");
        zmsImpl.putDomainMeta(ctx, domainName2, auditRef, null, dm);

        domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, null, null, null, null, "sports", null, null);
        assertNotNull(domList.getNames());
        assertEquals(domList.getNames().size(), 2);
        assertTrue(domList.getNames().contains(domainName1));
        assertTrue(domList.getNames().contains(domainName2));

        // unknown service - no match

        domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, null, null, null, null, "unknown-service", null, null);
        assertNotNull(domList.getNames());
        assertTrue(domList.getNames().isEmpty());

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName2, auditRef, null);
    }

    @Test
    public void testGetDomainListByRoleDetails() {

        final String domainName = "lookup-domain-role-details";
        final String roleName = "role-test1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.user101", null);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, "user.user101", roleName, null, null, null, null, null, null, null);
        assertNotNull(domList.getNames());
        assertEquals(domList.getNames().size(), 1);
        assertEquals(domList.getNames().get(0), domainName);

        domList = zmsImpl.getDomainList(ctx, null, null, null, null, null, null,
                "user.user101", "unknown-role-name", null, null, null, null, null, null, null);
        assertTrue(domList.getNames().isEmpty());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetDomainListByProductNumber() {

        final String domainName = "lookupdomainbyproductnumber";
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // enable product id support

        System.setProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT, "true");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setYpmId(101);
        dom1.setProductId("abcd-101");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null,
                null, null, 101, null, null, null, null, null, null, null, null, null);
        assertNotNull(domList.getNames());
        assertEquals(domList.getNames().size(), 1);
        assertEquals(domList.getNames().get(0), domainName);

        domList = zmsImpl.getDomainList(ctx, null, null, null, null, null,
                102, null, null, null, null, null, null, null, null, null);
        assertNull(domList.getNames());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testGetDomainListByProductId() {

        final String domainName = "lookupdomainbyproductid";
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // enable product id support

        System.setProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT, "true");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setYpmId(101);
        dom1.setProductId("abcd-101");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null,
                null, null, null, null, null, null, null, null, null, null, "abcd-101", null);
        assertNotNull(domList.getNames());
        assertEquals(domList.getNames().size(), 1);
        assertEquals(domList.getNames().get(0), domainName);

        domList = zmsImpl.getDomainList(ctx, null, null, null, null, null,
                null, null, null, null, null, null, null, null, "abcd-=102", null);
        assertNull(domList.getNames());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testGetDomainListIfModifiedSince() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ListDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // let's get the current time

        Date now = new Date();
        DateFormat df = new SimpleDateFormat("EEE, d MMM yyyy HH:mm:ss zzz");
        String modifiedSince = df.format(now);

        ZMSUtils.threadSleep(2000);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("ListDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null,
                null, null, null, null, null, null, null, null, null, null, null, modifiedSince);
        assertNotNull(domList);

        assertTrue(domList.getNames().contains("ListDom2".toLowerCase()));

        zmsImpl.deleteTopLevelDomain(ctx, "ListDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "ListDom2", auditRef, null);
    }

    @Test
    public void testGetDomainListInvalidIfModifiedSince() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getDomainList(ctx, null, null, null, null, null,
                    null, null, null, null, null, null, null, null, null, "abc");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        try {
            zmsImpl.getDomainList(ctx, null, null, null, null, null,
                    null, null, null, null, null, null, null, null, null, "May 20, 1099");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        try {
            zmsImpl.getDomainList(ctx, null, null, null, null, null,
                    null, null, null, null, null, null, null, null, null, "03:03:20 PM");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }
    }

    @Test
    public void testGetDomainListParamsLimit() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("LimitDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("LimitDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainList domList = zmsImpl.getDomainList(ctx, 1, null, null,
                null, null, null, null, null, null, null, null, null, null, null, null);
        assertEquals(1, domList.getNames().size());

        zmsImpl.deleteTopLevelDomain(ctx, "LimitDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "LimitDom2", auditRef, null);
    }

    @Test
    public void testGetDomainListParamsSkip() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("SkipDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("SkipDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        TopLevelDomain dom3 = zmsTestInitializer.createTopLevelDomainObject("SkipDom3",
                "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom3);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null,
                null, null, null, null, null, null, null, null, null, null, null, null);
        int size = domList.getNames().size();
        assertTrue(size > 3);

        // ask for only for 2 domains back
        domList = zmsImpl.getDomainList(ctx, 2, null, null, null, null,
                null, null, null, null, null, null, null, null, null, null);
        assertEquals(domList.getNames().size(), 2);

        // ask for the remaining domains
        DomainList remList = zmsImpl.getDomainList(ctx, null, domList.getNext(),
                null, null, null, null, null, null, null, null, null, null, null, null, null);
        assertEquals(remList.getNames().size(), size - 2);

        zmsImpl.deleteTopLevelDomain(ctx, "SkipDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "SkipDom2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "SkipDom3", auditRef, null);
    }

    @Test
    public void testGetDomainListParamsPrefix() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("NoPrefixDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("PrefixDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null,
                "Prefix", null, null, null, null, null, null, null, null, null, null, null, null);

        assertFalse(domList.getNames().contains("NoPrefixDom1".toLowerCase()));
        assertTrue(domList.getNames().contains("PrefixDom2".toLowerCase()));

        zmsImpl.deleteTopLevelDomain(ctx, "NoPrefixDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "PrefixDom2", auditRef, null);
    }

    @Test
    public void testGetDomainListParamsDepth() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("DepthDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        SubDomain dom2 = zmsTestInitializer.createSubDomainObject("DepthDom2", "DepthDom1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postSubDomain(ctx, "DepthDom1", auditRef, null, dom2);

        SubDomain dom3 = zmsTestInitializer.createSubDomainObject("DepthDom3",
                "DepthDom1.DepthDom2", "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "DepthDom1.DepthDom2", auditRef, null, dom3);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null,
                1, null, null, null, null, null, null, null, null, null, null, null);

        assertTrue(domList.getNames().contains("DepthDom1".toLowerCase()));
        assertTrue(domList.getNames().contains("DepthDom1.DepthDom2".toLowerCase()));
        assertFalse(domList.getNames().contains("DepthDom1.DepthDom2.DepthDom3".toLowerCase()));

        zmsImpl.deleteSubDomain(ctx, "DepthDom1.DepthDom2", "DepthDom3", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "DepthDom1", "DepthDom2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "DepthDom1", auditRef, null);
    }

    @Test
    public void testGetDomainListThrowException() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getDomainList(ctx, -1, null, null, null, null, null, null,
                    null, null, null, null, null, null, null, null);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }
    }

    @Test
    public void testCreateTopLevelDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AddTopDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        Domain resDom1 = zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        assertNotNull(resDom1);

        Domain resDom2 = zmsImpl.getDomain(ctx, "AddTopDom1");
        assertNotNull(resDom2);

        zmsImpl.deleteTopLevelDomain(ctx, "AddTopDom1", auditRef, null);
    }

    @Test
    public void testCreateTopLevelDomainOnceOnly() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AddOnceTopDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        Domain resDom1 = zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        assertNotNull(resDom1);

        // we should get an exception for the second call

        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "AddOnceTopDom1", auditRef, null);
    }

    @Test
    public void testCreateSubDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AddSubDom1",
            "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        SubDomain dom2 = zmsTestInitializer.createSubDomainObject("AddSubDom2", "AddSubDom1",
            "Test Domain2", null, zmsTestInitializer.getAdminUser());
        Domain resDom1 = zmsImpl.postSubDomain(ctx, "AddSubDom1", auditRef, null, dom2);
        assertNotNull(resDom1);

        Domain resDom2 = zmsImpl.getDomain(ctx, "AddSubDom1.AddSubDom2");
        assertNotNull(resDom2);

        assertEquals(dom2.getOrg(), "testorg");
        assertFalse(resDom2.getAuditEnabled());

        zmsImpl.deleteSubDomain(ctx, "AddSubDom1", "AddSubDom2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "AddSubDom1", auditRef, null);
    }

    @Test
    public void testCreateSubDomainInAuditEnabledParent() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AddSubDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Test Domain1", "testOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "AddSubDom1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "AddSubDom1", "auditenabled", auditRef, meta);

        SubDomain dom2 = zmsTestInitializer.createSubDomainObject("AddSubDom2", "AddSubDom1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        Domain resDom1 = zmsImpl.postSubDomain(ctx, "AddSubDom1", auditRef, null, dom2);
        assertNotNull(resDom1);

        Domain resDom2 = zmsImpl.getDomain(ctx, "AddSubDom1.AddSubDom2");
        assertNotNull(resDom2);

        assertTrue(resDom2.getAuditEnabled());

        zmsImpl.deleteSubDomain(ctx, "AddSubDom1", "AddSubDom2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "AddSubDom1", auditRef, null);
    }

    @Test
    public void testCreateUserDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        final String auditRef = zmsTestInitializer.getAuditRef();

        RsrcCtxWrapper ctx = zmsTestInitializer.contextWithMockPrincipal("postUserDomain");
        UserDomain dom1 = zmsTestInitializer.createUserDomainObject("john-doe", "Test Domain1", "testOrg");
        zmsImpl.postUserDomain(ctx, "john-doe", auditRef, null, dom1);

        assertSingleChangeMessage(ctx.getDomainChangeMessages(), DOMAIN, "user.john-doe",
                "user.john-doe", "postUserDomain");
        
        Domain resDom2 = zmsImpl.getDomain(ctx, "user.john-doe");
        assertNotNull(resDom2);

        RsrcCtxWrapper deleteCtx = zmsTestInitializer.contextWithMockPrincipal("deleteUserDomain");
        zmsImpl.deleteUserDomain(deleteCtx, "john-doe", auditRef, null);
        assertSingleChangeMessage(deleteCtx.getDomainChangeMessages(), DOMAIN, "user.john-doe",
                "user.john-doe", "deleteUserDomain");
    }

    @Test
    public void testCreateUserDomainWithTemplates() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain domSysSecurity = zmsTestInitializer.createSubDomainObject("security", "sys", "Test Domain",
                "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postSubDomain(ctx, "sys", auditRef, null, domSysSecurity);

        UserDomain dom1 = zmsTestInitializer.createUserDomainObject("john-doe", "Test Domain1", "testOrg");
        DomainTemplateList templates = new DomainTemplateList();
        List<String> templateNames = new ArrayList<>();
        templateNames.add("network");
        templates.setTemplateNames(templateNames);
        dom1.setTemplates(templates);
        zmsImpl.postUserDomain(ctx, "john-doe", auditRef, null, dom1);

        Domain resDom2 = zmsImpl.getDomain(ctx, "user.john-doe");
        assertNotNull(resDom2);
        templates = zmsImpl.getDomainTemplateList(ctx, "user.john-doe");
        assertEquals(templates.getTemplateNames().size(), 1);
        assertEquals(templates.getTemplateNames().get(0), "network");

        zmsImpl.deleteSubDomain(ctx, "sys", "security", auditRef, null);
        zmsImpl.deleteUserDomain(ctx, "john-doe", auditRef, null);
    }

    @Test
    public void testCreateUserDomainMismatch() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        UserDomain dom1 = zmsTestInitializer.createUserDomainObject("john-doe", "Test Domain Mismatch", "testMismatchOrg");
        try {
            zmsImpl.postUserDomain(ctx, "john-doe2", auditRef, null, dom1);
        } catch (ResourceException ex) {
            assertEquals(403, ex.getCode());
        }
    }

    @Test
    public void testCreateSubDomainNoParent() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain dom = zmsTestInitializer.createSubDomainObject("sub", "parent",
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.postSubDomain(ctx, "parent", auditRef, null, dom);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        // now first create the parent

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("parent",
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // and then create the subdomain

        Domain resDom = zmsImpl.postSubDomain(ctx, "parent", auditRef, null, dom);
        assertNotNull(resDom);

        // clean up domains

        zmsImpl.deleteSubDomain(ctx, "parent", "sub", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "parent", auditRef, null);
    }

    @Test
    public void testCreateSubDomainWithVirtualLimit() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT, "2");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();


        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("SubDomNoVirtual",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        SubDomain dom = zmsTestInitializer.createSubDomainObject("sub1", "SubDomNoVirtual",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        Domain resDom = zmsTest.postSubDomain(ctx, "SubDomNoVirtual", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub2", "SubDomNoVirtual",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "SubDomNoVirtual", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub3", "SubDomNoVirtual",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "SubDomNoVirtual", auditRef, null, dom);
        assertNotNull(resDom);

        zmsImpl.deleteSubDomain(ctx, "SubDomNoVirtual", "sub3", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "SubDomNoVirtual", "sub2", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "SubDomNoVirtual", "sub1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "SubDomNoVirtual", auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT);
    }

    @Test
    public void testCreateSubDomainVirtual() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT, "5");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain dom = zmsTestInitializer.createSubDomainObject("user1", "user",
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        Domain resDom = zmsTest.postSubDomain(ctx, "user", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub1", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub2", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub3", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub1a", "user.user1.sub1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        resDom = zmsTest.postSubDomain(ctx, "user.user1.sub1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub1aa", "user.user1.sub1.sub1a",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1.sub1.sub1a", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub1ab", "user.user1.sub1.sub1a",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsTest.postSubDomain(ctx, "user.user1.sub1.sub1a", auditRef, null, dom);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        dom = zmsTestInitializer.createSubDomainObject("sub4", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, dom);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        zmsImpl.deleteSubDomain(ctx, "user.user1.sub1.sub1a", "sub1aa", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1.sub1", "sub1a", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub3", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub2", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT);
    }

    @Test
    public void testCreateSubDomainVirtualNoLimit() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT, "0");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain dom = zmsTestInitializer.createSubDomainObject("user1", "user",
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        Domain resDom = zmsTest.postSubDomain(ctx, "user", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub1", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub2", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub3", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub4", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub5", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub6", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsTest.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub6", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub5", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub4", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub3", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub2", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT);
    }

    @Test
    public void testCreateSubDomainMismatchParent() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AddSubMismatchParentDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        SubDomain dom2 = zmsTestInitializer.createSubDomainObject("AddSubDom2", "AddSubMismatchParentDom1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());

        try {
            zmsImpl.postSubDomain(ctx, "AddSubMismatchParentDom2", auditRef, null, dom2);
        } catch (ResourceException ex) {
            assertEquals(403, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "AddSubMismatchParentDom1", auditRef, null);
    }

    @Test
    public void testCreateSubdomainOnceOnly() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AddOnceSubDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        SubDomain dom2 = zmsTestInitializer.createSubDomainObject("AddOnceSubDom2",
                "AddOnceSubDom1", "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        Domain resDom1 = zmsImpl.postSubDomain(ctx, "AddOnceSubDom1", auditRef, null, dom2);
        assertNotNull(resDom1);

        // we should get an exception for the second call

        try {
            zmsImpl.postSubDomain(ctx, "AddOnceSubDom1", auditRef, null, dom2);
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        zmsImpl.deleteSubDomain(ctx, "AddOnceSubDom1", "AddOnceSubDom2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "AddOnceSubDom1", auditRef, null);
    }

    @Test
    public void testPutDomainMetaThrowException() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domName = "wrongDomainName";
        DomainMeta meta = new DomainMeta();
        meta.setYpmId(ZMSTestInitializer.getRandomProductId());
        try {
            zmsImpl.putDomainMeta(ctx, domName, auditRef, null, meta);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(404, e.getCode());
        }
    }

    @Test
    public void testPutDomainMeta() {

        final String domainName = "domain-meta-test";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Domain resDom1 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom1);
        assertEquals(resDom1.getDescription(), "Test Domain1");
        assertEquals(resDom1.getOrg(), "testorg");
        assertTrue(resDom1.getEnabled());
        assertFalse(resDom1.getAuditEnabled());
        assertNull(resDom1.getServiceCertExpiryMins());
        assertNull(resDom1.getRoleCertExpiryMins());
        assertNull(resDom1.getMemberExpiryDays());
        assertNull(resDom1.getServiceExpiryDays());
        assertNull(resDom1.getGroupExpiryDays());
        assertNull(resDom1.getTokenExpiryMins());
        assertNull(resDom1.getMemberPurgeExpiryDays());
        assertNull(resDom1.getProductId());

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Test2 Domain", "NewOrg",
                true, true, "12345", 1001);
        meta.setCertDnsDomain("YAHOO.cloud");
        meta.setServiceCertExpiryMins(100);
        meta.setRoleCertExpiryMins(200);
        meta.setMemberPurgeExpiryDays(90);
        meta.setSignAlgorithm("ec");
        meta.setProductId("abcd-1234");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "account", auditRef, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "certdnsdomain", auditRef, meta);

        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                domainName, "domain", "productid", "org", "certdnsdomain");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "org", auditRef, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "productid", auditRef, meta);

        Domain resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getDescription(), "Test2 Domain");
        assertEquals(resDom3.getOrg(), "neworg");
        assertTrue(resDom3.getEnabled());
        assertTrue(resDom3.getAuditEnabled());
        assertEquals(resDom3.getAccount(), "12345");
        assertEquals(Integer.valueOf(1001), resDom3.getYpmId());
        assertEquals(resDom3.getProductId(), "abcd-1234");
        assertEquals(resDom3.getCertDnsDomain(), "yahoo.cloud");
        assertEquals(resDom3.getServiceCertExpiryMins(), Integer.valueOf(100));
        assertEquals(resDom3.getMemberPurgeExpiryDays(), Integer.valueOf(90));
        assertEquals(resDom3.getRoleCertExpiryMins(), Integer.valueOf(200));
        assertNull(resDom3.getMemberExpiryDays());
        assertNull(resDom3.getServiceExpiryDays());
        assertNull(resDom3.getGroupExpiryDays());
        assertNull(resDom3.getTokenExpiryMins());
        assertEquals(resDom3.getSignAlgorithm(), "ec");

        // put the metadata using same product id

        meta = zmsTestInitializer.createDomainMetaObject("just a new desc", "organs",
                true, true, "12345", 1001);
        meta.setMemberExpiryDays(300);
        meta.setServiceExpiryDays(350);
        meta.setGroupExpiryDays(375);
        meta.setTokenExpiryMins(400);
        meta.setProductId("abcd-1234");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);

        resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getDescription(), "just a new desc");
        //org is system attr. so it won't be changed by putdomainmeta call
        assertEquals(resDom3.getOrg(), "neworg");
        assertTrue(resDom3.getEnabled());
        assertTrue(resDom3.getAuditEnabled());
        assertEquals(resDom3.getAccount(), "12345");
        assertEquals(resDom3.getProductId(), "abcd-1234");
        assertEquals(Integer.valueOf(1001), resDom3.getYpmId());
        assertEquals(resDom3.getServiceCertExpiryMins(), Integer.valueOf(100));
        assertEquals(resDom3.getRoleCertExpiryMins(), Integer.valueOf(200));
        assertEquals(resDom3.getMemberExpiryDays(), Integer.valueOf(300));
        assertEquals(resDom3.getServiceExpiryDays(), Integer.valueOf(350));
        assertEquals(resDom3.getGroupExpiryDays(), Integer.valueOf(375));
        assertEquals(resDom3.getTokenExpiryMins(), Integer.valueOf(400));
        assertEquals(resDom3.getMemberPurgeExpiryDays(), Integer.valueOf(90));

        zmsImpl.putDomainSystemMeta(ctx, domainName, "org", auditRef, meta);
        resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getOrg(), "organs");

        // put the metadata using new product
        meta = zmsTestInitializer.createDomainMetaObject("just a new desc", "organs",
                true, true, "12345", 1001);
        Integer newProductId = ZMSTestInitializer.getRandomProductId();
        meta.setYpmId(newProductId);
        meta.setProductId("abcd-1234-5678");
        meta.setServiceCertExpiryMins(5);
        meta.setRoleCertExpiryMins(0);
        meta.setMemberExpiryDays(15);
        meta.setServiceExpiryDays(17);
        meta.setGroupExpiryDays(18);
        meta.setTokenExpiryMins(20);
        meta.setMemberPurgeExpiryDays(120);
        meta.setSignAlgorithm("rsa");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "productid", auditRef, meta);

        resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getDescription(), "just a new desc");
        assertEquals(resDom3.getOrg(), "organs");
        assertTrue(resDom3.getEnabled());
        assertTrue(resDom3.getAuditEnabled());
        assertEquals(resDom3.getAccount(), "12345");
        assertEquals(resDom3.getProductId(), "abcd-1234-5678");
        assertEquals(newProductId, resDom3.getYpmId());
        assertEquals(resDom3.getServiceCertExpiryMins(), Integer.valueOf(5));
        assertNull(resDom3.getRoleCertExpiryMins());
        assertEquals(resDom3.getMemberExpiryDays(), Integer.valueOf(15));
        assertEquals(resDom3.getServiceExpiryDays(), Integer.valueOf(17));
        assertEquals(resDom3.getGroupExpiryDays(), Integer.valueOf(18));
        assertEquals(resDom3.getTokenExpiryMins(), Integer.valueOf(20));
        assertEquals(resDom3.getMemberPurgeExpiryDays(), Integer.valueOf(120));
        assertEquals(resDom3.getSignAlgorithm(), "rsa");
        assertNull(resDom3.getFeatureFlags());

        // put new feature flags for the domain

        meta.setFeatureFlags(3);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "featureflags", auditRef, meta);

        resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getDescription(), "just a new desc");
        assertEquals(resDom3.getOrg(), "organs");
        assertTrue(resDom3.getEnabled());
        assertTrue(resDom3.getAuditEnabled());
        assertEquals(resDom3.getAccount(), "12345");
        assertEquals(resDom3.getProductId(), "abcd-1234-5678");
        assertEquals(newProductId, resDom3.getYpmId());
        assertEquals(resDom3.getServiceCertExpiryMins(), Integer.valueOf(5));
        assertNull(resDom3.getRoleCertExpiryMins());
        assertEquals(resDom3.getMemberExpiryDays(), Integer.valueOf(15));
        assertEquals(resDom3.getServiceExpiryDays(), Integer.valueOf(17));
        assertEquals(resDom3.getGroupExpiryDays(), Integer.valueOf(18));
        assertEquals(resDom3.getTokenExpiryMins(), Integer.valueOf(20));
        assertEquals(resDom3.getMemberPurgeExpiryDays(), Integer.valueOf(120));
        assertEquals(resDom3.getSignAlgorithm(), "rsa");
        assertEquals(resDom3.getFeatureFlags().intValue(), 3);

        // update the feature flags value

        meta.setFeatureFlags(7);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "featureflags", auditRef, meta);
        resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertEquals(resDom3.getFeatureFlags().intValue(), 7);

        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutDomainSystemMetaModifiedTimestamp() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "metadomainmodified";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Domain resDom1 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom1);
        long domMod1 = resDom1.getModified().millis();

        ZMSTestUtils.sleep(1);

        DomainMeta meta = new DomainMeta();
        zmsImpl.putDomainSystemMeta(ctx, domainName, "modified", auditRef, meta);

        Domain resDom2 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom2);
        long domMod2 = resDom2.getModified().millis();

        assertTrue(domMod2 > domMod1);
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutDomainMetaInvalid() {

        // enable product id support

        System.setProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT, "true");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "MetaDomProductid";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Domain resDom = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom);
        assertEquals(resDom.getDescription(), "Test Domain");
        assertEquals(resDom.getOrg(), "testorg");
        assertTrue(resDom.getEnabled());
        assertFalse(resDom.getAuditEnabled());
        Integer productId = resDom.getYpmId();

        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                domainName, "domain", "productid");
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Test2 Domain", "NewOrg",
                true, true, "12345", null);
        try {
            zmsImpl.putDomainSystemMeta(ctx, domainName, "productid", auditRef, meta);
            fail("bad request exc not thrown");
        } catch (ResourceException exc) {
            assertEquals(400, exc.getCode());
            assertTrue(exc.getMessage().contains("Unique Product Id must be specified for top level domain"));
        }

        // put metadata using another domains productId
        dom = zmsTestInitializer.createTopLevelDomainObject("MetaDomProductid2",
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        resDom = zmsImpl.getDomain(ctx, "MetaDomProductid2");
        Integer productId2 = resDom.getYpmId();
        assertNotEquals(productId, productId2);

        meta = zmsTestInitializer.createDomainMetaObject("Test3 Domain", "NewOrg",
                true, true, "12345", productId2);
        try {
            zmsImpl.putDomainSystemMeta(ctx, domainName, "productid", auditRef, meta);
            fail("bad request exc not thrown");
        } catch (ResourceException exc) {
            assertEquals(400, exc.getCode());
            assertTrue(exc.getMessage().contains("is already assigned to domain"));
        }

        // test negative values

        meta = new DomainMeta().setServiceExpiryDays(-10);
        try {
            zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        meta = new DomainMeta().setGroupExpiryDays(-10);
        try {
            zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        meta = new DomainMeta().setMemberExpiryDays(-10);
        try {
            zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        meta = new DomainMeta().setRoleCertExpiryMins(-10);
        try {
            zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        meta = new DomainMeta().setServiceCertExpiryMins(-10);
        try {
            zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        meta = new DomainMeta().setTokenExpiryMins(-10);
        try {
            zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");
        zmsImpl.deleteTopLevelDomain(ctx, "MetaDomProductid", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "MetaDomProductid2", auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testPutDomainMetaDefaults() {

        final String domainName = "meta-dom-values";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, null, null,
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Domain resDom1 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom1);
        assertNull(resDom1.getDescription());
        assertNull(resDom1.getOrg());
        assertTrue(resDom1.getEnabled());
        assertFalse(resDom1.getAuditEnabled());

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Test2 Domain", "NewOrg", true, false, null, 0);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);

        zmsImpl.putDomainSystemMeta(ctx, domainName, "org", auditRef, meta);

        Domain resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getDescription(), "Test2 Domain");
        assertEquals(resDom3.getOrg(), "neworg");
        assertTrue(resDom3.getEnabled());
        assertFalse(resDom3.getAuditEnabled());
        assertNull(resDom3.getAccount());
        assertNull(resDom3.getAzureSubscription());
        assertNull(resDom3.getGcpProject());
        assertNull(resDom3.getBusinessService());
        assertEquals(Integer.valueOf(0), resDom3.getYpmId());

        meta.setAccount("aws");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "account", auditRef, meta);
        resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getOrg(), "neworg");
        assertEquals(resDom3.getAccount(), "aws");
        assertNull(resDom3.getAzureSubscription());
        assertNull(resDom3.getGcpProject());
        assertNull(resDom3.getBusinessService());

        meta.setAzureSubscription("azure");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "azuresubscription", auditRef, meta);
        resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getOrg(), "neworg");
        assertEquals(resDom3.getAccount(), "aws");
        assertEquals(resDom3.getAzureSubscription(), "azure");
        assertNull(resDom3.getGcpProject());
        assertNull(resDom3.getGcpProjectNumber());
        assertNull(resDom3.getBusinessService());

        meta.setGcpProject("gcp");
        meta.setGcpProjectNumber("1239");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "gcpproject", auditRef, meta);
        resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getOrg(), "neworg");
        assertEquals(resDom3.getAccount(), "aws");
        assertEquals(resDom3.getAzureSubscription(), "azure");
        assertEquals(resDom3.getGcpProject(), "gcp");
        assertEquals(resDom3.getGcpProjectNumber(), "1239");
        assertNull(resDom3.getBusinessService());

        meta.setBusinessService("123:business service");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "businessservice", auditRef, meta);
        resDom3 = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(resDom3);
        assertEquals(resDom3.getOrg(), "neworg");
        assertEquals(resDom3.getAccount(), "aws");
        assertEquals(resDom3.getAzureSubscription(), "azure");
        assertEquals(resDom3.getGcpProject(), "gcp");
        assertEquals(resDom3.getGcpProjectNumber(), "1239");
        assertEquals(resDom3.getBusinessService(), "123:business service");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutDomainMetaMissingAuditRef() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testSetDomainMetaMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test1 Domain", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Domain resDom = zmsImpl.getDomain(ctx, domain);
        assertNotNull(resDom);
        assertEquals(resDom.getDescription(), "Test1 Domain");
        assertEquals(resDom.getOrg(), "testorg");
        assertTrue(resDom.getAuditEnabled());

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Test2 Domain", "NewOrg", false, true, null, 0);
        try {
            zmsImpl.putDomainMeta(ctx, domain, null, null, meta);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testPutDomainMetaSubDomain() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        try {
            TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject("MetaDomProductid",
                    "Test Domain", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);
        } catch (ResourceException rexc) {
            assertEquals(400, rexc.getCode());
        }

        SubDomain subDom = zmsTestInitializer.createSubDomainObject("metaSubDom", "MetaDomProductid",
                "sub Domain", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "MetaDomProductid", auditRef, null, subDom);

        // put metadata with null productId
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Test sub Domain", "NewOrg",
                true, true, "12345", null);
        zmsImpl.putDomainMeta(ctx, "MetaDomProductid.metaSubDom", auditRef, null, meta);

        // put metadata with a productId
        meta = zmsTestInitializer.createDomainMetaObject("Test sub Domain", "NewOrg",
                true, true, "12345", ZMSTestInitializer.getRandomProductId());
        zmsImpl.putDomainMeta(ctx, "MetaDomProductid.metaSubDom", auditRef, null, meta);

        // set the expiry days to 30

        meta.setMemberExpiryDays(30);
        meta.setServiceExpiryDays(25);
        meta.setGroupExpiryDays(35);
        zmsImpl.putDomainMeta(ctx, "MetaDomProductid.metaSubDom", auditRef, null, meta);
        Domain domain = zmsImpl.getDomain(ctx, "MetaDomProductid.metaSubDom");
        assertEquals(domain.getMemberExpiryDays(), Integer.valueOf(30));
        assertEquals(domain.getServiceExpiryDays(), Integer.valueOf(25));
        assertEquals(domain.getGroupExpiryDays(), Integer.valueOf(35));

        // if value is null we're not going to change it

        meta.setMemberExpiryDays(null);
        meta.setServiceExpiryDays(null);
        meta.setGroupExpiryDays(null);
        meta.setDescription("test1");
        zmsImpl.putDomainMeta(ctx, "MetaDomProductid.metaSubDom", auditRef, null, meta);
        domain = zmsImpl.getDomain(ctx, "MetaDomProductid.metaSubDom");
        assertEquals(domain.getMemberExpiryDays(), Integer.valueOf(30));
        assertEquals(domain.getServiceExpiryDays(), Integer.valueOf(25));
        assertEquals(domain.getGroupExpiryDays(), Integer.valueOf(35));
        assertEquals(domain.getDescription(), "test1");

        // setting is to 0

        meta.setMemberExpiryDays(0);
        meta.setServiceExpiryDays(0);
        meta.setGroupExpiryDays(0);
        meta.setDescription("test2");
        zmsImpl.putDomainMeta(ctx, "MetaDomProductid.metaSubDom", auditRef, null, meta);
        domain = zmsImpl.getDomain(ctx, "MetaDomProductid.metaSubDom");
        assertNull(domain.getMemberExpiryDays());
        assertNull(domain.getServiceExpiryDays());
        assertNull(domain.getGroupExpiryDays());
        assertEquals(domain.getDescription(), "test2");

        zmsImpl.deleteSubDomain(ctx, "MetaDomProductid", "metaSubDom", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "MetaDomProductid", auditRef, null);
    }

    @Test
    public void testGetRoleList() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("RoleListDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("RoleListDom1", "Role1", null, "user.joe",
                "user.jane");
        zmsImpl.putRole(ctx, "RoleListDom1", "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject("RoleListDom1", "Role2", null, "user.joe",
                "user.jane");
        zmsImpl.putRole(ctx, "RoleListDom1", "Role2", auditRef, false, null, role2);

        RoleList roleList = zmsImpl.getRoleList(ctx, "RoleListDom1", null, null);
        assertNotNull(roleList);

        assertTrue(roleList.getNames().contains("Role1".toLowerCase()));
        assertTrue(roleList.getNames().contains("Role2".toLowerCase()));

        zmsImpl.deleteTopLevelDomain(ctx, "RoleListDom1", auditRef, null);
    }

    @Test
    public void testGetRoleListParams() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("RoleListParamDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("RoleListParamDom1", "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, "RoleListParamDom1", "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject("RoleListParamDom1", "Role2", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, "RoleListParamDom1", "Role2", auditRef, false, null, role2);

        RoleList roleList = zmsImpl.getRoleList(ctx, "RoleListParamDom1", null, "role1");
        assertNotNull(roleList);

        assertFalse(roleList.getNames().contains("role1"));
        assertTrue(roleList.getNames().contains("role2"));

        // only one role at a time

        roleList = zmsImpl.getRoleList(ctx, "RoleListParamDom1", 1, null);
        assertNotNull(roleList);
        assertEquals(roleList.getNames().size(), 1);
        assertEquals(roleList.getNames().get(0), "admin");
        assertEquals(roleList.getNext(), "admin");

        zmsImpl.deleteTopLevelDomain(ctx, "RoleListParamDom1", auditRef, null);
    }

    @Test
    public void testGetRoleListThrowException() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getRoleList(ctx, "wrongDomainName", null, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testGetRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("GetRoleDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("GetRoleDom1", "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, "GetRoleDom1", "Role1", auditRef, false, null, role1);

        Role role = zmsImpl.getRole(ctx, "GetRoleDom1", "Role1", false, false, false);
        assertNotNull(role);

        assertEquals(role.getName(), "GetRoleDom1:role.Role1".toLowerCase());
        assertNull(role.getTrust());
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);

        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteTopLevelDomain(ctx, "GetRoleDom1", auditRef, null);
    }

    @Test
    public void testGetRoleWithAttributes() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("GetRoleDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("GetRoleDom1", "Role1", null,
                "user.joe", "user.jane");
        role1.setMemberExpiryDays(30);
        role1.setServiceExpiryDays(35);
        role1.setGroupExpiryDays(40);
        role1.setSelfServe(true);
        role1.setMemberReviewDays(70);
        role1.setServiceReviewDays(80);
        role1.setGroupReviewDays(90);
        role1.setDescription("testroledescription");
        role1.setMaxMembers(25);
        role1.setSelfRenew(true);
        role1.setSelfRenewMins(99);
        zmsImpl.putRole(ctx, "GetRoleDom1", "Role1", auditRef, false, null, role1);

        Role role = zmsImpl.getRole(ctx, "GetRoleDom1", "Role1", false, false, false);
        assertNotNull(role);

        assertEquals(role.getName(), "GetRoleDom1:role.Role1".toLowerCase());
        assertNull(role.getTrust());
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);

        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        zmsTestInitializer.checkRoleMember(checkList, members);

        assertEquals(role.getMemberExpiryDays(), Integer.valueOf(30));
        assertEquals(role.getServiceExpiryDays(), Integer.valueOf(35));
        assertEquals(role.getGroupExpiryDays(), Integer.valueOf(40));
        assertEquals(role.getMemberReviewDays(), Integer.valueOf(70));
        assertEquals(role.getServiceReviewDays(), Integer.valueOf(80));
        assertEquals(role.getGroupReviewDays(), Integer.valueOf(90));
        assertEquals(role.getDescription(), "testroledescription");
        assertTrue(role.getSelfServe());
        assertEquals(role.getMaxMembers(), 25);
        assertTrue(role.getSelfRenew());
        assertEquals(role.getSelfRenewMins(), 99);

        zmsImpl.deleteTopLevelDomain(ctx, "GetRoleDom1", auditRef, null);
    }

    @Test
    public void testGetRoleThrowException() {
        String domainName = "MbrGetRoleDom1";
        String roleName = "Role1";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // Tests the getRole() condition: if (domain == null)...
        try {
            zmsImpl.getRole(ctx, domainName, roleName, false, false, false);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Tests the getRole() condition: if (collection == null)...
        try {
            // Should fail because we did not create a role resource.
            zmsImpl.getRole(ctx, domainName, roleName, false, false, false);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        // Tests the getRole() condition: if (role == null)...
        String wrongRoleName = "Role2";
        try {
            Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null);
            zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

            // Should fail because we are trying to find a non-existent role.
            zmsImpl.getRole(ctx, domainName, wrongRoleName, false, false, false);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutRoleThrowException() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "DomainName1";
        String roleName = "RoleName1";
        Role role = new Role();

        // Tests the getRole() condition : if (!roleResourceName(domainName, roleName).equals(role.getName()))...
        try {
            String roleRoleName = "inconsistentRoleName1";
            role.setName(roleRoleName);

            // The role naming is inconsistent.
            zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }

        // Tests the getRole() condition : if (domain == null)...
        try {
            String roleRoleName = "DomainName1:role.RoleName1";
            role.setName(roleRoleName);

            // We never created a domain for this role.
            zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testPutRoleInvalidAuditEnabledState() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName1 = "role-audit-test-cases1";
        final String domainName2 = "role-audit-test-cases2";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setAuditEnabled(false);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // role without the audit enabled flag will be added successfully

        Role role11 = zmsTestInitializer.createRoleObject(domainName1, "role11", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domainName1, "role11", auditRef, false, null, role11);

        // role with the audit enabled flag will be rejected

        Role role12 = zmsTestInitializer.createRoleObject(domainName1, "role12", null,
                "user.joe", "user.jane");
        role12.setAuditEnabled(true);
        try {
            zmsImpl.putRole(ctx, domainName1, "role12", auditRef, false, null, role12);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Role cannot be set as audit-enabled if the domain is not audit-enabled"));
        }

        // now add a domain with the audit flag enabled

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2,
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        dom2.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        // role without the audit enabled flag will be added successfully

        Role role21 = zmsTestInitializer.createRoleObject(domainName2, "role21", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domainName2, "role21", auditRef, false, null, role21);

        // role with the audit enabled flag and no members will be added successfully

        Role role22 = zmsTestInitializer.createRoleObject(domainName2, "role22", null, null, null);
        role22.setAuditEnabled(true);
        zmsImpl.putRole(ctx, domainName2, "role22", auditRef, false, null, role22);

        // role with audit enabled flag and members will be rejected

        Role role23 = zmsTestInitializer.createRoleObject(domainName2, "role23", null,
                "user.joe", "user.jane");
        role23.setAuditEnabled(true);
        try {
            zmsImpl.putRole(ctx, domainName2, "role23", auditRef, false, null, role23);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Only system admins can set the role as audit-enabled if it has members"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName2, auditRef, null);
    }

    @Test
    public void testCreateRole() {

        TestAuditLogger alogger = new TestAuditLogger();
        List<String> aLogMsgs = alogger.getLogMsgList();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("CreateRoleDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putrole");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("CreateRoleDom1", "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, "CreateRoleDom1", "Role1", auditRef, false, null, role1);

        Role role3 = zmsImpl.getRole(ctx, "CreateRoleDom1", "Role1", false, false, false);
        assertNotNull(role3);
        assertEquals(role3.getName(), "CreateRoleDom1:role.Role1".toLowerCase());
        assertNull(role3.getTrust());

        // check audit log msg for putRole
        boolean foundError = false;
        System.err.println("testCreateRole: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putrole)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("\"name\": \"role1\",");
            assertTrue(index2 > index, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // delete member of the role
        //
        List<RoleMember> listrm = role1.getRoleMembers();
        for (RoleMember rmemb: listrm) {
            if (rmemb.getMemberName().equals("user.jane")) {
                listrm.remove(rmemb);
                break;
            }
        }

        aLogMsgs.clear();
        zmsImpl.putRole(ctx, "CreateRoleDom1", "Role1", auditRef, false, null, role1);

        foundError = false;
        System.err.println("testCreateRole: Now Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putrole)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("{\"name\": \"role1\", \"selfServe\": \"false\", \"memberExpiryDays\": \"null\", "
                    + "\"serviceExpiryDays\": \"null\", \"groupExpiryDays\": \"null\", \"tokenExpiryMins\": \"null\", "
                    + "\"certExpiryMins\": \"null\", \"memberReviewDays\": \"null\", \"serviceReviewDays\": \"null\", "
                    + "\"groupReviewDays\": \"null\", \"reviewEnabled\": \"false\", \"notifyRoles\": \"null\", "
                    + "\"signAlgorithm\": \"null\", \"userAuthorityFilter\": \"null\", "
                    + "\"userAuthorityExpiration\": \"null\", \"description\": \"null\", "
                    + "\"deleteProtection\": \"false\", \"lastReviewedDate\": \"null\", \"maxMembers\": \"null\", "
                    + "\"selfRenew\": \"null\", \"selfRenewMins\": \"null\", \"trust\": \"null\", "
                    + "\"deleted-members\": [{\"member\": \"user.jane\", \"approved\": true, \"system-disabled\": 0}], "
                    + "\"added-members\": []}");
            assertTrue(index2 > index, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // create a role with no members

        Role role4 = zmsTestInitializer.createRoleObject("CreateRoleDom1", "Role4", null);
        zmsImpl.putRole(ctx, "CreateRoleDom1", "Role4", auditRef, false, null, role4);

        Role role4Res = zmsImpl.getRole(ctx, "CreateRoleDom1", "Role4", false, false, false);
        assertNotNull(role4Res);
        assertTrue(role4Res.getRoleMembers().isEmpty());

        zmsImpl.deleteTopLevelDomain(ctx, "CreateRoleDom1", auditRef, null);
    }

    @Test
    public void testCreateRoleLocalNameOnly() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("CreateRoleLocalNameOnly",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = new Role();
        role1.setName("role1");
        role1.setMemberExpiryDays(30);
        role1.setServiceExpiryDays(45);
        role1.setGroupExpiryDays(50);
        role1.setMemberReviewDays(70);
        role1.setServiceReviewDays(80);
        role1.setGroupReviewDays(90);

        zmsImpl.putRole(ctx, "CreateRoleLocalNameOnly", "Role1", auditRef, false, null, role1);

        Role role3 = zmsImpl.getRole(ctx, "CreateRoleLocalNameOnly", "Role1", false, false, false);
        assertNotNull(role3);
        assertEquals(role3.getName(), "CreateRoleLocalNameOnly:role.Role1".toLowerCase());
        assertEquals(role3.getMemberExpiryDays(), Integer.valueOf(30));
        assertEquals(role3.getServiceExpiryDays(), Integer.valueOf(45));
        assertEquals(role3.getGroupExpiryDays(), Integer.valueOf(50));
        assertEquals(role3.getMemberReviewDays(), Integer.valueOf(70));
        assertEquals(role3.getServiceReviewDays(), Integer.valueOf(80));
        assertEquals(role3.getGroupReviewDays(), Integer.valueOf(90));

        zmsImpl.deleteTopLevelDomain(ctx, "CreateRoleLocalNameOnly", auditRef, null);
    }

    @Test
    public void testCreateRoleMissingAuditRef() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testCreateRoleMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Role role = zmsTestInitializer.createRoleObject(
                domain, "Role1", null, "user.joe", "user.jane");
        try {
            zmsImpl.putRole(ctx, domain, "Role1", null, false, null, role);
            fail("requesterror not thrown by putRole.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testCreateRoleMismatchName() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                "CreateMismatchRoleDom1", "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("CreateMismatchRoleDom1", "Role1", null,
                "user.joe", "user.jane");

        try {
            zmsImpl.putRole(ctx, "CreateMismatchRoleDom1",
                    "CreateMismatchRoleDom1.Role1", auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "CreateMismatchRoleDom1", auditRef, null);
    }

    @Test
    public void testCreateRoleInvalidName() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                "CreateRoleInvalidNameDom1", "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = new Role();
        role1.setName("Role1");

        try {
            zmsImpl.putRole(ctx, "CreateRoleInvalidNameDom1", "Role111", auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx,"CreateRoleInvalidNameDom1", auditRef, null);
    }

    @Test
    public void testCreateRoleInvalidStruct() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                "CreateRoleInvalidStructDom1", "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = new Role();

        try {
            zmsImpl.putRole(ctx, "CreateRoleInvalidStructDom1", "Role1", auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx,"CreateRoleInvalidStructDom1", auditRef, null);
    }

    @Test
    public void testCreateRoleInvalidMembers() {

        final String domainName = "create-role-invalid-members";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null, "user.joe", "jane");

        try {
            zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        Role role2 = zmsTestInitializer.createRoleObject(domainName, "Role2", null, "joe", "user.jane");

        try {
            zmsImpl.putRole(ctx, domainName, "Role2", auditRef, false, null, role2);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        // invalid group member

        Role role3 = zmsTestInitializer.createRoleObject(domainName, "Role3", null, "user.jane", domainName + ":group.dev-team");

        try {
            zmsImpl.putRole(ctx, domainName, "Role3", auditRef, false, null, role3);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreateRoleBothMemberAndTrust() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "rolebothmemberandtrust";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", "sys.auth",
                "user.joe", "user.jane");

        try {
            zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreateRoleTrustItself() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "roletrustitself";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", domainName,
                null, null);

        try {
            zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreateDuplicateMemberRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("CreateDuplicateMemberRoleDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("CreateDuplicateMemberRoleDom1", "Role1", null,
                "user.joe", "user.joe");
        zmsImpl.putRole(ctx, "CreateDuplicateMemberRoleDom1", "Role1", auditRef, false, null, role1);

        Role role = zmsImpl.getRole(ctx, "CreateDuplicateMemberRoleDom1", "Role1", false, false, false);
        assertNotNull(role);

        assertEquals(role.getName(), "CreateDuplicateMemberRoleDom1:role.Role1".toLowerCase());
        assertNull(role.getTrust());
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);
        assertEquals("user.joe", members.get(0).getMemberName());

        zmsImpl.deleteTopLevelDomain(ctx,"CreateDuplicateMemberRoleDom1", auditRef, null);
    }

    @Test
    public void testCreateNormalizedUserMemberRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("CreateNormalizedUserMemberRoleDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ArrayList<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user.jane"));

        Role role1 = zmsTestInitializer.createRoleObject("CreateNormalizedUserMemberRoleDom1", "Role1",
                null, roleMembers);
        zmsImpl.putRole(ctx, "CreateNormalizedUserMemberRoleDom1", "Role1", auditRef, false, null, role1);

        Role role = zmsImpl.getRole(ctx, "CreateNormalizedUserMemberRoleDom1", "Role1", false, false, false);
        assertNotNull(role);

        assertEquals(role.getName(), "CreateNormalizedUserMemberRoleDom1:role.Role1".toLowerCase());
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);
        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteTopLevelDomain(ctx,"CreateNormalizedUserMemberRoleDom1", auditRef, null);
    }

    @Test
    public void testCreateNormalizedServiceMemberRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("CreateNormalizedServiceMemberRoleDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        SubDomain subDom3 = zmsTestInitializer.createSubDomainObject("user1", "user",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postSubDomain(ctx, "user", auditRef, null, subDom3);

        SubDomain subDom4 = zmsTestInitializer.createSubDomainObject("dom1", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, subDom4);

        ArrayList<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("coretech.storage"));
        roleMembers.add(new RoleMember().setMemberName("coretech.storage"));
        roleMembers.add(new RoleMember().setMemberName("user.user1.dom1.api"));

        Role role1 = zmsTestInitializer.createRoleObject("CreateNormalizedServiceMemberRoleDom1", "Role1",
                null, roleMembers);
        zmsImpl.putRole(ctx, "CreateNormalizedServiceMemberRoleDom1", "Role1", auditRef, false, null, role1);

        Role role = zmsImpl.getRole(ctx, "CreateNormalizedServiceMemberRoleDom1", "Role1", false, false, false);
        assertNotNull(role);

        assertEquals(role.getName(), "CreateNormalizedServiceMemberRoleDom1:role.Role1".toLowerCase());
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);
        List<String> checkList = new ArrayList<>();
        checkList.add("coretech.storage");
        checkList.add("user.user1.dom1.api");
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteSubDomain(ctx, "user.user1", "dom1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx,"CreateNormalizedServiceMemberRoleDom1", auditRef, null);
    }

    @Test
    public void testCreateNormalizedGroupMemberRole() {

        final String domainName = "group-member-role";
        final String roleName = "role1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech", "Test Domain2", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, "group1", "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, "group1", auditRef, false, null, group1);

        Group group2 = zmsTestInitializer.createGroupObject("coretech", "dev-team", "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, "coretech", "dev-team", auditRef, false, null, group2);

        ArrayList<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName(domainName + ":group.group1"));
        roleMembers.add(new RoleMember().setMemberName("coretech:group.dev-team"));

        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, roleMembers);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        Role role = zmsImpl.getRole(ctx, domainName, roleName, false, false, false);
        assertNotNull(role);

        assertEquals(role.getName(), ResourceUtils.roleResourceName(domainName, roleName));
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);
        List<String> checkList = new ArrayList<>();
        checkList.add(domainName + ":group.group1");
        checkList.add("coretech:group.dev-team");
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteRole(ctx, domainName, roleName, auditRef, null);

        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreateNormalizedCombinedMemberRole() {

        final String domainName = "normalized-combined-member-role";
        final String roleName = "role1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech", "Test Domain2", "testOrg",
                zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech", "Test Domain2", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        SubDomain subDom3 = zmsTestInitializer.createSubDomainObject("user1", "user", "Test Domain2", "testOrg",
                zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postSubDomain(ctx, "user", auditRef, null, subDom3);

        SubDomain subDom4 = zmsTestInitializer.createSubDomainObject("dom1", "user.user1", "Test Domain2", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, subDom4);

        Group group1 = zmsTestInitializer.createGroupObject("coretech.storage", "dev-team", "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, "coretech.storage", "dev-team", auditRef, false, null, group1);

        ArrayList<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user.jane"));
        roleMembers.add(new RoleMember().setMemberName("coretech.storage"));
        roleMembers.add(new RoleMember().setMemberName("coretech.storage"));
        roleMembers.add(new RoleMember().setMemberName("user.user1.dom1.api"));
        roleMembers.add(new RoleMember().setMemberName("coretech.storage:group.dev-team"));

        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, roleMembers);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        Role role = zmsImpl.getRole(ctx, domainName, roleName, false, false, false);
        assertNotNull(role);

        assertEquals(role.getName(), ResourceUtils.roleResourceName(domainName, roleName));
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 5);
        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        checkList.add("coretech.storage");
        checkList.add("user.user1.dom1.api");
        checkList.add("coretech.storage:group.dev-team");
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteRole(ctx, domainName, roleName, auditRef, null);

        zmsImpl.deleteSubDomain(ctx, "user.user1", "dom1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("DelRoleDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("DelRoleDom1", "Role1", null, "user.joe",
                "user.jane");
        zmsImpl.putRole(ctx, "DelRoleDom1", "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject("DelRoleDom1", "Role2", null, "user.joe",
                "user.jane");
        zmsImpl.putRole(ctx, "DelRoleDom1", "Role2", auditRef, false, null, role2);

        RoleList roleList = zmsImpl.getRoleList(ctx, "DelRoleDom1", null, null);
        assertNotNull(roleList);

        // our role count is +1 because of the admin role
        assertEquals(roleList.getNames().size(), 3);

        zmsImpl.deleteRole(ctx,"DelRoleDom1", "Role1", auditRef, null);

        roleList = zmsImpl.getRoleList(ctx, "DelRoleDom1", null, null);
        assertNotNull(roleList);

        // our role count is +1 because of the admin role
        assertEquals(roleList.getNames().size(), 2);

        assertFalse(roleList.getNames().contains("Role1".toLowerCase()));
        assertTrue(roleList.getNames().contains("Role2".toLowerCase()));

        zmsImpl.deleteTopLevelDomain(ctx,"DelRoleDom1", auditRef, null);
    }

    @Test
    public void testDeleteRoleMissingAuditRef() {
        String domain = "testDeleteRoleMissingAuditRef";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Role role = zmsTestInitializer.createRoleObject(
                domain, "Role1", null, "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domain, "Role1", auditRef, false, null, role);

        try {
            zmsImpl.deleteRole(ctx, domain, "Role1", null, null);
            fail("requesterror not thrown by deleteRole.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testDeleteRoleThrowException() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "DomainName1";
        String roleName = "RoleName1";
        try {
            zmsImpl.deleteRole(ctx,domainName, roleName, auditRef, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testDeleteAdminRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("DelAdminRoleDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        try {
            zmsImpl.deleteRole(ctx,"DelAdminRoleDom1", "admin", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx,"DelAdminRoleDom1", auditRef, null);
    }

    @Test
    public void testDeleteRoleAssociatedToPolicy() {

        final String domain = "testDeleteRoleAssociatedToPolicy";
        final String role = "associatedRole";
        final String policy = "policy1";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domain,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        Role relatedRole = zmsTestInitializer.createRoleObject(domain, role, null, "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domain, role, auditRef, false, null, relatedRole);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domain, policy, role,
                "update_members", domain + ":role." + role, AssertionEffect.ALLOW);

        zmsImpl.putPolicy(ctx, domain, policy, auditRef, false, null, policy1);

        try {
            zmsImpl.deleteRole(ctx, domain, role, auditRef, null);
            fail("should be fail");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("it cannot be deleted"));
        }

        // we're going to retry our example with feature turned off
        // save our existing value, so we can restore after the test

        DynamicConfigBoolean currentValue = zmsImpl.validatePolicyAssertionRoles;
        zmsImpl.validatePolicyAssertionRoles = new DynamicConfigBoolean(false);
        zmsImpl.deleteRole(ctx, domain, role, auditRef, null);
        zmsImpl.validatePolicyAssertionRoles = currentValue;

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
    }

    @Test
    public void testValidateRoleNotAssociatedToPolicy() {

        final String relatedRole = "role1";
        final String domainName = "dom1";
        final String caller = "testValidateRoleNotAssociatedToPolicy";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1", relatedRole,
                "", "", AssertionEffect.ALLOW );
        List<Policy> policies = Collections.singletonList(policy);

        try {
            zmsImpl.validateRoleNotAssociatedToPolicy(policies, relatedRole, domainName, caller);
            fail("should be fail");
        } catch (ResourceException ex){
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("it cannot be deleted"));
        }

        // make sure some non-existent role is passed as ok

        zmsImpl.validateRoleNotAssociatedToPolicy(policies, "not_related_role", domainName, caller);

        // policy with no assertions should be supported as ok

        policy = new Policy().setName(ResourceUtils.policyResourceName(domainName, "policy1"));
        policies = Collections.singletonList(policy);
        zmsImpl.validateRoleNotAssociatedToPolicy(policies, relatedRole, domainName, caller);
    }

    @Test
    public void testValidateRoleAssociatedIsExist(){
        final String caller = "testValidateRoleAssociatedIsExist";
        final String domainName = "dom1";
        final String existRole = "role1";
        final String doesNotExistRole = "role2";
        Set<String> roleNames = new HashSet<>(){
            {
                add("admin");
                add(existRole);
            }
        };

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        zmsImpl.validateRoleAssociatedIsExist(roleNames, ResourceUtils.roleResourceName(domainName, existRole),
                domainName, caller);
        try {
            zmsImpl.validateRoleAssociatedIsExist(roleNames, ResourceUtils.roleResourceName(domainName, doesNotExistRole),
                    "policy1", caller);
            fail("should be fail");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("that associated to an assertion"));
        }

        // wild card case

        final String wildCard = ResourceUtils.roleResourceName(domainName, "Role*".toLowerCase());
        try {
            zmsImpl.validateRoleAssociatedIsExist(roleNames, ResourceUtils.roleResourceName(domainName, wildCard), domainName, caller);
            fail("should fail");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("that associated to an assertion"));
        }
    }

    @Test
    public void testGetOverdueReview() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("test-domain1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        long currentTimeMillis = System.currentTimeMillis();
        Timestamp oldTimestamp = Timestamp.fromMillis(currentTimeMillis - 60000);
        Timestamp futureTimestamp = Timestamp.fromMillis(currentTimeMillis + 60000);

        List<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.overduereview1").setReviewReminder(oldTimestamp));
        roleMembers.add(new RoleMember().setMemberName("user.overduereview2").setReviewReminder(oldTimestamp));
        roleMembers.add(new RoleMember().setMemberName("user.futurereview1").setReviewReminder(futureTimestamp));
        roleMembers.add(new RoleMember().setMemberName("user.noreview1"));

        Role role1 = zmsTestInitializer.createRoleObject("test-domain1", "Role1",
                null, roleMembers);

        zmsImpl.putRole(ctx, "test-domain1", "Role1", auditRef, false, null, role1);

        DomainRoleMembers responseMembers = zmsImpl.getOverdueReview(ctx, "test-domain1");
        assertEquals("test-domain1", responseMembers.getDomainName());
        List<DomainRoleMember> responseRoleMemberList = responseMembers.getMembers();
        assertEquals(responseRoleMemberList.size(), 2);
        assertEquals(responseRoleMemberList.get(0).getMemberName(), "user.overduereview1");
        assertEquals(responseRoleMemberList.get(1).getMemberName(), "user.overduereview2");

        zmsImpl.deleteTopLevelDomain(ctx, "test-domain1", auditRef, null);
    }

    @Test
    public void testGetOverdueReviewThrowException() {

        final String domainName = "test-domain1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        // Tests the getOverdueReview() condition : if (domain == null)...
        try {
            // Should fail because we never created this domain.
            zmsImpl.getOverdueReview(ctx, domainName);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testGetMembership() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrGetRoleDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("MbrGetRoleDom1", "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, "MbrGetRoleDom1", "Role1", auditRef, false, null, role1);

        Membership member1 = zmsImpl.getMembership(ctx, "MbrGetRoleDom1", "Role1",
                "user.joe", null);
        assertNotNull(member1);
        assertEquals(member1.getMemberName(), "user.joe");
        assertEquals(member1.getRoleName(), "MbrGetRoleDom1:role.Role1".toLowerCase());
        assertTrue(member1.getIsMember());

        Membership member2 = zmsImpl.getMembership(ctx, "MbrGetRoleDom1", "Role1",
                "user.doe", null);
        assertNotNull(member2);
        assertEquals(member2.getMemberName(), "user.doe");
        assertEquals(member2.getRoleName(), "MbrGetRoleDom1:role.Role1".toLowerCase());
        assertFalse(member2.getIsMember());

        zmsImpl.deleteTopLevelDomain(ctx,"MbrGetRoleDom1", auditRef, null);
    }

    @Test
    public void testGetMembershipThrowException() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "MbrGetRoleDom1";
        String roleName = "Role1";
        String memberName1 = "user.john";
        String memberName2 = "user.jane";

        // Tests the getMembership() condition : if (domain == null)...
        try {
            // Should fail because we never created this domain.
            zmsImpl.getMembership(ctx, domainName, roleName, memberName1, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Tests the getMembership() condition: if (collection == null)...
        try {
            // Should fail because we never added a role to this domain.
            zmsImpl.getMembership(ctx, domainName, roleName, memberName1, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        // Tests the getMembership() condition: if (role == null)...
        try {
            String missingRoleName = "Role2";

            Role role1 = zmsTestInitializer.createRoleObject("MbrGetRoleDom1", "Role1", null,
                    memberName1, memberName2);
            zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

            // Trying to find a non-existent role.
            zmsImpl.getMembership(ctx, domainName, missingRoleName, memberName1, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testPutMembership() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        when(ctx.getApiName())
                .thenReturn("posttopleveldomain").thenReturn("posttopleveldomain") // called twice in domain api
                .thenReturn("posttopleveldomain").thenReturn("posttopleveldomain") // called twice in domain api
                .thenReturn("postsubdomain").thenReturn("postsubdomain") // called twice in domain api
                .thenReturn("putrole")
                .thenReturn("putmembership");
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrAddDom1",
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        Role role1 = zmsTestInitializer.createRoleObject("MbrAddDom1", "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, "MbrAddDom1", "Role1", auditRef, false, null, role1);

        Membership mbr = zmsTestInitializer.generateMembership("Role1", "user.doe");
        zmsImpl.putMembership(ctx, "MbrAddDom1", "Role1", "user.doe", auditRef, false, null, mbr);

        // check audit log msg for putRole
        boolean foundError = false;
        List<String> aLogMsgs = alogger.getLogMsgList();
        System.err.println("testPutMembership: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putmembership)")) {
                continue;
            }
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("{\"member\": \"user.doe\", \"approved\": true, \"system-disabled\": 0}");
            assertTrue(index2 > index, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        aLogMsgs.clear();
        mbr = zmsTestInitializer.generateMembership("Role1", "coretech.storage");
        zmsImpl.putMembership(ctx, "MbrAddDom1", "Role1", "coretech.storage", auditRef, false, null, mbr);

        Role role = zmsImpl.getRole(ctx, "MbrAddDom1", "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 4);

        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        checkList.add("user.doe");
        checkList.add("coretech.storage");
        zmsTestInitializer.checkRoleMember(checkList, members);

        foundError = false;
        System.err.println("testPutMembership: now Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putmembership)")) {
                continue;
            }
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("{\"member\": \"coretech.storage\", \"approved\": true, \"system-disabled\": 0}");
            assertTrue(index2 > index, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // enable user validation for the test

        zmsImpl.userAuthority = new TestUserPrincipalAuthority();
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true);
        zmsImpl.validateUserRoleMembers = dynamicConfigBoolean;

        // valid users no exception

        mbr = zmsTestInitializer.generateMembership("role1", "user.joe");
        zmsImpl.putMembership(ctx, "MbrAddDom1", "role1", "user.joe", auditRef, false, null, mbr);

        // invalid user with exception

        mbr = zmsTestInitializer.generateMembership("role1", "user.john");
        try {
            zmsImpl.putMembership(ctx, "MbrAddDom1", "role1", "user.john", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx,"MbrAddDom1", auditRef, null);
    }

    @Test
    public void testPutMembershipResponse() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "mgradddom1";
        String roleName = "role";
        String roleFullName = domainName + ":role." + roleName;
        String memberName = "user.doe";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);

        // add member to the role
        Membership member = new Membership().setMemberName(memberName);
        Response returnedMember = zmsImpl.putMembership(ctx, domainName, roleName, memberName, auditRef, true, null, member);

        // check the response - the member should be approved
        assertTrue(returnedMember.getEntity() instanceof Membership);
        Membership m = (Membership)returnedMember.getEntity();
        assertEquals(m.getRoleName(), roleFullName);
        assertEquals(m.getMemberName(), memberName);
        assertTrue(m.getApproved());
        assertNull(m.getPendingState());

        // make the role review enabled
        RoleMeta meta = new RoleMeta()
                .setReviewEnabled(true);
        zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, meta);

        // add the same member to the role, now it should be added as a pending member
        returnedMember = zmsImpl.putMembership(ctx, domainName, roleName, memberName, auditRef, true, null, member);

        // check the response - the member should be not approved
        assertTrue(returnedMember.getEntity() instanceof Membership);
        m = (Membership)returnedMember.getEntity();
        assertEquals(m.getRoleName(), roleFullName);
        assertEquals(m.getMemberName(), memberName);
        assertFalse(m.getApproved());
        assertEquals(m.getPendingState(), PENDING_REQUEST_ADD_STATE);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutMembershipExpiration() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        when(ctx.getApiName())
                .thenReturn("posttopleveldomain").thenReturn("posttopleveldomain") // called twice in domain api
                .thenReturn("posttopleveldomain").thenReturn("posttopleveldomain") // called twice in domain api
                .thenReturn("postsubdomain").thenReturn("postsubdomain") // called twice in domain api
                .thenReturn("putrole")
                .thenReturn("putmembership")
                .thenReturn("deleteSubDomain")
                .thenReturn("deleteTopLevelDomain")
                .thenReturn("deleteTopLevelDomain");

        String domainName = "testPutMembershipExpiration";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("coretech - already exists"));
        }

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);

        Timestamp expired = Timestamp.fromMillis(System.currentTimeMillis() - 100);
        Timestamp notExpired = Timestamp.fromMillis(System.currentTimeMillis()
                + TimeUnit.HOURS.toMillis(1));

        Membership mbr = zmsTestInitializer.generateMembership("Role1", "user.doe", expired);
        zmsImpl.putMembership(ctx, domainName, "Role1", "user.doe", auditRef, false, null, mbr);
        Membership expiredMember = zmsImpl.getMembership(ctx, domainName,
                "Role1", "user.doe", null);

        mbr = zmsTestInitializer.generateMembership("Role1", "coretech.storage", notExpired);
        zmsImpl.putMembership(ctx, domainName, "Role1", "coretech.storage", auditRef, false, null, mbr);
        Membership notExpiredMember = zmsImpl.getMembership(ctx, domainName,
                "Role1", "coretech.storage", null);

        Role role = zmsImpl.getRole(ctx, domainName, "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 4);

        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        checkList.add("user.doe");
        checkList.add("coretech.storage");
        zmsTestInitializer.checkRoleMember(checkList, role.getRoleMembers());

        for (RoleMember roleMember: members) {
            if (roleMember.getMemberName().equalsIgnoreCase("user.doe")) {
                Timestamp actual = roleMember.getExpiration();
                assertNotNull(actual);
                assertEquals(actual, expired);
            }
            if (roleMember.getMemberName().equalsIgnoreCase("coretech.storage")) {
                Timestamp actual = roleMember.getExpiration();
                assertNotNull(actual);
                assertEquals(actual, notExpired);
            }
        }

        assertFalse(expiredMember.getIsMember());
        assertTrue(notExpiredMember.getIsMember());

        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testPutMembershipEmptyRoleMembers() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrAddDom1EmptyRole",
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = new Role();
        role1.setName(ResourceUtils.roleResourceName("MbrAddDom1EmptyRole", "Role1"));
        zmsImpl.putRole(ctx, "MbrAddDom1EmptyRole", "Role1", auditRef, false, null, role1);

        Membership mbr = zmsTestInitializer.generateMembership("Role1", "user.doe");
        zmsImpl.putMembership(ctx, "MbrAddDom1EmptyRole", "Role1", "user.doe", auditRef, false, null, mbr);

        Role role = zmsImpl.getRole(ctx, "MbrAddDom1EmptyRole", "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);

        assertEquals("user.doe", members.get(0).getMemberName());

        zmsImpl.deleteTopLevelDomain(ctx,"MbrAddDom1EmptyRole", auditRef, null);
    }

    @Test
    public void testPutMembershipRoleGroupMembers() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "role-group-members";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = new Role();
        role1.setName(ResourceUtils.roleResourceName(domainName, "Role1"));
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);

        // should fail since we don't have a group

        Membership mbr = zmsTestInitializer.generateMembership("Role1", domainName + ":group.dev-team");
        try {
            zmsImpl.putMembership(ctx, domainName, "Role1", domainName + ":group.dev-team", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        Group group1 = zmsTestInitializer.createGroupObject(domainName, "dev-team", "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, "dev-team", auditRef, false, null, group1);

        // now our put membership should work

        zmsImpl.putMembership(ctx, domainName, "Role1", domainName + ":group.dev-team", auditRef, false, null, mbr);

        Role role = zmsImpl.getRole(ctx, domainName, "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);

        assertEquals(domainName + ":group.dev-team", members.get(0).getMemberName());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutMembershipMissingAuditRef() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testPutMembershipMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", "user.user1");
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Role role = zmsTestInitializer.createRoleObject(
                domain, "Role1", null, "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domain, "Role1", auditRef, false, null, role);

        Membership mbr = zmsTestInitializer.generateMembership("Role1", "user.john");
        try {
            zmsImpl.putMembership(ctx, domain, "Role1", "user.john", null, false, null, mbr);
            fail("requesterror not thrown by putMembership.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testPutMembershipNormalizedUserUser() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrAddDom2",
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        Role role1 = zmsTestInitializer.createRoleObject("MbrAddDom2", "Role1", null,
                "coretech.storage", "user.jane");
        zmsImpl.putRole(ctx, "MbrAddDom2", "Role1", auditRef, false, null, role1);

        Membership mbr = zmsTestInitializer.generateMembership("Role1", "user.doe");
        zmsImpl.putMembership(ctx, "MbrAddDom2", "Role1", "user.doe", auditRef, false, null, mbr);

        Role role = zmsImpl.getRole(ctx, "MbrAddDom2", "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 3);

        List<String> checkList = new ArrayList<>();
        checkList.add("coretech.storage");
        checkList.add("user.jane");
        checkList.add("user.doe");
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "MbrAddDom2", auditRef, null);
    }

    @Test
    public void testPutMembershipNormalizedUser() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrAddDom3",
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        Role role1 = zmsTestInitializer.createRoleObject("MbrAddDom3", "Role1", null,
                "coretech.storage", "user.jane");
        zmsImpl.putRole(ctx, "MbrAddDom3", "Role1", auditRef, false, null, role1);

        Membership mbr = zmsTestInitializer.generateMembership("Role1", "user.doe");
        zmsImpl.putMembership(ctx, "MbrAddDom3", "Role1", "user.doe", auditRef, false, null, mbr);

        Role role = zmsImpl.getRole(ctx, "MbrAddDom3", "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 3);

        List<String> checkList = new ArrayList<>();
        checkList.add("coretech.storage");
        checkList.add("user.jane");
        checkList.add("user.doe");
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "MbrAddDom3", auditRef, null);
    }

    @Test
    public void testPutMembershipNormalizedService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrAddDom4",
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        TopLevelDomain dom3 = zmsTestInitializer.createTopLevelDomainObject("weather",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom3);

        SubDomain subDom3 = zmsTestInitializer.createSubDomainObject("storage", "weather",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "weather", auditRef, null, subDom3);

        Role role1 = zmsTestInitializer.createRoleObject("MbrAddDom4", "Role1", null,
                "coretech.storage", "user.jane");
        zmsImpl.putRole(ctx, "MbrAddDom4", "Role1", auditRef, false, null, role1);

        Membership mbr = zmsTestInitializer.generateMembership("Role1", "weather.storage");
        zmsImpl.putMembership(ctx, "MbrAddDom4", "Role1", "weather.storage", auditRef, false, null, mbr);

        Role role = zmsImpl.getRole(ctx, "MbrAddDom4", "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 3);

        List<String> checkList = new ArrayList<>();
        checkList.add("coretech.storage");
        checkList.add("user.jane");
        checkList.add("weather.storage");
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteSubDomain(ctx, "weather", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "weather", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "MbrAddDom4", auditRef, null);
    }

    @Test
    public void testPutMembershipRoleNotPresent() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrAddDomNoRole",
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        Role role1 = zmsTestInitializer.createRoleObject("MbrAddDomNoRole", "Role1", null,
                "coretech.storage", "user.jane");
        zmsImpl.putRole(ctx, "MbrAddDomNoRole", "Role1", auditRef, false, null, role1);

        // membership object with only member

        Membership mbr = new Membership();
        mbr.setMemberName("user.joe");

        zmsImpl.putMembership(ctx, "MbrAddDomNoRole", "Role1", "user.joe", auditRef, false, null, mbr);

        Role role = zmsImpl.getRole(ctx, "MbrAddDomNoRole", "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 3);

        List<String> checkList = new ArrayList<>();
        checkList.add("coretech.storage");
        checkList.add("user.jane");
        checkList.add("user.joe");
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "MbrAddDomNoRole", auditRef, null);
    }

    @Test
    public void testPutMembershipInvalid() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrAddDom5",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("MbrAddDom5", "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, "MbrAddDom5", "Role1", auditRef, false, null, role1);
        try {
            Membership mbr = zmsTestInitializer.generateMembership("Role1", "coretech");
            zmsImpl.putMembership(ctx, "MbrAddDom5", "Role1", "coretech", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "MbrAddDom5", auditRef, null);
    }

    @Test
    public void testPutMembershipRoleMismatch() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrAddDom6",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("MbrAddDom6", "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, "MbrAddDom6", "Role1", auditRef, false, null, role1);
        try {
            Membership mbr = zmsTestInitializer.generateMembership("Role2", "user.john");
            zmsImpl.putMembership(ctx, "MbrAddDom6", "Role1", "user.john", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "MbrAddDom6", auditRef, null);
    }

    @Test
    public void testPutMembershipMemberMismatch() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("MbrAddDom7",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("MbrAddDom7", "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, "MbrAddDom7", "Role1", auditRef, false, null, role1);
        try {
            Membership mbr = zmsTestInitializer.generateMembership("Role1", "user.john");
            zmsImpl.putMembership(ctx, "MbrAddDom7", "Role1", "user.johnny", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "MbrAddDom7", auditRef, null);
    }

    @Test
    public void testPutMembershipThrowException() {
        String domainName = "MbrGetRoleDom1";
        String roleName = "Role1";
        String memberName1 = "user.john";
        String memberName2 = "user.jane";
        String wrongDomainName = "MbrGetRoleDom2";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Tests the putMembership() condition : if (domain == null)...
        try {
            // Trying to add a wrong domain name.
            Membership mbr = zmsTestInitializer.generateMembership(roleName, memberName1);
            zmsImpl.putMembership(ctx, wrongDomainName, roleName, memberName1, auditRef, false, null, mbr);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }

        // Tests the putMembership() condition: if (collection == null)...
        try {
            // Should fail because we never added a role resource.
            Membership mbr = zmsTestInitializer.generateMembership(roleName, memberName1);
            zmsImpl.putMembership(ctx, domainName, roleName, memberName1, auditRef, false, null, mbr);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }

        // Tests the putMembership() condition : invalid membership object - null
        try {
            // Trying to add a wrong domain name.
            zmsImpl.putMembership(ctx, wrongDomainName, roleName, memberName1, auditRef, false, null, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }

        // Tests the putMembership() condition : invalid membership object - missing name
        try {
            // Trying to add a wrong domain name.
            Membership mbr = new Membership();
            zmsImpl.putMembership(ctx, wrongDomainName, roleName, memberName1, auditRef, false, null, mbr);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }

        // Tests the putMembership() condition: if (role == null)...
        try {
            String wrongRoleName = "Role2";

            Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null,
                    memberName1, memberName2);
            zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

            // Trying to add member to non-existent role.
            Membership mbr = zmsTestInitializer.generateMembership(wrongRoleName, memberName1);
            zmsImpl.putMembership(ctx, domainName, wrongRoleName, memberName1, auditRef, false, null, mbr);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testManageMembershipWithUpdateMembersAction() {

        final String domainName = "update-member-domain1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Authority savedAuthority = zmsImpl.userAuthority;

        Authority authority = Mockito.mock(Authority.class);
        when(authority.isValidUser(anyString())).thenReturn(true);
        when(authority.getDateAttribute(anyString(), anyString())).thenReturn(null);
        Set<String> attrs = new HashSet<>();
        attrs.add("elevated-clearance");
        when(authority.dateAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // role1 will have user.user1 through group1

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "role1", null, "user.user1", "user.user2");
        zmsImpl.putRole(ctx, domainName, "role1", auditRef, false, null, role1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "policy1", "role1",
                "update_members", domainName + ":role.role1", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1);

        // user1 has access to add members to a role1

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);

        Membership mbr = new Membership().setMemberName("user.user3");
        zmsImpl.putMembership(rsrcCtx1, domainName, "role1", "user.user3", auditRef, false, null, mbr);

        Membership mbrResponse = zmsImpl.getMembership(ctx, domainName, "role1", "user.user3", null);
        assertNotNull(mbrResponse);
        assertTrue(mbrResponse.getIsMember());
        assertTrue(mbrResponse.getApproved());

        // now delete the member

        zmsImpl.deleteMembership(rsrcCtx1, domainName, "role1", "user.user3", auditRef, null);
        mbrResponse = zmsImpl.getMembership(ctx, domainName, "role1", "user.user3", null);
        assertNotNull(mbrResponse);
        assertFalse(mbrResponse.getIsMember());

        // a different user does not have access to a role

        Principal principal4 = principalAuthority.authenticate("v=U1;d=user;n=user4;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx4 = zmsTestInitializer.createResourceContext(principal4);
        try {
            zmsImpl.putMembership(rsrcCtx4, domainName, "role1", "user.user3", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.deleteMembership(rsrcCtx4, domainName, "role1", "user.user1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        zmsImpl.userAuthority = savedAuthority;

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembership() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "mbr-del-dom";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);
        zmsImpl.deleteMembership(ctx, domainName, "Role1", "user.joe", auditRef, null);

        Role role = zmsImpl.getRole(ctx, domainName, "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);

        boolean found = false;
        for (RoleMember member: members) {
            if (member.getMemberName().equalsIgnoreCase("user.joe")) {
                fail("delete user.joe failed");
            }
            if (member.getMemberName().equalsIgnoreCase("user.jane")) {
                found = true;
            }
        }
        if (!found) {
            fail("user.jane not found");
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembershipSelf() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "mbr-del-dom-self";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=joe;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);

        // now let's try to delete ourselves which should work

        zmsImpl.deleteMembership(rsrcCtx1, domainName, "Role1", "user.joe", auditRef, null);

        // now try to delete the other user which should be rejected

        try {
            zmsImpl.deleteMembership(rsrcCtx1, domainName, "Role1", "user.jane", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.FORBIDDEN);
        }

        // now verify the results

        Role role = zmsImpl.getRole(ctx, domainName, "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);
        assertEquals(members.get(0).getMemberName(), "user.jane");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembershipMissingAuditRef() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "testDeleteMembershipMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domainName, "Test Domain1", "testOrg", "user.user1");
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Role role = zmsTestInitializer.createRoleObject(
                domainName, "Role1", null, "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role);

        try {
            zmsImpl.deleteMembership(ctx, domainName, "Role1", "user.joe", null, null);
            fail("requesterror not thrown by deleteMembership.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembershipInvalidDomain() {
        String domainName = "MbrGetRoleDom1";
        String roleName = "Role1";
        String memberName1 = "user.john";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Tests the deleteMembership() condition : if (domain == null)...
        try {
            String wrongDomainName = "MbrGetRoleDom2";

            // Should fail because this domain does not exist.
            zmsImpl.deleteMembership(ctx, wrongDomainName, roleName, memberName1, auditRef, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembershipInvalidRoleCollection() {
        String domainName = "MbrGetRoleDom1";
        String roleName = "Role1";
        String memberName1 = "user.john";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Test the deleteMembership() condition: if (collection == null)...
        try {
            // Should fail b/c a role entity was never added.
            zmsImpl.deleteMembership(ctx, domainName, roleName, memberName1, auditRef, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembershipInvalidRole() {

        String domainName = "del-mbr-invalid-role";
        String roleName = "role1";
        String memberName1 = "user.john";
        String memberName2 = "user.jane";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Tests the deleteMembership() condition: if (role == null)...

        try {
            Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null,
                    memberName1, memberName2);
            zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

            // Should fail b/c trying to find a non-existent role.

            final String wrongRoleName = "role2";
            zmsImpl.deleteMembership(ctx, domainName, wrongRoleName, memberName1, auditRef, null);
            fail("notfounderror not thrown.");

        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembershipAdminRoleSingleMember() {

        final String domainName = "del-mbr-single-role-member";
        final String memberName1 = "user.user1";
        final String adminRoleName = "admin";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", memberName1);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // deleting the single admin should throw an exception

        try {
            zmsImpl.deleteMembership(ctx, domainName, adminRoleName, memberName1, auditRef, null);
            fail("forbidden error not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 403);
        }

        // deleting another non-members should return not found exception

        try {
            zmsImpl.deleteMembership(ctx, domainName, adminRoleName, "user.joe", auditRef, null);
            fail("not found error not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembershipNormalizedUser() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "mbr-del-norm-user";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null,
                "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);
        zmsImpl.deleteMembership(ctx, domainName, "Role1", "user.joe", auditRef, null);

        Role role = zmsImpl.getRole(ctx, domainName, "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);
        assertEquals(members.get(0).getMemberName(), "user.jane");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembershipNormalizedService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "mbr-del-norm-svc";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", "user.user1");
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null,
                "user.joe", "coretech.storage");
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);
        zmsImpl.deleteMembership(ctx, domainName, "Role1", "coretech.storage", auditRef, null);

        Role role = zmsImpl.getRole(ctx, domainName, "Role1", false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);
        assertEquals(members.get(0).getMemberName(), "user.joe");

        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteMembershipFromDeleteProtectionRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "mbr-del-dom";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null,
                "user.joe", null);
        Response response = zmsImpl.putRole(ctx, domainName, "Role1", auditRef, true, null, role1);
        Role role = (Role) response.getEntity();
        assertEquals(role.getRoleMembers().size(), 1);
        RoleMeta meta = new RoleMeta().setReviewEnabled(true).setDeleteProtection(true);
        zmsImpl.putRoleMeta(ctx, domainName, "Role1", auditRef, null, meta);
        zmsImpl.deleteMembership(ctx, domainName, "Role1", "user.joe", auditRef, null);

        role = zmsImpl.getRole(ctx, domainName, "Role1", false, false, true);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);

        for (RoleMember member: members) {
            if (!member.getMemberName().equalsIgnoreCase("user.joe")) {
                fail();
            }
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetPolicyList() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyListDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject("PolicyListDom1", "Policy1");
        zmsImpl.putPolicy(ctx, "PolicyListDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject("PolicyListDom1", "Policy2");
        zmsImpl.putPolicy(ctx, "PolicyListDom1", "Policy2", auditRef, false, null, policy2);

        Policy policy3 = zmsTestInitializer.createPolicyObject("PolicyListDom1", "Policy3");
        policy3.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "PolicyListDom1", "Policy3", auditRef, false, null, policy3);

        PolicyList policyList = zmsImpl.getPolicyList(ctx, "PolicyListDom1", null, null);
        assertNotNull(policyList);

        // policy count +1 due to admin policy
        assertEquals(policyList.getNames().size(), 4);

        assertTrue(policyList.getNames().contains("policy1"));
        assertTrue(policyList.getNames().contains("policy2"));
        assertTrue(policyList.getNames().contains("policy3"));

        policyList = zmsImpl.getPolicyList(ctx, "PolicyListDom1", 1, null);
        assertNotNull(policyList);
        assertEquals(policyList.getNames().size(), 1);
        assertEquals(policyList.getNames().get(0), "admin");
        assertEquals(policyList.getNext(), "admin");

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyListDom1", auditRef, null);
    }

    @Test
    public void testGetPolicyVersionList() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyListDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        addRoleNeededForTest("PolicyListDom1", "Role1");
        Policy policyVer0 = zmsTestInitializer.createPolicyObject("PolicyListDom1", "PolicyName", null, true);
        zmsImpl.putPolicy(ctx, "PolicyListDom1", "PolicyName", auditRef, false, null, policyVer0);
        zmsImpl.putPolicyVersion(ctx, "PolicyListDom1", "PolicyName", new PolicyOptions().setVersion("version1"),
                auditRef, false, null);
        zmsImpl.putPolicyVersion(ctx, "PolicyListDom1", "PolicyName", new PolicyOptions().setVersion("version2"),
                auditRef, false, null);

        policyVer0 = zmsTestInitializer.createPolicyObject("PolicyListDom1", "PolicyName2", null, true);
        zmsImpl.putPolicy(ctx, "PolicyListDom1", "PolicyName2", auditRef, false, null, policyVer0);
        zmsImpl.putPolicyVersion(ctx, "PolicyListDom1", "PolicyName2", new PolicyOptions().setVersion("versionOne"),
                auditRef, false, null);
        zmsImpl.putPolicyVersion(ctx, "PolicyListDom1", "PolicyName2", new PolicyOptions().setVersion("versionTwo"),
                auditRef, false, null);

        PolicyList policyList = zmsImpl.getPolicyVersionList(ctx, "PolicyListDom1", "PolicyName");
        assertNotNull(policyList);

        assertEquals(policyList.getNames().size(), 3);

        assertTrue(policyList.getNames().contains("0"));
        assertTrue(policyList.getNames().contains("version1"));
        assertTrue(policyList.getNames().contains("version2"));

        policyList = zmsImpl.getPolicyVersionList(ctx, "PolicyListDom1", "PolicyName2");
        assertNotNull(policyList);

        assertEquals(policyList.getNames().size(), 3);
        assertTrue(policyList.getNames().contains("0"));
        assertTrue(policyList.getNames().contains("versionone"));
        assertTrue(policyList.getNames().contains("versiontwo"));

        // assert getting version list for non-existing domain throws exception
        try {
            zmsImpl.getPolicyVersionList(ctx, "UnknownDomain", "PolicyName2");
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (404): {code: 404, message: \"unknown domain - unknowndomain\"}");
        }

        // assert getting version list for non-existing policy throws exception
        try {
            zmsImpl.getPolicyVersionList(ctx, "PolicyListDom1", "UnKnown");
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (404): {code: 404, message: \"unknown policy - policylistdom1:policy.unknown\"}");
        }

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyListDom1", auditRef, null);
    }

    @Test
    public void testGetPolicyListParams() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                "PolicyListParamsDom1", "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject("PolicyListParamsDom1", "Policy1");
        zmsImpl.putPolicy(ctx, "PolicyListParamsDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject("PolicyListParamsDom1", "Policy2");
        zmsImpl.putPolicy(ctx, "PolicyListParamsDom1", "Policy2", auditRef, false, null, policy2);

        PolicyList policyList = zmsImpl.getPolicyList(ctx, "PolicyListParamsDom1", null,
                "Policy1");
        assertNotNull(policyList);

        assertFalse(policyList.getNames().contains("Policy1".toLowerCase()));
        assertTrue(policyList.getNames().contains("Policy2".toLowerCase()));

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyListParamsDom1", auditRef, null);
    }

    @Test
    public void testGetPolicyListThrowException() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getPolicyList(ctx, "WrongDomainName", null, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testGetPolicy() {

        TestAuditLogger alogger = new TestAuditLogger();
        List<String> aLogMsgs = alogger.getLogMsgList();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyGetDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putpolicy");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject("PolicyGetDom1", "Policy1");
        zmsImpl.putPolicy(ctx, "PolicyGetDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy = zmsImpl.getPolicy(ctx, "PolicyGetDom1", "Policy1");
        assertNotNull(policy);
        assertEquals(policy.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());

        List<Assertion> assertList = policy.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 1);
        Assertion obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());

        boolean foundError = false;
        System.err.println("testGetPolicy: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putpolicy)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("\"added-assertions\": [{\"role\": \"policygetdom1:role.admin\", \"action\": \"*\", \"effect\": \"ALLOW\", \"resource\": \"policygetdom1:*\"}]");
            assertTrue(index < index2, msg);
            index2 = msg.indexOf("ERROR");
            assertEquals(index2, -1, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // modify the assertion: result is add of new assertion, delete of old
        //
        obj.setAction("layup");
        obj.setEffect(AssertionEffect.DENY);
        List<Assertion> assertions = new ArrayList<>();
        assertions.add(obj);
        policy1.setAssertions(assertions);
        aLogMsgs.clear();
        zmsImpl.putPolicy(ctx, "PolicyGetDom1", "Policy1", auditRef, false, null, policy1);

        foundError = false;
        System.err.println("testGetPolicy: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putpolicy)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("\"added-assertions\": [{\"role\": \"policygetdom1:role.admin\", \"action\": \"layup\", \"effect\": \"DENY\", \"resource\": \"policygetdom1:*\"}]");
            assertTrue(index < index2, msg);
            index2 = msg.indexOf("ERROR");
            assertEquals(index2, -1, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // this should throw an exception
        try {
            zmsImpl.getPolicy(ctx, "PolicyGetDom1", "Policy2");
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyGetDom1", auditRef, null);
    }

    @Test
    public void testGetPolicyWithAssertionConditions() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyGetDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putpolicy");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject("PolicyGetDom1", "Policy1");
        zmsImpl.putPolicy(ctx, "PolicyGetDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy = zmsImpl.getPolicy(ctx, "PolicyGetDom1", "Policy1");
        assertNotNull(policy);
        assertEquals(policy.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());

        List<Assertion> assertList = policy.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 1);
        Assertion obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());
        // Put assertion conditions for the new assertion
        AssertionConditionData assertionConditionData = new AssertionConditionData();
        assertionConditionData.setOperator(AssertionConditionOperator.EQUALS);
        assertionConditionData.setValue("testVal1");

        Map<String, AssertionConditionData> conditionsMap1 = new HashMap<>();
        conditionsMap1.put("cond1", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue("testval1"));
        conditionsMap1.put("cond2", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue("testval2"));
        AssertionCondition assertionCondition1 = new AssertionCondition();
        assertionCondition1.setConditionsMap(conditionsMap1);
        Map<String, AssertionConditionData> conditionsMap2 = new HashMap<>();
        conditionsMap2.put("cond3", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue("testval3"));
        conditionsMap2.put("cond4", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue("testval4"));
        AssertionCondition assertionCondition2 = new AssertionCondition();
        assertionCondition2.setConditionsMap(conditionsMap2);
        List<AssertionCondition> conditionsList = new ArrayList<>();
        conditionsList.add(assertionCondition1);
        conditionsList.add(assertionCondition2);
        AssertionConditions assertionConditions = new AssertionConditions();
        assertionConditions.setConditionsList(conditionsList);
        zmsImpl.putAssertionConditions(ctx, "PolicyGetDom1", "Policy1", obj.getId(), auditRef, null, assertionConditions);

        policy = zmsImpl.getPolicy(ctx, "PolicyGetDom1", "Policy1");
        assertNotNull(policy);
        assertEquals(policy.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());

        assertList = policy.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 1);

        List<AssertionCondition> conditionsListReturned = assertList.get(0).getConditions().getConditionsList();
        assertEquals(conditionsListReturned.size(), 2);
        assertEquals(conditionsListReturned.get(0).getConditionsMap().get("cond1").getValue(), "testval1");
        assertEquals(conditionsListReturned.get(0).getConditionsMap().get("cond2").getValue(), "testval2");
        assertEquals(conditionsListReturned.get(1).getConditionsMap().get("cond3").getValue(), "testval3");
        assertEquals(conditionsListReturned.get(1).getConditionsMap().get("cond4").getValue(), "testval4");

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyGetDom1", auditRef, null);
    }

    @Test
    public void testPolicyVersions() {

        TestAuditLogger alogger = new TestAuditLogger();
        List<String> aLogMsgs = alogger.getLogMsgList();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "PolicyGetDom1";
        String policyName = "Policy1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putpolicy");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = createPolicyWithVersions(zmsImpl, domainName, policyName);

        // Verify policy and non-active versions are as expected
        Policy policy = zmsImpl.getPolicy(ctx, domainName, policyName);
        assertNotNull(policy);
        assertEquals(policy.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());
        assertEquals(policy.getVersion(), "0".toLowerCase());
        assertTrue(policy.getActive());

        Policy policyVer1 = zmsImpl.getPolicyVersion(ctx, domainName, policyName, "New-Version1");
        assertNotNull(policyVer1);
        assertEquals(policyVer1.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());
        assertEquals(policyVer1.getVersion(), "New-Version1".toLowerCase());
        assertFalse(policyVer1.getActive());

        Policy policyVer2 = zmsImpl.getPolicyVersion(ctx, domainName, policyName, "New-Version2");
        assertNotNull(policyVer2);
        assertEquals(policyVer2.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());
        assertEquals(policyVer2.getVersion(), "New-Version2".toLowerCase());
        assertFalse(policyVer2.getActive());

        // Verify assertions for active version
        List<Assertion> assertList = policy.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 2);
        Assertion obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());
        obj = assertList.get(1);
        assertEquals(obj.getAction(), "updatetest");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), domainName.toLowerCase() + ":resourcetest");
        assertEquals(obj.getRole(), ResourceUtils.roleResourceName(domainName.toLowerCase(), "admin"));

        // Verify assertion for New-Version1
        assertList = policyVer1.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 1);
        obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());

        // Verify assertion for New-Version2
        assertList = policyVer2.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 2);
        obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());
        obj = assertList.get(1);
        assertEquals(obj.getAction(), "updatetest");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), domainName.toLowerCase() + ":resourcetest");
        assertEquals(obj.getRole(), ResourceUtils.roleResourceName(domainName.toLowerCase(), "admin"));

        boolean foundError = false;
        System.err.println("testGetPolicyVersions: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putpolicy)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("\"added-assertions\": [{\"role\": \"policygetdom1:role.admin\", \"action\": \"*\", \"effect\": \"ALLOW\", \"resource\": \"policygetdom1:*\"}]");
            assertTrue(index < index2, msg);
            index2 = msg.indexOf("ERROR");
            assertEquals(index2, -1, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // modify the assertion: result is add of new assertion, delete of old
        //
        obj.setAction("layup");
        obj.setEffect(AssertionEffect.DENY);
        List<Assertion> assertions = new ArrayList<>();
        assertions.add(obj);
        policy1.setAssertions(assertions);
        aLogMsgs.clear();
        zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy1);

        foundError = false;
        System.err.println("testGetPolicyVersions: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putpolicy)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("\"added-assertions\": [{\"role\": \"policygetdom1:role.admin\", \"action\": \"layup\", \"effect\": \"DENY\", \"resource\": \"policygetdom1:resourcetest\"}]");
            assertTrue(index < index2, msg);
            index2 = msg.indexOf("ERROR");
            assertEquals(index2, -1, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // create new version, verify assertions are copied
        //
        aLogMsgs.clear();
        zmsImpl.putPolicyVersion(ctx, domainName, policyName, new PolicyOptions().setVersion("New-Version3"),
                auditRef, false, null);

        foundError = false;
        System.err.println("testGetPolicyVersions: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putpolicy)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("\"copied-assertions\": [{\"role\": \"policygetdom1:role.admin\", \"action\": \"layup\", \"effect\": \"DENY\", \"resource\": \"policygetdom1:resourcetest\"}]");
            assertTrue(index < index2, msg);
            index2 = msg.indexOf("ERROR");
            assertEquals(index2, -1, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // Verify getting unknown version throws exception
        try {
            zmsImpl.getPolicyVersion(ctx, domainName, policyName, "unknownversion");
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains(": Policy not found: 'policygetdom1:policy.policy1' with version: unknownversion\"}"));
        }

        // Verify trying to create new version for admin policy throws an exception
        try {
            zmsImpl.putPolicyVersion(ctx, domainName, "admin", new PolicyOptions().setVersion("NewVersion"),
                    auditRef, false, null);
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains(": admin policy cannot be modified\"}"));
        }

        // Verify putting policy version in read mode throws an exception
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true).thenReturn(false);
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.putPolicyVersion(ctx, domainName, policyName, new PolicyOptions().setVersion("New-Version4"),
                    auditRef, false, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"Server in Maintenance Read-Only mode. Please try your request later\"}");
        }

        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutPolicyVersionSpecifyFrom() {
        String domainName = "PolicyGetDom1";
        String policyName = "Policy1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putpolicy");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        createPolicyWithVersions(zmsImpl, domainName, policyName);

        // First we'll set New-Version1 as the active version
        zmsImpl.setActivePolicyVersion(ctx, domainName, policyName, new PolicyOptions().setVersion("New-Version1"), auditRef, null);

        // We'll verify it was set as active
        Policy newActivePolicy = zmsImpl.getPolicy(ctx, domainName, policyName);
        assertEquals(newActivePolicy.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());
        assertTrue(newActivePolicy.getActive());
        assertEquals(newActivePolicy.getVersion(), "New-Version1".toLowerCase());
        List<Assertion> assertList = newActivePolicy.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 1);
        Assertion obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());

        // Now we'll create a new version based on the now disabled version "0". This will contain that version's assertions instead of the active version.
        PolicyOptions policyOptions = new PolicyOptions();
        policyOptions.setVersion("to-version");
        policyOptions.setFromVersion("0");
        zmsImpl.putPolicyVersion(ctx, domainName, policyName, policyOptions, auditRef, false, null);

        // Get the new created version, verify it is based on non-active version 0
        Policy toVersion = zmsImpl.getPolicyVersion(ctx, domainName, policyName, "to-version");
        assertEquals(toVersion.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());
        assertFalse(toVersion.getActive());
        assertEquals(toVersion.getVersion(), "to-version");
        assertList = toVersion.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 2);
        obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());
        obj = assertList.get(1);
        assertEquals(obj.getAction(), "updatetest");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), domainName.toLowerCase() + ":resourcetest");
        assertEquals(obj.getRole(), ResourceUtils.roleResourceName(domainName.toLowerCase(), "admin"));

        // Remove assertion from the new created version and verify it was deleted
        zmsImpl.deleteAssertionPolicyVersion(ctx, domainName, policyName, "to-version", obj.getId(), auditRef, null);
        toVersion = zmsImpl.getPolicyVersion(ctx, domainName, policyName, "to-version");
        assertList = toVersion.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 1);
        obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutPolicyWithAssociatedRoleDoesNotExist() {
        String domainName = "PutPolicyDom1";
        String policyName = "Policy1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putpolicy");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        Policy policy = zmsTestInitializer.createPolicyObject(domainName, policyName, "doesn't_exist_role", "", "", AssertionEffect.ALLOW);

        // try to add - should be fill

        try{
            zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy);
            fail("should be fail");
        } catch (ResourceException ex){
            assertEquals(ex.getCode(), 400);
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        }
    }

    @Test
    public void testSetUnknownPolicyVersionAsActive() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "domain-name-invalid-active";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1);

        // valid policy - unknown version

        try {
            zmsImpl.setActivePolicyVersion(ctx, domainName, "policy1",
                    new PolicyOptions().setVersion("unknown-version"), auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
            assertTrue(ex.getMessage().contains("unknown policy version: unknown-version"));
        }

        // unknown policy

        try {
            zmsImpl.setActivePolicyVersion(ctx, domainName, "policy2",
                    new PolicyOptions().setVersion("unknown-version"), auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
            assertTrue(ex.getMessage().contains("unknown policy: policy2"));
        }

        // same policy version

        zmsImpl.setActivePolicyVersion(ctx, domainName, "policy1",
                new PolicyOptions().setVersion("0"), auditRef, null);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteAssertionIncorrectPolicyVersion() {
        String domainName = "PolicyGetDom1";
        String policyName = "Policy1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putpolicy");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        createPolicyWithVersions(zmsImpl, domainName, policyName);

        // get policy version New-Version2 and get assertion ids
        Policy policyVersion = zmsImpl.getPolicyVersion(ctx, domainName, policyName, "New-Version2");
        assertEquals(policyVersion.getAssertions().size(), 2);
        Long id1 = policyVersion.getAssertions().get(0).getId();
        Long id2 = policyVersion.getAssertions().get(1).getId();

        // verify that trying to delete assertion from the wrong policy version will throw error
        try {
            zmsImpl.deleteAssertion(ctx, domainName, policyName, id1, auditRef, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"putpolicy: unable to delete assertion: " + id1 + " from policy: policy1 version: active version\"}");
        }

        // we're not allowed to modify admin policy
        try {
            zmsImpl.deleteAssertionPolicyVersion(ctx, domainName, "admin", "New-Version1", id1, auditRef, null);
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains("admin policy cannot be modified"));
        }

        try {
            zmsImpl.deleteAssertionPolicyVersion(ctx, domainName, policyName, "New-Version1", id1, auditRef, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"putpolicy: unable to delete assertion: " + id1 + " from policy: policy1 version: new-version1\"}");
        }

        // Verify deleting using correct version works
        zmsImpl.deleteAssertionPolicyVersion(ctx, domainName, policyName, "New-Version2", id1, auditRef, null);
        policyVersion = zmsImpl.getPolicyVersion(ctx, domainName, policyName, "New-Version2");
        assertEquals(policyVersion.getAssertions().size(), 1);
        assertEquals(policyVersion.getAssertions().get(0).getId(), id2);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutPolicyVersionCopyAssertionConditions() {
        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "PolicyGetDom1";
        String policyName = "Policy1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("setActivePolicyVersion");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, policyName);
        // Create policy
        zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy1);

        // Put new version
        String newVersion = "new-version";
        zmsImpl.putPolicyVersion(ctx, domainName, policyName, new PolicyOptions().setVersion(newVersion), auditRef, false, null);

        // Put new assertion in new (disabled) version
        Assertion assertion = new Assertion();
        assertion.setAction("testAction");
        assertion.setEffect(AssertionEffect.DENY);
        assertion.setResource(domainName + ":test-resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "Role1"));

        // we're not allowed to add an assertion that the associated role doesn't exist

        try {
            zmsImpl.putAssertionPolicyVersion(ctx, domainName, policyName, newVersion, auditRef, null, assertion);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("does not exist"));
            }
        // add the doesn't exist role - now the addition should be successful
        addRoleNeededForTest(domainName,"Role1");
        zmsImpl.putAssertionPolicyVersion(ctx, domainName, policyName, newVersion, auditRef, null, assertion);

        // we're not allowed to create assertions in the admin policy

        try {
            zmsImpl.putAssertionPolicyVersion(ctx, domainName, "admin", newVersion, auditRef, null, assertion);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("admin policy cannot be modified"));
        }

        // Put assertion conditions for the new assertion
        AssertionConditionData assertionConditionData = new AssertionConditionData();
        assertionConditionData.setOperator(AssertionConditionOperator.EQUALS);
        assertionConditionData.setValue("testVal1");

        Map<String, AssertionConditionData> conditionsMap1 = new HashMap<>();
        conditionsMap1.put("cond1", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue("testval1"));
        conditionsMap1.put("cond2", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue("testval2"));
        AssertionCondition assertionCondition1 = new AssertionCondition();
        assertionCondition1.setConditionsMap(conditionsMap1);
        Map<String, AssertionConditionData> conditionsMap2 = new HashMap<>();
        conditionsMap2.put("cond3", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue("testval3"));
        conditionsMap2.put("cond4", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue("testval4"));
        AssertionCondition assertionCondition2 = new AssertionCondition();
        assertionCondition2.setConditionsMap(conditionsMap2);
        List<AssertionCondition> conditionsList = new ArrayList<>();
        conditionsList.add(assertionCondition1);
        conditionsList.add(assertionCondition2);
        AssertionConditions assertionConditions = new AssertionConditions();
        assertionConditions.setConditionsList(conditionsList);
        zmsImpl.putAssertionConditions(ctx, domainName, policyName, assertion.getId(), auditRef, null, assertionConditions);

        // put new policy version based on the version we just created
        zmsImpl.putPolicyVersion(ctx, domainName, policyName, new PolicyOptions().setFromVersion(newVersion).setVersion("new-version2"), auditRef, false, null);

        // get new policy version and verify all assertion and assertion conditions were copied
        // currently assertion conditions are only retrieved in get all policies call
        Policies policies = zmsImpl.getPolicies(ctx, domainName, true, true, null, null);
        Policy policyVersion = policies.getList().stream()
                .filter(policy ->
                        policy.getName().equals("PolicyGetDom1:policy.Policy1".toLowerCase()) && policy.getVersion().equals("new-version2")
                )
                .findFirst().get();

        assertEquals(policyVersion.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());
        assertFalse(policyVersion.getActive());
        assertEquals(policyVersion.getVersion(), "new-version2");
        List<Assertion> assertList = policyVersion.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 2);
        Assertion obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());
        assertNull(obj.getConditions());
        obj = assertList.get(1);
        assertEquals(obj.getAction(), "testaction");
        assertEquals(obj.getEffect(), AssertionEffect.DENY);
        assertEquals(obj.getResource(), domainName.toLowerCase() + ":test-resource");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Role1".toLowerCase());
        List<AssertionCondition> conditionsListReturned = obj.getConditions().getConditionsList();
        assertEquals(conditionsListReturned.size(), 2);
        assertEquals(conditionsListReturned.get(0).getConditionsMap().get("cond1").getValue(), "testval1");
        assertEquals(conditionsListReturned.get(0).getConditionsMap().get("cond2").getValue(), "testval2");
        assertEquals(conditionsListReturned.get(1).getConditionsMap().get("cond3").getValue(), "testval3");
        assertEquals(conditionsListReturned.get(1).getConditionsMap().get("cond4").getValue(), "testval4");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testEnablePolicyVersion() {

        TestAuditLogger alogger = new TestAuditLogger();
        List<String> aLogMsgs = alogger.getLogMsgList();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "PolicyGetDom1";
        String policyName = "Policy1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("setActivePolicyVersion");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        createPolicyWithVersions(zmsImpl, domainName, policyName);

        // enable a different version
        //
        aLogMsgs.clear();
        zmsImpl.setActivePolicyVersion(ctx, domainName, policyName, new PolicyOptions().setVersion("New-Version1"), auditRef, null);

        boolean foundError = false;
        System.err.println("testEnablePolicyVersion: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(setActivePolicyVersion)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("set-active-policy\": [{\"name\": \"policygetdom1:policy.policy1\", \"version\": \"0\", \"active\": \"false\", \"modified\": ");
            int index3 = msg.indexOf("},{\"name\": \"policygetdom1:policy.policy1\", \"version\": \"new-version1\", \"active\": \"true\", \"modified\": ");
            assertTrue(index < index2, msg);
            assertTrue(index2 < index3, msg);
            index2 = msg.indexOf("ERROR");
            assertEquals(index2, -1, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // Verify when fetching the policy we get the new active version
        Policy newActivePolicy = zmsImpl.getPolicy(ctx, domainName, policyName);
        assertTrue(newActivePolicy.getActive());
        assertEquals(newActivePolicy.getVersion(), "new-version1");
        assertEquals(newActivePolicy.getName(), "policygetdom1:policy.policy1");
        assertEquals(newActivePolicy.getAssertions().size(), 1);
        assertEquals(newActivePolicy.getAssertions().get(0).getResource(), "policygetdom1:*");
        assertEquals(newActivePolicy.getAssertions().get(0).getRole(), "PolicyGetDom1:role.Admin".toLowerCase());

        // Verify fetching other versions show them as non-active
        Policy oldVersion = zmsImpl.getPolicyVersion(ctx, domainName, policyName, "0");
        assertFalse(oldVersion.getActive());
        assertEquals(oldVersion.getVersion(), "0");
        assertEquals(oldVersion.getName(), "policygetdom1:policy.policy1");

        oldVersion = zmsImpl.getPolicyVersion(ctx, domainName, policyName, "new-version2");
        assertFalse(oldVersion.getActive());
        assertEquals(oldVersion.getVersion(), "new-version2");
        assertEquals(oldVersion.getName(), "policygetdom1:policy.policy1");

        // Verify trying to activate version in admin policy throws an exception
        try {
            zmsImpl.setActivePolicyVersion(ctx, domainName, "admin", new PolicyOptions().setVersion("newversion"), auditRef, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"setActivePolicyVersion: admin policy cannot be modified\"}");
        }

        // Verify setting active version in read mode throws an exception
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true).thenReturn(false);
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.setActivePolicyVersion(ctx, domainName, policyName, new PolicyOptions().setVersion("New-Version2"), auditRef, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"Server in Maintenance Read-Only mode. Please try your request later\"}");
        }

        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        zmsImpl.deleteTopLevelDomain(ctx, "PolicyGetDom1", auditRef, null);
    }

    private Policy createPolicyWithVersions(ZMSImpl zmsImpl, String domainName, String policyName) {

        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, policyName);
        // Create policy
        zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy1);

        // Create new version with the same assertions as the active policy
        zmsImpl.putPolicyVersion(ctx, domainName, policyName, new PolicyOptions().setVersion("New-Version1"), auditRef, false, null);

        // Put new assertions in active policy. They will not appear in "New-Version1".
        Assertion assertion = new Assertion();
        assertion.setAction("updatetest");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resourcetest");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));
        zmsImpl.putAssertion(ctx, domainName, policyName, auditRef, null, assertion);

        // Put new version. This will include all assertions of the active policy including the new assertion.
        zmsImpl.putPolicyVersion(ctx, "PolicyGetDom1", "Policy1", new PolicyOptions().setVersion("New-Version2"), auditRef, false, null);
        return policy1;
    }

    @Test
    public void testGetPolicyCaseSensitive() {

        TestAuditLogger alogger = new TestAuditLogger();
        List<String> aLogMsgs = alogger.getLogMsgList();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyGetDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putpolicy");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        addRoleNeededForTest("PolicyGetDom1", "Role1");
        Policy policy1 = zmsTestInitializer.createPolicyObject("PolicyGetDom1", "Policy1", "Role1", "ActioN1", "PolicyGetDom1:SomeResourcE", AssertionEffect.ALLOW);
        policy1.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "PolicyGetDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy = zmsImpl.getPolicy(ctx, "PolicyGetDom1", "Policy1");
        assertNotNull(policy);
        assertEquals(policy.getName(), "PolicyGetDom1:policy.Policy1".toLowerCase());

        List<Assertion> assertList = policy.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 1);
        Assertion obj = assertList.get(0);
        assertEquals(obj.getAction(), "ActioN1");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:SomeResourcE");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Role1".toLowerCase());

        boolean foundError = false;
        System.err.println("testGetPolicy: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putpolicy)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("\"added-assertions\": [{\"role\": \"policygetdom1:role.role1\", \"action\": \"ActioN1\", \"effect\": \"ALLOW\", \"resource\": \"policygetdom1:SomeResourcE\"}]");
            assertTrue(index < index2, msg);
            index2 = msg.indexOf("ERROR");
            assertEquals(index2, -1, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // modify the assertion: result is add of new assertion, delete of old
        //
        obj.setAction("layup");
        // We'll set the policy to not be case-sensitive. So even though we didn't override the resource name, it will be lower-cased
        policy1.setCaseSensitive(false);
        obj.setEffect(AssertionEffect.DENY);
        List<Assertion> assertions = new ArrayList<>();
        assertions.add(obj);
        policy1.setAssertions(assertions);
        aLogMsgs.clear();
        zmsImpl.putPolicy(ctx, "PolicyGetDom1", "Policy1", auditRef, false, null, policy1);

        foundError = false;
        System.err.println("testGetPolicy: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putpolicy)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("\"added-assertions\": [{\"role\": \"policygetdom1:role.role1\", \"action\": \"layup\", \"effect\": \"DENY\", \"resource\": \"policygetdom1:someresource\"}]");
            assertTrue(index < index2, msg);
            index2 = msg.indexOf("ERROR");
            assertEquals(index2, -1, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // this should throw an exception
        try {
            zmsImpl.getPolicy(ctx, "PolicyGetDom1", "Policy2");
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyGetDom1", auditRef, null);
    }

    @Test
    public void testGetPolicyThrowException() {
        String domainName = "PolicyGetDom1";
        String policyName = "Policy1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // Tests the getPolicy() condition : if (domain == null)...
        try {
            zmsImpl.getPolicy(ctx, domainName, policyName);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putpolicy");
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Tests the getPolicy() condition: if (collection == null)...
        try {
            // Should fail b/c a policy was never added.
            zmsImpl.getPolicy(ctx, domainName, policyName);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        // Tests the getPolicy() condition: if (policy == null)...
        try {
            String wrongPolicyName = "Policy2";

            Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, policyName);
            zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy1);

            // Should fail b/c trying to find a non-existent policy.
            zmsImpl.getPolicy(ctx, domainName, wrongPolicyName);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutPolicyThrowException() {
        String domainName = "DomainName";
        String policyName = "PolicyName";
        String wrongPolicyName = "WrongPolicyName";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // Tests the putPolicy() condition : if (!policyResourceName(domainName, policyName).equals(policy.getName()))...
        try {
            Policy policy = zmsTestInitializer.createPolicyObject(domainName, wrongPolicyName);

            // policyName should not be the same as policy.getName()
            zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }

        // Tests the putPolicy() condition: if (domain == null)...
        try {
            Policy policy = zmsTestInitializer.createPolicyObject(domainName, policyName);

            // should fail b/c we never created a top level domain.
            zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testCreatePolicy() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyAddDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject("PolicyAddDom1", "Policy1");
        zmsImpl.putPolicy(ctx, "PolicyAddDom1", "Policy1", auditRef, false, null, policy1);

        Policy policyRes2 = zmsImpl.getPolicy(ctx, "PolicyAddDom1", "Policy1");
        assertNotNull(policyRes2);
        assertEquals(policyRes2.getName(), "PolicyAddDom1:policy.Policy1".toLowerCase());

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyAddDom1", auditRef, null);
    }

    @Test
    public void testCreatePolicyCaseSensitive() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyAddDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Create policy with an "allow all" assertion
        Policy policy1 = zmsTestInitializer.createPolicyObject("PolicyAddDom1", "Policy1");
        // Make the assertions in the policy case-sensitive in regard to action and resource
        policy1.setCaseSensitive(true);

        addRoleNeededForTest("PolicyAddDom1", "provider");

        // Create assertion2
        Assertion assertion2 = new Assertion();
        assertion2.setAction("ReaD");
        assertion2.setEffect(AssertionEffect.ALLOW);
        assertion2.setResource("coretech:RESOURCE");
        assertion2.setRole("PolicyAddDom1:role.provider");

        // Create assertion3 which is identical to assertion2 but with a different case in action and resource
        Assertion assertion3 = new Assertion();
        assertion3.setAction("READ");
        assertion3.setEffect(AssertionEffect.ALLOW);
        assertion3.setResource("coretech:Resource");
        assertion3.setRole("PolicyAddDom1:role.provider");

        // Create assertion4 which is different from assertion 3 and 2
        Assertion assertion4 = new Assertion();
        assertion4.setAction("WritE");
        assertion4.setEffect(AssertionEffect.ALLOW);
        assertion4.setResource("coretech:OtherResource");
        assertion4.setRole("PolicyAddDom1:role.provider");

        policy1.getAssertions().add(assertion2);
        policy1.getAssertions().add(assertion3);
        policy1.getAssertions().add(assertion4);

        zmsImpl.putPolicy(ctx, "PolicyAddDom1", "Policy1", auditRef, false, null, policy1);

        Policy policyRes2 = zmsImpl.getPolicy(ctx, "PolicyAddDom1", "Policy1");
        assertNotNull(policyRes2);
        assertEquals(policyRes2.getName(), "PolicyAddDom1:policy.Policy1".toLowerCase());
        List<Assertion> assertions = policyRes2.getAssertions();
        assertEquals(assertions.size(), 3); // assertion 2 and 3 are considered identical so only one remained

        assertEquals(assertions.get(1).getAction(), "ReaD");
        assertEquals(assertions.get(1).getResource(), "coretech:RESOURCE");

        assertEquals(assertions.get(2).getAction(), "WritE");
        assertEquals(assertions.get(2).getResource(), "coretech:OtherResource");

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyAddDom1", auditRef, null);
    }

    @Test
    public void testCreatePolicyWithLocalName() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyAddDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = new Policy();
        policy.setName("policy1");

        Assertion assertion = new Assertion();
        assertion.setAction("read");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("policyadddom1:*");
        assertion.setRole("policyadddom1:role.admin");

        List<Assertion> assertList = new ArrayList<>();
        assertList.add(assertion);

        policy.setAssertions(assertList);

        zmsImpl.putPolicy(ctx, "PolicyAddDom1", "Policy1", auditRef, false, null, policy);

        Policy policyRes2 = zmsImpl.getPolicy(ctx, "PolicyAddDom1", "Policy1");
        assertNotNull(policyRes2);
        assertEquals(policyRes2.getName(), "PolicyAddDom1:policy.Policy1".toLowerCase());

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyAddDom1", auditRef, null);
    }

    @Test
    public void testCreatePolicyMissingAuditRef() {
        String domain = "testCreatePolicyMissingAuditRef";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Policy policy = zmsTestInitializer.createPolicyObject(domain, "Policy1");
        try {
            zmsImpl.putPolicy(ctx, domain, "Policy1", null, false, null, policy);
            fail("requesterror not thrown by putPolicy.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testPutPolicyChanges() {
        String domain     = "PutPolicyChanges";
        String policyName = "Jobs";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domain, policyName);
        List<Assertion> origAsserts = policy1.getAssertions();

        String userId = "hank";

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=" + userId;
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds + ";s=signature",
                0, principalAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);

        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);
        zmsImpl.putPolicy(rsrcCtx1, domain, policyName, auditRef, false, null, policy1);

        Policy policyRes1A = zmsImpl.getPolicy(ctx, domain, policyName);
        List<Assertion> resAsserts = policyRes1A.getAssertions();

        // check assertions are the same - should only be 1
        assertEquals(origAsserts.size(), resAsserts.size());

        // now replace the old assertion with a new ones
        //
        addRoleNeededForTest(domain, "librarian");
        Assertion assertionA = new Assertion();
        assertionA.setResource(domain + ":books");
        assertionA.setAction("READ");
        assertionA.setRole(domain + ":role.librarian");
        assertionA.setEffect(AssertionEffect.ALLOW);

        addRoleNeededForTest(domain, "astronaut");
        Assertion assertionB = new Assertion();
        assertionB.setResource(domain + ":jupiter");
        assertionB.setAction("TRAVEL");
        assertionB.setRole(domain + ":role.astronaut");
        assertionB.setEffect(AssertionEffect.ALLOW);

        List<Assertion> newAssertions = new ArrayList<>();
        newAssertions.add(assertionA);
        newAssertions.add(assertionB);

        policyRes1A.setAssertions(newAssertions);

        zmsImpl.putPolicy(ctx, domain, policyName, auditRef, false, null, policyRes1A);

        Policy policyRes1B = zmsImpl.getPolicy(ctx, domain, policyName);
        List<Assertion> resAssertsB = policyRes1B.getAssertions();

        // check assertions are the same - should be 2
        assertEquals(newAssertions.size(), resAssertsB.size());

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
    }


    private boolean assertionConditionListEqual(List<AssertionCondition> list1, List<AssertionCondition> list2) {
        if (list1.size() != list2.size()) {
            return false;
        }
        for (AssertionCondition ac: list1) {
            if (list2.stream().noneMatch(ac::equals)) {
                return false;
            }
        }
        return true;
    }
    
    @Test
    public void testPutPolicyAssertionConditionsChanges() {
        String domain     = "PutPolicyAssertionConditionsChanges";
        String policyName = "Jobs";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        String aclAction = "TCP-IN:84443:4443";
        Policy policy1 = zmsTestInitializer.createPolicyObject(domain, policyName, "admin", aclAction, domain + ":test", AssertionEffect.ALLOW);
        Assertion aclAssertion = policy1.getAssertions().get(0);
        aclAssertion.setCaseSensitive(true);
        aclAssertion.setConditions(new AssertionConditions().setConditionsList(new ArrayList<>()));
        AssertionCondition condition1 = createAssertionConditionObject(1, "test", "test1");
        AssertionCondition condition2 = createAssertionConditionObject(2, "test", "test2");
        aclAssertion.getConditions().getConditionsList().add(condition1);
        aclAssertion.getConditions().getConditionsList().add(condition2);

        // add the admin policy
        policy1.getAssertions().add(new Assertion()
                        .setRole(domain + ":role.admin")
                        .setAction("*")
                        .setResource(domain + ":*")
                        .setEffect(AssertionEffect.ALLOW));

        String userId = "hank";

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=" + userId;
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds + ";s=signature",
                0, principalAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);

        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);
        zmsImpl.putPolicy(rsrcCtx1, domain, policyName, auditRef, false, null, policy1);

        Policy policyRes1 = zmsImpl.getPolicy(ctx, domain, policyName);
        List<Assertion> resAsserts1 = policyRes1.getAssertions();

        assertEquals(resAsserts1.size(), 2);

        Assertion aclAssertRes1 = null;
        for (Assertion a: resAsserts1) {
            if (a.getAction().equals(aclAction)) {
                aclAssertRes1 = a;
                break;
            }
        }
        assertNotNull(aclAssertRes1);
        assertTrue(assertionConditionListEqual(aclAssertRes1.getConditions().getConditionsList(), aclAssertion.getConditions().getConditionsList()));

        // change the assertion itself
        aclAction = "TCP-IN:3333:2222";
        aclAssertRes1.setAction(aclAction).setCaseSensitive(true);

        zmsImpl.putPolicy(rsrcCtx1, domain, policyName, auditRef, false, null, policyRes1);
        Policy policyRes2 = zmsImpl.getPolicy(ctx, domain, policyName);
        List<Assertion> resAsserts2 = policyRes2.getAssertions();
        Assertion aclAssertRes2 = null;
        for (Assertion a: resAsserts2) {
            if (a.getAction().equals(aclAction)) {
                aclAssertRes2 = a;
                break;
            }
        }
        assertNotNull(aclAssertRes2);
        assertTrue(assertionConditionListEqual(aclAssertRes2.getConditions().getConditionsList(), aclAssertRes1.getConditions().getConditionsList()));

        // change the first assertion condition

        AssertionCondition condition3 = createAssertionConditionObject(condition1.getId(), "test", "test3");
        aclAssertRes2.getConditions().getConditionsList().remove(condition1);
        aclAssertRes2.getConditions().getConditionsList().add(condition3);
        aclAssertRes2.setCaseSensitive(true);
        zmsImpl.putPolicy(rsrcCtx1, domain, policyName, auditRef, false, null, policyRes2);

        Policy policyRes3 = zmsImpl.getPolicy(ctx, domain, policyName);
        List<Assertion> resAsserts3 = policyRes3.getAssertions();
        Assertion aclAssertRes3 = null;
        for (Assertion a: resAsserts3) {
            if (a.getAction().equals(aclAction)) {
                aclAssertRes3 = a;
                break;
            }
        }
        assertNotNull(aclAssertRes3);
        assertTrue(assertionConditionListEqual(aclAssertRes3.getConditions().getConditionsList(), aclAssertRes2.getConditions().getConditionsList()));


        // add condition
        AssertionCondition condition4 = createAssertionConditionObject(4, "test", "test4");
        aclAssertRes3.getConditions().getConditionsList().add(condition4);
        aclAssertRes3.setCaseSensitive(true);
        zmsImpl.putPolicy(rsrcCtx1, domain, policyName, auditRef, false, null, policyRes3);

        Policy policyRes4 = zmsImpl.getPolicy(ctx, domain, policyName);
        List<Assertion> resAsserts4 = policyRes4.getAssertions();
        Assertion aclAssertRes4 = null;
        for (Assertion a: resAsserts4) {
            if (a.getAction().equals(aclAction)) {
                aclAssertRes4 = a;
                break;
            }
        }
        assertNotNull(aclAssertRes4);
        assertTrue(assertionConditionListEqual(aclAssertRes4.getConditions().getConditionsList(), aclAssertRes3.getConditions().getConditionsList()));

        // nothing change
        aclAssertRes4.setCaseSensitive(true);
        zmsImpl.putPolicy(rsrcCtx1, domain, policyName, auditRef, false, null, policyRes4);

        Policy policyRes5 = zmsImpl.getPolicy(ctx, domain, policyName);
        List<Assertion> resAsserts5 = policyRes5.getAssertions();
        Assertion aclAssertRes5 = null;
        for (Assertion a: resAsserts5) {
            if (a.getAction().equals(aclAction)) {
                aclAssertRes5 = a;
                break;
            }
        }
        assertNotNull(aclAssertRes5);
        assertTrue(assertionConditionListEqual(aclAssertRes5.getConditions().getConditionsList(), aclAssertRes4.getConditions().getConditionsList()));

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
    }

    private void addRoleNeededForTest(String domain, String roleName) {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Role role = zmsTestInitializer.createRoleObject(domain, roleName, null);
        zmsImpl.putRole(ctx, domain, roleName, auditRef, false, null, role);
    }

    @Test
    public void testPutAdminPolicyRejection() {

        String domain = "put-admin-rejection";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domain, "admin");
        try {
            zmsImpl.putPolicy(ctx, domain, "admin", auditRef, false, null, policy);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("admin policy cannot be modified"), ex.getMessage());
        }
        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
    }

    @Test
    public void testCreatePolicyNoAssertions() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                "testCreatePolicyNoAssertions", "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = new Policy();
        policy1.setName(ResourceUtils.policyResourceName("testCreatePolicyNoAssertions",
                "Policy1"));

        try {
            zmsImpl.putPolicy(ctx, "testCreatePolicyNoAssertions", "Policy1", auditRef, false, null, policy1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "testCreatePolicyNoAssertions", auditRef, null);
    }

    @Test
    public void testPutPolicyInvalidAssertionResources() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "InvalidAssertionResources";
        String policyName = "Policy1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = new Policy();
        policy.setName(ResourceUtils.policyResourceName(domainName, policyName));

        // assertion missing domain name

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("resource1");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "role1"));

        List<Assertion> assertList = new ArrayList<>();
        assertList.add(assertion);
        policy.setAssertions(assertList);

        try {
            zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // assertion with invalid domain name

        assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain name:resource1");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "role1"));

        assertList.clear();
        assertList.add(assertion);
        policy.setAssertions(assertList);

        try {
            zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreatePolicyMismatchName() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                "PolicyAddMismatchNameDom1", "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject("PolicyAddMismatchNameDom1",
                "Policy1");

        try {
            zmsImpl.putPolicy(ctx, "PolicyAddMismatchNameDom1",
                    "PolicyAddMismatchNameDom1.Policy1", auditRef, false, null, policy1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyAddMismatchNameDom1", auditRef, null);
    }

    @Test
    public void testCreatePolicyInvalidName() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                "PolicyAddInvalidNameDom1", "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = new Policy();
        policy.setName("Policy1");

        try {
            zmsImpl.putPolicy(ctx, "PolicyAddInvalidNameDom1", "Policy1", auditRef, false, null, policy);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyAddInvalidNameDom1", auditRef, null);
    }

    @Test
    public void testCreatePolicyInvalidStruct() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                "PolicyAddInvalidStructDom1", "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = new Policy();

        try {
            zmsImpl.putPolicy(ctx, "PolicyAddInvalidStructDom1", "Policy1", auditRef, false, null, policy);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyAddInvalidStructDom1", auditRef, null);
    }

    @Test
    public void testDeletePolicy() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyDelDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject("PolicyDelDom1", "Policy1");
        zmsImpl.putPolicy(ctx, "PolicyDelDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject("PolicyDelDom1", "Policy2");
        zmsImpl.putPolicy(ctx, "PolicyDelDom1", "Policy2", auditRef, false, null, policy2);

        Policy policyRes1 = zmsImpl.getPolicy(ctx, "PolicyDelDom1", "Policy1");
        assertNotNull(policyRes1);

        Policy policyRes2 = zmsImpl.getPolicy(ctx, "PolicyDelDom1", "Policy2");
        assertNotNull(policyRes2);

        zmsImpl.deletePolicy(ctx, "PolicyDelDom1", "Policy1", auditRef, null);

        // we need to get an exception here
        try {
            zmsImpl.getPolicy(ctx, "PolicyDelDom1", "Policy1");
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        policyRes2 = zmsImpl.getPolicy(ctx, "PolicyDelDom1", "Policy2");
        assertNotNull(policyRes2);

        zmsImpl.deletePolicy(ctx, "PolicyDelDom1", "Policy2", auditRef, null);

        // we need to get an exception here
        try {
            zmsImpl.getPolicy(ctx, "PolicyDelDom1", "Policy1");
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        // we need to get an exception here
        try {
            zmsImpl.getPolicy(ctx, "PolicyDelDom1", "Policy2");
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyDelDom1", auditRef, null);
    }

    @Test
    public void testDeletePolicyVersion() {

        TestAuditLogger alogger = new TestAuditLogger();
        List<String> aLogMsgs = alogger.getLogMsgList();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "PolicyGetDom1";
        String policyName = "Policy1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putpolicy").thenReturn("putpolicyversion").thenReturn("putassertion").thenReturn("putpolicyversion").thenReturn("deletepolicyversion");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        createPolicyWithVersions(zmsImpl, domainName, policyName);

        // delete non-active policy version
        //
        aLogMsgs.clear();
        zmsImpl.deletePolicyVersion(ctx, domainName, policyName, "New-Version1", auditRef, null);

        boolean foundError = false;
        System.err.println("testDeletePolicyVersion: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(deletepolicyversion)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("{\"name\": \"policygetdom1:policy.policy1\", \"version\": \"new-version1\", \"active\": \"false\", \"modified\": ");
            int index3 = msg.indexOf(", \"deleted-assertions\": [{\"role\": \"policygetdom1:role.admin\", \"action\": \"*\", \"effect\": \"ALLOW\", \"resource\": \"policygetdom1:*\"}]");
            assertTrue(index < index2, msg);
            assertTrue(index2 < index3, msg);
            index2 = msg.indexOf("ERROR");
            assertEquals(index2, -1, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // Verify when fetching the policy we still get the active version
        Policy newActivePolicy = zmsImpl.getPolicy(ctx, domainName, policyName);
        assertTrue(newActivePolicy.getActive());
        assertEquals(newActivePolicy.getVersion(), "0");
        assertEquals(newActivePolicy.getName(), "policygetdom1:policy.policy1");

        // Verify assertions for active version
        List<Assertion> assertList = newActivePolicy.getAssertions();
        assertNotNull(assertList);
        assertEquals(assertList.size(), 2);
        Assertion obj = assertList.get(0);
        assertEquals(obj.getAction(), "*");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), "policygetdom1:*");
        assertEquals(obj.getRole(), "PolicyGetDom1:role.Admin".toLowerCase());
        obj = assertList.get(1);
        assertEquals(obj.getAction(), "updatetest");
        assertEquals(obj.getEffect(), AssertionEffect.ALLOW);
        assertEquals(obj.getResource(), domainName.toLowerCase() + ":resourcetest");
        assertEquals(obj.getRole(), ResourceUtils.roleResourceName(domainName.toLowerCase(), "admin"));

        // Verify exception is thrown when trying to set the deleted version active
        try {
            zmsImpl.setActivePolicyVersion(ctx, domainName, policyName, new PolicyOptions().setVersion("New-Version1"), auditRef, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (404): {code: 404, message: \"unknown policy version: new-version1\"}");
        }

        // Verify exception is thrown when trying to delete non-existing policy version
        try {
            zmsImpl.deletePolicyVersion(ctx, domainName, policyName, "New-Version1", auditRef, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (404): {code: 404, message: \"deletepolicyversion: unable to read policy: policy1, version: new-version1\"}");
        }

        // Verify exception is thrown when trying to delete active policy version
        try {
            zmsImpl.deletePolicyVersion(ctx, domainName, policyName, "0", auditRef, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"deletepolicyversion: unable to delete active policy version. Policy: policy1, version: 0\"}");
        }

        // Verify when fetching the policy we still get the active version
        newActivePolicy = zmsImpl.getPolicy(ctx, domainName, policyName);
        assertTrue(newActivePolicy.getActive());
        assertEquals(newActivePolicy.getVersion(), "0");
        assertEquals(newActivePolicy.getName(), "policygetdom1:policy.policy1");

        // Verify deleting policy version in read mode throws an exception
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true).thenReturn(false);
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.deletePolicyVersion(ctx, domainName, policyName, "New-Version2", auditRef, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"Server in Maintenance Read-Only mode. Please try your request later\"}");
        }
        zmsImpl.readOnlyMode = dynamicConfigBoolean;

        // Verify trying to delete admin policy version throws an exception
        try {
            zmsImpl.deletePolicyVersion(ctx, domainName, "admin", "0", auditRef, null);
            fail();
        } catch (Exception ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"deletepolicyversion: admin policy version cannot be deleted\"}");
        }

        // Delete entire policy, verify all versions are gone
        zmsImpl.deletePolicy(ctx, domainName, policyName, auditRef, null);
        List<String> versions = Arrays.asList("0", "New-Version1", "New-Version2");
        for (String version : versions) {
            try {
                zmsImpl.getPolicyVersion(ctx, domainName, policyName, version);
                fail();
            } catch (Exception ex) {
                assertTrue(ex.getMessage().contains("Policy not found: 'policygetdom1:policy.policy1' with version: " + version.toLowerCase() + "\"}"));
            }
        }
        try {
            zmsImpl.getPolicy(ctx, domainName, policyName);
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains(": Policy not found: 'policygetdom1:policy.policy1'\"}"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyGetDom1", auditRef, null);
    }

    @Test
    public void testDeletePolicyThrowException() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "WrongDomainName";
        String policyName = "WrongPolicyName";
        try {
            zmsImpl.deletePolicy(ctx, domainName, policyName, auditRef, null);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testDeleteAdminPolicy() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("PolicyAdminDelDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        try {
            zmsImpl.deletePolicy(ctx, "PolicyAdminDelDom1", "admin", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "PolicyAdminDelDom1", auditRef, null);
    }

    @Test
    public void testDeletePolicyMissingAuditRef() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // create a new policy without an auditref
        String domain = "testDeletePolicyMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, null, null, zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        try {
            zmsImpl.deletePolicy(ctx, domain, "Policy1", null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testCreateServiceIdentity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceAddDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceAddDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceAddDom1", "Service1", auditRef, false, null, service);

        ServiceIdentity serviceRes2 = zmsImpl.getServiceIdentity(ctx, "ServiceAddDom1",
                "Service1");
        assertNotNull(serviceRes2);
        assertEquals(serviceRes2.getName(), "ServiceAddDom1.Service1".toLowerCase());

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceAddDom1", auditRef, null);
    }

    @Test
    public void testCreateServiceIdentityNotSimpleName() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceAddDom1NotSimpleName",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceAddDom1NotSimpleName",
                "Service1.Test", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        try {
            zmsImpl.putServiceIdentity(ctx, "ServiceAddDom1NotSimpleName", "Service1.Test", auditRef, false, null, service);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceAddDom1NotSimpleName", auditRef, null);
    }

    @Test
    public void testCreateServiceIdentityMissingAuditRef() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testCreateServiceIdentityMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        ServiceIdentity service = zmsTestInitializer.createServiceObject(
                domain,
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        try {
            zmsImpl.putServiceIdentity(ctx, domain, "Service1", null, false, null, service);
            fail("requesterror not thrown by putServiceIdentity.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testCreateServiceIdentityMismatchName() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceAddMismatchNameDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceAddMismatchNameDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        try {
            zmsImpl.putServiceIdentity(ctx, "ServiceAddMismatchNameDom1",
                    "ServiceAddMismatchNameDom1.Service1", auditRef, false, null, service);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceAddMismatchNameDom1", auditRef, null);
    }

    @Test
    public void testCreateServiceIdentityInvalidName() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceAddInvalidNameDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = new ServiceIdentity();
        service.setName("Service1");

        try {
            zmsImpl.putServiceIdentity(ctx, "ServiceAddInvalidNameDom1", "Service1", auditRef, false, null, service);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceAddInvalidNameDom1", auditRef, null);
    }

    @Test
    public void testCreateServiceIdentityInvalidCert() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceAddInvalidCertDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName("ServiceAddInvalidCertDom1", "Service1"));
        List<PublicKeyEntry> pubKeys = new ArrayList<>();
        pubKeys.add(new PublicKeyEntry().setId("0").setKey("LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlHZk1BMEdDU3FHU0liM0RRRUJBUVVBQTRHTk"));
        service.setPublicKeys(pubKeys);

        try {
            zmsImpl.putServiceIdentity(ctx, "ServiceAddInvalidCertDom1", "Service1", auditRef, false, null, service);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceAddInvalidCertDom1", auditRef, null);
    }

    @Test
    public void testCreateServiceIdentityInvalidStruct() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceAddInvalidStructDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = new ServiceIdentity();

        try {
            zmsImpl.putServiceIdentity(ctx, "ServiceAddInvalidStructDom1", "Service1", auditRef, false, null, service);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceAddInvalidStructDom1", auditRef, null);
    }

    @Test
    public void testPutServiceIdentityWithoutPubKey() {
        String domainName = "ServicePutDom1";
        String serviceName = "Service1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName(domainName, serviceName));

        zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, service);

        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, domainName, serviceName);
        assertNotNull(serviceRes);
        assertEquals(serviceRes.getName(), "ServicePutDom1.Service1".toLowerCase());

        zmsImpl.deleteTopLevelDomain(ctx,  domainName, auditRef, null);
    }

    @Test
    public void testPutServiceIdentitySamePubKeyIdDifferentValue() {
        String domainName = "ServicePutDom1";
        String serviceName = "Service1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        List<PublicKeyEntry> publicKeyOldList = new ArrayList<>();
        PublicKeyEntry publicKeyEntryOld = new PublicKeyEntry();
        publicKeyEntryOld.setKey(zmsTestInitializer.getPubKeyK1());
        publicKeyEntryOld.setId("1");
        publicKeyOldList.add(publicKeyEntryOld);

        List<PublicKeyEntry> publicKeyNewList = new ArrayList<>();
        PublicKeyEntry publicKeyEntryNew = new PublicKeyEntry();
        publicKeyEntryNew.setKey(zmsTestInitializer.getPubKeyK2());
        publicKeyEntryNew.setId("1");
        publicKeyNewList.add(publicKeyEntryNew);

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName(domainName, serviceName));
        service.setPublicKeys(publicKeyOldList);
        zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, service);

        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, domainName, serviceName);
        assertNotNull(serviceRes);
        assertEquals(serviceRes.getName(), "ServicePutDom1.Service1".toLowerCase());
        assertEquals(serviceRes.getPublicKeys().size(), 1);
        assertEquals(serviceRes.getPublicKeys().get(0), publicKeyEntryOld);

        service.setPublicKeys(publicKeyNewList);
        zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, service);

        serviceRes = zmsImpl.getServiceIdentity(ctx, domainName, serviceName);
        assertNotNull(serviceRes);
        assertEquals(serviceRes.getName(), "ServicePutDom1.Service1".toLowerCase());
        assertEquals(serviceRes.getPublicKeys().size(), 1);
        assertEquals(serviceRes.getPublicKeys().get(0).getId(), "1");
        assertEquals(serviceRes.getPublicKeys().get(0).getKey(), zmsTestInitializer.getPubKeyK2());

        zmsImpl.deleteTopLevelDomain(ctx,  domainName, auditRef, null);
    }

    @Test
    public void testPutServiceIdentityInvalidServiceName() {
        String domainName = "ServicePutDom1";
        String serviceName = "cloud";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName(domainName, serviceName));

        try {
            zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, service);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("reserved service name"));
        }

        zmsImpl.deleteTopLevelDomain(ctx,  domainName, auditRef, null);
    }

    @Test
    public void testPutServiceIdentityInvalidEndPoint() {
        String domainName = "ServicePutDom1";
        String serviceName = "Service1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName(domainName, serviceName));
        service.setProviderEndpoint("https://sometestcompany.com");

        try {
            zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, service);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Invalid endpoint"));
        }

        zmsImpl.deleteTopLevelDomain(ctx,  domainName, auditRef, null);
    }

    @Test
    public void testPutServiceIdentityThrowException() {
        String domainName = "DomainName";
        String serviceName = "ServiceName";
        String wrongServiceName = "WrongServiceName";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // Tests the putServiceIdentity() condition: if (!serviceResourceName(domainName, serviceName).equals(detail.getName()))...
        try {
            ServiceIdentity detail = zmsTestInitializer.createServiceObject(domainName,
                    wrongServiceName, "http://localhost", "/usr/bin/java", "root",
                    "users", "host1");

            // serviceName should not render to be the same as domainName:service.wrongServiceName
            zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, detail);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }

        // Tests the putServiceIdentity() condition: if (domain == null)...
        try {
            ServiceIdentity detail = zmsTestInitializer.createServiceObject(domainName,
                    serviceName, "http://localhost", "/usr/bin/java", "root",
                    "users", "host1");

            // should fail b/c we never created a top level domain.
            zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, detail);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testGetServiceIdentity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceGetDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceGetDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceGetDom1", "Service1", auditRef, false, null, service);

        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, "ServiceGetDom1",
                "Service1");
        assertNotNull(serviceRes);
        assertEquals(serviceRes.getName(), "ServiceGetDom1.Service1".toLowerCase());
        assertEquals(serviceRes.getExecutable(), "/usr/bin/java");
        assertEquals(serviceRes.getGroup(), "users");
        assertEquals(serviceRes.getUser(), "root");

        // provider endpoint is a system meta attribute, so we shouldn't save it
        assertNull(serviceRes.getProviderEndpoint());

        List<String> hosts = serviceRes.getHosts();
        assertNotNull(hosts);
        assertEquals(hosts.size(), 1);
        assertEquals(hosts.get(0), "host1");

        // this should throw a not found exception
        try {
            zmsImpl.getServiceIdentity(ctx, "ServiceGetDom1", "Service2");
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        // this should throw a request error exception
        try {
            zmsImpl.getServiceIdentity(ctx, "ServiceGetDom1", "Service2.Service3");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceGetDom1", auditRef, null);
    }

    @Test
    public void testPutServiceIdentitySystemMeta() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "service-system-meta";
        final String serviceName = "service1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject(domainName,
                serviceName, "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, service);

        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, domainName, serviceName);
        assertNotNull(serviceRes);
        assertEquals(serviceRes.getName(), domainName + "." + serviceName);
        assertEquals(serviceRes.getExecutable(), "/usr/bin/java");
        assertEquals(serviceRes.getGroup(), "users");
        assertEquals(serviceRes.getUser(), "root");

        // provider endpoint is a system meta attribute, so we shouldn't save it
        assertNull(serviceRes.getProviderEndpoint());

        // now let's set the meta attribute

        ServiceIdentitySystemMeta meta = new ServiceIdentitySystemMeta();
        zmsImpl.putServiceIdentitySystemMeta(ctx, domainName, serviceName, "providerendpoint", auditRef, meta);

        // we expect no changes

        serviceRes = zmsImpl.getServiceIdentity(ctx, domainName, serviceName);
        assertEquals(serviceRes.getName(), domainName + "." + serviceName);
        assertEquals(serviceRes.getExecutable(), "/usr/bin/java");
        assertEquals(serviceRes.getGroup(), "users");
        assertEquals(serviceRes.getUser(), "root");
        assertNull(serviceRes.getProviderEndpoint());

        // now let's change the endpoint

        meta.setProviderEndpoint("https://localhost");
        zmsImpl.putServiceIdentitySystemMeta(ctx, domainName, serviceName, "providerendpoint", auditRef, meta);

        serviceRes = zmsImpl.getServiceIdentity(ctx, domainName, serviceName);
        assertEquals(serviceRes.getName(), domainName + "." + serviceName);
        assertEquals(serviceRes.getExecutable(), "/usr/bin/java");
        assertEquals(serviceRes.getGroup(), "users");
        assertEquals(serviceRes.getUser(), "root");
        assertEquals(serviceRes.getProviderEndpoint(), "https://localhost");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetServiceIdentityThrowException() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "ServiceGetDom1";
        String serviceName = "Service1";

        // Tests the getServiceIdentity() condition : if (domain == null)...
        try {
            // Should fail because we never created this domain.
            zmsImpl.getServiceIdentity(ctx, domainName, serviceName);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Tests the getServiceIdentity() condition : if (collection == null)...
        try {
            // Should fail because we never added a service identity to this domain.
            zmsImpl.getServiceIdentity(ctx, domainName, serviceName);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        // Tests the getServiceIdentity() condition : if (service == null)...
        try {
            String wrongServiceName = "Service2";

            ServiceIdentity service = zmsTestInitializer.createServiceObject(domainName,
                    serviceName, "http://localhost", "/usr/bin/java", "root",
                    "users", "host1");
            zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, service);

            // Should fail because trying to find a non-existent service identity.
            zmsImpl.getServiceIdentity(ctx, domainName, wrongServiceName);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteServiceIdentity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceDelDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject("ServiceDelDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceDelDom1", "Service1", auditRef, false, null, service1);

        ServiceIdentity service2 = zmsTestInitializer.createServiceObject("ServiceDelDom1",
                "Service2", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceDelDom1", "Service2", auditRef, false, null, service2);

        ServiceIdentity serviceRes1 = zmsImpl.getServiceIdentity(ctx, "ServiceDelDom1",
                "Service1");
        assertNotNull(serviceRes1);

        ServiceIdentity serviceRes2 = zmsImpl.getServiceIdentity(ctx, "ServiceDelDom1",
                "Service2");
        assertNotNull(serviceRes2);

        zmsImpl.deleteServiceIdentity(ctx, "ServiceDelDom1", "Service1", auditRef, null);

        // this should throw a not found exception
        try {
            zmsImpl.getServiceIdentity(ctx, "ServiceDelDom1", "Service1");
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        serviceRes2 = zmsImpl.getServiceIdentity(ctx, "ServiceDelDom1", "Service2");
        assertNotNull(serviceRes2);

        zmsImpl.deleteServiceIdentity(ctx, "ServiceDelDom1", "Service2", auditRef, null);

        // this should throw a not found exception
        try {
            zmsImpl.getServiceIdentity(ctx, "ServiceDelDom1", "Service1");
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        // this should throw a not found exception
        try {
            zmsImpl.getServiceIdentity(ctx, "ServiceDelDom1", "Service2");
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        // this should throw an invalid exception
        try {
            zmsImpl.getServiceIdentity(ctx, "ServiceDelDom1", "Service2.Service3");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceDelDom1", auditRef, null);
    }

    @Test
    public void testDeleteServiceIdentityMissingAuditRef() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testDeleteServiceIdentityMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        ServiceIdentity service = zmsTestInitializer.createServiceObject(
                domain,
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        zmsImpl.putServiceIdentity(ctx, domain, "Service1", auditRef, false, null, service);
        ServiceIdentity serviceRes =
                zmsImpl.getServiceIdentity(ctx, domain, "Service1");
        assertNotNull(serviceRes);
        try {
            zmsImpl.deleteServiceIdentity(ctx, domain, "Service1", null, null);
            fail("requesterror not thrown by deleteServiceIdentity.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testDeleteServiceIdentityThrowException() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "WrongDomainName";
        String serviceName = "WrongServiceName";
        try {
            zmsImpl.deleteServiceIdentity(ctx, domainName, serviceName, auditRef, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testGetServiceIdentityList() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceListDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject("ServiceListDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceListDom1", "Service1", auditRef, false, null, service1);

        ServiceIdentity service2 = zmsTestInitializer.createServiceObject("ServiceListDom1",
                "Service2", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceListDom1", "Service2", auditRef, false, null, service2);

        ServiceIdentityList serviceList = zmsImpl.getServiceIdentityList(
                ctx, "ServiceListDom1", null, null);
        assertNotNull(serviceList);
        assertEquals(serviceList.getNames().size(), 2);

        assertTrue(serviceList.getNames().contains("Service1".toLowerCase()));
        assertTrue(serviceList.getNames().contains("Service2".toLowerCase()));

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceListDom1", auditRef, null);
    }

    @Test
    public void testGetServiceIdentityListParams() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(
                "ServiceListParamsDom1", "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject("ServiceListParamsDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceListParamsDom1", "Service1", auditRef, false, null, service1);

        ServiceIdentity service2 = zmsTestInitializer.createServiceObject("ServiceListParamsDom1",
                "Service2", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceListParamsDom1", "Service2", auditRef, false, null, service2);

        ServiceIdentityList serviceList = zmsImpl.getServiceIdentityList(
                ctx, "ServiceListParamsDom1", 1, null);
        assertNotNull(serviceList);
        assertEquals(serviceList.getNames().size(), 1);

        serviceList = zmsImpl.getServiceIdentityList(ctx, "ServiceListParamsDom1", null,
                "Service1");
        assertNotNull(serviceList);
        assertEquals(serviceList.getNames().size(), 1);

        assertFalse(serviceList.getNames().contains("Service1".toLowerCase()));
        assertTrue(serviceList.getNames().contains("Service2".toLowerCase()));

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceListParamsDom1", auditRef, null);
    }

    @Test
    public void testGetServiceIdentityListThrowException() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        String domainName = "WrongDomainName";
        try {
            zmsImpl.getServiceIdentityList(ctx, domainName, null, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testGetEntity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-entity-dom1";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Entity entity1 = zmsTestInitializer.createEntityObject(domainName, "Entity1");
        zmsImpl.putEntity(ctx, domainName, "Entity1", auditRef, entity1);

        Entity entity2 = zmsImpl.getEntity(ctx, domainName, "Entity1");
        assertNotNull(entity2);

        assertEquals(entity2.getName(), "get-entity-dom1:entity.entity1");
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetEntityThrowException() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getEntity(ctx, "wrongDomainName", "wrongEntityName");
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testCreateEntity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "create-entity-dom1";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Entity entity1 = zmsTestInitializer.createEntityObject(domainName, "Entity1");
        zmsImpl.putEntity(ctx, domainName, "Entity1", auditRef, entity1);

        Entity entity2 = zmsImpl.getEntity(ctx, domainName, "Entity1");
        assertNotNull(entity2);
        assertEquals(entity2.getName(), "create-entity-dom1:entity.entity1");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testListEntity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "list-entity-dom1";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        EntityList entityList = zmsImpl.getEntityList(ctx, domainName);
        assertNotNull(entityList);
        assertEquals(0, entityList.getNames().size());

        Entity entity1 = zmsTestInitializer.createEntityObject(domainName, "Entity1");
        zmsImpl.putEntity(ctx, domainName, "Entity1", auditRef, entity1);

        entityList = zmsImpl.getEntityList(ctx, domainName);
        assertNotNull(entityList);
        assertEquals(1, entityList.getNames().size());
        assertTrue(entityList.getNames().contains("entity1"));

        Entity entity2 = zmsTestInitializer.createEntityObject(domainName, "Entity2");
        zmsImpl.putEntity(ctx, domainName, "Entity2", auditRef, entity2);

        entityList = zmsImpl.getEntityList(ctx, domainName);
        assertNotNull(entityList);
        assertEquals(2, entityList.getNames().size());
        assertTrue(entityList.getNames().contains("entity1"));
        assertTrue(entityList.getNames().contains("entity2"));

        zmsImpl.deleteEntity(ctx, domainName, "entity1", auditRef);

        entityList = zmsImpl.getEntityList(ctx, domainName);
        assertNotNull(entityList);
        assertEquals(1, entityList.getNames().size());
        assertTrue(entityList.getNames().contains("entity2"));

        zmsImpl.deleteEntity(ctx, domainName, "entity2", auditRef);

        entityList = zmsImpl.getEntityList(ctx, domainName);
        assertNotNull(entityList);
        assertEquals(0, entityList.getNames().size());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreateEntityMissingAuditRef() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "testCreateEntityMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Entity entity = zmsTestInitializer.createEntityObject(domainName, "Entity1");
        try {
            zmsImpl.putEntity(ctx, domainName, "Entity1", null, entity);
            fail("requesterror not thrown by putEntity.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        }
    }

    @Test
    public void testDeleteEntity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "del-entity-dom1";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Entity entity1 = zmsTestInitializer.createEntityObject(domainName, "Entity1");
        zmsImpl.putEntity(ctx, domainName, "Entity1", auditRef, entity1);

        Entity entity2 = zmsTestInitializer.createEntityObject(domainName, "Entity2");
        zmsImpl.putEntity(ctx, domainName, "Entity2", auditRef, entity2);

        Entity entityRes = zmsImpl.getEntity(ctx, domainName, "Entity1");
        assertNotNull(entityRes);

        entityRes = zmsImpl.getEntity(ctx, domainName, "Entity2");
        assertNotNull(entityRes);

        zmsImpl.deleteEntity(ctx, domainName, "Entity1", auditRef);

        try {
            zmsImpl.getEntity(ctx, domainName, "Entity1");
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        entityRes = zmsImpl.getEntity(ctx, domainName, "Entity2");
        assertNotNull(entityRes);

        zmsImpl.deleteEntity(ctx, domainName, "Entity2", auditRef);

        try {
            zmsImpl.getEntity(ctx, domainName, "Entity1");
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        try {
            zmsImpl.getEntity(ctx, domainName, "Entity2");
            fail();
        } catch (Exception ex) {
            assertTrue(true);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteEntityMissingAuditRef() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "testDeleteEntityMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Entity entity = zmsTestInitializer.createEntityObject(domainName, "Entity1");
        zmsImpl.putEntity(ctx, domainName, "Entity1", auditRef, entity);

        try {
            zmsImpl.deleteEntity(ctx, domainName, "Entity1", null);
            fail("requesterror not thrown by deleteEntity.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        }
    }

    @Test
    public void testGetUserToken() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // Use real Principal Authority to verify signatures
        PrincipalAuthority principalAuthority = new com.yahoo.athenz.auth.impl.PrincipalAuthority();
        principalAuthority.setKeyStore(zmsImpl);

        Authority userAuthority = new com.yahoo.athenz.common.server.debug.DebugUserAuthority();

        String userId = "george";
        Principal principal = SimplePrincipal.create("user", userId, userId + ":password",
                0, userAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(userId);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey())), "0");
        zmsTestInitializer.loadServerPublicKeys(zmsImpl);

        UserToken token = zmsImpl.getUserToken(rsrcCtx1, userId, null, null);
        assertNotNull(token);
        assertTrue(token.getToken().startsWith("v=U1;d=user;n=" + userId + ";"));
        assertTrue(token.getToken().contains(";h=localhost"));
        assertTrue(token.getToken().contains(";i=10.11.12.13"));
        assertTrue(token.getToken().contains(";k=0"));
        // Verify signature
        Principal principalToVerify = principalAuthority.authenticate(token.getToken(), "10.11.12.13", "GET", null);
        assertNotNull(principalToVerify);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKeyK1())), "1");

        token = zmsImpl.getUserToken(rsrcCtx1, userId, null, false);
        assertNotNull(token);
        assertTrue(token.getToken().contains("k=1"));
        // Verify signature
        principalToVerify = principalAuthority.authenticate(token.getToken(), "10.11.12.13", "GET", null);
        assertNotNull(principalToVerify);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKeyK2())), "2");

        token = zmsImpl.getUserToken(rsrcCtx1, userId, null, null);
        assertNotNull(token);
        assertTrue(token.getToken().contains("k=2"));
        // Verify signature
        principalToVerify = principalAuthority.authenticate(token.getToken(), "10.11.12.13", "GET", null);
        assertNotNull(principalToVerify);
    }

    @Test
    public void testGetUserTokenAuthorizedService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Authority userAuthority = new com.yahoo.athenz.common.server.debug.DebugUserAuthority();

        String userId = "george";
        Principal principal = SimplePrincipal.create("user", userId, userId + ":password",
                0, userAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(userId);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey())), "0");

        UserToken token = zmsImpl.getUserToken(rsrcCtx1, userId, "coretech.storage", null);
        assertNotNull(token);
        assertTrue(token.getToken().contains(";b=coretech.storage;"));

        token = zmsImpl.getUserToken(rsrcCtx1, userId, "coretech.storage,sports.hockey", false);
        assertNotNull(token);
        assertTrue(token.getToken().contains(";b=coretech.storage,sports.hockey;"));
    }

    @Test
    public void testGetUserTokenInvalidAuthorizedService() {

        Authority userAuthority = new com.yahoo.athenz.common.server.debug.DebugUserAuthority();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        String userId = "george";
        Principal principal = SimplePrincipal.create("user", userId, userId + ":password",
                0, userAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(userId);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);

        try {
            zmsImpl.getUserToken(rsrcCtx1, userId, "coretech.storage,sports", null);
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 401);
            assertTrue(ex.getMessage().contains("getUserToken: Service sports is not authorized in ZMS"));
        }

        try {
            zmsImpl.getUserToken(rsrcCtx1, userId, "baseball", false);
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 401);
            assertTrue(ex.getMessage().contains("getUserToken: Service baseball is not authorized in ZMS"));
        }

        try {
            zmsImpl.getUserToken(rsrcCtx1, userId, "hat trick", false);
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 401);
            assertTrue(ex.getMessage().contains("getUserToken: Service hat trick is not authorized in ZMS"));
        }
    }

    @Test
    public void testGetUserTokenExpiredIssueTime() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // Use real Principal Authority to verify signatures
        PrincipalAuthority principalAuthority = new com.yahoo.athenz.auth.impl.PrincipalAuthority();
        principalAuthority.setKeyStore(zmsImpl);

        // we're going to set the issue time 2 hours before the current time

        long issueTime = (System.currentTimeMillis() / 1000) - 7200;

        Authority userAuthority = new com.yahoo.athenz.common.server.debug.DebugUserAuthority();

        String userId = "george";
        Principal principal = SimplePrincipal.create("user", userId, userId + ":password",
                0, userAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(userId);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey())), "0");
        zmsTestInitializer.loadServerPublicKeys(zmsImpl);

        UserToken token = zmsImpl.getUserToken(rsrcCtx1, userId, null, null);
        assertNotNull(token);
        // Verify signature
        Principal principalToVerify = principalAuthority.authenticate(token.getToken(), "10.11.12.13", "GET", null);
        assertNotNull(principalToVerify);

        // verify that the issue time for the user token is not our issue time

        PrincipalToken pToken = new PrincipalToken(token.getToken());
        assertNotEquals(pToken.getTimestamp(), issueTime);

        // verify that our expiry is close to 1 hour default value

        assertTrue(pToken.getExpiryTime() - (System.currentTimeMillis() / 1000) > 3500);
    }

    @Test
    public void testGetUserTokenMismatchName() {

        int code = 401;

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Authority userAuthority = new com.yahoo.athenz.common.server.debug.DebugUserAuthority();

        String userId = "user1";
        Principal principal = SimplePrincipal.create("user", userId, userId + ":password",
                0, userAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(userId);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);

        try {
            zmsImpl.getUserToken(rsrcCtx1, "user2", null, null);
            fail("unauthorizederror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), code);
        }

        try {
            zmsImpl.getUserToken(rsrcCtx1, "_self", null, false);
            fail("unauthorizederror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), code);
        }

        try {
            zmsImpl.getUserToken(rsrcCtx1, "self", null, false);
            fail("unauthorizederror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), code);
        }
    }

    @Test
    public void testGetUserTokenDefaultSelfName() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // Use real Principal Authority to verify signatures
        PrincipalAuthority principalAuthority = new com.yahoo.athenz.auth.impl.PrincipalAuthority();
        principalAuthority.setKeyStore(zmsImpl);

        Authority userAuthority = new com.yahoo.athenz.common.server.debug.DebugUserAuthority();

        String userId = "user10";
        Principal principal = SimplePrincipal.create("user", userId, userId + ":password",
                0, userAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(userId);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey())), "0");
        zmsTestInitializer.loadServerPublicKeys(zmsImpl);

        UserToken token = zmsImpl.getUserToken(rsrcCtx1, "_self_", null, false);
        assertNotNull(token);
        assertTrue(token.getToken().startsWith("v=U1;d=user;n=" + userId + ";"));
        assertTrue(token.getToken().contains(";h=localhost"));
        assertTrue(token.getToken().contains(";i=10.11.12.13"));
        assertTrue(token.getToken().contains(";k=0"));
        // Verify signature
        Principal principalToVerify = principalAuthority.authenticate(token.getToken(), "10.11.12.13", "GET", null);
        assertNotNull(principalToVerify);
    }

    @Test
    public void testGetUserTokenBadAuthority() {

        int code = 401;

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature",
                0, principalAuthority);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);

        try {
            zmsImpl.getUserToken(rsrcCtx1, "user1", null, null);
            fail("unauthorizederror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), code);
        }
    }

    @Test
    public void testGetUserTokenNullAuthority() {
        int code = 401;

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Principal principal = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature");
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);

        try {
            zmsImpl.getUserToken(rsrcCtx1, "user1", null, null);
            fail("unauthorizederror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), code);
        }
    }

    @Test
    public void testGetTenantResourceGroupRoles() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testGetTenantResourceGroupRoles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        String tenantDomain = "tenantTestDeleteTenantRoles";
        TopLevelDomain tenantDom = zmsTestInitializer.createTopLevelDomainObject(
                tenantDomain, "Tenant Domain", "testOrg", zmsTestInitializer.getAdminUser());
        tenantDom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, tenantDom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String serviceName  = "storage";
        String resourceGroup = "Group1";

        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles().setDomain(domain)
                .setService(serviceName).setTenant(tenantDomain)
                .setRoles(roleActions).setResourceGroup(resourceGroup);
        zmsImpl.putTenantResourceGroupRoles(ctx, domain, serviceName, tenantDomain, resourceGroup,
                auditRef, tenantRoles);

        TenantResourceGroupRoles tRoles = zmsImpl.getTenantResourceGroupRoles(ctx, domain, serviceName,
                tenantDomain, resourceGroup);
        assertNotNull(tRoles);
        assertEquals(domain.toLowerCase(), tRoles.getDomain());
        assertEquals(serviceName.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        // Verify domain dependency wasn't created as the provider isn't listed in the "sys.auth:role.service_providers role

        try {
            zmsImpl.getDependentDomainList(ctx, domain + "." + serviceName);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"testgettenantresourcegrouproles.storage is not a registered service provider\"}");
        }

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
    }

    @Test
    public void testGetTenantResourceGroupRolesDomainDependency() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testGetTenantResourceGroupRolesDomainDependency";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        String tenantDomain = "tenantTestGetTenantResourceGroupRolesDomainDependency";
        TopLevelDomain tenantDom = zmsTestInitializer.createTopLevelDomainObject(
                tenantDomain, "Tenant Domain", "testOrg", zmsTestInitializer.getAdminUser());
        tenantDom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, tenantDom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String serviceName  = "storage";
        String resourceGroup = "Group1";

        ServiceIdentity serviceProviderIdentity = zmsTestInitializer.createServiceObject(domain,
                serviceName, "http://localhost/service-provider", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, domain, serviceName, auditRef, false, null, serviceProviderIdentity);

        zmsTestInitializer.makeServiceProviders(zmsImpl, ctx, Collections.singletonList(domain + "." + serviceName),
                fetchDomainDependencyFrequency);
        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles().setDomain(domain)
                .setService(serviceName).setTenant(tenantDomain)
                .setRoles(roleActions).setResourceGroup(resourceGroup);
        RsrcCtxWrapper serviceProviderCtx = zmsTestInitializer.contextWithMockPrincipal("putTenantResourceGroupRoles", domain, serviceName);
        zmsImpl.putTenantResourceGroupRoles(serviceProviderCtx, domain, serviceName, tenantDomain, resourceGroup,
                auditRef, tenantRoles);

        TenantResourceGroupRoles tRoles = zmsImpl.getTenantResourceGroupRoles(ctx, domain, serviceName,
                tenantDomain, resourceGroup);
        assertNotNull(tRoles);
        assertEquals(domain.toLowerCase(), tRoles.getDomain());
        assertEquals(serviceName.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        // Verify dependency

        DomainList dependentDomainList = zmsImpl.getDependentDomainList(ctx, domain + "." + serviceName);
        assertEquals(dependentDomainList.getNames().size(), 1);
        assertEquals(dependentDomainList.getNames().get(0), tenantDomain.toLowerCase());

        // Now add another resource group

        String resourceGroup2 = "Group2";
        tenantRoles = new TenantResourceGroupRoles().setDomain(domain)
                .setService(serviceName).setTenant(tenantDomain)
                .setRoles(roleActions).setResourceGroup(resourceGroup2);
        zmsImpl.putTenantResourceGroupRoles(serviceProviderCtx, domain, serviceName, tenantDomain, resourceGroup2,
                auditRef, tenantRoles);

        tRoles = zmsImpl.getTenantResourceGroupRoles(ctx, domain, serviceName,
                tenantDomain, resourceGroup2);
        assertNotNull(tRoles);
        assertEquals(domain.toLowerCase(), tRoles.getDomain());
        assertEquals(serviceName.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup2.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        DependentServiceResourceGroupList dependentServiceResourceGroupList = zmsImpl.getDependentServiceResourceGroupList(ctx, tenantDomain);
        assertEquals(dependentServiceResourceGroupList.getServiceAndResourceGroups().size(), 1);
        assertEquals(dependentServiceResourceGroupList.getServiceAndResourceGroups().get(0).getService(), "testgettenantresourcegrouprolesdomaindependency.storage");
        assertEquals(dependentServiceResourceGroupList.getServiceAndResourceGroups().get(0).getDomain(), "tenanttestgettenantresourcegrouprolesdomaindependency");
        List<String> resourceGroups = dependentServiceResourceGroupList.getServiceAndResourceGroups().get(0).getResourceGroups();
        assertEquals(resourceGroups.size(), 6);
        assertTrue(resourceGroups.contains("storage.tenant.tenanttestgettenantresourcegrouprolesdomaindependency.res_group.group1.admin"));
        assertTrue(resourceGroups.contains("storage.tenant.tenanttestgettenantresourcegrouprolesdomaindependency.res_group.group1.reader"));
        assertTrue(resourceGroups.contains("storage.tenant.tenanttestgettenantresourcegrouprolesdomaindependency.res_group.group1.writer"));
        assertTrue(resourceGroups.contains("storage.tenant.tenanttestgettenantresourcegrouprolesdomaindependency.res_group.group2.admin"));
        assertTrue(resourceGroups.contains("storage.tenant.tenanttestgettenantresourcegrouprolesdomaindependency.res_group.group2.reader"));
        assertTrue(resourceGroups.contains("storage.tenant.tenanttestgettenantresourcegrouprolesdomaindependency.res_group.group2.writer"));

        // Now remove the first resource group and verify dependency remains until the second resource group and admin role is removed

        zmsImpl.deleteTenantResourceGroupRoles(serviceProviderCtx, domain, serviceName, tenantDomain, resourceGroup, auditRef);
        dependentDomainList = zmsImpl.getDependentDomainList(ctx, domain + "." + serviceName);
        assertEquals(dependentDomainList.getNames().size(), 1);
        assertEquals(dependentDomainList.getNames().get(0), tenantDomain.toLowerCase());

        // Now delete the second resource group and verify dependency was removed

        zmsImpl.deleteTenantResourceGroupRoles(serviceProviderCtx, domain, serviceName, tenantDomain, resourceGroup2, auditRef);
        dependentDomainList = zmsImpl.getDependentDomainList(ctx, domain + "." + serviceName);
        assertEquals(dependentDomainList.getNames().size(), 0);

        // Finally, remove all resource groups related to the tenant domain (which will remove the admin role)

        ServiceIdentity serviceProvider = zmsTestInitializer.createServiceObject(domain,
                serviceName, "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, domain, serviceName, auditRef, false, null, serviceProvider);

        zmsImpl.deleteTenant(serviceProviderCtx, domain, serviceName, tenantDomain, auditRef);
        dependentDomainList = zmsImpl.getDependentDomainList(ctx, domain + "." + serviceName);
        assertEquals(dependentDomainList.getNames().size(), 0);

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
    }

    @Test
    public void testGetTenantResourceGroupRolesInvalidDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getTenantResourceGroupRoles(ctx, "invalid-domain", "api",
                    "tenant", "table1");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }
    }

    @Test
    public void testDeleteTenantResourceGroupRoles() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testDeleteTenantResourceGroupRoles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        String tenantDomain = "tenantTestDeleteTenantRoles";
        TopLevelDomain tenantDom = zmsTestInitializer.createTopLevelDomainObject(
                tenantDomain, "Tenant Domain", "testOrg", zmsTestInitializer.getAdminUser());
        tenantDom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, tenantDom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String serviceName  = "storage";
        String resourceGroup = "Group1";

        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles().setDomain(domain)
                .setService(serviceName).setTenant(tenantDomain)
                .setRoles(roleActions).setResourceGroup(resourceGroup);
        zmsImpl.putTenantResourceGroupRoles(ctx, domain, serviceName, tenantDomain, resourceGroup,
                auditRef, tenantRoles);

        TenantResourceGroupRoles tRoles = zmsImpl.getTenantResourceGroupRoles(ctx, domain, serviceName,
                tenantDomain, resourceGroup);
        assertNotNull(tRoles);

        // Delete the tenant domain. Then make sure we can still delete resource groups in provider

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);

        zmsImpl.deleteTenantResourceGroupRoles(ctx, domain, serviceName, tenantDomain, resourceGroup, auditRef);

        tRoles = zmsImpl.getTenantResourceGroupRoles(ctx, domain, serviceName, tenantDomain, resourceGroup);
        assertNotNull(tRoles);
        assertEquals(domain.toLowerCase(), tRoles.getDomain());
        assertEquals(serviceName.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(0, tRoles.getRoles().size());

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
    }

    @Test
    public void testValidatedAdminUsersThrowException() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        try {
            zmsImpl.validatedAdminUsers(null);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }
    }

    @Test
    public void testPutDefaultAdminsInvalidDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        DefaultAdmins admins = new DefaultAdmins();

        try {
            zmsImpl.putDefaultAdmins(ctx, "sports", auditRef, admins);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }
    }

    @Test
    public void testPutDefaultAdmins() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain sportsDomain = zmsTestInitializer.createTopLevelDomainObject("sports",
                "Test domain for sports", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
        } catch (ResourceException ignored) {
        }
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, sportsDomain);

        List<String> adminList = new ArrayList<>();
        DefaultAdmins admins = new DefaultAdmins();

        // negative test, pass an empty list
        admins.setAdmins(adminList);
        zmsImpl.putDefaultAdmins(ctx, "sports", auditRef, admins);

        Role role = zmsImpl.getRole(ctx, "sports", "admin", false, false, false);
        assertNotNull(role);
        assertEquals(role.getName(), "sports:role.admin");
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);
        assertEquals(members.get(0).getMemberName(), zmsTestInitializer.getAdminUser());

        // positive test
        adminList.add("user.sports_admin");
        adminList.add("sports.fantasy");
        adminList.add("user.joeschmoe");
        adminList.add("user.johndoe");

        admins.setAdmins(adminList);
        zmsImpl.putDefaultAdmins(ctx, "sports", auditRef, admins);

        role = zmsImpl.getRole(ctx, "sports", "admin", false, false, false);
        assertNotNull(role);
        assertEquals(role.getName(), "sports:role.admin");
        members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 5);

        // add user.testadminuser to the list for verification since it should be
        // there when the domain was added
        adminList.add(zmsTestInitializer.getAdminUser());
        for (String admin : adminList) {
            boolean found = false;
            for (RoleMember memberFromRole : members) {
                if (memberFromRole.getMemberName().equalsIgnoreCase(admin)) {
                    found = true;
                    break;
                }
            }
            assertTrue(found);
        }

        zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
    }

    @Test
    public void testPutDefaultAdminsMissingAuditRef() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testPutDefaultAdminsMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        List<String> adminList = new ArrayList<>();
        adminList.add("user.sports_admin");
        adminList.add("sports.fantasy");
        DefaultAdmins admins = new DefaultAdmins();
        admins.setAdmins(adminList);
        try {
            zmsImpl.putDefaultAdmins(ctx, domain, null, admins);
            fail("requesterror not thrown by putDefaultAdmins.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testPutDefaultAdminsNoAdminRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain sportsDomain = zmsTestInitializer.createTopLevelDomainObject("sports",
                "Test domain for sports", "testOrg", zmsTestInitializer.getAdminUser());

        try {
            zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
        } catch (ResourceException ignored) {
        }
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, sportsDomain);

        // since we can't delete the admin role anymore
        // we're going to access the store object directly to
        // accomplish that for our unit test

        zmsImpl.dbService.executeDeleteRole(ctx, sportsDomain.getName(), "admin",
                auditRef, "unittest");

        List<String> adminList = new ArrayList<>();
        DefaultAdmins admins = new DefaultAdmins();
        adminList.add("user.sports_admin");
        adminList.add("sports.fantasy");
        adminList.add("user.joeschmoe");
        adminList.add("user.johndoe");
        adminList.add(zmsTestInitializer.getAdminUser());

        admins.setAdmins(adminList);
        zmsImpl.putDefaultAdmins(ctx, "sports", auditRef, admins);

        Role role = zmsImpl.getRole(ctx, "sports", "admin", false, false, false);
        assertNotNull(role);
        assertEquals(role.getName(), "sports:role.admin");
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 5);

        // add user.testadminuser to the list for verification since it should be
        // there when the domain was added
        adminList.add(zmsTestInitializer.getAdminUser());
        for (String admin : adminList) {
            boolean found = false;
            for (RoleMember memberFromRole : members) {
                if (memberFromRole.getMemberName().equalsIgnoreCase(admin)) {
                    found = true;
                    break;
                }
            }
            assertTrue(found);
        }

        zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
    }

    @Test
    public void testPutDefaultAdmins_NoAdminPolicy() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain sportsDomain = zmsTestInitializer.createTopLevelDomainObject("sports",
                "Test domain for sports", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
        } catch (ResourceException ignored) {
        }
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, sportsDomain);

        // since we can't delete the admin policy anymore
        // we're going to access the store object directly to
        // accomplish that for our unit test

        zmsImpl.dbService.executeDeletePolicy(ctx, sportsDomain.getName(), "admin",
                auditRef, "unittest");

        List<String> adminList = new ArrayList<>();
        DefaultAdmins admins = new DefaultAdmins();
        adminList.add("user.sports_admin");
        adminList.add("sports.fantasy");
        adminList.add("user.joeschmoe");
        adminList.add("user.johndoe");

        admins.setAdmins(adminList);
        zmsImpl.putDefaultAdmins(ctx, "sports", auditRef, admins);

        // Validate that admin policy has been added back
        Policy policy = zmsImpl.getPolicy(ctx, "sports", "admin");
        assertNotNull(policy);
        assertEquals(policy.getName(), "sports:policy.admin");
        List<Assertion> assertions = policy.getAssertions();
        boolean foundAssertion = false;
        for (Assertion assertion : assertions) {
            if ("sports:*".equals(assertion.getResource())
                    && "*".equals(assertion.getAction())
                    && "sports:role.admin".equals(assertion.getRole())) {
                foundAssertion = true;
                break;
            }
        }
        assertTrue(foundAssertion);

        Role role = zmsImpl.getRole(ctx, "sports", "admin", false, false, false);
        assertNotNull(role);
        assertEquals(role.getName(), "sports:role.admin");
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 5);

        for (String admin : adminList) {
            boolean found = false;
            for (RoleMember memberFromRole : members) {
                if (memberFromRole.getMemberName().equalsIgnoreCase(admin)) {
                    found = true;
                    break;
                }
            }
            assertTrue(found);
        }

        zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
    }

    @Test
    public void testPutDefaultAdmins_AdminPolicyWithDeny() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain sportsDomain = zmsTestInitializer.createTopLevelDomainObject("sports",
                "Test domain for sports", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
        } catch (ResourceException ignored) {
        }
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, sportsDomain);

        // Add policy which will DENY admin role
        Policy policy = new Policy();
        policy.setName(ResourceUtils.policyResourceName("sports", "denyAdmin"));
        Assertion assertion = new Assertion();
        assertion.setResource("sports:*");
        assertion.setAction("*");
        assertion.setRole("sports:role.admin");
        assertion.setEffect(AssertionEffect.DENY);
        List<Assertion> assertions = new ArrayList<>();
        assertions.add(assertion);
        policy.setAssertions(assertions);
        zmsImpl.putPolicy(ctx, "sports", "denyAdmin", auditRef, false, null, policy);

        List<String> adminList = new ArrayList<>();
        DefaultAdmins admins = new DefaultAdmins();
        adminList.add("user.sports_admin");
        adminList.add("sports.fantasy");
        adminList.add("user.joeschmoe");
        adminList.add("user.johndoe");

        admins.setAdmins(adminList);
        zmsImpl.putDefaultAdmins(ctx, "sports", auditRef, admins);

        // denyAdmin policy should be deleted by putDefaultAdmins validation
        try {
            policy = zmsImpl.getPolicy(ctx, "sports", "denyAdmin");
            assertNotNull(policy); // should not be found
        } catch (ResourceException ex) {
            // policy should not be found
            if (ex.getCode() != 404) {
                throw ex;
            }
        }

        Role role = zmsImpl.getRole(ctx, "sports", "admin", false, false, false);
        assertNotNull(role);
        assertEquals(role.getName(), "sports:role.admin");
        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 5);

        for (String admin : adminList) {
            boolean found = false;
            for (RoleMember memberFromRole : members) {
                if (memberFromRole.getMemberName().equalsIgnoreCase(admin)) {
                    found = true;
                    break;
                }
            }
            assertTrue(found);
        }

        zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
    }

    @Test
    public void testPutDefaultAdmins_DenyIndirectRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain sportsDomain = zmsTestInitializer.createTopLevelDomainObject("sports",
                "Test domain for sports", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
        } catch (ResourceException ignored) {
        }
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, sportsDomain);

        // Add role indirectRole
        Role role = new Role();
        role.setName("sports:role.indirectRole");
        List<RoleMember> members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.johnadams"));
        members.add(new RoleMember().setMemberName("user.sports_admin"));
        members.add(new RoleMember().setMemberName("sports.fantasy"));
        members.add(new RoleMember().setMemberName("user.joeschmoe"));
        members.add(new RoleMember().setMemberName("user.johndoe"));
        role.setRoleMembers(members);
        role.setTrust(null);
        zmsImpl.putRole(ctx, "sports", "indirectRole", auditRef, false, null, role);

        // Add policy which will DENY indirectRole role
        Policy policy = new Policy();
        policy.setName(ResourceUtils.policyResourceName("sports", "denyIndirectRole"));
        Assertion assertion = new Assertion();
        assertion.setResource("sports:*");
        assertion.setAction("*");
        assertion.setRole("sports:role.indirectRole");
        assertion.setEffect(AssertionEffect.DENY);
        List<Assertion> assertions = new ArrayList<>();
        assertions.add(assertion);
        policy.setAssertions(assertions);
        zmsImpl.putPolicy(ctx, "sports", "denyIndirectRole", auditRef, false, null, policy);

        List<String> adminList = new ArrayList<>();
        DefaultAdmins admins = new DefaultAdmins();
        adminList.add("user.sports_admin");
        adminList.add("sports.fantasy");
        adminList.add("user.joeschmoe");
        adminList.add("user.johndoe");

        admins.setAdmins(adminList);
        zmsImpl.putDefaultAdmins(ctx, "sports", auditRef, admins);

        role = zmsImpl.getRole(ctx, "sports", "indirectRole", false, false, false);
        assertNotNull(role);
        assertEquals(role.getName(), "sports:role.indirectRole".toLowerCase());
        members = role.getRoleMembers();
        assertEquals(members.size(), 1);

        for (String admin : adminList) {
            boolean found = false;
            for (RoleMember memberFromRole : members) {
                if (memberFromRole.getMemberName().equalsIgnoreCase(admin)) {
                    found = true;
                    break;
                }
            }
            assertFalse(found);
        }

        role = zmsImpl.getRole(ctx, "sports", "admin", false, false, false);
        assertNotNull(role);
        assertEquals(role.getName(), "sports:role.admin");
        members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 5);

        for (String admin : adminList) {
            boolean found = false;
            for (RoleMember memberFromRole : members) {
                if (memberFromRole.getMemberName().equalsIgnoreCase(admin)) {
                    found = true;
                    break;
                }
            }
            assertTrue(found);
        }

        zmsImpl.deleteTopLevelDomain(ctx, sportsDomain.getName(), auditRef, null);
    }

    @Test
    public void testGetSignedDomains() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.loadServerPublicKeys(zmsImpl);

        // create multiple top level domains
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("SignedDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject("signeddom1", "group1", "user.user1", "user.user2");
        zmsImpl.putGroup(ctx, "signeddom1", "group1", auditRef, false, null, group1);

        // set the meta attributes for domain

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain1", null, true, false, "12345", 0);
        zmsImpl.putDomainMeta(ctx, "signeddom1", auditRef, null, meta);
        meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain1", null, true, false, "12345", 0);
        zmsImpl.putDomainSystemMeta(ctx, "signeddom1", "account", auditRef, meta);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("SignedDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain2", null, false, false, "12346", null);
        zmsImpl.putDomainMeta(ctx, "signeddom2", auditRef, null, meta);
        meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain2", null, false, false, "12346", null);
        zmsImpl.putDomainSystemMeta(ctx, "signeddom2", "account", auditRef, meta);

        Role role = zmsTestInitializer.createRoleObject("signeddom1", "role1", null, "user.john", "user.jane");
        Policy pol = zmsTestInitializer.createPolicyObject("signeddom1", "pol1", "role1", "action1", "signeddom1:resource1", AssertionEffect.ALLOW);
        zmsImpl.putRole(ctx, "signeddom1", "role1", auditRef, false, null, role);
        zmsImpl.putPolicy(ctx, "signeddom1", "pol1", auditRef, false, null, pol);

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, null, null, null, null, null, null, null);
        List<String> domNames = domList.getNames();
        int numDoms = domNames.size();

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey())), "0");

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal sysPrincipal = principalAuthority.authenticate("v=U1;d=sys;n=zts;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(sysPrincipal);

        Response response = zmsImpl.getSignedDomains(rsrcCtx, null, null, null, null, false, null);
        SignedDomains sdoms = (SignedDomains) response.getEntity();

        assertNotNull(sdoms);
        List<SignedDomain> list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), numDoms);

        boolean dom1Found = false;
        boolean dom2Found = false;
        for (SignedDomain sDomain : list) {
            String signature = sDomain.getSignature();
            String keyId = sDomain.getKeyId();
            String publicKey = zmsImpl.getPublicKey("sys.auth", "zms", keyId);
            DomainData domainData = sDomain.getDomain();
            if (domainData.getName().equals("signeddom1")) {
                assertEquals("12345", domainData.getAccount());
                dom1Found = true;
            } else if (domainData.getName().equals("signeddom2")) {
                assertEquals("12346", domainData.getAccount());
                dom2Found = true;
            }
            assertTrue(Crypto.verify(SignUtils.asCanonicalString(sDomain.getDomain()),
                    Crypto.loadPublicKey(publicKey), signature));
        }
        assertTrue(dom1Found);
        assertTrue(dom2Found);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(
                Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKeyK1())), "1");

        response = zmsImpl.getSignedDomains(rsrcCtx, null, null, "all", null, false, null);
        sdoms = (SignedDomains) response.getEntity();

        assertNotNull(sdoms);
        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), numDoms);

        for(SignedDomain sDomain : list) {
            String signature = sDomain.getSignature();
            String keyId = sDomain.getKeyId();
            String publicKey = zmsImpl.getPublicKey("sys.auth", "zms", keyId);
            assertTrue(Crypto.verify(SignUtils.asCanonicalString(sDomain.getDomain()),
                    Crypto.loadPublicKey(publicKey), signature));

            // we now need to verify the policy struct signature as well

            SignedPolicies signedPolicies = sDomain.getDomain().getPolicies();
            signature = signedPolicies.getSignature();
            assertTrue(Crypto.verify(SignUtils.asCanonicalString(signedPolicies.getContents()),
                    Crypto.loadPublicKey(publicKey), signature));
        }

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(
                Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKeyK2())), "2");

        response = zmsImpl.getSignedDomains(rsrcCtx, null, null, null, Boolean.TRUE, false, null);
        sdoms = (SignedDomains) response.getEntity();
        assertNotNull(sdoms);

        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), numDoms);

        for(SignedDomain sDomain : list) {
            String signature = sDomain.getSignature();
            String keyId = sDomain.getKeyId();
            String publicKey = zmsImpl.getPublicKey("sys.auth", "zms", keyId);
            assertTrue(Crypto.verify(SignUtils.asCanonicalString(sDomain.getDomain()),
                    Crypto.loadPublicKey(publicKey), signature));
        }

        // test metaonly=true
        //
        response = zmsImpl.getSignedDomains(rsrcCtx, null, "tRuE", null, Boolean.FALSE, false, null);
        sdoms = (SignedDomains) response.getEntity();
        assertNotNull(sdoms);

        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), numDoms);

        for (SignedDomain sDomain : list) {
            String signature = sDomain.getSignature();
            assertTrue(signature == null || signature.isEmpty());
            String keyId = sDomain.getKeyId();
            assertTrue(keyId == null || keyId.isEmpty());
            DomainData ddata = sDomain.getDomain();
            assertNotNull(ddata);
            assertFalse(ddata.getName().isEmpty());
            assertNotNull(ddata.getModified());
            assertNull(ddata.getPolicies());
            assertNull(ddata.getRoles());
            assertNull(ddata.getServices());
        }

        // test metaonly=garbage
        //
        response = zmsImpl.getSignedDomains(rsrcCtx, null, "garbage", null, null, false, null);
        sdoms = (SignedDomains) response.getEntity();
        assertNotNull(sdoms);

        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), numDoms);

        for (SignedDomain sDomain : list) {
            String signature = sDomain.getSignature();
            String keyId = sDomain.getKeyId();
            String publicKey = zmsImpl.getPublicKey("sys.auth", "zms", keyId);
            assertTrue(Crypto.verify(SignUtils.asCanonicalString(sDomain.getDomain()),
                    Crypto.loadPublicKey(publicKey), signature));
            DomainData ddata = sDomain.getDomain();
            assertNotNull(ddata.getPolicies());
            assertTrue(ddata.getRoles() != null && !ddata.getRoles().isEmpty());
            assertNotNull(ddata.getServices());
        }

        // test metaonly=false
        //
        response = zmsImpl.getSignedDomains(rsrcCtx, null, "fAlSe", null, null, false,null);
        sdoms = (SignedDomains) response.getEntity();
        assertNotNull(sdoms);

        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), numDoms);

        for (SignedDomain sDomain : list) {
            String signature = sDomain.getSignature();
            String keyId = sDomain.getKeyId();
            String publicKey = zmsImpl.getPublicKey("sys.auth", "zms", keyId);
            assertTrue(Crypto.verify(SignUtils.asCanonicalString(sDomain.getDomain()),
                    Crypto.loadPublicKey(publicKey), signature));
            DomainData ddata = sDomain.getDomain();
            assertNotNull(ddata.getPolicies());
            assertTrue(ddata.getRoles() != null && !ddata.getRoles().isEmpty());
            assertNotNull(ddata.getServices());
        }

        // test bad tag format
        //
        String eTag  = "I am not good";
        response = zmsImpl.getSignedDomains(rsrcCtx, null, null, null, Boolean.TRUE, false, eTag);
        sdoms = (SignedDomains) response.getEntity();
        String eTag2 = response.getHeaderString("ETag");
        assertNotNull(eTag2);
        assertNotEquals(eTag, eTag2);
        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), numDoms);

        ZMSUtils.threadSleep(1000);

        Policy policy1 = zmsTestInitializer.createPolicyObject("SignedDom1", "Policy1");
        zmsImpl.putPolicy(ctx, "SignedDom1", "Policy1", auditRef, false, null, policy1);

        response = zmsImpl.getSignedDomains(rsrcCtx, null, null, null, true, false, eTag2);
        sdoms = (SignedDomains) response.getEntity();
        eTag = response.getHeaderString("ETag");
        assertNotNull(eTag);
        assertNotEquals(eTag, eTag2);
        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(1, list.size());

        response = zmsImpl.getSignedDomains(rsrcCtx, null, null, null, Boolean.TRUE, false, eTag);
        assertEquals(304, response.getStatus());
        eTag2 = response.getHeaderString("ETag");

        assertNotNull(eTag2);
        assertEquals(eTag, eTag2);

        //test with conditions
        Policy policyResp = zmsImpl.getPolicy(ctx, "signeddom1", "pol1");
        AssertionConditions acs = new AssertionConditions().setConditionsList(new ArrayList<>());
        acs.getConditionsList().add(createAssertionConditionObject(1, "instances", "host1,host2,host3"));
        zmsImpl.putAssertionConditions(ctx, "signeddom1", "pol1", policyResp.getAssertions().get(0).getId(), auditRef, null, acs);

        response = zmsImpl.getSignedDomains(rsrcCtx, null, "false", null, true, true,null);
        sdoms = (SignedDomains) response.getEntity();
        assertNotNull(sdoms);

        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), numDoms);
        AssertionCondition conditionResp = createAssertionConditionObject(1, "instances", "host1,host2,host3");

        AssertionConditions conditionsResp;
        for (SignedDomain sDomain : list) {
            if ("signeddom1".equals(sDomain.getDomain().getName())) {
                DomainPolicies dompols = sDomain.getDomain().getPolicies().getContents();
                assertNotNull(dompols);
                for (Policy polResp : dompols.getPolicies()) {
                    if (("signeddom1:policy.pol1").equals(polResp.getName())) {
                        conditionsResp = polResp.getAssertions().get(0).getConditions();
                        assertNotNull(conditionsResp);
                        assertThat(conditionsResp.getConditionsList(), CoreMatchers.hasItems(conditionResp));
                    }
                }

            }
        }
        zmsImpl.deleteTopLevelDomain(ctx, "SignedDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "SignedDom2", auditRef, null);
    }

    private void addEntryToConditionMap(Map<String, AssertionConditionData> map, String key, String value) {
        AssertionConditionData cd = new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue(value);
        map.put(key, cd);
    }

    private AssertionCondition createAssertionConditionObject(int conditionId, String key, String value) {
        Map<String, AssertionConditionData> map = new HashMap<>();
        AssertionConditionData cd = new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS).setValue(value);
        map.put(key, cd);
        return new AssertionCondition().setId(conditionId).setConditionsMap(map);
    }

    @Test
    public void testGetSignedDomainsFiltered() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.loadServerPublicKeys(zmsImpl);

        // create multiple top level domains
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("signeddom1filtered",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("signeddom2filtered",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey())), "0");

        Response response = zmsImpl.getSignedDomains(ctx, "signeddom1filtered", null, null, null, false,  null);
        SignedDomains sdoms = (SignedDomains) response.getEntity();

        assertNotNull(sdoms);
        List<SignedDomain> list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(1, list.size());

        SignedDomain sDomain = list.get(0);
        String signature = sDomain.getSignature();
        String keyId = sDomain.getKeyId();
        String publicKey = zmsImpl.getPublicKey("sys.auth", "zms", keyId);
        assertTrue(Crypto.verify(SignUtils.asCanonicalString(sDomain.getDomain()), Crypto.loadPublicKey(publicKey), signature));
        assertEquals("signeddom1filtered", sDomain.getDomain().getName());

        // use domain=signeddom1filtered and metaonly=true
        //

        response = zmsImpl.getSignedDomains(ctx, "signeddom1filtered", "true", null, Boolean.TRUE, false, null);
        sdoms = (SignedDomains) response.getEntity();

        assertNotNull(sdoms);
        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(1, list.size());

        sDomain = list.get(0);
        signature = sDomain.getSignature();
        assertTrue(signature == null || signature.isEmpty());
        keyId = sDomain.getKeyId();
        assertTrue(keyId == null || keyId.isEmpty());
        DomainData ddata = sDomain.getDomain();
        assertEquals("signeddom1filtered", ddata.getName());
        assertNotNull(ddata.getModified());
        assertNull(ddata.getPolicies());
        assertNull(ddata.getRoles());
        assertNull(ddata.getServices());

        // no changes, we should still get the same data back
        // we're going to pass the domain name with caps and
        // make sure we still get back our domain

        response = zmsImpl.getSignedDomains(ctx, "SignedDom1Filtered", null, null, Boolean.TRUE, false, null);
        sdoms = (SignedDomains) response.getEntity();

        assertNotNull(sdoms);
        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(1, list.size());

        sDomain = list.get(0);
        signature = sDomain.getSignature();
        keyId = sDomain.getKeyId();
        publicKey = zmsImpl.getPublicKey("sys.auth", "zms", keyId);
        assertTrue(Crypto.verify(SignUtils.asCanonicalString(sDomain.getDomain()), Crypto.loadPublicKey(publicKey), signature));
        assertEquals("signeddom1filtered", sDomain.getDomain().getName());

        zmsImpl.deleteTopLevelDomain(ctx, "signeddom1filtered", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "signeddom2filtered", auditRef, null);
    }

    @Test
    public void testGetSignedDomainsNotSystemPrincipal() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // create multiple top level domains
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("SignedDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Response response = zmsImpl.getSignedDomains(ctx, null, null, null, Boolean.TRUE, false, null);
        assertEquals(response.getStatus(), ResourceException.BAD_REQUEST);

        zmsImpl.deleteTopLevelDomain(ctx, "SignedDom1", auditRef, null);
    }

    @Test
    public void testGetAccess() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AccessDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("AccessDom1", "Role1", null, "user.user1",
                "user.user3");
        zmsImpl.putRole(ctx, "AccessDom1", "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject("AccessDom1", "Role2", null, "user.user2",
                "user.user3");
        zmsImpl.putRole(ctx, "AccessDom1", "Role2", auditRef, false, null, role2);

        Policy policy1 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy1", "Role1",
                "UPDATE", "AccessDom1:resource1", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy2", "Role2",
                "CREATE", "AccessDom1:resource2", AssertionEffect.DENY);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy2", auditRef, false, null, policy2);

        Policy policy3 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy3", "Role2",
                "*", "AccessDom1:resource3", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy3", auditRef, false, null, policy3);

        Policy policy4 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy4", "Role2",
                "DELETE", "accessdom1:*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy4", auditRef, false, null, policy4);

        Policy policy5 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy5", "Role1",
                "READ", "accessdom1:*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy5", auditRef, false, null, policy5);

        Policy policy6 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy6", "Role1",
                "READ", "AccessDom1:resource6", AssertionEffect.DENY);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy6", auditRef, false, null, policy6);

        // user1 and user3 have access to UPDATE/resource1

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        Principal principal2 = principalAuthority.authenticate("v=U1;d=user;n=user2;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx2 = zmsTestInitializer.createResourceContext(principal2);
        Principal principal3 = principalAuthority.authenticate("v=U1;d=user;n=user3;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx3 = zmsTestInitializer.createResourceContext(principal3);

        Access access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UPDATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "UPDATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // same set as before with no trust domain field

        access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "AccessDom1:resource1",
                null, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UPDATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "UPDATE", "AccessDom1:resource1",
                null, null);
        assertTrue(access.getGranted());

        // all three have no access to CREATE action on resource1

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        // all three have no access to invalid domain name on resource 1

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource1",
                "AccessDom2", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource1",
                "AccessDom2", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource1",
                "AccessDom2", null);
        assertFalse(access.getGranted());

        // same as before with no trust domain field

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        // all three should have deny access to resource 2

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource2",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource2",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource2",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        // user2 and user3 have access to CREATE(*)/resource 3

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource3",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to UPDATE(*)/resource 3

        access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "AccessDom1:resource3",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UPDATE", "AccessDom1:resource3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "UPDATE", "AccessDom1:resource3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to DELETE/resource 4 (*)

        access = zmsImpl.getAccess(rsrcCtx1, "DELETE", "AccessDom1:resource4",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "DELETE", "AccessDom1:resource4",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "DELETE", "AccessDom1:resource4",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // user1 should be able to read resource 5(*) but not resource 6
        // (explicit DENY)

        access = zmsImpl.getAccess(rsrcCtx1, "READ", "AccessDom1:resource5",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "READ", "AccessDom1:resource6",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        // we should get an exception since access is not allowed to be called
        // with user cookie - this api is only for functions that require a
        // service or user tokens

        try {
            zmsImpl.access("READ", "AccessDom1:resource5", principal1, "AccessDom1");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "AccessDom1", auditRef, null);
    }

    @Test
    public void testGetAccessCaseSensitive() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AccessDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("AccessDom1", "Role1", null, "user.user1",
                "user.user3");
        zmsImpl.putRole(ctx, "AccessDom1", "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject("AccessDom1", "Role2", null, "user.user2",
                "user.user3");
        zmsImpl.putRole(ctx, "AccessDom1", "Role2", auditRef, false, null, role2);

        Policy policy1 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy1", "Role1",
                "UpdatE", "AccessDom1:ResourcE1", AssertionEffect.ALLOW);
        policy1.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy2", "Role2",
                "CreatE", "AccessDom1:ResourcE2", AssertionEffect.DENY);
        policy2.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy2", auditRef, false, null, policy2);

        Policy policy3 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy3", "Role2",
                "*", "AccessDom1:ResourcE3", AssertionEffect.ALLOW);
        policy3.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy3", auditRef, false, null, policy3);

        Policy policy4 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy4", "Role2",
                "DeletE", "AccessdoM1:*", AssertionEffect.ALLOW);
        policy4.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy4", auditRef, false, null, policy4);

        Policy policy5 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy5", "Role1",
                "ReaD", "AccessdoM1:*", AssertionEffect.ALLOW);
        policy5.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy5", auditRef, false, null, policy5);

        Policy policy6 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy6", "Role1",
                "ReaD", "AccessDom1:ResourcE6", AssertionEffect.DENY);
        policy6.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy6", auditRef, false, null, policy6);

        // user1 and user3 have access to UPDATE/resource1

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        Principal principal2 = principalAuthority.authenticate("v=U1;d=user;n=user2;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx2 = zmsTestInitializer.createResourceContext(principal2);
        Principal principal3 = principalAuthority.authenticate("v=U1;d=user;n=user3;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx3 = zmsTestInitializer.createResourceContext(principal3);

        Access access = zmsImpl.getAccess(rsrcCtx1, "uPDATe", "AcceSSDom1:rESOURCe1",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UpDaTe", "AccEssDom1:reSouRce1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "uPdate", "AccEssDom1:resOurce1",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // same set as before with no trust domain field

        access = zmsImpl.getAccess(rsrcCtx1, "UPDaTE", "ACcessDom1:reSource1",
                null, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UPDAtE", "AccEssDom1:resOUrce1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "uPDATE", "ACcessDom1:resourcE1",
                null, null);
        assertTrue(access.getGranted());

        // all three have no access to CREATE action on resource1

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        // all three have no access to invalid domain name on resource 1

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource1",
                "AccessDom2", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource1",
                "AccessDom2", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource1",
                "AccessDom2", null);
        assertFalse(access.getGranted());

        // same as before with no trust domain field

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        // all three should have deny access to resource 2

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource2",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource2",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource2",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        // user2 and user3 have access to CREATE(*)/resource 3

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource3",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CReATE", "AccessDOm1:resouRce3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATe", "accessDom1:rEsource3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to UPDATE(*)/resource 3

        access = zmsImpl.getAccess(rsrcCtx1, "UpDATE", "AcCessDom1:reSource3",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UPDaTE", "AccEssDom1:resourCe3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "UPDATe", "AccEssDom1:resouRce3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to DELETE/resource 4 (*)

        access = zmsImpl.getAccess(rsrcCtx1, "DeLETE", "AccEssDOm1:resouRce4",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "DELETe", "AccEssDom1:resouRce4",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "DELEtE", "AccesSDom1:resouRce4",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // user1 should be able to read resource 5(*) but not resource 6
        // (explicit DENY)

        access = zmsImpl.getAccess(rsrcCtx1, "reaD", "ACCessDom1:reSource5",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "READ", "AccessDom1:resource6",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        // we should get an exception since access is not allowed to be called
        // with user cookie - this api is only for functions that require a
        // service or user tokens

        try {
            zmsImpl.access("READ", "AccessDom1:resource5", principal1, "AccessDom1");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "AccessDom1", auditRef, null);
    }

    @Test
    public void testGetAccessWithGroups() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName1 = "access-domain1";
        final String domainName2 = "access-domain2";
        final String domainName3 = "access-domain3";
        final String groupName1 = "group1";
        final String groupName2 = "group2";
        final String groupName3 = "group3";
        final String groupName4 = "group4";
        final String roleName1 = "role1";
        final String roleName2 = "role2";
        final String roleName3 = "role3";
        final String roleName4 = "role4";
        final String policyName1 = "policy1";
        final String policyName2 = "policy2";
        final String policyName3 = "policy3";
        final String policyName4 = "policy4";

        Authority savedAuthority = zmsImpl.userAuthority;

        Authority authority = Mockito.mock(Authority.class);
        when(authority.isValidUser(anyString())).thenReturn(true);
        when(authority.getDateAttribute(anyString(), anyString())).thenReturn(null);
        Set<String> attrs = new HashSet<>();
        attrs.add("elevated-clearance");
        when(authority.dateAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;
        zmsImpl.dbService.zmsConfig.setUserAuthority(authority);

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2, "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        TopLevelDomain dom3 = zmsTestInitializer.createTopLevelDomainObject(domainName3, "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom3);

        Group group1 = zmsTestInitializer.createGroupObject(domainName1, groupName1, "user.user1", "user.user2");
        zmsImpl.putGroup(ctx, domainName1, groupName1, auditRef, false, null, group1);

        Group group2 = zmsTestInitializer.createGroupObject(domainName2, groupName2, "user.user2", "user.user3");
        zmsImpl.putGroup(ctx, domainName2, groupName2, auditRef, false, null, group2);

        // set elevated clearance so both users become expired

        Group group3 = zmsTestInitializer.createGroupObject(domainName3, groupName3, "user.user1", "user.user2");
        zmsImpl.putGroup(ctx, domainName3, groupName3, auditRef, false, null, group3);
        GroupMeta gm = new GroupMeta().setUserAuthorityExpiration("elevated-clearance");
        zmsImpl.putGroupMeta(ctx, domainName3, groupName3, auditRef, null, gm);

        // group 4 with no members

        Group group4 = new Group().setName(groupName4);
        zmsImpl.putGroup(ctx, domainName2, groupName4, auditRef, false, null, group4);

        // role1 will have user.user1 through group1

        Role role1 = zmsTestInitializer.createRoleObject(domainName1, roleName1, null, "user.user2", "user.user3");
        role1.getRoleMembers().add(new RoleMember().setMemberName(ResourceUtils.groupResourceName(domainName2, groupName2)));
        role1.getRoleMembers().add(new RoleMember().setMemberName(ResourceUtils.groupResourceName(domainName1, groupName1)));
        zmsImpl.putRole(ctx, domainName1, roleName1, auditRef, false, null, role1);

        // role2 has user1 as expired but ok from group1 as well

        Role role2 = zmsTestInitializer.createRoleObject(domainName1, roleName2, null, "user.user2", "user.user3");
        role2.getRoleMembers().add(new RoleMember().setMemberName("user.user1")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() - 1000)));
        role2.getRoleMembers().add(new RoleMember().setMemberName(ResourceUtils.groupResourceName(domainName2, groupName2)));
        role2.getRoleMembers().add(new RoleMember().setMemberName(ResourceUtils.groupResourceName(domainName1, groupName1)));
        zmsImpl.putRole(ctx, domainName1, roleName2, auditRef, false, null, role2);

        // role3 has user1 as expired but also group1 expired as well

        Role role3 = zmsTestInitializer.createRoleObject(domainName1, roleName3, null, "user.user2", "user.user3");
        role3.getRoleMembers().add(new RoleMember().setMemberName("user.user1")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() - 1000)));
        role3.getRoleMembers().add(new RoleMember().setMemberName(ResourceUtils.groupResourceName(domainName1, groupName1))
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() - 1000)));
        zmsImpl.putRole(ctx, domainName1, roleName3, auditRef, false, null, role3);

        // role4 does not have user1 at all

        Role role4 = zmsTestInitializer.createRoleObject(domainName1, roleName4, null, "user.user2", "user.user3");
        role4.getRoleMembers().add(new RoleMember().setMemberName(ResourceUtils.groupResourceName(domainName2, groupName2)));
        role4.getRoleMembers().add(new RoleMember().setMemberName(ResourceUtils.groupResourceName(domainName2, groupName4)));
        zmsImpl.putRole(ctx, domainName1, roleName4, auditRef, false, null, role4);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName1, policyName1, roleName1,
                "update", domainName1 + ":resource1", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, policyName1, auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName1, policyName2, roleName2,
                "update", domainName1 + ":resource2", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, policyName2, auditRef, false, null, policy2);

        Policy policy3 = zmsTestInitializer.createPolicyObject(domainName1, policyName3, roleName3,
                "update", domainName1 + ":resource3", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, policyName3, auditRef, false, null, policy3);

        Policy policy4 = zmsTestInitializer.createPolicyObject(domainName1, policyName4, roleName4,
                "update", domainName1 + ":resource4", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, policyName4, auditRef, false, null, policy4);

        // user1 and user3 have access to UPDATE/resource1

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);

        Access access = zmsImpl.getAccess(rsrcCtx1, "update", domainName1 + ":resource1", null, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "update", domainName1 + ":resource2", null, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "update", domainName1 + ":resource3", null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "update", domainName1 + ":resource4", null, null);
        assertFalse(access.getGranted());

        zmsImpl.dbService.zmsConfig.setUserAuthority(savedAuthority);
        zmsImpl.userAuthority = savedAuthority;

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName2, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName3, auditRef, null);
    }

    @Test
    public void testGetAccessWildcard() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AccessDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("AccessDom1", "Role1", null, "user.user1",
                "user.user3");
        zmsImpl.putRole(ctx, "AccessDom1", "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject("AccessDom1", "Role2", null, "user.user2",
                "user.user3");
        zmsImpl.putRole(ctx, "AccessDom1", "Role2", auditRef, false, null, role2);

        Policy policy1 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy1", "Role1",
                "UpdatE", "AccessDom1:ResourcE1", AssertionEffect.ALLOW);
        policy1.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy2", "Role2",
                "CreatE", "AccessDom1:ResourcE2", AssertionEffect.DENY);
        policy2.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy2", auditRef, false, null, policy2);

        Policy policy3 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy3", "Role2",
                "*", "AccessDom1:ResourcE3", AssertionEffect.ALLOW);
        policy3.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy3", auditRef, false, null, policy3);

        Policy policy4 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy4", "Role2",
                "DeletE", "AccessdoM1:*", AssertionEffect.ALLOW);
        policy4.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy4", auditRef, false, null, policy4);

        Policy policy5 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy5", "Role1",
                "ReaD", "AccessdoM1:*", AssertionEffect.ALLOW);
        policy5.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy5", auditRef, false, null, policy5);

        Policy policy6 = zmsTestInitializer.createPolicyObject("AccessDom1", "Policy6", "Role1",
                "ReaD", "AccessDom1:ResourcE6", AssertionEffect.DENY);
        policy6.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, "AccessDom1", "Policy6", auditRef, false, null, policy6);

        // user1 and user3 have access to UPDATE/resource1

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        Principal principal2 = principalAuthority.authenticate("v=U1;d=user;n=user2;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx2 = zmsTestInitializer.createResourceContext(principal2);
        Principal principal3 = principalAuthority.authenticate("v=U1;d=user;n=user3;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx3 = zmsTestInitializer.createResourceContext(principal3);

        Access access = zmsImpl.getAccess(rsrcCtx1, "uPDATe", "AcceSSDom1:rESOURCe1",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UpDaTe", "AccEssDom1:reSouRce1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "uPdate", "AccEssDom1:resOurce1",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // same set as before with no trust domain field

        access = zmsImpl.getAccess(rsrcCtx1, "UPDaTE", "ACcessDom1:reSource1",
                null, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UPDAtE", "AccEssDom1:resOUrce1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "uPDATE", "ACcessDom1:resourcE1",
                null, null);
        assertTrue(access.getGranted());

        // all three have no access to CREATE action on resource1

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource1",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        // all three have no access to invalid domain name on resource 1

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource1",
                "AccessDom2", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource1",
                "AccessDom2", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource1",
                "AccessDom2", null);
        assertFalse(access.getGranted());

        // same as before with no trust domain field

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource1",
                null, null);
        assertFalse(access.getGranted());

        // all three should have deny access to resource 2

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource2",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "AccessDom1:resource2",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "AccessDom1:resource2",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        // user2 and user3 have access to CREATE(*)/resource 3

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "AccessDom1:resource3",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CReATE", "AccessDOm1:resouRce3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATe", "accessDom1:rEsource3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to UPDATE(*)/resource 3

        access = zmsImpl.getAccess(rsrcCtx1, "UpDATE", "AcCessDom1:reSource3",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UPDaTE", "AccEssDom1:resourCe3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "UPDATe", "AccEssDom1:resouRce3",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to DELETE/resource 4 (*)

        access = zmsImpl.getAccess(rsrcCtx1, "DeLETE", "AccEssDOm1:resouRce4",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "DELETe", "AccEssDom1:resouRce4",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "DELEtE", "AccesSDom1:resouRce4",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        // user1 should be able to read resource 5(*) but not resource 6
        // (explicit DENY)

        access = zmsImpl.getAccess(rsrcCtx1, "reaD", "ACCessDom1:reSource5",
                "AccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "READ", "AccessDom1:resource6",
                "AccessDom1", null);
        assertFalse(access.getGranted());

        // we should get an exception since access is not allowed to be called
        // with user cookie - this api is only for functions that require a
        // service or user tokens

        try {
            zmsImpl.access("READ", "AccessDom1:resource5", principal1, "AccessDom1");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        zmsImpl.deleteTopLevelDomain(ctx, "AccessDom1", auditRef, null);
    }

    @Test
    public void testGetAccessCrossUser() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("CrossAllowDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("CrossAllowDom1", "Role1", null,
                "user.user1", "user.user3");
        zmsImpl.putRole(ctx, "CrossAllowDom1", "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject("CrossAllowDom1", "Role2", null,
                "user.user2", "user.user3");
        zmsImpl.putRole(ctx, "CrossAllowDom1", "Role2", auditRef, false, null, role2);

        Role role3 = zmsTestInitializer.createRoleObject("CrossAllowDom1", "Role3", null,
                "user.user1", null);
        zmsImpl.putRole(ctx, "CrossAllowDom1", "Role3", auditRef, false, null, role3);

        Policy policy1 = zmsTestInitializer.createPolicyObject("CrossAllowDom1", "Policy1",
                "Role1", "UPDATE", "CrossAllowDom1:resource1",
                AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "CrossAllowDom1", "Policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject("CrossAllowDom1", "Policy2",
                "Role2", "CREATE", "CrossAllowDom1:resource2",
                AssertionEffect.DENY);
        zmsImpl.putPolicy(ctx, "CrossAllowDom1", "Policy2", auditRef, false, null, policy2);

        Policy policy3 = zmsTestInitializer.createPolicyObject("CrossAllowDom1", "Policy3",
                "Role2", "*", "CrossAllowDom1:resource3", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "CrossAllowDom1", "Policy3", auditRef, false, null, policy3);

        Policy policy4 = zmsTestInitializer.createPolicyObject("CrossAllowDom1", "Policy4",
                "Role2", "DELETE", "CrossAllowDom1:*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "CrossAllowDom1", "Policy4", auditRef, false, null, policy4);

        // verify we have allow access for access resource

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        Principal principal2 = principalAuthority.authenticate("v=U1;d=user;n=user2;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx2 = zmsTestInitializer.createResourceContext(principal2);
        Principal principal3 = principalAuthority.authenticate("v=U1;d=user;n=user3;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx3 = zmsTestInitializer.createResourceContext(principal3);

        // user1 and user3 have access to UPDATE/resource1

        Access access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user1");
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user.user1");
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user2");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user.user2");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user3");
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user.user3");
        assertTrue(access.getGranted());

        // all three have no access to CREATE action on resource1

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user1");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user.user1");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user2");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user.user2");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user3");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user.user3");
        assertFalse(access.getGranted());

        // all three have no access to invalid domain name on resource 1

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom2", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom2", "user1");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom2", "user.user1");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "CrossAllowDom1:resource1",
                "CrossAllowDom2", null);
        assertFalse(access.getGranted());

        // user2 and user3 have access to CREATE(*)/resource 3

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource3",
                "CrossAllowDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource3",
                "CrossAllowDom1", "user1");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource3",
                "CrossAllowDom1", "user.user1");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "CREATE", "CrossAllowDom1:resource3",
                "CrossAllowDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource3",
                "CrossAllowDom1", "user2");
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource3",
                "CrossAllowDom1", "user.user2");
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "CREATE", "CrossAllowDom1:resource3",
                "CrossAllowDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource3",
                "CrossAllowDom1", "user3");
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx1, "CREATE", "CrossAllowDom1:resource3",
                "CrossAllowDom1", "user.user3");
        assertTrue(access.getGranted());

        // user2 and user3 are allowed to check each other's access

        access = zmsImpl.getAccess(rsrcCtx2, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user1");
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx2, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user.user1");
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user1");
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtx3, "UPDATE", "CrossAllowDom1:resource1",
                "CrossAllowDom1", "user.user1");
        assertTrue(access.getGranted());

        zmsImpl.deleteTopLevelDomain(ctx, "CrossAllowDom1", auditRef, null);
    }

    @Test
    public void testGetAccessHomeDomainEnabled() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN, "true");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();

        Principal pJane = principalAuthority.authenticate("v=U1;d=user;n=jane;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtxJane = zmsTestInitializer.createResourceContext(pJane);

        Access access = zmsTest.getAccess(rsrcCtxJane, "READ", "user.jane:Resource1", null, null);
        assertTrue(access.getGranted());

        access = zmsTest.getAccess(rsrcCtxJane, "WRITE", "user.jane:Resource1", null, null);
        assertTrue(access.getGranted());

        access = zmsTest.getAccess(rsrcCtxJane, "UPDATE", "user.jane:Resource1", null, null);
        assertTrue(access.getGranted());

        // user id does not match domain - all should be failure

        Principal pJohn = principalAuthority.authenticate("v=U1;d=user;n=john;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtxJohn = zmsTestInitializer.createResourceContext(pJohn);

        try {
            zmsTest.getAccess(rsrcCtxJohn, "READ", "user.jane:Resource1", null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        try {
            zmsTest.getAccess(rsrcCtxJohn, "WRITE", "user.jane:Resource1", null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        try {
            zmsTest.getAccess(rsrcCtxJohn, "UPDATE", "user.jane:Resource1", null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN);
    }

    @Test
    public void testGetAccessHomeDomainDisabled() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN, "false");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();

        Principal pJane = principalAuthority.authenticate("v=U1;d=user;n=jane;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtxJane = zmsTestInitializer.createResourceContext(pJane);

        try {
            zmsTest.getAccess(rsrcCtxJane, "READ", "user.jane:Resource1", null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        try {
            zmsTest.getAccess(rsrcCtxJane, "WRITE", "user.jane:Resource1", null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        try {
            zmsTest.getAccess(rsrcCtxJane, "UPDATE", "user.jane:Resource1", null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN);
    }

    @Test
    public void testGetAccessFailures() {

        final String domainName = "access-domain-fails";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Authority authority = Mockito.mock(Authority.class);
        when(authority.allowAuthorization()).thenReturn(false);
        Principal principal1 = Mockito.mock(Principal.class);
        when(principal1.getAuthority()).thenReturn(authority);

        // authority not authorized

        assertFalse(zmsImpl.access("update", domainName + ":resource1", principal1, null));

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal2 = principalAuthority.authenticate("v=U1;d=user;n=user2;s=signature",
                "10.11.12.13", "GET", null);

        // domain name missing in resource

        try {
            zmsImpl.access("update", "resource1", principal2, null);
            fail();
        } catch (com.yahoo.athenz.common.server.rest.ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        RsrcCtxWrapper rsrcCtx = Mockito.mock(RsrcCtxWrapper.class);
        try {
            zmsImpl.getAccessCheck(principal2, "update", "resource1", null, null, rsrcCtx);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // domain is disabled

        Domain dom1 = new Domain().setName(domainName).setEnabled(false);

        List<String> adminUsers = new ArrayList<>();
        adminUsers.add(zmsTestInitializer.getAdminUser());
        zmsImpl.dbService.makeDomain(ctx, dom1, adminUsers, null, auditRef);

        try {
            zmsImpl.access("update", domainName + ":resource1", principal2, null);
            fail();
        } catch (com.yahoo.athenz.common.server.rest.ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.getAccessCheck(principal2, "update", domainName + ":resource1", null, null, ctx);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testRetrieveAccessDomainValid() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("AccessDomain",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal pJane = principalAuthority.authenticate("v=U1;d=user;n=jane;s=signature",
                "10.11.12.13", "GET", null);

        AthenzDomain athenzDomain = zmsImpl.retrieveAccessDomain("accessdomain", pJane);
        assertNotNull(athenzDomain);

        zmsImpl.deleteTopLevelDomain(ctx, "AccessDomain", auditRef, null);
    }

    @Test
    public void testRetrieveAccessDomainVirtualValid() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN, "true");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature",
                0, principalAuthority);

        AthenzDomain athenzDomain = zmsTest.retrieveAccessDomain("user.user1", principal);
        assertNotNull(athenzDomain);
        assertEquals(athenzDomain.getName(), "user.user1");

        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN);
    }

    @Test
    public void testRetrieveAccessDomainVirtualDomainDisabled() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN, "false");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature",
                0, principalAuthority);

        AthenzDomain athenzDomain = zmsTest.retrieveAccessDomain("user.user1", principal);
        assertNull(athenzDomain);

        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN);
    }

    @Test
    public void testRetrieveAccessDomainPrincialNullDomain() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN, "true");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal = SimplePrincipal.create("user1", "v=U1;d=user;n=user1;s=signature",
                principalAuthority);

        AthenzDomain athenzDomain = zmsTest.retrieveAccessDomain("user.user1", principal);
        assertNull(athenzDomain);

        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN);

    }

    @Test
    public void testRetrieveAccessDomainMismatch() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN, "true");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal = SimplePrincipal.create("user", "user2", "v=U1;d=user;n=user2;s=signature",
                0, principalAuthority);

        AthenzDomain athenzDomain = zmsTest.retrieveAccessDomain("user.user1", principal);
        assertNull(athenzDomain);

        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN);
    }

    @Test
    public void testGetAccessCrossDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.setupTenantDomainProviderService("CrossDomainAccessDom1", "coretech", "storage",
                "http://localhost:8090/provider");

        Tenancy tenant = zmsTestInitializer.createTenantObject("CrossDomainAccessDom1", "coretech.storage");
        zmsImpl.putTenancy(ctx, "CrossDomainAccessDom1", "coretech.storage", auditRef, tenant);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction((String) f.value()));
        }
        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles().setDomain("coretech")
                .setService("storage").setTenant("CrossDomainAccessDom1")
                .setRoles(roleActions).setResourceGroup("group1");

        zmsImpl.putTenantResourceGroupRoles(ctx, "coretech", "storage", "CrossDomainAccessDom1",
                "group1", auditRef, tenantRoles);

        // reset roles in the CrossDomainAccessDom1 domain with unique values

        Role role = zmsTestInitializer.createRoleObject("CrossDomainAccessDom1", "reader", null, "user.joe",
                "user.jane");
        zmsImpl.putRole(ctx, "CrossDomainAccessDom1", "reader", auditRef, false, null, role);

        role = zmsTestInitializer.createRoleObject("CrossDomainAccessDom1", "writer", null, "user.john",
                "user.jane");
        zmsImpl.putRole(ctx, "CrossDomainAccessDom1", "writer", auditRef, false, null, role);

        Policy policy = zmsTestInitializer.createPolicyObject("CrossDomainAccessDom1", "tenancy.coretech.storage.writer",
                "writer", "ASSUME_ROLE",
                "coretech:role.storage.tenant.CrossDomainAccessDom1.res_group.group1.writer",
                AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "CrossDomainAccessDom1", "tenancy.coretech.storage.writer",
                auditRef, false, null, policy);

        policy = zmsTestInitializer.createPolicyObject("CrossDomainAccessDom1", "tenancy.coretech.storage.reader",
                "reader", "ASSUME_ROLE",
                "coretech:role.storage.tenant.CrossDomainAccessDom1.res_group.group1.reader",
                AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "CrossDomainAccessDom1", "tenancy.coretech.storage.reader",
                auditRef, false, null, policy);

        // verify the ASSUME_ROLE check - with trust domain specified it should work and
        // without trust domain it will not work since the resource is pointing to the
        // provider's domain and not to the tenant's domain

        Access access = zmsImpl.getAccess(ctx, "ASSUME_ROLE",
                "coretech:role.storage.tenant.CrossDomainAccessDom1.res_group.group1.reader",
                null, "user.jane");
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(ctx, "ASSUME_ROLE",
                "coretech:role.storage.tenant.CrossDomainAccessDom1.res_group.group1.reader",
                "CrossDomainAccessDom1", "user.jane");
        assertTrue(access.getGranted());

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();

        Principal pJane = principalAuthority.authenticate("v=U1;d=user;n=jane;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtxJane = zmsTestInitializer.createResourceContext(pJane);
        Principal pJohn = principalAuthority.authenticate("v=U1;d=user;n=john;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtxJohn = zmsTestInitializer.createResourceContext(pJohn);
        Principal pJoe = principalAuthority.authenticate("v=U1;d=user;n=joe;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtxJoe = zmsTestInitializer.createResourceContext(pJoe);

        access = zmsImpl.getAccess(rsrcCtxJoe, "READ",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJane, "READ",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJohn, "READ",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJoe, "WRITE",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJane, "WRITE",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom1", null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJohn, "WRITE",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom1", null);
        assertTrue(access.getGranted());

        // unknown action should always fail

        access = zmsImpl.getAccess(rsrcCtxJoe, "UPDATE",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJane, "UPDATE",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom1", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJohn, "UPDATE",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom1", null);
        assertFalse(access.getGranted());

        // same set as above without trust domain field

        access = zmsImpl.getAccess(rsrcCtxJoe, "READ",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                null, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJane, "READ",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                null, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJohn, "READ",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJoe, "WRITE",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                null, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJane, "WRITE",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                null, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJohn, "WRITE",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                null, null);
        assertTrue(access.getGranted());

        // failure with different domain name

        access = zmsImpl.getAccess(rsrcCtxJoe, "READ",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom2", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJane, "READ",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom2", null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccess(rsrcCtxJohn, "READ",
                "coretech:service.storage.tenant.CrossDomainAccessDom1.res_group.group1.resource1",
                "CrossDomainAccessDom2", null);
        assertFalse(access.getGranted());

        zmsImpl.deleteTenancy(ctx, "CrossDomainAccessDom1", "coretech.storage", auditRef);

        zmsImpl.deleteTopLevelDomain(ctx, "CrossDomainAccessDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
    }

    @Test
    public void testGetAccessCrossDomainWildCardResources() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // create the netops domain

        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject("netops",
                "Test Netops", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Role role = zmsTestInitializer.createRoleObject("netops", "users", null, null, null);
        zmsImpl.putRole(ctx, "netops", "users", auditRef, false, null, role);

        role = zmsTestInitializer.createRoleObject("netops", "superusers", null, "user.siteops_user_1",
                "user.siteops_user_2");
        zmsImpl.putRole(ctx, "netops", "superusers", auditRef, false, null, role);

        Policy policy = zmsTestInitializer.createPolicyObject("netops", "users",
                "users", "NODE_USER", "netops:node.",
                AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "netops", "users", auditRef, false, null, policy);

        policy = zmsTestInitializer.createPolicyObject("netops", "superusers",
                "superusers", "NODE_SUDO", "netops:node.",
                AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "netops", "superusers", auditRef, false, null, policy);

        policy = zmsTestInitializer.createPolicyObject("netops", "netops_superusers",
                "netops:role.superusers", false, "ASSUME_ROLE", "*:role.netops_superusers",
                AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "netops", "netops_superusers", auditRef, false, null, policy);

        // create the weather domain

        dom = zmsTestInitializer.createTopLevelDomainObject("weather",
                "Test weather", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        role = zmsTestInitializer.createRoleObject("weather", "users", null, null, null);
        zmsImpl.putRole(ctx, "weather", "users", auditRef, false, null, role);

        role = zmsTestInitializer.createRoleObject("weather", "superusers", null, "user.weather_admin_user",
                null);
        zmsImpl.putRole(ctx, "weather", "superusers", auditRef, false, null, role);

        role = zmsTestInitializer.createRoleObject("weather", "netops_superusers", "netops");
        zmsImpl.putRole(ctx, "weather", "netops_superusers", auditRef, false, null, role);

        policy = zmsTestInitializer.createPolicyObject("weather", "users",
                "users", "NODE_USER", "weather:node.",
                AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "weather", "users", auditRef, false, null, policy);

        policy = zmsTestInitializer.createPolicyObject("weather", "superusers",
                "superusers", "NODE_SUDO", "weather:node.*",
                AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "weather", "superusers", auditRef, false, null, policy);

        policy = zmsTestInitializer.createPolicyObject("weather", "netops_superusers",
                "netops_superusers", "NODE_SUDO", "weather:node.*",
                AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "weather", "netops_superusers", auditRef, false, null, policy);

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();

        Principal pWeather = principalAuthority.authenticate("v=U1;d=user;n=weather_admin_user;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtxWeather = zmsTestInitializer.createResourceContext(pWeather);

        Access access = zmsImpl.getAccess(rsrcCtxWeather, "NODE_SUDO", "weather:node.x", null, null);
        assertTrue(access.getGranted());

        Principal pSiteOps = principalAuthority.authenticate("v=U1;d=user;n=siteops_user_1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtxSiteOps = zmsTestInitializer.createResourceContext(pSiteOps);

        access = zmsImpl.getAccess(rsrcCtxSiteOps, "NODE_SUDO", "weather:node.x", null, null);
        assertTrue(access.getGranted());

        Principal pRandom = principalAuthority.authenticate("v=U1;d=user;n=random_user;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtxRandom = zmsTestInitializer.createResourceContext(pRandom);

        access = zmsImpl.getAccess(rsrcCtxRandom, "NODE_SUDO", "weather:node.x", null, null);
        assertFalse(access.getGranted());

        zmsImpl.deleteTopLevelDomain(ctx, "weather", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "netops", auditRef, null);
    }

    @Test
    public void testGetAccessExt() {

        final String testDomainName = "AccessDomExt1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(testDomainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(testDomainName, "Role1", null, "user.user1",
                "user.user3");
        zmsImpl.putRole(ctx, testDomainName, "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(testDomainName, "Role2", null, "user.user2",
                "user.user3");
        zmsImpl.putRole(ctx, testDomainName, "Role2", auditRef, false, null, role2);

        Policy policy1 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy1", "Role1",
                "UPDATE", testDomainName + ":resource1/resource2", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy2", "Role2",
                "CREATE", testDomainName + ":resource2(resource3)", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy2", auditRef, false, null, policy2);

        Policy policy3 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy3", "Role2",
                "*", testDomainName + ":resource3/*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy3", auditRef, false, null, policy3);

        Policy policy4 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy4", "Role1",
                "READ", testDomainName + ":resource4[*]/data1", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy4", auditRef, false, null, policy4);

        Policy policy5 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy5", "Role2",
                "access", testDomainName + ":https://*.athenz.com/*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy5", auditRef, false, null, policy5);

        // user1 and user3 have access to UPDATE/resource1

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        Principal principal2 = principalAuthority.authenticate("v=U1;d=user;n=user2;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx2 = zmsTestInitializer.createResourceContext(principal2);
        Principal principal3 = principalAuthority.authenticate("v=U1;d=user;n=user3;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx3 = zmsTestInitializer.createResourceContext(principal3);

        // user1 and user3 have update access to resource1/resource2

        Access access = zmsImpl.getAccessExt(rsrcCtx1, "UPDATE", testDomainName + ":resource1/resource2",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx1, "UPDATE", testDomainName + ":resource1/resource3",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "UPDATE", testDomainName + ":resource1/resource2",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "UPDATE", testDomainName + ":resource1/resource2",
                testDomainName, null);
        assertTrue(access.getGranted());

        // all three have no access to CREATE action on resource1/resource2

        access = zmsImpl.getAccessExt(rsrcCtx1, "CREATE", testDomainName + ":resource1/resource2",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "CREATE", testDomainName + ":resource1/resource2",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "CREATE", testDomainName + ":resource1/resource2",
                testDomainName, null);
        assertFalse(access.getGranted());

        // user2 and user3 have create access to resource2(resource3)

        access = zmsImpl.getAccessExt(rsrcCtx1, "CREATE", testDomainName + ":resource2(resource3)",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "CREATE", testDomainName + ":resource2(resource3)",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "CREATE", testDomainName + ":resource2(resource3)",
                testDomainName, null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to CREATE(*)/resource3/*

        access = zmsImpl.getAccessExt(rsrcCtx1, "CREATE", testDomainName + ":resource3",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "CREATE", testDomainName + ":resource3/test1",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "CREATE", testDomainName + ":resource3/anothertest",
                testDomainName, null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to UPDATE(*)/resource3/*

        access = zmsImpl.getAccessExt(rsrcCtx1, "UPDATE", testDomainName + ":resource3",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "UPDATE", testDomainName + ":resource3/(another value)",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "UPDATE", testDomainName + ":resource3/a",
                testDomainName, null);
        assertTrue(access.getGranted());

        // user1 and user3 have access to READ/resource6[*]/data1

        access = zmsImpl.getAccessExt(rsrcCtx1, "read", testDomainName + ":resource4[test1]/data1",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "read", testDomainName + ":resource4[test1]/data1",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "read", testDomainName + ":resource4[test another]/data1",
                testDomainName, null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to access/https://*.athenz.com/*

        access = zmsImpl.getAccessExt(rsrcCtx1, "access", testDomainName + ":https://web.athenz.com/data",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "access", testDomainName + ":https://web.athenz.com/data",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "access", testDomainName + ":https://web.athenz.org/data",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "access", testDomainName + ":https://web-store.athenz.com/data/path",
                testDomainName, null);
        assertTrue(access.getGranted());

        zmsImpl.deleteTopLevelDomain(ctx, testDomainName, auditRef, null);
    }

    @Test
    public void testGetAccessExtCaseSensitive() {

        final String testDomainName = "AccessDomExt1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(testDomainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(testDomainName, "Role1", null, "user.user1",
                "user.user3");
        zmsImpl.putRole(ctx, testDomainName, "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(testDomainName, "Role2", null, "user.user2",
                "user.user3");
        zmsImpl.putRole(ctx, testDomainName, "Role2", auditRef, false, null, role2);

        Policy policy1 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy1", "Role1",
                "UpdatE", testDomainName + ":ResourcE1/ResourcE2", AssertionEffect.ALLOW);
        policy1.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy2", "Role2",
                "CreatE", testDomainName + ":ResourcE2(ResourcE3)", AssertionEffect.ALLOW);
        policy2.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy2", auditRef, false, null, policy2);

        Policy policy3 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy3", "Role2",
                "*", testDomainName + ":ResourcE3/*", AssertionEffect.ALLOW);
        policy3.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy3", auditRef, false, null, policy3);

        Policy policy4 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy4", "Role1",
                "ReaD", testDomainName + ":ResourcE4[*]/DatA1", AssertionEffect.ALLOW);
        policy4.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy4", auditRef, false, null, policy4);

        Policy policy5 = zmsTestInitializer.createPolicyObject(testDomainName, "Policy5", "Role2",
                "AccesS", testDomainName + ":https://*.ATHENZ.com/*", AssertionEffect.ALLOW);
        policy5.setCaseSensitive(true);
        zmsImpl.putPolicy(ctx, testDomainName, "Policy5", auditRef, false, null, policy5);

        // user1 and user3 have access to UPDATE/resource1

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        Principal principal2 = principalAuthority.authenticate("v=U1;d=user;n=user2;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx2 = zmsTestInitializer.createResourceContext(principal2);
        Principal principal3 = principalAuthority.authenticate("v=U1;d=user;n=user3;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx3 = zmsTestInitializer.createResourceContext(principal3);

        // user1 and user3 have update access to resource1/resource2

        Access access = zmsImpl.getAccessExt(rsrcCtx1, "uPDATe", testDomainName + ":resouRce1/reSource2",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx1, "UPDATE", testDomainName + ":resource1/resource3",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "UPDATE", testDomainName + ":resource1/resource2",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "UPdATE", testDomainName + ":resoUrce1/resourCe2",
                testDomainName, null);
        assertTrue(access.getGranted());

        // all three have no access to CREATE action on resource1/resource2

        access = zmsImpl.getAccessExt(rsrcCtx1, "CReATE", testDomainName + ":resOurce1/resourcE2",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "CREAtE", testDomainName + ":resOurce1/resource2",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "cREATE", testDomainName + ":resource1/resoUrce2",
                testDomainName, null);
        assertFalse(access.getGranted());

        // user2 and user3 have create access to resource2(resource3)

        access = zmsImpl.getAccessExt(rsrcCtx1, "CreatE", testDomainName + ":resource2(resource3)",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "CreATE", testDomainName + ":resOUrce2(resOUrce3)",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "CrEATE", testDomainName + ":resourCe2(reSource3)",
                testDomainName, null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to CREATE(*)/resource3/*

        access = zmsImpl.getAccessExt(rsrcCtx1, "CreatE", testDomainName + ":resource3",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "CReATE", testDomainName + ":RESource3/TesT1",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "CReATE", testDomainName + ":resourCE3/AnotherTest",
                testDomainName, null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to UPDATE(*)/resource3/*

        access = zmsImpl.getAccessExt(rsrcCtx1, "UPDaTE", testDomainName + ":ResourcE3",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "UPDATE", testDomainName + ":RESOURCE3/(anotheR Value)",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "UPDaTE", testDomainName + ":resOurce3/a",
                testDomainName, null);
        assertTrue(access.getGranted());

        // user1 and user3 have access to READ/resource6[*]/data1

        access = zmsImpl.getAccessExt(rsrcCtx1, "REad", testDomainName + ":ResourCE4[TeSt1]/dAtA1",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "reaD", testDomainName + ":Resource4[test1]/dAta1",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "reaD", testDomainName + ":resouRce4[tesT another]/daTa1",
                testDomainName, null);
        assertTrue(access.getGranted());

        // user2 and user3 have access to access/https://*.athenz.com/*

        access = zmsImpl.getAccessExt(rsrcCtx1, "ACCess", testDomainName + ":https://Web.athenz.COM/datA",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "acCess", testDomainName + ":https://web.ATHENZ.com/data",
                testDomainName, null);
        assertTrue(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx2, "acCess", testDomainName + ":https://web.ATHENZ.org/data",
                testDomainName, null);
        assertFalse(access.getGranted());

        access = zmsImpl.getAccessExt(rsrcCtx3, "acCess", testDomainName + ":https://web-store.ATHENZ.com/data/path",
                testDomainName, null);
        assertTrue(access.getGranted());

        zmsImpl.deleteTopLevelDomain(ctx, testDomainName, auditRef, null);
    }

    @Test
    public void testValidateEntity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        int code = 400;
        final String domainName = "domain";
        final String entityName ="entity-one";
        final String nonmatchName ="entity-two";

        Entity entity = new Entity();

        // tests the condition: if (!en.equals(entity.getName()))...
        try {
            entity.setName(nonmatchName);

            zmsImpl.validateEntity(domainName, entityName, entity);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), code);
        }

        // tests the condition: if (entity.getValue() == null)...
        try {
            entity.setName(ResourceUtils.entityResourceName(domainName, entityName));

            zmsImpl.validateEntity(domainName, entityName, entity);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), code);
        }
    }

    @Test
    public void testValidateDomainTemplate() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        DomainTemplate domainTemplate = new DomainTemplate();
        List<String> names = new ArrayList<>();
        names.add("vipng");
        domainTemplate.setTemplateNames(names);

        List<TemplateParam> params = new ArrayList<>();
        params.add(new TemplateParam().setName("param_name_valid").setValue("param_value_valid"));
        domainTemplate.setParams(params);

        // our validation should be successful

        zmsImpl.validate(domainTemplate, "DomainTemplate", "testValidateDomainTemplate");

        // now let's add an invalid entry

        params.add(new TemplateParam().setName("param_name_invalid.test").setValue("param_value_valid"));
        try {
            zmsImpl.validate(domainTemplate, "DomainTemplate", "testValidateDomainTemplate");
            fail();
        } catch (ResourceException ignored) {
        }

        // value is string so it will be accepted

        params.remove(1);
        params.add(new TemplateParam().setName("param_name_valid").setValue("param_value_invalid(again)"));
        zmsImpl.validate(domainTemplate, "DomainTemplate", "testValidateDomainTemplate");
    }

    @Test
    public void testValidateRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Role role = new Role();
        role.setName("athenz:role.role1");
        List<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        role.setRoleMembers(roleMembers);

        // first validation should be successful

        zmsImpl.validate(role, "Role", "testValidateRole");

        // now let's add invalid entry

        roleMembers.add(new RoleMember().setMemberName("user joe"));
        try {
            zmsImpl.validate(role, "Role", "testValidateRole");
            fail();
        } catch (ResourceException ignored) {
        }

        role = new Role().setName("coretech:role.dev-team");
        roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.user1"));
        roleMembers.add(null);
        role.setRoleMembers(roleMembers);

        try {
            zmsImpl.validate(role, "Role", "testValidate");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Invalid Role"), ex.getMessage());
        }
    }

    @Test
    public void testPutEntity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String name = "entity-one";
        final String domainName = "put-entity";
        Entity entity = zmsTestInitializer.createEntityObject(domainName, name);

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // add a new entity as expected

        zmsImpl.putEntity(ctx, domainName, name, auditRef, entity);
        Entity response = zmsImpl.getEntity(ctx, domainName, name);
        assertNotNull(response);

        // now add entity without a name match

        try {
            zmsImpl.putEntity(ctx, domainName, "different-name", auditRef, entity);
            fail();
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }

        // now add entity with a different domain

        try {
            entity = zmsTestInitializer.createEntityObject("unknown-domain", name);
            zmsImpl.putEntity(ctx, "unknown-domain", name, auditRef, entity);
            fail();
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutEntityAuthzDetails() throws JsonProcessingException {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String name = "zts.authorization_details_setup";
        final String domainName = "put-entity-authz-details";

        Entity entity = new Entity();
        entity.setName(ResourceUtils.entityResourceName(domainName, name));

        final String jsonData = "{\"type\":\"message_access\",\"roles\":[{\"name\":\"msg-readers\"," +
                "\"optional\":true},{\"name\":\"msg-writers\",\"optional\":false},{\"name\":" +
                "\"msg-editors\"}],\"fields\":[{\"name\":\"location\",\"optional\":true}," +
                "{\"name\":\"identifier\",\"optional\":false},{\"name\":\"resource\"}]}";
        entity.setValue(new Struct().with("data", jsonData));

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // add a new authz entity as expected

        zmsImpl.putEntity(ctx, domainName, name, auditRef, entity);
        Entity response = zmsImpl.getEntity(ctx, domainName, name);
        assertNotNull(response);

        ObjectMapper jsonMapper = new ObjectMapper();
        jsonMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, true);

        AuthzDetailsEntity authzEntity = AuthzHelper.convertEntityToAuthzDetailsEntity(response);
        assertNotNull(authzEntity);

        List<AuthzDetailsField> roles = authzEntity.getRoles();
        assertNotNull(roles);
        assertEquals(roles.size(), 3);

        List<AuthzDetailsField> fields = authzEntity.getFields();
        assertNotNull(fields);
        assertEquals(fields.size(), 3);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutEntityAuthzDetailsInvalid() throws JsonProcessingException {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String name = "zts.authorization_details_setup";
        final String domainName = "put-entity-authz-details-invalid";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Entity entity = new Entity();
        entity.setName(ResourceUtils.entityResourceName(domainName, name));

        // first let's use attributes not present in the schema

        String jsonData = "{\"type\":\"message_access\",\"data\":\"resource\"}";
        entity.setValue(new Struct().with("data", jsonData));

        try {
            zmsImpl.putEntity(ctx, domainName, name, auditRef, entity);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Invalid authorization details entity object provided"));
        }

        // now let's try without required type attribute

        jsonData = "{\"roles\":[{\"name\":\"msg-readers\"," +
                "\"optional\":true},{\"name\":\"msg-writers\",\"optional\":false},{\"name\":" +
                "\"msg-editors\"}],\"fields\":[{\"name\":\"location\",\"optional\":true}," +
                "{\"name\":\"identifier\",\"optional\":false},{\"name\":\"resource\"}]}";
        entity.setValue(new Struct().with("data", jsonData));

        try {
            zmsImpl.putEntity(ctx, domainName, name, auditRef, entity);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Authorization details entity object missing type"));
        }

        // now let's try without required role attribute

        jsonData = "{\"type\":\"message_access\",\"fields\":[{\"name\":\"location\",\"optional\":true}," +
                "{\"name\":\"identifier\",\"optional\":false},{\"name\":\"resource\"}]}";
        entity.setValue(new Struct().with("data", jsonData));

        try {
            zmsImpl.putEntity(ctx, domainName, name, auditRef, entity);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Authorization details entity object missing roles"));
        }

        // now let's try without required fields

        jsonData = "{\"type\":\"message_access\",\"roles\":[{\"name\":\"msg-readers\"," +
                "\"optional\":true},{\"name\":\"msg-writers\",\"optional\":false},{\"name\":" +
                "\"msg-editors\"}]}";
        entity.setValue(new Struct().with("data", jsonData));

        try {
            zmsImpl.putEntity(ctx, domainName, name, auditRef, entity);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Authorization details entity object missing fields"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetPublicKeyZMS() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        zmsTestInitializer.loadServerPublicKeys(zmsImpl);

        String publicKey = zmsImpl.getPublicKey("sys.auth", "zms", "0");
        assertNotNull(publicKey);
        assertEquals(zmsTestInitializer.getPubKey(), Crypto.ybase64(publicKey.getBytes(StandardCharsets.UTF_8)));

        publicKey = zmsImpl.getPublicKey("sys.auth", "zms", "1");
        assertNotNull(publicKey);
        assertEquals(zmsTestInitializer.getPubKeyK1(), Crypto.ybase64(publicKey.getBytes(StandardCharsets.UTF_8)));

        publicKey = zmsImpl.getPublicKey("sys.auth", "zms", "2");
        assertNotNull(publicKey);
        assertEquals(zmsTestInitializer.getPubKeyK2(), Crypto.ybase64(publicKey.getBytes(StandardCharsets.UTF_8)));
    }

    @Test
    public void testGetPublicKeyInvalidService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        String pubKey = zmsImpl.getPublicKey("sys.auth", "sys.auth", "0");
        assertNull(pubKey);
    }

    @Test
    public void testGetPublicKeyService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("GetPublicKeyDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("GetPublicKeyDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "GetPublicKeyDom1", "Service1", auditRef, false, null, service);

        String publicKey = zmsImpl.getPublicKey("GetPublicKeyDom1", "Service1", "0");
        assertNull(publicKey);

        assertNull(zmsImpl.getPublicKey("GetPublicKeyDom1", null, "0"));
        assertNull(zmsImpl.getPublicKey("GetPublicKeyDom1", "Service1", null));

        publicKey = zmsImpl.getPublicKey("GetPublicKeyDom1", "Service1", "1");
        assertNotNull(publicKey);
        assertEquals(publicKey, Crypto.ybase64DecodeString(zmsTestInitializer.getPubKeyK1()));

        publicKey = zmsImpl.getPublicKey("GetPublicKeyDom1", "Service1", "2");
        assertNotNull(publicKey);
        assertEquals(publicKey, Crypto.ybase64DecodeString(zmsTestInitializer.getPubKeyK2()));

        zmsImpl.deleteTopLevelDomain(ctx, "GetPublicKeyDom1", auditRef, null);
    }

    @Test
    public void testPutTenancy() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.setupTenantDomainProviderService("AddTenancyDom1", "coretech", "storage",
                "http://localhost:8090/provider");

        Tenancy tenant = zmsTestInitializer.createTenantObject("AddTenancyDom1", "coretech.storage");
        zmsImpl.putTenancy(ctx, "AddTenancyDom1", "coretech.storage", auditRef, tenant);

        // now set up the tenant for the subdomain provider

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain("coretech").setService("storage")
                .setTenant("AddTenancyDom1").setRoles(roleActions)
                .setResourceGroup("set1");
        zmsImpl.putProviderResourceGroupRoles(ctx, "AddTenancyDom1", "coretech",
                "storage", "set1", auditRef, providerRoles);

        assertPutTenancyTest();

        // Verify domain dependency wasn't created as the provider isn't listed in the "sys.auth:role.service_providers role

        try {
            zmsImpl.getDependentDomainList(ctx, "coretech.storage");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"coretech.storage is not a registered service provider\"}");
        }

        zmsImpl.deleteTenancy(ctx, "AddTenancyDom1", "coretech.storage", auditRef);

        zmsImpl.deleteTopLevelDomain(ctx, "AddTenancyDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
    }

    @Test
    public void testPutTenancyNoAuthorizedServiceDomainDependency() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.setupTenantDomainProviderService(zmsImpl, "AddTenancyDom1", "coretech", "storage",
                "http://localhost:8090/provider");

        zmsTestInitializer.makeServiceProviders(zmsImpl, ctx, Collections.singletonList("coretech.storage"),
                fetchDomainDependencyFrequency);

        Tenancy tenant = zmsTestInitializer.createTenantObject("AddTenancyDom1", "coretech.storage");
        zmsImpl.putTenancy(ctx, "AddTenancyDom1", "coretech.storage", auditRef, tenant);

        // now set up the tenant for the subdomain provider

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain("coretech").setService("storage")
                .setTenant("AddTenancyDom1").setRoles(roleActions)
                .setResourceGroup("set1");
        zmsImpl.putProviderResourceGroupRoles(ctx, "AddTenancyDom1", "coretech",
                "storage", "set1", auditRef, providerRoles);

        assertPutTenancyTest();

        // Verify domain dependency wasn't created as no service token was passed

        DomainList dependentDomainList = zmsImpl.getDependentDomainList(ctx, "coretech.storage");
        assertEquals(dependentDomainList.getNames().size(), 0);

        zmsImpl.deleteTenancy(ctx, "AddTenancyDom1", "coretech.storage", auditRef);

        zmsImpl.deleteRole(ctx, "sys.auth", "service_providers", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "AddTenancyDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
    }

    private void assertPutTenancyTest() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        // make sure our roles have been created

        Role role = zmsImpl.getRole(ctx, "AddTenancyDom1", "tenancy.coretech.storage.admin", false, false, false);
        assertNotNull(role);

        role = zmsImpl.getRole(ctx, "AddTenancyDom1", "coretech.storage.res_group.set1.admin", false, false, false);
        assertNotNull(role);

        role = zmsImpl.getRole(ctx, "AddTenancyDom1", "coretech.storage.res_group.set1.reader", false, false, false);
        assertNotNull(role);

        role = zmsImpl.getRole(ctx, "AddTenancyDom1", "coretech.storage.res_group.set1.writer", false, false, false);
        assertNotNull(role);

        // verify the policies have the correct roles

        Policy policy = zmsImpl.getPolicy(ctx, "AddTenancyDom1", "tenancy.coretech.storage.admin");
        assertNotNull(policy);

        List<Assertion> assertList = policy.getAssertions();
        assertEquals(3, assertList.size());

        boolean domainAdminRoleCheck = false;
        boolean tenantAdminRoleCheck = false;
        boolean tenantUpdateCheck = false;
        for (Assertion obj : assertList) {
            assertEquals(AssertionEffect.ALLOW, obj.getEffect());
            switch (obj.getRole()) {
                case "addtenancydom1:role.admin":
                    assertEquals(obj.getAction(), "assume_role");
                    domainAdminRoleCheck = true;
                    break;
                case "addtenancydom1:role.tenancy.coretech.storage.admin":
                    if (obj.getAction().equals("assume_role")) {
                        tenantAdminRoleCheck = true;
                    } else if (obj.getAction().equals("update")) {
                        tenantUpdateCheck = true;
                    }
                    break;
            }
        }
        assertTrue(domainAdminRoleCheck);
        assertTrue(tenantAdminRoleCheck);
        assertTrue(tenantUpdateCheck);

        policy = zmsImpl.getPolicy(ctx, "AddTenancyDom1", "tenancy.coretech.storage.res_group.set1.reader");
        assertNotNull(policy);

        assertList = policy.getAssertions();
        assertEquals(assertList.size(), 1);
        assertEquals(assertList.get(0).getRole(), "addtenancydom1:role.coretech.storage.res_group.set1.reader");

        policy = zmsImpl.getPolicy(ctx, "AddTenancyDom1", "tenancy.coretech.storage.res_group.set1.writer");
        assertNotNull(policy);

        assertList = policy.getAssertions();
        assertEquals(assertList.size(), 1);
        assertEquals(assertList.get(0).getRole(), "addtenancydom1:role.coretech.storage.res_group.set1.writer");
    }

    @Test
    public void testPutTenancyWithoutAdmin() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.setupTenantDomainProviderService("AddTenancyDom1", "coretech", "storage",
                "http://localhost:8090/provider");

        Tenancy tenant = zmsTestInitializer.createTenantObject("AddTenancyDom1", "coretech.storage", false);
        zmsImpl.putTenancy(ctx, "AddTenancyDom1", "coretech.storage", auditRef, tenant);

        // now set up the tenant for the subdomain provider

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain("coretech").setService("storage")
                .setTenant("AddTenancyDom1").setRoles(roleActions)
                .setResourceGroup("set1")
                .setCreateAdminRole(false);
        zmsImpl.putProviderResourceGroupRoles(ctx, "AddTenancyDom1", "coretech",
                "storage", "set1", auditRef, providerRoles);

        // make sure tenancy admin role is not created
        try {
            zmsImpl.getRole(ctx, "AddTenancyDom1", "tenancy.coretech.storage.admin", false, false, false);
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), 404);
        }

        // make sure our roles have been created
        Role role = zmsImpl.getRole(ctx, "AddTenancyDom1", "coretech.storage.res_group.set1.admin", false, false, false);
        assertNotNull(role);

        role = zmsImpl.getRole(ctx, "AddTenancyDom1", "coretech.storage.res_group.set1.reader", false, false, false);
        assertNotNull(role);

        role = zmsImpl.getRole(ctx, "AddTenancyDom1", "coretech.storage.res_group.set1.writer", false, false, false);
        assertNotNull(role);

        // make sure tenancy admin policy is not created
        try {
            zmsImpl.getPolicy(ctx, "AddTenancyDom1", "tenancy.coretech.storage.admin");
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), 404);
        }

        Policy policy = zmsImpl.getPolicy(ctx, "AddTenancyDom1", "tenancy.coretech.storage.res_group.set1.reader");
        assertNotNull(policy);

        List<Assertion> assertList = policy.getAssertions();
        assertEquals(assertList.size(), 1);
        assertEquals(assertList.get(0).getRole(), "addtenancydom1:role.coretech.storage.res_group.set1.reader");

        policy = zmsImpl.getPolicy(ctx, "AddTenancyDom1", "tenancy.coretech.storage.res_group.set1.writer");
        assertNotNull(policy);

        assertList = policy.getAssertions();
        assertEquals(assertList.size(), 1);
        assertEquals(assertList.get(0).getRole(), "addtenancydom1:role.coretech.storage.res_group.set1.writer");

        zmsImpl.deleteTenancy(ctx, "AddTenancyDom1", "coretech.storage", auditRef);

        zmsImpl.deleteTopLevelDomain(ctx, "AddTenancyDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
    }

    @Test
    public void testPutTenancyWithAuthorizedService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "puttenancyauthorizedservice";
        String providerService  = "storage";
        String providerDomain = "coretech";
        String provider = providerDomain + "." + providerService;

        zmsTestInitializer.setupTenantDomainProviderService(tenantDomain, providerDomain, providerService, null);

        // tenant is set up so let's set up policy to authorize access to tenants
        // without this role/policy we won't be authorized to add tenant roles
        // to the provider domain even with authorized service details

        Role role = zmsTestInitializer.createRoleObject(providerDomain, "self_serve", null,
                providerDomain + "." + providerService, null);
        zmsImpl.putRole(ctx, providerDomain, "self_serve", auditRef, false, null, role);

        Policy policy = zmsTestInitializer.createPolicyObject(providerDomain, "self_serve",
                "self_serve", "update", providerDomain + ":tenant.*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, providerDomain, "self_serve", auditRef, false, null, policy);

        // we are going to create a principal object with authorized service
        // set to coretech.storage

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String userId = "user1";
        String unsignedCreds = "v=U1;d=user;u=" + userId;
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);
        ((SimplePrincipal) principal).setAuthorizedService(provider);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(principal, "puttenancy");

        // after this call we should have admin roles set for both provider and tenant

        Tenancy tenant = zmsTestInitializer.createTenantObject(tenantDomain, provider);
        zmsImpl.putTenancy(rsrcCtx, tenantDomain, provider, auditRef, tenant);

        String tenantRoleInProviderDomain = assertPolicyForTenancyTests(zmsImpl, tenantDomain, providerService, provider);

        // Verify domain dependency wasn't created as the provider isn't listed in the "sys.auth:role.service_providers role

        try {
            zmsImpl.getDependentDomainList(rsrcCtx, provider);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"coretech.storage is not a registered service provider\"}");
        }

        // now let's call delete tenancy support with the same authorized service token

        zmsImpl.deleteTenancy(rsrcCtx, tenantDomain,  provider, auditRef);

        // verify that all roles and policies have been deleted

        try {
            zmsImpl.getPolicy(rsrcCtx, tenantDomain, "tenancy." + provider + ".admin");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        try {
            zmsImpl.getRole(rsrcCtx, providerDomain, tenantRoleInProviderDomain, false, false, false);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // clean up our domains

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
    }

    @Test
    public void testPutTenancyWithAuthorizedServiceDomainDependency() {

        String tenantDomain = "puttenancyauthorizedservice";
        String providerService  = "storage";
        String providerDomain = "coretech";
        String provider = providerDomain + "." + providerService;

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.setupTenantDomainProviderService(zmsImpl, tenantDomain, providerDomain, providerService, null);
        zmsTestInitializer.makeServiceProviders(zmsImpl, ctx, Collections.singletonList("coretech.storage"),
                fetchDomainDependencyFrequency);

        // tenant is set up so let's set up up policy to authorize access to tenants
        // without this role/policy we won't be authorized to add tenant roles
        // to the provider domain even with authorized service details

        Role role = zmsTestInitializer.createRoleObject(providerDomain, "self_serve", null,
                providerDomain + "." + providerService, null);
        zmsImpl.putRole(ctx, providerDomain, "self_serve", auditRef, false, null, role);

        Policy policy = zmsTestInitializer.createPolicyObject(providerDomain, "self_serve",
                "self_serve", "update", providerDomain + ":tenant.*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, providerDomain, "self_serve", auditRef, false, null, policy);

        // we are going to create a principal object with authorized service
        // set to coretech.storage

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String userId = "user1";
        String unsignedCreds = "v=U1;d=user;u=" + userId;
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);
        ((SimplePrincipal) principal).setAuthorizedService(provider);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(principal, "puttenancy");

        // after this call we should have admin roles set for both provider and tenant

        Tenancy tenant = zmsTestInitializer.createTenantObject(tenantDomain, provider);
        zmsImpl.putTenancy(rsrcCtx, tenantDomain, provider, auditRef, tenant);

        String tenantRoleInProviderDomain = assertPolicyForTenancyTests(zmsImpl, tenantDomain, providerService, provider);

        // Verify domain dependency was created

        DomainList dependentDomainList = zmsImpl.getDependentDomainList(rsrcCtx, provider);
        assertEquals(dependentDomainList.getNames().size(), 1);
        assertEquals(dependentDomainList.getNames().get(0), "puttenancyauthorizedservice");

        // now let's call delete tenancy support with the same authorized service token

        zmsImpl.deleteTenancy(rsrcCtx, tenantDomain,  provider, auditRef);

        // Verify domain dependency was removed
        dependentDomainList = zmsImpl.getDependentDomainList(rsrcCtx, provider);
        assertEquals(dependentDomainList.getNames().size(), 0);

        // verify that all roles and policies have been deleted

        try {
            zmsImpl.getPolicy(rsrcCtx, tenantDomain, "tenancy." + provider + ".admin");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        try {
            zmsImpl.getRole(rsrcCtx, providerDomain, tenantRoleInProviderDomain, false, false, false);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // clean up our domains

        zmsImpl.deleteRole(ctx, "sys.auth", "service_providers", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
    }

    private String assertPolicyForTenancyTests(ZMSImpl zms, String tenantDomain, String providerService, String provider) {

        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        // make sure our policy has been created

        Policy policy = zms.getPolicy(ctx, tenantDomain, "tenancy." + provider + ".admin");
        assertNotNull(policy);

        String tenantRoleInProviderDomain = providerService + ".tenant." + tenantDomain + ".admin";

        List<Assertion> assertList = policy.getAssertions();
        assertEquals(3, assertList.size());
        boolean domainAdminRoleCheck = false;
        boolean tenantAdminRoleCheck = false;
        boolean tenantUpdateCheck = false;
        for (Assertion obj : assertList) {
            assertEquals(AssertionEffect.ALLOW, obj.getEffect());
            if (obj.getRole().equals(tenantDomain + ":role.admin")) {
                assertEquals("assume_role", obj.getAction());
                assertEquals("coretech:role.storage.tenant.puttenancyauthorizedservice.admin", obj.getResource());
                domainAdminRoleCheck = true;
            } else if (obj.getRole().equals(tenantDomain + ":role.tenancy." + provider + ".admin")) {
                if (obj.getAction().equals("assume_role")) {
                    assertEquals("coretech:role.storage.tenant.puttenancyauthorizedservice.admin", obj.getResource());
                    tenantAdminRoleCheck = true;
                } else if (obj.getAction().equals("update")) {
                    assertEquals(tenantDomain + ":tenancy." + provider, obj.getResource());
                    tenantUpdateCheck = true;
                }
            }
        }
        assertTrue(domainAdminRoleCheck);
        assertTrue(tenantAdminRoleCheck);
        assertTrue(tenantUpdateCheck);
        return tenantRoleInProviderDomain;
    }

    @Test
    public void testPutTenancyWithAuthorizedServiceMismatch() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "puttenancyauthorizedservicemismatch";
        String providerService  = "storage";
        String providerDomain = "coretech-test";
        String provider = providerDomain + "." + providerService;

        zmsTestInitializer.setupTenantDomainProviderService(zmsImpl, tenantDomain, providerDomain, providerService, null);

        // tenant is setup so let's setup up policy to authorize access to tenants
        // without this role/policy we won't be authorized to add tenant roles
        // to the provider domain even with authorized service details

        Role role = zmsTestInitializer.createRoleObject(providerDomain, "self_serve", null,
                providerDomain + "." + providerService, null);
        zmsImpl.putRole(ctx, providerDomain, "self_serve", auditRef, false, null, role);

        Policy policy = zmsTestInitializer.createPolicyObject(providerDomain, "self_serve",
                "self_serve", "update", providerDomain + ":tenant.*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, providerDomain, "self_serve", auditRef, false, null, policy);

        // we are going to create a principal object with authorized service
        // set to coretech.storage

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String userId = "user1";
        String unsignedCreds = "v=U1;d=user;u=" + userId;
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);
        ((SimplePrincipal) principal).setAuthorizedService("coretech.storage"); // make provider mismatch
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(principal, "puttenancy");

        // this should fail since the authorized service name does not
        // match to the provider

        Tenancy tenant = zmsTestInitializer.createTenantObject(tenantDomain, provider);
        try {
            zmsImpl.putTenancy(rsrcCtx, tenantDomain, provider, auditRef, tenant);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // clean up our domains

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
    }

    @Test
    public void testPutTenancyWithoutTenantRoles() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.setupTenantDomainProviderService("AddTenancyDom1", "coretech", "storage",
                "http://localhost:8090/provider");

        Tenancy tenant = zmsTestInitializer.createTenantObject("AddTenancyDom1", "coretech.storage");
        zmsImpl.putTenancy(ctx, "AddTenancyDom1", "coretech.storage", auditRef, tenant);

        // make sure our roles have not been created

        try {
            zmsImpl.getRole(ctx, "AddTenancyDom1", "coretech.storage.admin", false, false, false);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        try {
            zmsImpl.getRole(ctx, "AddTenancyDom1", "coretech.storage.reader", false, false, false);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        try {
            zmsImpl.getRole(ctx, "AddTenancyDom1", "coretech.storage.writer", false, false, false);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        // verify the admin policy has been successfully created

        Policy policy = zmsImpl.getPolicy(ctx, "AddTenancyDom1", "tenancy.coretech.storage.admin");
        assertNotNull(policy);

        // we should not have other policies for actions

        try {
            zmsImpl.getPolicy(ctx, "AddTenancyDom1", "tenancy.coretech.storage.reader");
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        try {
            zmsImpl.getPolicy(ctx, "AddTenancyDom1", "tenancy.coretech.storage.writer");
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }

        zmsImpl.deleteTenancy(ctx, "AddTenancyDom1", "coretech.storage", auditRef);

        zmsImpl.deleteTopLevelDomain(ctx, "AddTenancyDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
    }

    @Test
    public void testPutTenancyInvalidService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("providerdomaintenancy",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Tenancy tenant = new Tenancy().setDomain("sports").setService("providerdomaintenancy.api");
        try {
            zmsImpl.putTenancy(ctx, "sports", "providerdomaintenancy.api", auditRef, tenant);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "providerdomaintenancy", auditRef, null);
    }

    @Test
    public void testPutTenancyMissingAuditRef() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain    = "testPutTenancyMissingAuditRef";
        String providerDomain  = "providerTestPutTenancyMissingAuditRef";
        String providerService = "storage";

        // create tenant and provider domains

        zmsTestInitializer.setupTenantDomainProviderService(tenantDomain, providerDomain, providerService,
                "http://localhost:8090/provider");

        // modify the tenant domain to require auditing

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain", null, true, true, null, 0);
        zmsImpl.putDomainMeta(ctx, tenantDomain, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, tenantDomain, "auditenabled", auditRef, meta);

        Tenancy tenant = zmsTestInitializer.createTenantObject(tenantDomain, providerDomain + "." + providerService);
        try {
            zmsImpl.putTenancy(ctx, tenantDomain, providerDomain + "." + providerService, null, tenant);
            fail("requesterror not thrown by putTenancy.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
            zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
        }
    }

    @Test
    public void testPutTenancyMismatchObject() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain    = "testPutTenancyMismatchObject";
        String providerDomain  = "providerTestPutTenancyMismatchObject";
        String providerService = "storage";

        // create tenant and provider domains

        zmsTestInitializer.setupTenantDomainProviderService(tenantDomain, providerDomain, providerService,
                "http://localhost:8090/provider");

        Tenancy tenant = zmsTestInitializer.createTenantObject(tenantDomain + "test", providerDomain + "." + providerService);
        try {
            zmsImpl.putTenancy(ctx, tenantDomain, providerDomain + "." + providerService, auditRef, tenant);
            fail("request error not thrown by putTenancy.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
            zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
        }
    }

    @Test
    public void testDeleteTenancy() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain    = "testDeleteTenancy";
        String providerDomain  = "providerTestDeleteTenancy";
        String providerService = "storage";
        String provService = providerDomain + "." + providerService;

        // create tenant and provider domains
        //
        zmsTestInitializer.setupTenantDomainProviderService(tenantDomain, providerDomain, providerService,
                "http://localhost:8090/provider");

        // modify the tenant domain to require auditing
        //
        DomainMeta meta =
                zmsTestInitializer.createDomainMetaObject("Tenant Domain", null, true, true, null, 0);
        zmsImpl.putDomainMeta(ctx, tenantDomain, auditRef, null, meta);

        String testRoleName = providerDomain + ".testrole";
        Role role = zmsTestInitializer.createRoleObject(tenantDomain, testRoleName, null, "user.joe", "user.jane");
        zmsImpl.putRole(ctx, tenantDomain, testRoleName, auditRef, false, null, role);

        // setup tenancy
        //
        Tenancy tenant = zmsTestInitializer.createTenantObject(tenantDomain, provService);
        zmsImpl.putTenancy(ctx, tenantDomain, provService, auditRef, tenant);

        try {
            zmsImpl.deleteTenancy(ctx, tenantDomain,  provService, auditRef);

            // verify we didn't delete a role by mistake

            assertNotNull(zmsImpl.getRole(ctx, tenantDomain, testRoleName, false, false, false));

            // verify that all roles and policies have been deleted

            try {
                zmsImpl.getRole(ctx, tenantDomain, provService + ".admin", false, false, false);
                fail();
            } catch (ResourceException ex) {
                assertEquals(ex.getCode(), 404);
            }

            try {
                zmsImpl.getRole(ctx, tenantDomain, provService + ".reader", false, false, false);
                fail();
            } catch (ResourceException ex) {
                assertEquals(ex.getCode(), 404);
            }
            try {
                zmsImpl.getRole(ctx, tenantDomain, provService + ".writer", false, false, false);
                fail();
            } catch (ResourceException ex) {
                assertEquals(ex.getCode(), 404);
            }

            try {
                zmsImpl.getPolicy(ctx, tenantDomain, "tenancy." + provService + ".admin");
                fail();
            } catch (ResourceException ex) {
                assertEquals(ex.getCode(), 404);
            }

            try {
                zmsImpl.getPolicy(ctx, tenantDomain, "tenancy." + provService + ".reader");
                fail();
            } catch (ResourceException ex) {
                assertEquals(ex.getCode(), 404);
            }

            try {
                zmsImpl.getPolicy(ctx, tenantDomain, "tenancy." + provService + ".writer");
                fail();
            } catch (ResourceException ex) {
                assertEquals(ex.getCode(), 404);
            }

        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
            zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
        }
    }

    @Test
    public void testDeleteTenancyMissingService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain    = "testDeleteTenancy";
        String providerDomain  = "providerTestDeleteTenancy";
        String providerService = "storage";
        String provService = providerDomain + "." + providerService;

        // create tenant and provider domains
        //
        zmsTestInitializer.setupTenantDomainProviderService(tenantDomain, providerDomain, providerService,
                "http://localhost:8090/provider");

        // modify the tenant domain to require auditing
        //
        DomainMeta meta =
                zmsTestInitializer.createDomainMetaObject("Tenant Domain", null, true, true, null, 0);
        zmsImpl.putDomainMeta(ctx, tenantDomain, auditRef, null, meta);

        // setup tenancy
        //
        Tenancy tenant = zmsTestInitializer.createTenantObject(tenantDomain, provService);
        zmsImpl.putTenancy(ctx, tenantDomain, provService, auditRef, tenant);

        // delete the provider service

        zmsImpl.deleteServiceIdentity(ctx, providerDomain, providerService, auditRef, null);

        try {
            zmsImpl.deleteTenancy(ctx, tenantDomain, provService, auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
            assertTrue(ex.getMessage().contains("Unable to retrieve service"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
            zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
        }
    }

    @Test
    public void testDeleteTenancyMissingAuditRef() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain    = "testDeleteTenancyMissingAuditRef";
        String providerDomain  = "providerTestDeleteTenancyMissingAuditRef";
        String providerService = "storage";

        // create tenant and provider domains
        //
        zmsTestInitializer.setupTenantDomainProviderService(tenantDomain, providerDomain, providerService,
                "http://localhost:8090/provider");

        // modify the tenant domain to require auditing
        //
        DomainMeta meta =
                zmsTestInitializer.createDomainMetaObject("Tenant Domain", null, true, true, null, 0);
        zmsImpl.putDomainMeta(ctx, tenantDomain, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, tenantDomain, "auditenabled", auditRef, meta);
        zmsImpl.putDomainSystemMeta(ctx, tenantDomain, "enabled", auditRef, meta);

        // setup tenancy
        //
        Tenancy tenant = zmsTestInitializer.createTenantObject(tenantDomain, providerDomain + "." + providerService);
        zmsImpl.putTenancy(ctx, tenantDomain, providerDomain + "." + providerService, auditRef, tenant);

        try {
            zmsImpl.deleteTenancy(ctx, tenantDomain,  providerDomain + "." + providerService, null);
            fail("requesterror not thrown by deleteTenancy.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
            zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
        }
    }

    @Test
    public void testPutTenantRolesWithResourceGroup() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testPutTenantRoles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        String tenantDomain = "tenantTestPutTenantRoles";
        TopLevelDomain tenantDom = zmsTestInitializer.createTopLevelDomainObject(
                tenantDomain, "Tenant Domain", "testOrg", zmsTestInitializer.getAdminUser());
        tenantDom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, tenantDom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String serviceName  = "storage";
        String resourceGroup = "Group1";

        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles().setDomain(domain)
                .setService(serviceName).setTenant(tenantDomain)
                .setRoles(roleActions).setResourceGroup(resourceGroup);
        zmsImpl.putTenantResourceGroupRoles(ctx, domain, serviceName, tenantDomain, resourceGroup,
                auditRef, tenantRoles);

        TenantResourceGroupRoles tRoles = zmsImpl.getTenantResourceGroupRoles(ctx, domain, serviceName,
                tenantDomain, resourceGroup);
        assertNotNull(tRoles);
        assertEquals(domain.toLowerCase(), tRoles.getDomain());
        assertEquals(serviceName.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
    }

    @Test
    public void testPutTenantRolesWithResourceGroupInvalidTenant() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testPutTenantRoles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        String tenantDomain = "tenantTestPutTenantRoles";

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String serviceName  = "storage";
        String resourceGroup = "Group1";

        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles().setDomain(domain)
                .setService(serviceName).setTenant(tenantDomain)
                .setRoles(roleActions).setResourceGroup(resourceGroup);
        try {
            zmsImpl.putTenantResourceGroupRoles(ctx, domain, serviceName, tenantDomain, resourceGroup,
                    auditRef, tenantRoles);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getMessage(), "ResourceException (404): {code: 404, message: \"someApiMethod: Unknown tenant domain: tenanttestputtenantroles\"}");
        }

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
    }

    @Test
    public void testPutTenantRolesWithResourceGroupEmptyRoleActions() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testputtenantrolesnoroles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        String serviceName  = "storage";
        String tenantDomain = "tenantTestPutTenantRoles";
        String resourceGroup = "Group1";

        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles().setDomain(domain)
                .setService(serviceName).setTenant(tenantDomain)
                .setRoles(roleActions).setResourceGroup(resourceGroup);

        try {
            zmsImpl.putTenantResourceGroupRoles(ctx, domain, serviceName, tenantDomain,
                    resourceGroup, auditRef, tenantRoles);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
    }

    @Test
    public void testGetDomainDataCheck() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String caller = "testGetDomainDataCheck";
        String tenantDomainName = "testGetDomainDataCheck";
        TopLevelDomain tenDom = zmsTestInitializer.createTopLevelDomainObject(tenantDomainName,
                "Test Provider Domain", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, tenDom);
        // create roles
        Role role1 = zmsTestInitializer.createRoleObject(tenantDomainName, "Role1", null, "user.joe", "user.jane");
        zmsImpl.putRole(ctx, tenantDomainName, "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(tenantDomainName, "Role2", null, "user.phil", "user.gil");
        zmsImpl.putRole(ctx, tenantDomainName, "Role2", auditRef, false, null, role2);

        // create policies
        Policy policy1 = zmsTestInitializer.createPolicyObject(tenantDomainName, "Policy1", "Role1",
                "UPDATE", tenantDomainName + ":resource1", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, tenantDomainName, "Policy1", auditRef, false, null, policy1);
        Policy policy2 = zmsTestInitializer.createPolicyObject(tenantDomainName, "Policy2", "Role2",
                "READ", tenantDomainName + ":resource1", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, tenantDomainName, "Policy2", auditRef, false, null, policy2);
        //
        // test valid setup domain
        DomainDataCheck ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(3, ddc.getPolicyCount());
        assertEquals(3, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertNull(ddc.getDanglingPolicies());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // set valid wildcard role
        Assertion assertion = new Assertion();
        assertion.setAction("MANAGE");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(tenantDomainName + ":wildlife");
        assertion.setRole(tenantDomainName + ":role.Role1");

        Policy policy = zmsImpl.getPolicy(ctx, tenantDomainName, "Policy2");
        List<Assertion> assertList = policy.getAssertions();
        assertList.add(assertion);
        policy.setAssertions(assertList);
        zmsImpl.putPolicy(ctx, tenantDomainName, "Policy2", auditRef, false, null, policy);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(3, ddc.getPolicyCount());
        assertEquals(4, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertNull(ddc.getDanglingPolicies());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // test dangling policy with wildcard role
        assertion = new Assertion();
        assertion.setAction("MANAGE");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(tenantDomainName + ":wildlife");
        assertion.setRole(tenantDomainName + ":role.wild");

        policy = zmsImpl.getPolicy(ctx, tenantDomainName, "Policy2");
        assertList = policy.getAssertions();
        assertList.add(assertion);
        policy.setAssertions(assertList);

        // since we can't put policy that its assertion has a non-existent role
        // we're going to access the store object directly to
        // accomplish that for our unit test
        AthenzObject.POLICY.convertToLowerCase(policy);
        zmsImpl.dbService.executePutPolicy(ctx, tenantDomainName.toLowerCase(), "Policy2".toLowerCase(), policy, auditRef, caller, false);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(3, ddc.getPolicyCount());
        assertEquals(5, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertEquals(1, ddc.getDanglingPolicies().size());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // add a dangling role
        Role role3 = zmsTestInitializer.createRoleObject(tenantDomainName, "Role3", null, "user.user1", "user.user3");
        zmsImpl.putRole(ctx, tenantDomainName, "Role3", auditRef, false, null, role3);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(3, ddc.getPolicyCount());
        assertEquals(5, ddc.getAssertionCount());
        assertEquals(1, ddc.getDanglingRoles().size());
        assertEquals(1, ddc.getDanglingPolicies().size());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // test more dangling policies
        // create policy with assertion using unknown role
        assertion = new Assertion();
        assertion.setAction("snorkel");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(tenantDomainName + ":molokoni");
        assertion.setRole(tenantDomainName + ":role.snorkeler");

        policy = zmsImpl.getPolicy(ctx, tenantDomainName, "Policy2");
        assertList = policy.getAssertions();
        assertList.add(assertion);
        policy.setAssertions(assertList);

        // since we can't put policy that its assertion has a non-existent role
        // we're going to access the store object directly to
        // accomplish that for our unit test
        AthenzObject.POLICY.convertToLowerCase(policy);
        zmsImpl.dbService.executePutPolicy(ctx, tenantDomainName.toLowerCase(), "Policy2".toLowerCase(), policy, auditRef, caller, false);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(3, ddc.getPolicyCount());
        assertEquals(6, ddc.getAssertionCount());
        assertEquals(1, ddc.getDanglingRoles().size());
        assertEquals(2, ddc.getDanglingPolicies().size());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // create provider domain
        String provDomainTop = "testGetDomainDataCheckProvider";
        TopLevelDomain provDom = zmsTestInitializer.createTopLevelDomainObject(provDomainTop,
                "Test Provider Domain", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, provDom);

        String provDomainSub = provDomainTop + ".sub";
        SubDomain subDom = zmsTestInitializer.createSubDomainObject("sub", provDomainTop, null, null,
                zmsTestInitializer.getAdminUser());
        subDom.setAuditEnabled(true);
        zmsImpl.postSubDomain(ctx, provDomainTop, auditRef, null, subDom);

        // test incomplete tenancy setup
        // put tenancy for provider
        String provEndPoint = "http://localhost:8090/provider";
        String provSvc = "storage";
        ServiceIdentity service = zmsTestInitializer.createServiceObject(
                provDomainSub, provSvc, provEndPoint,
                "/usr/bin/java", "root", "users", "localhost");

        zmsImpl.putServiceIdentity(ctx, provDomainSub, provSvc, auditRef, false, null, service);

        Tenancy tenant = zmsTestInitializer.createTenantObject(tenantDomainName, provDomainSub + "." + provSvc);
        zmsImpl.putTenancy(ctx, tenantDomainName, provDomainSub + "." + provSvc, auditRef, tenant);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(4, ddc.getPolicyCount());
        assertEquals(9, ddc.getAssertionCount());
        assertEquals(1, ddc.getDanglingRoles().size());
        assertEquals(2, ddc.getDanglingPolicies().size());
        assertTrue(ddc.getDanglingRoles().contains("role3"));
        boolean danglingPolicy1Found = false;
        boolean danglingPolicy2Found = false;
        for (DanglingPolicy danglingPolicy : ddc.getDanglingPolicies()) {
            if (danglingPolicy.getPolicyName().equals("policy2") && danglingPolicy.getRoleName().equals("wild")) {
                danglingPolicy1Found = true;
            } else if (danglingPolicy.getPolicyName().equals("policy2") && danglingPolicy.getRoleName().equals("snorkeler")) {
                danglingPolicy2Found = true;
            }
        }
        assertTrue(danglingPolicy1Found);
        assertTrue(danglingPolicy2Found);
        assertEquals(1, ddc.getProvidersWithoutTrust().size());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // test that now all is hunky-dory between the tenant and provider.
        // provider gets the trust role(s).
        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction((String) f.value()));
        }

        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles().setDomain(provDomainSub)
                .setService(provSvc).setTenant(tenantDomainName)
                .setRoles(roleActions).setResourceGroup("set1");

        zmsImpl.putTenantResourceGroupRoles(ctx, provDomainSub, provSvc, tenantDomainName,
                "set1", auditRef, tenantRoles);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(4, ddc.getPolicyCount());
        assertEquals(9, ddc.getAssertionCount());
        assertEquals(1, ddc.getDanglingRoles().size());
        assertEquals(2, ddc.getDanglingPolicies().size());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        ddc = zmsImpl.getDomainDataCheck(ctx, provDomainSub);
        assertNotNull(ddc);
        assertEquals(5, ddc.getPolicyCount());
        assertEquals(5, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertNull(ddc.getDanglingPolicies());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNotNull(ddc.getTenantsWithoutAssumeRole());

        // test provider should report tenant is missing
        // remove the assume_role policies from the tenant
        zmsImpl.deleteTenancy(ctx, tenantDomainName, provDomainSub + "." + provSvc, auditRef);

        ddc = zmsImpl.getDomainDataCheck(ctx, provDomainSub);
        assertNotNull(ddc);
        assertEquals(5, ddc.getPolicyCount());
        assertEquals(5, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertNull(ddc.getDanglingPolicies());
        assertNull(ddc.getProvidersWithoutTrust());
        assertEquals(1, ddc.getTenantsWithoutAssumeRole().size());

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(3, ddc.getPolicyCount());
        assertEquals(6, ddc.getAssertionCount());
        assertEquals(2, ddc.getDanglingRoles().size());
        assertEquals(2, ddc.getDanglingPolicies().size());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // test service name with resource group
        // setup up the top level domain+service with resource group
        String provSvcTop = "shelter";
        service = zmsTestInitializer.createServiceObject(
                provDomainTop, provSvcTop, provEndPoint,
                "/usr/bin/java", "root", "users", "localhost");

        zmsImpl.putServiceIdentity(ctx, provDomainTop, provSvcTop, auditRef, false, null, service);

        TenantResourceGroupRoles tenantGroupRoles = new TenantResourceGroupRoles()
                .setDomain(provDomainTop)
                .setService(provSvcTop).setTenant(tenantDomainName)
                .setRoles(roleActions).setResourceGroup("ravers");
        // put the trust roles with resource group into top level provider domain
        // - tenant is not yet supporting the top level domain
        zmsImpl.putTenantResourceGroupRoles(ctx, provDomainTop, provSvcTop, tenantDomainName, "ravers",
                auditRef, tenantGroupRoles);

        ddc = zmsImpl.getDomainDataCheck(ctx, provDomainTop);
        assertNotNull(ddc);
        assertEquals(5, ddc.getPolicyCount());
        assertEquals(5, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertNull(ddc.getDanglingPolicies());
        assertNull(ddc.getProvidersWithoutTrust());
        assertEquals(1, ddc.getTenantsWithoutAssumeRole().size());

        // now set up the tenant for the subdomain provider
        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(provDomainSub).setService(provSvc)
                .setTenant(tenantDomainName).setRoles(roleActions)
                .setResourceGroup("ravers");
        // this sets up the assume roles in the tenant for the subdomain
        // if it is an authorized service, then it will setup the provider roles too
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomainName, provDomainSub, provSvc,
                "ravers", auditRef, providerRoles);

        // tenant sees that the subdomain provider isn't provisioned yet
        // for the resource group: testgetdomaindatacheckprovider.sub.storage.ravers
        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc, ddc.toString());
        assertEquals(7, ddc.getPolicyCount());
        assertEquals(12, ddc.getAssertionCount());
        assertEquals(1, ddc.getDanglingRoles().size());
        assertEquals(2, ddc.getDanglingPolicies().size());
        assertEquals(1, ddc.getProvidersWithoutTrust().size());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // setup tenancy in the tenant domain for the provider subdomain
        zmsImpl.putTenancy(ctx, tenantDomainName, provDomainSub + "." + provSvc, auditRef, tenant);

        // the subdomain provider believes it is in sync with tenant
        ddc = zmsImpl.getDomainDataCheck(ctx, provDomainSub);
        assertNotNull(ddc);
        assertEquals(5, ddc.getPolicyCount());
        assertEquals(5, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertNull(ddc.getDanglingPolicies());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNotNull(ddc.getTenantsWithoutAssumeRole());

        // but the tenant sees the sub provider is not setup
        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(7, ddc.getPolicyCount());
        assertEquals(12, ddc.getAssertionCount());
        assertEquals(1, ddc.getDanglingRoles().size());
        assertEquals(2, ddc.getDanglingPolicies().size());
        assertEquals(1, ddc.getProvidersWithoutTrust().size());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // now set up the subdomain provider for the tenant with resource groups
        // so tenant and the subdomain provider are in sync again
        // add resource groups to provider
        tenantGroupRoles = new TenantResourceGroupRoles()
                .setDomain(provDomainSub)
                .setService(provSvc).setTenant(tenantDomainName)
                .setRoles(roleActions).setResourceGroup("ravers");
        // put the trust roles into subdomain provider
        zmsImpl.putTenantResourceGroupRoles(ctx, provDomainSub, provSvc, tenantDomainName, "ravers",
                auditRef, tenantGroupRoles);

        // now tenant sees the subdomain has provisioned it
        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(7, ddc.getPolicyCount());
        assertEquals(12, ddc.getAssertionCount());
        assertEquals(1, ddc.getDanglingRoles().size());
        assertEquals(2, ddc.getDanglingPolicies().size());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // now set up the tenant for the top level domain provider
        // so tenant and the top level domain provider are in sync again
        providerRoles = new ProviderResourceGroupRoles()
                .setDomain(provDomainTop).setService(provSvcTop)
                .setTenant(tenantDomainName).setRoles(roleActions)
                .setResourceGroup("ravers");
        // this sets up the assume roles in the tenant for the top level domain
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomainName, provDomainTop, provSvcTop,
                "ravers", auditRef, providerRoles);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(11, ddc.getPolicyCount());
        assertEquals(18, ddc.getAssertionCount());
        assertEquals(1, ddc.getDanglingRoles().size());
        assertEquals(2, ddc.getDanglingPolicies().size());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // delete the resource group tenancy support from subdomain
        // this means the tenant domain should show both the subdomain and
        // the top domain is without trust roles
        zmsImpl.deleteTenantResourceGroupRoles(ctx, provDomainSub, provSvc,
                tenantDomainName, "ravers", auditRef);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(11, ddc.getPolicyCount());
        assertEquals(18, ddc.getAssertionCount());
        assertEquals(1, ddc.getDanglingRoles().size());
        assertEquals(2, ddc.getDanglingPolicies().size());
        assertEquals(1, ddc.getProvidersWithoutTrust().size());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // delete the dangling policies and dangling role
        zmsImpl.deletePolicy(ctx, tenantDomainName, "Policy2", auditRef, null);
        zmsImpl.deleteRole(ctx, tenantDomainName, "Role3", auditRef, null);
        zmsImpl.deleteRole(ctx, tenantDomainName, "Role2", auditRef, null);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(10, ddc.getPolicyCount());
        assertEquals(14, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertNull(ddc.getDanglingPolicies());
        assertEquals(1, ddc.getProvidersWithoutTrust().size());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // add the tenancy support for top domain
        // - now tenant will see that it is all setup
        tenantRoles = new TenantResourceGroupRoles().setDomain(provDomainTop)
                .setService(provSvcTop).setTenant(tenantDomainName)
                .setRoles(roleActions).setResourceGroup("set1");

        zmsImpl.putTenantResourceGroupRoles(ctx, provDomainTop, provSvcTop,
                tenantDomainName, "set1", auditRef, tenantRoles);

        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(10, ddc.getPolicyCount());
        assertEquals(14, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertNull(ddc.getDanglingPolicies());
        assertEquals(1, ddc.getProvidersWithoutTrust().size());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        // delete the provider resource group roles for the subdomain provider
        // then everything in sync for this tenant
        zmsImpl.deleteProviderResourceGroupRoles(ctx, tenantDomainName, provDomainSub, provSvc,
                "ravers", auditRef);
        ddc = zmsImpl.getDomainDataCheck(ctx, tenantDomainName);
        assertNotNull(ddc);
        assertEquals(7, ddc.getPolicyCount());
        assertEquals(11, ddc.getAssertionCount());
        assertNull(ddc.getDanglingRoles());
        assertNull(ddc.getDanglingPolicies());
        assertNull(ddc.getProvidersWithoutTrust());
        assertNull(ddc.getTenantsWithoutAssumeRole());

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomainName, auditRef, null);
        zmsImpl.deleteSubDomain(ctx, provDomainTop, "sub", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, provDomainTop, auditRef, null);
    }

    @Test
    public void testGetServicePrincipal() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        PrivateKey privateKey = Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey()));
        SimpleServiceIdentityProvider provider = new SimpleServiceIdentityProvider("coretech",
                "storage", privateKey, "0");

        Principal testPrincipal = provider.getIdentity("coretech", "storage");
        assertNotNull(testPrincipal);
        ResourceContext rsrcCtxTest = zmsTestInitializer.createResourceContext(testPrincipal);
        ServicePrincipal principal = zmsImpl.getServicePrincipal(rsrcCtxTest);
        assertNotNull(principal);
        assertEquals("storage", principal.getService());
        assertEquals("coretech", principal.getDomain());
    }

    @Test
    public void testGetServicePrincipalAuthorityNoAuthz() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        PrivateKey privateKey = Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey()));
        Authority authority = new UserAuthority();
        SimpleServiceIdentityProvider provider = new SimpleServiceIdentityProvider(authority,
                "user", "test1", privateKey, "0", 3600);

        Principal testPrincipal = provider.getIdentity("user", "test1");
        assertNotNull(testPrincipal);
        ResourceContext rsrcCtxTest = zmsTestInitializer.createResourceContext(testPrincipal);
        ServicePrincipal principal = zmsImpl.getServicePrincipal(rsrcCtxTest);
        assertNotNull(principal);
        assertEquals("test1", principal.getService());
        assertEquals("user", principal.getDomain());
    }

    @Test
    public void testEmitMonmetricError() {
        int errorCode = 403;
        String caller = "forbiddenError";
        boolean isEmitMonmetricError;

        // negative tests
        isEmitMonmetricError = ZMSUtils.emitMonmetricError(errorCode, null);
        assertFalse(isEmitMonmetricError);

        isEmitMonmetricError = ZMSUtils.emitMonmetricError(errorCode, "");
        assertFalse(isEmitMonmetricError);

        isEmitMonmetricError = ZMSUtils.emitMonmetricError(0, caller);
        assertFalse(isEmitMonmetricError);

        isEmitMonmetricError = ZMSUtils.emitMonmetricError(-100, caller);
        assertFalse(isEmitMonmetricError);

        // positive tests
        isEmitMonmetricError = ZMSUtils.emitMonmetricError(errorCode, caller);
        assertTrue(isEmitMonmetricError);

        isEmitMonmetricError = ZMSUtils.emitMonmetricError(errorCode, " " + caller + " ");
        assertTrue(isEmitMonmetricError);
    }

    @Test
    public void testValidateRoleBasedAccessCheckTrustDomain() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.validateRoleBasedAccessCheck(Collections.emptyList(), "trustdomain",
                "domain1", "domain1"));
    }

    @Test
    public void testValidateRoleBasedAccessCheckMismatchNames() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        List<String> roles = new ArrayList<>();
        roles.add("readers");
        assertFalse(zmsImpl.validateRoleBasedAccessCheck(roles, null, "domain1", "domain2"));

        roles = new ArrayList<>();
        roles.add("domain1:role.readers");
        roles.add("domain2:role.readers");
        assertFalse(zmsImpl.validateRoleBasedAccessCheck(roles, null, "domain1", "domain1"));
    }

    @Test
    public void testValidateRoleBasedAccessCheckValid() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        assertTrue(zmsImpl.validateRoleBasedAccessCheck(Collections.emptyList(), null, "domain1", "domain1"));

        List<String> roles = new ArrayList<>();
        roles.add("readers");
        assertTrue(zmsImpl.validateRoleBasedAccessCheck(roles, null, "domain1", "domain1"));

        roles = new ArrayList<>();
        roles.add("domain1:role.readers");
        roles.add("domain1:role.writers");
        assertTrue(zmsImpl.validateRoleBasedAccessCheck(roles, null, "domain1", "domain1"));
        assertTrue(zmsImpl.validateRoleBasedAccessCheck(roles, null, "domain1", "domain2"));
    }

    @Test
    public void testIsVirtualDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        assertTrue(zmsImpl.isVirtualDomain("user.user1"));
        assertTrue(zmsImpl.isVirtualDomain("user.user2"));
        assertTrue(zmsImpl.isVirtualDomain("user.user1.sub1"));
        assertTrue(zmsImpl.isVirtualDomain("user.user1.sub2.sub3"));

        assertFalse(zmsImpl.isVirtualDomain("user"));
        assertFalse(zmsImpl.isVirtualDomain("usertest"));
        assertFalse(zmsImpl.isVirtualDomain("coretech.api"));
    }

    @Test
    public void testHasExceededVirtualSubDomainLimitUnderLimitOneLevel() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT, "2");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain dom = zmsTestInitializer.createSubDomainObject("user1", "user",
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        Domain resDom = zmsTest.postSubDomain(ctx, "user", auditRef, null, dom);
        assertNotNull(resDom);

        assertFalse(zmsTest.hasExceededVirtualSubDomainLimit("user.user1"));

        dom = zmsTestInitializer.createSubDomainObject("sub1", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        assertFalse(zmsTest.hasExceededVirtualSubDomainLimit("user.user1"));

        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT);
    }

    @Test
    public void testHasExceededVirtualSubDomainLimitOverLimitOneLevel() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT, "2");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain dom = zmsTestInitializer.createSubDomainObject("user1", "user",
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        Domain resDom = zmsTest.postSubDomain(ctx, "user", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub1", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub2", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        assertTrue(zmsTest.hasExceededVirtualSubDomainLimit("user.user1"));

        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub2", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT);
    }

    @Test
    public void testHasExceededVirtualSubDomainLimitUnderLimitMultipleLevel() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT, "3");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain dom = zmsTestInitializer.createSubDomainObject("user1", "user",
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        Domain resDom = zmsTest.postSubDomain(ctx, "user", auditRef, null, dom);
        assertNotNull(resDom);

        assertFalse(zmsTest.hasExceededVirtualSubDomainLimit("user.user1"));

        dom = zmsTestInitializer.createSubDomainObject("sub1", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        resDom = zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub2", "user.user1.sub1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsImpl.postSubDomain(ctx, "user.user1.sub1", auditRef, null, dom);
        assertNotNull(resDom);

        assertFalse(zmsTest.hasExceededVirtualSubDomainLimit("user.user1.sub1"));

        zmsImpl.deleteSubDomain(ctx, "user.user1.sub1", "sub2", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT);
    }

    @Test
    public void testHasExceededVirtualSubDomainLimitOverLimitMultipleLevel() {

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT, "2");
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain dom = zmsTestInitializer.createSubDomainObject("user1", "user",
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        Domain resDom = zmsTest.postSubDomain(ctx, "user", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub1", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        resDom = zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, dom);
        assertNotNull(resDom);

        dom = zmsTestInitializer.createSubDomainObject("sub2", "user.user1.sub1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        resDom = zmsImpl.postSubDomain(ctx, "user.user1.sub1", auditRef, null, dom);
        assertNotNull(resDom);

        assertTrue(zmsTest.hasExceededVirtualSubDomainLimit("user.user1.sub1"));
        assertTrue(zmsTest.hasExceededVirtualSubDomainLimit("user.user1"));

        zmsImpl.deleteSubDomain(ctx, "user.user1.sub1", "sub2", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user.user1", "sub1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT);
    }

    @Test
    public void testGetNormalizedMemberNoSplit() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user"), "user.user");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user2"), "user.user2");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user1"), "user.user1");
        assertEquals(zmsImpl.normalizeDomainAliasUser("coretech.storage"), "coretech.storage");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user1"), "user1");
    }

    @Test
    public void testGetNormalizedMemberInvalidFormat() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        assertEquals(zmsImpl.normalizeDomainAliasUser("user:user:user1"), "user:user:user1");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user:"), "user:");
        assertEquals(zmsImpl.normalizeDomainAliasUser("coretech:storage:api"), "coretech:storage:api");
    }

    @Test
    public void testGetNormalizedMemberUsersWithSplit() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user"), "user.user");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user2"), "user.user2");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user1"), "user.user1");
    }

    @Test
    public void testGetNormalizedMemberServiceWithSplit() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        assertEquals(zmsImpl.normalizeDomainAliasUser("coretech.storage"), "coretech.storage");
        assertEquals(zmsImpl.normalizeDomainAliasUser("weather.storage.api"), "weather.storage.api");
        assertEquals(zmsImpl.normalizeDomainAliasUser("weather.entity.api"), "weather.entity.api");
        assertEquals(zmsImpl.normalizeDomainAliasUser("weather.storage.service.*"), "weather.storage.service.*");
    }

    @Test
    public void testGetNormalizedMemberAliasDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.userDomain = "user";
        zmsImpl.userDomainPrefix = "user.";
        zmsImpl.userDomainAlias = null;
        zmsImpl.userDomainAliasPrefix = null;

        assertEquals(zmsImpl.normalizeDomainAliasUser("user-alias.user1"), "user-alias.user1");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user-alias.user1.svc"), "user-alias.user1.svc");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user1"), "user.user1");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user1.svc"), "user.user1.svc");

        zmsImpl.userDomainAlias = "user-alias";
        zmsImpl.userDomainAliasPrefix = "user-alias.";
        assertEquals(zmsImpl.normalizeDomainAliasUser("user-alias.user1"), "user.user1");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user-alias.user1.svc"), "user-alias.user1.svc");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user1"), "user.user1");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user1.svc"), "user.user1.svc");

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testNormalizeRoleMembersCombined() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        ArrayList<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user.jane"));
        roleMembers.add(new RoleMember().setMemberName("coretech.storage"));
        roleMembers.add(new RoleMember().setMemberName("coretech.storage"));
        roleMembers.add(new RoleMember().setMemberName("weather.storage"));
        roleMembers.add(new RoleMember().setMemberName("weather.api.access"));

        ArrayList<String> membersList = new ArrayList<>();
        membersList.add("coretech.storage");
        membersList.add("user.john");

        Role role = zmsTestInitializer.createRoleObject("TestRole", "Role1", null, roleMembers);
        role.setMembers(membersList);

        zmsImpl.normalizeRoleMembers(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 6);

        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        checkList.add("user.john");
        checkList.add("weather.api.access");
        checkList.add("coretech.storage");
        checkList.add("weather.storage");
        zmsTestInitializer.checkRoleMember(checkList, members);
    }

    @Test
    public void testNormalizeRoleMembersInvalid() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        ArrayList<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        roleMembers.add(new RoleMember().setMemberName("user2"));

        Role role = zmsTestInitializer.createRoleObject("TestRole", "Role1", null, roleMembers);
        zmsImpl.normalizeRoleMembers(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);

        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user2");
        zmsTestInitializer.checkRoleMember(checkList, members);
    }

    @Test
    public void testHasExceededListLimitNullLimit() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.hasExceededListLimit(null, 10));
    }

    @Test
    public void testHasExceededListLimitNotValidLimit() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.hasExceededListLimit(0, 10));
        assertFalse(zmsImpl.hasExceededListLimit(-1, 10));
    }

    @Test
    public void testHasExceededListLimitYes() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.hasExceededListLimit(10, 11));
    }

    @Test
    public void testHasExceededListLimitNo() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.hasExceededListLimit(10, 9));
        assertFalse(zmsImpl.hasExceededListLimit(10, 10));
    }

    @Test
    public void testVerifyServicePublicKeysNoKeys() {

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName("ServiceAddInvalidCertDom1", "Service1"));

        // New Service need not have any public keys
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.verifyServicePublicKeys(service));
    }

    @Test
    public void testVerifyServicePublicKeysInvalidPublicKeys() {

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName("ServiceDom1", "Service1"));

        List<PublicKeyEntry> publicKeyList = new ArrayList<>();
        PublicKeyEntry publicKeyEntry1 = new PublicKeyEntry();
        publicKeyEntry1.setKey("LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlHZk1BMEdDU3FHU0liM0RRRUJBUVVBQTRHTk");
        publicKeyEntry1.setId("1");
        publicKeyList.add(publicKeyEntry1);
        service.setPublicKeys(publicKeyList);

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.verifyServicePublicKeys(service));
    }

    @Test
    public void testVerifyServicePublicKeyInvalidPublicKey() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.verifyServicePublicKey("LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlHZk1B"));
        assertFalse(zmsImpl.verifyServicePublicKey("LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlHZk1BMEdDU3FHU0liM0RRRUJBUVVBQTRHTk"));
        assertFalse(zmsImpl.verifyServicePublicKey(zmsTestInitializer.getPrivKeyK1()));
        assertFalse(zmsImpl.verifyServicePublicKey(zmsTestInitializer.getPrivKeyK2()));
    }

    @Test
    public void testVerifyServicePublicKeyValidPublicKey() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.verifyServicePublicKey(zmsTestInitializer.getPubKeyK1()));
        assertTrue(zmsImpl.verifyServicePublicKey(zmsTestInitializer.getPubKeyK2()));
    }

    @Test
    public void testVerifyServicePublicKeysValidKeysOnly() {
        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceAddDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.verifyServicePublicKeys(service));
    }

    @Test
    public void testIsValidUserTokenRequestNoAuthority() {
        Principal principal = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature");
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.isValidUserTokenRequest(principal, "user1"));
    }

    @Test
    public void testIsValidUserTokenRequestNotuserAuthority() {
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature",
                0, principalAuthority);

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.isValidUserTokenRequest(principal, "user1"));
    }

    @Test
    public void testIsValidUserTokenRequestNullPrincipal() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.isValidUserTokenRequest(null, "user1"));
    }

    @Test
    public void testMatchPrincipalInRoleStdMemberMatch() {

        Role role = zmsTestInitializer.createRoleObject("weather",  "Role", null, "user.user2", null);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.matchPrincipalInRole(role, null, "user.user2", null));
    }

    @Test
    public void testMatchPrincipalInRoleStdMemberNoMatch() {

        Role role = zmsTestInitializer.createRoleObject("weather",  "Role", null, "user.user2", null);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.matchPrincipalInRole(role, null, "user.user23", null));
    }

    @Test
    public void testMatchPrincipalInRoleNoDelegatedTrust() {
        Role role = zmsTestInitializer.createRoleObject("weather",  "Role", null);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.matchPrincipalInRole(role, null, null, null));
        assertFalse(zmsImpl.matchPrincipalInRole(role, null, null, "weather"));
    }

    @Test
    public void testMatchPrincipalInRoleDelegatedTrustNoMatch() {
        Role role = zmsTestInitializer.createRoleObject("weather",  "Role", "coretech_not_present");
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.matchPrincipalInRole(role, "Role", "user.user1", "coretech_not_present"));
    }

    @Test
    public void testMatchPrincipalInRoleDelegatedTrustMatch() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "coretechtrust";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.user2");
        zmsImpl.dbService.makeDomain(ctx, ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org",
                true, null, 0, null, 0), adminUsers, null, auditRef);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "trust", "coretechtrust:role.role1",
                false, "ASSUME_ROLE", "weather:role.role1", AssertionEffect.ALLOW);
        zmsImpl.dbService.executePutPolicy(ctx, domainName, "trust",
                policy, auditRef, "unitTest", false);

        Role role1 = zmsTestInitializer.createRoleObject(domainName,  "role1", null, "user.user1", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role1",
                role1, auditRef, "unittest", false);

        Role role2 = zmsTestInitializer.createRoleObject(domainName,  "role2", null, "user.user2", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role2",
                role2, auditRef, "unittest", false);

        Role role = zmsTestInitializer.createRoleObject("weather",  "role1", domainName);
        assertTrue(zmsImpl.matchPrincipalInRole(role, "weather:role.role1", "user.user1", "coretechtrust"));
        assertFalse(zmsImpl.matchPrincipalInRole(role, "weather:role.role1", "user.user1", "coretechtrust2"));
        assertFalse(zmsImpl.matchPrincipalInRole(role, "weather:role.role1", "user.user3", "coretechtrust"));
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName, auditRef, "unittest");
    }

    @Test
    public void testProcessListRequestNoCollection() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "listrequest";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.user");
        zmsImpl.dbService.makeDomain(ctx, ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org",
                true, null, 0, null, 0), adminUsers, null, auditRef);

        Role role1 = zmsTestInitializer.createRoleObject(domainName,  "role1", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role1",
                role1, auditRef, "unittest", false);

        Role role2 = zmsTestInitializer.createRoleObject(domainName,  "role2", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role2",
                role2, auditRef, "unittest", false);

        Role role3 = zmsTestInitializer.createRoleObject(domainName,  "role3", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role3",
                role3, auditRef, "unittest", false);

        zmsImpl.dbService.executeDeletePolicy(ctx, domainName, "admin", auditRef, "unittest");

        List<String> names = new ArrayList<>(zmsImpl.dbService.listPolicies(domainName));
        assertNull(zmsImpl.processListRequest(null, null, names));
        assertEquals(names.size(), 0);
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName, auditRef, "unittest");
    }

    @Test
    public void testProcessListRequestCollectionEmpty() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "listrequest";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.user");
        zmsImpl.dbService.makeDomain(ctx, ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org",
                true, null, 0, null, 0), adminUsers, null, auditRef);

        zmsImpl.dbService.executeDeleteRole(ctx, domainName, "admin", auditRef, "unittest");

        List<String> names = new ArrayList<>(zmsImpl.dbService.listRoles(domainName));
        assertNull(zmsImpl.processListRequest(null, null, names));
        assertEquals(names.size(), 0);
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName, auditRef, "unittest");
    }

    @Test
    public void testProcessListRequestSkipNoMatch() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "listrequestskipnomatch";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.user");
        zmsImpl.dbService.makeDomain(ctx, ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org",
                true, null, 0, null, 0), adminUsers, null, auditRef);

        Role role1 = zmsTestInitializer.createRoleObject(domainName,  "role1", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role1",
                role1, auditRef, "unittest", false);

        Role role2 = zmsTestInitializer.createRoleObject(domainName,  "role2", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role2",
                role2, auditRef, "unittest", false);

        Role role3 = zmsTestInitializer.createRoleObject(domainName,  "role3", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role3",
                role3, auditRef, "unittest", false);

        List<String> names = new ArrayList<>(zmsImpl.dbService.listRoles(domainName));
        assertNull(zmsImpl.processListRequest(null, "role4", names));

        // our response is going to get the admin role

        assertEquals(4, names.size());
        assertTrue(names.contains("admin"));
        assertTrue(names.contains("role1"));
        assertTrue(names.contains("role2"));
        assertTrue(names.contains("role3"));
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName, auditRef, "unittest");
    }

    @Test
    public void testProcessListRequestSkipMatch() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "listrequestskipmatch";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.user");
        zmsImpl.dbService.makeDomain(ctx, ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org",
                true, null, 0, null, 0), adminUsers, null, auditRef);

        Role role1 = zmsTestInitializer.createRoleObject(domainName,  "role1", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role1",
                role1, auditRef, "unittest", false);

        Role role2 = zmsTestInitializer.createRoleObject(domainName,  "role2", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role2",
                role2, auditRef, "unittest", false);

        Role role3 = zmsTestInitializer.createRoleObject(domainName,  "role3", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role3",
                role3, auditRef, "unittest", false);

        List<String> names = new ArrayList<>(zmsImpl.dbService.listRoles(domainName));
        assertNull(zmsImpl.processListRequest(null, "role2", names));
        assertEquals(names.size(), 1);
        assertTrue(names.contains("role3"));
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName, auditRef, "unittest");
    }

    @Test
    public void testProcessListRequestLimitExceeded() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "listrequestlimitexceeded";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.user");
        zmsImpl.dbService.makeDomain(ctx, ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org",
                true, null, 0, null, 0), adminUsers, null, auditRef);

        Role role1 = zmsTestInitializer.createRoleObject(domainName,  "role1", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role1",
                role1, auditRef, "unittest", false);

        Role role2 = zmsTestInitializer.createRoleObject(domainName,  "role2", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role2",
                role2, auditRef, "unittest", false);

        Role role3 = zmsTestInitializer.createRoleObject(domainName,  "role3", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role3",
                role3, auditRef, "unittest", false);

        List<String> names = new ArrayList<>(zmsImpl.dbService.listRoles(domainName));
        String next = zmsImpl.processListRequest(2, null, names);
        assertEquals("role1", next);
        assertEquals(2, names.size());
        assertTrue(names.contains("admin"));
        assertTrue(names.contains("role1"));
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName, auditRef, "unittest");
    }

    @Test
    public void testProcessListRequestLimitNotExceeded() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "listrequestlimitnotexceeded";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.user");
        zmsImpl.dbService.makeDomain(ctx, ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org",
                true, null, 0, null, 0), adminUsers, null, auditRef);

        Role role1 = zmsTestInitializer.createRoleObject(domainName,  "role1", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role1",
                role1, auditRef, "unittest", false);

        Role role2 = zmsTestInitializer.createRoleObject(domainName,  "role2", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role2",
                role2, auditRef, "unittest", false);

        Role role3 = zmsTestInitializer.createRoleObject(domainName,  "role3", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role3",
                role3, auditRef, "unittest", false);

        List<String> names = new ArrayList<>(zmsImpl.dbService.listRoles(domainName));
        zmsImpl.processListRequest(5, null, names);

        // make sure to account for the admin role

        assertEquals(4, names.size());
        assertTrue(names.contains("admin"));
        assertTrue(names.contains("role1"));
        assertTrue(names.contains("role2"));
        assertTrue(names.contains("role3"));
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName, auditRef, "unittest");
    }

    @Test
    public void testProcessListRequestLimitAndSkip() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "listrequestlimitandskip";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.user");
        zmsImpl.dbService.makeDomain(ctx, ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org",
                true, null, 0, null, 0), adminUsers, null, auditRef);

        Role role1 = zmsTestInitializer.createRoleObject(domainName,  "role1", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role1",
                role1, auditRef, "unittest", false);

        Role role2 = zmsTestInitializer.createRoleObject(domainName,  "role2", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role2",
                role2, auditRef, "unittest", false);

        Role role3 = zmsTestInitializer.createRoleObject(domainName,  "role3", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role3",
                role3, auditRef, "unittest", false);

        Role role4 = zmsTestInitializer.createRoleObject(domainName,  "role4", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role4",
                role4, auditRef, "unittest", false);

        Role role5 = zmsTestInitializer.createRoleObject(domainName,  "role5", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role5",
                role5, auditRef, "unittest", false);

        List<String> names = new ArrayList<>(zmsImpl.dbService.listRoles(domainName));
        String next = zmsImpl.processListRequest(2, "role2", names);
        assertEquals(next, "role4");
        assertEquals(names.size(), 2);
        assertTrue(names.contains("role3"));
        assertTrue(names.contains("role4"));
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName, auditRef, "unittest");
    }

    @Test
    public void testProcessListRequestLimitAndSkipLessThanLimitLeft() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "listrequestlimitskiplessthanlimitleft";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.user");
        zmsImpl.dbService.makeDomain(ctx, ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org",
                true, null, 0, null, 0), adminUsers, null, auditRef);

        Role role1 = zmsTestInitializer.createRoleObject(domainName,  "role1", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role1",
                role1, auditRef, "unittest", false);

        Role role2 = zmsTestInitializer.createRoleObject(domainName,  "role2", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role2",
                role2, auditRef, "unittest", false);

        Role role3 = zmsTestInitializer.createRoleObject(domainName,  "role3", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role3",
                role3, auditRef, "unittest", false);

        Role role4 = zmsTestInitializer.createRoleObject(domainName,  "role4", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role4",
                role4, auditRef, "unittest", false);

        Role role5 = zmsTestInitializer.createRoleObject(domainName,  "role5", null, "user.user", null);
        zmsImpl.dbService.executePutRole(ctx, domainName, "role5",
                role5, auditRef, "unittest", false);

        List<String> names = new ArrayList<>(zmsImpl.dbService.listRoles(domainName));
        assertNull(zmsImpl.processListRequest(2, "role4", names));
        assertEquals(names.size(), 1);
        assertTrue(names.contains("role5"));
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName, auditRef, "unittest");
    }

    @Test
    public void testAccessInvalidResourceDomain() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Principal principal = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature");
        try {
            zmsImpl.access("read", "domain:invalid:entity", principal, null);
            fail();
        } catch (com.yahoo.athenz.common.server.rest.ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }
    }

    @Test
    public void testHasAccessInvalidRoleTokenAccess() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "coretech";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        List<String> authRoles = new ArrayList<>();
        authRoles.add("role1");
        Principal principal = SimplePrincipal.create(domainName, "v=U1;d=user;n=user1;s=signature", authRoles, null);
        assertNotNull(principal);
        AthenzDomain domain = zmsImpl.retrieveAccessDomain(domainName, principal);
        assertEquals(zmsImpl.hasAccess(domain, "read", domainName + ":entity", principal, "trustdomain"),
                AccessStatus.DENIED_INVALID_ROLE_TOKEN);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testAccessNotFoundDomain() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Principal principal = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature");
        try {
            zmsImpl.access("read", "domain_not_found:entity", principal, null);
            fail();
        } catch (com.yahoo.athenz.common.server.rest.ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }
    }

    @Test
    public void testHasAccessValidMember() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("HasAccessDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("HasAccessDom1", "Role1", null, "user.user1",
                "user.user3");
        zmsImpl.putRole(ctx, "HasAccessDom1", "Role1", auditRef, false, null, role1);

        Policy policy1 = zmsTestInitializer.createPolicyObject("HasAccessDom1", "Policy1", "Role1",
                "UPDATE", "HasAccessDom1:resource1", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "HasAccessDom1", "Policy1", auditRef, false, null, policy1);

        // user1 and user3 have access to UPDATE/resource1

        Principal principal1 = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature");
        AthenzDomain domain = zmsImpl.retrieveAccessDomain("hasaccessdom1", principal1);

        assertEquals(zmsImpl.hasAccess(domain, "update", "hasaccessdom1:resource1",
                principal1, null), AccessStatus.ALLOWED);

        Principal principal3 = SimplePrincipal.create("user", "user3", "v=U1;d=user;n=user3;s=signature");
        assertEquals(zmsImpl.hasAccess(domain, "update", "hasaccessdom1:resource1",
                principal3, null), AccessStatus.ALLOWED);

        zmsImpl.deleteTopLevelDomain(ctx, "HasAccessDom1", auditRef, null);
    }

    @Test
    public void testHasAccessInValidMember() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("HasAccessDom2",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("HasAccessDom2", "Role1", null, "user.user1",
                "user.user3");
        zmsImpl.putRole(ctx, "HasAccessDom2", "Role1", auditRef, false, null, role1);

        Policy policy1 = zmsTestInitializer.createPolicyObject("HasAccessDom2", "Policy1", "Role1",
                "UPDATE", "HasAccessDom2:resource1", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, "HasAccessDom2", "Policy1", auditRef, false, null, policy1);

        // user2 does not have access to UPDATE/resource1

        Principal principal2 = SimplePrincipal.create("user", "user2", "v=U1;d=user;n=user2;s=signature");

        // this is internal zms function so the values passed have already been converted to lower
        // case so we need to handle the test case accordingly.

        AthenzDomain domain = zmsImpl.retrieveAccessDomain("hasaccessdom2", principal2);
        assertEquals(AccessStatus.DENIED, zmsImpl.hasAccess(domain, "update",
                "hasaccessdom2:resource1", principal2, null));
        zmsImpl.deleteTopLevelDomain(ctx, "HasAccessDom2", auditRef, null);
    }

    @Test
    public void testEvaluateAccessNoAssertions() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        AthenzDomain domain = new AthenzDomain("coretech");
        Role role = new Role().setName("coretech:role.role1");
        domain.getRoles().add(role);
        Policy policy = new Policy().setName("coretech:policy.policy1");
        domain.getPolicies().add(policy);
        assertEquals(zmsImpl.evaluateAccess(domain, null, null, null, null, null, zmsTestInitializer.getMockDomRestRsrcCtx().principal()), AccessStatus.DENIED);
    }

    @Test
    public void testEvaluateAccessAssertionDeny() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        AthenzDomain domain = new AthenzDomain("coretech");
        Role role = zmsTestInitializer.createRoleObject("coretech", "role1", null, "user.user1", null);
        domain.getRoles().add(role);

        Policy policy = new Policy().setName("coretech:policy.policy1");
        Assertion assertion = new Assertion();
        assertion.setAction("read");
        assertion.setEffect(AssertionEffect.DENY);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.role1");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);
        domain.getPolicies().add(policy);

        assertEquals(zmsImpl.evaluateAccess(domain, "user.user1", "read", "coretech:resource1",
                null, null, zmsTestInitializer.getMockDomRestRsrcCtx().principal()), AccessStatus.DENIED);
    }

    @Test
    public void testEvaluateAccessAssertionDenyCaseSensitive() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        AthenzDomain domain = new AthenzDomain("coretech");
        Role role = zmsTestInitializer.createRoleObject("coretech", "role1", null, "user.user1", null);
        domain.getRoles().add(role);

        Policy policy = new Policy().setName("coretech:policy.policy1");
        Assertion assertion = new Assertion();
        assertion.setAction("ReaD");
        assertion.setEffect(AssertionEffect.DENY);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.role1");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);
        domain.getPolicies().add(policy);

        ZMSImpl spiedZms = Mockito.spy(zmsImpl);
        assertEquals(spiedZms.evaluateAccess(domain, "user.user1", "read", "coretech:resource1",
                null, null, zmsTestInitializer.getMockDomRestRsrcCtx().principal()), AccessStatus.DENIED);

        // Verify that it was denied by explicit "Deny" assertion and not because no match was found
        verify(spiedZms, times(1)).matchPrincipal(
                eq(domain.getRoles()),
                eq("^coretech:role\\.role1$"),
                eq("user.user1"),
                eq(null));
    }

    @Test
    public void testEvaluateAccessAssertionAllow() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        AthenzDomain domain = new AthenzDomain("coretech");
        Role role = zmsTestInitializer.createRoleObject("coretech", "role1", null, "user.user1", null);
        domain.getRoles().add(role);

        Policy policy = new Policy().setName("coretech:policy.policy1");
        Assertion assertion = new Assertion();
        assertion.setAction("read");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.role1");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);
        domain.getPolicies().add(policy);

        assertEquals(zmsImpl.evaluateAccess(domain, "user.user1", "read", "coretech:resource1", null, null,
                zmsTestInitializer.getMockDomRestRsrcCtx().principal()), AccessStatus.ALLOWED);
    }

    @Test
    public void testEvaluateAccessAssertionAllowNotActive() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        AthenzDomain domain = new AthenzDomain("coretech");
        Role role = zmsTestInitializer.createRoleObject("coretech", "role1", null, "user.user1", null);
        domain.getRoles().add(role);

        // we have valid policy that would match however we have the
        // active flag set to false so the policy will be skipped

        Policy policy = new Policy().setName("coretech:policy.policy1").setActive(false);
        Assertion assertion = new Assertion();
        assertion.setAction("read");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.role1");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);
        domain.getPolicies().add(policy);

        assertEquals(zmsImpl.evaluateAccess(domain, "user.user1", "read", "coretech:resource1", null, null,
                zmsTestInitializer.getMockDomRestRsrcCtx().principal()), AccessStatus.DENIED);
    }

    @Test
    public void testEvaluateAccessMtlsRestricted() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        AthenzDomain domain = new AthenzDomain("coretech");
        Role role = zmsTestInitializer.createRoleObject("coretech", "role1", null, "user.user1", null);
        domain.getRoles().add(role);

        Policy policy = new Policy().setName("coretech:policy.policy1");
        Assertion assertion = new Assertion();
        assertion.setAction("read");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.role1");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);
        domain.getPolicies().add(policy);

        Authority certificateAuthority = new CertificateAuthority();
        String unsignedCreds = "v=U1;d=user;n=user2";
        final Principal rsrcPrince = SimplePrincipal.create("user", "user2",
                unsignedCreds + ";s=signature", 0, certificateAuthority);
        assertNotNull(rsrcPrince);

        assertEquals(zmsImpl.evaluateAccess(domain, "user.user1", "read", "coretech:resource1", null, null, rsrcPrince),
                AccessStatus.ALLOWED);
        ((SimplePrincipal)rsrcPrince).setMtlsRestricted(true);
        assertEquals(zmsImpl.evaluateAccess(domain, "user.user1", "read", "coretech:resource1", null, null, rsrcPrince),
                AccessStatus.DENIED);
    }

    @Test
    public void testEvaluateAccessAssertionAllowCaseSensitive() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        AthenzDomain domain = new AthenzDomain("coretech");
        Role role = zmsTestInitializer.createRoleObject("coretech", "role1", null, "user.user1", null);
        domain.getRoles().add(role);

        Policy policy = new Policy().setName("coretech:policy.policy1");
        Assertion assertion = new Assertion();
        assertion.setAction("ReaD");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.role1");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);
        domain.getPolicies().add(policy);

        assertEquals(zmsImpl.evaluateAccess(domain, "user.user1", "read", "coretech:resource1", null, null,
                zmsTestInitializer.getMockDomRestRsrcCtx().principal()), AccessStatus.ALLOWED);
    }

    @Test
    public void testHasExceededDepthLimitNullLimit() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.hasExceededDepthLimit(null, "domain"));
    }

    @Test
    public void testHasExceededDepthLimitNotValidLimit() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.hasExceededDepthLimit(-1, "domain"));
        assertTrue(zmsImpl.hasExceededDepthLimit(-1, "domain.sub1"));
    }

    @Test
    public void testHasExceededDepthLimitYes() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.hasExceededDepthLimit(0, "domain.sub1"));
        assertTrue(zmsImpl.hasExceededDepthLimit(1, "domain.sub1.sub2"));
        assertTrue(zmsImpl.hasExceededDepthLimit(1, "domain.sub1.sub2.sub3"));
        assertTrue(zmsImpl.hasExceededDepthLimit(2, "domain.sub1.sub2.sub3"));
    }

    @Test
    public void testHasExceededDepthLimitNo() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.hasExceededDepthLimit(1, "domain.sub1"));
        assertFalse(zmsImpl.hasExceededDepthLimit(2, "domain.sub1"));
        assertFalse(zmsImpl.hasExceededDepthLimit(2, "domain.sub1.sub2"));
        assertFalse(zmsImpl.hasExceededDepthLimit(3, "domain.sub1.sub2"));
        assertFalse(zmsImpl.hasExceededDepthLimit(3, "domain.sub1.sub2.sub3"));
        assertFalse(zmsImpl.hasExceededDepthLimit(4, "domain.sub1.sub2.sub3"));
    }

    @Test
    public void testIsZMSServiceYes() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.isZMSService("sys.auth", "zms"));
        assertTrue(zmsImpl.isZMSService("sys.Auth", "ZMS"));
        assertTrue(zmsImpl.isZMSService("SYS.AUTH", "ZMS"));
    }

    @Test
    public void testIsZMSServiceNo() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.isZMSService("sys.auth2", "zms"));
        assertFalse(zmsImpl.isZMSService("sys.auth", "zts"));
    }

    @Test
    public void testRetrieveServiceIdentityInvalidServiceName() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceRetrieveDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceRetrieveDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceRetrieveDom1", "Service1", auditRef, false, null, service);

        try {
            zmsImpl.getServiceIdentity(ctx, "ServiceRetrieveDom1", "Service");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }
        try {
            zmsImpl.getServiceIdentity(ctx, "ServiceRetrieveDom1", "Service2");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }
        try {
            zmsImpl.getServiceIdentity(ctx, "ServiceRetrieveDom1", "Service11");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceRetrieveDom1", auditRef, null);
    }

    @Test
    public void testRetrieveServiceIdentityValid() {

        String domainName = "serviceretrievedom2";
        String serviceName = "service1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject(domainName,
                serviceName, "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, domainName, "Service1", auditRef, false, null, service);

        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, domainName, serviceName);
        assertNotNull(serviceRes);
        assertEquals(serviceRes.getName(), domainName + "." + serviceName);
        assertEquals(serviceRes.getExecutable(), "/usr/bin/java");
        assertEquals(serviceRes.getGroup(), "users");
        assertEquals(serviceRes.getUser(), "root");

        // provider endpoint is a system meta attribute so we shouldn't saved it
        assertNull(serviceRes.getProviderEndpoint());

        List<String> hosts = serviceRes.getHosts();
        assertNotNull(hosts);
        assertEquals(hosts.size(), 1);
        assertEquals(hosts.get(0), "host1");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetProviderRoleActionPolicyNotFound() {

        String domainName = "coretech";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        addRoleNeededForTest(domainName, "role1");
        Assertion assertion = new Assertion();
        assertion.setAction("read");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.role1");

        Policy policy = new Policy().setName("coretech:policy.provider");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);

        zmsImpl.putPolicy(ctx, domainName, "provider", auditRef, false, null, policy);

        assertEquals(zmsImpl.getProviderRoleAction(domainName, "policy1"), "");
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetProviderRoleActionAssertionNoMatch() {

        String domainName = "coretech";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        addRoleNeededForTest(domainName, "Role1");
        Assertion assertion = new Assertion();
        assertion.setAction("read");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.role1");

        Policy policy = new Policy().setName("coretech:policy.provider");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);

        zmsImpl.putPolicy(ctx, domainName, "provider", auditRef, false, null, policy);

        assertEquals(zmsImpl.getProviderRoleAction(domainName, "provider"), "");
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetProviderRoleActionNoAssertions() {

        String domainName = "coretech";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = new Policy().setName("coretech:policy.provider");
        policy.setAssertions(new ArrayList<>());

        zmsImpl.putPolicy(ctx, domainName, "provider", auditRef, false, null, policy);

        assertEquals(zmsImpl.getProviderRoleAction(domainName, "provider"), "");
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetProviderRoleActionAssertionActionNull() {

        String domainName = "coretech";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Assertion assertion = new Assertion();
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.provider");

        Policy policy = new Policy().setName("coretech:policy.provider");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);

        try {
            zmsImpl.putPolicy(ctx, domainName, "provider", auditRef, false, null, policy);
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        assertEquals(zmsImpl.getProviderRoleAction(domainName, "provider"), "");
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetProviderRoleActionValid() {

        String domainName = "coretech";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        addRoleNeededForTest(domainName, "provider");
        Assertion assertion = new Assertion();
        assertion.setAction("read");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coretech:*");
        assertion.setRole("coretech:role.provider");

        Policy policy = new Policy().setName("coretech:policy.provider");
        policy.setAssertions(new ArrayList<>());
        policy.getAssertions().add(assertion);

        zmsImpl.putPolicy(ctx, domainName, "provider", auditRef, false, null, policy);

        assertEquals(zmsImpl.getProviderRoleAction(domainName, "provider"), "read");
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testListDomains() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ListDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("ListDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainList domList = zmsImpl.listDomains(null, null, null, null, 0, false);
        assertNotNull(domList);

        assertTrue(domList.getNames().contains("ListDom1".toLowerCase()));
        assertTrue(domList.getNames().contains("ListDom2".toLowerCase()));

        zmsImpl.deleteTopLevelDomain(ctx, "ListDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "ListDom2", auditRef, null);
    }

    @Test
    public void testListDomainsParamsLimit() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("LimitDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("LimitDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainList domList = zmsImpl.listDomains(1, null, null, null, 0, false);
        assertEquals(1, domList.getNames().size());

        zmsImpl.deleteTopLevelDomain(ctx, "LimitDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "LimitDom2", auditRef, null);
    }

    @Test
    public void testListDomainsParamsSkip() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("SkipDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("SkipDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        TopLevelDomain dom3 = zmsTestInitializer.createTopLevelDomainObject("SkipDom3",
                "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom3);

        DomainList domList = zmsImpl.listDomains(null, null, null, null, 0, false);
        int size = domList.getNames().size();
        assertTrue(size > 3);

        // ask for only for 2 domains back
        domList = zmsImpl.listDomains(2, null, null, null, 0, false);
        assertEquals(domList.getNames().size(), 2);

        // ask for the remaining domains
        DomainList remList = zmsImpl.listDomains(null, domList.getNext(), null, null, 0, false);
        assertEquals(remList.getNames().size(), size - 2);

        zmsImpl.deleteTopLevelDomain(ctx, "SkipDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "SkipDom2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "SkipDom3", auditRef, null);
    }

    @Test
    public void testListDomainsParamsPrefix() {

        String noPrefixDom = "noprefixdom1";
        String prefixDom = "prefixdom2";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(noPrefixDom,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(prefixDom,
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainList domList = zmsImpl.listDomains(null, null, "prefix", null, 0, false);

        assertFalse(domList.getNames().contains(noPrefixDom));
        assertTrue(domList.getNames().contains(prefixDom));

        zmsImpl.deleteTopLevelDomain(ctx, noPrefixDom, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, prefixDom, auditRef, null);
    }

    @Test
    public void testListDomainsParamsDepth() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("DepthDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        SubDomain dom2 = zmsTestInitializer.createSubDomainObject("DepthDom2", "DepthDom1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postSubDomain(ctx, "DepthDom1", auditRef, null, dom2);

        SubDomain dom3 = zmsTestInitializer.createSubDomainObject("DepthDom3",
                "DepthDom1.DepthDom2", "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "DepthDom1.DepthDom2", auditRef, null, dom3);

        DomainList domList = zmsImpl.listDomains(null, null, null, 1, 0, false);

        assertTrue(domList.getNames().contains("DepthDom1".toLowerCase()));
        assertTrue(domList.getNames().contains("DepthDom1.DepthDom2".toLowerCase()));
        assertFalse(domList.getNames().contains("DepthDom1.DepthDom2.DepthDom3".toLowerCase()));

        zmsImpl.deleteSubDomain(ctx, "DepthDom1.DepthDom2", "DepthDom3", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "DepthDom1", "DepthDom2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "DepthDom1", auditRef, null);
    }

    @Test
    public void testListModifiedDomains() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ListDomMod1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("ListDomMod2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainMetaList domModList = zmsImpl.dbService.listModifiedDomains(0, true);
        assertNotNull(domModList);
        assertTrue(domModList.getDomains().size() > 1);

        boolean dom1Found = false;
        boolean dom2Found = false;
        for (Domain domName : domModList.getDomains()) {
            if (domName.getName().equalsIgnoreCase("ListDomMod1")) {
                dom1Found = true;
            } else if (domName.getName().equalsIgnoreCase("ListDomMod2")) {
                dom2Found = true;
            }
        }

        assertTrue(dom1Found);
        assertTrue(dom2Found);

        zmsImpl.deleteTopLevelDomain(ctx, "ListDomMod1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "ListDomMod2", auditRef, null);
    }

    @Test
    public void testListModifiedDomainsMillis() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        long timestamp = System.currentTimeMillis() - 2001;

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ListDomMod1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("ListDomMod2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        DomainMetaList domModList = zmsImpl.dbService.listModifiedDomains(timestamp, true);
        assertNotNull(domModList);
        assertTrue(domModList.getDomains().size() > 1);

        boolean dom1Found = false;
        boolean dom2Found = false;
        for (Domain domName : domModList.getDomains()) {
            if (domName.getName().equalsIgnoreCase("ListDomMod1")) {
                dom1Found = true;
            } else if (domName.getName().equalsIgnoreCase("ListDomMod2")) {
                dom2Found = true;
            }
        }

        assertTrue(dom1Found);
        assertTrue(dom2Found);

        timestamp += 10000; // add 10 seconds
        domModList = zmsImpl.dbService.listModifiedDomains(timestamp, true);
        assertNotNull(domModList);
        assertEquals(0, domModList.getDomains().size());

        zmsImpl.deleteTopLevelDomain(ctx, "ListDomMod1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "ListDomMod2", auditRef, null);
    }

    @Test
    public void testVirtualHomeDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();

        Principal principal = SimplePrincipal.create("user", "user1", "v=U1;d=user;n=user1;s=signature",
                0, principalAuthority);

        AthenzDomain virtualDomain = zmsImpl.virtualHomeDomain(principal, "user.user1");
        assertNotNull(virtualDomain);

        List<Role> roles = virtualDomain.getRoles();
        assertNotNull(roles);
        Role adminRole = null;
        for (Role role : roles) {
            if (role.getName().equals("user.user1:role.admin")) {
                adminRole = role;
                break;
            }
        }
        assertNotNull(adminRole);
        List<RoleMember> roleMembers = adminRole.getRoleMembers();
        assertEquals(roleMembers.size(), 1);
        assertEquals(roleMembers.get(0).getMemberName(), "user.user1");

        List<Policy> policies = virtualDomain.getPolicies();
        assertNotNull(policies);
        Policy adminPolicy = null;
        for (Policy policy : policies) {
            if (policy.getName().equals("user.user1:policy.admin")) {
                adminPolicy = policy;
                break;
            }
        }
        assertNotNull(adminPolicy);
    }

    @Test
    public void testVirtualHomeDomainDifferentUserHome() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();

        Principal principal = SimplePrincipal.create("user", "john.smith", "v=U1;d=user;n=john.smith;s=signature",
                0, principalAuthority);

        AthenzDomain virtualDomain = zmsImpl.virtualHomeDomain(principal, "home.john-smith");
        assertNotNull(virtualDomain);

        List<Role> roles = virtualDomain.getRoles();
        assertNotNull(roles);
        Role adminRole = null;
        for (Role role : roles) {
            if (role.getName().equals("home.john-smith:role.admin")) {
                adminRole = role;
                break;
            }
        }
        assertNotNull(adminRole);
        List<RoleMember> roleMembers = adminRole.getRoleMembers();
        assertEquals(roleMembers.size(), 1);
        assertEquals(roleMembers.get(0).getMemberName(), "user.john.smith");

        List<Policy> policies = virtualDomain.getPolicies();
        assertNotNull(policies);
        Policy adminPolicy = null;
        for (Policy policy : policies) {
            if (policy.getName().equals("home.john-smith:policy.admin")) {
                adminPolicy = policy;
                break;
            }
        }
        assertNotNull(adminPolicy);
    }

    @Test
    public void testDeletePublicKeyEntry() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceDelPubKeyDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceDelPubKeyDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceDelPubKeyDom1", "Service1", auditRef, false, null, service);

        zmsImpl.deletePublicKeyEntry(ctx, "ServiceDelPubKeyDom1", "Service1", "1", auditRef, null);
        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, "ServiceDelPubKeyDom1", "Service1");
        List<PublicKeyEntry> keyList = serviceRes.getPublicKeys();
        boolean found = false;
        for (PublicKeyEntry entry : keyList) {
            if (entry.getId().equals("1")) {
                found = true;
                break;
            }
        }
        assertFalse(found);

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceDelPubKeyDom1", auditRef, null);
    }

    @Test
    public void testDeletePublicKeyEntryMissingAuditRef() {
        String domain = "testDeletePublicKeyEntryMissingAuditRef";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        ServiceIdentity service = zmsTestInitializer.createServiceObject(
                domain,
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        zmsImpl.putServiceIdentity(ctx, domain, "Service1", auditRef, false, null, service);

        PublicKeyEntry keyEntry = new PublicKeyEntry();
        keyEntry.setId("zone1");
        keyEntry.setKey(zmsTestInitializer.getPubKeyK2());
        zmsImpl.putPublicKeyEntry(ctx, domain, "Service1", "zone1", auditRef, null, keyEntry);
        try {
            zmsImpl.deletePublicKeyEntry(ctx, domain, "Service1", "1", null, null);
            fail("requesterror not thrown by deletePublicKeyEntry.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testDeletePublicKeyEntryDomainNotFound() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceDelPubKeyDom2",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceDelPubKeyDom2",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceDelPubKeyDom2", "Service1", auditRef, false, null, service);

        // this should throw a not found exception
        try {
            zmsImpl.deletePublicKeyEntry(ctx, "UnknownPublicKeyDomain", "Service1", "1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceDelPubKeyDom2", auditRef, null);
    }

    @Test
    public void testDeletePublicKeyEntryInvalidService() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceDelPubKeyDom2InvalidService",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceDelPubKeyDom2InvalidService",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceDelPubKeyDom2InvalidService",
                "Service1", auditRef, false, null, service);

        // this should throw an invalid request exception
        try {
            zmsImpl.deletePublicKeyEntry(ctx, "ServiceDelPubKeyDom2InvalidService",
                    "Service1.Service2", "1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceDelPubKeyDom2InvalidService", auditRef, null);
    }

    @Test
    public void testDeletePublicKeyEntryServiceNotFound() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceDelPubKeyDom3",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceDelPubKeyDom3",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceDelPubKeyDom3", "Service1", auditRef, false, null, service);

        // this should throw a not found exception
        try {
            zmsImpl.deletePublicKeyEntry(ctx, "ServiceDelPubKeyDom3", "ServiceNotFound", "1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceDelPubKeyDom3", auditRef, null);
    }

    @Test
    public void testDeletePublicKeyEntryIdNotFound() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServiceDelPubKeyDom4",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServiceDelPubKeyDom4",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServiceDelPubKeyDom4", "Service1", auditRef, false, null, service);

        // process invalid keys

        try {
            zmsImpl.deletePublicKeyEntry(ctx, "ServiceDelPubKeyDom4", "Service1", "zone", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // make sure both 1 and 2 keys are still valid

        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, "ServiceDelPubKeyDom4", "Service1");
        List<PublicKeyEntry> keyList = serviceRes.getPublicKeys();
        boolean foundKey1 = false;
        boolean foundKey2 = false;
        for (PublicKeyEntry entry : keyList) {
            if (entry.getId().equals("1")) {
                foundKey1 = true;
            } else if (entry.getId().equals("2")) {
                foundKey2 = true;
            }
        }
        assertTrue(foundKey1);
        assertTrue(foundKey2);

        zmsImpl.deleteTopLevelDomain(ctx, "ServiceDelPubKeyDom4", auditRef, null);
    }

    @Test
    public void testGetPublicKeyEntry() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePubKeyDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePubKeyDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePubKeyDom1", "Service1", auditRef, false, null, service);

        PublicKeyEntry entry = zmsImpl.getPublicKeyEntry(ctx, "ServicePubKeyDom1", "Service1", "1");
        assertNotNull(entry);
        assertEquals(entry.getId(), "1");
        assertEquals(entry.getKey(), zmsTestInitializer.getPubKeyK1());

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePubKeyDom1", auditRef, null);
    }

    @Test
    public void testGetPublicKeyEntryInvalidService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePubKeyDom2Invalid",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePubKeyDom2Invalid",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePubKeyDom2Invalid", "Service1", auditRef, false, null, service);

        // this should throw an invalid request exception
        try {
            zmsImpl.getPublicKeyEntry(ctx, "ServicePubKeyDom2Invalid", "Service1.Service2", "1");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePubKeyDom2Invalid", auditRef, null);
    }

    @Test
    public void testGetPublicKeyEntryDomainNotFound() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePubKeyDom2",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePubKeyDom2",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePubKeyDom2", "Service1", auditRef, false, null, service);

        // this should throw a not found exception
        try {
            zmsImpl.getPublicKeyEntry(ctx, "UnknownPublicKeyDomain", "Service1", "1");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePubKeyDom2", auditRef, null);
    }

    @Test
    public void testGetPublicKeyEntryServiceNotFound() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePubKeyDom3",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePubKeyDom3",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePubKeyDom3", "Service1", auditRef, false, null, service);

        // this should throw a not found exception
        try {
            zmsImpl.getPublicKeyEntry(ctx, "ServicePubKeyDom3", "ServiceNotFound", "1");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePubKeyDom3", auditRef, null);
    }

    @Test
    public void testGetPublicKeyEntryIdNotFound() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePubKeyDom4",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePubKeyDom4",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePubKeyDom4", "Service1", auditRef, false, null, service);

        // this should throw a not found exception
        try {
            zmsImpl.getPublicKeyEntry(ctx, "ServicePubKeyDom4", "Service1", "zone");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePubKeyDom4", auditRef, null);
    }

    @Test
    public void testPutPublicKeyEntryNew() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePutPubKeyDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePutPubKeyDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePutPubKeyDom1", "Service1", auditRef, false, null, service);

        PublicKeyEntry keyEntry = new PublicKeyEntry();
        keyEntry.setId("zone1");
        keyEntry.setKey(zmsTestInitializer.getPubKeyK2());

        zmsImpl.putPublicKeyEntry(ctx, "ServicePutPubKeyDom1", "Service1", "zone1", auditRef, null, keyEntry);

        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, "ServicePutPubKeyDom1", "Service1");
        List<PublicKeyEntry> keyList = serviceRes.getPublicKeys();
        boolean foundKey1 = false;
        boolean foundKey2 = false;
        boolean foundKeyZONE1 = false;
        for (PublicKeyEntry entry : keyList) {
            switch (entry.getId()) {
                case "1":
                    foundKey1 = true;
                    break;
                case "2":
                    foundKey2 = true;
                    break;
                case "zone1":
                    foundKeyZONE1 = true;
                    break;
            }
        }
        assertTrue(foundKey1);
        assertTrue(foundKey2);
        assertTrue(foundKeyZONE1);

        PublicKeyEntry entry = zmsImpl.getPublicKeyEntry(ctx, "ServicePutPubKeyDom1", "Service1", "zone1");
        assertNotNull(entry);
        assertEquals(entry.getId(), "zone1");
        assertEquals(entry.getKey(), zmsTestInitializer.getPubKeyK2());

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePutPubKeyDom1", auditRef, null);
    }

    @Test
    public void testPutPublicKeyEntryInvalidKey() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePutPubKeyDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePutPubKeyDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePutPubKeyDom1", "Service1", auditRef, false, null, service);

        PublicKeyEntry keyEntry = new PublicKeyEntry();
        keyEntry.setId("zone1");
        keyEntry.setKey("some-invalid-key");

        try {
            zmsImpl.putPublicKeyEntry(ctx, "ServicePutPubKeyDom1", "Service1", "zone1", auditRef, null, keyEntry);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Invalid public key"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePutPubKeyDom1", auditRef, null);
    }

    @Test
    public void testPutPublicKeyEntryMissingAuditRef() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testPutPublicKeyEntryMissingAuditRef";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        ServiceIdentity service = zmsTestInitializer.createServiceObject(
                domain,
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        zmsImpl.putServiceIdentity(ctx, domain, "Service1", auditRef, false, null, service);

        PublicKeyEntry keyEntry = new PublicKeyEntry();
        keyEntry.setId("zone1");
        keyEntry.setKey(zmsTestInitializer.getPubKeyK2());

        try {
            zmsImpl.putPublicKeyEntry(ctx, domain, "Service1", "zone1", null, null, keyEntry);
            fail("requesterror not thrown by putPublicKeyEntry.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testPutPublicKeyEntryInvalidService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testPutPublicKeyEntryInvalidService";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        ServiceIdentity service = zmsTestInitializer.createServiceObject(
                domain,
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        zmsImpl.putServiceIdentity(ctx, domain, "Service1", auditRef, false, null, service);

        PublicKeyEntry keyEntry = new PublicKeyEntry();
        keyEntry.setId("zone1");
        keyEntry.setKey(zmsTestInitializer.getPubKeyK2());

        try {
            zmsImpl.putPublicKeyEntry(ctx, domain, "Service1.Service2", "zone1", null, null, keyEntry);
            fail("requesterror not thrown by putPublicKeyEntry.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
        }
    }

    @Test
    public void testPutPublicKeyEntryUpdate() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePutPubKeyDom1A",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePutPubKeyDom1A",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePutPubKeyDom1A", "Service1", auditRef, false, null, service);

        PublicKeyEntry keyEntry = new PublicKeyEntry();
        keyEntry.setId("1");
        keyEntry.setKey(zmsTestInitializer.getPubKeyK2());

        zmsImpl.putPublicKeyEntry(ctx, "ServicePutPubKeyDom1A", "Service1", "1", auditRef, null, keyEntry);

        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, "ServicePutPubKeyDom1A", "Service1");
        List<PublicKeyEntry> keyList = serviceRes.getPublicKeys();
        assertEquals(keyList.size(), 2);

        boolean foundKey1 = false;
        boolean foundKey2 = false;
        for (PublicKeyEntry entry : keyList) {
            if (entry.getId().equals("1")) {
                foundKey1 = true;
            } else if (entry.getId().equals("2")) {
                foundKey2 = true;
            }
        }

        assertTrue(foundKey1);
        assertTrue(foundKey2);

        PublicKeyEntry entry = zmsImpl.getPublicKeyEntry(ctx, "ServicePutPubKeyDom1A", "Service1", "1");
        assertNotNull(entry);
        assertEquals(entry.getId(), "1");
        assertEquals(entry.getKey(), zmsTestInitializer.getPubKeyK2());

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePutPubKeyDom1A", auditRef, null);
    }

    @Test
    public void testPutPublicKeyEntryDomainNotFound() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePutPubKeyDom2",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePutPubKeyDom2",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePutPubKeyDom2", "Service1", auditRef, false, null, service);

        // this should throw a not found exception
        try {
            PublicKeyEntry keyEntry = new PublicKeyEntry();
            keyEntry.setId("zone1");
            keyEntry.setKey(zmsTestInitializer.getPubKeyK2());

            zmsImpl.putPublicKeyEntry(ctx, "UnknownPublicKeyDomain", "Service1", "zone1", auditRef, null, keyEntry);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePutPubKeyDom2", auditRef, null);
    }

    @Test
    public void testPutPublicKeyEntryServiceNotFound() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePutPubKeyDom3",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePutPubKeyDom3",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePutPubKeyDom3", "Service1", auditRef, false, null, service);

        // this should throw a not found exception
        try {
            PublicKeyEntry keyEntry = new PublicKeyEntry();
            keyEntry.setId("zone1");
            keyEntry.setKey(zmsTestInitializer.getPubKeyK2());

            zmsImpl.putPublicKeyEntry(ctx, "ServicePutPubKeyDom3", "ServiceNotFound", "zone1", auditRef, null, keyEntry);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePutPubKeyDom3", auditRef, null);
    }

    @Test
    public void testDeletePublicKeyEntryIdNoMatch() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ServicePutPubKeyDom4",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("ServicePutPubKeyDom4",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "ServicePutPubKeyDom4", "Service1", auditRef, false, null, service);

        // this should throw invalid request exception

        try {
            PublicKeyEntry keyEntry = new PublicKeyEntry();
            keyEntry.setId("zone1");
            keyEntry.setKey(zmsTestInitializer.getPubKeyK2());

            zmsImpl.putPublicKeyEntry(ctx, "ServicePutPubKeyDom4", "Service1", "zone2", auditRef, null, keyEntry);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "ServicePutPubKeyDom4", auditRef, null);
    }

    @Test
    public void testConvertToLowerCaseAssertion() {

        Assertion assertion = new Assertion();
        assertion.setAction("Read");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coreTech:VIP.*");
        assertion.setRole("coretech:role.Role1");

        AthenzObject.ASSERTION.convertToLowerCase(assertion);
        assertEquals(assertion.getRole(), "coretech:role.role1");
        assertEquals(assertion.getAction(), "read");
        assertEquals(assertion.getResource(), "coretech:vip.*");

        // Check with case-sensitive flag
        new Assertion();
        assertion.setAction("Read");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("coreTech:VIP.*");
        assertion.setRole("coretech:role.Role1");
        assertion.setCaseSensitive(true);

        AthenzObject.ASSERTION.convertToLowerCase(assertion);
        assertEquals(assertion.getRole(), "coretech:role.role1");
        assertEquals(assertion.getAction(), "Read");
        assertEquals(assertion.getResource(), "coretech:VIP.*");
    }

    @Test
    public void testRemoveQuotes() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertEquals(zmsImpl.removeQuotes("abc"), "abc");
        assertEquals(zmsImpl.removeQuotes("\"abc"), "abc");
        assertEquals(zmsImpl.removeQuotes("abc\""), "abc");
        assertEquals(zmsImpl.removeQuotes("\"abc\""), "abc");
        assertEquals(zmsImpl.removeQuotes("\"a\"bc\""), "a\"bc");
    }

    @Test
    public void testConvertToLowerCaseList() {

        AthenzObject.LIST.convertToLowerCase(null);

        List<String> list = new ArrayList<>();
        list.add("item1");
        list.add("Item2");
        list.add("ITEM3");

        AthenzObject.LIST.convertToLowerCase(list);
        assertTrue(list.contains("item1"));
        assertTrue(list.contains("item2"));
        assertTrue(list.contains("item3"));
        assertEquals(list.size(), 3);
    }

    @Test
    public void testConvertToLowerCaseSubdomain() {

        SubDomain dom = zmsTestInitializer.createSubDomainObject("DepthDom2", "DepthDom1",
                "Test Domain2", "testOrg", "user.user3A");
        dom.setSignAlgorithm("RSA");
        AthenzObject.SUB_DOMAIN.convertToLowerCase(dom);
        assertEquals(dom.getName(), "depthdom2");
        assertEquals(dom.getParent(), "depthdom1");
        assertEquals(dom.getSignAlgorithm(), "rsa");
        assertTrue(dom.getAdminUsers().contains("user.user3a"));

        SubDomain dom2 = zmsTestInitializer.createSubDomainObject("DepthDom2", "DepthDom1",
                "Test Domain2", "testOrg", "user.user3B");
        DomainTemplateList templates = new DomainTemplateList();
        List<String> list = new ArrayList<>();
        list.add("platforms");
        list.add("vipNg");
        list.add("ATHENZ");
        templates.setTemplateNames(list);
        dom2.setTemplates(templates);
        AthenzObject.SUB_DOMAIN.convertToLowerCase(dom2);
        assertEquals(dom2.getName(), "depthdom2");
        assertEquals(dom2.getParent(), "depthdom1");
        assertTrue(dom2.getAdminUsers().contains("user.user3b"));
        templates = dom2.getTemplates();
        list = templates.getTemplateNames();
        assertEquals(3, list.size());
        assertTrue(list.contains("platforms"));
        assertTrue(list.contains("vipng"));
        assertTrue(list.contains("athenz"));
    }

    @Test
    public void testConvertToLowerCaseTopLeveldomain() {

        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject("TopLevelDomain",
                "Test Domain1", "testOrg", "user.USER3A");
        dom.setSignAlgorithm("EC");
        AthenzObject.TOP_LEVEL_DOMAIN.convertToLowerCase(dom);
        assertEquals(dom.getName(), "topleveldomain");
        assertEquals(dom.getSignAlgorithm(), "ec");
        assertTrue(dom.getAdminUsers().contains("user.user3a"));

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("TopLevelDomain",
                "Test Domain1", "testOrg", "user.USER3B");
        DomainTemplateList templates = new DomainTemplateList();
        List<String> list = new ArrayList<>();
        list.add("platforms");
        list.add("vipNg");
        list.add("ATHENZ");
        templates.setTemplateNames(list);
        dom2.setTemplates(templates);
        AthenzObject.TOP_LEVEL_DOMAIN.convertToLowerCase(dom2);
        assertEquals(dom2.getName(), "topleveldomain");
        assertTrue(dom2.getAdminUsers().contains("user.user3b"));
        templates = dom2.getTemplates();
        list = templates.getTemplateNames();
        assertEquals(3, list.size());
        assertTrue(list.contains("platforms"));
        assertTrue(list.contains("vipng"));
        assertTrue(list.contains("athenz"));
    }

    @Test
    public void testConvertToLowerCaseUserdomain() {

        UserDomain dom = zmsTestInitializer.createUserDomainObject("USER3A",
                "Test Domain1", "testOrg");
        dom.setSignAlgorithm("RSA");
        AthenzObject.USER_DOMAIN.convertToLowerCase(dom);
        assertEquals(dom.getName(), "user3a");
        assertEquals(dom.getSignAlgorithm(), "rsa");

        UserDomain dom2 = zmsTestInitializer.createUserDomainObject("USER3B",
                "Test Domain1", "testOrg");
        DomainTemplateList templates = new DomainTemplateList();
        List<String> list = new ArrayList<>();
        list.add("platforms");
        list.add("vipNg");
        list.add("ATHENZ");
        templates.setTemplateNames(list);
        dom2.setTemplates(templates);

        AthenzObject.USER_DOMAIN.convertToLowerCase(dom2);
        assertEquals(dom2.getName(), "user3b");
        templates = dom2.getTemplates();
        list = templates.getTemplateNames();
        assertEquals(3, list.size());
        assertTrue(list.contains("platforms"));
        assertTrue(list.contains("vipng"));
        assertTrue(list.contains("athenz"));
    }

    @Test
    public void testConvertToLowerCasePublicKeyEntry() {
        PublicKeyEntry keyEntry = new PublicKeyEntry().setKey("KEY").setId("ZONE1");
        AthenzObject.PUBLIC_KEY_ENTRY.convertToLowerCase(keyEntry);
        assertEquals(keyEntry.getKey(), "KEY");
        assertEquals(keyEntry.getId(), "zone1");
    }

    @Test
    public void testConvertToLowerCaseQuota() {
        Quota quota = new Quota().setName("UpperCaseDomain");
        AthenzObject.QUOTA.convertToLowerCase(quota);
        assertEquals(quota.getName(), "uppercasedomain");
    }

    @Test
    public void testConvertToLowerCaseEntity() {
        Entity entity = zmsTestInitializer.createEntityObject("Domain1", "ABcEntity");
        AthenzObject.ENTITY.convertToLowerCase(entity);
        assertEquals(entity.getName(), "domain1:entity.abcentity");
    }

    @Test
    public void testConvertToLowerCaseTemplate() {
        DomainTemplate template = new DomainTemplate();
        List<String> names = new ArrayList<>();
        names.add("Burbank");
        names.add("santa_Monica");
        names.add("playa");
        template.setTemplateNames(names);
        List<TemplateParam> params = new ArrayList<>();
        params.add(new TemplateParam().setName("Name1").setValue("value1"));
        params.add(new TemplateParam().setName("name2").setValue("Value2"));
        template.setParams(params);

        AthenzObject.DOMAIN_TEMPLATE.convertToLowerCase(template);
        assertEquals(template.getTemplateNames().size(), 3);
        assertTrue(template.getTemplateNames().contains("burbank"));
        assertTrue(template.getTemplateNames().contains("playa"));
        assertTrue(template.getTemplateNames().contains("santa_monica"));
        assertEquals(template.getParams().size(), 2);
        boolean param1Check = false;
        boolean param2Check = false;
        TemplateParam param1 = new TemplateParam().setName("name1").setValue("value1");
        TemplateParam param2 = new TemplateParam().setName("name2").setValue("value2");
        for (TemplateParam param : template.getParams()) {
            if (param.equals(param1)) {
                param1Check = true;
            } else if (param.equals(param2)) {
                param2Check = true;
            }
        }
        assertTrue(param1Check);
        assertTrue(param2Check);

        // passing null should be no-op

        AthenzObject.DOMAIN_TEMPLATE.convertToLowerCase(null);
    }

    @Test
    public void testConvertToLowerCaseTenancy() {
        Tenancy tenancy = zmsTestInitializer.createTenantObject("CoretecH", "STorage");
        List<String> groups = new ArrayList<>();
        groups.add("Burbank");
        groups.add("santa_monica");
        tenancy.setResourceGroups(groups);
        AthenzObject.TENANCY.convertToLowerCase(tenancy);
        assertEquals(tenancy.getDomain(), "coretech");
        assertEquals(tenancy.getService(), "storage");
        assertTrue(tenancy.getResourceGroups().contains("burbank"));
        assertTrue(tenancy.getResourceGroups().contains("santa_monica"));
    }

    @Test
    public void testConvertToLowerCaseDefaultAdmins() {

        List<String> adminList = new ArrayList<>();
        adminList.add("user.User1");
        adminList.add("user.user2");
        DefaultAdmins admins = new DefaultAdmins();
        admins.setAdmins(adminList);

        AthenzObject.DEFAULT_ADMINS.convertToLowerCase(admins);
        assertTrue(admins.getAdmins().contains("user.user1"));
        assertTrue(admins.getAdmins().contains("user.user2"));
    }

    @Test
    public void testConvertToLowerCaseTenantResourceGroupRolesNoActions() {

        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles()
                .setDomain("coreTech").setService("storaGe")
                .setTenant("DelTenantRolesDom1").setResourceGroup("Hockey");
        AthenzObject.TENANT_RESOURCE_GROUP_ROLES.convertToLowerCase(tenantRoles);
        assertEquals(tenantRoles.getDomain(), "coretech");
        assertEquals(tenantRoles.getService(), "storage");
        assertEquals(tenantRoles.getTenant(), "deltenantrolesdom1");
        assertEquals(tenantRoles.getResourceGroup(), "hockey");
    }

    @Test
    public void testConvertToLowerCaseProviderResourceGroupRolesNoActions() {

        ProviderResourceGroupRoles tenantRoles = new ProviderResourceGroupRoles()
                .setDomain("coreTech").setService("storaGe")
                .setTenant("DelTenantRolesDom1").setResourceGroup("Hockey");
        AthenzObject.PROVIDER_RESOURCE_GROUP_ROLES.convertToLowerCase(tenantRoles);
        assertEquals(tenantRoles.getDomain(), "coretech");
        assertEquals(tenantRoles.getService(), "storage");
        assertEquals(tenantRoles.getTenant(), "deltenantrolesdom1");
        assertEquals(tenantRoles.getResourceGroup(), "hockey");
    }

    @Test
    public void testConvertToLowerCaseGroupRole() {
        Role role = zmsTestInitializer.createRoleObject("RoleDomain", "roleName", null, "user.USER1", "user.user2");
        AthenzObject.ROLE.convertToLowerCase(role);
        assertEquals(role.getName(), "roledomain:role.rolename");
        List<String> checkList = new ArrayList<>();
        checkList.add("user.user1");
        checkList.add("user.user2");
        zmsTestInitializer.checkRoleMember(checkList, role.getRoleMembers());
    }

    @Test
    public void testConvertToLowerCaseRoleMeta() {
        RoleMeta roleMeta = new RoleMeta();
        roleMeta.setNotifyRoles("role1,Role2,roLE3");
        roleMeta.setUserAuthorityFilter("attr1,ATTR2");
        roleMeta.setUserAuthorityExpiration("ElevatedClearance");
        roleMeta.setSignAlgorithm("EC");
        AthenzObject.ROLE_META.convertToLowerCase(roleMeta);
        assertEquals(roleMeta.getNotifyRoles(), "role1,role2,role3");
        assertEquals(roleMeta.getUserAuthorityFilter(), "attr1,ATTR2");
        assertEquals(roleMeta.getUserAuthorityExpiration(), "ElevatedClearance");
        assertEquals(roleMeta.getSignAlgorithm(), "ec");
    }

    @Test
    public void testConvertToLowerCaseTrustRole() {
        Role role = zmsTestInitializer.createRoleObject("RoleDomain", "roleName", "TRUSTDomain");
        AthenzObject.ROLE.convertToLowerCase(role);
        assertEquals(role.getName(), "roledomain:role.rolename");
        assertEquals(role.getTrust(), "trustdomain");
    }

    @Test
    public void testConvertToLowerCaseMembershipWithRole() {
        Membership membership = new Membership().setMemberName("user.member1").setRoleName("ROLE1");
        AthenzObject.MEMBERSHIP.convertToLowerCase(membership);
        assertEquals(membership.getMemberName(), "user.member1");
        assertEquals(membership.getRoleName(), "role1");
    }

    @Test
    public void testConvertToLowerCaseRole() {

        Role role = new Role().setName("Role1");

        List<String> list = new ArrayList<>();
        list.add("item1");
        list.add("Item2");
        list.add("ITEM3");
        role.setMembers(list);

        List<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("item1"));
        roleMembers.add(new RoleMember().setMemberName("Item2"));
        roleMembers.add(new RoleMember().setMemberName("ITEM3"));
        role.setRoleMembers(roleMembers);

        AthenzObject.ROLE.convertToLowerCase(role);

        assertEquals(role.getName(), "role1");
        list = role.getMembers();
        assertTrue(list.contains("item1"));
        assertTrue(list.contains("item2"));
        assertTrue(list.contains("item3"));
        assertEquals(list.size(), 3);

        roleMembers = role.getRoleMembers();
        assertEquals(roleMembers.size(), 3);
        boolean item1 = false;
        boolean item2 = false;
        boolean item3 = false;
        for (RoleMember member : roleMembers) {
            switch (member.getMemberName()) {
                case "item1":
                    item1 = true;
                    break;
                case "item2":
                    item2 = true;
                    break;
                case "item3":
                    item3 = true;
                    break;
            }
        }
        assertTrue(item1);
        assertTrue(item2);
        assertTrue(item3);
    }

    @Test
    public void testConvertToLowerCaseMembershipWithoutRole() {
        Membership membership = new Membership().setMemberName("user.member1");
        AthenzObject.MEMBERSHIP.convertToLowerCase(membership);
        assertEquals(membership.getMemberName(), "user.member1");
    }

    @Test
    public void testConvertToLowerCaseServciceWithKeys() {
        ServiceIdentity service = zmsTestInitializer.createServiceObject("CoreTECH", "STORage",
                "http://localhost:4080", "jetty", "user", "group", "HOST1");
        List<PublicKeyEntry> publicKeyList = new ArrayList<>();
        PublicKeyEntry publicKeyEntry1 = new PublicKeyEntry();
        publicKeyEntry1.setKey(zmsTestInitializer.getPubKeyK1());
        publicKeyEntry1.setId("ZONE1");
        publicKeyList.add(publicKeyEntry1);
        PublicKeyEntry publicKeyEntry2 = new PublicKeyEntry();
        publicKeyEntry2.setKey(zmsTestInitializer.getPubKeyK2());
        publicKeyEntry2.setId("2");
        publicKeyList.add(publicKeyEntry2);
        service.setPublicKeys(publicKeyList);
        AthenzObject.SERVICE_IDENTITY.convertToLowerCase(service);
        assertEquals(service.getName(), "coretech.storage");
        assertTrue(service.getHosts().contains("host1"));
        assertEquals(service.getPublicKeys().get(0).getId(), "zone1");
        assertEquals(service.getPublicKeys().get(1).getId(), "2");
    }

    @Test
    public void testConvertToLowerCaseTenantRoleAction() {

        TenantRoleAction roleAction = new TenantRoleAction().setRole("ReaDer").setAction("READ");

        AthenzObject.TENANT_ROLE_ACTION.convertToLowerCase(roleAction);
        assertEquals(roleAction.getAction(), "read");
        assertEquals(roleAction.getRole(), "reader");
    }

    @Test
    public void testConvertToLowerCasePolicyNoAssertion() {

        Policy policy = new Policy();
        policy.setName(ResourceUtils.policyResourceName("CoreTech", "policy"));

        AthenzObject.POLICY.convertToLowerCase(policy);
        assertEquals(policy.getName(), "coretech:policy.policy");

        policy.setName(ResourceUtils.policyResourceName("newtech", "Policy"));

        AthenzObject.POLICY.convertToLowerCase(policy);
        assertEquals(policy.getName(), "newtech:policy.policy");
    }

    @Test
    public void testConvertToLowerCasePolicyMultipleAssertion() {

        Policy policy = new Policy();
        policy.setName(ResourceUtils.policyResourceName("CoreTech", "policy"));

        Assertion assertion1 = new Assertion();
        assertion1.setAction("Read");
        assertion1.setEffect(AssertionEffect.ALLOW);
        assertion1.setResource("coreTech:VIP.*");
        assertion1.setRole("coretech:role.Role1");

        Assertion assertion2 = new Assertion();
        assertion2.setAction("UPDATE");
        assertion2.setEffect(AssertionEffect.ALLOW);
        assertion2.setResource("CoreTech:VIP.*");
        assertion2.setRole("coretech:role.RoleAB");

        List<Assertion> assertList = new ArrayList<>();
        assertList.add(assertion1);
        assertList.add(assertion2);

        policy.setAssertions(assertList);

        AthenzObject.POLICY.convertToLowerCase(policy);
        assertEquals(policy.getName(), "coretech:policy.policy");
        Assertion assertion = policy.getAssertions().get(0);
        assertEquals(assertion.getRole(), "coretech:role.role1");
        assertEquals(assertion.getAction(), "read");
        assertEquals(assertion.getResource(), "coretech:vip.*");

        assertion = policy.getAssertions().get(1);
        assertEquals(assertion.getRole(), "coretech:role.roleab");
        assertEquals(assertion.getAction(), "update");
        assertEquals(assertion.getResource(), "coretech:vip.*");

        // Now check case-sensitive
        policy = new Policy();
        policy.setName(ResourceUtils.policyResourceName("CoreTech", "policy"));
        policy.setCaseSensitive(true);
        assertion1 = new Assertion();
        assertion1.setAction("Read");
        assertion1.setEffect(AssertionEffect.ALLOW);
        assertion1.setResource("coreTech:VIP.*");
        assertion1.setRole("coretech:role.Role1");

        assertion2 = new Assertion();
        assertion2.setAction("UPDATE");
        assertion2.setEffect(AssertionEffect.ALLOW);
        assertion2.setResource("CoreTech:VIP.*");
        assertion2.setRole("coretech:role.RoleAB");

        assertList = new ArrayList<>();
        assertList.add(assertion1);
        assertList.add(assertion2);

        policy.setAssertions(assertList);

        AthenzObject.POLICY.convertToLowerCase(policy);
        assertEquals(policy.getName(), "coretech:policy.policy");
        assertion = policy.getAssertions().get(0);
        assertEquals(assertion.getRole(), "coretech:role.role1");
        assertEquals(assertion.getAction(), "Read");
        assertEquals(assertion.getResource(), "coretech:VIP.*");

        assertion = policy.getAssertions().get(1);
        assertEquals(assertion.getRole(), "coretech:role.roleab");
        assertEquals(assertion.getAction(), "UPDATE");
        assertEquals(assertion.getResource(), "coretech:VIP.*");
    }

    @Test
    public void testConvertToLowerCasePolicyOneAssertion() {

        Policy policy = zmsTestInitializer.createPolicyObject("CoreTech", "NewPolicy");
        AthenzObject.POLICY.convertToLowerCase(policy);
        assertEquals(policy.getName(), "coretech:policy.newpolicy");
        Assertion assertion = policy.getAssertions().get(0);
        assertEquals(assertion.getRole(), "coretech:role.admin");
    }

    @Test
    public void testConvertToLowerCaseDomainTemplateList() {
        DomainTemplateList templates = new DomainTemplateList();
        List<String> list = new ArrayList<>();
        list.add("platforms");
        list.add("vipNg");
        list.add("ATHENZ");
        templates.setTemplateNames(list);
        AthenzObject.DOMAIN_TEMPLATE_LIST.convertToLowerCase(templates);

        list = templates.getTemplateNames();
        assertEquals(3, list.size());
        assertTrue(list.contains("platforms"));
        assertTrue(list.contains("vipng"));
        assertTrue(list.contains("athenz"));
    }

    @Test
    public void testProviderServiceDomain() {
        assertEquals(ZMSUtils.providerServiceDomain("coretech.storage"), "coretech");
        assertEquals(ZMSUtils.providerServiceDomain("coretech.hosted.storage"), "coretech.hosted");
        assertNull(ZMSUtils.providerServiceDomain("coretech"));
        assertNull(ZMSUtils.providerServiceDomain(".coretech"));
        assertNull(ZMSUtils.providerServiceDomain("coretech."));
    }

    @Test
    public void testProviderServiceName() {
        assertEquals(ZMSUtils.providerServiceName("coretech.storage"), "storage");
        assertEquals(ZMSUtils.providerServiceName("coretech.hosted.storage"), "storage");
        assertNull(ZMSUtils.providerServiceName("coretech"));
        assertNull(ZMSUtils.providerServiceName(".coretech"));
        assertNull(ZMSUtils.providerServiceName("coretech."));
    }

    @Test
    public void testIsAuthorizedProviderServiceInvalidService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // null authorized service argument

        assertFalse(zmsImpl.isAuthorizedProviderService(null, "coretech", "storage", zmsTestInitializer.getMockDomRestRsrcCtx().principal()));

        // service does not match provider details

        assertFalse(zmsImpl.isAuthorizedProviderService("coretech.storage", "coretech", "storage2", zmsTestInitializer.getMockDomRestRsrcCtx().principal()));
        assertFalse(zmsImpl.isAuthorizedProviderService("coretech.storage", "coretech2", "storage", zmsTestInitializer.getMockDomRestRsrcCtx().principal()));

        // domain does not exist in zms

        assertFalse(zmsImpl.isAuthorizedProviderService("not_present_domain.storage", "not_present_domain",
                "storage", zmsTestInitializer.getMockDomRestRsrcCtx().principal()));
    }

    @Test
    public void testIsAuthorizedProviderServiceAuthorized() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "AuthorizedProviderDom1";
        String providerDomain = "coretech";
        zmsTestInitializer.setupTenantDomainProviderService(tenantDomain, providerDomain, "storage",
                "http://localhost:8090/tableprovider");

        // tenant is setup so let's setup up policy to authorize access to tenants

        Role role = zmsTestInitializer.createRoleObject(providerDomain, "self_serve", null, providerDomain + ".storage", null);
        zmsImpl.putRole(ctx, providerDomain, "self_serve", auditRef, false, null, role);

        Policy policy = zmsTestInitializer.createPolicyObject(providerDomain, "self_serve",
                "self_serve", "update", providerDomain + ":tenant.*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, providerDomain, "self_serve", auditRef, false, null, policy);

        assertTrue(zmsImpl.isAuthorizedProviderService(providerDomain + ".storage", providerDomain,
                "storage", zmsTestInitializer.getMockDomRestRsrcCtx().principal()));

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
    }

    @Test
    public void testIsAuthorizedProviderServiceNotAuthorized() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "AuthorizedProviderDom2";
        String providerDomain = "coretech";
        zmsTestInitializer.setupTenantDomainProviderService(tenantDomain, providerDomain, "storage",
                "http://localhost:8090/tableprovider");

        // tenant is setup but no policy to authorize access to tenants

        assertFalse(zmsImpl.isAuthorizedProviderService(providerDomain + ".storage", providerDomain,
                "storage", zmsTestInitializer.getMockDomRestRsrcCtx().principal()));

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
    }

    @Test
    public void testVerifyAuthorizedServiceOperation() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // null authorized service means it's all good

        zmsImpl.verifyAuthorizedServiceOperation(null, "putrole");

        // our test resource json file includes two services:
        // coretech.storage - allowed for putrole and putpolicy
        // sports.hockey - not allowed for any ops

        zmsImpl.verifyAuthorizedServiceOperation("coretech.storage", "putrole");
        zmsImpl.verifyAuthorizedServiceOperation("coretech.storage", "putpolicy");
        try {
            zmsImpl.verifyAuthorizedServiceOperation("coretech.storage", "postdomain");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.verifyAuthorizedServiceOperation("coretech.storage", "deleterole");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.verifyAuthorizedServiceOperation("sports.hockey", "putrole");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }
        try {
            zmsImpl.verifyAuthorizedServiceOperation("sports.hockey", "putpolicy");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }
        try {
            zmsImpl.verifyAuthorizedServiceOperation("sports.hockey", "deleterole");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }
        try {
            zmsImpl.verifyAuthorizedServiceOperation("sports.hockey", "putserviceidentity");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        // ATHENZ-1528
        // Try passing along operationItem key + value to see if verification works

        // First, try with AllowAll operation
        zmsImpl.verifyAuthorizedServiceOperation("coretech.newsvc", "putrole"); // putrole has no restriction. This should pass.

        // Second, try with restricted operation. Currently, putmembership only allow single operation item.
        zmsImpl.verifyAuthorizedServiceOperation("coretech.newsvc", "putmembership", "role", "platforms_deployer");
        zmsImpl.verifyAuthorizedServiceOperation("coretech.newsvc", "putmembership", "role", "platforms_different_deployer");
        zmsImpl.verifyAuthorizedServiceOperation("coretech.newsvc", "putmembership", "not_role", "platforms_role_deployer");

        // Third, try with restriction operation, with not-specified operation item.

        try {
            zmsImpl.verifyAuthorizedServiceOperation("coretech.newsvc", "putmembership", "role", "platforms_deployer_new");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.verifyAuthorizedServiceOperation("coretech.newsvc", "putmembership", "not_role", "platforms_deployer_new_new");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.verifyAuthorizedServiceOperation("coretech.storage2", "postdomain");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.verifyAuthorizedServiceOperation("media.storage", "deleterole");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }
    }

    @Test
    public void testVerifyAuthorizedServiceRolePrefixOperation() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // our test resource json includes the following
        // role-prefix use case
        //        "coretech.updater": {
        //            "allowedOperations": [
        //               {
        //                 "name":"putmembership",
        //                  "items": {
        //                      "role-prefix" : [
        //                          "reader.org.",
        //                          "writer.domain."
        //                      ]
        //                  }
        //              }
        //            ]

        zmsImpl.verifyAuthorizedServiceRoleOperation(null, "putmembership", "role1");

        // Try passing along operationItem key + value to see if verification works

        zmsImpl.verifyAuthorizedServiceRoleOperation("coretech.updater", "putmembership", "reader.org.role1");
        zmsImpl.verifyAuthorizedServiceRoleOperation("coretech.updater", "putmembership", "writer.domain.role1");

        // try with restricted operation. Currently, putmembership only allow single operation item.
        zmsImpl.verifyAuthorizedServiceRoleOperation("coretech.newsvc", "putmembership", "platforms_deployer");
        zmsImpl.verifyAuthorizedServiceRoleOperation("coretech.newsvc", "putmembership", "platforms_different_deployer");

        // Third, try with restriction operation, with not-specified operation item.

        try {
            zmsImpl.verifyAuthorizedServiceRoleOperation("coretech.updater", "putmembership", "platforms_deployer_new");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.verifyAuthorizedServiceRoleOperation("coretech.updater", "putmembership", "reader.org1.role1");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.verifyAuthorizedServiceRoleOperation("coretech.newsvc", "putmembership", "platforms_deployer_new");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }
    }

    @Test
    public void testPutProviderResourceGroupRoles() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "putproviderresourcegrouproles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(tenantDomain, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String providerService = "storage";
        String providerDomain = "coretech";
        String resourceGroup = "hockey";

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup);
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup, auditRef, providerRoles);

        ProviderResourceGroupRoles tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(tRoles);
        assertEquals(providerDomain.toLowerCase(), tRoles.getDomain());
        assertEquals(providerService.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        // when we execute the same request, it should work without
        // rejecting the request

        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup, auditRef, providerRoles);

        tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(tRoles);
        assertEquals(providerDomain.toLowerCase(), tRoles.getDomain());
        assertEquals(providerService.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
    }

    @Test
    public void testPutProviderResourceGroupMultipleRoles() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "putproviderresourcegroupmultipleroles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(tenantDomain, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String providerService = "storage";
        String providerDomain = "coretech";
        String resourceGroup1 = "hockey";
        String resourceGroup2 = "baseball";

        // add resource group1 roles

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup1);
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup1, auditRef, providerRoles);

        // add resource group2 roles

        providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup2);
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup2, auditRef, providerRoles);

        // verify group 1 roles

        final String roleWriter = providerDomain + "." + providerService + ".res_group." + resourceGroup1 + ".writer";
        final String roleReader = providerDomain + "." + providerService + ".res_group." + resourceGroup1 + ".reader";

        ProviderResourceGroupRoles tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup1);

        assertNotNull(tRoles);
        assertEquals(providerDomain.toLowerCase(), tRoles.getDomain());
        assertEquals(providerService.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup1.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        Role roleW = zmsImpl.getRole(ctx, tenantDomain, roleWriter, false, false, false);
        assertEquals(roleW.getRoleMembers().size(), 1);
        assertEquals(roleW.getRoleMembers().get(0).getMemberName(), zmsTestInitializer.getMockDomRestRsrcCtx().principal().getFullName());

        Role roleR = zmsImpl.getRole(ctx, tenantDomain, roleReader, false, false, false);
        assertEquals(roleR.getRoleMembers().size(), 1);
        assertEquals(roleR.getRoleMembers().get(0).getMemberName(), zmsTestInitializer.getMockDomRestRsrcCtx().principal().getFullName());

        // verify group 2 roles

        tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup2);

        assertNotNull(tRoles);
        assertEquals(providerDomain.toLowerCase(), tRoles.getDomain());
        assertEquals(providerService.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup2.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        // add an additional service to the writer action role

        final String newMember = tenantDomain + ".backend";

        Membership mbr = zmsTestInitializer.generateMembership(roleWriter, newMember);
        zmsImpl.putMembership(ctx, tenantDomain, roleWriter, newMember, auditRef, false, null, mbr);

        // now let's re-add the group 1 roles again and verify that the
        // member list is correct

        providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup1);
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup1, auditRef, providerRoles);

        roleW = zmsImpl.getRole(ctx, tenantDomain, roleWriter, false, false, false);
        assertEquals(roleW.getRoleMembers().size(), 2);

        assertTrue(zmsTestInitializer.verifyRoleMember(roleW, zmsTestInitializer.getMockDomRestRsrcCtx().principal().getFullName()));
        assertTrue(zmsTestInitializer.verifyRoleMember(roleW, newMember));

        roleR = zmsImpl.getRole(ctx, tenantDomain, roleReader, false, false, false);
        assertEquals(roleR.getRoleMembers().size(), 1);
        assertTrue(zmsTestInitializer.verifyRoleMember(roleW, zmsTestInitializer.getMockDomRestRsrcCtx().principal().getFullName()));

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
    }

    @Test
    public void testDeleteProviderResourceGroupRoles() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "deleteproviderresourcegrouproles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(tenantDomain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String providerService  = "storage";
        String providerDomain = "coretech";
        String resourceGroup = "hockey";

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup);
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup, auditRef, providerRoles);

        ProviderResourceGroupRoles tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(tRoles);
        assertEquals(providerDomain.toLowerCase(), tRoles.getDomain());
        assertEquals(providerService.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        // now let's delete our resource group

        zmsImpl.deleteProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup, auditRef);

        // now let's retrieve our resource group and verify we got 0 roles

        tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(tRoles);
        assertEquals(providerDomain.toLowerCase(), tRoles.getDomain());
        assertEquals(providerService.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(0, tRoles.getRoles().size());

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
    }

    @Test
    public void testDeleteProviderResourceGroupMultipleRoles() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "deleteproviderresourcegroupmultipleroles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(tenantDomain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String providerService  = "storage";
        String providerDomain = "coretech";
        String resourceGroup1 = "hockey";
        String resourceGroup2 = "baseball";

        // add resource group1 roles

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup1);
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup1, auditRef, providerRoles);

        // add resource group2 roles

        providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup2);
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup2, auditRef, providerRoles);

        // now let's delete our resource group 1

        zmsImpl.deleteProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup1, auditRef);

        // verify group 1 roles and it's size of 0

        ProviderResourceGroupRoles tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup1);

        assertNotNull(tRoles);
        assertEquals(providerDomain.toLowerCase(), tRoles.getDomain());
        assertEquals(providerService.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup1.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(0, tRoles.getRoles().size());

        // verify group 2 roles with valid size of roles

        tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup2);

        assertNotNull(tRoles);
        assertEquals(providerDomain.toLowerCase(), tRoles.getDomain());
        assertEquals(providerService.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup2.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());

        // now let's delete our resource group 2

        zmsImpl.deleteProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup2, auditRef);

        // now both get operations must return 0 for the size

        tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup1);

        assertNotNull(tRoles);
        assertEquals(0, tRoles.getRoles().size());

        tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup2);

        assertNotNull(tRoles);
        assertEquals(0, tRoles.getRoles().size());

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
    }

    @Test
    public void testGetProviderResourceGroupRoles() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "getproviderresourcegrouproles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(tenantDomain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String providerService  = "storage";
        String providerDomain = "coretech";
        String resourceGroup = "hockey";

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup);
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain, providerService,
                resourceGroup, auditRef, providerRoles);

        ProviderResourceGroupRoles tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(tRoles);
        assertEquals(providerDomain.toLowerCase(), tRoles.getDomain());
        assertEquals(providerService.toLowerCase(), tRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), tRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), tRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());
        List<TenantRoleAction> traList = tRoles.getRoles();
        List<String> roles = new ArrayList<>();
        for (TenantRoleAction ra : traList) {
            roles.add(ra.getRole());
        }
        assertTrue(roles.contains("reader"));
        assertTrue(roles.contains("writer"));

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
    }

    @Test
    public void testGetProviderResourceGroupRolesInvalid() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String tenantDomain = "getproviderresourcegrouprolesinvalid";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(tenantDomain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        // all invalid input with provider domain, resource and resource group
        // just returns an empty list for role actions.

        ProviderResourceGroupRoles tRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, "test1", "invalid", "hockey");

        assertNotNull(tRoles);
        assertEquals(0, tRoles.getRoles().size());

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
    }

    @Test
    public void testGetProviderResourceGroupRolesUnknownDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        // all invalid input with provider domain, resource and resource group
        // just returns an empty list for role actions but for invalid tenant
        // domain we get 404 exception

        try {
            zmsImpl.getProviderResourceGroupRoles(ctx, "unknown-domain",
                    "test1", "invalid", "hockey");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }
    }

    @Test
    public void testPutProviderResourceGroupRolesWithAuthorizedService() {

        String tenantDomain = "providerresourcegrouprolesauthorizedservice";
        String providerService  = "storage";
        String providerDomain = "coretech";
        String resourceGroup = "hockey";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.setupTenantDomainProviderService(tenantDomain, providerDomain, providerService,
                "http://localhost:8090/tableprovider");

        // tenant is setup so let's setup up policy to authorize access to tenants
        // without this role/policy we won't be authorized to add tenant roles
        // to the provider domain even with authorized service details

        Role role = zmsTestInitializer.createRoleObject(providerDomain, "self_serve", null,
                providerDomain + "." + providerService, null);
        zmsImpl.putRole(ctx, providerDomain, "self_serve", auditRef, false, null, role);

        Policy policy = zmsTestInitializer.createPolicyObject(providerDomain, "self_serve",
                "self_serve", "update", providerDomain + ":tenant.*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, providerDomain, "self_serve", auditRef, false, null, policy);

        // now we're going to setup our provider role call

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup);

        // we are going to create a principal object with authorized service
        // set to coretech.storage

        String userId = "user1";
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=" + userId;
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds + ";s=signature",
                0, principalAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);
        ((SimplePrincipal) principal).setAuthorizedService("coretech.storage");
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(principal, "putproviderresourcegrouproles");

        // after this call we should have roles set for both provider and tenant

        zmsImpl.putProviderResourceGroupRoles(rsrcCtx, tenantDomain, providerDomain, providerService,
                resourceGroup, auditRef, providerRoles);

        assertPutProviderResourceGroupRolesWithAuthorizedService(zmsImpl, tenantDomain, providerService,
                providerDomain, resourceGroup, rsrcCtx);

        // Verify domain dependency wasn't created as the provider isn't listed in the "sys.auth:role.service_providers role

        try {
            zmsImpl.getDependentDomainList(ctx, providerDomain + "." + providerService);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"" + providerDomain + "." + providerService + " is not a registered service provider\"}");
        }

        // now we're going to delete the provider roles using the standard
        // resource object without the authorized service. in this case
        // the provider roles are going to be deleted but not the tenant
        // roles from the provider domain

        zmsImpl.deleteProviderResourceGroupRoles(ctx, tenantDomain, providerDomain,
                providerService, resourceGroup, auditRef);

        // so for tenant we're going to 0 provider roles

        ProviderResourceGroupRoles pRoles = zmsImpl.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(pRoles);
        assertEquals(0, pRoles.getRoles().size());

        // but for provider we're still going to get full set of roles

        TenantResourceGroupRoles tRoles = zmsImpl.getTenantResourceGroupRoles(rsrcCtx, providerDomain,
                providerService, tenantDomain, resourceGroup);
        assertNotNull(tRoles);
        assertEquals(2, tRoles.getRoles().size());

        // now this time we're going to delete with the principal with the
        // authorized service token

        zmsImpl.deleteProviderResourceGroupRoles(rsrcCtx, tenantDomain, providerDomain,
                providerService, resourceGroup, auditRef);

        // so for tenant we're still going to 0 provider roles

        pRoles = zmsImpl.getProviderResourceGroupRoles(rsrcCtx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(pRoles);
        assertEquals(0, pRoles.getRoles().size());

        // and for provider we're now going to get 0 tenant roles as well

        tRoles = zmsImpl.getTenantResourceGroupRoles(ctx, providerDomain,
                providerService, tenantDomain, resourceGroup);
        assertNotNull(tRoles);
        assertEquals(0, tRoles.getRoles().size());

        // clean up our domains

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
    }

    @Test
    public void testPutProviderResourceGroupRolesWithAuthorizedServiceDomainDependency() {

        String tenantDomain = "providerresourcegrouprolesauthorizedservice";
        String providerService  = "storage";
        String providerDomain = "coretech";
        String resourceGroup = "hockey";

        ZMSImpl zms = zmsTestInitializer.zmsInit();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        zmsTestInitializer.setupTenantDomainProviderService(zms, tenantDomain, providerDomain, providerService,
                "http://localhost:8090/tableprovider");

        zmsTestInitializer.makeServiceProviders(zms, ctx, Collections.singletonList("coretech.storage"),
                fetchDomainDependencyFrequency);

        // tenant is setup so let's setup up policy to authorize access to tenants
        // without this role/policy we won't be authorized to add tenant roles
        // to the provider domain even with authorized service details

        Role role = zmsTestInitializer.createRoleObject(providerDomain, "self_serve", null,
                providerDomain + "." + providerService, null);
        zms.putRole(ctx, providerDomain, "self_serve", auditRef, false, null, role);

        Policy policy = zmsTestInitializer.createPolicyObject(providerDomain, "self_serve",
                "self_serve", "update", providerDomain + ":tenant.*", AssertionEffect.ALLOW);
        zms.putPolicy(ctx, providerDomain, "self_serve", auditRef, false, null, policy);

        // now we're going to setup our provider role call

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup);

        // we are going to create a principal object with authorized service
        // set to coretech.storage

        String userId = "user1";
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=" + userId;
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds + ";s=signature",
                0, principalAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);
        ((SimplePrincipal) principal).setAuthorizedService("coretech.storage");
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(principal, "putproviderresourcegrouproles");

        // after this call we should have roles set for both provider and tenant

        zms.putProviderResourceGroupRoles(rsrcCtx, tenantDomain, providerDomain, providerService,
                resourceGroup, auditRef, providerRoles);

        assertPutProviderResourceGroupRolesWithAuthorizedService(zms, tenantDomain, providerService, providerDomain, resourceGroup, ctx);

        // Verify domain dependency was created

        DomainList dependentDomainList = zms.getDependentDomainList(ctx, providerDomain + "." + providerService);
        assertEquals(dependentDomainList.getNames().size(), 1);
        assertEquals(dependentDomainList.getNames().get(0), "providerresourcegrouprolesauthorizedservice");

        // now we're going to delete the provider roles using the standard
        // resource object without the authorized service. in this case
        // the provider roles are going to be deleted but not the tenant
        // roles from the provider domain

        zms.deleteProviderResourceGroupRoles(ctx, tenantDomain, providerDomain,
                providerService, resourceGroup, auditRef);

        // so for tenant we're going to 0 provider roles

        ProviderResourceGroupRoles pRoles = zms.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(pRoles);
        assertEquals(0, pRoles.getRoles().size());

        // but for provider we're still going to get full set of roles

        TenantResourceGroupRoles tRoles = zms.getTenantResourceGroupRoles(ctx, providerDomain,
                providerService, tenantDomain, resourceGroup);
        assertNotNull(tRoles);
        assertEquals(2, tRoles.getRoles().size());

        // Also, domain dependency remains until the resources are removed from the provider

        dependentDomainList = zms.getDependentDomainList(ctx, providerDomain + "." + providerService);
        assertEquals(dependentDomainList.getNames().size(), 1);
        assertEquals(dependentDomainList.getNames().get(0), "providerresourcegrouprolesauthorizedservice");

        // now this time we're going to delete with the principal with the
        // authorized service token

        zms.deleteProviderResourceGroupRoles(rsrcCtx, tenantDomain, providerDomain,
                providerService, resourceGroup, auditRef);

        // so for tenant we're still going to 0 provider roles

        pRoles = zmsImpl.getProviderResourceGroupRoles(rsrcCtx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(pRoles);
        assertEquals(0, pRoles.getRoles().size());

        // and for provider we're now going to get 0 tenant roles as well

        tRoles = zms.getTenantResourceGroupRoles(ctx, providerDomain,
                providerService, tenantDomain, resourceGroup);
        assertNotNull(tRoles);
        assertEquals(0, tRoles.getRoles().size());

        // Domain dependency will be removed

        dependentDomainList = zms.getDependentDomainList(ctx, providerDomain + "." + providerService);
        assertEquals(dependentDomainList.getNames().size(), 0);

        // Finally, delete the tenant
        RsrcCtxWrapper serviceProviderCtx = zmsTestInitializer.contextWithMockPrincipal("deleteTenant", providerDomain, providerService);
        zms.deleteTenant(serviceProviderCtx, providerDomain, providerService, tenantDomain, auditRef);
        dependentDomainList = zms.getDependentDomainList(ctx, providerDomain + "." + providerService);
        assertEquals(dependentDomainList.getNames().size(), 0);

        // clean up our domains

        zms.deleteRole(ctx, "sys.auth", "service_providers", auditRef, null);
        zms.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
        zms.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
    }

    private void assertPutProviderResourceGroupRolesWithAuthorizedService(ZMSImpl zms, String tenantDomain, String providerService, String providerDomain, String resourceGroup, ResourceContext ctx) {
        ProviderResourceGroupRoles pRoles = zms.getProviderResourceGroupRoles(ctx,
                tenantDomain, providerDomain, providerService, resourceGroup);

        assertNotNull(pRoles);
        assertEquals(providerDomain.toLowerCase(), pRoles.getDomain());
        assertEquals(providerService.toLowerCase(), pRoles.getService());
        assertEquals(tenantDomain.toLowerCase(), pRoles.getTenant());
        assertEquals(resourceGroup.toLowerCase(), pRoles.getResourceGroup());
        assertEquals(ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS.size(), pRoles.getRoles().size());
        List<TenantRoleAction> traList = pRoles.getRoles();
        List<String> roles = new ArrayList<>();
        for (TenantRoleAction ra : traList) {
            roles.add(ra.getRole());
        }
        assertTrue(roles.contains("reader"));
        assertTrue(roles.contains("writer"));

        // now get the tenant roles for the provider

        TenantResourceGroupRoles tRoles = zms.getTenantResourceGroupRoles(ctx, providerDomain,
                providerService, tenantDomain, resourceGroup);
        assertNotNull(tRoles);
        assertEquals(tRoles.getDomain(), providerDomain);
        assertEquals(tRoles.getService(), providerService);
        assertEquals(tRoles.getTenant(), tenantDomain);
        assertEquals(tRoles.getResourceGroup(), resourceGroup);
        assertEquals(ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS.size(), tRoles.getRoles().size());
        traList = pRoles.getRoles();
        roles = new ArrayList<>();
        for (TenantRoleAction ra : traList) {
            roles.add(ra.getRole());
        }
        assertTrue(roles.contains("reader"));
        assertTrue(roles.contains("writer"));
    }

    @Test
    public void testProviderResourceGroupRolesWithAuthorizedServiceNoAccess() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        String tenantDomain = "provrscgrprolesauthorizedservicenoaccess";
        String providerService  = "index";
        String providerDomain = "coretech";
        String resourceGroup = "hockey";

        zmsTestInitializer.setupTenantDomainProviderService(zmsImpl, tenantDomain, providerDomain, providerService,
                "http://localhost:8090/tableprovider");

        // tenant is setup so let's setup up policy to authorize access to tenants
        // without this role/policy we won't be authorized to add tenant roles
        // to the provider domain even with authorized service details

        Role role = zmsTestInitializer.createRoleObject(providerDomain, "self_serve", null,
                providerDomain + "." + providerService, null);
        zmsImpl.putRole(ctx, providerDomain, "self_serve", auditRef, false, null, role);

        Policy policy = zmsTestInitializer.createPolicyObject(providerDomain, "self_serve",
                "self_serve", "update", providerDomain + ":tenant.*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, providerDomain, "self_serve", auditRef, false, null, policy);

        // now we're going to setup our provider role call

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.RESOURCE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup);

        // we are going to create a principal object with authorized service
        // set to coretech.index

        String userId = "user1";
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=" + userId;
        Principal principal = SimplePrincipal.create("user", userId, unsignedCreds + ";s=signature",
                0, principalAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);
        ((SimplePrincipal) principal).setUnsignedCreds(unsignedCreds);
        ((SimplePrincipal) principal).setAuthorizedService("coretech.index");
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(principal);

        // this call should return an exception since we can't execute
        // the putproviderresourcegrouproles operation with our chained token

        try {
            zmsImpl.putProviderResourceGroupRoles(rsrcCtx, tenantDomain, providerDomain, providerService,
                    resourceGroup, auditRef, providerRoles);
            fail();
        } catch (ResourceException ex) {
            assertEquals(403, ex.getCode());
        }

        // clean up our domains

        zmsImpl.deleteTopLevelDomain(ctx, tenantDomain, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, providerDomain, auditRef, null);
    }

    @Test
    public void testPutProviderRolesWithResourceGroupEmptyRoleActions() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domain = "testputproviderrolesnoroles";
        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(
                domain, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        List<TenantRoleAction> roleActions = new ArrayList<>();
        String serviceName  = "storage";
        String tenantDomain = "tenantTestPutTenantRoles";
        String resourceGroup = "Group1";

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles().setDomain(domain)
                .setService(serviceName).setTenant(tenantDomain)
                .setRoles(roleActions).setResourceGroup(resourceGroup);

        try {
            zmsImpl.putProviderResourceGroupRoles(ctx, domain, serviceName, tenantDomain,
                    resourceGroup, auditRef, providerRoles);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domain, auditRef, null);
    }

    @Test
    public void testOptionsUserTokenInvalidService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        // null service must return 400

        try {
            zmsImpl.optionsUserToken(ctx, "user1", null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // empty service must return 400

        try {
            zmsImpl.optionsUserToken(ctx, "user1", "");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // unknown registered service must return 400
        try {
            zmsImpl.optionsUserToken(ctx, "user1", "unknown_service_name");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // in a list all services must be valid - any invalid must return 400

        try {
            zmsImpl.optionsUserToken(ctx, "user1", "coretech.storage,unknown_service_name");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }
    }

    @Test
    public void testOptionsUserToken() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        HttpServletRequest servletRequest = new MockHttpServletRequest();
        HttpServletResponse servletResponse = new MockHttpServletResponse();
        ResourceContext ctx = new RsrcCtxWrapper(null, servletRequest, servletResponse, null, false,
                null, new Object(), "apiName", false);

        zmsImpl.optionsUserToken(ctx, "user", "coretech.storage");
        assertEquals("GET", servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_METHODS));
        assertEquals("2592000", servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_MAX_AGE));
        assertEquals("true", servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_CREDENTIALS));

        // using default values where we'll get back null for origin and no allow headers

        assertNull(servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_ORIGIN));
        assertNull(servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_HEADERS));
    }

    @Test
    public void testOptionsUserTokenRequestHeaders() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        MockHttpServletRequest servletRequest = new MockHttpServletRequest();
        MockHttpServletResponse servletResponse = new MockHttpServletResponse();
        ResourceContext ctx = new RsrcCtxWrapper(null, servletRequest, servletResponse, null, false,
                null, new Object(), "apiName", false);

        String origin = "https://zms.origin.athenzcompany.com";
        String requestHeaders = "X-Forwarded-For,Content-Type";
        servletRequest.addHeader(ZMSConsts.HTTP_ORIGIN, origin);
        servletRequest.addHeader(ZMSConsts.HTTP_ACCESS_CONTROL_REQUEST_HEADERS, requestHeaders);

        // this time we're going to try with multiple services

        zmsImpl.optionsUserToken(ctx, "user", "coretech.storage,coretech.index");
        assertEquals("GET", servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_METHODS));
        assertEquals("2592000", servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_MAX_AGE));
        assertEquals("true", servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_CREDENTIALS));
        assertEquals(origin, servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_ORIGIN));

        // because X-Forwarded-For is not in the request header list,
        // our header list will be null

        assertNull(servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_HEADERS));

        // now let's add the header to the list and we should get
        // back our header list

        zmsImpl.corsRequestHeaderList.add("x-forwarded-for");
        zmsImpl.optionsUserToken(ctx, "user", "coretech.storage,coretech.index");

        assertEquals(requestHeaders, servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_HEADERS));
        zmsImpl.corsRequestHeaderList.remove("x-forwarded-for");
    }

    @Test
    public void testSetStandardCORSHeaders() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        HttpServletRequest servletRequest = new MockHttpServletRequest();
        HttpServletResponse servletResponse = new MockHttpServletResponse();
        ResourceContext ctx = new RsrcCtxWrapper(null, servletRequest, servletResponse, null, false,
                null, new Object(), "apiName", false);

        zmsImpl.setStandardCORSHeaders(ctx);
        assertEquals("true", servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_CREDENTIALS));

        // using default values where we'll get back null for origin and no allow headers

        assertNull(servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_ORIGIN));
        assertNull(servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_HEADERS));
    }

    @Test
    public void testSetStandardCORSHeadersRequestHeaders() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        MockHttpServletRequest servletRequest = new MockHttpServletRequest();
        MockHttpServletResponse servletResponse = new MockHttpServletResponse();
        ResourceContext ctx = new RsrcCtxWrapper(null, servletRequest, servletResponse, null, false,
                null, new Object(), "apiName", true);

        String origin = "https://zms.origin.athenzcompany.com";
        String requestHeaders = "X-Forwarded-For,Content-Type";
        servletRequest.addHeader(ZMSConsts.HTTP_ORIGIN, origin);
        servletRequest.addHeader(ZMSConsts.HTTP_ACCESS_CONTROL_REQUEST_HEADERS, requestHeaders);

        zmsImpl.corsRequestHeaderList.add("x-forwarded-for");
        zmsImpl.setStandardCORSHeaders(ctx);
        assertEquals("true", servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_CREDENTIALS));

        assertEquals(origin, servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_ORIGIN));
        assertEquals(requestHeaders, servletResponse.getHeader(ZMSConsts.HTTP_ACCESS_CONTROL_ALLOW_HEADERS));
        zmsImpl.corsRequestHeaderList.remove("x-forwarded-for");
    }

    @Test
    public void testVerifyProviderEndpoint() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // http successful test cases (localhost or *.athenzcompany.com)
        assertTrue(zmsImpl.verifyProviderEndpoint("http://localhost"));
        assertTrue(zmsImpl.verifyProviderEndpoint("http://localhost:4080"));
        assertTrue(zmsImpl.verifyProviderEndpoint("http://localhost:4080/"));
        assertTrue(zmsImpl.verifyProviderEndpoint("http://localhost:4080/test1"));
        assertTrue(zmsImpl.verifyProviderEndpoint("http://host1.athenzcompany.com"));
        assertTrue(zmsImpl.verifyProviderEndpoint("http://host1.athenzcompany.com:4080"));
        assertTrue(zmsImpl.verifyProviderEndpoint("http://host1.athenzcompany.com:4080/"));
        assertTrue(zmsImpl.verifyProviderEndpoint("http://host1.athenzcompany.com:4080/test1"));

        // https successful test cases (localhost or *.athenzcompany.com)
        assertTrue(zmsImpl.verifyProviderEndpoint("https://localhost"));
        assertTrue(zmsImpl.verifyProviderEndpoint("https://localhost:4080"));
        assertTrue(zmsImpl.verifyProviderEndpoint("https://localhost:4080/"));
        assertTrue(zmsImpl.verifyProviderEndpoint("https://localhost:4080/test1"));
        assertTrue(zmsImpl.verifyProviderEndpoint("https://host1.athenzcompany.com"));
        assertTrue(zmsImpl.verifyProviderEndpoint("https://host1.athenzcompany.com:4080"));
        assertTrue(zmsImpl.verifyProviderEndpoint("https://host1.athenzcompany.com:4080/"));
        assertTrue(zmsImpl.verifyProviderEndpoint("https://host1.athenzcompany.com:4080/test1"));

        // class successful test case
        assertTrue(zmsImpl.verifyProviderEndpoint("class://com.yahoo.athenz.zmsImpl.ZMS"));

        // http invalid cases - not *.athenzcompany.com
        assertFalse(zmsImpl.verifyProviderEndpoint("http://host1.server.com"));
        assertFalse(zmsImpl.verifyProviderEndpoint("http://host1.server.com:4080"));
        assertFalse(zmsImpl.verifyProviderEndpoint("http://host1.server.com:4080/"));
        assertFalse(zmsImpl.verifyProviderEndpoint("http://host1.server.yahoo:4080/test1"));
        assertFalse(zmsImpl.verifyProviderEndpoint("http://host1.athenz.server.com:4080/test1"));
        assertFalse(zmsImpl.verifyProviderEndpoint("http://host1.athenz.ch:4080/test1"));

        // non-http scheme test cases
        assertFalse(zmsImpl.verifyProviderEndpoint("file://host1.athenz.com"));

        // other null and empty test cases
        assertTrue(zmsImpl.verifyProviderEndpoint(null));
        assertTrue(zmsImpl.verifyProviderEndpoint(""));
    }

    @Test
    public void testGetServerTemplateList() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        ServerTemplateList list = zmsImpl.getServerTemplateList(ctx);
        assertNotNull(list);
        assertTrue(list.getTemplateNames().contains("platforms"));
        assertTrue(list.getTemplateNames().contains("vipng"));
        assertTrue(list.getTemplateNames().contains("user_provisioning"));
    }

    @Test
    public void testGetTemplateInvalid() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        try {
            zmsImpl.getTemplate(ctx, "platforms test");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        try {
            zmsImpl.getTemplate(ctx, "invalid");
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }
    }

    @Test
    public void testGetTemplate() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        Template template = zmsImpl.getTemplate(ctx, "user_provisioning");
        assertNotNull(template);

        List<Role> roles = template.getRoles();
        assertNotNull(roles);
        assertEquals(3, roles.size());

        Role userRole = null;
        Role superuserRole = null;
        Role openstackReadersRole = null;
        for (Role role : roles) {
            switch (role.getName()) {
                case "_domain_:role.user":
                    userRole = role;
                    break;
                case "_domain_:role.superuser":
                    superuserRole = role;
                    break;
                case "_domain_:role.openstack_readers":
                    openstackReadersRole = role;
                    break;
            }
        }

        assertNotNull(userRole);
        assertNotNull(superuserRole);
        assertNotNull(openstackReadersRole);

        // openstack_readers role has 2 members

        assertEquals(2, openstackReadersRole.getRoleMembers().size());
        List<String> checkList = new ArrayList<>();
        checkList.add("sys.builder");
        checkList.add("sys.openstack");
        zmsTestInitializer.checkRoleMember(checkList, openstackReadersRole.getRoleMembers());

        // other roles have no members

        assertNull(userRole.getRoleMembers());
        assertNull(superuserRole.getRoleMembers());

        List<Policy> policies = template.getPolicies();
        assertNotNull(policies);
        assertEquals(3, policies.size());

        Policy userPolicy = null;
        Policy superuserPolicy = null;
        Policy openstackReadersPolicy = null;
        for (Policy policy : policies) {
            switch (policy.getName()) {
                case "_domain_:policy.user":
                    userPolicy = policy;
                    break;
                case "_domain_:policy.superuser":
                    superuserPolicy = policy;
                    break;
                case "_domain_:policy.openstack_readers":
                    openstackReadersPolicy = policy;
                    break;
            }
        }

        assertNotNull(userPolicy);
        assertNotNull(superuserPolicy);
        assertNotNull(openstackReadersPolicy);

        assertEquals(1, userPolicy.getAssertions().size());
        assertEquals(1, superuserPolicy.getAssertions().size());
        assertEquals(2, openstackReadersPolicy.getAssertions().size());

        template = zmsImpl.getTemplate(ctx, "vipng");
        assertNotNull(template);

        template = zmsImpl.getTemplate(ctx, "platforms");
        assertNotNull(template);

        template = zmsImpl.getTemplate(ctx, "VipNg");
        assertNotNull(template);

        assertEquals(10, template.getMetadata().getLatestVersion().intValue());
        assertEquals("2020-04-28T00:00:00.000Z", template.getMetadata().timestamp.toString());
        assertEquals("Vipng template", template.getMetadata().description);
        assertEquals("", template.getMetadata().keywordsToReplace);
        assertFalse(template.getMetadata().getAutoUpdate());
    }

    @Test
    public void testValidateSolutionTemplates() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        final String caller = "testValidateDomainTemplates";
        List<String> templateNames = new ArrayList<>();
        templateNames.add("platforms");
        zmsImpl.validateSolutionTemplates(templateNames, caller);

        templateNames.add("vipng");
        zmsImpl.validateSolutionTemplates(templateNames, caller);

        templateNames.add("athenz");
        try {
            zmsImpl.validateSolutionTemplates(templateNames, caller);
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
            assertTrue(ex.getMessage().contains("athenz"));
        }
    }

    @Test
    public void testPutPolicyNoLoopbackNoSuchDomainError() {
        final String auditRef = zmsTestInitializer.getAuditRef();
        HttpServletRequest servletRequest = Mockito.mock(HttpServletRequest.class);
        when(servletRequest.getRemoteAddr()).thenReturn("10.10.10.11");
        when(servletRequest.isSecure()).thenReturn(true);

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsObj = zmsTestInitializer.getZmsImpl(alogger);

        String userId = "user";
        Principal principal = SimplePrincipal.create("user", userId, "v=U1;d=user;n=user;s=signature", 0, null);
        ResourceContext context = zmsTestInitializer.createResourceContext(principal, servletRequest);
        String domainName = "DomainName";
        String policyName = "PolicyName";

        // Tests the putPolicy() condition: if (domain == null)...
        try {
            Policy policy = zmsTestInitializer.createPolicyObject(domainName, policyName);

            // should fail b/c we never created a top level domain.
            zmsObj.putPolicy(context, domainName, policyName, auditRef, false, null, policy);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testPutPolicyLoopbackNoXFF_InconsistentNameError() {
        final String auditRef = zmsTestInitializer.getAuditRef();
        HttpServletRequest servletRequest = Mockito.mock(HttpServletRequest.class);
        when(servletRequest.getRemoteAddr()).thenReturn("127.0.0.1");
        when(servletRequest.isSecure()).thenReturn(true);

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsObj = zmsTestInitializer.getZmsImpl(alogger);

        String userId = "user";
        Principal principal = SimplePrincipal.create("user", userId, "v=U1;d=user;n=user;s=signature", 0, null);
        ResourceContext context = zmsTestInitializer.createResourceContext(principal, servletRequest);
        String domainName = "DomainName";
        String policyName = "PolicyName";

        // Tests the putPolicy() condition : if (!policyResourceName(domainName, policyName).equals(policy.getName()))...
        try {
            Policy policy = zmsTestInitializer.createPolicyObject(domainName, policyName);

            zmsObj.putPolicy(context, domainName, "Bad" + policyName, auditRef, false, null, policy);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }
    }

    @Test
    public void testPutPolicyLoopbackXFFSingleValue() {
        final String auditRef = zmsTestInitializer.getAuditRef();
        HttpServletRequest servletRequest = Mockito.mock(HttpServletRequest.class);
        when(servletRequest.getRemoteAddr()).thenReturn("127.0.0.1");
        when(servletRequest.getHeader("X-Forwarded-For")).thenReturn("10.10.10.11");
        when(servletRequest.isSecure()).thenReturn(true);

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsObj = zmsTestInitializer.getZmsImpl(alogger);

        String userId = "user";
        Principal principal = SimplePrincipal.create("user", userId, "v=U1;d=user;n=user;s=signature", 0, null);
        ResourceContext context = zmsTestInitializer.createResourceContext(principal, servletRequest);
        String domainName = "DomainName";
        String policyName = "PolicyName";

        // Tests the putPolicy() condition : if (!policyResourceName(domainName, policyName).equals(policy.getName()))...
        try {
            Policy policy = zmsTestInitializer.createPolicyObject(domainName, policyName);

            zmsObj.putPolicy(context, domainName, "Bad" + policyName, auditRef, false, null, policy);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }
    }

    @Test
    public void testPutPolicyLoopbackXFFMultipleValues() {
        final String auditRef = zmsTestInitializer.getAuditRef();
        HttpServletRequest servletRequest = Mockito.mock(HttpServletRequest.class);
        when(servletRequest.getRemoteAddr()).thenReturn("127.0.0.1");
        when(servletRequest.getHeader("X-Forwarded-For")).thenReturn("10.10.10.11, 10.11.11.11, 10.12.12.12");
        when(servletRequest.isSecure()).thenReturn(true);

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsObj = zmsTestInitializer.getZmsImpl(alogger);

        String userId = "user";
        Principal principal = SimplePrincipal.create("user", userId, "v=U1;d=user;n=user;s=signature", 0, null);
        ResourceContext context = zmsTestInitializer.createResourceContext(principal, servletRequest);
        String domainName = "DomainName";
        String policyName = "PolicyName";

        // Tests the putPolicy() condition : if (!policyResourceName(domainName, policyName).equals(policy.getName()))...
        try {
            Policy policy = zmsTestInitializer.createPolicyObject(domainName, policyName);

            zmsObj.putPolicy(context, domainName, "Bad" + policyName, auditRef, false, null, policy);
            fail("requesterror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 400);
        }
    }

    @Test
    public void testLoadSolutionTemplatesInvalid() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        System.setProperty(ZMSConsts.ZMS_PROP_SOLUTION_TEMPLATE_FNAME, "invalid-templates.json");
        zmsImpl.serverSolutionTemplates = null;
        zmsImpl.loadSolutionTemplates();
        assertNotNull(zmsImpl.serverSolutionTemplates);
        assertTrue(zmsImpl.serverSolutionTemplates.getTemplates().isEmpty());
        System.clearProperty(ZMSConsts.ZMS_PROP_SOLUTION_TEMPLATE_FNAME);
    }

    @Test
    public void testUnderscoreNotAllowed() {

        String domainName = "core-tech";
        String badDomainName = "core_tech";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(badDomainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        SubDomain sub = zmsTestInitializer.createSubDomainObject(badDomainName, domainName,
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsImpl.postSubDomain(ctx, domainName, auditRef, null, sub);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        UserDomain userDom = zmsTestInitializer.createUserDomainObject(badDomainName, "Test Domain1", "testOrg");
        try {
            zmsImpl.postUserDomain(ctx, badDomainName, auditRef, null, userDom);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testReadOnlyMode() {

        // first initialize our impl which would create our service

        //noinspection UnusedAssignment
        ZMSImpl zmsTest = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // now we're going to create a new instance with read-only mode

        System.setProperty(ZMSConsts.ZMS_PROP_READ_ONLY_MODE, "true");
        System.setProperty(ZMSConsts.ZMS_PROP_PRINCIPAL_STATE_UPDATER_DISABLE_TIMER, "true");

        zmsTest = new ZMSImpl();
        ZMSImpl.serverHostName = "localhost";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("ReadOnlyDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        try {
            zmsTest.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteTopLevelDomain(ctx, "domain", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.postUserDomain(ctx, "user", auditRef, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteUserDomain(ctx, "user", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.postSubDomain(ctx, "athenz", auditRef, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteSubDomain(ctx, "athenz", "sub", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putDomainTemplate(ctx, "athenz", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putDomainTemplateExt(ctx, "athenz", "template", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteDomainTemplate(ctx, "athenz", "template", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putEntity(ctx, "athenz", "entity", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteEntity(ctx, "athenz", "entity", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        Policy policy1 = zmsTestInitializer.createPolicyObject("ReadOnlyDom1", "Policy1");
        try {
            zmsTest.putPolicy(ctx, "ReadOnlyDom1", "Policy1", auditRef, false, null, policy1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deletePolicy(ctx, "ReadOnlyDom1", "Policy1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putAssertion(ctx, "ReadOnlyDom1", "Policy1", auditRef, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteAssertion(ctx, "ReadOnlyDom1", "Policy1", 101L, auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        Role role1 = zmsTestInitializer.createRoleObject("ReadOnlyDom1", "Role1", null,
                "user.joe", "user.jane");
        try {
            zmsTest.putRole(ctx, "ReadOnlyDom1", "Role1", auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteRole(ctx, "ReadOnlyDom1", "Role1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putMembership(ctx, "ReadOnlyDom1", "Role1", "Member1", auditRef, false, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteMembership(ctx, "ReadOnlyDom1", "Role1", "Member1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject("ReadOnlyDom1",
                "Service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        try {
            zmsTest.putServiceIdentity(ctx, "ReadOnlyDom1", "Service1", auditRef, false, null, service1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            ServiceIdentitySystemMeta meta = new ServiceIdentitySystemMeta();
            zmsTest.putServiceIdentitySystemMeta(ctx, "ReadOnlyDom1", "Service1", "providerendpoint",
                    auditRef, meta);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteServiceIdentity(ctx, "ReadOnlyDom1", "Service1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putPublicKeyEntry(ctx, "ReadOnlyDom1", "Service1", "0", auditRef, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deletePublicKeyEntry(ctx, "ReadOnlyDom1", "Service1", "0", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteDomainRoleMember(ctx, "dom1", "user1", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteUser(ctx, "user1", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putDomainMeta(ctx, "dom1", auditRef, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putDomainSystemMeta(ctx, "dom1", "account", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putTenancy(ctx, "tenant", "provider.service", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteTenancy(ctx, "tenant", "provider.service", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putTenant(ctx, "provider", "service", "tenant", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteTenant(ctx, "provider", "service", "tenant", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putTenantResourceGroupRoles(ctx, "provider", "service", "tenant",
                    "resgroup", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putProviderResourceGroupRoles(ctx, "tenant", "provider", "service",
                    "resgroup", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteProviderResourceGroupRoles(ctx, "tenant", "provider", "service",
                    "resgroup", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteTenantResourceGroupRoles(ctx, "provider", "service", "tenant",
                    "resgroup", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putQuota(ctx, "domain", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteQuota(ctx, "domain", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putDefaultAdmins(ctx, "domain", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
            zmsTest.putRoleSystemMeta(ctx, "domain", "role1", "auditenabled", auditRef, rsm);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            RoleMeta rm = ZMSTestUtils.createRoleMetaObject(true);
            zmsTest.putRoleMeta(ctx, "domain", "role1", "auditenabled", null, rm);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putMembershipDecision(ctx, "readonlydom1", "role1", "member1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putRoleReview(ctx, "readonlydom1", "role1", auditRef, false, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deletePendingMembership(ctx, "readonlydom1", "role1", "member1", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putGroup(ctx, "readonlydom1", "group1", auditRef, false, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteGroup(ctx, "readonlydom1", "group1", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putGroupMembership(ctx, "readonlydom1", "group1", "user.joe", auditRef, false, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putGroupMembershipDecision(ctx, "readonlydom1", "group1", "user.joe", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putGroupReview(ctx, "readonlydom1", "group1", auditRef, false, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putGroupMeta(ctx, "readonlydom1", "group1", auditRef, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putGroupSystemMeta(ctx, "readonlydom1", "group1", "attr", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteGroupMembership(ctx, "readonlydom1", "group1", "user.joe", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deletePendingGroupMembership(ctx, "readonlydom1", "group1", "user.joe", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putAssertionPolicyVersion(ctx, "readonlydom1", "policy1", "1", auditRef, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteAssertionPolicyVersion(ctx, "readonlydom1", "policy1", "1", 1001L, auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            DependentService dependentService = new DependentService().setService("sys.auth.zms");
            zmsTest.putDomainDependency(ctx, "readonlydom1", auditRef, dependentService);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.deleteDomainDependency(ctx, "readonlydom1", auditRef, "sys.auth.zms");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putResourceDomainOwnership(ctx, "readonlydom1", auditRef, new ResourceDomainOwnership());
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putResourceRoleOwnership(ctx, "readonlydom1", "role1", auditRef, new ResourceRoleOwnership());
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putResourceGroupOwnership(ctx, "readonlydom1", "group1", auditRef, new ResourceGroupOwnership());
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putResourcePolicyOwnership(ctx, "readonlydom1", "policy1", auditRef, new ResourcePolicyOwnership());
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        try {
            zmsTest.putResourceServiceIdentityOwnership(ctx, "readonlydom1", "service1", auditRef,
                    new ResourceServiceIdentityOwnership());
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Read-Only"));
        }

        // now make sure we can read our sys.auth zms service

        ServiceIdentity serviceRes = zmsTest.getServiceIdentity(ctx, "sys.auth", "zms");
        assertNotNull(serviceRes);
        assertEquals(serviceRes.getName(), "sys.auth.zms");

        System.clearProperty(ZMSConsts.ZMS_PROP_READ_ONLY_MODE);
    }

    @Test
    public void testResourceContext() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = (RsrcCtxWrapper) zmsImpl.newResourceContext(zmsTestInitializer.getMockServletContext(),
                zmsTestInitializer.getMockServletRequest(), zmsTestInitializer.getMockServletResponse(), "apiName");
        assertNotNull(ctx);
        assertNotNull(ctx.context());
        assertNull(ctx.principal());
        assertEquals(ctx.servletContext(), zmsTestInitializer.getMockServletContext());
        assertEquals(ctx.request(), zmsTestInitializer.getMockServletRequest());
        assertEquals(ctx.response(), zmsTestInitializer.getMockServletResponse());

        try {
            com.yahoo.athenz.common.server.rest.ResourceException restExc = new com.yahoo.athenz.common.server.rest.ResourceException(401, "failed struct");
            ctx.throwZmsException(restExc);
            fail();
        } catch (ResourceException ex) {
            assertEquals(401, ex.getCode());
            assertEquals( ((ResourceError) ex.data).message, "failed struct");
        }
    }

    @Test
    public void testAssertionMatchAuthenticatedRoles() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Role role = new Role().setName("domain:role.role1");
        ArrayList<Role> roles = new ArrayList<>();
        roles.add(role);

        ArrayList<String> authRoles = new ArrayList<>();
        authRoles.add("domain:role.role1");

        Assertion assertion = new Assertion();
        assertion.setAction("write");
        assertion.setResource("domain:db.write");
        assertion.setRole("domain:role.role1");

        assertTrue(zmsImpl.assertionMatch(assertion, "user.john", "write", "domain:db.write", "domain",
                roles, authRoles, null));

        // check case-sensitive action and resource
        assertion = new Assertion();
        assertion.setAction("write");
        assertion.setResource("domain:db.write");
        assertion.setRole("domain:role.role1");

        assertTrue(zmsImpl.assertionMatch(assertion, "user.john", "write", "domain:db.write", "domain",
                roles, authRoles, null));

        // check case-sensitive assertion
        assertion = new Assertion();
        assertion.setAction("WRITE");
        assertion.setResource("domain:db.WRITE");
        assertion.setRole("domain:role.role1");

        assertTrue(zmsImpl.assertionMatch(assertion, "user.john", "write", "domain:db.write", "domain",
                roles, authRoles, null));
    }

    @Test
    public void testMatchRoleNoRoles() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.matchRole("domain", new ArrayList<>(), "role", null));
    }

    @Test
    public void testMatchRoleNoRoleMatch() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.matchRole("domain", new ArrayList<>(), "domain:role\\.role2.*", null));
    }

    @Test
    public void testMatchRoleAuthRoleNoMatchShortName() {
        Role role = new Role().setName("domain:role.role1");
        ArrayList<Role> roles = new ArrayList<>();
        roles.add(role);

        ArrayList<String> authRoles = new ArrayList<>();
        authRoles.add("role3");

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.matchRole("domain", roles, "domain:role\\.role1.*", authRoles));
    }

    @Test
    public void testMatchRoleAuthRoleNoMatchFullName() {
        Role role = new Role().setName("domain:role.role1");
        ArrayList<Role> roles = new ArrayList<>();
        roles.add(role);

        ArrayList<String> authRoles = new ArrayList<>();
        authRoles.add("domain:role.role3");

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.matchRole("domain", roles, "domain:role\\.role1.*", authRoles));
    }

    @Test
    public void testMatchRoleNoMatchPattern() {
        Role role = new Role().setName("domain:role.role2");
        ArrayList<Role> roles = new ArrayList<>();
        roles.add(role);

        ArrayList<String> authRoles = new ArrayList<>();
        authRoles.add("role3");

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.matchRole("domain", roles, "domain:role\\.role1.*", authRoles));
    }

    @Test
    public void testMatchRoleShortName() {
        Role role = new Role().setName("domain:role.role1");
        ArrayList<Role> roles = new ArrayList<>();
        roles.add(role);

        ArrayList<String> authRoles = new ArrayList<>();
        authRoles.add("role1");

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.matchRole("domain", roles, "domain:role\\.role.*", authRoles));
    }

    @Test
    public void testMatchRoleFullName() {
        Role role = new Role().setName("domain:role.role1");
        ArrayList<Role> roles = new ArrayList<>();
        roles.add(role);

        ArrayList<String> authRoles = new ArrayList<>();
        authRoles.add("domain:role.role1");

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertTrue(zmsImpl.matchRole("domain", roles, "domain:role\\.role.*", authRoles));
    }

    @Test
    public void testServerInternalError() {

        RuntimeException ex = ZMSUtils.internalServerError("unit test", "tester");
        assertTrue(ex.getMessage().contains("{code: 500"));
    }

    @Test
    public void testGetSchema() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        Schema schema = zmsImpl.getRdlSchema(ctx);
        assertNotNull(schema);
    }

    @Test
    public void testValidatePolicyAssertionsInValid() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // assertion missing domain name

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("resource1");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        List<Assertion> assertList = new ArrayList<>();
        assertList.add(assertion);

        try {
            zmsImpl.validatePolicyAssertions(assertList, "domain1", "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // assertion with empty domain name

        assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(":resource1");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        assertList.clear();
        assertList.add(assertion);

        try {
            zmsImpl.validatePolicyAssertions(assertList, "domain1", "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // assertion with invalid domain name

        assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain name:resource1");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        assertList.clear();
        assertList.add(assertion);

        try {
            zmsImpl.validatePolicyAssertions(assertList, "domain1", "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }
    }

    @Test
    public void testValidatePolicyAssertionInValid() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // assertion missing domain name

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("resource1");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        try {
            zmsImpl.validatePolicyAssertion(assertion, "domain1", new HashSet<>(), "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // assertion with empty domain name

        assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(":resource1");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        try {
            zmsImpl.validatePolicyAssertion(assertion, "domain1", new HashSet<>(), "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // assertion with invalid domain name

        assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain name:resource1");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        try {
            zmsImpl.validatePolicyAssertion(assertion, "domain1", new HashSet<>(), "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // assertion with invalid resource name

        assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain1:resource\t\ntest");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        try {
            zmsImpl.validatePolicyAssertion(assertion, "domain1", new HashSet<>(), "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // assertion with null action

        assertion = new Assertion();
        assertion.setAction(null);
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain1:resource1");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        try {
            zmsImpl.validatePolicyAssertion(assertion, "domain1", new HashSet<>(), "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // assertion with empty action

        assertion = new Assertion();
        assertion.setAction("");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain1:resource1");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        try {
            zmsImpl.validatePolicyAssertion(assertion, "domain1", new HashSet<>(), "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }

        // assertion with action containing control characters

        assertion = new Assertion();
        assertion.setAction("update\t");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain1:resource1");
        assertion.setRole(ResourceUtils.roleResourceName("domain1", "role1"));

        try {
            zmsImpl.validatePolicyAssertion(assertion, "domain1", new HashSet<>(), "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
        }
    }

    @Test
    public void testValidatePolicyAssertionsValid() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "domain1";
        String roleName = "role1";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        addRoleNeededForTest(domainName, roleName);
        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain1:resource1");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, roleName));

        List<Assertion> assertList = new ArrayList<>();
        assertList.add(assertion);

        assertion = new Assertion();
        assertion.setAction("play");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("*:resource1");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, roleName));

        assertList.add(assertion);

        assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain1:");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, roleName));

        assertList.add(assertion);

        try {
            zmsImpl.validatePolicyAssertions(assertList, domainName, "unitTest");
        } catch (Exception ex) {
            fail(ex.getMessage());
        }

        // null should also be valid

        try {
            zmsImpl.validatePolicyAssertions(null, domainName, "unitTest");
        } catch (Exception ex) {
            fail(ex.getMessage());
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testValidatePolicyAssertionValid() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "domain1";
        String roleName = "role1";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        addRoleNeededForTest(domainName, roleName);
        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain1:resource1");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, roleName));

        try {
            zmsImpl.validatePolicyAssertion(assertion, domainName, new HashSet<>(), "unitTest");
        } catch (Exception ex) {
            fail(ex.getMessage());
        }

        assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("*:resource1");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, roleName));

        try {
            zmsImpl.validatePolicyAssertion(assertion, domainName, new HashSet<>(), "unitTest");
        } catch (Exception ex) {
            fail(ex.getMessage());
        }

        assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain1:");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, roleName));

        try {
            zmsImpl.validatePolicyAssertion(assertion, domainName, new HashSet<>(), "unitTest");
        } catch (Exception ex) {
            fail(ex.getMessage());
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testValidatePolicyAssertionRoleNames() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "validate-policy-assertion-role";
        final String roleName = "dev-role";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("domain1:resource1");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, roleName));

        // with feature enabled the request is rejected because there is no role

        DynamicConfigBoolean currentValue = zmsImpl.validatePolicyAssertionRoles;
        zmsImpl.validatePolicyAssertionRoles = new DynamicConfigBoolean(true);

        try {
            zmsImpl.validatePolicyAssertion(assertion, domainName, new HashSet<>(), "unitTest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        // now disable the feature and we should be able to process the assertion

        zmsImpl.validatePolicyAssertionRoles = new DynamicConfigBoolean(false);
        try {
            zmsImpl.validatePolicyAssertion(assertion, domainName, new HashSet<>(), "unitTest");
        } catch (ResourceException ex) {
            fail(ex.getMessage());
        }

        zmsImpl.validatePolicyAssertionRoles = currentValue;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testValidatePolicyAssertionConditionsValid() {
        // TODO this is only a skeleton, we need to add more tests once the validateAssertionConditions func implemented

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        zmsImpl.validatePolicyAssertionConditions(null, "unittest");
        Assertion a = new Assertion();
        AssertionCondition ac = createAssertionConditionObject(1, "enforcementstate", "report");
        addEntryToConditionMap(ac.getConditionsMap(), "instances", "*");
        addEntryToConditionMap(ac.getConditionsMap(), "scopeaws", "true");
        addEntryToConditionMap(ac.getConditionsMap(), "scopeonprem", "false");
        addEntryToConditionMap(ac.getConditionsMap(), "scopeall", "false");
        zmsImpl.validatePolicyAssertionConditions(List.of(a), "unittest");
    }

    @Test
    public void testValidatePolicyAssertionConditionsInvalid() {
        // TODO this is only a skeleton, we need to add tests once the validateAssertionConditions func implemented
    }

    @Test
    public void testSetupRoleListWithMembers() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "setuprolelistwithmembers";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null, "user.joe",
                "user.jane");
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(domainName, "Role2", null, "user.doe",
                "user.janie");
        zmsImpl.putRole(ctx, domainName, "Role2", auditRef, false, null, role2);

        Role role3 = zmsTestInitializer.createRoleObject(domainName, "Role3", "sys.auth", null, null);
        zmsImpl.putRole(ctx, domainName, "Role3", auditRef, false, null, role3);

        AthenzDomain domain = zmsImpl.getAthenzDomain(domainName, false);
        List<Role> roles = zmsImpl.setupRoleList(domain, Boolean.TRUE, null, null);
        assertEquals(4, roles.size()); // need to account for admin role

        boolean role1Check = false;
        boolean role2Check = false;
        boolean role3Check = false;

        for (Role role : roles) {
            switch (role.getName()) {
                case "setuprolelistwithmembers:role.role1":
                    List<String> checkList = new ArrayList<>();
                    checkList.add("user.joe");
                    checkList.add("user.jane");
                    zmsTestInitializer.checkRoleMember(checkList, role.getRoleMembers());
                    assertEquals(role.getRoleMembers().size(), 2);
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    role1Check = true;
                    break;
                case "setuprolelistwithmembers:role.role2":
                    List<String> checkList2 = new ArrayList<>();
                    checkList2.add("user.doe");
                    checkList2.add("user.janie");
                    zmsTestInitializer.checkRoleMember(checkList2, role.getRoleMembers());
                    assertEquals(role.getRoleMembers().size(), 2);
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    role2Check = true;
                    break;
                case "setuprolelistwithmembers:role.role3":
                    assertEquals(role.getTrust(), "sys.auth");
                    assertNull(role.getRoleMembers());
                    role3Check = true;
                    assertNotNull(role.getModified());
                    break;
            }
        }

        assertTrue(role1Check);
        assertTrue(role2Check);
        assertTrue(role3Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testSetupRoleListWithOutMembers() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "setuprolelistwithoutmembers";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null, "user.joe",
                "user.jane");
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(domainName, "Role2", null, "user.doe",
                "user.janie");
        zmsImpl.putRole(ctx, domainName, "Role2", auditRef, false, null, role2);

        Role role3 = zmsTestInitializer.createRoleObject(domainName, "Role3", "sys.auth", null, null);
        zmsImpl.putRole(ctx, domainName, "Role3", auditRef, false, null, role3);

        Role role4 = zmsTestInitializer.createRoleObject(domainName, "Role4", null, "user.doe",
                "user.jane");
        zmsImpl.putRole(ctx, domainName, "Role4", auditRef, false, null, role4);

        RoleMeta rm = ZMSTestUtils.createRoleMetaObject(true);
        rm.setReviewEnabled(true);
        rm.setDeleteProtection(true);
        rm.setMemberExpiryDays(45);
        rm.setCertExpiryMins(55);
        rm.setServiceExpiryDays(45);
        rm.setGroupExpiryDays(50);
        rm.setTokenExpiryMins(65);
        rm.setMemberReviewDays(70);
        rm.setServiceReviewDays(80);
        rm.setGroupReviewDays(90);
        rm.setSignAlgorithm("ec");
        rm.setDescription("testroledescription");
        zmsImpl.putRoleMeta(ctx, domainName, "role4", auditRef, null, rm);

        AthenzDomain domain = zmsImpl.getAthenzDomain(domainName, false);
        List<Role> roles = zmsImpl.setupRoleList(domain, Boolean.FALSE, null, null);
        assertEquals(5, roles.size()); // need to account for admin role

        boolean role1Check = false;
        boolean role2Check = false;
        boolean role3Check = false;
        boolean role4Check = false;

        for (Role role : roles) {
            switch (role.getName()) {
                case "setuprolelistwithoutmembers:role.role1":
                    assertNull(role.getRoleMembers());
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    role1Check = true;
                    break;
                case "setuprolelistwithoutmembers:role.role2":
                    assertNull(role.getRoleMembers());
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    role2Check = true;
                    break;
                case "setuprolelistwithoutmembers:role.role3":
                    assertEquals(role.getTrust(), "sys.auth");
                    assertNull(role.getRoleMembers());
                    role3Check = true;
                    assertNotNull(role.getModified());
                    break;
                case "setuprolelistwithoutmembers:role.role4":
                    assertNull(role.getRoleMembers());
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    assertNull(role.getLastReviewedDate());
                    assertEquals(role.getMemberExpiryDays().intValue(), 45);
                    assertEquals(role.getCertExpiryMins().intValue(), 55);
                    assertEquals(role.getServiceExpiryDays().intValue(), 45);
                    assertEquals(role.getGroupExpiryDays().intValue(), 50);
                    assertEquals(role.getTokenExpiryMins().intValue(), 65);
                    assertEquals(role.getMemberReviewDays().intValue(), 70);
                    assertEquals(role.getServiceReviewDays().intValue(), 80);
                    assertEquals(role.getGroupReviewDays().intValue(), 90);
                    assertNotNull(role.getSignAlgorithm());
                    assertNotNull(role.getDescription());
                    assertTrue(role.getReviewEnabled());
                    assertTrue(role.getDeleteProtection());
                    assertTrue(role.getSelfServe());
                    assertNull(role.getAuditEnabled());
                    role4Check = true;
                    break;
            }
        }

        assertTrue(role1Check);
        assertTrue(role2Check);
        assertTrue(role3Check);
        assertTrue(role4Check);

        // we'll do the same check this time passing null
        // for the boolean flag instead of false

        roles = zmsImpl.setupRoleList(domain, null, null, null);
        assertEquals(5, roles.size()); // need to account for admin role

        role1Check = false;
        role2Check = false;
        role3Check = false;
        role4Check = false;

        for (Role role : roles) {
            switch (role.getName()) {
                case "setuprolelistwithoutmembers:role.role1":
                    assertNull(role.getRoleMembers());
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    role1Check = true;
                    break;
                case "setuprolelistwithoutmembers:role.role2":
                    assertNull(role.getRoleMembers());
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    role2Check = true;
                    break;
                case "setuprolelistwithoutmembers:role.role3":
                    assertEquals(role.getTrust(), "sys.auth");
                    assertNull(role.getRoleMembers());
                    role3Check = true;
                    assertNotNull(role.getModified());
                    break;
                case "setuprolelistwithoutmembers:role.role4":
                    assertNull(role.getRoleMembers());
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    assertNull(role.getLastReviewedDate());
                    assertEquals(role.getMemberExpiryDays().intValue(), 45);
                    assertEquals(role.getCertExpiryMins().intValue(), 55);
                    assertEquals(role.getServiceExpiryDays().intValue(), 45);
                    assertEquals(role.getGroupExpiryDays().intValue(), 50);
                    assertEquals(role.getTokenExpiryMins().intValue(), 65);
                    assertEquals(role.getMemberReviewDays().intValue(), 70);
                    assertEquals(role.getServiceReviewDays().intValue(), 80);
                    assertEquals(role.getGroupReviewDays().intValue(), 90);
                    assertNotNull(role.getSignAlgorithm());
                    assertTrue(role.getReviewEnabled());
                    assertTrue(role.getDeleteProtection());
                    assertTrue(role.getSelfServe());
                    role4Check = true;
                    break;
            }
        }

        assertTrue(role1Check);
        assertTrue(role2Check);
        assertTrue(role3Check);
        assertTrue(role4Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetRoles() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "getroles";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "Role1", null, "user.joe",
                "user.jane");
        zmsImpl.putRole(ctx, domainName, "Role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(domainName, "Role2", null, "user.doe",
                "user.janie");
        zmsImpl.putRole(ctx, domainName, "Role2", auditRef, false, null, role2);

        Role role3 = zmsTestInitializer.createRoleObject(domainName, "Role3", "sys.auth", null, null);
        zmsImpl.putRole(ctx, domainName, "Role3", auditRef, false, null, role3);

        Roles roleList = zmsImpl.getRoles(ctx, domainName, Boolean.TRUE, null, null);
        List<Role> roles = roleList.getList();
        assertEquals(4, roles.size()); // need to account for admin role

        boolean role1Check = false;
        boolean role2Check = false;
        boolean role3Check = false;

        for (Role role : roles) {
            switch (role.getName()) {
                case "getroles:role.role1":
                    List<String> checkList = new ArrayList<>();
                    checkList.add("user.joe");
                    checkList.add("user.jane");
                    zmsTestInitializer.checkRoleMember(checkList, role.getRoleMembers());
                    assertEquals(role.getRoleMembers().size(), 2);
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    role1Check = true;
                    break;
                case "getroles:role.role2":
                    List<String> checkList2 = new ArrayList<>();
                    checkList2.add("user.doe");
                    checkList2.add("user.janie");
                    zmsTestInitializer.checkRoleMember(checkList2, role.getRoleMembers());
                    assertEquals(role.getRoleMembers().size(), 2);
                    assertNull(role.getTrust());
                    assertNotNull(role.getModified());
                    role2Check = true;
                    break;
                case "getroles:role.role3":
                    assertEquals(role.getTrust(), "sys.auth");
                    assertNull(role.getRoleMembers());
                    role3Check = true;
                    assertNotNull(role.getModified());
                    break;
            }
        }

        assertTrue(role1Check);
        assertTrue(role2Check);
        assertTrue(role3Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetRolesInvalidDomain() {

        final String domainName = "getrolesinvaliddomain";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getRoles(ctx, domainName, null, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }
    }

    @Test
    public void testSetupPolicyListWithAssertionsBothActive() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "setup-policy-with-assert";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName, "policy2");
        zmsImpl.putPolicy(ctx, domainName, "policy2", auditRef, false, null, policy2);

        AthenzDomain domain = zmsImpl.getAthenzDomain(domainName, false);
        List<Policy> policies = zmsImpl.setupPolicyList(domain, Boolean.TRUE, Boolean.FALSE, null, null);
        assertEquals(3, policies.size()); // need to account for admin policy

        boolean policy1Check = false;
        boolean policy2Check = false;

        List<Assertion> testAssertions;
        for (Policy policy : policies) {
            switch (policy.getName()) {
                case "setup-policy-with-assert:policy.policy1":
                    testAssertions = policy.getAssertions();
                    assertEquals(testAssertions.size(), 1);
                    policy1Check = true;
                    break;
                case "setup-policy-with-assert:policy.policy2":
                    testAssertions = policy.getAssertions();
                    assertEquals(testAssertions.size(), 1);
                    policy2Check = true;
                    break;
            }
        }

        assertTrue(policy1Check);
        assertTrue(policy2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testSetupPolicyListWithAssertionsActiveOnly() {

        final String domainName = "setup-policy-with-assert-active-only";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "policy1").setActive(true);
        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName, "policy2").setActive(false);

        List<Policy> policyList = new ArrayList<>();
        policyList.add(policy1);
        policyList.add(policy2);

        AthenzDomain domain = new AthenzDomain(domainName);
        domain.setPolicies(policyList);

        List<Policy> policies = zmsImpl.setupPolicyList(domain, Boolean.TRUE, Boolean.FALSE, null, null);
        assertEquals(1, policies.size());
        assertEquals(policies.get(0).getName(), "setup-policy-with-assert-active-only:policy.policy1");
    }

    @Test
    public void testSetupPolicyListWithAssertionsAllVersions() {

        final String domainName = "setup-policy-with-assert-all-versions";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "policy1").setActive(true).setVersion("ver1");
        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName, "policy2").setActive(false).setVersion("ver2");

        List<Policy> policyList = new ArrayList<>();
        policyList.add(policy1);
        policyList.add(policy2);

        AthenzDomain domain = new AthenzDomain(domainName);
        domain.setPolicies(policyList);

        List<Policy> policies = zmsImpl.setupPolicyList(domain, Boolean.TRUE, Boolean.TRUE, null, null);
        assertEquals(2, policies.size());
        assertEquals(policies.get(0).getName(), "setup-policy-with-assert-all-versions:policy.policy1");
        assertEquals(policies.get(0).getVersion(), "ver1");
        assertTrue(policies.get(0).getActive());
        assertEquals(policies.get(1).getName(), "setup-policy-with-assert-all-versions:policy.policy2");
        assertEquals(policies.get(1).getVersion(), "ver2");
        assertFalse(policies.get(1).getActive());

        policies = zmsImpl.setupPolicyList(domain, Boolean.FALSE, Boolean.TRUE, null, null);
        assertEquals(2, policies.size());
        assertEquals(policies.get(0).getName(), "setup-policy-with-assert-all-versions:policy.policy1");
        assertEquals(policies.get(0).getVersion(), "ver1");
        assertTrue(policies.get(0).getActive());
        assertEquals(policies.get(1).getName(), "setup-policy-with-assert-all-versions:policy.policy2");
        assertEquals(policies.get(1).getVersion(), "ver2");
        assertFalse(policies.get(1).getActive());
    }

    @Test
    public void testGetPolicies() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-policies";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName, "policy2");
        zmsImpl.putPolicy(ctx, domainName, "policy2", auditRef, false, null, policy2);

        Policies policyList = zmsImpl.getPolicies(ctx, domainName, Boolean.TRUE, Boolean.FALSE, null, null);
        List<Policy> policies = policyList.getList();
        assertEquals(3, policies.size()); // need to account for admin policy

        boolean policy1Check = false;
        boolean policy2Check = false;

        List<Assertion> testAssertions;
        for (Policy policy : policies) {
            switch (policy.getName()) {
                case "get-policies:policy.policy1":
                    testAssertions = policy.getAssertions();
                    assertEquals(testAssertions.size(), 1);
                    policy1Check = true;
                    break;
                case "get-policies:policy.policy2":
                    testAssertions = policy.getAssertions();
                    assertEquals(testAssertions.size(), 1);
                    policy2Check = true;
                    break;
            }
        }

        assertTrue(policy1Check);
        assertTrue(policy2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetPolicyVersions() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-policies";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1);
        zmsImpl.putPolicyVersion(ctx, domainName, "policy1", new PolicyOptions().setVersion("version2"), auditRef, false, null);

        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName, "policy2");
        zmsImpl.putPolicy(ctx, domainName, "policy2", auditRef, false, null, policy2);
        zmsImpl.putPolicyVersion(ctx, domainName, "policy2", new PolicyOptions().setVersion("new-version"), auditRef, false, null);

        Policies policyList = zmsImpl.getPolicies(ctx, domainName, Boolean.TRUE, Boolean.TRUE, null, null);
        List<Policy> policies = policyList.getList();
        assertEquals(5, policies.size()); // need to account for admin policy
        // set our default versions for our policy objects
        policy1.setVersion("0");
        policy2.setVersion("0");
        assertTrue(checkPolicyList(policies, policy1));
        policy1.setVersion("version2");
        policy1.setActive(false);
        assertTrue(checkPolicyList(policies, policy1));
        assertTrue(checkPolicyList(policies, policy2));
        policy2.setVersion("new-version");
        policy2.setActive(false);
        assertTrue(checkPolicyList(policies, policy2));

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    boolean checkPolicyList(List<Policy> policies, Policy checkPolicy) {
        for (Policy policy : policies) {
            if (policy.getName().equals(checkPolicy.getName()) && policy.getVersion().equals(checkPolicy.getVersion())) {
                return true;
            }
        }
        return false;
    }
    @Test
    public void testGetPoliciesInvalidDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        String domainName = "get-policies-invalid-domain";

        try {
            zmsImpl.getPolicies(ctx, domainName, Boolean.TRUE, Boolean.FALSE, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }
    }

    @Test
    public void testSetupPolicyListWithOutAssertions() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "setup-policy-without-assert";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName, "policy2");
        zmsImpl.putPolicy(ctx, domainName, "policy2", auditRef, false, null, policy2);

        AthenzDomain domain = zmsImpl.getAthenzDomain(domainName, false);
        List<Policy> policies = zmsImpl.setupPolicyList(domain, Boolean.FALSE, Boolean.FALSE, null, null);
        assertEquals(3, policies.size()); // need to account for admin policy

        boolean policy1Check = false;
        boolean policy2Check = false;

        for (Policy policy : policies) {
            switch (policy.getName()) {
                case "setup-policy-without-assert:policy.policy1":
                    assertNull(policy.getAssertions());
                    policy1Check = true;
                    break;
                case "setup-policy-without-assert:policy.policy2":
                    assertNull(policy.getAssertions());
                    policy2Check = true;
                    break;
            }
        }

        assertTrue(policy1Check);
        assertTrue(policy2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetServiceIdentities() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-services";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject(domainName,
                "service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        zmsImpl.putServiceIdentity(ctx,
                domainName, "service1", auditRef, true, null, service1);

        ServiceIdentity service2 = zmsTestInitializer.createServiceObject(domainName,
                "service2", "http://localhost", "/usr/bin/java", "yahoo",
                "users", "host2");

        zmsImpl.putServiceIdentity(ctx, domainName, "service2",
                auditRef, false, null, service2);

        ServiceIdentities serviceList = zmsImpl.getServiceIdentities(ctx,
                domainName, Boolean.TRUE, Boolean.TRUE, null, null);
        List<ServiceIdentity> services = serviceList.getList();
        assertEquals(2, services.size());

        boolean service1Check = false;
        boolean service2Check = false;

        for (ServiceIdentity service : services) {
            switch (service.getName()) {
                case "get-services.service1":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "root");
                    assertEquals(service.getPublicKeys().size(), 2);
                    assertEquals(service.getHosts().size(), 1);
                    assertEquals(service.getHosts().get(0), "host1");
                    service1Check = true;
                    break;
                case "get-services.service2":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "yahoo");
                    assertEquals(service.getPublicKeys().size(), 2);
                    assertEquals(service.getHosts().size(), 1);
                    assertEquals(service.getHosts().get(0), "host2");
                    assertEquals(service.getDescription(), "test");
                    service2Check = true;
                    break;
            }
        }

        assertTrue(service1Check);
        assertTrue(service2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetServiceIdentitiesInvalidDomain() {

        String domainName = "get-services-invalid-domain";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getServiceIdentities(ctx, domainName,
                    Boolean.TRUE, Boolean.TRUE, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }
    }

    @Test
    public void testSetupServiceListWithKeysHosts() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "setup-service-keys-hosts";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject(domainName,
                "service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        zmsImpl.putServiceIdentity(ctx, domainName, "service1", auditRef, false, null, service1);

        ServiceIdentity service2 = zmsTestInitializer.createServiceObject(domainName,
                "service2", "http://localhost", "/usr/bin/java", "yahoo",
                "users", "host2");
        zmsImpl.putServiceIdentity(ctx, domainName, "service2", auditRef, false, null, service2);

        AthenzDomain domain = zmsImpl.getAthenzDomain(domainName, false);
        List<ServiceIdentity> services = zmsImpl.setupServiceIdentityList(domain,
                Boolean.TRUE, Boolean.TRUE, null, null);
        assertEquals(2, services.size());

        boolean service1Check = false;
        boolean service2Check = false;

        for (ServiceIdentity service : services) {
            switch (service.getName()) {
                case "setup-service-keys-hosts.service1":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "root");
                    assertEquals(service.getPublicKeys().size(), 2);
                    assertEquals(service.getHosts().size(), 1);
                    assertEquals(service.getHosts().get(0), "host1");
                    service1Check = true;
                    break;
                case "setup-service-keys-hosts.service2":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "yahoo");
                    assertEquals(service.getPublicKeys().size(), 2);
                    assertEquals(service.getHosts().size(), 1);
                    assertEquals(service.getHosts().get(0), "host2");
                    service2Check = true;
                    break;
            }
        }

        assertTrue(service1Check);
        assertTrue(service2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testSetupServiceListWithOutKeysHosts() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "setup-service-without-keys-hosts";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject(domainName,
                "service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        zmsImpl.putServiceIdentity(ctx, domainName, "service1", auditRef, false, null, service1);

        ServiceIdentity service2 = zmsTestInitializer.createServiceObject(domainName,
                "service2", "http://localhost", "/usr/bin/java", "yahoo",
                "users", "host2");
        zmsImpl.putServiceIdentity(ctx, domainName, "service2", auditRef, false, null, service2);

        AthenzDomain domain = zmsImpl.getAthenzDomain(domainName, false);
        List<ServiceIdentity> services = zmsImpl.setupServiceIdentityList(domain,
                Boolean.FALSE, Boolean.FALSE, null, null);
        assertEquals(2, services.size());

        boolean service1Check = false;
        boolean service2Check = false;

        for (ServiceIdentity service : services) {
            switch (service.getName()) {
                case "setup-service-without-keys-hosts.service1":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "root");
                    assertNull(service.getPublicKeys());
                    assertNull(service.getHosts());
                    service1Check = true;
                    break;
                case "setup-service-without-keys-hosts.service2":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "yahoo");
                    assertNull(service.getPublicKeys());
                    assertNull(service.getHosts());
                    service2Check = true;
                    break;
            }
        }

        assertTrue(service1Check);
        assertTrue(service2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testSetupServiceListWithKeysOnly() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "setup-service-keys-only";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject(domainName,
                "service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        zmsImpl.putServiceIdentity(ctx, domainName, "service1", auditRef, false, null, service1);

        ServiceIdentity service2 = zmsTestInitializer.createServiceObject(domainName,
                "service2", "http://localhost", "/usr/bin/java", "yahoo",
                "users", "host2");
        zmsImpl.putServiceIdentity(ctx, domainName, "service2", auditRef, false, null, service2);

        AthenzDomain domain = zmsImpl.getAthenzDomain(domainName, false);
        List<ServiceIdentity> services = zmsImpl.setupServiceIdentityList(domain,
                Boolean.TRUE, Boolean.FALSE, null, null);
        assertEquals(2, services.size());

        boolean service1Check = false;
        boolean service2Check = false;

        for (ServiceIdentity service : services) {
            switch (service.getName()) {
                case "setup-service-keys-only.service1":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "root");
                    assertEquals(service.getPublicKeys().size(), 2);
                    assertNull(service.getHosts());
                    service1Check = true;
                    break;
                case "setup-service-keys-only.service2":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "yahoo");
                    assertEquals(service.getPublicKeys().size(), 2);
                    assertNull(service.getHosts());
                    service2Check = true;
                    break;
            }
        }

        assertTrue(service1Check);
        assertTrue(service2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testSetupServiceListWithHostsOnly() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "setup-service-hosts-only";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject(domainName,
                "service1", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");
        zmsImpl.putServiceIdentity(ctx, domainName, "service1", auditRef, false, null, service1);

        ServiceIdentity service2 = zmsTestInitializer.createServiceObject(domainName,
                "service2", "http://localhost", "/usr/bin/java", "yahoo",
                "users", "host2");
        zmsImpl.putServiceIdentity(ctx, domainName, "service2", auditRef, false, null, service2);

        AthenzDomain domain = zmsImpl.getAthenzDomain(domainName, false);
        List<ServiceIdentity> services = zmsImpl.setupServiceIdentityList(domain,
                Boolean.FALSE, Boolean.TRUE, null, null);
        assertEquals(2, services.size());

        boolean service1Check = false;
        boolean service2Check = false;

        for (ServiceIdentity service : services) {
            switch (service.getName()) {
                case "setup-service-hosts-only.service1":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "root");
                    assertNull(service.getPublicKeys());
                    assertEquals(service.getHosts().size(), 1);
                    assertEquals(service.getHosts().get(0), "host1");
                    service1Check = true;
                    break;
                case "setup-service-hosts-only.service2":
                    assertEquals(service.getExecutable(), "/usr/bin/java");
                    assertEquals(service.getUser(), "yahoo");
                    assertNull(service.getPublicKeys());
                    assertEquals(service.getHosts().size(), 1);
                    assertEquals(service.getHosts().get(0), "host2");
                    service2Check = true;
                    break;
            }
        }

        assertTrue(service1Check);
        assertTrue(service2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetAssertion() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-assertion";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);

        Policy policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");
        Long assertionId = policyRes.getAssertions().get(0).getId();

        Assertion assertion = zmsImpl.getAssertion(ctx, domainName, "policy1", assertionId);
        assertNotNull(assertion);
        assertEquals(assertion.getAction(), "*");
        assertEquals(assertion.getResource(), domainName + ":*");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetAssertionActivePolicy() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-assertion";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Create policy
        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);

        // Create policy version
        zmsImpl.putPolicyVersion(ctx, domainName, "policy1", new PolicyOptions().setVersion("new-version"), auditRef, false, null);

        // Add assertion to policy
        Assertion assertion = new Assertion();
        assertion.setAction("testactive");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));
        zmsImpl.putAssertion(ctx, domainName, "policy1", auditRef, null, assertion);

        // Make sure it is added to active policy version
        Policy policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");
        Long assertionId = policyRes.getAssertions().get(1).getId();
        assertion = zmsImpl.getAssertion(ctx, domainName, "policy1", assertionId);
        assertNotNull(assertion);
        assertEquals(assertion.getAction(), "testactive");
        assertEquals(assertion.getResource(), domainName + ":resource");

        // Make sure it isn't added to non-active policy version
        policyRes = zmsImpl.getPolicyVersion(ctx, domainName, "policy1", "new-version");
        assertEquals(policyRes.getAssertions().size(), 1);
        assertEquals(policyRes.getAssertions().get(0).getAction(), "*");
        assertEquals(policyRes.getAssertions().get(0).getResource(), domainName + ":*");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetAssertionCaseSensitive() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-assertion";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        addRoleNeededForTest(domainName, "Role1");

        // Create case-sensitive policy
        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1", "Role1", "ActioN1", "GeT-AssertioN:SomeResource", AssertionEffect.ALLOW);
        policy.setCaseSensitive(true);

        // Create case-insensitive policy
        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName, "policy2", "Role1", "ActioN2", "GeT-AssertioN:SomeResource2", AssertionEffect.ALLOW);

        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);
        zmsImpl.putPolicy(ctx, domainName, "policy2", auditRef, false, null, policy2);

        Policy policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");
        Long assertionId = policyRes.getAssertions().get(0).getId();

        Assertion assertion = zmsImpl.getAssertion(ctx, domainName, "policy1", assertionId);
        assertNotNull(assertion);
        assertEquals(assertion.getAction(), "ActioN1");
        assertEquals(assertion.getResource(), domainName + ":SomeResource");

        policyRes = zmsImpl.getPolicy(ctx, domainName, "policy2");
        assertionId = policyRes.getAssertions().get(0).getId();

        assertion = zmsImpl.getAssertion(ctx, domainName, "policy2", assertionId);
        assertNotNull(assertion);
        assertEquals(assertion.getAction(), "action2");
        assertEquals(assertion.getResource(), domainName + ":someresource2");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetAssertionMultiple() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-assertion-multiple";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));

        // Create case-sensitive assertion
        Assertion assertion2 = new Assertion();
        assertion2.setAction("UpdatE2");
        assertion2.setEffect(AssertionEffect.ALLOW);
        assertion2.setResource(domainName + ":ResourcE2");
        assertion2.setRole(ResourceUtils.roleResourceName(domainName, "admin"));
        assertion2.setCaseSensitive(true);

        // Put both assertions
        policy.getAssertions().add(assertion);
        policy.getAssertions().add(assertion2);

        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);

        Policy policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");
        List<Assertion> testAssertions = new ArrayList<>();

        Long assertionId = policyRes.getAssertions().get(0).getId();
        Assertion testAssertion = zmsImpl.getAssertion(ctx, domainName, "policy1", assertionId);
        assertNotNull(testAssertion);
        testAssertions.add(testAssertion);

        assertionId = policyRes.getAssertions().get(1).getId();
        testAssertion = zmsImpl.getAssertion(ctx, domainName, "policy1", assertionId);
        assertNotNull(testAssertion);
        testAssertions.add(testAssertion);

        assertionId = policyRes.getAssertions().get(2).getId();
        testAssertion = zmsImpl.getAssertion(ctx, domainName, "policy1", assertionId);
        assertNotNull(testAssertion);
        testAssertions.add(testAssertion);

        boolean assert1Check = false;
        boolean assert2Check = false;
        boolean assert3Check = false;
        for (Assertion testAssert : testAssertions) {
            switch (testAssert.getAction()) {
                case "*":
                    assertEquals(testAssert.getResource(), domainName + ":*");
                    assert1Check = true;
                    break;
                case "update":
                    assertEquals(testAssert.getResource(), domainName + ":resource");
                    assert2Check = true;
                    break;
                case "UpdatE2":
                    assertEquals(testAssert.getResource(), domainName + ":ResourcE2");
                    assert3Check = true;
                    break;
            }
        }
        assertTrue(assert1Check);
        assertTrue(assert2Check);
        assertTrue(assert3Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetAssertionUnknownId() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-assertion-invalid";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);

        try {
            zmsImpl.getAssertion(ctx, domainName, "policy1", 1L);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutAssertion() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-assertion";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));

        // add the assertion

        assertion = zmsImpl.putAssertion(ctx, domainName, "policy1", auditRef, null, assertion);

        // verity that the return assertion object has the id set

        assertNotNull(assertion.getId());

        // validate that both assertions exist

        Policy policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");

        boolean assert1Check = false;
        boolean assert2Check = false;
        for (Assertion testAssert : policyRes.getAssertions()) {
            switch (testAssert.getAction()) {
                case "*":
                    assertEquals(testAssert.getResource(), domainName + ":*");
                    assert1Check = true;
                    break;
                case "update":
                    assertEquals(testAssert.getResource(), domainName + ":resource");
                    assert2Check = true;
                    break;
            }
        }
        assertTrue(assert1Check);
        assertTrue(assert2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutAssertionItsRoleDoesNotExist(){

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-assertion";
        final String policyName = "policy1";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, policyName);
        zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy);

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "not-exist"));

        // add the assertion - should be fail
        try {
            zmsImpl.putAssertion(ctx, domainName, policyName, auditRef, null, assertion);
            fail("should be fail");
        } catch (ResourceException ex){
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("that associated to an assertion"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        }
    }

    @Test
    public void testPutAssertionCaseSensitive() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-assertion";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);

        Assertion assertion = new Assertion();
        assertion.setAction("Update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":Resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));
        assertion.setCaseSensitive(true);

        // add the assertion

        assertion = zmsImpl.putAssertion(ctx, domainName, "policy1", auditRef, null, assertion);

        // verity that the return assertion object has the id set

        assertNotNull(assertion.getId());

        // validate that both assertions exist

        Policy policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");

        boolean assert1Check = false;
        boolean assert2Check = false;
        for (Assertion testAssert : policyRes.getAssertions()) {
            switch (testAssert.getAction()) {
                case "*":
                    assertEquals(testAssert.getResource(), domainName + ":*");
                    assert1Check = true;
                    break;
                case "Update":
                    assertEquals(testAssert.getResource(), domainName + ":Resource");
                    assert2Check = true;
                    break;
            }
        }
        assertTrue(assert1Check);
        assertTrue(assert2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testAddDefaultAdminAssertion() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-default-assertion";
        final String policyName = "policy1";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // add an empty policy to the domain

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, policyName);
        zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy);

        // add invalid assertions that will be skipped by the call
        // and we'll add the default assertion

        List<Assertion> assertList = new ArrayList<>();

        Assertion assertion = new Assertion();
        assertion.setResource(null);
        assertList.add(assertion);

        assertion = new Assertion();
        assertion.setResource(domainName + ":test");
        assertion.setAction(null);
        assertList.add(assertion);

        assertion = new Assertion();
        assertion.setResource(domainName + ":test");
        assertion.setAction("update");
        assertion.setRole(null);
        assertList.add(assertion);

        assertion = new Assertion();
        assertion.setResource(domainName + ":test");
        assertion.setAction("update");
        assertion.setRole("admin");
        assertList.add(assertion);

        assertion = new Assertion();
        assertion.setResource(domainName + ":test");
        assertion.setAction("update");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));
        assertion.setEffect(AssertionEffect.DENY);
        assertList.add(assertion);

        // add the assertion

        policy.setAssertions(assertList);
        zmsImpl.addDefaultAdminAssertion(ctx, domainName, policy, auditRef, "unit-test");

        // validate admin policy is correct set with assertion

        Policy policyRes = zmsImpl.getPolicy(ctx, domainName, "admin");

        boolean assert1Check = false;
        for (Assertion testAssert : policyRes.getAssertions()) {
            if ("*".equals(testAssert.getAction())) {
                assertEquals(testAssert.getResource(), domainName + ":*");
                assert1Check = true;
                break;
            }
        }
        assertTrue(assert1Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutAssertionAdminReject() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-assertion-admin";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));

        try {
            zmsImpl.putAssertion(ctx, domainName, "admin", auditRef, null, assertion);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("admin policy cannot be modified"), ex.getMessage());
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutAssertionWithoutDomainPrefixForRole() {

        final String domainName = "put-invalid-assertion";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole("role_with_out_prefix");

        try {
            zmsImpl.putAssertion(ctx, domainName, "policy1", auditRef, null, assertion);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("that associated to an assertion"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutAssertionUnknownPolicy() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-assertion-unknown";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));

        // add the assertion which should fail due to unknown policy name

        try {
            zmsImpl.putAssertion(ctx, domainName, "policy2", auditRef, null, assertion);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteAssertionSingle() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "delete-assertion-single";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);

        // now let's delete the assertion directly

        Policy policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");
        Long assertionId = policyRes.getAssertions().get(0).getId();

        zmsImpl.deleteAssertion(ctx, domainName, "policy1", assertionId, auditRef, null);

        policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");
        assertEquals(policyRes.getAssertions().size(), 0);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteAssertionMultiple() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "delete-assertion-multiple";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));
        policy.getAssertions().add(assertion);
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);

        Policy policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");

        // we are going to delete assertion at index 0

        Long assertionId = policyRes.getAssertions().get(0).getId();
        zmsImpl.deleteAssertion(ctx, domainName, "policy1", assertionId, auditRef, null);

        // remember the assertion action for index 1

        String action = policyRes.getAssertions().get(1).getAction();

        // fetch the policy again and verify the action

        policyRes = zmsImpl.getPolicy(ctx, domainName, "policy1");
        assertEquals(policyRes.getAssertions().size(), 1);
        assertEquals(policyRes.getAssertions().get(0).getAction(), action);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteAssertionAdminReject() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "delete-assertion-admin";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        try {
            zmsImpl.deleteAssertion(ctx, domainName, "admin", 101L, auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("admin policy cannot be modified"), ex.getMessage());
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteAssertionUnknown() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "delete-assertion-unknown";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy);

        // delete the assertion which should fail due to unknown policy name

        try {
            zmsImpl.deleteAssertion(ctx, domainName, "policy2", 1L, auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        // delete the assertion which should fail due to unknown assertion id

        try {
            zmsImpl.deleteAssertion(ctx, domainName, "policy1", 1L, auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetPolicyListWithoutAssertionId() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertNull(zmsImpl.getDomainPolicyList(null, false));

        List<Policy> emptyList = new ArrayList<>();
        List<Policy> result = zmsImpl.getDomainPolicyList(emptyList, false);
        assertTrue(result.isEmpty());

        final String domainName = "assertion-test";
        Policy policy = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        policy.setCaseSensitive(true);
        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));
        assertion.setId(101L);
        assertion.setCaseSensitive(true);
        policy.getAssertions().add(assertion);

        List<Policy> policyList = new ArrayList<>();
        policyList.add(policy);

        result = zmsImpl.getDomainPolicyList(policyList, false);
        assertEquals(result.size(), 1);
        Assertion testAssertion = result.get(0).getAssertions().get(0);
        assertNull(testAssertion.getId());
        assertEquals(assertion.getAction(), "update");
        assertEquals(assertion.getEffect(), AssertionEffect.ALLOW);
        assertEquals(assertion.getResource(), domainName + ":resource");
        assertEquals(assertion.getRole(), ResourceUtils.roleResourceName(domainName, "admin"));

        // Verify case-sensitivity isn't returned
        assertNull(result.get(0).getCaseSensitive());
        assertNull(testAssertion.getCaseSensitive());
    }

    @Test
    public void testIsConsistentRoleName() {

        Role role = new Role();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        role.setName("domain1:role.role1");
        assertTrue(zmsImpl.isConsistentRoleName("domain1", "role1", role));

        // local name behavior

        role.setName("role1");
        assertTrue(zmsImpl.isConsistentRoleName("domain1", "role1", role));
        assertEquals(role.getName(), "domain1:role.role1");

        // inconsistent behavior

        role.setName("domain1:role.role1");
        assertFalse(zmsImpl.isConsistentRoleName("domain1", "role2", role));

        role.setName("role1");
        assertFalse(zmsImpl.isConsistentRoleName("domain1", "role2", role));
    }

    @Test
    public void testIsConsistentPolicyName() {

        Policy policy = new Policy();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        policy.setName("domain1:policy.policy1");
        assertTrue(zmsImpl.isConsistentPolicyName("domain1", "policy1", policy));

        // local name behavior

        policy.setName("policy1");
        assertTrue(zmsImpl.isConsistentPolicyName("domain1", "policy1", policy));
        assertEquals(policy.getName(), "domain1:policy.policy1");

        // inconsistent behavior

        policy.setName("domain1:policy.policy1");
        assertFalse(zmsImpl.isConsistentPolicyName("domain1", "policy2", policy));

        policy.setName("policy1");
        assertFalse(zmsImpl.isConsistentPolicyName("domain1", "policy2", policy));
    }

    @Test
    public void testGetDomainListNotNull() {
        Authority userAuthority = new com.yahoo.athenz.common.server.debug.DebugUserAuthority();
        String userId = "user1";
        Principal principal = SimplePrincipal.create("user", userId, userId + ":password", 0, userAuthority);
        assertNotNull(principal);
        ((SimplePrincipal) principal).setUnsignedCreds(userId);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        zmsImpl.getDomainList(rsrcCtx1, 100, null, null, 100, "account", 224, "roleMem1",
                "role1", null, null, null, null, null, null, null);
    }

    @Test
    public void testPutTenantResourceGroupRolesNull() {
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        TenantResourceGroupRoles tenantResource = new TenantResourceGroupRoles();
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        try{
            zmsImpl.putTenantResourceGroupRoles(rsrcCtx1, null, null, null, null, null, tenantResource);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }
    }

    @Test
    public void testDeleteTenantResourceGroupRolesNull() {
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        try{
            zmsImpl.deleteTenantResourceGroupRoles(rsrcCtx1, null, null, null, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }
    }

    @Test
    public void testGetResourceAccessListFailure() {
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        try{
            zmsImpl.getResourceAccessList(rsrcCtx1, "principal", "UPDATE");
            fail();
        } catch(Exception ex) {
            assertTrue(true);
        }
    }

    @Test
    public void testGetResourceAccessListNullPrincipal() {
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        try{
            zmsImpl.getResourceAccessList(rsrcCtx1, "", "UPDATE");
            fail();
        } catch(ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("principal is required for resource access list"));
        }

        try{
            zmsImpl.getResourceAccessList(rsrcCtx1, null, "UPDATE");
            fail();
        } catch(ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("principal is required for resource access list"));
        }
    }

    @Test
    public void testGetResourceAccessListAws() {

        final String domainName1 = "resource-aws1";
        final String domainName2 = "resource-aws2";
        final String domainName3 = "resource-aws3";
        final String domainName4 = "resource-aws4";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setAccount("aws-1234");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2,
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        TopLevelDomain dom3 = zmsTestInitializer.createTopLevelDomainObject(domainName3,
                "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom3);

        TopLevelDomain dom4 = zmsTestInitializer.createTopLevelDomainObject(domainName4,
                "Test Domain4", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom4);

        Group group31 = zmsTestInitializer.createGroupObject(domainName3, "group31", "user.john", "user.joe");
        zmsImpl.putGroup(ctx, domainName3, "group31", auditRef, false, null, group31);

        Group group32 = zmsTestInitializer.createGroupObject(domainName3, "group32", "user.john", "user.joe");
        zmsImpl.putGroup(ctx, domainName3, "group32", auditRef, false, null, group32);

        Group group33 = zmsTestInitializer.createGroupObject(domainName3, "group33", "user.jack", "user.joe");
        zmsImpl.putGroup(ctx, domainName3, "group33", auditRef, false, null, group33);

        // two roles in domain1 with aws access

        Role role1 = zmsTestInitializer.createRoleObject(domainName1, "aws-role1", null, "user.joe",
                ResourceUtils.groupResourceName(domainName3, "group31"));
        zmsImpl.putRole(ctx, domainName1, "aws-role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(domainName1, "aws-role2", null, "user.jane",
                ResourceUtils.groupResourceName(domainName3, "group32"));
        zmsImpl.putRole(ctx, domainName1, "aws-role2", auditRef, false, null, role2);

        // we have another role without any policy

        Role role3 = zmsTestInitializer.createRoleObject(domainName1, "aws-role3", null, "user.david", null);
        zmsImpl.putRole(ctx, domainName1, "aws-role3", auditRef, false, null, role3);

        // same roles in domain2 without aws access

        role1 = zmsTestInitializer.createRoleObject(domainName2, "aws-role1", null, "user.joe",
                ResourceUtils.groupResourceName(domainName3, "group31"));
        zmsImpl.putRole(ctx, domainName2, "aws-role1", auditRef, false, null, role1);

        role2 = zmsTestInitializer.createRoleObject(domainName2, "aws-role2", null, "user.jane",
                ResourceUtils.groupResourceName(domainName3, "group32"));
        zmsImpl.putRole(ctx, domainName2, "aws-role2", auditRef, false, null, role2);

        // similar roles in domain3 without any policies

        role1 = zmsTestInitializer.createRoleObject(domainName3, "aws-role1", null, "user.joe",
                ResourceUtils.groupResourceName(domainName3, "group33"));
        zmsImpl.putRole(ctx, domainName3, "aws-role1", auditRef, false, null, role1);

        role2 = zmsTestInitializer.createRoleObject(domainName3, "aws-role2", null, "user.jane",
                ResourceUtils.groupResourceName(domainName3, "group33"));
        zmsImpl.putRole(ctx, domainName3, "aws-role2", auditRef, false, null, role2);

        // create the policies with assume_aws_role action

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName1, "policy1", "aws-role1",
                "assume_aws_role", domainName1 + ":role1-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, "policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName1, "policy2", "aws-role2",
                "assume_aws_role", domainName1 + ":role2-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, "policy2", auditRef, false, null, policy2);

        // this should be excluded due to domain mismatch for aws check

        Policy policy3 = zmsTestInitializer.createPolicyObject(domainName1, "policy3", "aws-role2",
                "assume_aws_role", domainName4 + ":role3-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, "policy3", auditRef, false, null, policy3);

        // same policies in domain 2 without aws access

        policy1 = zmsTestInitializer.createPolicyObject(domainName2, "policy1", "aws-role1",
                "assume_aws_role", domainName2 + ":role1-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName2, "policy1", auditRef, false, null, policy1);

        policy2 = zmsTestInitializer.createPolicyObject(domainName2, "policy2", "aws-role2",
                "assume_aws_role", domainName2 + ":role2-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName2, "policy2", auditRef, false, null, policy2);

        // get the list of resources for user.david which should return empty list

        ResourceAccessList resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.david", "assume_aws_role");
        List<ResourceAccess> resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        assertTrue(resources.get(0).getAssertions().isEmpty());

        // get the list of resources for user.joe with assume_aws_role action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.joe", "assume_aws_role");
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        ResourceAccess rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.joe");
        assertEquals(rsrcAccess.getAssertions().size(), 2);
        Set<String> resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains("arn:aws:iam::aws-1234:role/role1-resource"));
        assertTrue(resourceCheck.contains("arn:aws:iam::aws-1234:role/role2-resource"));

        // get the list of resources for user.jane with assume_aws_role action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.jane", "assume_aws_role");
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.jane");
        assertEquals(rsrcAccess.getAssertions().size(), 1);
        assertEquals(rsrcAccess.getAssertions().get(0).getResource(), "arn:aws:iam::aws-1234:role/role2-resource");

        // get the list of resources for user.john with assume_aws_role action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.john", "assume_aws_role");
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.john");
        assertEquals(rsrcAccess.getAssertions().size(), 2);
        resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains("arn:aws:iam::aws-1234:role/role1-resource"));
        assertTrue(resourceCheck.contains("arn:aws:iam::aws-1234:role/role2-resource"));

        // get the list of resources for unknown user with assume_aws_role action

        try {
            zmsImpl.getResourceAccessList(ctx, "user.unknown", "assume_aws_role");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // get the list of resources for user.joe with unknown action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.joe", "unknown");
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.joe");
        assertTrue(rsrcAccess.getAssertions().isEmpty());

        // get the list of resources for user.joe with null action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.joe", null);
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.joe");
        assertEquals(rsrcAccess.getAssertions().size(), 5);
        resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains(domainName1 + ":role1-resource"));
        assertTrue(resourceCheck.contains(domainName1 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role1-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName4 + ":role3-resource"));

        // get the list of resources for user.jane with null action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.jane", null);
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.jane");
        assertEquals(rsrcAccess.getAssertions().size(), 3);
        resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains(domainName1 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName4 + ":role3-resource"));

        // get the list of resources for user.john with null action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.john", null);
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.john");
        assertEquals(rsrcAccess.getAssertions().size(), 5);
        resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains(domainName1 + ":role1-resource"));
        assertTrue(resourceCheck.contains(domainName1 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role1-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName4 + ":role3-resource"));

        // get the list of resources for unknown user with null action

        try {
            zmsImpl.getResourceAccessList(ctx, "user.unknown", null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName2, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName3, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName4, auditRef, null);
    }

    @Test
    public void testGetResourceAccessListGcp() {

        final String domainName1 = "resource-gcp1";
        final String domainName2 = "resource-gcp2";
        final String domainName3 = "resource-gcp3";
        final String domainName4 = "resource-gcp4";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setGcpProject("gcp-1234");
        dom1.setGcpProjectNumber("1234");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2,
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        TopLevelDomain dom3 = zmsTestInitializer.createTopLevelDomainObject(domainName3,
                "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom3);

        TopLevelDomain dom4 = zmsTestInitializer.createTopLevelDomainObject(domainName4,
                "Test Domain4", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom4);

        Group group31 = zmsTestInitializer.createGroupObject(domainName3, "group31", "user.john", "user.joe");
        zmsImpl.putGroup(ctx, domainName3, "group31", auditRef, false, null, group31);

        Group group32 = zmsTestInitializer.createGroupObject(domainName3, "group32", "user.john", "user.joe");
        zmsImpl.putGroup(ctx, domainName3, "group32", auditRef, false, null, group32);

        Group group33 = zmsTestInitializer.createGroupObject(domainName3, "group33", "user.jack", "user.joe");
        zmsImpl.putGroup(ctx, domainName3, "group33", auditRef, false, null, group33);

        // two roles in domain1 with gcp access

        Role role1 = zmsTestInitializer.createRoleObject(domainName1, "gcp-role1", null, "user.joe",
                ResourceUtils.groupResourceName(domainName3, "group31"));
        zmsImpl.putRole(ctx, domainName1, "gcp-role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(domainName1, "gcp-role2", null, "user.jane",
                ResourceUtils.groupResourceName(domainName3, "group32"));
        zmsImpl.putRole(ctx, domainName1, "gcp-role2", auditRef, false, null, role2);

        Role role3 = zmsTestInitializer.createRoleObject(domainName1, "gcp-role3", null, "user.joe", null);
        zmsImpl.putRole(ctx, domainName1, "gcp-role3", auditRef, false, null, role3);

        // we have another role without any policy

        Role role4 = zmsTestInitializer.createRoleObject(domainName1, "gcp-role4", null, "user.david", null);
        zmsImpl.putRole(ctx, domainName1, "gcp-role4", auditRef, false, null, role4);

        // same roles in domain2 without gcp access

        role1 = zmsTestInitializer.createRoleObject(domainName2, "gcp-role1", null, "user.joe",
                ResourceUtils.groupResourceName(domainName3, "group31"));
        zmsImpl.putRole(ctx, domainName2, "gcp-role1", auditRef, false, null, role1);

        role2 = zmsTestInitializer.createRoleObject(domainName2, "gcp-role2", null, "user.jane",
                ResourceUtils.groupResourceName(domainName3, "group32"));
        zmsImpl.putRole(ctx, domainName2, "gcp-role2", auditRef, false, null, role2);

        // similar roles in domain3 without any policies

        role1 = zmsTestInitializer.createRoleObject(domainName3, "gcp-role1", null, "user.joe",
                ResourceUtils.groupResourceName(domainName3, "group33"));
        zmsImpl.putRole(ctx, domainName3, "gcp-role1", auditRef, false, null, role1);

        role2 = zmsTestInitializer.createRoleObject(domainName3, "gcp-role2", null, "user.jane",
                ResourceUtils.groupResourceName(domainName3, "group33"));
        zmsImpl.putRole(ctx, domainName3, "gcp-role2", auditRef, false, null, role2);

        // create the policies with assume_gcp_role action

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName1, "policy1", "gcp-role1",
                "assume_gcp_role", domainName1 + ":roles/role1-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, "policy1", auditRef, false, null, policy1);

        Policy policy2 = zmsTestInitializer.createPolicyObject(domainName1, "policy2", "gcp-role2",
                "assume_gcp_role", domainName1 + ":role2-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, "policy2", auditRef, false, null, policy2);

        Policy policy3 = zmsTestInitializer.createPolicyObject(domainName1, "policy3", "gcp-role3",
                "assume_gcp_role", domainName1 + ":groups/group1-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, "policy3", auditRef, false, null, policy3);

        Policy policy4 = zmsTestInitializer.createPolicyObject(domainName1, "policy4", "gcp-role3",
                "assume_gcp_service", domainName1 + ":services/service1-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, "policy4", auditRef, false, null, policy4);

        // this should be excluded due to domain mismatch for gcp check

        Policy policy5 = zmsTestInitializer.createPolicyObject(domainName1, "policy5", "gcp-role2",
                "assume_gcp_role", domainName4 + ":role3-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName1, "policy5", auditRef, false, null, policy5);

        // same policies in domain 2 without gcp access

        policy1 = zmsTestInitializer.createPolicyObject(domainName2, "policy1", "gcp-role1",
                "assume_gcp_role", domainName2 + ":role1-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName2, "policy1", auditRef, false, null, policy1);

        policy2 = zmsTestInitializer.createPolicyObject(domainName2, "policy2", "gcp-role2",
                "assume_gcp_role", domainName2 + ":role2-resource", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName2, "policy2", auditRef, false, null, policy2);

        // get the list of resources for user.david which should return empty list

        ResourceAccessList resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.david", "assume_gcp_role");
        List<ResourceAccess> resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        assertTrue(resources.get(0).getAssertions().isEmpty());

        // get the list of resources for user.joe with assume_gcp_role action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.joe", "assume_gcp_role");
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        ResourceAccess rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.joe");
        assertEquals(rsrcAccess.getAssertions().size(), 3);
        Set<String> resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains("projects/gcp-1234/roles/role1-resource"));
        assertTrue(resourceCheck.contains("projects/gcp-1234/roles/role2-resource"));
        assertTrue(resourceCheck.contains("projects/gcp-1234/groups/group1-resource"));

        // get the list of resources for user.joe with assume_gcp_service action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.joe", "assume_gcp_service");
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.joe");
        assertEquals(rsrcAccess.getAssertions().size(), 1);
        assertEquals(rsrcAccess.getAssertions().get(0).getResource(), "projects/gcp-1234/services/service1-resource");

        // get the list of resources for user.jane with assume_gcp_role action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.jane", "assume_gcp_role");
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.jane");
        assertEquals(rsrcAccess.getAssertions().size(), 1);
        assertEquals(rsrcAccess.getAssertions().get(0).getResource(), "projects/gcp-1234/roles/role2-resource");

        // get the list of resources for user.john with assume_gcp_role action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.john", "assume_gcp_role");
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.john");
        assertEquals(rsrcAccess.getAssertions().size(), 2);
        resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains("projects/gcp-1234/roles/role1-resource"));
        assertTrue(resourceCheck.contains("projects/gcp-1234/roles/role2-resource"));

        // get the list of resources for unknown user with assume_gcp_role action

        try {
            zmsImpl.getResourceAccessList(ctx, "user.unknown", "assume_gcp_role");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // get the list of resources for user.joe with unknown action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.joe", "unknown");
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.joe");
        assertTrue(rsrcAccess.getAssertions().isEmpty());

        // get the list of resources for user.joe with null action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.joe", null);
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.joe");
        assertEquals(rsrcAccess.getAssertions().size(), 7);
        resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains(domainName1 + ":roles/role1-resource"));
        assertTrue(resourceCheck.contains(domainName1 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName1 + ":groups/group1-resource"));
        assertTrue(resourceCheck.contains(domainName1 + ":services/service1-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role1-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName4 + ":role3-resource"));

        // get the list of resources for user.jane with null action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.jane", null);
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.jane");
        assertEquals(rsrcAccess.getAssertions().size(), 3);
        resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains(domainName1 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName4 + ":role3-resource"));

        // get the list of resources for user.john with null action

        resourceAccessList = zmsImpl.getResourceAccessList(ctx, "user.john", null);
        assertNotNull(resourceAccessList);

        resources = resourceAccessList.getResources();
        assertEquals(resources.size(), 1);
        rsrcAccess = resources.get(0);
        assertEquals(rsrcAccess.getPrincipal(), "user.john");
        assertEquals(rsrcAccess.getAssertions().size(), 5);
        resourceCheck = new HashSet<>();
        for (Assertion assertion : rsrcAccess.getAssertions()) {
            resourceCheck.add(assertion.getResource());
        }
        assertTrue(resourceCheck.contains(domainName1 + ":roles/role1-resource"));
        assertTrue(resourceCheck.contains(domainName1 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role1-resource"));
        assertTrue(resourceCheck.contains(domainName2 + ":role2-resource"));
        assertTrue(resourceCheck.contains(domainName4 + ":role3-resource"));

        // get the list of resources for unknown user with null action

        try {
            zmsImpl.getResourceAccessList(ctx, "user.unknown", null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName2, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName3, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName4, auditRef, null);
    }

    @Test
    public void testDeleteProviderResourceGroupRolesNull() {
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=user1;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        try{
            zmsImpl.deleteProviderResourceGroupRoles(rsrcCtx1, null, null, null, null, null);
            fail();
        } catch(Exception ex) {
            assertTrue(true);
        }
    }

    @DataProvider(name = "roles")
    public static Object[][] getRoles() {
        final String memberName="member1";
        final String memberNameToSearch="notFound";
        final Timestamp expiredTimestamp = Timestamp.fromMillis(System.currentTimeMillis() - 10000);
        final Timestamp notExpiredTimestamp = Timestamp.fromMillis(System.currentTimeMillis() + 10000);

        return new Object[][] {
                //expired
                {memberName, memberName, expiredTimestamp, true, false},
                //not expired
                {memberName, memberName, notExpiredTimestamp, true, true},
                //not found
                {memberName, memberNameToSearch, notExpiredTimestamp, true, false},
                //set not filled which means no members are defined
                {memberName, memberName, notExpiredTimestamp, false, false},
                //null expiration
                {memberName, memberName, null, true, true},
        };
    }

    @Test(dataProvider = "roles")
    public void testIsMemberOfRole(final String memeberName, final String memberNameToSearch,
                                   Timestamp expiredTimestamp, boolean setRoleMembers, boolean isMember) {
        //Construct roleMembers
        List<RoleMember> roleMembers = new ArrayList<>();
        RoleMember roleMember = new RoleMember();
        roleMember.setMemberName(memeberName);
        roleMember.setExpiration(expiredTimestamp);
        roleMembers.add(roleMember);

        Role role = new Role();
        if (setRoleMembers) {
            role.setRoleMembers(roleMembers);
        }
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        boolean actual = zmsImpl.isMemberOfRole(role, memberNameToSearch);
        assertEquals(actual, isMember);
    }

    @Test
    public void testLogPrincipalEmpty() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        MockHttpServletRequest request = new MockHttpServletRequest();
        MockHttpServletResponse response = new MockHttpServletResponse();
        ResourceContext ctx = zmsImpl.newResourceContext(null, request, response, "apiName");
        zmsImpl.logPrincipal(ctx);
        assertTrue(request.getAttributes().isEmpty());
    }

    @Test
    public void testIsSysAdminUserInvalidDomain() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal = SimplePrincipal.create("sports", "nhl", "v=S1;d=sports;n=nhl;s=signature",
                0, principalAuthority);
        assertNotNull(principal);
        assertFalse(zmsImpl.isSysAdminUser(principal));
    }

    @Test
    public void testIsSysAdminUserValidDomain() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.contextWithMockPrincipal("postUserDomain");
        assertTrue(zmsImpl.isSysAdminUser(ctx.principal()));
    }

    @Test
    public void testGetUserList() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        ZMSTestUtils.cleanupNotAdminUsers(zmsImpl, zmsTestInitializer.getAdminUser(), ctx);

        String domainName = "listusers1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("listusersports",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        TopLevelDomain dom3 = zmsTestInitializer.createTopLevelDomainObject("listuserweather",
                "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom3);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "role1", null,
                "user.joe", "user.janie");
        zmsImpl.putRole(ctx, domainName, "role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(domainName, "role2", null,
                "user.joe", "listusersports.jane");
        zmsImpl.putRole(ctx, domainName, "role2", auditRef, false, null, role2);

        Role role3 = zmsTestInitializer.createRoleObject(domainName, "role3", null,
                "user.jack", "listuserweather.jane");
        zmsImpl.putRole(ctx, domainName, "role3", auditRef, false, null, role3);

        Role role4 = zmsTestInitializer.createRoleObject("listusersports", "role4", null,
                "user.ana", "user.janie");
        zmsImpl.putRole(ctx, "listusersports", "role4", auditRef, false, null, role4);

        UserList userList = zmsImpl.getUserList(ctx, null);
        List<String> users = userList.getNames();
        assertTrue(users.contains("user.testadminuser"));
        assertTrue(users.contains("user.janie"));
        assertTrue(users.contains("user.ana"));
        assertTrue(users.contains("user.jack"));
        assertTrue(users.contains("user.joe"));

        // retry the operation with the default user domain and
        // we should get the same results

        userList = zmsImpl.getUserList(ctx, "user");
        users = userList.getNames();
        assertTrue(users.contains("user.testadminuser"));
        assertTrue(users.contains("user.janie"));
        assertTrue(users.contains("user.ana"));
        assertTrue(users.contains("user.jack"));
        assertTrue(users.contains("user.joe"));

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "listusersports", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "listuserweather", auditRef, null);
    }

    @Test
    public void testGetUserListInvalidDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getUserList(ctx, "coretech");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
            assertTrue(ex.getMessage().contains("Unknown user domain"));
        }
    }

    @Test
    public void testGetUserListUserDomains() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Set<String> currentUserDomainSet = zmsImpl.addlUserCheckDomainSet;
        zmsImpl.addlUserCheckDomainSet = new HashSet<>();
        zmsImpl.addlUserCheckDomainSet.add("unix");
        zmsImpl.addlUserCheckDomainSet.add("grid");

        ZMSTestUtils.cleanupNotAdminUsers(zmsImpl, zmsTestInitializer.getAdminUser(), ctx);

        String domainName = "listusersdomians";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("unix",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        TopLevelDomain dom3 = zmsTestInitializer.createTopLevelDomainObject("grid",
                "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom3);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "role1", null,
                "user.joe", "unix.nobody");
        zmsImpl.putRole(ctx, domainName, "role1", auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(domainName, "role2", null,
                "user.joe", "grid.jane");
        zmsImpl.putRole(ctx, domainName, "role2", auditRef, false, null, role2);

        Role role3 = zmsTestInitializer.createRoleObject(domainName, "role3", null,
                "unix.root", "user.ana");
        zmsImpl.putRole(ctx, domainName, "role3", auditRef, false, null, role3);

        UserList userList = zmsImpl.getUserList(ctx, null);
        List<String> users = userList.getNames();
        assertTrue(users.contains("user.testadminuser"));
        assertTrue(users.contains("user.joe"));
        assertTrue(users.contains("user.ana"));

        userList = zmsImpl.getUserList(ctx, "unix");
        users = userList.getNames();
        assertTrue(users.contains("unix.nobody"));
        assertTrue(users.contains("unix.root"));

        userList = zmsImpl.getUserList(ctx, "grid");
        users = userList.getNames();
        assertTrue(users.contains("grid.jane"));

        try {
            zmsImpl.getUserList(ctx, "coretech");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
            assertTrue(ex.getMessage().contains("Unknown user domain"));
        }

        zmsImpl.addlUserCheckDomainSet = currentUserDomainSet;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "unix", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "grid", auditRef, null);
    }

    @Test
    public void testGetDomainRoleMembersInvalidDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getDomainRoleMembers(ctx, "invalid-domain");
            fail();
        } catch (ResourceException ex) {
            assertEquals(404, ex.getCode());
        }
    }

    @Test
    public void testPutQuota() {

        String domainName = "putquota";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Quota quota = new Quota().setName(domainName)
                .setAssertion(10).setEntity(11)
                .setPolicy(12).setPublicKey(13)
                .setRole(14).setRoleMember(15)
                .setService(16).setServiceHost(17)
                .setSubdomain(18).setGroupMember(19).setGroup(20);

        zmsImpl.putQuota(ctx, domainName, auditRef, quota);

        // now retrieve the quota using zms interface

        Quota quotaCheck = zmsImpl.getQuota(ctx, domainName);
        assertNotNull(quotaCheck);
        assertEquals(quotaCheck.getAssertion(), 10);
        assertEquals(quotaCheck.getRole(), 14);
        assertEquals(quotaCheck.getPolicy(), 12);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutQuotaMismatchName() {

        String domainName = "putquotamismatchname";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Quota quota = new Quota().setName("athenz")
                .setAssertion(10).setEntity(11)
                .setPolicy(12).setPublicKey(13)
                .setRole(14).setRoleMember(15)
                .setService(16).setServiceHost(17)
                .setSubdomain(18);

        try {
            zmsImpl.putQuota(ctx, domainName, auditRef, quota);
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteQuota() {

        String domainName = "deletequota";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Quota quota = new Quota().setName(domainName)
                .setAssertion(10).setEntity(11)
                .setPolicy(12).setPublicKey(13)
                .setRole(14).setRoleMember(15)
                .setService(16).setServiceHost(17)
                .setSubdomain(18).setGroupMember(19).setGroup(20);

        zmsImpl.putQuota(ctx, domainName, auditRef, quota);

        Quota quotaCheck = zmsImpl.getQuota(ctx, domainName);
        assertNotNull(quotaCheck);
        assertEquals(domainName, quotaCheck.getName());
        assertEquals(quotaCheck.getAssertion(), 10);
        assertEquals(quotaCheck.getRole(), 14);
        assertEquals(quotaCheck.getPolicy(), 12);

        // now delete the quota

        zmsImpl.deleteQuota(ctx, domainName, auditRef);

        // now we'll get the default quota

        quotaCheck = zmsImpl.getQuota(ctx, domainName);

        assertEquals("server-default", quotaCheck.getName());
        assertEquals(quotaCheck.getAssertion(), 100);
        assertEquals(quotaCheck.getRole(), 1000);
        assertEquals(quotaCheck.getPolicy(), 1000);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testUserHomeDomainResource() {
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        PrincipalAuthority principalAuthority = new com.yahoo.athenz.auth.impl.PrincipalAuthority();
        PrincipalAuthority testPrincipalAuthority = new com.yahoo.athenz.zms.TestUserPrincipalAuthority();

        // no changes expected

        zmsImpl.userDomain = "user";
        zmsImpl.userDomainPrefix = "user.";
        zmsImpl.homeDomain = "user";
        zmsImpl.homeDomainPrefix = "user.";
        zmsImpl.userAuthority = principalAuthority;
        assertEquals(zmsImpl.userHomeDomainResource("user.john-doe:domain"), "user.john-doe:domain");
        assertEquals(zmsImpl.userHomeDomainResource("user.john.smith:domain"), "user.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("testuser.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("product.john.smith:domain"), "product.john.smith:domain");

        // no changes expected

        zmsImpl.userDomain = "user";
        zmsImpl.userDomainPrefix = "user.";
        zmsImpl.homeDomain = "user";
        zmsImpl.homeDomainPrefix = "user.";
        zmsImpl.userAuthority = testPrincipalAuthority;
        assertEquals(zmsImpl.userHomeDomainResource("user.john-doe:domain"), "user.john-doe:domain");
        assertEquals(zmsImpl.userHomeDomainResource("user.john.smith:domain"), "user.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("testuser.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("product.john.smith:domain"), "product.john.smith:domain");

        // only domain name is changed - no username changes since user/home are same

        zmsImpl.userDomain = "testuser";
        zmsImpl.userDomainPrefix = "testuser.";
        zmsImpl.homeDomain = "testuser";
        zmsImpl.homeDomainPrefix = "testuser.";
        zmsImpl.userAuthority = principalAuthority;
        assertEquals(zmsImpl.userHomeDomainResource("user.john-doe:domain"), "testuser.john-doe:domain");
        assertEquals(zmsImpl.userHomeDomainResource("user.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("testuser.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("product.john.smith:domain"), "product.john.smith:domain");

        // only domain name is changed - no username changes since user/home are same

        zmsImpl.userDomain = "testuser";
        zmsImpl.userDomainPrefix = "testuser.";
        zmsImpl.homeDomain = "testuser";
        zmsImpl.homeDomainPrefix = "testuser.";
        zmsImpl.userAuthority = testPrincipalAuthority;
        assertEquals(zmsImpl.userHomeDomainResource("user.john-doe:domain"), "testuser.john-doe:domain");
        assertEquals(zmsImpl.userHomeDomainResource("user.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("testuser.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("product.john.smith:domain"), "product.john.smith:domain");

        // domain and username are changed since user/home namespaces are different
        // username impl in authority is default so we'll end up with same username

        zmsImpl.userDomain = "user";
        zmsImpl.userDomainPrefix = "user.";
        zmsImpl.homeDomain = "home";
        zmsImpl.homeDomainPrefix = "home.";
        zmsImpl.userAuthority = principalAuthority;
        assertEquals(zmsImpl.userHomeDomainResource("user.john-doe:domain"), "home.john-doe:domain");
        assertEquals(zmsImpl.userHomeDomainResource("user.john.smith:domain"), "home.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("testuser.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("product.john.smith:domain"), "product.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("user.john-doe"), "user.john-doe");

        // domain and username are changed since user/home namespaces are different
        // username impl in authority will replace .'s with -'s

        zmsImpl.userDomain = "user";
        zmsImpl.userDomainPrefix = "user.";
        zmsImpl.homeDomain = "home";
        zmsImpl.homeDomainPrefix = "home.";
        zmsImpl.userAuthority = testPrincipalAuthority;
        assertEquals(zmsImpl.userHomeDomainResource("user.john-doe:domain"), "home.john-doe:domain");
        assertEquals(zmsImpl.userHomeDomainResource("user.john.smith:domain"), "home.john-smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("testuser.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("product.john.smith:domain"), "product.john.smith:domain");

        // domain and username are changed since user/home namespaces are different
        // username impl in authority is default so we'll end up with same username

        zmsImpl.userDomain = "testuser";
        zmsImpl.userDomainPrefix = "testuser.";
        zmsImpl.homeDomain = "home";
        zmsImpl.homeDomainPrefix = "home.";
        zmsImpl.userAuthority = principalAuthority;
        assertEquals(zmsImpl.userHomeDomainResource("user.john-doe:domain"), "home.john-doe:domain");
        assertEquals(zmsImpl.userHomeDomainResource("user.john.smith:domain"), "home.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("testuser.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("product.john.smith:domain"), "product.john.smith:domain");

        // domain and username are changed since user/home namespaces are different
        // username impl in authority will replace .'s with -'s

        zmsImpl.userDomain = "testuser";
        zmsImpl.userDomainPrefix = "testuser.";
        zmsImpl.homeDomain = "home";
        zmsImpl.homeDomainPrefix = "home.";
        zmsImpl.userAuthority = testPrincipalAuthority;
        assertEquals(zmsImpl.userHomeDomainResource("user.john-doe:domain"), "home.john-doe:domain");
        assertEquals(zmsImpl.userHomeDomainResource("user.john.smith:domain"), "home.john-smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("testuser.john.smith:domain"), "testuser.john.smith:domain");
        assertEquals(zmsImpl.userHomeDomainResource("product.john.smith:domain"), "product.john.smith:domain");

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testNormalizedAdminUsers() {
        List<String> list = new ArrayList<>();
        list.add("user-alias.user1");
        list.add("user-alias.user1.svc");
        list.add("user.user2");
        list.add("user.user2.svc");

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.userDomain = "user";
        zmsImpl.userDomainPrefix = "user.";
        zmsImpl.userDomainAlias = null;
        zmsImpl.userDomainAliasPrefix = null;

        List<String> normList = zmsImpl.normalizedAdminUsers(list, null, "unit-test");
        assertEquals(normList.size(), 4);
        assertTrue(normList.contains("user-alias.user1"));
        assertTrue(normList.contains("user-alias.user1.svc"));
        assertTrue(normList.contains("user.user2"));
        assertTrue(normList.contains("user.user2.svc"));

        zmsImpl.userDomainAlias = "user-alias";
        zmsImpl.userDomainAliasPrefix = "user-alias.";

        normList = zmsImpl.normalizedAdminUsers(list, null, "unit-test");
        assertEquals(normList.size(), 4);
        assertTrue(normList.contains("user.user1"));
        assertTrue(normList.contains("user-alias.user1.svc"));
        assertTrue(normList.contains("user.user2"));
        assertTrue(normList.contains("user.user2.svc"));

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testNormalizeDomainAliasUser() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.userDomain = "user";
        zmsImpl.userDomainPrefix = "user.";
        zmsImpl.userDomainAlias = null;
        zmsImpl.userDomainAliasPrefix = null;

        assertNull(zmsImpl.normalizeDomainAliasUser(null));
        assertEquals(zmsImpl.normalizeDomainAliasUser("user-alias.user1"), "user-alias.user1");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user-alias.user1.svc"), "user-alias.user1.svc");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user2"), "user.user2");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user2.svc"), "user.user2.svc");

        zmsImpl.userDomainAlias = "user-alias";
        zmsImpl.userDomainAliasPrefix = "user-alias.";
        assertNull(zmsImpl.normalizeDomainAliasUser(null));
        assertEquals(zmsImpl.normalizeDomainAliasUser("user-alias.user1"), "user.user1");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user-alias.user1.svc"), "user-alias.user1.svc");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user2"), "user.user2");
        assertEquals(zmsImpl.normalizeDomainAliasUser("user.user2.svc"), "user.user2.svc");

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testValidateRequestSecureRequests() {
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.secureRequestsOnly = false;
        zmsImpl.statusPort = 0;

        HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
        when(request.isSecure()).thenReturn(true);

        // if secure requests is false, no check is done

        zmsImpl.validateRequest(request, "test");
        zmsImpl.validateRequest(request, "test", false);
        zmsImpl.validateRequest(request, "test", true);

        // should complete successfully since our request is true

        zmsImpl.secureRequestsOnly = true;
        zmsImpl.validateRequest(request, "test");
        zmsImpl.validateRequest(request, "test", false);
        zmsImpl.validateRequest(request, "test", true);

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testValidateRequestNonSecureRequests() {
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.secureRequestsOnly = true;
        zmsImpl.statusPort = 0;

        HttpServletRequest request = Mockito.mock(HttpServletRequest.class);

        // if request is not secure, should be rejected

        when(request.isSecure()).thenReturn(false);
        try {
            zmsImpl.validateRequest(request, "test");
            fail();
        } catch (ResourceException ignored) {
        }
        try {
            zmsImpl.validateRequest(request, "test", false);
            fail();
        } catch (ResourceException ignored) {
        }
        try {
            zmsImpl.validateRequest(request, "test", true);
            fail();
        } catch (ResourceException ignored) {
        }

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testValidateRequestStatusRequestPort() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.secureRequestsOnly = true;
        zmsImpl.statusPort = 8443;

        HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
        when(request.isSecure()).thenReturn(true);
        when(request.getLocalPort()).thenReturn(4443);

        // non-status requests are allowed on port 4443

        zmsImpl.validateRequest(request, "test");
        zmsImpl.validateRequest(request, "test", false);

        // status requests are not allowed on port 4443

        try {
            zmsImpl.validateRequest(request, "test", true);
            fail();
        } catch (ResourceException ignored) {
        }

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testValidateRequestRegularRequestPort() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.secureRequestsOnly = true;
        zmsImpl.statusPort = 8443;

        HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
        when(request.isSecure()).thenReturn(true);
        when(request.getLocalPort()).thenReturn(8443);

        // status requests are allowed on port 8443

        zmsImpl.validateRequest(request, "test", true);

        // non-status requests are not allowed on port 8443

        try {
            zmsImpl.validateRequest(request, "test");
            fail();
        } catch (ResourceException ignored) {
        }

        try {
            zmsImpl.validateRequest(request, "test", false);
            fail();
        } catch (ResourceException ignored) {
        }

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testGetStatus() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        zmsImpl.statusPort = 0;
        Status status = zmsImpl.getStatus(ctx);
        assertEquals(status.getCode(), ResourceException.OK);

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testGetStatusWithStatusFile() throws IOException {

        System.setProperty(ZMSConsts.ZMS_PROP_HEALTH_CHECK_PATH, "/tmp/zms-healthcheck");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        zmsImpl.statusPort = 0;

        // without the file we should get failure - make sure
        // to delete it just in case left over from previous run

        File healthCheckFile = new File("/tmp/zms-healthcheck");
        healthCheckFile.delete();

        try {
            zmsImpl.getStatus(ctx);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ResourceException.NOT_FOUND, ex.getCode());
        }

        // create the status file

        new FileOutputStream(healthCheckFile).close();
        Status status = zmsImpl.getStatus(ctx);
        assertEquals(ResourceException.OK, status.getCode());

        // delete the status file

        healthCheckFile.delete();
        try {
            zmsImpl.getStatus(ctx);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ResourceException.NOT_FOUND, ex.getCode());
        }

        System.clearProperty(ZMSConsts.ZMS_PROP_HEALTH_CHECK_PATH);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testGetStatusWithStatusChecker() {

        // if the MockStatusCheckerNoException is set
        // the MockStatusCheckerNoException determines the server is healthy

        System.setProperty(ZMSConsts.ZMS_PROP_STATUS_CHECKER_FACTORY_CLASS,
                MockStatusCheckerNoException.class.getName());
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        zmsImpl.statusPort = 0;

        Status status = zmsImpl.getStatus(ctx);
        assertEquals(ResourceException.OK, status.getCode());

        // if the MockStatusCheckerThrowException is set
        // the MockStatusCheckerThrowException determines that there is a problem with the server

        System.setProperty(ZMSConsts.ZMS_PROP_STATUS_CHECKER_FACTORY_CLASS,
                MockStatusCheckerThrowException.NoArguments.class.getName());
        zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.statusPort = 0;

        try {
            zmsImpl.getStatus(ctx);
            fail();
        } catch (ResourceException ex) {
            int code = com.yahoo.athenz.common.server.rest.ResourceException.INTERNAL_SERVER_ERROR;
            String msg = com.yahoo.athenz.common.server.rest.ResourceException.symbolForCode(ResourceException.INTERNAL_SERVER_ERROR);
            assertEquals(new ResourceError().code(code).message(msg).toString(), ex.getData().toString());
        }

        System.setProperty(ZMSConsts.ZMS_PROP_STATUS_CHECKER_FACTORY_CLASS,
                MockStatusCheckerThrowException.NotFound.class.getName());
        zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.statusPort = 0;

        try {
            zmsImpl.getStatus(ctx);
            fail();
        } catch (ResourceException ex) {
            int code = com.yahoo.athenz.common.server.rest.ResourceException.NOT_FOUND;
            String msg = com.yahoo.athenz.common.server.rest.ResourceException.symbolForCode(ResourceException.NOT_FOUND);
            assertEquals(new ResourceError().code(code).message(msg).toString(), ex.getData().toString());
        }

        System.setProperty(ZMSConsts.ZMS_PROP_STATUS_CHECKER_FACTORY_CLASS,
                MockStatusCheckerThrowException.InternalServerErrorWithMessage.class.getName());
        zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.statusPort = 0;

        try {
            zmsImpl.getStatus(ctx);
            fail();
        } catch (ResourceException ex) {
            int code = com.yahoo.athenz.common.server.rest.ResourceException.INTERNAL_SERVER_ERROR;
            String msg = "error message";
            assertEquals(new ResourceError().code(code).message(msg).toString(), ex.getData().toString());
        }

        System.setProperty(ZMSConsts.ZMS_PROP_STATUS_CHECKER_FACTORY_CLASS,
                MockStatusCheckerThrowException.CauseRuntimeException.class.getName());
        zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.statusPort = 0;

        try {
            zmsImpl.getStatus(ctx);
            fail();
        } catch (ResourceException ex) {
            int code = com.yahoo.athenz.common.server.rest.ResourceException.INTERNAL_SERVER_ERROR;
            String msg = "runtime exception";
            assertEquals(new ResourceError().code(code).message(msg).toString(), ex.getData().toString());
        }

        System.clearProperty(ZMSConsts.ZMS_PROP_STATUS_CHECKER_FACTORY_CLASS);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testValidateString() {
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.validateString(null, "CompoundName", "unit-test");
        zmsImpl.validateString("", "CompoundName", "unit-test");
        zmsImpl.validateString("124356789012", "CompoundName", "unit-test");
        zmsImpl.validateString("unit-test_test-101", "CompoundName", "unit-test");
        try {
            zmsImpl.validateString("unit test", "CompoundName", "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testgetModTimestampEmtpy() {
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        assertEquals(zmsImpl.getModTimestamp(null), 0);
        assertEquals(zmsImpl.getModTimestamp("\"\""), 0);
        assertEquals(zmsImpl.getModTimestamp(""), 0);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testValidCORSOrigin() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        // invalid origin values tests

        assertFalse(zmsImpl.isValidCORSOrigin(null));
        assertFalse(zmsImpl.isValidCORSOrigin(""));

        // origin white list not configured tests

        zmsImpl.corsOriginList = null;
        assertTrue(zmsImpl.isValidCORSOrigin("http://cors.origin1"));
        assertTrue(zmsImpl.isValidCORSOrigin("http://cors.origin2"));
        assertTrue(zmsImpl.isValidCORSOrigin("https://cors.origin2"));
        assertTrue(zmsImpl.isValidCORSOrigin("https://cors.origin2:4443"));

        assertFalse(zmsImpl.isValidCORSOrigin("https://cors.origin2:2000000"));
        assertFalse(zmsImpl.isValidCORSOrigin("https://cors.origin2:-2"));
        assertFalse(zmsImpl.isValidCORSOrigin("https://cors.origin2/"));
        assertFalse(zmsImpl.isValidCORSOrigin("https://cors.origin2/data"));
        assertFalse(zmsImpl.isValidCORSOrigin("https://cors.origin2:443?test=data"));
        assertFalse(zmsImpl.isValidCORSOrigin("file://cors.origin2"));
        assertFalse(zmsImpl.isValidCORSOrigin("https://cors origin2"));
        assertFalse(zmsImpl.isValidCORSOrigin("https://cors%20origin2"));

        zmsImpl.corsOriginList = new HashSet<>();
        assertTrue(zmsImpl.isValidCORSOrigin("http://cors.origin1"));
        assertTrue(zmsImpl.isValidCORSOrigin("https://cors.origin2"));
        assertFalse(zmsImpl.isValidCORSOrigin("file://cors.origin2"));

        // origin white list configured tests

        zmsImpl.corsOriginList.add("http://cors.origin1");
        assertTrue(zmsImpl.isValidCORSOrigin("http://cors.origin1"));
        assertFalse(zmsImpl.isValidCORSOrigin("http://cors.origin2"));

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testValidateServiceName() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        StringBuilder errorMessage = new StringBuilder(64);

        // reserved names
        assertFalse(zmsImpl.isValidServiceName("athenz", "com", errorMessage));
        assertEquals(errorMessage.toString(), "reserved service name");
        assertFalse(zmsImpl.isValidServiceName("athenz", "gov", errorMessage));
        assertFalse(zmsImpl.isValidServiceName("athenz", "info", errorMessage));
        assertFalse(zmsImpl.isValidServiceName("athenz", "org", errorMessage));

        assertTrue(zmsImpl.isValidServiceName("athenz", "svc", errorMessage));
        assertTrue(zmsImpl.isValidServiceName("athenz", "acom", errorMessage));
        assertTrue(zmsImpl.isValidServiceName("athenz", "coms", errorMessage));
        assertTrue(zmsImpl.isValidServiceName("athenz", "borg", errorMessage));

        // service names with 1 or 2 chars

        errorMessage.setLength(0);
        assertFalse(zmsImpl.isValidServiceName("athenz", "u", errorMessage));
        assertEquals(errorMessage.toString(), "service name length too short");

        assertFalse(zmsImpl.isValidServiceName("athenz", "k", errorMessage));
        assertFalse(zmsImpl.isValidServiceName("athenz", "r", errorMessage));

        assertFalse(zmsImpl.isValidServiceName("athenz", "us", errorMessage));
        assertFalse(zmsImpl.isValidServiceName("athenz", "uk", errorMessage));
        assertFalse(zmsImpl.isValidServiceName("athenz", "fr", errorMessage));

        // set the min length to 0 and verify all pass

        zmsImpl.serviceNameMinLength = 0;
        assertTrue(zmsImpl.isValidServiceName("athenz", "r", errorMessage));
        assertTrue(zmsImpl.isValidServiceName("athenz", "us", errorMessage));
        assertTrue(zmsImpl.isValidServiceName("athenz", "svc", errorMessage));

        // set map to null and verify all pass

        zmsImpl.reservedServiceNames = null;
        assertTrue(zmsImpl.isValidServiceName("athenz", "com", errorMessage));
        assertTrue(zmsImpl.isValidServiceName("athenz", "gov", errorMessage));

        // create new impl objects with new settings

        System.setProperty(ZMSConsts.ZMS_PROP_RESERVED_SERVICE_NAMES, "one,two");
        System.setProperty(ZMSConsts.ZMS_PROP_SERVICE_NAME_MIN_LENGTH, "0");
        ZMSImpl zmsImpl2 = zmsTestInitializer.zmsInit();

        assertTrue(zmsImpl2.isValidServiceName("athenz", "com", errorMessage));
        assertTrue(zmsImpl2.isValidServiceName("athenz", "gov", errorMessage));
        assertTrue(zmsImpl2.isValidServiceName("athenz", "info", errorMessage));

        assertFalse(zmsImpl2.isValidServiceName("athenz", "one", errorMessage));
        assertFalse(zmsImpl2.isValidServiceName("athenz", "two", errorMessage));

        assertTrue(zmsImpl2.isValidServiceName("athenz", "u", errorMessage));
        assertTrue(zmsImpl2.isValidServiceName("athenz", "k", errorMessage));
        assertTrue(zmsImpl2.isValidServiceName("athenz", "r", errorMessage));
        System.clearProperty(ZMSConsts.ZMS_PROP_RESERVED_SERVICE_NAMES);
        System.clearProperty(ZMSConsts.ZMS_PROP_SERVICE_NAME_MIN_LENGTH);

        // validate service names with underscores set to allow

        zmsImpl2.allowUnderscoreInServiceNames = new DynamicConfigBoolean(Boolean.TRUE);
        assertTrue(zmsImpl2.isValidServiceName("athenz", "service-name", errorMessage));
        assertTrue(zmsImpl2.isValidServiceName("athenz", "service_name", errorMessage));

        // while to allow option is enabled, let's create a service with underscore

        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain testDomain = zmsTestInitializer.createTopLevelDomainObject("athenz",
                "Athenz Domain", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, testDomain);

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName("athenz", "service_name"));
        zmsImpl2.putServiceIdentity(ctx, "athenz", "service_name", auditRef, false, null, service);

        // now let's disable the option. with the existing service, it should
        // be allowed but non-existent service name with be rejected

        zmsImpl2.allowUnderscoreInServiceNames = new DynamicConfigBoolean(Boolean.FALSE);
        assertTrue(zmsImpl2.isValidServiceName("athenz", "service-name", errorMessage));
        assertTrue(zmsImpl2.isValidServiceName("athenz", "service_name", errorMessage));
        errorMessage.setLength(0);
        assertFalse(zmsImpl2.isValidServiceName("athenz", "service_name2", errorMessage));
        assertEquals(errorMessage.toString(), "service name with underscore not allowed");

        // by default the feature flag is not enabled for the domain

        assertFalse(zmsImpl2.isDomainFeatureFlagEnabled("athenz", 1));
        assertFalse(zmsImpl2.isDomainFeatureFlagEnabled("athenz", 2));

        // enable the domain to have the underscore feature flag enabled
        // services should now be allowed

        DomainMeta meta = new DomainMeta().setFeatureFlags(1);
        zmsImpl2.putDomainSystemMeta(ctx, "athenz", "featureflags", auditRef, meta);

        assertTrue(zmsImpl2.isDomainFeatureFlagEnabled("athenz", 1));
        assertFalse(zmsImpl2.isDomainFeatureFlagEnabled("athenz", 2));

        assertTrue(zmsImpl2.isValidServiceName("athenz", "service-name", errorMessage));
        assertTrue(zmsImpl2.isValidServiceName("athenz", "service_name", errorMessage));
        assertTrue(zmsImpl2.isValidServiceName("athenz", "service_name2", errorMessage));
        assertTrue(zmsImpl2.isValidServiceName("athenz", "service_name3", errorMessage));

        zmsImpl2.deleteDomain(ctx, auditRef, "athenz", "unit-test");

        zmsImpl.objectStore.clearConnections();
        zmsImpl2.objectStore.clearConnections();
    }

    @Test
    public void testRetrieveSignedDomainMeta() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        Domain domainMeta = new Domain().setName("dom1").setYpmId(123).setModified(Timestamp.fromCurrentTime())
                .setAccount("1234").setAuditEnabled(true).setOrg("org").setAzureSubscription("4567")
                .setBusinessService("123:business service").setGcpProject("gcp").setGcpProjectNumber("1240")
                .setProductId("abcd-123");
        SignedDomain domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, null);
        assertNull(domain.getDomain().getAccount());
        assertNull(domain.getDomain().getYpmId());
        assertNull(domain.getDomain().getOrg());
        assertNull(domain.getDomain().getAuditEnabled());
        assertNull(domain.getDomain().getAzureSubscription());
        assertNull(domain.getDomain().getGcpProject());
        assertNull(domain.getDomain().getGcpProjectNumber());
        assertNull(domain.getDomain().getBusinessService());
        assertNull(domain.getDomain().getProductId());

        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "unknown");
        assertNull(domain.getDomain().getAccount());
        assertNull(domain.getDomain().getYpmId());
        assertNull(domain.getDomain().getOrg());
        assertNull(domain.getDomain().getAuditEnabled());
        assertNull(domain.getDomain().getAzureSubscription());
        assertNull(domain.getDomain().getGcpProject());
        assertNull(domain.getDomain().getGcpProjectNumber());
        assertNull(domain.getDomain().getBusinessService());
        assertNull(domain.getDomain().getProductId());

        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "account");
        assertEquals(domain.getDomain().getAccount(), "1234");
        assertNull(domain.getDomain().getYpmId());
        assertNull(domain.getDomain().getOrg());
        assertNull(domain.getDomain().getAuditEnabled());
        assertNull(domain.getDomain().getAzureSubscription());
        assertNull(domain.getDomain().getGcpProject());
        assertNull(domain.getDomain().getGcpProjectNumber());
        assertNull(domain.getDomain().getBusinessService());
        assertNull(domain.getDomain().getProductId());

        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "ypmid");
        assertNull(domain.getDomain().getAccount());
        assertEquals(domain.getDomain().getYpmId().intValue(), 123);
        assertNull(domain.getDomain().getOrg());
        assertNull(domain.getDomain().getAuditEnabled());
        assertNull(domain.getDomain().getAzureSubscription());
        assertNull(domain.getDomain().getGcpProject());
        assertNull(domain.getDomain().getGcpProjectNumber());
        assertNull(domain.getDomain().getBusinessService());
        assertNull(domain.getDomain().getProductId());

        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "azuresubscription");
        assertEquals(domain.getDomain().getAzureSubscription(), "4567");
        assertNull(domain.getDomain().getAccount());
        assertNull(domain.getDomain().getYpmId());
        assertNull(domain.getDomain().getOrg());
        assertNull(domain.getDomain().getAuditEnabled());
        assertNull(domain.getDomain().getGcpProject());
        assertNull(domain.getDomain().getGcpProjectNumber());
        assertNull(domain.getDomain().getBusinessService());
        assertNull(domain.getDomain().getProductId());

        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "gcpproject");
        assertEquals(domain.getDomain().getGcpProject(), "gcp");
        assertEquals(domain.getDomain().getGcpProjectNumber(), "1240");
        assertNull(domain.getDomain().getAccount());
        assertNull(domain.getDomain().getYpmId());
        assertNull(domain.getDomain().getOrg());
        assertNull(domain.getDomain().getAuditEnabled());
        assertNull(domain.getDomain().getAzureSubscription());
        assertNull(domain.getDomain().getBusinessService());
        assertNull(domain.getDomain().getProductId());

        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "businessservice");
        assertEquals(domain.getDomain().getBusinessService(), "123:business service");
        assertNull(domain.getDomain().getAccount());
        assertNull(domain.getDomain().getYpmId());
        assertNull(domain.getDomain().getOrg());
        assertNull(domain.getDomain().getAuditEnabled());
        assertNull(domain.getDomain().getAzureSubscription());
        assertNull(domain.getDomain().getGcpProject());
        assertNull(domain.getDomain().getGcpProjectNumber());
        assertNull(domain.getDomain().getProductId());

        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "productid");
        assertEquals(domain.getDomain().getProductId(), "abcd-123");
        assertNull(domain.getDomain().getAccount());
        assertNull(domain.getDomain().getYpmId());
        assertNull(domain.getDomain().getOrg());
        assertNull(domain.getDomain().getAuditEnabled());
        assertNull(domain.getDomain().getAzureSubscription());
        assertNull(domain.getDomain().getGcpProject());
        assertNull(domain.getDomain().getGcpProjectNumber());
        assertNull(domain.getDomain().getBusinessService());

        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "all");
        assertEquals(domain.getDomain().getAccount(), "1234");
        assertEquals(domain.getDomain().getAzureSubscription(), "4567");
        assertEquals(domain.getDomain().getGcpProject(), "gcp");
        assertEquals(domain.getDomain().getGcpProjectNumber(), "1240");
        assertEquals(domain.getDomain().getYpmId().intValue(), 123);
        assertEquals(domain.getDomain().getOrg(), "org");
        assertTrue(domain.getDomain().getAuditEnabled());
        assertEquals(domain.getDomain().getBusinessService(), "123:business service");
        assertEquals(domain.getDomain().getProductId(), "abcd-123");

        domainMeta.setAccount(null);
        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "account");
        assertNull(domain);

        domainMeta.setAzureSubscription(null);
        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "azuresubscription");
        assertNull(domain);

        domainMeta.setGcpProject(null);
        domainMeta.setGcpProjectNumber(null);
        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "gcpproject");
        assertNull(domain);

        domainMeta.setBusinessService(null);
        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "businessservice");
        assertNull(domain);

        domainMeta.setAccount("1234");
        domainMeta.setYpmId(null);
        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "ypmid");
        assertNull(domain);

        domainMeta.setProductId(null);
        domain = zmsImpl.retrieveSignedDomainMeta(domainMeta, "productid");
        assertNull(domain);

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testRetrieveSignedDomainDataNotFound() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        Domain dom = new Domain().setName("unknown").setModified(Timestamp.fromMillis(1234));
        SignedDomain domain = zmsImpl.retrieveSignedDomainData(dom, true, false);
        assertNull(domain);

        // now signed domains with unknown domain name

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal sysPrincipal = principalAuthority.authenticate("v=U1;d=sys;n=zts;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(sysPrincipal);

        Response response = zmsImpl.getSignedDomains(rsrcCtx, "unknown", null, null, Boolean.TRUE, false, null);
        SignedDomains sdoms = (SignedDomains) response.getEntity();

        assertNotNull(sdoms);
        List<SignedDomain> list = sdoms.getDomains();
        assertEquals(0, list.size());

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testGetSignedDomainsWithMetaAttrs() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // create multiple top level domains
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("SignedDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // set the meta attributes for domain

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain1", null, true, false, "12345", 0);
        zmsImpl.putDomainMeta(ctx, "signeddom1", auditRef, null, meta);
        meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain1", null, true, false, "12345", 987654103);
        zmsImpl.putDomainSystemMeta(ctx, "signeddom1", "account", auditRef, meta);
        zmsImpl.putDomainSystemMeta(ctx, "signeddom1", "productid", auditRef, meta);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("SignedDom2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain2", null, true, false, "12346", null);
        zmsImpl.putDomainMeta(ctx, "signeddom2", auditRef, null, meta);
        meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain2", null, true, false, "12346", null);
        zmsImpl.putDomainSystemMeta(ctx, "signeddom2", "account", auditRef, meta);

        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                "signeddom2", "domain", "productid");
        meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain2", null, true, false, "12346", null);
        zmsImpl.putDomainSystemMeta(ctx, "signeddom2", "productid", auditRef, meta);
        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");

        DomainList domList = zmsImpl.getDomainList(ctx, null, null, null, null,
                null, null, null, null, null, null, null, null, null, null, null);
        assertNotNull(domList);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey())), "0");

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal sysPrincipal = principalAuthority.authenticate("v=U1;d=sys;n=zts;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(sysPrincipal);

        // we're going to ask for entries with ypm id so we'll only
        // get one of the domains back - dom1 but not dom2

        Response response = zmsImpl.getSignedDomains(rsrcCtx, null, "true", "ypmid", Boolean.TRUE, false, null);
        SignedDomains sdoms = (SignedDomains) response.getEntity();
        assertNotNull(sdoms);
        List<SignedDomain> list = sdoms.getDomains();
        assertNotNull(list);

        boolean dom1Found = false;
        boolean dom2Found = false;
        for (SignedDomain sDomain : list) {
            DomainData domainData = sDomain.getDomain();
            switch (domainData.getName()) {
                case "signeddom1":
                    dom1Found = true;
                    break;
                case "signeddom2":
                    dom2Found = true;
                    break;
            }
        }
        assertTrue(dom1Found);
        assertFalse(dom2Found);

        // now asking for specific domains with ypm id
        // first signeddom1 with should return

        response = zmsImpl.getSignedDomains(rsrcCtx, "signeddom1", "true", "ypmid", Boolean.TRUE, false, null);
        sdoms = (SignedDomains) response.getEntity();

        assertNotNull(sdoms);
        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), 1);

        DomainData domainData = list.get(0).getDomain();
        assertEquals(domainData.getName(), "signeddom1");

        // then signeddom2 with should not return

        response = zmsImpl.getSignedDomains(rsrcCtx, "signeddom2", "true", "ypmid", Boolean.TRUE, false, null);
        sdoms = (SignedDomains) response.getEntity();

        assertNotNull(sdoms);
        list = sdoms.getDomains();
        assertNotNull(list);
        assertEquals(list.size(), 0);

        zmsImpl.deleteTopLevelDomain(ctx, "SignedDom1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "SignedDom2", auditRef, null);
    }

    @Test
    public void testGetSignedDomainsNotModified() throws InterruptedException {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("SignedDom1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // set the meta attributes for domain

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Tenant Domain1", null, true, false, "12345", 0);
        zmsImpl.putDomainMeta(ctx, "signeddom1", auditRef, null, meta);

        zmsImpl.privateKey = new ServerPrivateKey(Crypto.loadPrivateKey(
                Crypto.ybase64DecodeString(zmsTestInitializer.getPrivKey())), "0");

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal sysPrincipal = principalAuthority.authenticate("v=U1;d=sys;n=zts;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(sysPrincipal);

        Thread.sleep(1000);
        EntityTag eTag = new EntityTag(Timestamp.fromCurrentTime().toString());
        Response response = zmsImpl.getSignedDomains(rsrcCtx, "signeddom1", null, null, Boolean.TRUE, false, eTag.getValue());
        assertEquals(response.getStatus(), 304);

        zmsImpl.deleteTopLevelDomain(ctx, "SignedDom1", auditRef, null);
    }

    @Test
    public void testGetSignedDomainsException503() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        DBService dbService = Mockito.mock(DBService.class);
        when(dbService.getDomain("signeddom1", true)).thenThrow(new ResourceException(503));
        zmsImpl.dbService = dbService;

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal sysPrincipal = principalAuthority.authenticate("v=U1;d=sys;n=zts;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(sysPrincipal);

        try {
            zmsImpl.getSignedDomains(rsrcCtx, "signeddom1", null, null, Boolean.TRUE, false, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 503);
        }

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testGetSignedDomainsException404() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        DBService dbService = Mockito.mock(DBService.class);
        when(dbService.getDomain("signeddom1", true)).thenThrow(new ResourceException(404));
        zmsImpl.dbService = dbService;

        // now signed domains with unknown domain name

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal sysPrincipal = principalAuthority.authenticate("v=U1;d=sys;n=zts;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(sysPrincipal);

        Response response = zmsImpl.getSignedDomains(rsrcCtx, "signeddom1", null, null, Boolean.TRUE, false, null);
        SignedDomains sdoms = (SignedDomains) response.getEntity();

        assertNotNull(sdoms);
        List<SignedDomain> list = sdoms.getDomains();
        assertEquals(0, list.size());

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testReceiveSignedDomainDataDisabled() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // create multiple top level domains
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("SignedDom1Disabled",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // load the domain into cache and set the enabled to false

        zmsImpl.getAthenzDomain("signeddom1disabled", true);
        ObjectStoreConnection conn = zmsImpl.dbService.store.getConnection(true, false);
        zmsImpl.dbService.getAthenzDomainFromCache(conn, "signeddom1disabled").getDomain().setEnabled(false);

        // get the domain which would return from cache

        Domain dom = new Domain().setName("signeddom1disabled").setModified(Timestamp.fromMillis(0));
        SignedDomain signedDomain = zmsImpl.retrieveSignedDomainData(dom, false, false);
        assertFalse(signedDomain.getDomain().getEnabled());

        zmsImpl.deleteTopLevelDomain(ctx, "signeddom1disabled", auditRef, null);
    }

    @Test
    public void testReceiveSignedDomainDataAuditExpiryFields() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Authority savedAuthority = zmsImpl.userAuthority;
        final String domainName = "signed-dom-fields";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setAuditEnabled(true);
        dom1.setTokenExpiryMins(10);
        dom1.setRoleCertExpiryMins(20);
        dom1.setServiceCertExpiryMins(30);
        dom1.setDescription("test description");
        dom1.setCertDnsDomain("test dns domain");
        dom1.setOrg("org");
        dom1.setUserAuthorityFilter("OnShore-US");
        dom1.setMemberExpiryDays(40);
        dom1.setGroupExpiryDays(50);
        dom1.setServiceExpiryDays(60);
        dom1.setMemberPurgeExpiryDays(90);

        Authority authority = Mockito.mock(Authority.class);
        when(authority.getDateAttribute("user.testadminuser", "elevated-clearance")).thenReturn(new Date());
        when(authority.isAttributeSet("user.testadminuser", "OnShore-US")).thenReturn(true);
        Set<String> attrs = new HashSet<>();
        attrs.add("OnShore-US");
        attrs.add("elevated-clearance");
        when(authority.booleanAttributesSupported()).thenReturn(attrs);
        when(authority.dateAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;
        zmsImpl.dbService.zmsConfig.setUserAuthority(authority);

        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // get the domain which would return from cache

        Domain dom = new Domain().setName(domainName).setModified(Timestamp.fromMillis(0));
        SignedDomain signedDomain = zmsImpl.retrieveSignedDomainData(dom, false, false);
        assertTrue(signedDomain.getDomain().getAuditEnabled());
        assertEquals(Integer.valueOf(10), signedDomain.getDomain().getTokenExpiryMins());
        assertEquals(Integer.valueOf(20), signedDomain.getDomain().getRoleCertExpiryMins());
        assertEquals(Integer.valueOf(30), signedDomain.getDomain().getServiceCertExpiryMins());
        assertEquals("test description", signedDomain.getDomain().getDescription());
        assertEquals("test dns domain", signedDomain.getDomain().getCertDnsDomain());
        assertEquals("org", signedDomain.getDomain().getOrg());
        assertEquals("OnShore-US", signedDomain.getDomain().getUserAuthorityFilter());
        assertEquals(Integer.valueOf(40), signedDomain.getDomain().getMemberExpiryDays());
        assertEquals(Integer.valueOf(50), signedDomain.getDomain().getGroupExpiryDays());
        assertEquals(Integer.valueOf(60), signedDomain.getDomain().getServiceExpiryDays());
        assertEquals(Integer.valueOf(90), signedDomain.getDomain().getMemberPurgeExpiryDays());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.dbService.zmsConfig.setUserAuthority(savedAuthority);
    }

    @Test
    public void testValidateTenancyObject() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Tenancy tenant = new Tenancy().setDomain("athenz").setService("sports.provider");
        assertTrue(zmsImpl.validateTenancyObject(tenant, "athenz", "sports.provider"));
        assertFalse(zmsImpl.validateTenancyObject(tenant, "athens", "sports.provider"));
        assertFalse(zmsImpl.validateTenancyObject(tenant, "athenz", "sports.providers"));
    }

    @Test
    public void testPutTenantInvalidObject() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Tenancy tenant = new Tenancy().setDomain("sports").setService("athenz.provider");
        try {
            zmsImpl.putTenant(ctx, "athenz", "provider", "weather", auditRef, tenant);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }
    }

    @Test
    public void testPutTenantInvalidService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("providerdomain2",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Tenancy tenant = new Tenancy().setDomain("sports").setService("providerdomain2.service");
        try {
            zmsImpl.putTenant(ctx, "providerdomain2", "service", "sports", auditRef, tenant);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "providerdomain2", auditRef, null);
    }

    @Test
    public void testPutTenant() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("providerdomain",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain sportsDomain = zmsTestInitializer.createTopLevelDomainObject("sports",
                "Sports Domain", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, sportsDomain);

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName("providerdomain", "api"));
        zmsImpl.putServiceIdentity(ctx, "providerdomain", "api", auditRef, false, null, service);

        Tenancy tenant = new Tenancy().setDomain("sports").setService("providerdomain.api");
        zmsImpl.putTenant(ctx, "providerdomain", "api", "sports", auditRef, tenant);

        assertPutTenantTests(zmsImpl);

        // Verify domain dependency wasn't created as the provider isn't listed in the "sys.auth:role.service_providers role

        try {
            zmsImpl.getDependentDomainList(ctx, "providerdomain.api");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"providerdomain.api is not a registered service provider\"}");
        }

        zmsImpl.deleteTopLevelDomain(ctx, "providerdomain", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "sports", auditRef, null);
    }

    @Test
    public void testPutTenantDomainDependency() {
        ZMSImpl zms = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("providerdomain",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zms.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain sportsDomain = zmsTestInitializer.createTopLevelDomainObject("sports",
                "Sports Domain", "testOrg", zmsTestInitializer.getAdminUser());
        zms.postTopLevelDomain(ctx, auditRef, null, sportsDomain);

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName("providerdomain", "api"));
        zms.putServiceIdentity(ctx, "providerdomain", "api", auditRef, false, null, service);

        zmsTestInitializer.makeServiceProviders(zms, ctx, Collections.singletonList("providerdomain.api"),
                fetchDomainDependencyFrequency);

        // Switch to service provider context

        RsrcCtxWrapper serviceProviderCtx = zmsTestInitializer.contextWithMockPrincipal("putTenant",
                "providerdomain", "api");

        Tenancy tenant = new Tenancy().setDomain("sports").setService("providerdomain.api");
        zms.putTenant(serviceProviderCtx, "providerdomain", "api", "sports", auditRef, tenant);

        assertPutTenantTests(zms);

        // Verify domain dependency was created

        DomainList dependentDomainList = zms.getDependentDomainList(ctx, "providerdomain.api");
        assertEquals(dependentDomainList.getNames().size(), 1);
        assertEquals(dependentDomainList.getNames().get(0), "sports");

        // Delete tenant, verify domain dependency was removed

        zms.deleteTenant(serviceProviderCtx, "providerdomain", "api", "sports", auditRef);
        dependentDomainList = zms.getDependentDomainList(ctx, "providerdomain.api");
        assertEquals(dependentDomainList.getNames().size(), 0);

        zms.deleteRole(ctx, "sys.auth", "service_providers", auditRef, null);
        zms.deleteTopLevelDomain(ctx, "providerdomain", auditRef, null);
        zms.deleteTopLevelDomain(ctx, "sports", auditRef, null);
    }

    private void assertPutTenantTests(ZMSImpl zms) {
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        Role role = zms.getRole(ctx, "providerdomain", "api.tenant.sports.admin", false, false, false);
        assertNotNull(role);
        assertEquals(role.getTrust(), "sports");

        Policy policy = zms.getPolicy(ctx, "providerdomain", "api.tenant.sports.admin");
        assertNotNull(policy);
        assertEquals(policy.getAssertions().size(), 1);
        Assertion assertion = policy.getAssertions().get(0);
        assertEquals(assertion.getAction(), "*");
        assertEquals(assertion.getRole(), "providerdomain:role.api.tenant.sports.admin");
        assertEquals(assertion.getResource(), "providerdomain:service.api.tenant.sports.*");
    }

    @Test
    public void testDeleteTenant() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("providerdomaindelete",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain sportsDomain = zmsTestInitializer.createTopLevelDomainObject("sports",
                "sports domain", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, sportsDomain);

        ServiceIdentity service = new ServiceIdentity();
        service.setName(ResourceUtils.serviceResourceName("providerdomaindelete", "api"));
        zmsImpl.putServiceIdentity(ctx, "providerdomaindelete", "api", auditRef, false, null, service);

        Tenancy tenant = new Tenancy().setDomain("sports").setService("providerdomaindelete.api");
        zmsImpl.putTenant(ctx, "providerdomaindelete", "api", "sports", auditRef, tenant);

        Role role = zmsImpl.getRole(ctx, "providerdomaindelete", "api.tenant.sports.admin", false, false, false);
        assertNotNull(role);

        Policy policy = zmsImpl.getPolicy(ctx, "providerdomaindelete", "api.tenant.sports.admin");
        assertNotNull(policy);

        zmsImpl.deleteTenant(ctx, "providerdomaindelete", "api", "sports", auditRef);

        try {
            zmsImpl.getRole(ctx, "providerdomaindelete", "api.tenant.sports.admin", false, false, false);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        try {
            zmsImpl.getPolicy(ctx, "providerdomaindelete", "api.tenant.sports.admin");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "providerdomaindelete", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "sports", auditRef, null);
    }

    @Test
    public void testDeleteTenantInvalidService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("providerdomaindelete2",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        try {
            zmsImpl.deleteTenant(ctx, "providerdomaindelete2", "api", "sports", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "providerdomaindelete2", auditRef, null);
    }

    @Test
    public void testValidateTenantResourceGroupRolesObject() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        List<TenantRoleAction> list = new ArrayList<>();
        list.add(new TenantRoleAction().setRole("role").setAction("action"));

        TenantResourceGroupRoles roles = new TenantResourceGroupRoles()
                .setTenant("tenant").setDomain("domain").setResourceGroup("resourcegroup")
                .setService("service").setRoles(list);

        assertTrue(zmsImpl.validateTenantResourceGroupRolesObject(roles, "domain", "service",
                "tenant", "resourcegroup"));

        assertFalse(zmsImpl.validateTenantResourceGroupRolesObject(roles, "domain1", "service",
                "tenant", "resourcegroup"));
        assertFalse(zmsImpl.validateTenantResourceGroupRolesObject(roles, "domain", "service1",
                "tenant", "resourcegroup"));
        assertFalse(zmsImpl.validateTenantResourceGroupRolesObject(roles, "domain", "service",
                "tenant1", "resourcegroup"));
        assertFalse(zmsImpl.validateTenantResourceGroupRolesObject(roles, "domain", "service",
                "tenant", "resourcegroup1"));

        list.clear();
        assertFalse(zmsImpl.validateTenantResourceGroupRolesObject(roles, "domain", "service",
                "tenant", "resourcegroup"));

        roles.setRoles(null);
        assertFalse(zmsImpl.validateTenantResourceGroupRolesObject(roles, "domain", "service",
                "tenant", "resourcegroup"));
    }

    @Test
    public void testValidateProviderResourceGroupRolesObject() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        List<TenantRoleAction> list = new ArrayList<>();
        list.add(new TenantRoleAction().setRole("role").setAction("action"));

        ProviderResourceGroupRoles roles = new ProviderResourceGroupRoles()
                .setTenant("tenant").setDomain("domain").setResourceGroup("resourcegroup")
                .setService("service").setRoles(list);

        assertTrue(zmsImpl.validateProviderResourceGroupRolesObject(roles, "domain", "service",
                "tenant", "resourcegroup"));

        assertFalse(zmsImpl.validateProviderResourceGroupRolesObject(roles, "domain1", "service",
                "tenant", "resourcegroup"));
        assertFalse(zmsImpl.validateProviderResourceGroupRolesObject(roles, "domain", "service1",
                "tenant", "resourcegroup"));
        assertFalse(zmsImpl.validateProviderResourceGroupRolesObject(roles, "domain", "service",
                "tenant1", "resourcegroup"));
        assertFalse(zmsImpl.validateProviderResourceGroupRolesObject(roles, "domain", "service",
                "tenant", "resourcegroup1"));

        list.clear();
        assertFalse(zmsImpl.validateProviderResourceGroupRolesObject(roles, "domain", "service",
                "tenant", "resourcegroup"));

        roles.setRoles(null);
        assertFalse(zmsImpl.validateProviderResourceGroupRolesObject(roles, "domain", "service",
                "tenant", "resourcegroup"));
    }

    @Test
    public void testTenancyIdenticalProviderTenantDomains() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        List<TenantRoleAction> roleActions = new ArrayList<>();
        for (Struct.Field f : ZMSTestInitializer.TABLE_PROVIDER_ROLE_ACTIONS) {
            roleActions.add(new TenantRoleAction().setRole(f.name()).setAction(
                    (String) f.value()));
        }
        String tenantDomain = "identicaldomain";
        String providerDomain = "identicaldomain";
        String providerService  = "storage";
        String providerFullService = providerDomain + "." + providerService;
        String resourceGroup = "group1";

        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles()
                .setDomain(providerDomain)
                .setService(providerService)
                .setTenant(tenantDomain)
                .setRoles(roleActions).setResourceGroup(resourceGroup);

        try {
            zmsImpl.putTenantResourceGroupRoles(ctx, providerDomain, providerService,
                    tenantDomain, resourceGroup, auditRef, tenantRoles);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Provider and tenant domains cannot be the same"));
        }

        Tenancy tenant = new Tenancy().setDomain(tenantDomain).setService(providerFullService);
        try {
            zmsImpl.putTenant(ctx, providerDomain, providerService, tenantDomain,
                    auditRef, tenant);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Provider and tenant domains cannot be the same"));
        }

        tenant = zmsTestInitializer.createTenantObject(tenantDomain, providerFullService);
        try {
            zmsImpl.putTenancy(ctx, tenantDomain, providerFullService, auditRef, tenant);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Provider and tenant domains cannot be the same"));
        }

        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
                .setDomain(providerDomain).setService(providerService)
                .setTenant(tenantDomain).setRoles(roleActions)
                .setResourceGroup(resourceGroup);

        try {
            zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomain, providerDomain,
                    providerService, resourceGroup, auditRef, providerRoles);
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Provider and tenant domains cannot be the same"));
        }
    }

    @Test
    public void testGetAuthorityInvalid() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertNull(zmsImpl.getAuthority("invalid.class"));
    }

    @Test
    public void testLoadAuditRefValidator(){
        System.setProperty(ZMSConsts.ZMS_PROP_AUDIT_REF_VALIDATOR_FACTORY_CLASS, "com.yahoo.athenz.zms.audit.MockAuditReferenceValidatorFactoryImpl");
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        zmsImpl.loadAuditRefValidator();
        assertNotNull(zmsImpl.auditReferenceValidator);
        System.clearProperty(ZMSConsts.ZMS_PROP_AUDIT_REF_VALIDATOR_FACTORY_CLASS);
    }

    @Test
    public void testNullLoadAuditRefValidator(){
        System.setProperty(ZMSConsts.ZMS_PROP_AUDIT_REF_VALIDATOR_FACTORY_CLASS, "does.not.exist");
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        try {
            zmsImpl.loadAuditRefValidator();
        } catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Invalid audit reference factory class");
        }

        System.clearProperty(ZMSConsts.ZMS_PROP_AUDIT_REF_VALIDATOR_FACTORY_CLASS);
    }

    @Test
    public void testDefaultValuesOnCreation() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        assertEquals(zmsImpl.virtualDomainLimit, 5);
        assertNull(zmsImpl.userDomainAliasPrefix);
        assertEquals(zmsImpl.signedPolicyTimeout, 1000 * 604800);
    }

    @Test
    public void testConfigOverridesOnCreation() {

        TestAuditLogger alogger = new TestAuditLogger();

        System.setProperty(ZMSConsts.ZMS_PROP_USER_DOMAIN_ALIAS, "xyz");
        System.setProperty(ZMSConsts.ZMS_PROP_SIGNED_POLICY_TIMEOUT, "86400");
        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT, "10");
        System.setProperty(ZMSConsts.ZMS_PROP_CORS_ORIGIN_LIST, "a.com,b.com");

        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        assertEquals(zmsImpl.virtualDomainLimit, 10);
        assertEquals(zmsImpl.userDomainAliasPrefix, "xyz.");
        assertEquals(zmsImpl.signedPolicyTimeout, 1000 * 86400);

        assertTrue(zmsImpl.isValidCORSOrigin("a.com"));

        System.clearProperty(ZMSConsts.ZMS_PROP_USER_DOMAIN_ALIAS);
        System.clearProperty(ZMSConsts.ZMS_PROP_SIGNED_POLICY_TIMEOUT);
        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT);
        System.clearProperty(ZMSConsts.ZMS_PROP_CORS_ORIGIN_LIST);
    }

    @Test
    public void testPostSubDomainSkipSystemAttributes() {

        final String domainName = "subdomain-with-system-attrs";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1",
                "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        dom1.setAzureSubscription("azure");
        dom1.setAccount("aws");
        dom1.setGcpProject("gcp");
        dom1.setGcpProjectNumber("1250");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Domain dom1Res = zmsImpl.getDomain(ctx, domainName);
        assertEquals(dom1Res.getAccount(), "aws");
        assertEquals(dom1Res.getAzureSubscription(), "azure");
        assertEquals(dom1Res.getGcpProject(), "gcp");
        assertEquals(dom1Res.getGcpProjectNumber(), "1250");

        SubDomain dom2 = zmsTestInitializer.createSubDomainObject("sub", domainName, "Test Domain2",
                "testOrg", zmsTestInitializer.getAdminUser());
        dom2.setAzureSubscription("azure");
        dom2.setAccount("aws");
        dom2.setGcpProject("gcp");
        dom2.setGcpProjectNumber("1251");

        // system meta attributes are automatically skipped

        zmsImpl.postSubDomain(ctx, domainName, auditRef, null, dom2);
        Domain dom2Res = zmsImpl.getDomain(ctx, domainName + ".sub");
        assertNull(dom2Res.getAccount());
        assertNull(dom2Res.getAzureSubscription());
        assertNull(dom2Res.getGcpProject());
        assertNull(dom2Res.getGcpProjectNumber());

        zmsImpl.deleteSubDomain(ctx, domainName, "sub", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetPrincipalDomain() {
        Principal principal = SimplePrincipal.create("sports", "api",
                "creds", 0, new PrincipalAuthority());
        ResourceContext ctx = zmsTestInitializer.createResourceContext(principal);

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertEquals(zmsImpl.getPrincipalDomain(ctx), "sports");
    }

    @Test
    public void testGetPrincipalDomainNull() {

        ResourceContext ctx = zmsTestInitializer.createResourceContext(null);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertNull(zmsImpl.getPrincipalDomain(ctx));
    }

    private GroupSystemMeta createGroupSystemMetaObject(Boolean auditEnabled) {

        GroupSystemMeta meta = new GroupSystemMeta();

        if (auditEnabled != null) {
            meta.setAuditEnabled(auditEnabled);
        }
        return meta;
    }

    @Test
    public void testPutRoleSystemMeta() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("rolesystemmetadom1",
                "Role System Meta Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for Role System Meta test", "NewOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "rolesystemmetadom1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "rolesystemmetadom1", "auditenabled", auditRef, meta);

        Role role1 = zmsTestInitializer.createRoleObject("rolesystemmetadom1", "role1", null,
                "user.john", "user.jane");
        zmsImpl.putRole(ctx, "rolesystemmetadom1", "role1", auditRef, false, null, role1);

        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, "rolesystemmetadom1", "role1", "auditenabled", auditRef, rsm);

        Role resRole1 = zmsImpl.getRole(ctx, "rolesystemmetadom1", "role1", true, false, false);

        assertNotNull(resRole1);
        assertTrue(resRole1.getAuditEnabled());

        zmsImpl.deleteTopLevelDomain(ctx, "rolesystemmetadom1", auditRef, null);
    }

    @Test
    public void testPutRoleSystemMetaMissingAuditRef() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("rolesystemmetadom1",
                "Role System Meta Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for Role System Meta test", "NewOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "rolesystemmetadom1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "rolesystemmetadom1", "auditenabled", auditRef, meta);

        Role role1 = zmsTestInitializer.createRoleObject("rolesystemmetadom1", "role1", null,
                "user.john", "user.jane");
        zmsImpl.putRole(ctx, "rolesystemmetadom1", "role1", auditRef, false, null, role1);

        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);

        try {
            zmsImpl.putRoleSystemMeta(ctx, "rolesystemmetadom1", "role1", "auditenabled", null, rsm);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, "rolesystemmetadom1", auditRef, null);
        }
    }

    @Test
    public void testPutRoleSystemMetaThrowException() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        RoleSystemMeta rsm = new RoleSystemMeta();
        rsm.setAuditEnabled(false);

        try {
            zmsImpl.putRoleSystemMeta(ctx, "rolesystemmetadom1", "role1", "auditenabled", null, rsm);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(404, e.getCode());
        }
    }

    @Test
    public void testIsAllowedSystemMetaDelete(){

        TestAuditLogger alogger = new TestAuditLogger();
        System.setProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT, "true");
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        assertFalse(zmsImpl.isAllowedSystemMetaDelete(ctx.principal(), "mockdom1", "auditenabled", "role"));
        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                "mockdom1", "role", "auditenabled");
        assertTrue(zmsImpl.isAllowedSystemMetaDelete(ctx.principal(), "mockdom1", "auditenabled", "role"));
        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "role");

        System.clearProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT);
    }

    @Test
    public void testPutRoleMeta() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("rolemetadom1",
                "Role Meta Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("rolemetadom1", "role1", null,
                "user.john", "user.jane");
        zmsImpl.putRole(ctx, "rolemetadom1", "role1", auditRef, false, null, role1);

        RoleMeta rm = ZMSTestUtils.createRoleMetaObject(true);
        rm.setMemberExpiryDays(45);
        rm.setCertExpiryMins(55);
        rm.setServiceExpiryDays(45);
        rm.setGroupExpiryDays(50);
        rm.setTokenExpiryMins(65);
        rm.setMemberReviewDays(70);
        rm.setServiceReviewDays(80);
        rm.setGroupReviewDays(90);
        rm.setSignAlgorithm("ec");
        rm.setDescription("testroledescription");
        rm.setMaxMembers(25);
        rm.setSelfRenew(true);
        rm.setSelfRenewMins(99);
        zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm);

        Role resRole1 = zmsImpl.getRole(ctx, "rolemetadom1", "role1", true, false, false);

        assertNotNull(resRole1);
        assertTrue(resRole1.getSelfServe());
        assertEquals(resRole1.getMemberExpiryDays(), Integer.valueOf(45));
        assertEquals(resRole1.getCertExpiryMins(), Integer.valueOf(55));
        assertEquals(resRole1.getTokenExpiryMins(), Integer.valueOf(65));
        assertEquals(resRole1.getServiceExpiryDays(), Integer.valueOf(45));
        assertEquals(resRole1.getGroupExpiryDays(), Integer.valueOf(50));
        assertEquals(resRole1.getMemberReviewDays(), Integer.valueOf(70));
        assertEquals(resRole1.getServiceReviewDays(), Integer.valueOf(80));
        assertEquals(resRole1.getGroupReviewDays(), Integer.valueOf(90));
        assertEquals(resRole1.getDescription(), "testroledescription");
        assertEquals(resRole1.getSignAlgorithm(), "ec");
        assertTrue(resRole1.getSelfRenew());
        assertEquals(resRole1.getMaxMembers(), 25);
        assertEquals(resRole1.getSelfRenewMins(), 99);

        // if we pass a null for the expiry days (e.g. old client)
        // then we're not going to modify the value

        RoleMeta rm2 = ZMSTestUtils.createRoleMetaObject(false);
        zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm2);

        resRole1 = zmsImpl.getRole(ctx, "rolemetadom1", "role1", true, false, false);

        assertNotNull(resRole1);
        assertNull(resRole1.getSelfServe());
        assertEquals(resRole1.getMemberExpiryDays(), Integer.valueOf(45));
        assertEquals(resRole1.getServiceExpiryDays(), Integer.valueOf(45));
        assertEquals(resRole1.getGroupExpiryDays(), Integer.valueOf(50));
        assertEquals(resRole1.getCertExpiryMins(), Integer.valueOf(55));
        assertEquals(resRole1.getTokenExpiryMins(), Integer.valueOf(65));
        assertEquals(resRole1.getMemberReviewDays(), Integer.valueOf(70));
        assertEquals(resRole1.getServiceReviewDays(), Integer.valueOf(80));
        assertEquals(resRole1.getGroupReviewDays(), Integer.valueOf(90));
        assertTrue(resRole1.getSelfRenew());
        assertEquals(resRole1.getMaxMembers(), 25);
        assertEquals(resRole1.getSelfRenewMins(), 99);

        // now let's reset to 0

        RoleMeta rm3 = ZMSTestUtils.createRoleMetaObject(false);
        rm3.setMemberExpiryDays(0);
        rm3.setServiceExpiryDays(0);
        rm3.setGroupExpiryDays(0);
        rm3.setCertExpiryMins(0);
        rm3.setTokenExpiryMins(85);
        rm3.setMemberReviewDays(0);
        rm3.setServiceReviewDays(0);
        rm3.setGroupReviewDays(0);
        rm3.setSelfRenewMins(0);
        rm3.setSelfRenew(false);
        rm3.setMaxMembers(0);
        zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm3);

        resRole1 = zmsImpl.getRole(ctx, "rolemetadom1", "role1", true, false, false);

        assertNotNull(resRole1);
        assertNull(resRole1.getSelfServe());
        assertNull(resRole1.getMemberExpiryDays());
        assertNull(resRole1.getServiceExpiryDays());
        assertNull(resRole1.getGroupExpiryDays());
        assertNull(resRole1.getCertExpiryMins());
        assertEquals(resRole1.getTokenExpiryMins(), Integer.valueOf(85));
        assertNull(resRole1.getMemberReviewDays());
        assertNull(resRole1.getServiceReviewDays());
        assertNull(resRole1.getGroupReviewDays());
        assertNull(resRole1.getSelfRenew());
        assertNull(resRole1.getMaxMembers());
        assertNull(resRole1.getSelfRenewMins());

        // invalid negative values

        RoleMeta rm4 = ZMSTestUtils.createRoleMetaObject(false);
        rm4.setMemberExpiryDays(-10);
        try {
            zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm4);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        rm4.setMemberExpiryDays(10);
        rm4.setServiceExpiryDays(-10);
        try {
            zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm4);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        rm4.setMemberExpiryDays(10);
        rm4.setServiceExpiryDays(10);
        rm4.setGroupExpiryDays(-10);
        try {
            zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm4);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        rm4.setMemberExpiryDays(10);
        rm4.setServiceExpiryDays(10);
        rm4.setGroupExpiryDays(10);
        rm4.setCertExpiryMins(-10);
        try {
            zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm4);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        rm4.setMemberExpiryDays(10);
        rm4.setServiceExpiryDays(10);
        rm4.setCertExpiryMins(10);
        rm4.setTokenExpiryMins(-10);
        try {
            zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm4);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        rm4.setMemberExpiryDays(10);
        rm4.setServiceExpiryDays(10);
        rm4.setCertExpiryMins(10);
        rm4.setTokenExpiryMins(10);
        rm4.setMemberReviewDays(-10);
        try {
            zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm4);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        rm4.setMemberExpiryDays(10);
        rm4.setServiceExpiryDays(10);
        rm4.setCertExpiryMins(10);
        rm4.setTokenExpiryMins(10);
        rm4.setMemberReviewDays(10);
        rm4.setServiceReviewDays(-10);
        try {
            zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm4);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.deleteTopLevelDomain(ctx, "rolemetadom1", auditRef, null);
    }

    @Test
    public void testPutRoleMetaMissingAuditRef() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("rolemetadom1", "Role Meta Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for Role Meta test", "NewOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "rolemetadom1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "rolemetadom1", "auditenabled", auditRef, meta);

        Role role1 = zmsTestInitializer.createRoleObject("rolemetadom1", "role1", null,
                "user.john", "user.jane");
        zmsImpl.putRole(ctx, "rolemetadom1", "role1", auditRef, false, null, role1);

        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, "rolemetadom1", "role1", "auditenabled", auditRef, rsm);

        RoleMeta rm = ZMSTestUtils.createRoleMetaObject(true);
        try {
            zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", null, null, rm);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, "rolemetadom1", auditRef, null);
        }
    }

    @Test
    public void testPutRoleMetaThrowException() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        RoleMeta rm = new RoleMeta();
        rm.setSelfServe(false);

        try {
            zmsImpl.putRoleMeta(ctx, "rolemetadom1", "role1", auditRef, null, rm);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(404, e.getCode());
        }
    }

    @Test
    public void testPutRoleMetaGroupMemberWithAuthorityFilter() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-role-meta-group-authority";
        final String groupName = "group1";
        final String roleName = "role1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Role Meta Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Authority savedAuthority = zmsImpl.userAuthority;

        Authority authority = Mockito.mock(Authority.class);
        when(authority.getDateAttribute("user.john", "elevated-clearance")).thenReturn(new Date());
        when(authority.isAttributeSet("user.john", "OnShore-US")).thenReturn(true);
        when(authority.getDateAttribute("user.jane", "elevated-clearance")).thenReturn(new Date());
        when(authority.isAttributeSet("user.jane", "OnShore-US")).thenReturn(true);
        Set<String> attrs = new HashSet<>();
        attrs.add("OnShore-US");
        attrs.add("elevated-clearance");
        when(authority.booleanAttributesSupported()).thenReturn(attrs);
        when(authority.dateAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;
        zmsImpl.dbService.zmsConfig.setUserAuthority(authority);

        // let's add a role and set the user authority filter

        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john", "user.jane");
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        RoleMeta rm = new RoleMeta().setUserAuthorityFilter("OnShore-US");
        zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, rm);

        // now let's try to add a group which should be rejected since
        // the group does not have authority filter

        Membership mbr = zmsTestInitializer.generateMembership(roleName, ResourceUtils.groupResourceName(domainName, groupName));
        try {
            zmsImpl.putMembership(ctx, domainName, roleName,
                    ResourceUtils.groupResourceName(domainName, groupName), auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // now we're going to set the same filter on the group

        GroupMeta groupMeta = new GroupMeta().setUserAuthorityFilter("OnShore-US");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, groupMeta);

        // we should now be able to add the member successfully

        zmsImpl.putMembership(ctx, domainName, roleName,
                ResourceUtils.groupResourceName(domainName, groupName), auditRef, false, null, mbr);

        // now we're going to set the expiry attribute set on the role but
        // it should be rejected since group does not have that expiry

        rm = new RoleMeta().setUserAuthorityFilter("OnShore-US").setUserAuthorityExpiration("elevated-clearance");
        try {
            zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, rm);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
            assertTrue(ex.getMessage().contains(ResourceUtils.groupResourceName(domainName, groupName)));
        }

        // now let's set the expiry flag on the group

        groupMeta = new GroupMeta().setUserAuthorityFilter("OnShore-US").setUserAuthorityExpiration("elevated-clearance");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, groupMeta);

        // our put role meta should work now

        zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, rm);

        zmsImpl.dbService.zmsConfig.setUserAuthority(savedAuthority);
        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testIsAllowedPutMembershipAccess(){

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1",
                "Role Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("testdomain1", "testrole1", null,"user.user1", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole1", auditRef, false, null, role1);

        AthenzDomain domain = zmsImpl.getAthenzDomain("testdomain1", false);
        Role role = zmsImpl.getRoleFromDomain("testrole1", domain);

        assertTrue(zmsImpl.isAllowedPutMembershipAccess(zmsTestInitializer.getMockDomRestRsrcCtx().principal(), domain, role.getName()));

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=john";
        final Principal rsrcPrince = SimplePrincipal.create("user", "john", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);

        assertFalse(zmsImpl.isAllowedPutMembershipAccess(rsrcPrince, domain, role.getName()));// some random user does not have access

        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testIsAllowedPutRoleMetaAccess(){

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1",
                "Role Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("testdomain1", "testrole1", null,"user.user1", "user.john");
        zmsImpl.putRole(ctx, "testdomain1", "testrole1", auditRef, false, null, role1);

        AthenzDomain domain = zmsImpl.getAthenzDomain("testdomain1", false);
        Role role = zmsImpl.getRoleFromDomain("testrole1", domain);

        assertTrue(zmsImpl.isAllowedPutRoleMetaAccess(zmsTestInitializer.getMockDomRestRsrcCtx().principal(), domain, role.getName()));

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=john";
        final Principal rsrcPrince = SimplePrincipal.create("user", "john", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);

        assertFalse(zmsImpl.isAllowedPutRoleMetaAccess(rsrcPrince, domain, role.getName())); // some random user does not have access

        // create policy that allows the user something other than "update" or "update_meta" - will still be denied
        Policy policy = zmsTestInitializer.createPolicyObject(domain.getName(), "testupdatemta", "testrole1",
                "update_somethingelse", role.getName(), AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domain.getName(), "testupdatemta", auditRef, false, null, policy);
        domain = zmsImpl.getAthenzDomain("testdomain1", false);
        assertFalse(zmsImpl.isAllowedPutRoleMetaAccess(rsrcPrince, domain, role.getName()));

        // Finally create policy with "update_meta" which will allow access
        policy = zmsTestInitializer.createPolicyObject(domain.getName(), "testupdatemta", "testrole1",
                "update_meta", role.getName(), AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domain.getName(), "testupdatemta", auditRef, false, null, policy);
        domain = zmsImpl.getAthenzDomain("testdomain1", false);

        // Will now be allowed
        assertTrue(zmsImpl.isAllowedPutRoleMetaAccess(rsrcPrince, domain, role.getName()));

        // Same thing with "update" instead of "update_meta"
        policy = zmsTestInitializer.createPolicyObject(domain.getName(), "testupdatemta", "testrole1",
                "update", role.getName(), AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domain.getName(), "testupdatemta", auditRef, false, null, policy);
        domain = zmsImpl.getAthenzDomain("testdomain1", false);
        assertTrue(zmsImpl.isAllowedPutRoleMetaAccess(rsrcPrince, domain, role.getName()));

        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testIsAllowedPutMembership() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1","Role Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("testdomain1", "testrole1", null,"user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole1", auditRef, false, null, role1);

        AthenzDomain domain = zmsImpl.getAthenzDomain("testdomain1", false);
        Role role = zmsImpl.getRoleFromDomain("testrole1", domain);

        RoleMember roleMember = new RoleMember().setMemberName("user.user1");

        assertTrue(zmsImpl.isAllowedPutMembership(zmsTestInitializer.getMockDomRestRsrcCtx().principal(), domain, role, roleMember));//admin allowed
        assertTrue(roleMember.getApproved());

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=bob";
        final Principal rsrcPrince = SimplePrincipal.create("user", "bob", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);

        roleMember = new RoleMember().setMemberName("user.bob");
        assertFalse(zmsImpl.isAllowedPutMembership(rsrcPrince, domain, role, roleMember));//bob trying to add himself

        // without self-serve bob is not allowed to add dave
        roleMember = new RoleMember().setMemberName("user.dave");
        assertFalse(zmsImpl.isAllowedPutMembership(rsrcPrince, domain, role, roleMember));//bob trying to add dave

        Role selfserverole = zmsTestInitializer.createRoleObject("testdomain1", "testrole2", null,"user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole2", auditRef, false, null, selfserverole);

        RoleMeta rm = ZMSTestUtils.createRoleMetaObject(true);
        zmsImpl.putRoleMeta(ctx, "testdomain1", "testrole2",  auditRef, null, rm);

        domain = zmsImpl.getAthenzDomain("testdomain1", false);
        role = zmsImpl.getRoleFromDomain("testrole2", domain);

        roleMember = new RoleMember().setMemberName("user.bob");
        assertTrue(zmsImpl.isAllowedPutMembership(rsrcPrince, domain, role, roleMember));//bob trying to add himself
        assertFalse(roleMember.getApproved());

        // with self-serve bob is now allowed to add dave
        roleMember.setMemberName("user.dave");
        assertTrue(zmsImpl.isAllowedPutMembership(rsrcPrince, domain, role, roleMember));//bob trying to add dave
        assertFalse(roleMember.getApproved());

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for Role Meta test", "testOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "testdomain1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "testdomain1", "auditenabled", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject("testdomain1", "testrole3", null,"user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole3", auditRef, false, null, auditedRole);

        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, "testdomain1", "testrole3", "auditenabled", auditRef, rsm);

        domain = zmsImpl.getAthenzDomain("testdomain1", false);
        role = zmsImpl.getRoleFromDomain("testrole3", domain);

        roleMember = new RoleMember().setMemberName("user.user1");
        assertTrue(zmsImpl.isAllowedPutMembership(zmsTestInitializer.getMockDomRestRsrcCtx().principal(), domain, role, roleMember));//admin allowed
        assertFalse(roleMember.getApproved());

        roleMember = new RoleMember().setMemberName("user.bob");
        assertFalse(zmsImpl.isAllowedPutMembership(rsrcPrince, domain, role, roleMember));//bob trying to add himself not allowed

        roleMember = new RoleMember().setMemberName("user.dave");
        assertFalse(zmsImpl.isAllowedPutMembership(rsrcPrince, domain, role, roleMember));//bob trying to add dave not allowed

        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testPutMembershipSelfserveRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        addMemberToSelfServeRoleWithUserIdentity();

        Role resrole = zmsImpl.getRole(ctx, "testdomain1", "testrole1", false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 3);
        for (RoleMember rmem : resrole.getRoleMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertFalse(rmem.getApproved());
            }
        }
        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    private void addMemberToSelfServeRoleWithUserIdentity() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1", "Approval test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject("testdomain1", "testrole1", null, "user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole1", auditRef, false, null, role1);

        RoleMeta rm = ZMSTestUtils.createRoleMetaObject(true);
        zmsImpl.putRoleMeta(ctx, "testdomain1", "testrole1", auditRef, null, rm);

        //switch to user.bob principal to test selfserve role membership
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=bob";
        final Principal rsrcPrince = SimplePrincipal.create("user", "bob", unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcPrince);
        when(ctx.principal()).thenReturn(rsrcPrince);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);

        zmsImpl.putMembership(ctx, "testdomain1", "testrole1", "user.bob", auditRef, false, null, mbr);

        //revert back to admin principal
        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1", adminUnsignedCreds + ";s=signature",
                0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);
    }

    private void addMemberToSelfServeGroupWithUserIdentity(final String domainName, final String groupName) {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMeta rm = new GroupMeta().setSelfServe(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, rm);

        //switch to user.bob principal to test selfserve role membership
        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=bob";
        final Principal rsrcPrince = SimplePrincipal.create("user", "bob", unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcPrince);
        when(ctx.principal()).thenReturn(rsrcPrince);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);

        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        //revert back to admin principal
        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1", adminUnsignedCreds + ";s=signature",
                0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);
    }

    @Test
    public void testPutMembershipDecisionSelfserveRoleApprove() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        addMemberToSelfServeRoleWithUserIdentity();

        Role resrole = zmsImpl.getRole(ctx, "testdomain1", "testrole1", false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 3);
        for (RoleMember rmem : resrole.getRoleMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertFalse(rmem.getApproved());
            }
        }
        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);
        zmsImpl.putMembershipDecision(ctx, "testdomain1", "testrole1", "user.bob", auditRef, mbr);

        resrole = zmsImpl.getRole(ctx, "testdomain1", "testrole1", false, false, false);
        assertEquals(resrole.getRoleMembers().size(), 3);
        for (RoleMember rmem : resrole.getRoleMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertTrue(rmem.getApproved());
            }
        }
        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testPutMembershipDecisionSelfserveRoleReject() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        addMemberToSelfServeRoleWithUserIdentity();

        Role resrole = zmsImpl.getRole(ctx, "testdomain1", "testrole1", false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 3);
        for (RoleMember rmem : resrole.getRoleMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertFalse(rmem.getApproved());
            }
        }
        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembershipDecision(ctx, "testdomain1", "testrole1", "user.bob", auditRef, mbr);

        resrole = zmsImpl.getRole(ctx, "testdomain1", "testrole1", false, false, false);
        assertEquals(resrole.getRoleMembers().size(), 2);

        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    private void setupPrincipalAuditedRoleApprovalByOrg(ZMSImpl zmsImpl, final String principal, final String org) {

        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Role role = zmsTestInitializer.createRoleObject("sys.auth.audit.org", org, null, principal, null);
        zmsImpl.putRole(ctx, "sys.auth.audit.org", org, auditRef, false, null, role);

        Policy policy = new Policy();
        policy.setName(org);

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("sys.auth.audit.org:audit." + org);
        assertion.setRole("sys.auth.audit.org:role." + org);

        List<Assertion> assertList = new ArrayList<>();
        assertList.add(assertion);
        policy.setAssertions(assertList);

        zmsImpl.putPolicy(ctx, "sys.auth.audit.org", org, auditRef, false, null, policy);
    }

    private void setupPrincipalAuditedRoleApprovalByDomain(ZMSImpl zmsImpl, final String principal, final String domainName) {

        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Role role = zmsTestInitializer.createRoleObject("sys.auth.audit.domain", domainName, null, principal, null);
        zmsImpl.putRole(ctx, "sys.auth.audit.domain", domainName, auditRef, false, null, role);

        Policy policy = new Policy();
        policy.setName(domainName);

        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource("sys.auth.audit.domain:audit." + domainName);
        assertion.setRole("sys.auth.audit.domain:role." + domainName);

        List<Assertion> assertList = new ArrayList<>();
        assertList.add(assertion);
        policy.setAssertions(assertList);

        zmsImpl.putPolicy(ctx, "sys.auth.audit.domain", domainName, auditRef, false, null, policy);
    }

    @Test
    public void testPutMembershipDecisionReviewEnabledRoleApproveAddState() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "review-enabled-domain";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval test Domain1",
                "testOrg", "user.user1");
        dom1.getAdminUsers().add("user.user2");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        final String roleName = "review-role";
        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, null, null);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        RoleMeta rm = new RoleMeta().setReviewEnabled(true);
        zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, rm);

        // switch to user.user2 principal to add a member to a role

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=user2";
        final Principal rsrcPrince = SimplePrincipal.create("user", "user2",
                unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcPrince);
        when(ctx.principal()).thenReturn(rsrcPrince);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);

        zmsImpl.putMembership(ctx, domainName, roleName, "user.bob", auditRef, false, null, mbr);

        // verify the user is added with pending state

        Role resrole = zmsImpl.getRole(ctx, domainName, roleName, false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 1);
        assertEquals(resrole.getRoleMembers().get(0).getMemberName(), "user.bob");
        assertEquals(resrole.getRoleMembers().get(0).getPendingState(), PENDING_REQUEST_ADD_STATE);
        assertFalse(resrole.getRoleMembers().get(0).getApproved());

        // now try as the admin himself to approve this user and it must
        // be rejected since it has to be done by some other admin

        mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("cannot approve his/her own request"));
        }

        // revert back to admin principal

        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        // approve the message which should be successful

        zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);

        // verify the user is now active

        resrole = zmsImpl.getRole(ctx, domainName, roleName, false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 1);
        assertEquals(resrole.getRoleMembers().get(0).getMemberName(), "user.bob");
        assertTrue(resrole.getRoleMembers().get(0).getApproved());

        // trying to approve the same user should return 404

        try {
            zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        // now try to approve another use which should also return 404

        mbr.setMemberName("user.joe");
        try {
            zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.joe", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutMembershipDecisionReviewEnabledRoleApproveDeleteState() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "review-enabled-domain";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval test Domain1",
                "testOrg", "user.user1");
        dom1.getAdminUsers().add("user.user2");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        final String roleName = "review-role";
        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.bob", null);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        RoleMeta rm = new RoleMeta().setReviewEnabled(true).setDeleteProtection(true);
        zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, rm);

        // switch to user.user2 principal to add a member to a role

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=user2";
        final Principal rsrcPrince = SimplePrincipal.create("user", "user2",
                unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        when(ctx.principal()).thenReturn(rsrcPrince);
        when(ctx.principal()).thenReturn(rsrcPrince);

        zmsImpl.deleteMembership(ctx, domainName, roleName, "user.bob", auditRef, null);

        // verify the user is not been deleted and also verify the user is added as a pending member

        Role resrole = zmsImpl.getRole(ctx, domainName, roleName, false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 2);
        assertEquals(resrole.getRoleMembers().get(0).getMemberName(), "user.bob");
        assertTrue(resrole.getRoleMembers().get(0).getApproved());
        assertEquals(resrole.getRoleMembers().get(1).getMemberName(), "user.bob");
        assertFalse(resrole.getRoleMembers().get(1).getApproved());
        assertEquals(resrole.getRoleMembers().get(1).getPendingState(), PENDING_REQUEST_DELETE_STATE);

        // now try as the admin himself to approve this user and it must
        // be rejected since it has to be done by some other admin
        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setApproved(true);
        try {
            zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("cannot approve his/her own request"));
        }

        // revert back to admin principal

        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(ctx.principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        // approve the message which should be successful

        zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);

        // verify the user is now been deleted from both tables (standard and pending)

        resrole = zmsImpl.getRole(ctx, domainName, roleName, false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 0);

        // trying to approve the same user should return 404

        try {
            zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        // now try to approve another use which should also return 404

        mbr.setMemberName("user.joe");
        try {
            zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.joe", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPendingMembershipConflictRequests() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "review-enabled-domain";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval test Domain1",
                "testOrg", "user.user1");
        dom1.getAdminUsers().add("user.user2");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        final String roleName = "review-role";
        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.bob", null);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        RoleMeta rm = new RoleMeta().setReviewEnabled(true).setDeleteProtection(true);
        zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, rm);

        zmsImpl.deleteMembership(ctx, domainName, roleName, "user.bob", auditRef, null);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        try {
            zmsImpl.putMembership(ctx, domainName, roleName, "user.bob", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
            assertTrue(ex.getMessage().contains("already has a pending request in a different state"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    private void cleanupPrincipalAuditedRoleApprovalByOrg(ZMSImpl zmsImpl, final String org) {
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        zmsImpl.deletePolicy(ctx, "sys.auth.audit.org", org, auditRef, null);
        zmsImpl.deleteRole(ctx, "sys.auth.audit.org", org, auditRef, null);
    }

    private void cleanupPrincipalAuditedRoleApprovalByDomain(ZMSImpl zmsImpl, final String domainName) {
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        zmsImpl.deletePolicy(ctx, "sys.auth.audit.domain", domainName, auditRef, null);
        zmsImpl.deleteRole(ctx, "sys.auth.audit.domain", domainName, auditRef, null);
    }

    @Test
    public void testPutMembershipDecisionAuditEnabledRoleByOrg() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "testdomain1";
        final String roleName = "testrole1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john", "user.jane");
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, auditedRole);
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, domainName, roleName, "auditenabled", auditRef, rsm);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctx, domainName, roleName, "user.bob", auditRef, false, null, mbr);

        Role resrole = zmsImpl.getRole(ctx, domainName, roleName, false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 3);
        for (RoleMember rmem : resrole.getRoleMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertFalse(rmem.getApproved());
            }
        }

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testOrg");

        mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.FORBIDDEN);
        }

        Authority auditAdminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String auditAdminUnsignedCreds = "v=U1;d=user;n=fury";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAuditAdminPrince = SimplePrincipal.create("user", "fury",
                auditAdminUnsignedCreds + ";s=signature", 0, auditAdminPrincipalAuthority);
        assertNotNull(rsrcAuditAdminPrince);
        ((SimplePrincipal) rsrcAuditAdminPrince).setUnsignedCreds(auditAdminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAuditAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAuditAdminPrince);

        zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);

        //revert back to admin principal
        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        resrole = zmsImpl.getRole(ctx, domainName, roleName, false, false, false);
        assertEquals(resrole.getRoleMembers().size(), 3);
        for (RoleMember rmem : resrole.getRoleMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertTrue(rmem.getApproved());
            }
        }

        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutMembershipDecisionAuditEnabledRoleByDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "testdomain1";
        final String roleName = "testrole1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john", "user.jane");
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, auditedRole);
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, domainName, roleName, "auditenabled", auditRef, rsm);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctx, domainName, roleName, "user.bob", auditRef, false, null, mbr);

        Role resrole = zmsImpl.getRole(ctx, domainName, roleName, false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 3);
        for (RoleMember rmem : resrole.getRoleMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertFalse(rmem.getApproved());
            }
        }

        setupPrincipalAuditedRoleApprovalByDomain(zmsImpl, "user.fury", domainName);

        mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.FORBIDDEN);
        }

        Authority auditAdminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String auditAdminUnsignedCreds = "v=U1;d=user;n=fury";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAuditAdminPrince = SimplePrincipal.create("user", "fury",
                auditAdminUnsignedCreds + ";s=signature", 0, auditAdminPrincipalAuthority);
        assertNotNull(rsrcAuditAdminPrince);
        ((SimplePrincipal) rsrcAuditAdminPrince).setUnsignedCreds(auditAdminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAuditAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAuditAdminPrince);

        zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);

        //revert back to admin principal
        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        resrole = zmsImpl.getRole(ctx, domainName, roleName, false, false, false);
        assertEquals(resrole.getRoleMembers().size(), 3);
        for (RoleMember rmem : resrole.getRoleMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertTrue(rmem.getApproved());
            }
        }

        cleanupPrincipalAuditedRoleApprovalByDomain(zmsImpl, domainName);
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutMembershipDecisionAuditEnabledRoleInvalidUser() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1", "Approval Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "testdomain1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "testdomain1", "auditenabled", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject("testdomain1", "testrole1", null, "user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole1", auditRef, false, null, auditedRole);
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, "testdomain1", "testrole1", "auditenabled", auditRef, rsm);

        Membership mbr = new Membership();
        mbr.setMemberName("user.joe");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctx, "testdomain1", "testrole1", "user.joe", auditRef, false, null, mbr);

        mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctx, "testdomain1", "testrole1", "user.bob", auditRef, false, null, mbr);

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testOrg");

        Authority auditAdminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String auditAdminUnsignedCreds = "v=U1;d=user;n=fury";

        final Principal rsrcAuditAdminPrince = SimplePrincipal.create("user", "fury",
                auditAdminUnsignedCreds + ";s=signature", 0, auditAdminPrincipalAuthority);
        assertNotNull(rsrcAuditAdminPrince);
        ((SimplePrincipal) rsrcAuditAdminPrince).setUnsignedCreds(auditAdminUnsignedCreds);

        when(ctx.principal()).thenReturn(rsrcAuditAdminPrince);

        // enable user authority check - joe and jane are the only
        // valid users in the system

        zmsImpl.userAuthority = new TestUserPrincipalAuthority();

        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true);
        zmsImpl.validateUserRoleMembers = dynamicConfigBoolean;

        // first let's approve user.joe which should be ok since user joe
        // is a valid user based on our test authority

        mbr = new Membership();
        mbr.setMemberName("user.joe");
        mbr.setActive(true);
        mbr.setApproved(true);
        zmsImpl.putMembershipDecision(ctx, "testdomain1", "testrole1", "user.joe", auditRef, mbr);

        // now let's approve our bob user which is going to be rejected
        // since bob is not a valid user based on our test authority

        mbr.setMemberName("user.bob");

        try {
            zmsImpl.putMembershipDecision(ctx, "testdomain1", "testrole1", "user.bob", auditRef, mbr);
            fail();
        }catch (ResourceException ex) {
            assertEquals(ex.code, 400);
        }

        // now let's just reject user bob which should work
        // ok because we no longer validate users when we
        // are rejecting thus deleting role members

        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembershipDecision(ctx, "testdomain1", "testrole1", "user.bob", auditRef, mbr);

        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");
        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testPutMembershipDecisionReviewEnabledUnauthorized() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "review-enabled-domain-forbidden";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        final String roleName = "review-role";
        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, null, null);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        RoleMeta rm = new RoleMeta().setReviewEnabled(true);
        zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, rm);

        // add a user to the role

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);

        zmsImpl.putMembership(ctx, domainName, roleName, "user.bob", auditRef, false, null, mbr);

        // verify the user is added with pending state

        Role resrole = zmsImpl.getRole(ctx, domainName, roleName, false, false, true);
        assertEquals(resrole.getRoleMembers().size(), 1);
        assertEquals(resrole.getRoleMembers().get(0).getMemberName(), "user.bob");
        assertFalse(resrole.getRoleMembers().get(0).getApproved());

        // now try as the second admin himself to approve this user and it must
        // be rejected since second admin is not authorized

        mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        // switch to user.user2 principal to add a member to a role

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=user2";
        final Principal rsrcPrince = SimplePrincipal.create("user", "user2",
                unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcPrince);
        when(ctx.principal()).thenReturn(rsrcPrince);

        try {
            zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("not authorized to approve / reject members"));
        }

        // revert back to admin principal

        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutMembershipDecisionErrors() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1","Approval Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testOrg",true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "testdomain1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "testdomain1", "auditenabled", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject("testdomain1", "testrole1", null,"user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole1", auditRef, false, null, auditedRole);
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, "testdomain1", "testrole1", "auditenabled", auditRef, rsm);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctx, "testdomain1", "testrole1", "user.bob", auditRef, false, null, mbr);

        mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putMembershipDecision(ctx, "testdomain1", "testrole1", "user.chris", auditRef, mbr);//invalid member
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 400);
            assertTrue(r.getMessage().contains("putMembershipDecision: Member name in URI and Membership object do not match"));
        }

        mbr.setRoleName("invalidrole");
        try {
            zmsImpl.putMembershipDecision(ctx, "testdomain1", "testrole1", "user.bob", auditRef, mbr);//invalid role
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 400);
            assertTrue(r.getMessage().contains("putMembershipDecision: Role name in URI and Membership object do not match"));
        }

        mbr.setRoleName(null);
        try {
            zmsImpl.putMembershipDecision(ctx, "testdomain2", "testrole1", "user.bob", auditRef, mbr);//invalid domain name
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 400);
            assertTrue(r.getMessage().contains("Invalid rolename"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testGetPendingDomainRoleMembersListByPrincipal() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1", "Approval Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testorg");

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testorg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "testdomain1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "testdomain1", "auditenabled", auditRef, meta);
        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                "testdomain1", "domain", "org");
        zmsImpl.putDomainSystemMeta(ctx, "testdomain1", "org", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject("testdomain1", "testrole1", null, "user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole1", auditRef, false, null, auditedRole);
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, "testdomain1", "testrole1", "auditenabled", auditRef, rsm);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctx, "testdomain1", "testrole1", "user.bob", auditRef, false, null, mbr);

        mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putMembershipDecision(ctx, "testdomain1", "testrole1", "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 403);
        }

        // first request using specific principal

        DomainRoleMembership domainRoleMembership = zmsImpl.getPendingDomainRoleMembersList(ctx, "user.fury", null);

        assertNotNull(domainRoleMembership);
        assertNotNull(domainRoleMembership.getDomainRoleMembersList());
        assertEquals(domainRoleMembership.getDomainRoleMembersList().size(), 1);
        for (DomainRoleMembers drm : domainRoleMembership.getDomainRoleMembersList()) {
            assertEquals(drm.getDomainName(), "testdomain1");
            assertNotNull(drm.getMembers());
            for (DomainRoleMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (MemberRole mr : mem.getMemberRoles()) {
                    assertNotNull(mr);
                    assertEquals(mr.getRoleName(), "testrole1");
                }
            }
        }

        // repeat the request using context principal

        Principal mockPrincipal = Mockito.mock(Principal.class);
        when(ctx.principal()).thenReturn(mockPrincipal);
        when(mockPrincipal.getDomain()).thenReturn("user");
        when(mockPrincipal.getFullName()).thenReturn("user.fury");
        domainRoleMembership = zmsImpl.getPendingDomainRoleMembersList(ctx, null, null);

        assertNotNull(domainRoleMembership);
        assertNotNull(domainRoleMembership.getDomainRoleMembersList());
        assertEquals(domainRoleMembership.getDomainRoleMembersList().size(), 1);
        for (DomainRoleMembers drm : domainRoleMembership.getDomainRoleMembersList()) {
            assertEquals(drm.getDomainName(), "testdomain1");
            assertNotNull(drm.getMembers());
            for (DomainRoleMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (MemberRole mr : mem.getMemberRoles()) {
                    assertNotNull(mr);
                    assertEquals(mr.getRoleName(), "testrole1");
                }
            }
        }

        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");
        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");

        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testGetPendingDomainRoleMembersListByDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1", "Approval Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testorg");

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testorg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "testdomain1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "testdomain1", "auditenabled", auditRef, meta);
        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                "testdomain1", "domain", "org");
        zmsImpl.putDomainSystemMeta(ctx, "testdomain1", "org", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject("testdomain1", "testrole1", null, "user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole1", auditRef, false, null, auditedRole);
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, "testdomain1", "testrole1", "auditenabled", auditRef, rsm);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctx, "testdomain1", "testrole1", "user.bob", auditRef, false, null, mbr);

        mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putMembershipDecision(ctx, "testdomain1", "testrole1", "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 403);
        }

        // first request using specific principal

        DomainRoleMembership domainRoleMembership = zmsImpl.getPendingDomainRoleMembersList(ctx, null, "testdomain1");

        assertNotNull(domainRoleMembership);
        assertNotNull(domainRoleMembership.getDomainRoleMembersList());
        assertEquals(domainRoleMembership.getDomainRoleMembersList().size(), 1);
        for (DomainRoleMembers drm : domainRoleMembership.getDomainRoleMembersList()) {
            assertEquals(drm.getDomainName(), "testdomain1");
            assertNotNull(drm.getMembers());
            for (DomainRoleMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (MemberRole mr : mem.getMemberRoles()) {
                    assertNotNull(mr);
                    assertEquals(mr.getRoleName(), "testrole1");
                    assertEquals(mr.getPendingState(), PENDING_REQUEST_ADD_STATE);
                }
            }
        }

        // repeat using all domains
        domainRoleMembership = zmsImpl.getPendingDomainRoleMembersList(ctx, null, "*");

        assertNotNull(domainRoleMembership);
        assertNotNull(domainRoleMembership.getDomainRoleMembersList());
        assertEquals(domainRoleMembership.getDomainRoleMembersList().size(), 1);
        for (DomainRoleMembers drm : domainRoleMembership.getDomainRoleMembersList()) {
            assertEquals(drm.getDomainName(), "testdomain1");
            assertNotNull(drm.getMembers());
            for (DomainRoleMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (MemberRole mr : mem.getMemberRoles()) {
                    assertNotNull(mr);
                    assertEquals(mr.getRoleName(), "testrole1");
                    assertEquals(mr.getPendingState(), PENDING_REQUEST_ADD_STATE);
                }
            }
        }

        // repeat the request using context principal

        Principal mockPrincipal = Mockito.mock(Principal.class);
        when(ctx.principal()).thenReturn(mockPrincipal);
        when(mockPrincipal.getDomain()).thenReturn("user");
        when(mockPrincipal.getFullName()).thenReturn("user.fury");
        domainRoleMembership = zmsImpl.getPendingDomainRoleMembersList(ctx, null, null);

        assertNotNull(domainRoleMembership);
        assertNotNull(domainRoleMembership.getDomainRoleMembersList());
        assertEquals(domainRoleMembership.getDomainRoleMembersList().size(), 1);
        for (DomainRoleMembers drm : domainRoleMembership.getDomainRoleMembersList()) {
            assertEquals(drm.getDomainName(), "testdomain1");
            assertNotNull(drm.getMembers());
            for (DomainRoleMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (MemberRole mr : mem.getMemberRoles()) {
                    assertNotNull(mr);
                    assertEquals(mr.getRoleName(), "testrole1");
                    assertEquals(mr.getPendingState(), PENDING_REQUEST_ADD_STATE);
                }
            }
        }

        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");
        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");

        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testGetRoleWithPendingMembers() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1","Pending Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, "testdomain1", auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, "testdomain1", "auditenabled", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject("testdomain1", "testrole1", null,"user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole1", auditRef, false, null, auditedRole);
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, "testdomain1", "testrole1", "auditenabled", auditRef, rsm);
        RoleMeta rMeta = new RoleMeta().setDeleteProtection(true);
        zmsImpl.putRoleMeta(ctx, "testdomain1", "testrole1", auditRef, null, rMeta);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctx, "testdomain1", "testrole1", "user.bob", auditRef, false, null, mbr);

        // try deleting user.john from review-enabled role, the user should not been deleted and also should add as a pending member
        zmsImpl.deleteMembership(ctx, "testdomain1", "testrole1", "user.john", auditRef, null);

        Role resRole = zmsImpl.getRole(ctx, "testdomain1", "testrole1", false, false, true);

        assertNotNull(resRole);
        assertEquals(resRole.getRoleMembers().size(), 4);

        int johnCount = 0;
        for ( RoleMember rm : resRole.getRoleMembers()) {
            if ("user.bob".equals(rm.getMemberName())) {
                assertFalse(rm.getApproved());
                assertEquals(rm.getPendingState(), PENDING_REQUEST_ADD_STATE);
            } else if ("user.john".equals(rm.getMemberName())) {
                ++johnCount;
                if (!rm.getApproved()) {
                    assertEquals(rm.getPendingState(), PENDING_REQUEST_DELETE_STATE);
                }
            }
        }
        assertEquals(johnCount, 2);

        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testValidateRoleMemberPrincipals() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        DynamicConfigBoolean validateUserRoleMembersBool = Mockito.mock(DynamicConfigBoolean.class);
        when(validateUserRoleMembersBool.get()).thenReturn(false);
        zmsImpl.validateUserRoleMembers = validateUserRoleMembersBool;
        DynamicConfigBoolean validateServiceRoleMembersBool = Mockito.mock(DynamicConfigBoolean.class);
        when(validateServiceRoleMembersBool.get()).thenReturn(false);
        zmsImpl.validateServiceRoleMembers = validateServiceRoleMembersBool;

        // if both are false then any invalid users are ok

        List<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user").setPrincipalType(Principal.Type.SERVICE.getValue()));
        roleMembers.add(new RoleMember().setMemberName("user.john").setPrincipalType(Principal.Type.USER.getValue()));
        roleMembers.add(new RoleMember().setMemberName("user.jane").setPrincipalType(Principal.Type.USER.getValue()));
        roleMembers.add(new RoleMember().setMemberName("coretech.api").setPrincipalType(Principal.Type.SERVICE.getValue()));
        roleMembers.add(new RoleMember().setMemberName("coretech.backend").setPrincipalType(Principal.Type.SERVICE.getValue()));

        Role role = new Role().setRoleMembers(roleMembers);
        zmsImpl.validateRoleMemberPrincipals(role, null, false, "unittest");

        // enable user authority check

        zmsImpl.userAuthority = new TestUserPrincipalAuthority();
        DynamicConfigBoolean validateUserRoleMembersBoolTrue = Mockito.mock(DynamicConfigBoolean.class);
        when(validateUserRoleMembersBoolTrue.get()).thenReturn(true);
        zmsImpl.validateUserRoleMembers = validateUserRoleMembersBoolTrue;

        // include all valid principals

        roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.joe").setPrincipalType(Principal.Type.USER.getValue()));
        roleMembers.add(new RoleMember().setMemberName("user.jane").setPrincipalType(Principal.Type.USER.getValue()));
        role.setRoleMembers(roleMembers);

        zmsImpl.validateRoleMemberPrincipals(role, null, false, "unittest");

        // add one more invalid user

        roleMembers.add(new RoleMember().setMemberName("user.john").setPrincipalType(Principal.Type.USER.getValue()));
        try {
            zmsImpl.validateRoleMemberPrincipals(role, null, false, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // do not allow any groups

        roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.joe").setPrincipalType(Principal.Type.USER.getValue()));
        roleMembers.add(new RoleMember().setMemberName("user.jane").setPrincipalType(Principal.Type.USER.getValue()));
        roleMembers.add(new RoleMember().setMemberName("coretech:group.dev-team").setPrincipalType(Principal.Type.GROUP.getValue()));
        role.setRoleMembers(roleMembers);
        try {
            zmsImpl.validateRoleMemberPrincipals(role, null, true, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // unknown types are always rejected

        roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("unknown").setPrincipalType(Principal.Type.UNKNOWN.getValue()));
        role.setRoleMembers(roleMembers);
        try {
            zmsImpl.validateRoleMemberPrincipals(role, null, false, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }
    }

    @Test
    public void testValidateRoleMemberPrincipalUser() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = new TestUserPrincipalAuthority();
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true);
        zmsImpl.validateUserRoleMembers = dynamicConfigBoolean;

        // valid users no exception

        zmsImpl.validateRoleMemberPrincipal("user.joe", Principal.Type.USER.getValue(), null, null, null, false, "unittest");
        zmsImpl.validateRoleMemberPrincipal("user.jane", Principal.Type.USER.getValue(), null, null, null, false, "unittest");

        // invalid user request error

        try {
            zmsImpl.validateRoleMemberPrincipal("user.john", Principal.Type.USER.getValue(), null, null, null, false, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // non - user principals by default are accepted

        zmsImpl.validateRoleMemberPrincipal("coretech.api", Principal.Type.SERVICE.getValue(),
                null, null, null, false, "unittest");

        // valid employee and contractor users

        zmsImpl.validateRoleMemberPrincipal("user.joe", Principal.Type.USER.getValue(), "employee",
                null, null, false, "unittest");
        zmsImpl.validateRoleMemberPrincipal("user.jane", Principal.Type.USER.getValue(), "employee",
                null, null, false, "unittest");
        zmsImpl.validateRoleMemberPrincipal("user.jack", Principal.Type.USER.getValue(), "contractor",
                null, null, false, "unittest");

        // valid multiple attribute users

        zmsImpl.validateRoleMemberPrincipal("user.joe", Principal.Type.USER.getValue(), "employee,local",
                null, null, false, "unittest");
        zmsImpl.validateRoleMemberPrincipal("user.jane", Principal.Type.USER.getValue(), "employee,local",
                null, null, false, "unittest");
        zmsImpl.validateRoleMemberPrincipal("user.jack", Principal.Type.USER.getValue(), "contractor,local",
                null, null, false, "unittest");

        // invalid employee type

        try {
            zmsImpl.validateRoleMemberPrincipal("user.jack", Principal.Type.USER.getValue(), "employee",
                    null, null, false, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // invalid multiple types

        try {
            zmsImpl.validateRoleMemberPrincipal("user.jack", Principal.Type.USER.getValue(), "local,employee",
                    null, null, false, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.userAuthority = savedAuthority;
    }

    @Test
    public void testValidateRoleMemberPrincipalService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true);
        zmsImpl.validateServiceRoleMembers = dynamicConfigBoolean;

        // wildcards are always valid with no exception

        zmsImpl.validateRoleMemberPrincipal("athenz.api*", Principal.Type.SERVICE.getValue(),
                null, null, null, false, "unittest");
        zmsImpl.validateRoleMemberPrincipal("coretech.*", Principal.Type.SERVICE.getValue(),
                null, null, null, false, "unittest");

        // should get back invalid request since service does not exist

        try {
            zmsImpl.validateRoleMemberPrincipal("coretech.api", Principal.Type.SERVICE.getValue(), "employee",
                    null, null, false, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // invalid service request error

        try {
            zmsImpl.validateRoleMemberPrincipal("coretech", Principal.Type.SERVICE.getValue(),
                    null, null, null, false, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain1", "testorg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech2",
                "Test Domain2", "testorg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject("coretech",
                "api", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "coretech", "api", auditRef, false, null, service1);

        // known service - no exception

        zmsImpl.validateRoleMemberPrincipal("coretech.api", Principal.Type.SERVICE.getValue(),
                null, null,  null, false, "unittest");

        // unknown service - exception

        try {
            zmsImpl.validateRoleMemberPrincipal("coretech.backend", Principal.Type.SERVICE.getValue(),
                    null, null, null, false, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // include coretech and rbac in the skip domain list and try
        // the operation again

        System.setProperty(ZMSConsts.ZMS_PROP_VALIDATE_SERVICE_MEMBERS_SKIP_DOMAINS,
                "unix,coretech,rbac.*");
        zmsImpl.loadConfigurationSettings();
        zmsImpl.validateServiceRoleMembers = dynamicConfigBoolean;

        // coretech is now accepted

        zmsImpl.validateRoleMemberPrincipal("coretech.backend", Principal.Type.SERVICE.getValue(),
                null, null, null, false, "unittest");

        // but coretech2 is rejected

        try {
            zmsImpl.validateRoleMemberPrincipal("coretech2.backend", Principal.Type.SERVICE.getValue(),
                    null, null, null, false, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // rbac.sre does not exists, but is accepted because rbac.* is included in skipDomains

        zmsImpl.validateRoleMemberPrincipal("rbac.sre.backend", Principal.Type.SERVICE.getValue(),
                null, null, null ,false, "unittest");

        // user principals by default are accepted

        zmsImpl.validateRoleMemberPrincipal("user.john", Principal.Type.USER.getValue(), null, null, null, false, "unittest");

        // reset our setting

        System.clearProperty(ZMSConsts.ZMS_PROP_VALIDATE_SERVICE_MEMBERS_SKIP_DOMAINS);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech2", auditRef, null);
    }

    @Test
    public void testValidateGroupMemberPrincipal() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = new TestUserPrincipalAuthority();

        // wildcards are always rejected

        try {
            zmsImpl.validateGroupMemberPrincipal("athenz.api*", Principal.Type.SERVICE.getValue(), null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        try {
            zmsImpl.validateGroupMemberPrincipal("athenz.api*", Principal.Type.SERVICE.getValue(), null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        try {
            zmsImpl.validateGroupMemberPrincipal("*", Principal.Type.SERVICE.getValue(), null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // should get back invalid request since service does not exist

        try {
            zmsImpl.validateGroupMemberPrincipal("coretech.api", Principal.Type.SERVICE.getValue(), "employee", "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // invalid service request error

        try {
            zmsImpl.validateGroupMemberPrincipal("coretech", Principal.Type.SERVICE.getValue(), null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("coretech", "Test Domain1", "testorg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ServiceIdentity service1 = zmsTestInitializer.createServiceObject("coretech",
                "api", "http://localhost", "/usr/bin/java", "root",
                "users", "host1");

        zmsImpl.putServiceIdentity(ctx, "coretech", "api", auditRef, false, null, service1);

        // known service - no exception

        zmsImpl.validateGroupMemberPrincipal("coretech.api", Principal.Type.SERVICE.getValue(), null,  "unittest");

        // unknown service - exception

        try {
            zmsImpl.validateGroupMemberPrincipal("coretech.backend", Principal.Type.SERVICE.getValue(), null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // known user principals are accepted

        zmsImpl.validateGroupMemberPrincipal("user.joe", Principal.Type.USER.getValue(), null, "unittest");
        zmsImpl.validateGroupMemberPrincipal("user.jane", Principal.Type.USER.getValue(), null, "unittest");

        // unknown users are rejected

        try {
            zmsImpl.validateGroupMemberPrincipal("user.john", Principal.Type.USER.getValue(), null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // groups and unknown types are rejected

        try {
            zmsImpl.validateGroupMemberPrincipal("user", Principal.Type.UNKNOWN.getValue(), null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        Group group = zmsTestInitializer.createGroupObject("coretech", "dev-team", "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, "coretech", "dev-team", auditRef, false, null, group);

        try {
            zmsImpl.validateGroupMemberPrincipal("coretech:group.dev-team", Principal.Type.GROUP.getValue(), null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // reset our setting

        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
    }

    @Test
    public void testCreateMembershipApprovalNotification() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("testdomain1","Role Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role selfserverole = zmsTestInitializer.createRoleObject("testdomain1", "testrole2", null,"user.john", "user.jane");
        zmsImpl.putRole(ctx, "testdomain1", "testrole2", auditRef, false, null, selfserverole);

        RoleMeta rm = ZMSTestUtils.createRoleMetaObject(true);
        zmsImpl.putRoleMeta(ctx, "testdomain1", "testrole2",  auditRef, null, rm);

        Authority auditAdminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String auditAdminUnsignedCreds = "v=U1;d=user;n=fury";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAuditAdminPrince = SimplePrincipal.create("user", "fury",
                auditAdminUnsignedCreds + ";s=signature", 0, auditAdminPrincipalAuthority);
        assertNotNull(rsrcAuditAdminPrince);
        ((SimplePrincipal) rsrcAuditAdminPrince).setUnsignedCreds(auditAdminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAuditAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAuditAdminPrince);

        Membership membership = new Membership().setActive(false).setApproved(false)
                .setMemberName("user.fury").setRoleName("testrole2");

        zmsImpl.putMembership(ctx, "testdomain1", "testrole2", "user.fury", "adding fury", false, null, membership);

        //revert back to admin principal
        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        List<Notification> expextedNotifications = Collections.singletonList(new Notification());
        expextedNotifications.get(0).addRecipient("user.user1");
        expextedNotifications.get(0).addDetails("requester", "user.fury");
        expextedNotifications.get(0).addDetails("reason", "adding fury");
        expextedNotifications.get(0).addDetails("role", "testrole2");
        expextedNotifications.get(0).addDetails("domain", "testdomain1");
        expextedNotifications.get(0).addDetails("member", "user.fury");
        expextedNotifications.get(0).setNotificationToEmailConverter(new PutRoleMembershipNotificationTask.PutMembershipNotificationToEmailConverter(new NotificationToEmailConverterCommon(null)));
        expextedNotifications.get(0).setNotificationToMetricConverter(new PutRoleMembershipNotificationTask.PutMembershipNotificationToMetricConverter());

        verify(zmsTestInitializer.getMockNotificationManager(),
                times(1)).sendNotifications(eq(expextedNotifications));

        zmsImpl.deleteTopLevelDomain(ctx, "testdomain1", auditRef, null);
    }

    @Test
    public void testGetMemberDueDate() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertEquals(zmsImpl.getMemberDueDate(100, null), Timestamp.fromMillis(100));
        assertEquals(zmsImpl.getMemberDueDate(100, Timestamp.fromMillis(50)), Timestamp.fromMillis(50));
        assertEquals(zmsImpl.getMemberDueDate(100, Timestamp.fromMillis(150)), Timestamp.fromMillis(100));
    }

    @Test
    public void testMemberDueDateTimestamp() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertEquals(zmsImpl.memberDueDateTimestamp(null, null, Timestamp.fromMillis(100)), Timestamp.fromMillis(100));
        assertEquals(zmsImpl.memberDueDateTimestamp(-1, 0, Timestamp.fromMillis(100)), Timestamp.fromMillis(100));
        assertEquals(zmsImpl.memberDueDateTimestamp(-3, -2, Timestamp.fromMillis(100)), Timestamp.fromMillis(100));

        long ext50Millis = TimeUnit.MILLISECONDS.convert(50, TimeUnit.DAYS);
        long ext75Millis = TimeUnit.MILLISECONDS.convert(75, TimeUnit.DAYS);
        long ext100Millis = TimeUnit.MILLISECONDS.convert(100, TimeUnit.DAYS);

        Timestamp stamp = zmsImpl.memberDueDateTimestamp(100, 50, Timestamp.fromMillis(System.currentTimeMillis() + ext75Millis));
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext50Millis));

        stamp = zmsImpl.memberDueDateTimestamp(75, null, Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis));
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext75Millis));
    }

    @Test
    public void testUpdateRoleMemberReview() {

        long ext100Millis = TimeUnit.MILLISECONDS.convert(100, TimeUnit.DAYS);
        long ext125Millis = TimeUnit.MILLISECONDS.convert(125, TimeUnit.DAYS);
        long ext150Millis = TimeUnit.MILLISECONDS.convert(150, TimeUnit.DAYS);
        long ext175Millis = TimeUnit.MILLISECONDS.convert(175, TimeUnit.DAYS);

        List<RoleMember> members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.joe").setReviewReminder(null)
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("user.jane")
                .setReviewReminder(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("athenz.api").setReviewReminder(null)
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz.backend")
                .setReviewReminder(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz.api.group").setReviewReminder(null)
                .setPrincipalType(Principal.Type.GROUP.getValue()));
        members.add(new RoleMember().setMemberName("athenz.backend.group")
                .setReviewReminder(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.GROUP.getValue()));

        Role role = new Role().setMemberReviewDays(125).setServiceReviewDays(150).setGroupReviewDays(175);
        MemberDueDays memberDueDays = new MemberDueDays(null, role, MemberDueDays.Type.REMINDER);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        zmsImpl.updateRoleMemberReviewReminder(memberDueDays, members);

        Timestamp stamp = members.get(0).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext125Millis));

        stamp = members.get(1).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        stamp = members.get(2).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext150Millis));

        stamp = members.get(3).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        stamp = members.get(4).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext175Millis));

        stamp = members.get(5).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));
    }

    @Test
    public void testUpdateRoleMemberReviewNoUser() {

        long ext100Millis = TimeUnit.MILLISECONDS.convert(100, TimeUnit.DAYS);
        long ext150Millis = TimeUnit.MILLISECONDS.convert(150, TimeUnit.DAYS);
        long ext175Millis = TimeUnit.MILLISECONDS.convert(175, TimeUnit.DAYS);

        List<RoleMember> members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.joe").setReviewReminder(null)
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("user.jane")
                .setReviewReminder(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("athenz.api").setReviewReminder(null)
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz.backend")
                .setReviewReminder(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz.api.group").setReviewReminder(null)
                .setPrincipalType(Principal.Type.GROUP.getValue()));
        members.add(new RoleMember().setMemberName("athenz.backend.group")
                .setReviewReminder(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.GROUP.getValue()));

        Role role = new Role().setMemberReviewDays(0).setServiceReviewDays(150).setGroupReviewDays(175);
        MemberDueDays memberDueDays = new MemberDueDays(null, role, MemberDueDays.Type.REMINDER);

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        zmsImpl.updateRoleMemberReviewReminder(memberDueDays, members);

        assertNull(members.get(0).getReviewReminder());

        Timestamp stamp = members.get(1).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        stamp = members.get(2).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext150Millis));

        stamp = members.get(3).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        stamp = members.get(4).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext175Millis));

        stamp = members.get(5).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));
    }

    @Test
    public void testUpdateRoleMemberReviewNoService() {

        long ext100Millis = TimeUnit.MILLISECONDS.convert(100, TimeUnit.DAYS);
        long ext125Millis = TimeUnit.MILLISECONDS.convert(125, TimeUnit.DAYS);

        List<RoleMember> members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.joe").setReviewReminder(null)
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("user.jane")
                .setReviewReminder(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("athenz.api").setReviewReminder(null)
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz.backend")
                .setReviewReminder(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz.api.group").setReviewReminder(null)
                .setPrincipalType(Principal.Type.GROUP.getValue()));
        members.add(new RoleMember().setMemberName("athenz.backend.group")
                .setReviewReminder(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.GROUP.getValue()));

        Role role = new Role().setMemberReviewDays(125).setServiceReviewDays(0).setGroupReviewDays(175);
        MemberDueDays memberDueDays = new MemberDueDays(null, role, MemberDueDays.Type.REMINDER);
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        zmsImpl.updateRoleMemberReviewReminder(memberDueDays, members);

        Timestamp stamp = members.get(0).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext125Millis));

        stamp = members.get(1).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        assertNull(members.get(2).getReviewReminder());

        stamp = members.get(3).getReviewReminder();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));
    }

    @Test
    public void testUpdateRoleMemberExpiration() {

        long ext100Millis = TimeUnit.MILLISECONDS.convert(100, TimeUnit.DAYS);
        long ext125Millis = TimeUnit.MILLISECONDS.convert(125, TimeUnit.DAYS);
        long ext150Millis = TimeUnit.MILLISECONDS.convert(150, TimeUnit.DAYS);

        List<RoleMember> members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.joe").setExpiration(null)
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("user.jane")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("athenz.api").setExpiration(null)
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz.backend")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz:group.dev-team").setExpiration(null)
                .setPrincipalType(Principal.Type.GROUP.getValue()));
        members.add(new RoleMember().setMemberName("athenz:group.ops-team")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.GROUP.getValue()));
        members.add(new RoleMember().setMemberName("user-headless.api").setExpiration(null)
                .setPrincipalType(Principal.Type.USER_HEADLESS.getValue()));

        // for user members we have 50/125 setup while for service members 75/150

        Role role = new Role().setMemberExpiryDays(125).setServiceExpiryDays(150).setGroupExpiryDays(125);
        Domain domain = new Domain().setMemberExpiryDays(50).setServiceExpiryDays(75).setGroupExpiryDays(100);
        MemberDueDays memberDueDays = new MemberDueDays(domain, role, MemberDueDays.Type.EXPIRY);

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        zmsImpl.updateRoleMemberExpiration(memberDueDays, members);

        assertEquals(members.get(0).getMemberName(), "user.joe");
        Timestamp stamp = members.get(0).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext125Millis));

        assertEquals(members.get(1).getMemberName(), "user.jane");
        stamp = members.get(1).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        assertEquals(members.get(2).getMemberName(), "athenz.api");
        stamp = members.get(2).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext150Millis));

        assertEquals(members.get(3).getMemberName(), "athenz.backend");
        stamp = members.get(3).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        assertEquals(members.get(4).getMemberName(), "athenz:group.dev-team");
        stamp = members.get(4).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext125Millis));

        assertEquals(members.get(5).getMemberName(), "athenz:group.ops-team");
        stamp = members.get(5).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        assertEquals(members.get(6).getMemberName(), "user-headless.api");
        stamp = members.get(6).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext150Millis));
    }

    @Test
    public void testUpdateRoleMemberExpirationNoUser() {

        long ext100Millis = TimeUnit.MILLISECONDS.convert(100, TimeUnit.DAYS);
        long ext150Millis = TimeUnit.MILLISECONDS.convert(150, TimeUnit.DAYS);

        List<RoleMember> members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.joe").setExpiration(null)
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("user.jane")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("athenz.api").setExpiration(null)
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz.backend")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz:group.dev-team").setExpiration(null)
                .setPrincipalType(Principal.Type.GROUP.getValue()));
        members.add(new RoleMember().setMemberName("athenz:group.ops-team")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.GROUP.getValue()));
        members.add(new RoleMember().setMemberName("user-headless.api").setExpiration(null)
                .setPrincipalType(Principal.Type.USER_HEADLESS.getValue()));

        // for user members we have 0 setup while for service members 75/150

        Role role = new Role().setMemberExpiryDays(0).setServiceExpiryDays(150).setGroupExpiryDays(0);
        Domain domain = new Domain().setMemberExpiryDays(0).setServiceExpiryDays(75).setGroupExpiryDays(0);
        MemberDueDays memberDueDays = new MemberDueDays(domain, role, MemberDueDays.Type.EXPIRY);

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        zmsImpl.updateRoleMemberExpiration(memberDueDays, members);

        assertEquals(members.get(0).getMemberName(), "user.joe");
        assertNull(members.get(0).getExpiration());

        assertEquals(members.get(1).getMemberName(), "user.jane");
        Timestamp stamp = members.get(1).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        assertEquals(members.get(2).getMemberName(), "athenz.api");
        stamp = members.get(2).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext150Millis));

        assertEquals(members.get(3).getMemberName(), "athenz.backend");
        stamp = members.get(3).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        assertEquals(members.get(4).getMemberName(), "athenz:group.dev-team");
        assertNull(members.get(4).getExpiration());

        assertEquals(members.get(5).getMemberName(), "athenz:group.ops-team");
        stamp = members.get(5).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        assertEquals(members.get(6).getMemberName(), "user-headless.api");
        stamp = members.get(6).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext150Millis));
    }

    @Test
    public void testUpdateRoleMemberExpirationNoService() {

        long ext100Millis = TimeUnit.MILLISECONDS.convert(100, TimeUnit.DAYS);
        long ext125Millis = TimeUnit.MILLISECONDS.convert(125, TimeUnit.DAYS);

        List<RoleMember> members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.joe").setExpiration(null)
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("user.jane")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("athenz.api").setExpiration(null)
                .setPrincipalType(Principal.Type.SERVICE.getValue()));
        members.add(new RoleMember().setMemberName("athenz.backend")
                .setExpiration(Timestamp.fromMillis(System.currentTimeMillis() + ext100Millis))
                .setPrincipalType(Principal.Type.SERVICE.getValue()));

        // for user members we have 50/125 setup while for service members 0

        Role role = new Role().setMemberExpiryDays(125).setServiceExpiryDays(0).setGroupExpiryDays(0);
        Domain domain = new Domain().setMemberExpiryDays(50).setServiceExpiryDays(0).setGroupExpiryDays(0);
        MemberDueDays memberDueDays = new MemberDueDays(domain, role, MemberDueDays.Type.EXPIRY);

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        zmsImpl.updateRoleMemberExpiration(memberDueDays, members);

        Timestamp stamp = members.get(0).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext125Millis));

        stamp = members.get(1).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));

        assertNull(members.get(2).getExpiration());

        stamp = members.get(3).getExpiration();
        assertTrue(ZMSTestUtils.validateDueDate(stamp.millis(), ext100Millis));
    }

    @Test
    public void testRemoveMatchedAssertionNoMatch() {

        List<Assertion> assertions = new ArrayList<>();
        List<Assertion> matchedAssertions = new ArrayList<>();

        Assertion assertion = new Assertion().setAction("action").setResource("resource")
                .setRole("role").setEffect(AssertionEffect.ALLOW);
        assertions.add(assertion);

        Assertion checkAssertion = new Assertion().setAction("action").setResource("resource")
                .setRole("role1").setEffect(AssertionEffect.ALLOW);

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        assertFalse(zmsImpl.dbService.removeMatchedAssertion(checkAssertion, assertions, matchedAssertions));

        // match the role but not the affect

        checkAssertion.setRole("role");
        checkAssertion.setEffect(AssertionEffect.DENY);

        assertFalse(zmsImpl.dbService.removeMatchedAssertion(checkAssertion, assertions, matchedAssertions));

        // full match

        checkAssertion.setEffect(AssertionEffect.ALLOW);
        assertTrue(zmsImpl.dbService.removeMatchedAssertion(checkAssertion, assertions, matchedAssertions));
    }

    @Test
    public void testIsUserDomainPrincipal() {

        // default no additional user domains

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        assertTrue(ZMSUtils.isUserDomainPrincipal("user.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertFalse(ZMSUtils.isUserDomainPrincipal("unix.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertFalse(ZMSUtils.isUserDomainPrincipal("ldap.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertFalse(ZMSUtils.isUserDomainPrincipal("x509.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));

        // now let's set the addls to empty - no changes

        System.setProperty(ZMSConsts.ZMS_PROP_ADDL_USER_CHECK_DOMAINS, "");
        zmsImpl = zmsTestInitializer.zmsInit();
        assertTrue(ZMSUtils.isUserDomainPrincipal("user.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertFalse(ZMSUtils.isUserDomainPrincipal("unix.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertFalse(ZMSUtils.isUserDomainPrincipal("ldap.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertFalse(ZMSUtils.isUserDomainPrincipal("x509.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));

        // now let's add one of the domains to the list

        System.setProperty(ZMSConsts.ZMS_PROP_ADDL_USER_CHECK_DOMAINS, "unix");
        zmsImpl = zmsTestInitializer.zmsInit();
        assertTrue(ZMSUtils.isUserDomainPrincipal("user.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertTrue(ZMSUtils.isUserDomainPrincipal("unix.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertFalse(ZMSUtils.isUserDomainPrincipal("ldap.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertFalse(ZMSUtils.isUserDomainPrincipal("x509.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));

        // now let's set two domains in the list

        System.setProperty(ZMSConsts.ZMS_PROP_ADDL_USER_CHECK_DOMAINS, "unix,ldap");
        zmsImpl = zmsTestInitializer.zmsInit();
        assertTrue(ZMSUtils.isUserDomainPrincipal("user.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertTrue(ZMSUtils.isUserDomainPrincipal("unix.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertTrue(ZMSUtils.isUserDomainPrincipal("ldap.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));
        assertFalse(ZMSUtils.isUserDomainPrincipal("x509.joe", zmsImpl.userDomainPrefix, zmsImpl.addlUserCheckDomainPrefixList));

        System.clearProperty(ZMSConsts.ZMS_PROP_ADDL_USER_CHECK_DOMAINS);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testPutRoleReviewEnabledMembers() {

        final String domainName = "role-review-enabled";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Role review Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "role1", null, "user.john", "user.jane");
        role1.setReviewEnabled(true);

        try {
            zmsImpl.putRole(ctx, domainName, "role1", auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Set review-enabled flag using role meta api"));
        }

        // now create a role review enabled with no members

        Role role2 = zmsTestInitializer.createRoleObject(domainName, "role2", null, null, null);
        role2.setReviewEnabled(true);
        zmsImpl.putRole(ctx, domainName, "role2", auditRef, false, null, role2);

        Role resRole2 = zmsImpl.getRole(ctx, domainName, "role2", false, false, false);
        assertNotNull(resRole2);
        assertTrue(resRole2.getReviewEnabled());

        // we should not be able to modify a review enabled role

        Role role2a = zmsTestInitializer.createRoleObject(domainName, "role2", null, "user.john", "user.jane");
        try {
            zmsImpl.putRole(ctx, domainName, "role2", auditRef, false, null, role2a);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Can not update auditEnabled and/or reviewEnabled roles"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testLoadServerPrivateKey() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // first we try with ec private key only

        System.setProperty(FilePrivateKeyStore.ATHENZ_PROP_PRIVATE_EC_KEY, "src/test/resources/unit_test_zms_private_ec.pem");
        System.clearProperty(FilePrivateKeyStore.ATHENZ_PROP_PRIVATE_RSA_KEY);
        System.clearProperty(FilePrivateKeyStore.ATHENZ_PROP_PRIVATE_KEY);

        zmsImpl.loadPrivateKeyStore();
        assertNotNull(zmsImpl.privateECKey);
        assertEquals(zmsImpl.privateKey, zmsImpl.privateECKey);
        assertNull(zmsImpl.privateRSAKey);

        // now let's try the rsa key

        System.setProperty(FilePrivateKeyStore.ATHENZ_PROP_PRIVATE_RSA_KEY, "src/test/resources/unit_test_zms_private.pem");
        System.clearProperty(FilePrivateKeyStore.ATHENZ_PROP_PRIVATE_EC_KEY);
        System.clearProperty(FilePrivateKeyStore.ATHENZ_PROP_PRIVATE_KEY);

        zmsImpl.loadPrivateKeyStore();
        assertNotNull(zmsImpl.privateRSAKey);
        assertEquals(zmsImpl.privateKey, zmsImpl.privateRSAKey);
        assertNull(zmsImpl.privateECKey);

        // now back to our regular key setup

        System.setProperty(FilePrivateKeyStore.ATHENZ_PROP_PRIVATE_KEY, "src/test/resources/unit_test_zms_private.pem");
        System.clearProperty(FilePrivateKeyStore.ATHENZ_PROP_PRIVATE_EC_KEY);
        System.clearProperty(FilePrivateKeyStore.ATHENZ_PROP_PRIVATE_RSA_KEY);

        zmsImpl.loadPrivateKeyStore();
        assertNotNull(zmsImpl.privateKey);
        assertNull(zmsImpl.privateECKey);
        assertNull(zmsImpl.privateRSAKey);
    }

    @Test
    public void testLoadInvalidClasses() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        System.setProperty(ZMSConsts.ZMS_PROP_METRIC_FACTORY_CLASS, "invalid.class");
        try {
            zmsImpl.loadMetricObject();
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains("Invalid metric class"));
        }
        System.clearProperty(ZMSConsts.ZMS_PROP_METRIC_FACTORY_CLASS);

        System.setProperty(ZMS_PROP_AUTH_HISTORY_STORE_FACTORY_CLASS, "invalid.class");
        try {
            zmsImpl.loadAuthHistoryStore();
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains("Invalid auth history store"));
        }
        System.clearProperty(ZMSConsts.ZMS_PROP_AUTH_HISTORY_STORE_FACTORY_CLASS);

        System.setProperty(ZMSConsts.ZMS_PROP_OBJECT_STORE_FACTORY_CLASS, "invalid.class");
        try {
            zmsImpl.loadObjectStore();
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains("Invalid object store"));
        }
        System.clearProperty(ZMSConsts.ZMS_PROP_OBJECT_STORE_FACTORY_CLASS);

        System.setProperty(ZMSConsts.ZMS_PROP_PRIVATE_KEY_STORE_FACTORY_CLASS, "invalid.class");
        try {
            zmsImpl.loadPrivateKeyStore();
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains("Invalid private key store"));
        }
        System.clearProperty(ZMSConsts.ZMS_PROP_PRIVATE_KEY_STORE_FACTORY_CLASS);

        System.setProperty(ZMSConsts.ZMS_PROP_AUDIT_LOGGER_FACTORY_CLASS, "invalid.class");
        try {
            zmsImpl.loadAuditLogger();
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains("Invalid audit logger class"));
        }
        System.clearProperty(ZMSConsts.ZMS_PROP_AUDIT_LOGGER_FACTORY_CLASS);

        assertNull(zmsImpl.getAuthority("invalid.class"));

        System.setProperty(ZMSConsts.ZMS_PROP_AUTHORITY_CLASSES, "invalid.class");
        try {
            zmsImpl.loadAuthorities();
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains("Invalid authority"));
        }
        System.clearProperty(ZMSConsts.ZMS_PROP_AUTHORITY_CLASSES);

        System.setProperty(ZMSConsts.ZMS_PROP_STATUS_CHECKER_FACTORY_CLASS, "invalid.class");
        try {
            zmsImpl.loadStatusChecker();
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains("Invalid status checker"));
        }
        System.clearProperty(ZMSConsts.ZMS_PROP_STATUS_CHECKER_FACTORY_CLASS);

        System.setProperty(ZMSConsts.ZMS_PROP_DOMAIN_META_STORE_FACTORY_CLASS, "invalid.class");
        try {
            zmsImpl.loadDomainMetaStore();
            fail();
        } catch (Exception ex) {
            assertTrue(ex.getMessage().contains("Invalid metastore factory"));
        }
        System.clearProperty(ZMSConsts.ZMS_PROP_DOMAIN_META_STORE_FACTORY_CLASS);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testInvalidConfigValues() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        System.setProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT, "-10");
        System.setProperty(ZMSConsts.ZMS_PROP_SIGNED_POLICY_TIMEOUT, "-10");

        zmsImpl.loadConfigurationSettings();

        assertEquals(zmsImpl.virtualDomainLimit, 5);
        assertEquals(zmsImpl.signedPolicyTimeout, 604800000);

        System.clearProperty(ZMSConsts.ZMS_PROP_VIRTUAL_DOMAIN_LIMIT);
        System.clearProperty(ZMSConsts.ZMS_PROP_SIGNED_POLICY_TIMEOUT);

        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testLoadAuthorities() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        assertNull(zmsImpl.userAuthority);
        assertNull(zmsImpl.principalAuthority);

        // set the authority class properties

        System.setProperty(ZMSConsts.ZMS_PROP_AUTHORITY_CLASSES, ZMSConsts.ZMS_PRINCIPAL_AUTHORITY_CLASS);
        System.setProperty(ZMSConsts.ZMS_PROP_PRINCIPAL_AUTHORITY_CLASS, ZMSConsts.ZMS_PRINCIPAL_AUTHORITY_CLASS);
        System.setProperty(ZMSConsts.ZMS_PROP_USER_AUTHORITY_CLASS, ZMSConsts.ZMS_PRINCIPAL_AUTHORITY_CLASS);

        zmsImpl.loadAuthorities();

        assertNotNull(zmsImpl.userAuthority);
        assertNotNull(zmsImpl.principalAuthority);

        System.clearProperty(ZMSConsts.ZMS_PROP_AUTHORITY_CLASSES);
        System.clearProperty(ZMSConsts.ZMS_PROP_PRINCIPAL_AUTHORITY_CLASS);
        System.clearProperty(ZMSConsts.ZMS_PROP_USER_AUTHORITY_CLASS);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testAutoApplyTemplate() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        System.setProperty(ZMSConsts.ZMS_AUTO_UPDATE_TEMPLATE_FEATURE_FLAG, "true");
        try {
            zmsImpl.autoApplyTemplates();
        } catch (Exception e) {
            fail();
        }
        System.clearProperty(ZMSConsts.ZMS_AUTO_UPDATE_TEMPLATE_FEATURE_FLAG);
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testLoadPublicKeysInvalidService() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        // delete all public keys from zms service

        ServiceIdentity serviceRes = zmsImpl.getServiceIdentity(ctx, "sys.auth", "zms");
        List<PublicKeyEntry> keyList = serviceRes.getPublicKeys();
        for (PublicKeyEntry entry : keyList) {
            zmsImpl.deletePublicKeyEntry(ctx, "sys.auth", "zms", entry.getId(), auditRef, null);
        }

        // delete all public keys and load again

        zmsImpl.serverPublicKeyMap.clear();
        zmsTestInitializer.loadServerPublicKeys(zmsImpl);

        assertFalse(zmsImpl.serverPublicKeyMap.isEmpty());

        // now verify without the zms service

        zmsImpl.deleteServiceIdentity(ctx, "sys.auth", "zms", auditRef, null);

        // delete all public keys and load again

        zmsImpl.serverPublicKeyMap.clear();
        zmsTestInitializer.loadServerPublicKeys(zmsImpl);

        assertFalse(zmsImpl.serverPublicKeyMap.isEmpty());
        zmsImpl.objectStore.clearConnections();
    }

    @Test
    public void testAddDefaultAdminMembers() {

        final String domainName = "add-default-domain-admins";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role adminRole = zmsImpl.getRole(ctx, domainName, "admin", false, false, false);
        assertEquals(adminRole.getRoleMembers().size(), 1);

        List<String> admins = new ArrayList<>();
        admins.add(zmsTestInitializer.getAdminUser());
        admins.add("user.default");

        DefaultAdmins addDefaultAdmins = new DefaultAdmins().setAdmins(admins);
        zmsImpl.addDefaultAdminMembers(ctx, domainName, adminRole, addDefaultAdmins, auditRef, "unittest");

        adminRole = zmsImpl.getRole(ctx, domainName, "admin", false, false, false);
        assertEquals(adminRole.getRoleMembers().size(), 2);
        boolean newAdminFound = false;
        for (RoleMember roleMember : adminRole.getRoleMembers()) {
            if (roleMember.getMemberName().equals("user.default")) {
                newAdminFound = true;
                break;
            }
        }
        assertTrue(newAdminFound);

        // now let's delete the default admin user

        admins = new ArrayList<>();
        admins.add("user.default");
        admins.add("user.unknown");
        DefaultAdmins deleteDefaultAdmins = new DefaultAdmins().setAdmins(admins);

        zmsImpl.removeAdminMembers(ctx, domainName, Collections.singletonList(adminRole),
                adminRole.getName(), deleteDefaultAdmins, auditRef, "unittest");

        // verify we're back to a single admin role member

        Role adminRoleResponse = zmsImpl.getRole(ctx, domainName, "admin", false, false, false);
        assertEquals(adminRoleResponse.getRoleMembers().size(), 1);
        assertEquals(adminRoleResponse.getRoleMembers().get(0).getMemberName(), zmsTestInitializer.getAdminUser());

        // let's delete the members again which typically would return
        // a not found exception, but we're going to ignore it

        zmsImpl.removeAdminMembers(ctx, domainName, Collections.singletonList(adminRole),
                adminRole.getName(), deleteDefaultAdmins, auditRef, "unittest");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetJWSDomain() throws JsonProcessingException, ParseException, JOSEException {

        final String domainName = "jws-domain";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setMemberPurgeExpiryDays(90);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Response response = zmsImpl.getJWSDomain(ctx, domainName, null, null);
        JWSDomain jwsDomain = (JWSDomain) response.getEntity();
        DomainData domainData = zmsTestInitializer.getDomainData(jwsDomain);

        assertNotNull(domainData);
        assertEquals(domainData.getName(), "jws-domain");
        assertEquals(domainData.getMemberPurgeExpiryDays(), 90);

        Map<String, String> header = jwsDomain.getHeader();
        assertEquals(header.get("kid"), "0");

        // now we're going to ask for the same domain with the tag
        // and make sure we get back 304

        EntityTag tag = response.getEntityTag();
        response = zmsImpl.getJWSDomain(ctx, domainName, Boolean.FALSE, tag.getValue());
        assertEquals(response.getStatus(), ResourceException.NOT_MODIFIED);

        // pass a timestamp a minute back and make sure we
        // get back the domain

        Timestamp tstamp = Timestamp.fromMillis(System.currentTimeMillis() - 3600);
        response = zmsImpl.getJWSDomain(ctx, domainName, false, tstamp.toString());
        jwsDomain = (JWSDomain) response.getEntity();
        domainData = zmsTestInitializer.getDomainData(jwsDomain);

        assertNotNull(domainData);
        assertEquals(domainData.getName(), "jws-domain");
        assertEquals(domainData.getMemberPurgeExpiryDays(), 90);

        // any invalid data is also treated as no etag

        response = zmsImpl.getJWSDomain(ctx, domainName, null, "unknown-date");
        jwsDomain = (JWSDomain) response.getEntity();
        domainData = zmsTestInitializer.getDomainData(jwsDomain);

        assertNotNull(domainData);
        assertEquals(domainData.getName(), "jws-domain");
        assertEquals(domainData.getMemberPurgeExpiryDays(), 90);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetJWSDomainP1363Signature() throws JsonProcessingException, ParseException, JOSEException {

        final String domainName = "jws-domain-p1363";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Response response = zmsImpl.getJWSDomain(ctx, domainName, Boolean.TRUE, null);
        JWSDomain jwsDomain = (JWSDomain) response.getEntity();

        JWSObject jwsObject = new JWSObject(Base64URL.from(jwsDomain.getProtectedHeader()),
                Base64URL.from(jwsDomain.getPayload()), Base64URL.from(jwsDomain.getSignature()));

        JWSVerifier verifier = new RSASSAVerifier((RSAPublicKey) Crypto.extractPublicKey(zmsImpl.privateKey.getKey()));
        assertTrue(jwsObject.verify(verifier));

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetJWSDomainError() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        // not found

        try {
            zmsImpl.getJWSDomain(ctx, "unknown", Boolean.TRUE, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ResourceException.NOT_FOUND, ex.getCode());
        }

        // null data causing exception which is caught
        // and we return null back as result

        ServerPrivateKey pkey = zmsImpl.privateKey;
        zmsImpl.privateKey = null;
        assertNull(zmsImpl.signJwsDomain(null, null));
        zmsImpl.privateKey = pkey;
    }

    @Test
    public void testValidateIntegerValue() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // valid values

        zmsImpl.validateIntegerValue(10, "positive");
        zmsImpl.validateIntegerValue(0, "zero");
        zmsImpl.validateIntegerValue(null, "null");

        // invalid value

        try {
            zmsImpl.validateIntegerValue(-1, "negative");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }
    }

    @Test
    public void testIsAllowedDeletePendingMembership() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "test-domain";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Role Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "testrole1", null, "user.user1", "user.jane");
        zmsImpl.putRole(ctx, domainName, "testrole1", auditRef, false, null, role1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "Policy1", "testrole1",
                "UPDATE", domainName + ":role.*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName, "Policy1", auditRef, false, null, policy1);

        assertTrue(zmsImpl.isAllowedDeletePendingMembership(ctx.principal(), domainName,
                "testrole1", "user.pending"));

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=jane";
        Principal rsrcPrince = SimplePrincipal.create("user", "jane", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);

        assertTrue(zmsImpl.isAllowedDeletePendingMembership(rsrcPrince, domainName,
                "testrole1", "user.pending"));

        unsignedCreds = "v=U1;d=user;n=john";
        rsrcPrince = SimplePrincipal.create("user", "john", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);

        // this time false since john is not authorized

        assertFalse(zmsImpl.isAllowedDeletePendingMembership(rsrcPrince, domainName,
                "testrole1", "user.pending"));

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeletePendingMembershipAdminRequest() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "delete-pending";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "delete pending membership",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testorg");

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testorg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);
        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                domainName, "domain", "org");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "org", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject(domainName, "testrole1", null, "user.john", "user.jane");
        zmsImpl.putRole(ctx, domainName, "testrole1", auditRef, false, null, auditedRole);
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, domainName, "testrole1", "auditenabled", auditRef, rsm);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctx, domainName, "testrole1", "user.bob", auditRef, false, null, mbr);

        // first request using admin principal

        DomainRoleMembership domainRoleMembership = zmsImpl.getPendingDomainRoleMembersList(ctx, "user.fury", null);

        assertNotNull(domainRoleMembership);
        assertNotNull(domainRoleMembership.getDomainRoleMembersList());
        assertEquals(domainRoleMembership.getDomainRoleMembersList().size(), 1);
        for (DomainRoleMembers drm : domainRoleMembership.getDomainRoleMembersList()) {
            assertEquals(drm.getDomainName(), domainName);
            assertNotNull(drm.getMembers());
            for (DomainRoleMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (MemberRole mr : mem.getMemberRoles()) {
                    assertNotNull(mr);
                    assertEquals(mr.getRoleName(), "testrole1");
                }
            }
        }

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=jane";
        Principal rsrcPrince = SimplePrincipal.create("user", "jane", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(rsrcPrince);

        // first try to delete the pending request without proper authorization

        try {
            zmsImpl.deletePendingMembership(rsrcCtx, domainName, "testrole1", "user.bob", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        // repeat the request using context principal

        zmsImpl.deletePendingMembership(ctx, domainName, "testrole1", "user.bob", auditRef);

        // check the list to see there are no pending requests

        domainRoleMembership = zmsImpl.getPendingDomainRoleMembersList(ctx, "user.fury", null);
        assertNotNull(domainRoleMembership);
        assertTrue(domainRoleMembership.getDomainRoleMembersList().isEmpty());

        // delete some unknown member in the same role as admin

        try {
            zmsImpl.deletePendingMembership(ctx, domainName, "testrole1", "user.bob2", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // delete some member in an unknown domain

        try {
            zmsImpl.deletePendingMembership(ctx, "unkwown-domain", "testrole1", "user.bob2", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");
        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeletePendingMembershipSelfServeRequest() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "delete-pending-self-serve";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "delete pending membership",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testorg");

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testorg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);
        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                domainName, "domain", "org");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "org", auditRef, meta);

        Role auditedRole = zmsTestInitializer.createRoleObject(domainName, "testrole1", null, "user.john", "user.jane");
        zmsImpl.putRole(ctx, domainName, "testrole1", auditRef, false, null, auditedRole);
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, domainName, "testrole1", "auditenabled", auditRef, rsm);
        RoleMeta rm = new RoleMeta().setSelfServe(true);
        zmsImpl.putRoleMeta(ctx, domainName, "testrole1", auditRef, null, rm);

        // user.joe is going to add user.bob in the self serve role

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=joe";
        Principal rsrcPrince = SimplePrincipal.create("user", "joe", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        ResourceContext ctxJoe = zmsTestInitializer.createResourceContext(rsrcPrince);

        Membership mbr = new Membership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putMembership(ctxJoe, domainName, "testrole1", "user.bob", auditRef, false, null, mbr);

        // first request using admin principal

        DomainRoleMembership domainRoleMembership = zmsImpl.getPendingDomainRoleMembersList(ctx, "user.fury", null);

        assertNotNull(domainRoleMembership);
        assertNotNull(domainRoleMembership.getDomainRoleMembersList());
        assertEquals(domainRoleMembership.getDomainRoleMembersList().size(), 1);
        for (DomainRoleMembers drm : domainRoleMembership.getDomainRoleMembersList()) {
            assertEquals(drm.getDomainName(), domainName);
            assertNotNull(drm.getMembers());
            for (DomainRoleMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (MemberRole mr : mem.getMemberRoles()) {
                    assertNotNull(mr);
                    assertEquals(mr.getRoleName(), "testrole1");
                }
            }
        }

        // first try to delete the pending request without proper authorization

        unsignedCreds = "v=U1;d=user;n=jane";
        rsrcPrince = SimplePrincipal.create("user", "jane", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        ResourceContext ctxJane = zmsTestInitializer.createResourceContext(rsrcPrince);

        try {
            zmsImpl.deletePendingMembership(ctxJane, domainName, "testrole1", "user.bob", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        // repeat the request using joe principal

        zmsImpl.deletePendingMembership(ctxJoe, domainName, "testrole1", "user.bob", auditRef);

        // check the list to see there are no pending requests

        domainRoleMembership = zmsImpl.getPendingDomainRoleMembersList(ctx, "user.fury", null);
        assertNotNull(domainRoleMembership);
        assertTrue(domainRoleMembership.getDomainRoleMembersList().isEmpty());

        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");
        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetDomainTemplateDetailsList() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "test-domain";
        List<String> adminUsers = new ArrayList<>();
        adminUsers.add("user.test");
        List<String> solutionTemplate = new ArrayList<>();
        solutionTemplate.add("user_provisioning");

        zmsImpl.dbService.makeDomain(ctx,
                ZMSTestUtils.makeDomainObject(domainName, "Test Domain", "org", true, null, 0, null, 0),
                adminUsers, solutionTemplate, auditRef);

        assertNotNull(zmsImpl.getDomainTemplateDetailsList(ctx, domainName));
        zmsImpl.dbService.executeDeleteDomain(ctx, domainName,
                auditRef, "unit-test");
    }

    @Test
    public void testGetServerTemplateDetailsList() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        DomainTemplateDetailsList serverTemplateDetailsList = zmsImpl.getServerTemplateDetailsList(ctx);
        assertEquals(serverTemplateDetailsList.getMetaData().size(), 11);
        TemplateMetaData vipTemplateMetaData = null;
        for (TemplateMetaData templateMetaData : serverTemplateDetailsList.getMetaData()) {
            if (templateMetaData.getTemplateName().equals("vipng")) {
                vipTemplateMetaData = templateMetaData;
                break;
            }
        }
        assertNotNull(vipTemplateMetaData);
        assertEquals(vipTemplateMetaData.getDescription(), "Vipng template");
        assertEquals(vipTemplateMetaData.getLatestVersion().intValue(), 10);
    }

    @Test
    public void testEnforcedUserAuthorityFilter() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Authority savedAuthority = zmsImpl.userAuthority;

        // null authority, filter or empty filter

        zmsImpl.userAuthority = null;
        assertNull(zmsImpl.enforcedUserAuthorityFilter("validFilter", null));
        assertNull(zmsImpl.enforcedUserAuthorityFilter(null, "validFilter"));
        assertNull(zmsImpl.enforcedUserAuthorityFilter("validFilter", "validFilter"));
        assertNull(zmsImpl.enforcedUserAuthorityFilter(null, null));

        zmsImpl.userAuthority = Mockito.mock(Authority.class);

        assertNull(zmsImpl.enforcedUserAuthorityFilter(null, null));
        assertNull(zmsImpl.enforcedUserAuthorityFilter("", null));
        assertNull(zmsImpl.enforcedUserAuthorityFilter(null, ""));

        // valid filter

        assertEquals("validFilter", zmsImpl.enforcedUserAuthorityFilter("validFilter", null));
        assertEquals("validFilter", zmsImpl.enforcedUserAuthorityFilter(null, "validFilter"));
        assertEquals("validFilter", zmsImpl.enforcedUserAuthorityFilter("validFilter", ""));
        assertEquals("validFilter", zmsImpl.enforcedUserAuthorityFilter("", "validFilter"));
        assertEquals("validFilter1,validFilter2", zmsImpl.enforcedUserAuthorityFilter("validFilter1", "validFilter2"));
        assertEquals("validFilter,validFilter", zmsImpl.enforcedUserAuthorityFilter("validFilter", "validFilter"));

        zmsImpl.userAuthority = savedAuthority;
    }

    @Test
    public void testGetUserAuthorityExpiryAttr() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Role role = new Role().setUserAuthorityExpiration("elevated-clearance");

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = null;

        // with authority null we always get null

        assertNull(zmsImpl.getUserAuthorityExpiryAttr(role.getUserAuthorityExpiration()));

        zmsImpl.userAuthority = Mockito.mock(Authority.class);

        assertEquals("elevated-clearance", zmsImpl.getUserAuthorityExpiryAttr(role.getUserAuthorityExpiration()));

        role.setUserAuthorityExpiration("");
        assertNull(zmsImpl.getUserAuthorityExpiryAttr(role.getUserAuthorityExpiration()));

        role.setUserAuthorityExpiration(null);
        assertNull(zmsImpl.getUserAuthorityExpiryAttr(role.getUserAuthorityExpiration()));

        zmsImpl.userAuthority = savedAuthority;
    }

    @Test
    public void testGetUserAuthorityExpiry() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Role role = new Role().setUserAuthorityExpiration("elevated-clearance");

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = null;

        // with authority null we always get null

        assertNull(zmsImpl.getUserAuthorityExpiry("user.john", role.getUserAuthorityExpiration(), "unit-test"));

        Authority authority = Mockito.mock(Authority.class);
        when(authority.getDateAttribute("user.john", "elevated-clearance"))
                .thenReturn(new Date());
        when(authority.getDateAttribute("user.joe", "elevated-clearance"))
                .thenReturn(null);
        zmsImpl.userAuthority = authority;

        assertNotNull(zmsImpl.getUserAuthorityExpiry("user.john", role.getUserAuthorityExpiration(), "unit-test"));

        try {
            zmsImpl.getUserAuthorityExpiry("user.joe", role.getUserAuthorityExpiration(), "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("User does not have required user authority expiry configured"));
        }

        zmsImpl.userAuthority = savedAuthority;
    }

    @Test
    public void testUpdateRoleMemberUserAuthorityExpiry() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Role role = new Role().setUserAuthorityExpiration("elevated-clearance");

        List<RoleMember> members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.john").setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("user.joe").setPrincipalType(Principal.Type.USER.getValue()));
        role.setRoleMembers(members);

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = null;

        // with authority null we always get no changes

        zmsImpl.updateRoleMemberUserAuthorityExpiry(role, "unit-test");
        assertNull(role.getRoleMembers().get(0).getExpiration());
        assertNull(role.getRoleMembers().get(1).getExpiration());

        Authority authority = Mockito.mock(Authority.class);
        when(authority.getDateAttribute("user.john", "elevated-clearance"))
                .thenReturn(new Date());
        when(authority.getDateAttribute("user.jane", "elevated-clearance"))
                .thenReturn(new Date());
        when(authority.getDateAttribute("user.joe", "elevated-clearance"))
                .thenReturn(null);
        zmsImpl.userAuthority = authority;

        // with one valid and one invalid we should get an exception

        try {
            zmsImpl.updateRoleMemberUserAuthorityExpiry(role, "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Invalid member: user.joe"));
        }

        // let's have one valid user and one service

        members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.john").setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("sports.api").setPrincipalType(Principal.Type.SERVICE.getValue()));
        role.setRoleMembers(members);

        // the user will have an expiration while service is skipped

        zmsImpl.updateRoleMemberUserAuthorityExpiry(role, "unit-test");
        assertNotNull(role.getRoleMembers().get(0).getExpiration());
        assertNull(role.getRoleMembers().get(1).getExpiration());

        // now let's have only user members

        members = new ArrayList<>();
        members.add(new RoleMember().setMemberName("user.john").setPrincipalType(Principal.Type.USER.getValue()));
        members.add(new RoleMember().setMemberName("user.jane").setPrincipalType(Principal.Type.USER.getValue()));
        role.setRoleMembers(members);

        zmsImpl.updateRoleMemberUserAuthorityExpiry(role, "unit-test");
        assertNotNull(role.getRoleMembers().get(0).getExpiration());
        assertNotNull(role.getRoleMembers().get(1).getExpiration());

        zmsImpl.userAuthority = savedAuthority;
    }

    @Test
    public void testValidateRoleUserAuthorityAttributes() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = null;

        // with authority null we always get exceptions if we have
        // not empty values specified

        zmsImpl.validateUserAuthorityAttributes(null, null, "unit-test");
        zmsImpl.validateUserAuthorityAttributes(null, "", "unit-test");
        zmsImpl.validateUserAuthorityAttributes("", null, "unit-test");
        zmsImpl.validateUserAuthorityAttributes("", "", "unit-test");

        try {
            zmsImpl.validateUserAuthorityAttributes("attr1", null, "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("User Authority filter specified without a valid user authority"));
        }

        try {
            zmsImpl.validateUserAuthorityAttributes(null, "attr1", "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("User Authority expiry specified without a valid user authority"));
        }

        Authority authority = Mockito.mock(Authority.class);
        Set<String> booleanAttrSet = new HashSet<>();
        booleanAttrSet.add("elevated-clearance");
        booleanAttrSet.add("full-time-employee");
        when(authority.booleanAttributesSupported()).thenReturn(booleanAttrSet);
        Set<String> dateAttrSet = new HashSet<>();
        dateAttrSet.add("term-date");
        when(authority.dateAttributesSupported()).thenReturn(dateAttrSet);
        zmsImpl.userAuthority = authority;

        // valid values

        zmsImpl.validateUserAuthorityAttributes("elevated-clearance", null, "unit-test");
        zmsImpl.validateUserAuthorityAttributes("elevated-clearance", "", "unit-test");
        zmsImpl.validateUserAuthorityAttributes("elevated-clearance,full-time-employee", null, "unit-test");
        zmsImpl.validateUserAuthorityAttributes("full-time-employee,elevated-clearance", "term-date", "unit-test");
        zmsImpl.validateUserAuthorityAttributes("", "term-date", "unit-test");
        zmsImpl.validateUserAuthorityAttributes(null, "term-date", "unit-test");

        zmsImpl.validateUserAuthorityAttributes(null, null, "unit-test");
        zmsImpl.validateUserAuthorityAttributes(null, "", "unit-test");
        zmsImpl.validateUserAuthorityAttributes("", null, "unit-test");
        zmsImpl.validateUserAuthorityAttributes("", "", "unit-test");

        // invalid values

        try {
            zmsImpl.validateUserAuthorityAttributes("elevated-clearance,contractor", null, "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("contractor is not a valid user authority attribute"));
        }

        try {
            zmsImpl.validateUserAuthorityAttributes("elevated-clearance", "hire-date", "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("hire-date is not a valid user authority date attribute"));
        }

        zmsImpl.userAuthority = savedAuthority;
    }

    @Test
    public void testSetRoleMemberExpiration() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = null;

        // with authority null we always get no changes

        Authority authority = Mockito.mock(Authority.class);
        Date testDate = new Date();
        when(authority.getDateAttribute("user.john", "elevated-clearance"))
                .thenReturn(testDate);
        when(authority.getDateAttribute("user.jane", "elevated-clearance"))
                .thenReturn(testDate);
        when(authority.getDateAttribute("user.joe", "elevated-clearance"))
                .thenReturn(null);
        Set<String> dateAttrSet = new HashSet<>();
        dateAttrSet.add("elevated-clearance");
        when(authority.dateAttributesSupported()).thenReturn(dateAttrSet);

        zmsImpl.userAuthority = authority;

        // add a role with an elevated clearance option

        final String domainName = "userexpirydomain";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        final String roleName = "audit-role";
        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, null);
        role.setUserAuthorityExpiration("elevated-clearance");
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);

        // add a valid member who should get the expiry date

        Membership mbr = new Membership().setMemberName("user.john");
        zmsImpl.putMembership(ctx, domainName, roleName, "user.john", auditRef, false, null, mbr);

        Membership mbrResult = zmsImpl.getMembership(ctx, domainName, roleName, "user.john", null);
        assertNotNull(mbrResult);
        assertEquals(mbrResult.getMemberName(), "user.john");
        assertNotNull(mbrResult.getExpiration());
        assertEquals(mbrResult.getExpiration().millis(), testDate.getTime());

        // user with no expiry

        mbr = new Membership().setMemberName("user.joe");
        try {
            zmsImpl.putMembership(ctx, domainName, roleName, "user.joe", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("User does not have required user authority expiry configured"));
        }

        // service user should be added ok since service user is not processed
        // by user authority

        mbr = new Membership().setMemberName("userexpirydomain.api");
        zmsImpl.putMembership(ctx, domainName, roleName, "userexpirydomain.api", auditRef, false, null, mbr);
        mbrResult = zmsImpl.getMembership(ctx, domainName, roleName, "userexpirydomain.api", null);
        assertNotNull(mbrResult);

        // add a role with group expiry days set

        Group group1 = zmsTestInitializer.createGroupObject(domainName, "group1", null);
        zmsImpl.putGroup(ctx, domainName, "group1", auditRef, false, null, group1);
        final int groupExpiryDays = 10;
        final String roleName1 = "role-group-member-expiry";
        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName1, null, null);
        role1.setGroupExpiryDays(groupExpiryDays);
        zmsImpl.putRole(ctx, domainName, roleName1, auditRef, false, null, role1);

        Membership mbr1 = new Membership().setMemberName(group1.name);
        zmsImpl.putMembership(ctx, domainName, roleName1, group1.name, auditRef, false, null, mbr1);

        mbrResult = zmsImpl.getMembership(ctx, domainName, roleName1, group1.name, null);
        long days = ((mbrResult.getExpiration().millis() - testDate.getTime()) / (60*60*24*1000));
        assertNotNull(mbrResult);
        assertEquals(mbrResult.getMemberName(), group1.name);
        assertNotNull(mbrResult.getExpiration());
        assertEquals(days, groupExpiryDays);

        RoleMeta rm = new RoleMeta().setGroupExpiryDays(1);
        zmsImpl.putRoleMeta(ctx, domainName, roleName1, auditRef, null, rm);
        mbrResult = zmsImpl.getMembership(ctx, domainName, roleName1, group1.name, null);
        days = ((mbrResult.getExpiration().millis() - testDate.getTime()) / (60*60*24*1000));
        assertNotNull(mbrResult);
        assertEquals(mbrResult.getMemberName(), group1.name);
        assertNotNull(mbrResult.getExpiration());
        assertEquals(days, 1);

        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testSetGroupMemberExpiration() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = null;

        // with authority null we always get no changes

        Authority authority = Mockito.mock(Authority.class);
        Date testDate = new Date();
        when(authority.getDateAttribute("user.john2", "elevated-clearance"))
                .thenReturn(testDate);
        when(authority.getDateAttribute("user.jane2", "elevated-clearance"))
                .thenReturn(testDate);
        when(authority.getDateAttribute("user.joe2", "elevated-clearance"))
                .thenReturn(null);
        when(authority.isValidUser(anyString()))
                .thenReturn(true);
        Set<String> dateAttrSet = new HashSet<>();
        dateAttrSet.add("elevated-clearance");
        when(authority.dateAttributesSupported()).thenReturn(dateAttrSet);

        zmsImpl.userAuthority = authority;

        // add a group with an elevated clearance option

        final String domainName = "userexpirydomain";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain2", "testOrg2", "user.user2");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        final String groupName = "audit-group2";
        Group group = zmsTestInitializer.createGroupObject(domainName, groupName, null);
        group.setUserAuthorityExpiration("elevated-clearance");
        group.setSelfServe(true);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group);

        // add a valid member who should get the expiry date

        GroupMembership mbr = new GroupMembership().setMemberName("user.john2");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.john2", auditRef, false, null, mbr);

        GroupMembership mbrResult = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.john2", null);
        assertNotNull(mbrResult);
        assertEquals(mbrResult.getMemberName(), "user.john2");
        assertNotNull(mbrResult.getExpiration());
        assertEquals(mbrResult.getExpiration().millis(), testDate.getTime());

        // user with no expiry

        mbr = new GroupMembership().setMemberName("user.joe2");
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.joe2", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("User does not have required user authority expiry configured"));
        }

        // First add service
        ServiceIdentity serviceIdentity = new ServiceIdentity().setName("userexpirydomain.api");
        zmsImpl.putServiceIdentity(ctx, domainName, "api", auditRef, false, null, serviceIdentity);

        // service user should be added ok since service user is not processed
        // by user authority

        mbr = new GroupMembership().setMemberName("userexpirydomain.api");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "userexpirydomain.api", auditRef, false, null, mbr);
        mbrResult = zmsImpl.getGroupMembership(ctx, domainName, groupName, "userexpirydomain.api", null);
        assertNotNull(mbrResult);

        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testSetGroupMemberExpirationGroupRejected() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        GroupMember groupMember = new GroupMember().setMemberName("dev-group")
                .setPrincipalType(Principal.Type.GROUP.getValue());
        try {
            zmsImpl.setGroupMemberExpiration(null, null, groupMember, null, "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
            assertTrue(ex.getMessage().contains("Group member can't be of type group"));
        }
    }

    @DataProvider(name = "delegatedRoles")
    public static Object[][] getDelegatedRoles() {
        String domainName = "test_domain";

        Role role1 = new Role();
        String memberName = "member";
        RoleMember roleMember = new RoleMember().setMemberName(memberName);

        Role role2 = new Role();
        role2.setMembers(Collections.singletonList(memberName));
        role2.setRoleMembers(Collections.singletonList(roleMember));

        Role role3 = new Role();
        role3.setRoleMembers(Collections.singletonList(roleMember));

        Role role4 = new Role();
        role4.setRoleMembers(Collections.singletonList(roleMember));
        role4.setTrust("trust");

        Role role5 = new Role();
        role5.setMembers(Collections.singletonList(memberName));
        role5.setTrust("trust");

        Role role6 = new Role();
        role6.setTrust("trust");

        Role role7 = new Role();
        role7.setTrust("trust-notfound");

        return new Object[][] {
                {domainName, role1, false},
                {domainName, role2, true},
                {domainName, role3, false},
                {domainName, role4, true},
                {domainName, role5, true},
                {"trust", role6, true},
                {"test_domain", role6, false},
                {"test_domain", role7, true}
        };
    }

    @Test(dataProvider = "delegatedRoles")
    public void testValidateRoleStructure(String domainName, Role role, boolean expectedFailure) {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String trustDomainName = "trust";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(trustDomainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        try {
            zmsImpl.validateRoleStructure(role, domainName, "unittest");
            if (expectedFailure) {
                fail();
            }
        } catch (ResourceException e) {
            if (expectedFailure) {
                assertEquals(e.getCode(), 400);
            } else {
                fail("should not have failed with ResourceException");
            }
        }

        zmsImpl.deleteTopLevelDomain(ctx, trustDomainName, auditRef, null);
    }

    @Test
    public void testRecordMetricsUnauthenticated() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        ZMSImpl.metric = Mockito.mock(Metric.class);
        RsrcCtxWrapper ctx = (RsrcCtxWrapper) zmsImpl.newResourceContext(null, zmsTestInitializer.getMockServletRequest(), zmsTestInitializer.getMockServletResponse(), "someApiMethod");
        String testDomain = "testDomain";
        int httpStatus = 200;
        ctx.setRequestDomain(testDomain);
        zmsImpl.recordMetrics(ctx, httpStatus);
        verify(ZMSImpl.metric,
                times(1)).increment (
                eq("zms_api"),
                eq(testDomain),
                eq(null),
                eq("GET"),
                eq(httpStatus),
                eq("someapimethod"));
        verify(ZMSImpl.metric,
                times(1)).stopTiming (
                eq(ctx.getTimerMetric()),
                eq(testDomain),
                eq(null),
                eq("GET"),
                eq(httpStatus),
                eq("someapimethod_timing"));
        verify(ZMSImpl.metric,
                times(1)).startTiming (
                eq("zms_api_latency"),
                eq(null),
                eq(null),
                eq("GET"),
                eq("someapimethod"));
    }

    @Test
    public void testRecordMetricsAuthenticated() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        ZMSImpl.metric = Mockito.mock(Metric.class);
        String testDomain = "testDomain";
        int httpStatus = 200;
        when(ctx.getRequestDomain()).thenReturn(testDomain);
        zmsImpl.recordMetrics(ctx, httpStatus);
        verify(ZMSImpl.metric,
                times(1)).increment (
                eq("zms_api"),
                eq(testDomain),
                eq("user"),
                eq("GET"),
                eq(httpStatus),
                eq("someApiMethod"));
        verify(ZMSImpl.metric,
                times(1)).stopTiming (
                eq(ctx.getTimerMetric()),
                eq(testDomain),
                eq("user"),
                eq("GET"), eq(httpStatus), eq("someApiMethod_timing"));
    }

    @Test
    public void testRecordMetricsNoCtx() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        int httpStatus = 200;
        ZMSImpl.metric = Mockito.mock(Metric.class);
        zmsImpl.recordMetrics(null, httpStatus);
        verify(ZMSImpl.metric,
                times(1)).increment (
                eq("zms_api"),
                eq(null),
                eq(null),
                eq(null),
                eq(httpStatus),
                eq(null));
        verify(ZMSImpl.metric,
                times(1)).stopTiming (
                eq(null),
                eq(null),
                eq(null),
                eq(null),
                eq(httpStatus),
                eq(null));
    }

    @Test
    public void testGetGroupWithAttributes() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-domain-group1";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, "group1", "user.joe", "user.jane");
        group1.setSelfServe(true);
        group1.setMemberExpiryDays(30);
        group1.setServiceExpiryDays(35);
        zmsImpl.putGroup(ctx, domainName, "group1", auditRef, false, null, group1);

        Group group1a = zmsImpl.getGroup(ctx, domainName, "group1", false, false);
        assertNotNull(group1a);

        assertEquals(group1a.getName(), domainName + ":group.group1");
        List<GroupMember> members = group1a.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);

        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        zmsTestInitializer.checkGroupMember(checkList, members);
        assertTrue(group1a.getSelfServe());
        assertEquals(group1a.getMemberExpiryDays(), Integer.valueOf(30));
        assertEquals(group1a.getServiceExpiryDays(), Integer.valueOf(35));
        // get unknown group

        try {
            zmsImpl.getGroup(ctx, domainName, "uknown-group", false, false);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreateGroup() {

        final String domainName = "create-group";
        final String groupName = "group1";

        TestAuditLogger alogger = new TestAuditLogger();
        List<String> aLogMsgs = alogger.getLogMsgList();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        when(ctx.getApiName()).thenReturn("posttopleveldomain").thenReturn("putgroup");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Group group1a = zmsImpl.getGroup(ctx, domainName, groupName, true, false);
        assertNotNull(group1a);
        assertNotNull(group1a.getAuditLog());
        assertEquals(group1a.getAuditLog().size(), 2);
        assertEquals(group1a.getName(), domainName + ":group." + groupName);
        assertNull(group1a.getAuditEnabled());
        assertNull(group1a.getReviewEnabled());

        // check audit log msg for putgroup
        boolean foundError = false;
        System.err.println("testCreateGroup: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putgroup)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("\"name\": \"" + groupName + "\",");
            assertTrue(index2 > index, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // delete member of the group
        //
        List<GroupMember> listrm = group1.getGroupMembers();
        for (GroupMember rmemb: listrm) {
            if (rmemb.getMemberName().equals("user.jane")) {
                listrm.remove(rmemb);
                break;
            }
        }

        aLogMsgs.clear();
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        foundError = false;
        System.err.println("testCreateGroup: Now Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putgroup)")) {
                continue;
            }
            assertTrue(msg.contains("CLIENT-IP=(" + ZMSTestInitializer.MOCKCLIENTADDR + ")"), msg);
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("{\"name\": \"group1\", \"selfServe\": \"false\", \"memberExpiryDays\": \"null\", "
                    + "\"serviceExpiryDays\": \"null\", \"reviewEnabled\": \"false\", \"notifyRoles\": \"null\", "
                    + "\"userAuthorityFilter\": \"null\", \"userAuthorityExpiration\": \"null\", "
                    + "\"deleteProtection\": \"false\", \"lastReviewedDate\": \"null\", \"maxMembers\": \"null\", "
                    + "\"selfRenew\": \"null\", \"selfRenewMins\": \"null\", "
                    + "\"deleted-members\": [{\"member\": \"user.jane\", \"approved\": true, \"system-disabled\": 0}], "
                    + "\"added-members\": []}");
            assertTrue(index2 > index, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreateGroupDBFailure() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "create-group-db-failure";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // put the db in read-only mode

        zmsTestInitializer.setDatabaseReadOnlyMode(true);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, "group1", "user.joe", "user.jane");
        try {
            zmsImpl.putGroup(ctx, domainName, "group1", auditRef, false, null, group1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.GONE);
        }

        // remove read-only mode

        zmsTestInitializer.setDatabaseReadOnlyMode(false);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreateGroupInvalidMembers() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "create-group-invalid-member-failure";
        final String groupName = "dev-team";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // add group members with another group as member

        Group group2 = zmsTestInitializer.createGroupObject(domainName, "group2", "user.joe", domainName  + ":group.dev-team");
        try {
            zmsImpl.putGroup(ctx, domainName, "group2", auditRef, false, null, group2);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // add group with invalid service names

        group2 = zmsTestInitializer.createGroupObject(domainName, "group2", "user.joe", domainName  + ".api");
        try {
            zmsImpl.putGroup(ctx, domainName, "group2", auditRef, false, null, group2);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // now create the service and retry the operation again

        ServiceIdentity service = zmsTestInitializer.createServiceObject(domainName, "api", "http://localhost", "/usr/bin/java",
                "root", "users", "host1");
        zmsImpl.putServiceIdentity(ctx, domainName, "api", auditRef, false, null, service);

        zmsImpl.putGroup(ctx, domainName, "group2", auditRef, false, null, group2);

        // now try to add a wildcard which should be rejected

        Group group3 = zmsTestInitializer.createGroupObject(domainName, "group3", "user.joe", "*");
        try {
            zmsImpl.putGroup(ctx, domainName, "group3", auditRef, false, null, group3);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // wildcard with service name

        group3 = zmsTestInitializer.createGroupObject(domainName, "group3", "user.joe", domainName + ".api*");
        try {
            zmsImpl.putGroup(ctx, domainName, "group3", auditRef, false, null, group3);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testCreateDuplicateMemberGroup() {

        final String domainName = "dup-member-group";
        final String groupName = "group1";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.joe");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        assertEquals(group.getName(), domainName + ":group.group1".toLowerCase());
        List<GroupMember> members = group.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);
        assertEquals("user.joe", members.get(0).getMemberName());

        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testPutGroupInvalidAuditEnabledState() {

        ZMSImpl zms = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        final String domainName1 = "group-audit-test-cases1";
        final String domainName2 = "group-audit-test-cases2";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setAuditEnabled(false);
        zms.postTopLevelDomain(ctx, auditRef, null, dom1);

        // group without the audit enabled flag will be added successfully

        Group group11 = zmsTestInitializer.createGroupObject(domainName1, "group11",
                "user.joe", "user.jane");
        zms.putGroup(ctx, domainName1, "group11", auditRef, false, null, group11);

        // group with the audit enabled flag will be rejected

        Group group12 = zmsTestInitializer.createGroupObject(domainName1, "group12",
                "user.joe", "user.jane");
        group12.setAuditEnabled(true);
        try {
            zms.putGroup(ctx, domainName1, "group12", auditRef, false, null, group12);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Group cannot be set as audit-enabled if the domain is not audit-enabled"));
        }

        // now add a domain with the audit flag enabled

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2,
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        dom2.setAuditEnabled(true);
        zms.postTopLevelDomain(ctx, auditRef, null, dom2);

        // group without the audit enabled flag will be added successfully

        Group group21 = zmsTestInitializer.createGroupObject(domainName2, "group21",
                "user.joe", "user.jane");
        zms.putGroup(ctx, domainName2, "group21", auditRef, false, null, group21);

        // group with the audit enabled flag and no members will be added successfully

        Group group22 = zmsTestInitializer.createGroupObject(domainName2, "group22", null, null);
        group22.setAuditEnabled(true);
        zms.putGroup(ctx, domainName2, "group22", auditRef, false, null, group22);

        // group with audit enabled flag and members will be rejected

        Group group23 = zmsTestInitializer.createGroupObject(domainName2, "group23",
                "user.joe", "user.jane");
        group23.setAuditEnabled(true);
        try {
            zms.putGroup(ctx, domainName2, "group23", auditRef, false, null, group23);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Only system admins can set the group as audit-enabled if it has members"));
        }

        zms.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
        zms.deleteTopLevelDomain(ctx, domainName2, auditRef, null);
    }

    @Test
    public void testPutGroupUpdate() {

        final String domainName = "update-group";
        final String groupName = "group1";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.joe");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        assertEquals(group.getName(), domainName + ":group.group1".toLowerCase());
        List<GroupMember> members = group.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);
        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.john");
        zmsTestInitializer.checkGroupMember(checkList, members);

        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testPutGroupExceptions() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-exc";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // inconsistent group name

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        try {
            zmsImpl.putGroup(ctx, domainName, "different-group", auditRef, false, null, group1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // unknown domain

        try {
            group1 = zmsTestInitializer.createGroupObject("unknown-domain", groupName, "user.joe", "user.jane");
            zmsImpl.putGroup(ctx, "unknown-domain", groupName, auditRef, false, null, group1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        // review enabled with members

        group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        group1.setReviewEnabled(true);
        try {
            zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testCreateNormalizedUserMemberGroup() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final  String domainName = "norm-user-member-group";
        final String groupName = "group1";
        final String groupName2 = "group2";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ArrayList<GroupMember> groupMembers = new ArrayList<>();
        groupMembers.add(new GroupMember().setMemberName("user.joe"));
        groupMembers.add(new GroupMember().setMemberName("user.joe"));
        groupMembers.add(new GroupMember().setMemberName("user.joe"));
        groupMembers.add(new GroupMember().setMemberName("user.jane"));

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, groupMembers);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        assertEquals(group.getName(), domainName + ":group.group1".toLowerCase());
        List<GroupMember> members = group.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);
        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        zmsTestInitializer.checkGroupMember(checkList, members);

        // create a group with no members

        Group group2 = zmsTestInitializer.createGroupObject(domainName, groupName2, null);
        zmsImpl.putGroup(ctx, domainName, groupName2, auditRef, false, null, group2);

        group = zmsImpl.getGroup(ctx, domainName, groupName2, false, false);
        assertNotNull(group);
        assertTrue(group.getGroupMembers().isEmpty());

        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testCreateNormalizedServiceMemberGroup() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "norm-svc-member-group";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("coretech", "storage",
                "http://localhost", "/usr/bin/java", "root", "users", "host1");
        zmsImpl.putServiceIdentity(ctx, "coretech", "storage", auditRef, false, null, service);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        SubDomain subDom3 = zmsTestInitializer.createSubDomainObject("user1", "user",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postSubDomain(ctx, "user", auditRef, null, subDom3);

        SubDomain subDom4 = zmsTestInitializer.createSubDomainObject("dom1", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, subDom4);

        service = zmsTestInitializer.createServiceObject("user.user1.dom1", "api",
                "http://localhost", "/usr/bin/java", "root", "users", "host1");
        zmsImpl.putServiceIdentity(ctx, "user.user1.dom1", "api", auditRef, false, null, service);

        ArrayList<GroupMember> groupMembers = new ArrayList<>();
        groupMembers.add(new GroupMember().setMemberName("coretech.storage"));
        groupMembers.add(new GroupMember().setMemberName("coretech.storage"));
        groupMembers.add(new GroupMember().setMemberName("user.user1.dom1.api"));

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, groupMembers);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        assertEquals(group.getName(), domainName + ":group.Group1".toLowerCase());
        List<GroupMember> members = group.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);
        List<String> checkList = new ArrayList<>();
        checkList.add("coretech.storage");
        checkList.add("user.user1.dom1.api");
        zmsTestInitializer.checkGroupMember(checkList, members);

        zmsImpl.deleteSubDomain(ctx, "user.user1", "dom1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testUpdateGroup() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "update-group";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ArrayList<GroupMember> groupMembers = new ArrayList<>();
        groupMembers.add(new GroupMember().setMemberName("user.user1"));
        groupMembers.add(new GroupMember().setMemberName("user.user2"));
        groupMembers.add(new GroupMember().setMemberName("user.user3"));

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, groupMembers);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // now let's update our group with new members

        groupMembers = new ArrayList<>();
        groupMembers.add(new GroupMember().setMemberName("user.user3"));
        groupMembers.add(new GroupMember().setMemberName("user.user4"));
        groupMembers.add(new GroupMember().setMemberName("user.user5"));

        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // now let's get the group and verify our update

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        assertEquals(group.getName(), domainName + ":group.Group1".toLowerCase());
        List<GroupMember> members = group.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 3);
        List<String> checkList = new ArrayList<>();
        checkList.add("user.user3");
        checkList.add("user.user4");
        checkList.add("user.user5");
        zmsTestInitializer.checkGroupMember(checkList, members);

        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testUpdateReviewEnabledRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "update-review-group";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, null);
        group1.setReviewEnabled(true);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // now let's update our group with new members

        group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.user1", "user.user2");
        try {
            zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("reviewEnabled groups"));
        }

        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testCreateNormalizedCombinedMemberGroup() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "norm-combined-member-group";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("coretech", "storage",
                "http://localhost", "/usr/bin/java", "root", "users", "host1");
        zmsImpl.putServiceIdentity(ctx, "coretech", "storage", auditRef, false, null, service);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        SubDomain subDom3 = zmsTestInitializer.createSubDomainObject("user1", "user",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postSubDomain(ctx, "user", auditRef, null, subDom3);

        SubDomain subDom4 = zmsTestInitializer.createSubDomainObject("dom1", "user.user1",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "user.user1", auditRef, null, subDom4);

        service = zmsTestInitializer.createServiceObject("user.user1.dom1", "api",
                "http://localhost", "/usr/bin/java", "root", "users", "host1");
        zmsImpl.putServiceIdentity(ctx, "user.user1.dom1", "api", auditRef, false, null, service);

        ArrayList<GroupMember> groupMembers = new ArrayList<>();
        groupMembers.add(new GroupMember().setMemberName("user.joe"));
        groupMembers.add(new GroupMember().setMemberName("user.joe"));
        groupMembers.add(new GroupMember().setMemberName("user.joe"));
        groupMembers.add(new GroupMember().setMemberName("user.jane"));
        groupMembers.add(new GroupMember().setMemberName("coretech.storage"));
        groupMembers.add(new GroupMember().setMemberName("coretech.storage"));
        groupMembers.add(new GroupMember().setMemberName("user.user1.dom1.api"));

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, groupMembers);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        assertEquals(group.getName(), domainName + ":group.group1".toLowerCase());
        List<GroupMember> members = group.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 4);
        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        checkList.add("coretech.storage");
        checkList.add("user.user1.dom1.api");
        zmsTestInitializer.checkGroupMember(checkList, members);

        zmsImpl.deleteSubDomain(ctx, "user.user1", "dom1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "user", "user1", auditRef, null);
        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testDeleteGroup() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName1 = "delete-group1";
        final String domainName2 = "delete-group2";
        final String groupName1 = "group1";
        final String groupName2 = "group2";
        final String roleName1 = "role1";
        final String roleName2 = "role2";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2, "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        Group group1 = zmsTestInitializer.createGroupObject(domainName1, groupName1, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName1, groupName1, auditRef, false, null, group1);

        Group group2 = zmsTestInitializer.createGroupObject(domainName1, groupName2, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName1, groupName2, auditRef, false, null, group2);

        // add group2 as a member to roles in 2 different domains

        Role role1 = zmsTestInitializer.createRoleObject(domainName1, roleName1, null, "user.john",
                ResourceUtils.groupResourceName(domainName1, groupName2));
        zmsImpl.putRole(ctx, domainName1, roleName1, auditRef, false, null, role1);

        Role role2 = zmsTestInitializer.createRoleObject(domainName2, roleName2, null, "user.john",
                ResourceUtils.groupResourceName(domainName1, groupName2));
        zmsImpl.putRole(ctx, domainName2, roleName2, auditRef, false, null, role2);

        Groups groupList = zmsImpl.getGroups(ctx, domainName1, false, null, null);
        assertNotNull(groupList);

        assertEquals(groupList.getList().size(), 2);

        // now delete group 1 which should be good since it's not part
        // of any roles

        zmsImpl.deleteGroup(ctx, domainName1, groupName1, auditRef, null);

        groupList = zmsImpl.getGroups(ctx, domainName1, false, null, null);

        assertNotNull(groupList);

        assertEquals(groupList.getList().size(), 1);
        assertEquals(groupList.getList().get(0).getName(), domainName1 + ":group.group2");

        // now delete group2 which should be rejected since it's
        // included in 2 roles

        try {
            zmsImpl.deleteGroup(ctx, domainName1, groupName2, auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains(ResourceUtils.roleResourceName(domainName1, roleName1)));
            assertTrue(ex.getMessage().contains(ResourceUtils.roleResourceName(domainName2, roleName2)));
        }

        // delete one of the roles

        zmsImpl.deleteRole(ctx, domainName1, roleName1, auditRef, null);

        // we should still fail since it's still included in one other role

        try {
            zmsImpl.deleteGroup(ctx, domainName1, groupName2, auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertFalse(ex.getMessage().contains(ResourceUtils.roleResourceName(domainName1, roleName1)));
            assertTrue(ex.getMessage().contains(ResourceUtils.roleResourceName(domainName2, roleName2)));
        }

        // delete the second role and now we should be able to delete the group

        zmsImpl.deleteRole(ctx, domainName2, roleName2, auditRef, null);
        zmsImpl.deleteGroup(ctx, domainName1, groupName2, auditRef, null);

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName2, auditRef, null);
    }

    @Test
    public void testGetGroups() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-groups";
        final String groupName1 = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName1, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName1, auditRef, false, null, group1);

        Groups groupList = zmsImpl.getGroups(ctx, domainName, true, null, null);

        assertNotNull(groupList);

        assertEquals(groupList.getList().size(), 1);

        Group group = groupList.list.get(0);
        assertEquals(group.getName(), domainName + ":group.group1");
        assertEquals(group.getGroupMembers().size(), 2);
        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        zmsTestInitializer.checkGroupMember(checkList, group.getGroupMembers());

        // get groups on unknown domain

        try {
            zmsImpl.getGroups(ctx, "unknown-domain", true, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteGroupMissingAuditRef() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "delete-group-missing-ref";
        final String groupName = "group1";

        TopLevelDomain dom = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        dom.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom);

        Group group = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group);

        try {
            zmsImpl.deleteGroup(ctx, domainName, groupName, null, null);
            fail("requesterror not thrown by deleteGroup.");
        } catch (ResourceException ex) {
            assertEquals(400, ex.getCode());
            assertTrue(ex.getMessage().contains("Audit reference required"));
        } finally {
            zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        }
    }

    @Test
    public void testDeleteGroupThrowException() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        final String domainName = "DomainName1";
        final String groupName = "GroupName1";
        try {
            zmsImpl.deleteGroup(ctx,domainName, groupName, auditRef, null);
            fail("notfounderror not thrown.");
        } catch (ResourceException e) {
            assertEquals(e.getCode(), 404);
        }
    }

    @Test
    public void testConvertToLowerGroupMember() {

        AthenzObject.GROUP_MEMBER.convertToLowerCase(null);

        List<GroupMember> list = new ArrayList<>();
        list.add(new GroupMember().setGroupName("GroupA").setMemberName("MemberA").setDomainName("Domain"));
        AthenzObject.GROUP_MEMBER.convertToLowerCase(list);

        GroupMember member = list.get(0);
        assertEquals(member.getMemberName(), "membera");
        assertEquals(member.getGroupName(), "groupa");
        assertEquals(member.getDomainName(), "domain");

        list = new ArrayList<>();
        list.add(new GroupMember().setGroupName("GroupA").setDomainName("Domain"));
        AthenzObject.GROUP_MEMBER.convertToLowerCase(list);

        member = list.get(0);
        assertNull(member.getMemberName());
        assertEquals(member.getGroupName(), "groupa");
        assertEquals(member.getDomainName(), "domain");
    }

    @Test
    public void testConvertToLowerGroupMembership() {

        GroupMembership member = new GroupMembership().setGroupName("GroupA").setMemberName("MemberA");
        AthenzObject.GROUP_MEMBERSHIP.convertToLowerCase(member);

        assertEquals(member.getMemberName(), "membera");
        assertEquals(member.getGroupName(), "groupa");

        member = new GroupMembership().setMemberName("MemberA");
        AthenzObject.GROUP_MEMBERSHIP.convertToLowerCase(member);

        assertEquals(member.getMemberName(), "membera");
        assertNull(member.getGroupName());
    }

    @Test
    public void testConvertToLowerGroupMeta() {

        GroupMeta meta = new GroupMeta().setNotifyRoles("rolesA,rolesB");
        AthenzObject.GROUP_META.convertToLowerCase(meta);

        assertEquals(meta.getNotifyRoles(), "rolesa,rolesb");

        meta = new GroupMeta();
        AthenzObject.GROUP_META.convertToLowerCase(meta);

        assertNull(meta.getNotifyRoles());
    }

    @Test
    public void testIsConsistentGroupName() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Group group = new Group();

        group.setName("domain1:group.group1");
        assertTrue(zmsImpl.isConsistentGroupName("domain1", "group1", group));

        // local name behavior

        group.setName("group1");
        assertTrue(zmsImpl.isConsistentGroupName("domain1", "group1", group));
        assertEquals(group.getName(), "domain1:group.group1");

        // inconsistent behavior

        group.setName("domain1:group.group1");
        assertFalse(zmsImpl.isConsistentGroupName("domain1", "group2", group));

        group.setName("role1");
        assertFalse(zmsImpl.isConsistentGroupName("domain1", "group2", group));
    }

    @Test
    public void testNormalizeGroupMembersNull() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        Group group = new Group();
        zmsImpl.normalizeGroupMembers(group);
        assertTrue(group.getGroupMembers().isEmpty());
    }

    @Test
    public void testValidateGroupMemberPrincipals() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        // invalid users are always rejected

        List<GroupMember> groupMembers = new ArrayList<>();
        groupMembers.add(new GroupMember().setMemberName("user").setPrincipalType(Principal.Type.SERVICE.getValue()));
        groupMembers.add(new GroupMember().setMemberName("user.john").setPrincipalType(Principal.Type.USER.getValue()));
        groupMembers.add(new GroupMember().setMemberName("user.jane").setPrincipalType(Principal.Type.USER.getValue()));
        groupMembers.add(new GroupMember().setMemberName("coretech.api").setPrincipalType(Principal.Type.SERVICE.getValue()));
        groupMembers.add(new GroupMember().setMemberName("coretech.backend").setPrincipalType(Principal.Type.SERVICE.getValue()));

        Group group = new Group().setGroupMembers(groupMembers);
        try {
            zmsImpl.validateGroupMemberPrincipals(group, null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // set our user authority

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = new TestUserPrincipalAuthority();

        // include all valid principals

        groupMembers = new ArrayList<>();
        groupMembers.add(new GroupMember().setMemberName("user.joe").setPrincipalType(Principal.Type.USER.getValue()));
        groupMembers.add(new GroupMember().setMemberName("user.jane").setPrincipalType(Principal.Type.USER.getValue()));
        groupMembers.add(new GroupMember().setMemberName("sys.auth.zms").setPrincipalType(Principal.Type.SERVICE.getValue()));
        group.setGroupMembers(groupMembers);

        zmsImpl.validateGroupMemberPrincipals(group, null, "unittest");

        // add one more invalid user

        groupMembers.add(new GroupMember().setMemberName("user.john").setPrincipalType(Principal.Type.USER.getValue()));
        try {
            zmsImpl.validateGroupMemberPrincipals(group, null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.userAuthority = savedAuthority;
    }

    @Test
    public void testUpdateGroupMemberUserAuthorityExpiry() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        Group group = new Group().setUserAuthorityExpiration("elevated-clearance");

        List<GroupMember> members = new ArrayList<>();
        members.add(new GroupMember().setMemberName("user.john"));
        members.add(new GroupMember().setMemberName("user.joe"));
        group.setGroupMembers(members);

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = null;

        // with authority null we always get no changes

        zmsImpl.updateGroupMemberUserAuthorityExpiry(group, "unit-test");
        assertNull(group.getGroupMembers().get(0).getExpiration());
        assertNull(group.getGroupMembers().get(1).getExpiration());

        Authority authority = Mockito.mock(Authority.class);
        when(authority.getDateAttribute("user.john", "elevated-clearance"))
                .thenReturn(new Date());
        when(authority.getDateAttribute("user.jane", "elevated-clearance"))
                .thenReturn(new Date());
        when(authority.getDateAttribute("user.joe", "elevated-clearance"))
                .thenReturn(null);
        zmsImpl.userAuthority = authority;

        // with one valid and one invalid we should get an exception

        try {
            zmsImpl.updateGroupMemberUserAuthorityExpiry(group, "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Invalid member: user.joe"));
        }

        // let's have one valid user and one service

        members = new ArrayList<>();
        members.add(new GroupMember().setMemberName("user.john"));
        members.add(new GroupMember().setMemberName("sports.api"));
        group.setGroupMembers(members);

        // the user will have an expiration while service is skipped

        zmsImpl.updateGroupMemberUserAuthorityExpiry(group, "unit-test");
        assertNotNull(group.getGroupMembers().get(0).getExpiration());
        assertNull(group.getGroupMembers().get(1).getExpiration());

        // now let's have only user members

        members = new ArrayList<>();
        members.add(new GroupMember().setMemberName("user.john"));
        members.add(new GroupMember().setMemberName("user.jane"));
        group.setGroupMembers(members);

        zmsImpl.updateGroupMemberUserAuthorityExpiry(group, "unit-test");
        assertNotNull(group.getGroupMembers().get(0).getExpiration());
        assertNotNull(group.getGroupMembers().get(1).getExpiration());

        zmsImpl.userAuthority = savedAuthority;
    }

    @Test
    public void testGetGroupMembership() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "get-group-mbr";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // inconsistent group name

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMembership mbr = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.joe", null);
        assertNotNull(mbr);
        assertTrue(mbr.getIsMember());
        assertTrue(mbr.getApproved());
        assertEquals(mbr.getGroupName(), domainName + ":group." + groupName);
        assertEquals(mbr.getMemberName(), "user.joe");

        mbr = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.jane", null);
        assertNotNull(mbr);
        assertTrue(mbr.getIsMember());
        assertTrue(mbr.getApproved());
        assertEquals(mbr.getGroupName(), domainName + ":group." + groupName);
        assertEquals(mbr.getMemberName(), "user.jane");

        zmsImpl.deleteTopLevelDomain(ctx,domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembership() {

        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-mbr";
        final String groupName = "group1";

        when(ctx.getApiName())
                .thenReturn("putserviceidentity")
                .thenReturn("posttopleveldomain").thenReturn("posttopleveldomain") // called twice in domain api
                .thenReturn("posttopleveldomain").thenReturn("posttopleveldomain") // called twice in domain api
                .thenReturn("putserviceidentity").thenReturn("putserviceidentity").thenReturn("putserviceidentity")
                .thenReturn("putserviceidentity").thenReturn("putserviceidentity")
                .thenReturn("postsubdomain").thenReturn("postsubdomain") // called twice in domain api
                .thenReturn("putgroup").thenReturn("putgroup").thenReturn("putgroup").thenReturn("putgroup").thenReturn("putgroup") // called 5 times in group api
                .thenReturn("putgroupmembership");

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject("coretech", "Test Domain2", "testOrg",
                zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        ServiceIdentity service = zmsTestInitializer.createServiceObject("coretech", "storage",
                "http://localhost", "/usr/bin/java", "root", "users", "host1");
        zmsImpl.putServiceIdentity(ctx, "coretech", "storage", auditRef, false, null, service);

        SubDomain subDom2 = zmsTestInitializer.createSubDomainObject("storage", "coretech", "Test Domain2",
                "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(ctx, "coretech", auditRef, null, subDom2);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMembership mbr = zmsTestInitializer.generateGroupMembership(groupName, "user.doe");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, mbr);

        // check audit log msg for putGroup
        boolean foundError = false;
        List<String> aLogMsgs = alogger.getLogMsgList();
        System.err.println("testPutGroupMembership: Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putgroupmembership)")) {
                continue;
            }
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("{\"member\": \"user.doe\", \"approved\": true, \"system-disabled\": 0}");
            assertTrue(index2 > index, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        aLogMsgs.clear();
        mbr = zmsTestInitializer.generateGroupMembership(groupName, "coretech.storage");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "coretech.storage", auditRef, false, null, mbr);

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        List<GroupMember> members = group.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 4);

        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        checkList.add("user.doe");
        checkList.add("coretech.storage");
        zmsTestInitializer.checkGroupMember(checkList, members);

        foundError = false;
        System.err.println("testGroupPutMembership: now Number of lines: " + aLogMsgs.size());
        for (String msg: aLogMsgs) {
            if (!msg.contains("WHAT-api=(putgroupmembership)")) {
                continue;
            }
            int index = msg.indexOf("WHAT-details=(");
            assertTrue(index != -1, msg);
            int index2 = msg.indexOf("{\"member\": \"coretech.storage\", \"approved\": true, \"system-disabled\": 0}");
            assertTrue(index2 > index, msg);
            foundError = true;
            break;
        }
        assertTrue(foundError);

        // enable user validation for the test

        zmsImpl.userAuthority = new TestUserPrincipalAuthority();
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true);
        zmsImpl.validateUserRoleMembers = dynamicConfigBoolean;

        // valid users no exception

        mbr = zmsTestInitializer.generateGroupMembership(groupName, "user.joe");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.joe", auditRef, false, null, mbr);

        // invalid user with exception

        mbr = zmsTestInitializer.generateGroupMembership("group1", "user.john");
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.john", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.deleteSubDomain(ctx, "coretech", "storage", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "coretech", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipRespone() {

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        final String auditRef = zmsTestInitializer.getAuditRef();
        String domainName = "mgradddom1";
        String groupName = "group";
        String groupFullName = domainName + ":group." + groupName;
        String memberName = "user.doe";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);


        Group group = zmsTestInitializer.createGroupObject(domainName, groupName,
                "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group);

        // add member to the group
        GroupMembership member = new GroupMembership().setMemberName(memberName);
        Response returnedMember = zmsImpl.putGroupMembership(ctx, domainName, groupName, memberName, auditRef, true, null, member);

        // check the response - the member should be approved
        assertTrue(returnedMember.getEntity() instanceof GroupMembership);
        GroupMembership gm = (GroupMembership)returnedMember.getEntity();
        assertEquals(gm.getGroupName(), groupFullName);
        assertEquals(gm.getMemberName(), memberName);
        assertTrue(gm.getApproved());

        // make the group review enabled
        GroupMeta meta = new GroupMeta()
                .setReviewEnabled(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, meta);

        // add the same member to the group, now it should be added as a pending member
        returnedMember = zmsImpl.putGroupMembership(ctx, domainName, groupName, memberName, auditRef, true, null, member);

        // check the response - the member should be not approved
        assertTrue(returnedMember.getEntity() instanceof GroupMembership);
        gm = (GroupMembership)returnedMember.getEntity();
        assertEquals(gm.getGroupName(), groupFullName);
        assertEquals(gm.getMemberName(), memberName);
        assertFalse(gm.getApproved());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipWithElevatedClearance() {

        final String domainName = "put-group-mbr-expiry";
        final String groupName = "group1";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Date joeDate = new Date();
        Date janeDate = new Date();
        Date bobDate = new Date();

        Set<String> attrSet = new HashSet<>();
        attrSet.add("ElevatedClearance");

        Authority mockAuthority = Mockito.mock(Authority.class);

        when(mockAuthority.isValidUser(anyString())).thenReturn(true);
        when(mockAuthority.getDateAttribute("user.joe", "ElevatedClearance")).thenReturn(joeDate);
        when(mockAuthority.getDateAttribute("user.jane", "ElevatedClearance")).thenReturn(janeDate);
        when(mockAuthority.getDateAttribute("user.bob", "ElevatedClearance")).thenReturn(bobDate);
        when(mockAuthority.getDateAttribute("user.dave", "ElevatedClearance")).thenReturn(null);
        when(mockAuthority.dateAttributesSupported()).thenReturn(attrSet);

        Authority savedAuthority = zmsImpl.userAuthority;
        zmsImpl.userAuthority = mockAuthority;

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        group1.setUserAuthorityExpiration("ElevatedClearance");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMembership mbr = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.joe", null);
        assertNotNull(mbr);
        assertEquals(mbr.getExpiration().millis(), joeDate.getTime());

        mbr = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.jane", null);
        assertNotNull(mbr);
        assertEquals(mbr.getExpiration().millis(), janeDate.getTime());

        mbr = zmsTestInitializer.generateGroupMembership(groupName, "user.bob");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);
        mbr = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.bob", null);
        assertNotNull(mbr);
        assertEquals(mbr.getExpiration().millis(), bobDate.getTime());

        mbr = zmsTestInitializer.generateGroupMembership(groupName, "user.dave");
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.dave", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
            assertTrue(ex.getMessage().contains("does not have required user authority expiry configured"));
        }

        mbr = zmsTestInitializer.generateGroupMembership(groupName, "sys.auth.zms");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "sys.auth.zms", auditRef, false, null, mbr);
        mbr = zmsImpl.getGroupMembership(ctx, domainName, groupName, "sys.auth.zms", null);
        assertNotNull(mbr);

        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipForbidden() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-mbr-403";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMembership mbr = zmsTestInitializer.generateGroupMembership(groupName, "user.doe");
        // this should be rejected since user.user1 is not domain admin
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.FORBIDDEN);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipInvalidMembers() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-mbr-400";
        final String groupName1 = "group1";
        final String groupName2 = "group2";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName1, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName1, auditRef, false, null, group1);

        Group group2 = zmsTestInitializer.createGroupObject(domainName, groupName2, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName2, auditRef, false, null, group2);

        GroupMembership mbr = zmsTestInitializer.generateGroupMembership(groupName2, ResourceUtils.groupResourceName(domainName, "group2"));
        // this should be rejected since groups are not allowed
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName2,
                    ResourceUtils.groupResourceName(domainName, "group2"), auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // services with wildcard are not allowed either

        mbr = zmsTestInitializer.generateGroupMembership(groupName2, domainName + ".*");
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName2, domainName + ".*", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipSelfServe() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-mbr-self-serve";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        group1.setSelfServe(true);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMembership mbr = zmsTestInitializer.generateGroupMembership(groupName, "user.doe");

        // since we have admin mismatch it should be added as pending
        // since self-serve flag is on

        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, mbr);

        GroupMembership mbr1 = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.doe", null);
        assertNotNull(mbr1);
        assertFalse(mbr1.getApproved());

        // now we're going to delete our pending group membership
        // this should be allowed since the user itself is the requestor

        zmsImpl.deletePendingGroupMembership(ctx, domainName, groupName, "user.doe", null);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteGroupMembershipForbidden() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "del-group-mbr-403";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        group1.setSelfServe(true);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMembership mbr = zmsTestInitializer.generateGroupMembership(groupName, "user.doe");

        // since we have admin mismatch it should be added as pending
        // since self-serve flag is on

        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, mbr);

        // first deleting an invalid domain should return 404

        try {
            zmsImpl.deletePendingGroupMembership(ctx, "unknown-domain", groupName, "user.doe", null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        // now we're going to add with a different user as admin
        // which should be rejected

        Authority auditAdminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String auditAdminUnsignedCreds = "v=U1;d=user;n=fury";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAuditAdminPrince = SimplePrincipal.create("user", "fury",
                auditAdminUnsignedCreds + ";s=signature", 0, auditAdminPrincipalAuthority);
        assertNotNull(rsrcAuditAdminPrince);
        ((SimplePrincipal) rsrcAuditAdminPrince).setUnsignedCreds(auditAdminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAuditAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAuditAdminPrince);

        try {
            zmsImpl.deletePendingGroupMembership(ctx, domainName, groupName, "user.doe", null);
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.FORBIDDEN);
        }

        //revert back to admin principal
        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipExceptions() {

        final String domainName = "put-group-mbr-ex";
        final String groupName = "group1";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // member mismatch

        GroupMembership mbr = zmsTestInitializer.generateGroupMembership(groupName, "user.doe");
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.joe", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // groupname mismatch

        try {
            zmsImpl.putGroupMembership(ctx, domainName, "invalid-group", "user.doe", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // invalid group

        mbr = zmsTestInitializer.generateGroupMembership("invalid-group", "user.doe");
        try {
            zmsImpl.putGroupMembership(ctx, domainName, "invalid-group", "user.doe", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipDecisionAuditEnabledGroupByDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "group-dec-by-domain";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);

        Group auditedGroup = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, auditedGroup);
        GroupSystemMeta rsm = createGroupSystemMetaObject(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName, "auditenabled", auditRef, rsm);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        Group resgroup = zmsImpl.getGroup(ctx, domainName, groupName, false, true);
        assertEquals(resgroup.getGroupMembers().size(), 3);
        for (GroupMember rmem : resgroup.getGroupMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertFalse(rmem.getApproved());
            }
        }

        setupPrincipalAuditedRoleApprovalByDomain(zmsImpl, "user.fury", domainName);

        mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.FORBIDDEN);
        }

        Authority auditAdminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String auditAdminUnsignedCreds = "v=U1;d=user;n=fury";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAuditAdminPrince = SimplePrincipal.create("user", "fury",
                auditAdminUnsignedCreds + ";s=signature", 0, auditAdminPrincipalAuthority);
        assertNotNull(rsrcAuditAdminPrince);
        ((SimplePrincipal) rsrcAuditAdminPrince).setUnsignedCreds(auditAdminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAuditAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAuditAdminPrince);

        zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);

        //revert back to admin principal
        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        // used with the zmsTestInitializer.getMockDomRestRsrcCtx()
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        resgroup = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertEquals(resgroup.getGroupMembers().size(), 3);
        for (GroupMember rmem : resgroup.getGroupMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertTrue(rmem.getApproved());
            }
        }

        cleanupPrincipalAuditedRoleApprovalByDomain(zmsImpl, domainName);
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipDecisionAuditEnabledGroupInvalidUser() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "group-mbr-dec-invalid";
        final String groupName = "testgroup1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);

        Group auditedGroup = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, auditedGroup);
        GroupSystemMeta rsm = createGroupSystemMetaObject(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName, "auditenabled", auditRef, rsm);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.joe");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.joe", auditRef, false, null, mbr);

        mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testOrg");

        Authority auditAdminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String auditAdminUnsignedCreds = "v=U1;d=user;n=fury";

        final Principal rsrcAuditAdminPrince = SimplePrincipal.create("user", "fury",
                auditAdminUnsignedCreds + ";s=signature", 0, auditAdminPrincipalAuthority);
        assertNotNull(rsrcAuditAdminPrince);
        ((SimplePrincipal) rsrcAuditAdminPrince).setUnsignedCreds(auditAdminUnsignedCreds);

        when(ctx.principal()).thenReturn(rsrcAuditAdminPrince);

        // enable user authority check - joe and jane are the only
        // valid users in the system

        zmsImpl.userAuthority = new TestUserPrincipalAuthority();
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true);
        zmsImpl.validateUserRoleMembers = dynamicConfigBoolean;

        // first let's approve user.joe which should be ok since user joe
        // is a valid user based on our test authority

        mbr = new GroupMembership();
        mbr.setMemberName("user.joe");
        mbr.setActive(true);
        mbr.setApproved(true);
        zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.joe", auditRef, mbr);

        // now let's approve our bob user which is going to be rejected
        // since bob is not a valid user based on our test authority

        mbr.setMemberName("user.bob");

        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);
            fail();
        }catch (ResourceException ex) {
            assertEquals(ex.code, 400);
        }

        // now let's just reject user bob which should work
        // ok because we no longer validate users when we
        // are rejecting thus deleting group members

        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);

        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipDecisionReviewEnabledUnauthorized() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "group-review-enabled-domain-forbidden";
        final String groupName = "review-group";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, null, null);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMeta rm = new GroupMeta().setReviewEnabled(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, rm);

        // add a user to the group

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);

        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        // verify the user is added with pending state

        Group resgroup = zmsImpl.getGroup(ctx, domainName, groupName, false, true);
        assertEquals(resgroup.getGroupMembers().size(), 1);
        assertEquals(resgroup.getGroupMembers().get(0).getMemberName(), "user.bob");
        assertFalse(resgroup.getGroupMembers().get(0).getApproved());

        // now try as the second admin himself to approve this user and it must
        // be rejected since second admin is not authorized

        mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        // switch to user.user2 principal to add a member to a group

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=user2";
        final Principal rsrcPrince = SimplePrincipal.create("user", "user2",
                unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcPrince);
        when(ctx.principal()).thenReturn(rsrcPrince);

        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("not authorized to approve / reject members"));
        }

        // revert back to admin principal

        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipDecisionErrors() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-dec-errors";
        final String groupName = "testgroup1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,"Approval Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testOrg",true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);

        Group auditedGroup = zmsTestInitializer.createGroupObject(domainName, groupName,"user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, auditedGroup);
        GroupSystemMeta rsm = createGroupSystemMetaObject(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName, "auditenabled", auditRef, rsm);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.chris", auditRef, mbr);//invalid member
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 400);
            assertTrue(r.getMessage().contains("putGroupMembershipDecision: Member name in URI and GroupMembership object do not match"));
        }

        mbr.setGroupName("invalidgroup");
        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);//invalid group
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 400);
            assertTrue(r.getMessage().contains("putGroupMembershipDecision: Group name in URI and GroupMembership object do not match"));
        }

        mbr.setGroupName(null);
        try {
            zmsImpl.putGroupMembershipDecision(ctx, "testdomain2", groupName, "user.bob", auditRef, mbr);//invalid domain name
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 400);
            assertTrue(r.getMessage().contains("Invalid groupname"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupSystemMetaErrors() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName1 = "put-group-sys-meta-errors1";
        final String domainName2 = "put-group-sys-meta-errors2";
        final String groupName = "testgroup1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1, "Approval Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testOrg",true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName1, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName1, "auditenabled", auditRef, meta);

        Group auditedGroup = zmsTestInitializer.createGroupObject(domainName1, groupName,"user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName1, groupName, auditRef, false, null, auditedGroup);

        // invalid field name

        GroupSystemMeta rsm = createGroupSystemMetaObject(true);
        try {
            zmsImpl.putGroupSystemMeta(ctx, domainName1, groupName, "unknown-field", auditRef, rsm);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
            assertTrue(ex.getMessage().contains("unknown group system meta attribute"));
        }

        // invalid domain name

        try {
            zmsImpl.putGroupSystemMeta(ctx, "invalid-domain", groupName, "auditenabled", auditRef, rsm);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        // domain without audit enabled flag

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2, "Approval Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        try {
            zmsImpl.putGroupSystemMeta(ctx, domainName2, groupName, "auditenabled", auditRef, rsm);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
            assertTrue(ex.getMessage().contains("auditEnabled flag not set for domain"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName2, auditRef, null);
    }

    @Test
    public void testDeleteGroupMembership() {

        final String domainName = "del-group-mbr";
        final String groupName = "group1";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);
        zmsImpl.deleteGroupMembership(ctx, domainName, groupName, "user.joe", auditRef, null);

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        List<GroupMember> members = group.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);

        boolean found = false;
        for (GroupMember member: members) {
            if (member.getMemberName().equalsIgnoreCase("user.joe")) {
                fail("delete user.joe failed");
            }
            if (member.getMemberName().equalsIgnoreCase("user.jane")) {
                found = true;
            }
        }
        if (!found) {
            fail("user.jane not found");
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteGroupMembershipInvalidGroup() {

        String domainName = "del-mbr-invalid-group";
        String groupName = "group1";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // Tests the deleteGroupMembership() condition: if (group == null)...

        try {
            Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName,
                    "user.joe", "user.jane");
            zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

            // Should fail b/c trying to find a non-existent group.

            final String wrongGroupName = "group2";
            zmsImpl.deleteGroupMembership(ctx, domainName, wrongGroupName, "user.joe", auditRef, null);
            fail("notfounderror not thrown.");

        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteGroupMembershipSelf() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "del-group-mbr-self";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        Principal principal1 = principalAuthority.authenticate("v=U1;d=user;n=joe;s=signature",
                "10.11.12.13", "GET", null);
        ResourceContext rsrcCtx1 = zmsTestInitializer.createResourceContext(principal1);

        // now let's try to delete ourselves which should work

        zmsImpl.deleteGroupMembership(rsrcCtx1, domainName, groupName, "user.joe", auditRef, null);

        // now try to delete the other user which should be rejected

        try {
            zmsImpl.deleteGroupMembership(rsrcCtx1, domainName, groupName, "user.jane", auditRef, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.FORBIDDEN);
        }

        // now verify the results

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        List<GroupMember> members = group.getGroupMembers();
        assertNotNull(members);
        assertEquals(members.size(), 1);
        assertEquals(members.get(0).getMemberName(), "user.jane");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testIsAllowedDeletePendingGroupMembership() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "allowed-del-pending-mbr";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Group Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.user1", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "testrole1", null, "user.user1", "user.jane");
        zmsImpl.putRole(ctx, domainName, "testrole1", auditRef, false, null, role1);

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "Policy1", "testrole1",
                "UPDATE", domainName + ":group.*", AssertionEffect.ALLOW);
        zmsImpl.putPolicy(ctx, domainName, "Policy1", auditRef, false, null, policy1);

        assertTrue(zmsImpl.isAllowedDeletePendingGroupMembership(ctx.principal(), domainName,
                groupName, "user.pending"));

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=jane";
        Principal rsrcPrince = SimplePrincipal.create("user", "jane", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);

        assertTrue(zmsImpl.isAllowedDeletePendingGroupMembership(rsrcPrince, domainName, groupName, "user.pending"));

        unsignedCreds = "v=U1;d=user;n=john";
        rsrcPrince = SimplePrincipal.create("user", "john", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);

        // this time false since john is not authorized

        assertFalse(zmsImpl.isAllowedDeletePendingGroupMembership(rsrcPrince, domainName,
                groupName, "user.pending"));

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGPendingDomainGroupMembersListInvalidPrincipal() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        try {
            zmsImpl.getPendingDomainGroupMembersList(ctx, "user.unknwon", null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }
    }

    @Test
    public void testDeletePendingGroupMembershipAdminRequest() {

        final String domainName = "delete-pending-admin";
        final String groupName = "testgroup1";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "delete pending membership",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testorg");

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testorg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);
        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                domainName, "domain", "org");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "org", auditRef, meta);

        Group auditedGroup = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, auditedGroup);
        GroupSystemMeta rsm = createGroupSystemMetaObject(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName, "auditenabled", auditRef, rsm);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        // first request using admin principal

        DomainGroupMembership domainGroupMembership = zmsImpl.getPendingDomainGroupMembersList(ctx, "user.fury", null);

        assertNotNull(domainGroupMembership);
        assertNotNull(domainGroupMembership.getDomainGroupMembersList());
        assertEquals(domainGroupMembership.getDomainGroupMembersList().size(), 1);
        for (DomainGroupMembers drm : domainGroupMembership.getDomainGroupMembersList()) {
            assertEquals(drm.getDomainName(), domainName);
            assertNotNull(drm.getMembers());
            for (DomainGroupMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (GroupMember mr : mem.getMemberGroups()) {
                    assertNotNull(mr);
                    assertEquals(mr.getGroupName(), groupName);
                }
            }
        }

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=jane";
        Principal rsrcPrince = SimplePrincipal.create("user", "jane", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        ResourceContext rsrcCtx = zmsTestInitializer.createResourceContext(rsrcPrince);

        // first try to delete the pending request without proper authorization

        try {
            zmsImpl.deletePendingGroupMembership(rsrcCtx, domainName, groupName, "user.bob", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        // repeat the request using context principal

        zmsImpl.deletePendingGroupMembership(ctx, domainName, groupName, "user.bob", auditRef);

        // check the list to see there are no pending requests

        domainGroupMembership = zmsImpl.getPendingDomainGroupMembersList(ctx, "user.fury", null);
        assertNotNull(domainGroupMembership);
        assertTrue(domainGroupMembership.getDomainGroupMembersList().isEmpty());

        // delete some unknown member in the same group as admin

        try {
            zmsImpl.deletePendingGroupMembership(ctx, domainName, groupName, "user.bob2", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // delete some member in an unknown domain

        try {
            zmsImpl.deletePendingGroupMembership(ctx, "unkwown-domain", groupName, "user.bob2", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");
        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeletePendingGroupMembershipSelfServeRequest() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "delete-pending-self-serve";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "delete pending membership",
                "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testorg",
                true, false, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);

        Group auditedGroup = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, auditedGroup);
        GroupMeta rm = new GroupMeta().setSelfServe(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, rm);

        // user.joe is going to add user.bob in the self serve group

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=joe";
        Principal rsrcPrince = SimplePrincipal.create("user", "joe", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        ResourceContext ctxJoe = zmsTestInitializer.createResourceContext(rsrcPrince);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembership(ctxJoe, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        // first request using admin principal

        DomainGroupMembership domainGroupMembership = zmsImpl.getPendingDomainGroupMembersList(ctx, "user.user1", null);

        assertNotNull(domainGroupMembership);
        assertNotNull(domainGroupMembership.getDomainGroupMembersList());
        assertEquals(domainGroupMembership.getDomainGroupMembersList().size(), 1);
        for (DomainGroupMembers drm : domainGroupMembership.getDomainGroupMembersList()) {
            assertEquals(drm.getDomainName(), domainName);
            assertNotNull(drm.getMembers());
            for (DomainGroupMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (GroupMember mr : mem.getMemberGroups()) {
                    assertNotNull(mr);
                    assertEquals(mr.getGroupName(), groupName);
                }
            }
        }

        // first try to delete the pending request without proper authorization

        unsignedCreds = "v=U1;d=user;n=jane";
        rsrcPrince = SimplePrincipal.create("user", "jane", unsignedCreds + ";s=signature",0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        ResourceContext ctxJane = zmsTestInitializer.createResourceContext(rsrcPrince);

        try {
            zmsImpl.deletePendingGroupMembership(ctxJane, domainName, groupName, "user.bob", auditRef);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        // repeat the request using joe principal

        zmsImpl.deletePendingGroupMembership(ctxJoe, domainName, groupName, "user.bob", auditRef);

        // check the list to see there are no pending requests

        domainGroupMembership = zmsImpl.getPendingDomainGroupMembersList(ctx, "user.user1", null);
        assertNotNull(domainGroupMembership);
        assertTrue(domainGroupMembership.getDomainGroupMembersList().isEmpty());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetPendingDomainGroupMembersListByPrincipal() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "pend-dom-grp-mbr-list";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testorg");

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testorg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);
        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                domainName, "domain", "org");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "org", auditRef, meta);

        Group auditedGroup = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, auditedGroup);
        GroupSystemMeta rsm = createGroupSystemMetaObject(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName, "auditenabled", auditRef, rsm);
        GroupMeta rm = new GroupMeta().setSelfServe(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, rm);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 403);
        }

        // first request using specific principal

        DomainGroupMembership domainGroupMembership = zmsImpl.getPendingDomainGroupMembersList(ctx, "user.fury", null);

        assertNotNull(domainGroupMembership);
        assertNotNull(domainGroupMembership.getDomainGroupMembersList());
        assertEquals(domainGroupMembership.getDomainGroupMembersList().size(), 1);
        for (DomainGroupMembers drm : domainGroupMembership.getDomainGroupMembersList()) {
            assertEquals(drm.getDomainName(), domainName);
            assertNotNull(drm.getMembers());
            for (DomainGroupMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (GroupMember mr : mem.getMemberGroups()) {
                    assertNotNull(mr);
                    assertEquals(mr.getGroupName(), groupName);
                    assertEquals(mr.getPendingState(), PENDING_REQUEST_ADD_STATE);
                }
            }
        }

        // repeat the request using context principal

        Principal mockPrincipal = Mockito.mock(Principal.class);
        when(ctx.principal()).thenReturn(mockPrincipal);
        when(mockPrincipal.getDomain()).thenReturn("user");
        when(mockPrincipal.getFullName()).thenReturn("user.fury");
        domainGroupMembership = zmsImpl.getPendingDomainGroupMembersList(ctx, null, null);

        assertNotNull(domainGroupMembership);
        assertNotNull(domainGroupMembership.getDomainGroupMembersList());
        assertEquals(domainGroupMembership.getDomainGroupMembersList().size(), 1);
        for (DomainGroupMembers drm : domainGroupMembership.getDomainGroupMembersList()) {
            assertEquals(drm.getDomainName(), domainName);
            assertNotNull(drm.getMembers());
            for (DomainGroupMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (GroupMember mr : mem.getMemberGroups()) {
                    assertNotNull(mr);
                    assertEquals(mr.getGroupName(), groupName);
                    assertEquals(mr.getPendingState(), PENDING_REQUEST_ADD_STATE);
                }
            }
        }

        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");
        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetPendingDomainGroupMembersListByDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "pend-dom-grp-mbr-list";
        final String groupName = "group2";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        setupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "user.fury", "testorg");

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for approval test", "testorg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);
        zmsTestInitializer.setupPrincipalSystemMetaDelete(zmsImpl, ctx.principal().getFullName(),
                domainName, "domain", "org");
        zmsImpl.putDomainSystemMeta(ctx, domainName, "org", auditRef, meta);

        Group auditedGroup = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, auditedGroup);
        GroupSystemMeta rsm = createGroupSystemMetaObject(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName, "auditenabled", auditRef, rsm);
        GroupMeta rm = new GroupMeta().setSelfServe(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, rm);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException r) {
            assertEquals(r.code, 403);
        }

        // first request using specific principal

        DomainGroupMembership domainGroupMembership = zmsImpl.getPendingDomainGroupMembersList(ctx, null, domainName);

        assertNotNull(domainGroupMembership);
        assertNotNull(domainGroupMembership.getDomainGroupMembersList());
        assertEquals(domainGroupMembership.getDomainGroupMembersList().size(), 1);
        for (DomainGroupMembers drm : domainGroupMembership.getDomainGroupMembersList()) {
            assertEquals(drm.getDomainName(), domainName);
            assertNotNull(drm.getMembers());
            for (DomainGroupMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (GroupMember mr : mem.getMemberGroups()) {
                    assertNotNull(mr);
                    assertEquals(mr.getGroupName(), groupName);
                    assertEquals(mr.getPendingState(), PENDING_REQUEST_ADD_STATE);
                }
            }
        }

        // repeat the request using context principal

        Principal mockPrincipal = Mockito.mock(Principal.class);
        when(ctx.principal()).thenReturn(mockPrincipal);
        when(mockPrincipal.getDomain()).thenReturn("user");
        when(mockPrincipal.getFullName()).thenReturn("user.fury");
        domainGroupMembership = zmsImpl.getPendingDomainGroupMembersList(ctx, null, null);

        assertNotNull(domainGroupMembership);
        assertNotNull(domainGroupMembership.getDomainGroupMembersList());
        assertEquals(domainGroupMembership.getDomainGroupMembersList().size(), 1);
        for (DomainGroupMembers drm : domainGroupMembership.getDomainGroupMembersList()) {
            assertEquals(drm.getDomainName(), domainName);
            assertNotNull(drm.getMembers());
            for (DomainGroupMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (GroupMember mr : mem.getMemberGroups()) {
                    assertNotNull(mr);
                    assertEquals(mr.getGroupName(), groupName);
                    assertEquals(mr.getPendingState(), PENDING_REQUEST_ADD_STATE);
                }
            }
        }

        domainGroupMembership = zmsImpl.getPendingDomainGroupMembersList(ctx, null, "*");

        assertNotNull(domainGroupMembership);
        assertNotNull(domainGroupMembership.getDomainGroupMembersList());
        assertEquals(domainGroupMembership.getDomainGroupMembersList().size(), 1);
        for (DomainGroupMembers drm : domainGroupMembership.getDomainGroupMembersList()) {
            assertEquals(drm.getDomainName(), domainName);
            assertNotNull(drm.getMembers());
            for (DomainGroupMember mem : drm.getMembers()) {
                assertNotNull(mem);
                assertEquals(mem.getMemberName(), "user.bob");
                for (GroupMember mr : mem.getMemberGroups()) {
                    assertNotNull(mr);
                    assertEquals(mr.getGroupName(), groupName);
                    assertEquals(mr.getPendingState(), PENDING_REQUEST_ADD_STATE);
                }
            }
        }

        zmsTestInitializer.cleanupPrincipalSystemMetaDelete(zmsImpl, "domain");
        cleanupPrincipalAuditedRoleApprovalByOrg(zmsImpl, "testOrg");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetPrincipalGroups() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName1 = "principal-groups-dom1";
        final String groupName1 = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName1, groupName1, "user.john", "user.joe");
        zmsImpl.putGroup(ctx, domainName1, groupName1, auditRef, false, null, group1);

        final String domainName2 = "principal-groups-dom2";
        final String groupName2 = "group2";

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);

        Group group2 = zmsTestInitializer.createGroupObject(domainName2, groupName2, "user.john", "user.user1");
        zmsImpl.putGroup(ctx, domainName2, groupName2, auditRef, false, null, group2);

        DomainGroupMember dgm = zmsImpl.getPrincipalGroups(ctx, "user.john", domainName1);
        assertNotNull(dgm);
        List<GroupMember> memberGroups = dgm.getMemberGroups();
        assertEquals(memberGroups.size(), 1);
        assertEquals(memberGroups.get(0).getGroupName(), groupName1);
        assertEquals(memberGroups.get(0).getDomainName(), domainName1);

        dgm = zmsImpl.getPrincipalGroups(ctx, "user.john", null);
        assertNotNull(dgm);
        memberGroups = dgm.getMemberGroups();
        assertEquals(memberGroups.size(), 2);

        dgm = zmsImpl.getPrincipalGroups(ctx, null, domainName1);
        assertNotNull(dgm);
        assertTrue(dgm.getMemberGroups().isEmpty());

        dgm = zmsImpl.getPrincipalGroups(ctx, null, domainName2);
        assertNotNull(dgm);
        memberGroups = dgm.getMemberGroups();
        assertEquals(memberGroups.size(), 1);
        assertEquals(memberGroups.get(0).getGroupName(), groupName2);
        assertEquals(memberGroups.get(0).getDomainName(), domainName2);
    }

    @Test
    public void testVerifyAuthorizedServiceGroupPrefixOperation() {

        // our test resource json includes the following
        // group-prefix use case
        //        "coretech.updater": {
        //            "allowedOperations": [
        //               {
        //                 "name":"putgroupmembership",
        //                  "items": {
        //                      "group-prefix" : [
        //                          "reader.org.",
        //                          "writer.domain."
        //                      ]
        //                  }
        //              }
        //            ]

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        zmsImpl.verifyAuthorizedServiceGroupOperation(null, "putgroupmembership", "group1");

        // Try passing along operationItem key + value to see if verification works

        zmsImpl.verifyAuthorizedServiceGroupOperation("coretech.updater", "putgroupmembership", "reader.org.group1");
        zmsImpl.verifyAuthorizedServiceGroupOperation("coretech.updater", "putgroupmembership", "writer.domain.group1");

        // try with restricted operation. Currently, putmembership only allow single operation item.
        zmsImpl.verifyAuthorizedServiceGroupOperation("coretech.newsvc", "putgroupmembership", "platforms_deployer");
        zmsImpl.verifyAuthorizedServiceGroupOperation("coretech.newsvc", "putgroupmembership", "platforms_different_deployer");

        // Third, try with restriction operation, with not-specified operation item.

        try {
            zmsImpl.verifyAuthorizedServiceGroupOperation("coretech.updater", "putgroupmembership", "platforms_deployer_new");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.verifyAuthorizedServiceGroupOperation("coretech.updater", "putgroupmembership", "reader.org1.group1");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }

        try {
            zmsImpl.verifyAuthorizedServiceGroupOperation("coretech.newsvc", "putgroupmembership", "platforms_deployer_new");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 403);
        }
    }

    @Test
    public void testPutGroupMembershipDecisionSelfserveGroupApprove() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "self-service-group-approve";
        final String groupName = "group1";

        addMemberToSelfServeGroupWithUserIdentity(domainName, groupName);

        Group resGroup = zmsImpl.getGroup(ctx, domainName, groupName, false, true);
        assertEquals(resGroup.getGroupMembers().size(), 3);
        for (GroupMember rmem : resGroup.getGroupMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertFalse(rmem.getApproved());
            }
        }
        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);
        zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);

        resGroup = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertEquals(resGroup.getGroupMembers().size(), 3);
        for (GroupMember rmem : resGroup.getGroupMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertTrue(rmem.getApproved());
            }
        }
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipDecisionSelfserveRoleReject() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "self-service-group-reject";
        final String groupName = "group1";

        addMemberToSelfServeGroupWithUserIdentity(domainName, groupName);

        Group resGroup = zmsImpl.getGroup(ctx, domainName, groupName, false, true);
        assertEquals(resGroup.getGroupMembers().size(), 3);
        for (GroupMember rmem : resGroup.getGroupMembers()) {
            if ("user.bob".equals(rmem.getMemberName())) {
                assertFalse(rmem.getApproved());
            }
        }
        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);
        zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);

        resGroup = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertEquals(resGroup.getGroupMembers().size(), 2);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipDecisionReviewEnabledGroupApproveAddState() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "review-enabled-domain";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval test Domain1",
                "testOrg", "user.user1");
        dom1.getAdminUsers().add("user.user2");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        final String groupName = "review-group";
        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, null, null);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMeta rm = new GroupMeta().setReviewEnabled(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, rm);

        // switch to user.user2 principal to add a member to a group

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=user2";
        final Principal rsrcPrince = SimplePrincipal.create("user", "user2",
                unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcPrince);
        when(ctx.principal()).thenReturn(rsrcPrince);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(false);
        mbr.setApproved(false);

        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);

        // verify the user is added with pending state

        Group resgroup = zmsImpl.getGroup(ctx, domainName, groupName, false, true);
        assertEquals(resgroup.getGroupMembers().size(), 1);
        assertEquals(resgroup.getGroupMembers().get(0).getMemberName(), "user.bob");
        assertFalse(resgroup.getGroupMembers().get(0).getApproved());
        assertEquals(resgroup.getGroupMembers().get(0).getPendingState(), PENDING_REQUEST_ADD_STATE);

        // now try as the admin himself to approve this user and it must
        // be rejected since it has to be done by some other admin

        mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setActive(true);
        mbr.setApproved(true);

        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("cannot approve his/her own request"));
        }

        // revert back to admin principal

        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(zmsTestInitializer.getMockDomRestRsrcCtx().principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        // approve the message which should be successful

        zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);

        // verify the user is now active

        resgroup = zmsImpl.getGroup(ctx, domainName, groupName, false, true);
        assertEquals(resgroup.getGroupMembers().size(), 1);
        assertEquals(resgroup.getGroupMembers().get(0).getMemberName(), "user.bob");
        assertTrue(resgroup.getGroupMembers().get(0).getApproved());
        assertNull(resgroup.getGroupMembers().get(0).getPendingState());

        // trying to approve the same user should return 404

        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        // now try to approve another use which should also return 404

        mbr.setMemberName("user.joe");
        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.joe", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipDecisionReviewEnabledGroupApproveDeleteState() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "review-enabled-domain";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval test Domain1",
                "testOrg", "user.user1");
        dom1.getAdminUsers().add("user.user2");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        final String groupName = "review-group";
        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.bob", null);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMeta gm = new GroupMeta().setReviewEnabled(true).setDeleteProtection(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);

        // switch to user.user2 principal to add a member to a role

        Authority principalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String unsignedCreds = "v=U1;d=user;n=user2";
        final Principal rsrcPrince = SimplePrincipal.create("user", "user2",
                unsignedCreds + ";s=signature", 0, principalAuthority);
        assertNotNull(rsrcPrince);
        ((SimplePrincipal) rsrcPrince).setUnsignedCreds(unsignedCreds);
        when(ctx.principal()).thenReturn(rsrcPrince);
        when(ctx.principal()).thenReturn(rsrcPrince);

        zmsImpl.deleteGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, null);

        // verify the user is not been deleted and also verify the user is added as a pending member

        Group resgroup = zmsImpl.getGroup(ctx, domainName, groupName, false,true);
        assertEquals(resgroup.getGroupMembers().size(), 2);
        assertEquals(resgroup.getGroupMembers().get(0).getMemberName(), "user.bob");
        assertTrue(resgroup.getGroupMembers().get(0).getApproved());
        assertEquals(resgroup.getGroupMembers().get(1).getMemberName(), "user.bob");
        assertFalse(resgroup.getGroupMembers().get(1).getApproved());
        assertEquals(resgroup.getGroupMembers().get(1).getPendingState(), PENDING_REQUEST_DELETE_STATE);

        // now try as the admin himself to approve this user and it must
        // be rejected since it has to be done by some other admin
        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        mbr.setApproved(true);
        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("cannot approve his/her own request"));
        }

        // revert back to admin principal

        Authority adminPrincipalAuthority = new com.yahoo.athenz.common.server.debug.DebugPrincipalAuthority();
        String adminUnsignedCreds = "v=U1;d=user;n=user1";
        final Principal rsrcAdminPrince = SimplePrincipal.create("user", "user1",
                adminUnsignedCreds + ";s=signature", 0, adminPrincipalAuthority);
        assertNotNull(rsrcAdminPrince);
        ((SimplePrincipal) rsrcAdminPrince).setUnsignedCreds(adminUnsignedCreds);

        when(ctx.principal()).thenReturn(rsrcAdminPrince);
        when(ctx.principal()).thenReturn(rsrcAdminPrince);

        // approve the message which should be successful

        zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);

        // verify the user is now been deleted from both tables (standard and pending)

        resgroup = zmsImpl.getGroup(ctx, domainName, groupName, false, true);
        assertEquals(resgroup.getGroupMembers().size(), 0);

        // trying to approve the same user should return 404

        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.bob", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        // now try to approve another use which should also return 404

        mbr.setMemberName("user.joe");
        try {
            zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.joe", auditRef, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPendingGroupMembershipConflictRequests() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "review-enabled-domain";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Approval test Domain1",
                "testOrg", "user.user1");
        dom1.getAdminUsers().add("user.user2");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        final String groupName = "review-group";
        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.bob", null);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupMeta gm = new GroupMeta().setReviewEnabled(true).setDeleteProtection(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);

        zmsImpl.deleteGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, null);

        GroupMembership mbr = new GroupMembership();
        mbr.setMemberName("user.bob");
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.bob", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
            assertTrue(ex.getMessage().contains("already has a pending request in a different state"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMeta() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-meta";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Group Meta Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Authority savedAuthority = zmsImpl.userAuthority;

        Authority authority = Mockito.mock(Authority.class);
        when(authority.getDateAttribute("user.john", "elevated-clearance")).thenReturn(new Date());
        when(authority.isAttributeSet("user.john", "OnShore-US")).thenReturn(true);
        when(authority.getDateAttribute("user.jane", "elevated-clearance")).thenReturn(new Date());
        when(authority.isAttributeSet("user.jane", "OnShore-US")).thenReturn(true);
        Set<String> attrs = new HashSet<>();
        attrs.add("OnShore-US");
        attrs.add("elevated-clearance");
        when(authority.booleanAttributesSupported()).thenReturn(attrs);
        when(authority.dateAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;
        zmsImpl.dbService.zmsConfig.setUserAuthority(authority);

        GroupMeta groupMeta = new GroupMeta();
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, groupMeta);

        Group resGroup1 = zmsImpl.getGroup(ctx, domainName, groupName, true, false);
        assertNotNull(resGroup1);
        assertNull(resGroup1.getSelfServe());
        assertNull(resGroup1.getReviewEnabled());
        assertNull(resGroup1.getNotifyRoles());
        assertNull(resGroup1.getUserAuthorityExpiration());
        assertNull(resGroup1.getUserAuthorityFilter());
        assertNull(resGroup1.getMaxMembers());
        assertNull(resGroup1.getSelfRenew());
        assertNull(resGroup1.getSelfRenewMins());

        groupMeta = new GroupMeta()
                .setSelfServe(true)
                .setNotifyRoles("role1")
                .setReviewEnabled(false)
                .setUserAuthorityExpiration("elevated-clearance")
                .setUserAuthorityFilter("OnShore-US")
                .setMemberExpiryDays(45)
                .setServiceExpiryDays(45)
                .setSelfRenew(true)
                .setSelfRenewMins(99)
                .setMaxMembers(23);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, groupMeta);

        resGroup1 = zmsImpl.getGroup(ctx, domainName, groupName, true, false);
        assertNotNull(resGroup1);
        assertTrue(resGroup1.getSelfServe());
        assertNull(resGroup1.getReviewEnabled());
        assertEquals(resGroup1.getNotifyRoles(), "role1");
        assertEquals(resGroup1.getUserAuthorityExpiration(), "elevated-clearance");
        assertEquals(resGroup1.getUserAuthorityFilter(), "OnShore-US");
        assertEquals(resGroup1.getMemberExpiryDays(), Integer.valueOf(45));
        assertEquals(resGroup1.getServiceExpiryDays(), Integer.valueOf(45));
        assertEquals(resGroup1.getMaxMembers(), 23);
        assertTrue(resGroup1.getSelfRenew());
        assertEquals(resGroup1.getSelfRenewMins(), 99);

        groupMeta = new GroupMeta().setNotifyRoles("role2,role3");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, groupMeta);

        resGroup1 = zmsImpl.getGroup(ctx, domainName, groupName, true, false);
        assertNotNull(resGroup1);
        assertNull(resGroup1.getSelfServe()); // default value is false is not specified
        assertNull(resGroup1.getReviewEnabled());
        assertEquals(resGroup1.getNotifyRoles(), "role2,role3");
        assertEquals(resGroup1.getUserAuthorityExpiration(), "elevated-clearance");
        assertEquals(resGroup1.getUserAuthorityFilter(), "OnShore-US");

        zmsImpl.dbService.zmsConfig.setUserAuthority(savedAuthority);
        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMetaMissingAuditRef() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-meta-missing-auditref";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Group Meta Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainMeta meta = zmsTestInitializer.createDomainMetaObject("Domain Meta for Group Meta test", "NewOrg",
                true, true, "12345", 1001);
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        GroupSystemMeta rsm = createGroupSystemMetaObject(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName, "auditenabled", auditRef, rsm);

        GroupMeta rm = new GroupMeta().setSelfServe(true);
        try {
            zmsImpl.putGroupMeta(ctx, domainName, groupName, null, null, rm);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Audit reference required"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMetaThrowException() {

        final String domainName = "put-group-meta-exc";
        final String groupName = "group1";

        TestAuditLogger alogger = new TestAuditLogger();
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();
        GroupMeta rm = new GroupMeta();
        rm.setSelfServe(false);

        try {
            zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, rm);
            fail("notfounderror not thrown.");
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }
    }

    @Test
    public void testPutGroupMetaUserAuthorityFilterSet() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-meta-on-shore";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Group Meta Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Authority savedAuthority = zmsImpl.userAuthority;

        Authority authority = Mockito.mock(Authority.class);
        when(authority.isValidUser(anyString())).thenReturn(true);
        when(authority.isAttributeSet("user.john", "OnShore-US")).thenReturn(true);
        when(authority.isAttributeSet("user.jane", "OnShore-US")).thenReturn(false);
        when(authority.isAttributeSet("user.joe", "OnShore-US")).thenReturn(true);
        when(authority.isAttributeSet("user.doe", "OnShore-US")).thenReturn(false);
        Set<String> attrs = new HashSet<>();
        attrs.add("OnShore-US");
        when(authority.booleanAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;
        zmsImpl.dbService.zmsConfig.setUserAuthority(authority);

        GroupMeta groupMeta = new GroupMeta().setUserAuthorityFilter("OnShore-US");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, groupMeta);

        // john should be active but jane should be disabled

        GroupMembership groupMembership = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.john", null);
        assertNotNull(groupMembership);
        assertTrue(groupMembership.getIsMember());
        assertNull(groupMembership.getSystemDisabled());

        groupMembership = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.jane", null);
        assertNotNull(groupMembership);
        assertTrue(groupMembership.getIsMember());
        assertEquals(groupMembership.getSystemDisabled().intValue(), 1);

        // we should be able to add joe but not doe

        groupMembership = new GroupMembership().setGroupName(groupName).setMemberName("user.joe");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.joe", auditRef, false, null, groupMembership);

        groupMembership = new GroupMembership().setGroupName(groupName).setMemberName("user.doe");
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, groupMembership);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // now let's remove our flag

        groupMeta = new GroupMeta().setUserAuthorityFilter("");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, groupMeta);

        // jane should be back to 0 for system disabled flag

        groupMembership = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.jane", null);
        assertNotNull(groupMembership);
        assertTrue(groupMembership.getIsMember());
        assertNull(groupMembership.getSystemDisabled());

        // and we're able to add doe now

        groupMembership = new GroupMembership().setGroupName(groupName).setMemberName("user.doe");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, groupMembership);

        zmsImpl.dbService.zmsConfig.setUserAuthority(savedAuthority);
        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMetaUserAuthorityFilterExpirySet() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-group-meta-elevated-clearance";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Group Meta Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        Authority savedAuthority = zmsImpl.userAuthority;

        Timestamp timestmp = Timestamp.fromMillis(System.currentTimeMillis() + 100000);
        Date date = timestmp.toDate();
        Authority authority = Mockito.mock(Authority.class);
        when(authority.isValidUser(anyString())).thenReturn(true);
        when(authority.getDateAttribute("user.john", "elevated-clearance")).thenReturn(date);
        when(authority.getDateAttribute("user.jane", "elevated-clearance")).thenReturn(null);
        when(authority.getDateAttribute("user.joe", "elevated-clearance")).thenReturn(date);
        when(authority.getDateAttribute("user.doe", "elevated-clearance")).thenReturn(null);
        Set<String> attrs = new HashSet<>();
        attrs.add("elevated-clearance");
        when(authority.dateAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;
        zmsImpl.dbService.zmsConfig.setUserAuthority(authority);

        GroupMeta groupMeta = new GroupMeta().setUserAuthorityExpiration("elevated-clearance");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, groupMeta);

        // john should be active but jane should be expired

        GroupMembership groupMembership = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.john", null);
        assertNotNull(groupMembership);
        assertTrue(groupMembership.getIsMember());
        assertEquals(groupMembership.getExpiration(), timestmp);

        groupMembership = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.jane", null);
        assertNotNull(groupMembership);
        assertFalse(groupMembership.getIsMember());
        assertTrue(groupMembership.getExpiration().millis() <= System.currentTimeMillis());

        // we should be able to add joe but not doe

        groupMembership = new GroupMembership().setGroupName(groupName).setMemberName("user.joe");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.joe", auditRef, false, null, groupMembership);

        groupMembership = new GroupMembership().setGroupName(groupName).setMemberName("user.doe");
        try {
            zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, groupMembership);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // now let's remove our flag

        groupMeta = new GroupMeta().setUserAuthorityExpiration("");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, groupMeta);

        // jane should be still be inactive since we don't remove
        // expiration flags from users

        groupMembership = zmsImpl.getGroupMembership(ctx, domainName, groupName, "user.jane", null);
        assertNotNull(groupMembership);
        assertFalse(groupMembership.getIsMember());
        assertTrue(groupMembership.getExpiration().millis() <= System.currentTimeMillis());

        // and we're able to add doe now

        groupMembership = new GroupMembership().setGroupName(groupName).setMemberName("user.doe");
        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, groupMembership);

        zmsImpl.dbService.zmsConfig.setUserAuthority(savedAuthority);
        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutGroupMembershipDBFailure() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "create-group-mbr-db-failure";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // put the db in read-only mode

        zmsTestInitializer.setDatabaseReadOnlyMode(true);

        // add a new member

        try {
            GroupMembership mbr = zmsTestInitializer.generateGroupMembership(groupName, "user.doe");
            zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex)  {
            assertEquals(ex.getCode(), ResourceException.GONE);
        }

        // delete an existing member

        try {
            zmsImpl.deleteGroupMembership(ctx, domainName, groupName, "user.joe", auditRef, null);
            fail();
        } catch (ResourceException ex)  {
            assertEquals(ex.getCode(), ResourceException.GONE);
        }

        // remove read-only mode

        zmsTestInitializer.setDatabaseReadOnlyMode(false);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteGroupDBFailure() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "del-group-db-failure";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // put the db in read-only mode

        zmsTestInitializer.setDatabaseReadOnlyMode(true);

        // add a new member

        try {
            zmsImpl.deleteGroup(ctx, domainName, groupName, auditRef, null);
            fail();
        } catch (ResourceException ex)  {
            assertEquals(ex.getCode(), ResourceException.GONE);
        }

        // remove read-only mode

        zmsTestInitializer.setDatabaseReadOnlyMode(false);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testUpdateRoleMemberReviewAndExpirationDates() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "update-role";
        final String roleName = "role1";

        Timestamp t1 = Timestamp.fromMillis(1000);
        Timestamp t2 = Timestamp.fromMillis(2000);
        Timestamp t3 = Timestamp.fromMillis(3000);
        Timestamp t4 = Timestamp.fromMillis(4000);

        List<RoleMember> originalMembers = new ArrayList<>();
        originalMembers.add(new RoleMember().setMemberName("user.joe")
                .setPrincipalType(Principal.Type.USER.getValue()));
        originalMembers.add(new RoleMember().setMemberName("user.jane")
                .setReviewReminder(t1)
                .setPrincipalType(Principal.Type.USER.getValue()));
        originalMembers.add(new RoleMember().setMemberName("user.joseph")
                .setReviewReminder(t1)
                .setExpiration(t1)
                .setPrincipalType(Principal.Type.USER.getValue()));
        originalMembers.add(new RoleMember().setMemberName("user.judy")
                .setReviewReminder(t1)
                .setExpiration(t1)
                .setPrincipalType(Principal.Type.USER.getValue()));
        originalMembers.add(new RoleMember().setMemberName("user.johannes")
                .setExpiration(t1)
                .setPrincipalType(Principal.Type.USER.getValue()));

        List<RoleMember> updatedMembers = new ArrayList<>();
        updatedMembers.add(new RoleMember().setMemberName("user.joe")
                .setExpiration(t2)
                .setPrincipalType(Principal.Type.USER.getValue()));
        updatedMembers.add(new RoleMember().setMemberName("user.jane")
                .setReviewReminder(t2)
                .setPrincipalType(Principal.Type.USER.getValue()));
        updatedMembers.add(new RoleMember().setMemberName("user.joseph")
                .setReviewReminder(t3)
                .setExpiration(t4)
                .setPrincipalType(Principal.Type.USER.getValue()));
        updatedMembers.add(new RoleMember().setMemberName("user.judy")
                .setReviewReminder(t1)
                .setExpiration(t1)
                .setPrincipalType(Principal.Type.USER.getValue()));

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // now let's create a role with user members only

        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, originalMembers);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        // now let's get our role object

        Role role = zmsImpl.getRole(ctx, domainName, roleName, false, false, false);
        assertNotNull(role);

        List<RoleMember> retrievedMembers = role.getRoleMembers();
        assertNotNull(retrievedMembers);
        assertEquals(retrievedMembers.size(), 5);
        zmsTestInitializer.checkRoleMembersExpirationAndReviewDates(originalMembers, retrievedMembers);

        // now let's update our role with the updated members

        role1.setRoleMembers(updatedMembers);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        // now let's get our role object

        role = zmsImpl.getRole(ctx, domainName, roleName, false, false, false);
        assertNotNull(role);

        retrievedMembers = role.getRoleMembers();
        assertNotNull(retrievedMembers);
        assertEquals(retrievedMembers.size(), 4);
        zmsTestInitializer.checkRoleMembersExpirationAndReviewDates(updatedMembers, retrievedMembers);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testUpdateGroupMemberExpirationDate() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "update-group";
        final String groupName = "group1";

        Timestamp t1 = Timestamp.fromMillis(1000);
        Timestamp t2 = Timestamp.fromMillis(2000);
        Timestamp t3 = Timestamp.fromMillis(3000);

        List<GroupMember> originalMembers = new ArrayList<>();
        originalMembers.add(new GroupMember().setMemberName("user.joe")
                .setPrincipalType(Principal.Type.USER.getValue()));
        originalMembers.add(new GroupMember().setMemberName("user.jane")
                .setPrincipalType(Principal.Type.USER.getValue()));
        originalMembers.add(new GroupMember().setMemberName("user.joseph")
                .setExpiration(t1)
                .setPrincipalType(Principal.Type.USER.getValue()));
        originalMembers.add(new GroupMember().setMemberName("user.judy")
                .setExpiration(t1)
                .setPrincipalType(Principal.Type.USER.getValue()));
        originalMembers.add(new GroupMember().setMemberName("user.johannes")
                .setExpiration(t1)
                .setPrincipalType(Principal.Type.USER.getValue()));

        List<GroupMember> updatedMembers = new ArrayList<>();
        updatedMembers.add(new GroupMember().setMemberName("user.joe")
                .setExpiration(t2)
                .setPrincipalType(Principal.Type.USER.getValue()));
        updatedMembers.add(new GroupMember().setMemberName("user.jane")
                .setPrincipalType(Principal.Type.USER.getValue()));
        updatedMembers.add(new GroupMember().setMemberName("user.joseph")
                .setExpiration(t3)
                .setPrincipalType(Principal.Type.USER.getValue()));
        updatedMembers.add(new GroupMember().setMemberName("user.judy")
                .setExpiration(t1)
                .setPrincipalType(Principal.Type.USER.getValue()));

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // now let's create a group with user members only

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName,  originalMembers);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // now let's get our group object

        Group group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        List<GroupMember> retrievedMembers = group.getGroupMembers();
        assertNotNull(retrievedMembers);
        assertEquals(retrievedMembers.size(), 5);
        zmsTestInitializer.checkGroupMembersExpirationDate(originalMembers, retrievedMembers);

        // now let's update our group with the updated members

        group1.setGroupMembers(updatedMembers);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // now let's get our group object

        group = zmsImpl.getGroup(ctx, domainName, groupName, false, false);
        assertNotNull(group);

        retrievedMembers = group.getGroupMembers();
        assertNotNull(retrievedMembers);
        assertEquals(retrievedMembers.size(), 4);
        zmsTestInitializer.checkGroupMembersExpirationDate(updatedMembers, retrievedMembers);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testUpdateRoleWithGroupMembers() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "update-role";
        final String roleName = "role1";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        ArrayList<GroupMember> groupMembers = new ArrayList<>();
        groupMembers.add(new GroupMember().setMemberName("user.user1"));
        groupMembers.add(new GroupMember().setMemberName("user.user2"));
        groupMembers.add(new GroupMember().setMemberName("user.user3"));

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName, groupMembers);
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group1);

        // now let's create a role with user members only

        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.user1", "user.user2");
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        // now let's update our role with group member - first with invalid

        role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.user1", ResourceUtils.groupResourceName(domainName, "dev-team"));
        try {
            zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // now let's update our role with correct group member

        role1 = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.user1", ResourceUtils.groupResourceName(domainName, groupName));
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role1);

        // now let's get our role object

        Role role = zmsImpl.getRole(ctx, domainName, roleName, false, false, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);
        List<String> checkList = new ArrayList<>();
        checkList.add("user.user1");
        checkList.add(ResourceUtils.groupResourceName(domainName, groupName));
        zmsTestInitializer.checkRoleMember(checkList, members);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testValidateGroupMemberAuthorityAttributesFailures() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "group-member-attr";
        final String roleName = "role1";
        final String groupName = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // invalid group that doesn't exist

        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john",
                ResourceUtils.groupResourceName(domainName, groupName));

        try {
            zmsImpl.validateGroupMemberAuthorityAttributes(role, "OnShore-US", "elevated-clearance", "unittest");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Invalid group member"));
        }

        // now let's add the group to make it valid

        Group group = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group);

        try {
            zmsImpl.validateGroupMemberAuthorityAttributes(role, "OnShore-US", "elevated-clearance", "unittest");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("does not have same user authority filter"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testValidateGroupPrincipalFailures() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "val-group-principal";
        final String groupName = "group1";

        Authority savedAuthority = zmsImpl.userAuthority;

        Authority authority = Mockito.mock(Authority.class);
        when(authority.isValidUser(anyString())).thenReturn(true);
        when(authority.getDateAttribute("user.john", "elevated-clearance")).thenReturn(new Date());
        when(authority.isAttributeSet("user.john", "OnShore-US")).thenReturn(true);
        when(authority.getDateAttribute("user.jane", "elevated-clearance")).thenReturn(new Date());
        when(authority.isAttributeSet("user.jane", "OnShore-US")).thenReturn(true);
        Set<String> attrs = new HashSet<>();
        attrs.add("OnShore-US");
        attrs.add("elevated-clearance");
        when(authority.booleanAttributesSupported()).thenReturn(attrs);
        when(authority.dateAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;
        zmsImpl.dbService.zmsConfig.setUserAuthority(authority);

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group);

        // both null is good

        zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), null, null, null, "unittest");

        // with user authority we have failure

        try {
            zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), "OnShore-US",
                    null, null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("does not have same user authority filter"));
        }

        GroupMeta gm = new GroupMeta().setUserAuthorityFilter("OnShore-US");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);

        // now without user expiry we have success

        zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), "OnShore-US",
                null, null, "unittest");

        // with expiry it's failure

        try {
            zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), "OnShore-US",
                    "elevated-clearance", null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("does not have same user authority expiration"));
        }

        // now we set the expiry on group as well

        gm = new GroupMeta().setUserAuthorityFilter("OnShore-US").setUserAuthorityExpiration("elevated-clearance");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);

        // now we have success

        zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), "OnShore-US",
                "elevated-clearance", null, "unittest");

        // with different values we have failures again

        try {
            zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), "OnShore-UK",
                    null, null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("does not have same user authority filter"));
        }

        try {
            zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), "OnShore-US",
                    "elevated-l2-clearance", null, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("does not have same user authority expiration"));
        }

        // if we ask for the audit enabled flag we should get failure

        try {
            zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), null, null, true, "unittest");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("must be audit enabled"));
        }

        // if we pass false then we're good

        zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), null, null, false, "unittest");

        // now let's set the group as audit enabled and try again

        GroupSystemMeta gsm = new GroupSystemMeta().setAuditEnabled(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName, "auditenabled", auditRef, gsm);

        zmsImpl.validateGroupPrincipal(ResourceUtils.groupResourceName(domainName, groupName), null, null, true, "unittest");

        zmsImpl.dbService.zmsConfig.setUserAuthority(savedAuthority);
        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutRoleSystemMetaWithGroups() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "role-system-audit-enabled";
        final String roleName1 = "role1";
        final String groupName1 = "group1";
        final String groupName2 = "group2";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Role System Meta Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainMeta meta = new DomainMeta().setAuditEnabled(true);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName1, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName1, auditRef, false, null, group1);

        Group group2 = zmsTestInitializer.createGroupObject(domainName, groupName2, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName2, auditRef, false, null, group2);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName1, null, "user.john",
                ResourceUtils.groupResourceName(domainName, groupName1));
        zmsImpl.putRole(ctx, domainName, roleName1, auditRef, false, null, role1);

        // if we try to put the audit enabled flag on the role
        // it should be rejected since the group doesn't have audit flag

        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        try {
            zmsImpl.putRoleSystemMeta(ctx, domainName, roleName1, "auditenabled", auditRef, rsm);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("must have audit flag enabled"));
        }

        // now let's set the audit enabled flag on the group

        GroupSystemMeta gsm = new GroupSystemMeta().setAuditEnabled(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName1, "auditenabled", auditRef, gsm);

        // now let's try our set system role meta operation

        zmsImpl.putRoleSystemMeta(ctx, domainName, roleName1, "auditenabled", auditRef, rsm);

        // now we're going to add group2 as a member which should be rejected
        // since it's not audit enabled

        Membership mbr = new Membership().setMemberName(ResourceUtils.groupResourceName(domainName, groupName2));
        try {
            zmsImpl.putMembership(ctx, domainName, roleName1,
                    ResourceUtils.groupResourceName(domainName, groupName2), auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("must be audit enabled"));
        }

        // now let's add the audit flag on the group and our put membership should work

        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName2, "auditenabled", auditRef, gsm);
        zmsImpl.putMembership(ctx, domainName, roleName1,
                ResourceUtils.groupResourceName(domainName, groupName2), auditRef, false, null, mbr);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGroupUserAuthorityFilterRemoveRejection() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "reject-group-filter-remove";
        final String groupName = "group1";
        final String roleName = "role1";

        Authority savedAuthority = zmsImpl.userAuthority;

        Authority authority = Mockito.mock(Authority.class);
        when(authority.isValidUser(anyString())).thenReturn(true);
        when(authority.isAttributeSet("user.john", "OnShore-US")).thenReturn(true);
        Set<String> attrs = new HashSet<>();
        attrs.add("OnShore-US");
        when(authority.booleanAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", "user.user1");

        dom1.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group);

        GroupMeta gm = new GroupMeta().setUserAuthorityFilter("OnShore-US");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);

        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john", ResourceUtils.groupResourceName(domainName, groupName));
        role.setUserAuthorityFilter("OnShore-US");
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);

        // now we're going to try to remove the user authority filter
        // from the group and it should be rejected since the role
        // has the filter set on the group

        gm = new GroupMeta().setUserAuthorityFilter("");
        try {
            zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("role filter requirements"));
        }

        // now let's remove the filter from the role

        RoleMeta rm = new RoleMeta().setUserAuthorityFilter("");
        zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, rm);

        // now our group meta should work

        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);

        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGroupUserAuthorityExpiryRemoveRejection2() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "reject-group-expiry-remove";
        final String groupName = "group1";
        final String roleName = "role1";

        Authority savedAuthority = zmsImpl.userAuthority;

        Authority authority = Mockito.mock(Authority.class);
        when(authority.isValidUser(anyString())).thenReturn(true);
        when(authority.getDateAttribute("user.john", "elevated-clearance")).thenReturn(new Date());
        when(authority.getDateAttribute("user.jane", "elevated-clearance")).thenReturn(new Date());
        Set<String> attrs = new HashSet<>();
        attrs.add("elevated-clearance");
        when(authority.booleanAttributesSupported()).thenReturn(attrs);
        when(authority.dateAttributesSupported()).thenReturn(attrs);
        zmsImpl.userAuthority = authority;
        zmsImpl.dbService.zmsConfig.setUserAuthority(authority);

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", "user.user1");

        dom1.setAuditEnabled(true);
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group = zmsTestInitializer.createGroupObject(domainName, groupName, "user.john", "user.jane");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group);

        GroupMeta gm = new GroupMeta().setUserAuthorityExpiration("elevated-clearance");
        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);

        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john", ResourceUtils.groupResourceName(domainName, groupName));
        role.setUserAuthorityExpiration("elevated-clearance");
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);

        // now we're going to try to remove the user authority expiration
        // from the group and it should be rejected since the role
        // has the expiration set on the group

        gm = new GroupMeta().setUserAuthorityExpiration("");
        try {
            zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("role expiration requirements"));
        }

        // now let's remove the expiration from the role

        RoleMeta rm = new RoleMeta().setUserAuthorityExpiration("");
        zmsImpl.putRoleMeta(ctx, domainName, roleName, auditRef, null, rm);

        // now our group meta should work

        zmsImpl.putGroupMeta(ctx, domainName, groupName, auditRef, null, gm);

        zmsImpl.dbService.zmsConfig.setUserAuthority(savedAuthority);
        zmsImpl.userAuthority = savedAuthority;
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testZMSGroupMemberFetcher() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName1 = "group-fetcher";
        final String groupName1 = "group1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1, "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName1, groupName1, "user.joe", "user.jane");
        zmsImpl.putGroup(ctx, domainName1, groupName1, auditRef, false, null, group1);

        // first failure case

        assertNull(zmsImpl.groupMemberFetcher.getGroupMembers("group-fetcher:group.group2"));

        // now valid case

        List<GroupMember> members = zmsImpl.groupMemberFetcher.getGroupMembers("group-fetcher:group.group1");
        assertNotNull(members);
        assertEquals(members.size(), 2);

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
    }

    @Test
    public void testGetRoleWithGroupMembers() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "role-with-group";
        final String roleName1 = "role1";
        final String roleName2 = "role2";
        final String groupName1 = "dev-team";
        final String groupName2 = "pe-team";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role1 = zmsTestInitializer.createRoleObject(domainName, roleName1, null, "user.joe", "user.jane");
        zmsImpl.putRole(ctx, domainName, roleName1, auditRef, false, null, role1);

        Role role = zmsImpl.getRole(ctx, domainName, roleName1, false, true, false);
        assertNotNull(role);

        List<RoleMember> members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 2);

        List<String> checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        zmsTestInitializer.checkRoleMember(checkList, members);

        // now let's create a group with 2 new members and it to the role

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName1, "user.joey", "user.moe");
        zmsImpl.putGroup(ctx, domainName, groupName1, auditRef, false, null, group1);

        Membership mbr = new Membership().setMemberName(ResourceUtils.groupResourceName(domainName, groupName1));
        zmsImpl.putMembership(ctx, domainName, roleName1,
                ResourceUtils.groupResourceName(domainName, groupName1), auditRef, false, null, mbr);

        role = zmsImpl.getRole(ctx, domainName, roleName1, false, true, false);
        assertNotNull(role);

        members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 4);

        checkList = new ArrayList<>();
        checkList.add("user.joe");
        checkList.add("user.jane");
        checkList.add("user.joey");
        checkList.add("user.moe");
        zmsTestInitializer.checkRoleMember(checkList, members);

        // now we're going to add another group with the same users from role and group1

        Group group2 = zmsTestInitializer.createGroupObject(domainName, groupName2, "user.joey", "user.joe");
        zmsImpl.putGroup(ctx, domainName, groupName2, auditRef, false, null, group2);

        mbr = new Membership().setMemberName(ResourceUtils.groupResourceName(domainName, groupName2));
        zmsImpl.putMembership(ctx, domainName, roleName1,
                ResourceUtils.groupResourceName(domainName, groupName2), auditRef, false, null, mbr);

        role = zmsImpl.getRole(ctx, domainName, roleName1, false, true, false);
        assertNotNull(role);

        members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 6);

        // make sure joe and joey are listed twice

        int joeCount = 0;
        int joeyCount = 0;
        for (RoleMember roleMember : members) {
            switch (roleMember.getMemberName()) {
                case "user.joe":
                    joeCount += 1;
                    break;
                case "user.joey":
                    joeyCount += 1;
                    break;
            }
        }
        assertEquals(2, joeCount);
        assertEquals(2, joeyCount);

        // now let's create a role member where the group has an expiry

        Role role2 = zmsTestInitializer.createRoleObject(domainName, roleName2, null, "user.joe", "user.jane");
        role2.getRoleMembers().add(new RoleMember()
                .setMemberName(ResourceUtils.groupResourceName(domainName, groupName2))
                .setExpiration(Timestamp.fromCurrentTime()));
        zmsImpl.putRole(ctx, domainName, roleName2, auditRef, false, null, role2);

        role = zmsImpl.getRole(ctx, domainName, roleName2, false, true, false);
        assertNotNull(role);

        members = role.getRoleMembers();
        assertNotNull(members);
        assertEquals(members.size(), 4);

        // make sure joe is listed twice once with expiry and one
        // without expiry

        joeCount = 0;
        int joeCountWithExpiry = 0;
        for (RoleMember roleMember : members) {
            if ("user.joe".equals(roleMember.getMemberName())) {
                if (roleMember.getExpiration() == null) {
                    joeCount += 1;
                } else {
                    joeCountWithExpiry += 1;
                }
            }
        }
        assertEquals(1, joeCount);
        assertEquals(1, joeCountWithExpiry);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testAdminRoleGroupRestriction() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "role-with-group";
        final String groupName1 = "dev-team";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1", "testOrg", "user.user1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Group group1 = zmsTestInitializer.createGroupObject(domainName, groupName1, "user.joey", "user.moe");
        zmsImpl.putGroup(ctx, domainName, groupName1, auditRef, false, null, group1);

        // we're not allowed to create top level domain with group members

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain2", "testOrg",
                "user.user1");
        dom2.getAdminUsers().add(ResourceUtils.groupResourceName(domainName, groupName1));

        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // we should be not be allowed to update admin role

        Role role1 = zmsTestInitializer.createRoleObject(domainName, "admin", null, "user.joe",
                ResourceUtils.groupResourceName(domainName, groupName1));

        try {
            zmsImpl.putRole(ctx, domainName, "admin", auditRef, false, null, role1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        // we should not be allowed to add groups to the admin role

        Membership mbr = new Membership().setMemberName(ResourceUtils.groupResourceName(domainName, groupName1));
        try {
            zmsImpl.putMembership(ctx, domainName, "admin",
                    ResourceUtils.groupResourceName(domainName, groupName1), auditRef, false, null, mbr);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.BAD_REQUEST);
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testAzureSubscriptionUniquenessCheck() {

        final String domainName1 = "azure-sub-unique1";
        final String domainName2 = "azure-sub-unique2";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1, "Test Domain1",
                "testOrg", "user.user1");
        dom1.setAzureSubscription("azure1");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // create another domain with the same subscription which should be rejected

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2, "Test Domain1",
                "testOrg", "user.user1");
        dom2.setAzureSubscription("azure1");
        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Subscription Id: azure1 is already assigned to domain: " + domainName1));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
    }

    @Test
    public void testGcpProjectUniquenessCheck() {

        final String domainName1 = "gcp-sub-unique1";
        final String domainName2 = "gcp-sub-unique2";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName1, "Test Domain1",
                "testOrg", "user.user1");
        dom1.setGcpProject("gcp1");
        dom1.setGcpProjectNumber("1234");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // create another domain with the same project which should be rejected

        TopLevelDomain dom2 = zmsTestInitializer.createTopLevelDomainObject(domainName2, "Test Domain1",
                "testOrg", "user.user1");
        dom2.setGcpProject("gcp1");
        dom2.setGcpProjectNumber("1235");
        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom2);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Project: gcp1 is already assigned to domain: " + domainName1));
        }

        zmsImpl.deleteTopLevelDomain(ctx, domainName1, auditRef, null);
    }

    @Test
    public void testCreateTopLevelDomainInvalidFields(){

        final String domainName = "invalid-fields";

        TestAuditLogger alogger = new TestAuditLogger();
        System.setProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT, "true");
        ZMSImpl zmsImpl = zmsTestInitializer.getZmsImpl(alogger);
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", "user.user1");

        // first try with negative product id

        dom1.setYpmId(-11001);
        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Product Id must be a positive integer"));
        }

        // try with invalid environment

        dom1.setYpmId(101999);
        dom1.setEnvironment("unknown");
        try {
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid environment for domain"));
        }

        System.clearProperty(ZMSConsts.ZMS_PROP_PRODUCT_ID_SUPPORT);
    }

    @Test
    public void testCreateTopLevelDomainWithTemplate() {

        final String domainName = "domain-with-template";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain domSysNetwork = zmsTestInitializer.createSubDomainObject("network", "sys", "Test Domain",
                "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postSubDomain(ctx, "sys", auditRef, null, domSysNetwork);

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName, "Test Domain1",
                "testOrg", "user.user1");
        DomainTemplateList templateList = new DomainTemplateList();
        List<String> templates = new ArrayList<>();
        templates.add("vipng");
        templateList.setTemplateNames(templates);
        dom1.setTemplates(templateList);

        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        Domain domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);

        Role role = zmsImpl.getRole(ctx, domainName,
                "vip_admin", false, false, false);
        assertNotNull(role);

        Policy policy = zmsImpl.getPolicy(ctx, domainName, "vip_admin");
        assertNotNull(policy);

        zmsImpl.deleteSubDomain(ctx, "sys", "network", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testGetAthenzDomainWithEntities() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "athenz-domain-with-entities";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Entity entity1 = zmsTestInitializer.createEntityObject(domainName, "test-entity1");
        zmsImpl.putEntity(ctx, domainName, "test-entity1", auditRef, entity1);

        Entity entity2 = zmsTestInitializer.createEntityObject(domainName, "test-entity2");
        zmsImpl.putEntity(ctx, domainName, "test-entity2", auditRef, entity2);

        AthenzDomain domain = zmsImpl.getAthenzDomain(domainName, false);
        List<Entity> entities = domain.getEntities();
        assertNotNull(entities);
        assertEquals(entities.size(), 2);

        boolean entity1Check = false;
        boolean entity2Check = false;

        for (Entity entity : entities) {
            switch (entity.getName()) {
                case "athenz-domain-with-entities:entity.test-entity1":
                    entity1Check = true;
                    break;
                case "athenz-domain-with-entities:entity.test-entity2":
                    entity2Check = true;
                    break;
            }
        }

        assertTrue(entity1Check);
        assertTrue(entity2Check);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutDomainMetaBusinessService() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "athenz-domain-with-business-service";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Domain domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertNull(domain.getBusinessService());

        // set the business service

        DomainMeta dm = new DomainMeta().setBusinessService("service1");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, dm);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getBusinessService(), "service1");

        // update the business service

        dm.setBusinessService("service2");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, dm);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getBusinessService(), "service2");

        // update different meta attribute

        dm = new DomainMeta().setDescription("new description");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, dm);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getBusinessService(), "service2");
        assertEquals(domain.getDescription(), "new description");

        // remove the business service

        dm = new DomainMeta().setBusinessService("").setDescription("new description");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, dm);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertNull(domain.getBusinessService());
        assertEquals(domain.getDescription(), "new description");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutDomainMetaEnvironment() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "athenz-domain-with-environment";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Domain domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertNull(domain.getEnvironment());

        // set the environment

        DomainMeta dm = new DomainMeta().setEnvironment("production");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, dm);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getEnvironment(), "production");

        // update the environment

        dm.setEnvironment("staging");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, dm);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getEnvironment(), "staging");

        // set an invalid value and verify failure

        dm = new DomainMeta().setEnvironment("unknown");
        try {
            zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, dm);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid environment for domain"));
        }

        // remove the environment

        dm = new DomainMeta().setEnvironment("");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, dm);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertNull(domain.getEnvironment());

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPostDomainInvalidDomainMetaStoreValues() {

        final String domainName = "athenz-domain-with-invalid-details";

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        DomainMetaStore savedMetaStore = zmsImpl.domainMetaStore;
        zmsImpl.domainMetaStore = new TestDomainMetaStore();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());

        try {
            dom1.setBusinessService("invalid-business-service");
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid business service name"));
        }

        try {
            dom1.setBusinessService("valid-business-service");
            dom1.setAccount("invalid-aws-account");
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid aws account"));
        }

        try {
            dom1.setAccount("valid-aws-account");
            dom1.setAzureSubscription("invalid-azure-subscription");
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid azure subscription"));
        }

        try {
            dom1.setAccount("valid-aws-account");
            dom1.setAzureSubscription("valid-azure-subscription");
            dom1.setGcpProject("invalid-gcp-project");
            dom1.setGcpProjectNumber("1200");
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid gcp project"));
        }

        zmsImpl.productIdSupport = true;
        try {
            dom1.setGcpProject("valid-gcp-project");
            dom1.setGcpProjectNumber("1200");
            dom1.setYpmId(100);
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid product id"));
        }

        try {
            dom1.setGcpProject("valid-gcp-project");
            dom1.setGcpProjectNumber("1200");
            dom1.setYpmId(101);
            dom1.setProductId("invalid-product-id");
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid product id"));
        }

        // specify gcp project but no project number

        try {
            dom1.setYpmId(101);
            dom1.setProductId("valid-product-id");
            dom1.setGcpProject("valid-gcp-project");
            dom1.setGcpProjectNumber(null);
            zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid gcp project"));
        }

        dom1.setYpmId(101);
        dom1.setGcpProject("valid-gcp-project");
        dom1.setGcpProjectNumber("1200");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Domain domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getBusinessService(), "valid-business-service");
        assertEquals(domain.getAccount(), "valid-aws-account");
        assertEquals(domain.getAzureSubscription(), "valid-azure-subscription");
        assertEquals(domain.getGcpProject(), "valid-gcp-project");
        assertEquals(domain.getYpmId().intValue(), 101);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        zmsImpl.domainMetaStore = savedMetaStore;
        zmsImpl.productIdSupport = false;
    }

    @Test
    public void testPutDomainMetaInvalidDomainMetaStoreValues() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "athenz-domain-meta-with-invalid-details";
        DomainMetaStore savedMetaStore = zmsImpl.domainMetaStore;
        zmsImpl.domainMetaStore = new TestDomainMetaStore();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        DomainMeta meta = new DomainMeta().setBusinessService("invalid-business-service");
        try {
            zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid business service name"));
        }

        meta.setBusinessService("valid-business-service");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);

        // second time no-op since value not changed

        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, meta);

        Domain domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getBusinessService(), "valid-business-service");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        zmsImpl.domainMetaStore = savedMetaStore;
    }

    @Test
    public void testPutDomainSystemMetaInvalidDomainMetaStoreValues() {

        final String domainName = "athenz-domain-system-meta-with-invalid-details";
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        DomainMetaStore savedMetaStore = zmsImpl.domainMetaStore;
        zmsImpl.domainMetaStore = new TestDomainMetaStore();

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        // first aws account

        DomainMeta meta = new DomainMeta().setAccount("invalid-aws-account");
        try {
            zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_ACCOUNT, auditRef, meta);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid aws account"));
        }

        meta.setAccount("valid-aws-account");
        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_ACCOUNT, auditRef, meta);

        Domain domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getAccount(), "valid-aws-account");

        // second time no-op since nothing has changed

        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_ACCOUNT, auditRef, meta);

        // next azure subscription

        try {
            meta.setAzureSubscription("invalid-azure-subscription");
            zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_AZURE_SUBSCRIPTION, auditRef, meta);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid azure subscription"));
        }

        meta.setAzureSubscription("valid-azure-subscription");
        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_AZURE_SUBSCRIPTION, auditRef, meta);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getAzureSubscription(), "valid-azure-subscription");

        // second time no-op since nothing has changed

        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_AZURE_SUBSCRIPTION, auditRef, meta);

        // next gcp project

        try {
            meta.setGcpProject("invalid-gcp-project");
            meta.setGcpProjectNumber("1200");
            zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_GCP_PROJECT, auditRef, meta);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid gcp project"));
        }

        // next gcp project without project number

        try {
            meta.setGcpProject("valid-gcp-project");
            meta.setGcpProjectNumber(null);
            zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_GCP_PROJECT, auditRef, meta);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid gcp project"));
        }

        meta.setGcpProject("valid-gcp-project");
        meta.setGcpProjectNumber("1200");
        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_GCP_PROJECT, auditRef, meta);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getGcpProject(), "valid-gcp-project");
        assertEquals(domain.getGcpProjectNumber(), "1200");

        // now keep the gcp project but update the project number

        meta.setGcpProject("valid-gcp-project");
        meta.setGcpProjectNumber("1201");
        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_GCP_PROJECT, auditRef, meta);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getGcpProject(), "valid-gcp-project");
        assertEquals(domain.getGcpProjectNumber(), "1201");

        // second time no-op since nothing has changed

        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_GCP_PROJECT, auditRef, meta);

        // next product id

        zmsImpl.productIdSupport = true;
        try {
            meta.setYpmId(100);
            zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_PRODUCT_ID, auditRef, meta);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid product id"));
        }

        meta.setYpmId(101);
        try {
            meta.setProductId("invalid-product-id");
            zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_PRODUCT_ID, auditRef, meta);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid product id"));
        }

        meta.setProductId("valid-product-id");
        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_PRODUCT_ID, auditRef, meta);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getYpmId().intValue(), 101);

        // final business service

        try {
            meta.setBusinessService("invalid-business-service");
            zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_BUSINESS_SERVICE, auditRef, meta);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("invalid business service"));
        }

        meta.setBusinessService("valid-business-service");
        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_BUSINESS_SERVICE, auditRef, meta);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getBusinessService(), "valid-business-service");

        // second time no-op since nothing has changed

        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_BUSINESS_SERVICE, auditRef, meta);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        zmsImpl.domainMetaStore = savedMetaStore;
        zmsImpl.productIdSupport = false;
    }

    @Test
    public void testPutDomainMetaIDomainMetaStoreException() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "athenz-domain-meta-with-exception";
        DomainMetaStore savedMetaStore = zmsImpl.domainMetaStore;
        zmsImpl.domainMetaStore = new TestDomainMetaStore();

        // value with exc- will throw an exception but we should
        // not reject the request

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setBusinessService("exc-business-service");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Domain domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getBusinessService(), "exc-business-service");

        // try with system attribute now as well

        DomainMeta meta = new DomainMeta().setAccount("exc-aws-account");
        zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_ACCOUNT, auditRef, meta);

        domain = zmsImpl.getDomain(ctx, domainName);
        assertNotNull(domain);
        assertEquals(domain.getAccount(), "exc-aws-account");
        assertEquals(domain.getBusinessService(), "exc-business-service");

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
        zmsImpl.domainMetaStore = savedMetaStore;
    }

    @Test
    public void testPutDomainSystemMetaInvalidDomain() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "athenz-domain-system-meta-not-found";

        DomainMeta meta = new DomainMeta().setAccount("aws-account");
        try {
            zmsImpl.putDomainSystemMeta(ctx, domainName, ZMSConsts.SYSTEM_META_ACCOUNT, auditRef, meta);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), ResourceException.NOT_FOUND);
        }
    }

    @Test
    public void testGetDomainMetaStoreValidValuesList() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        DomainMetaStore savedMetaStore = zmsImpl.domainMetaStore;
        DomainMetaStore mockDomainMetaStore = Mockito.mock(DomainMetaStore.class);
        List<String> awsAccountsList = Collections.singletonList("awsAcc");
        when(mockDomainMetaStore.getValidAWSAccounts(isNull())).thenReturn(awsAccountsList);
        List<String> businessServicesList = Collections.singletonList("bservice");
        when(mockDomainMetaStore.getValidBusinessServices(isNull())).thenReturn(businessServicesList);
        List<String> azureList = Collections.singletonList("azureSub");
        when(mockDomainMetaStore.getValidAzureSubscriptions(isNull())).thenReturn(azureList);
        List<String> gcpList = Collections.singletonList("gcpProject");
        when(mockDomainMetaStore.getValidGcpProjects(isNull())).thenReturn(gcpList);
        List<String> productIdList = Collections.singletonList("product");
        when(mockDomainMetaStore.getValidProductIds(isNull())).thenReturn(productIdList);
        zmsImpl.domainMetaStore = mockDomainMetaStore;
        assertEquals("bservice", zmsImpl.getDomainMetaStoreValidValuesList(ctx, "businessService", null).getValidValues().get(0));
        assertEquals("awsAcc", zmsImpl.getDomainMetaStoreValidValuesList(ctx, "awsAccount", null).getValidValues().get(0));
        assertEquals("azureSub", zmsImpl.getDomainMetaStoreValidValuesList(ctx, "azureSubscription", null).getValidValues().get(0));
        assertEquals("gcpProject", zmsImpl.getDomainMetaStoreValidValuesList(ctx, "gcpProject", null).getValidValues().get(0));
        assertEquals("product", zmsImpl.getDomainMetaStoreValidValuesList(ctx, "productId", null).getValidValues().get(0));
        assertEquals("product", zmsImpl.getDomainMetaStoreValidValuesList(ctx, "productNumber", null).getValidValues().get(0));
        zmsImpl.domainMetaStore = savedMetaStore;
    }

    @Test
    public void testGetDomainMetaStoreValidValuesListEmpty() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        DomainMetaStore savedMetaStore = zmsImpl.domainMetaStore;
        zmsImpl.domainMetaStore = new TestDomainMetaStore();
        DomainMetaStoreValidValuesList emptyValidValuesList = new DomainMetaStoreValidValuesList();
        emptyValidValuesList.setValidValues(new ArrayList<>());
        assertEquals(emptyValidValuesList, zmsImpl.getDomainMetaStoreValidValuesList(ctx, "businessService", null));
        assertEquals(emptyValidValuesList, zmsImpl.getDomainMetaStoreValidValuesList(ctx, "awsAccount", null));
        assertEquals(emptyValidValuesList, zmsImpl.getDomainMetaStoreValidValuesList(ctx, "azureSubscription", null));
        assertEquals(emptyValidValuesList, zmsImpl.getDomainMetaStoreValidValuesList(ctx, "gcpProject", null));
        assertEquals(emptyValidValuesList, zmsImpl.getDomainMetaStoreValidValuesList(ctx, "productId", null));
        zmsImpl.domainMetaStore = savedMetaStore;
    }

    @Test
    public void testGetDomainMetaStoreValidValuesListBadAttribute() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        DomainMetaStore savedMetaStore = zmsImpl.domainMetaStore;
        zmsImpl.domainMetaStore = new TestDomainMetaStore();
        try {
            zmsImpl.getDomainMetaStoreValidValuesList(ctx, "badAttribute", null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"Invalid attribute: badAttribute\"}");
        } finally {
            zmsImpl.domainMetaStore = savedMetaStore;
        }
    }

    @Test
    public void testGetDomainMetaStoreValidValuesListMissingAttribute() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        DomainMetaStore savedMetaStore = zmsImpl.domainMetaStore;
        zmsImpl.domainMetaStore = new TestDomainMetaStore();
        try {
            zmsImpl.getDomainMetaStoreValidValuesList(ctx, null, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getMessage(), "ResourceException (400): {code: 400, message: \"attributeName is mandatory\"}");
        } finally {
            zmsImpl.domainMetaStore = savedMetaStore;
        }
    }

    @Test
    public void testGetDomainMetaStoreValidValuesUsernameLowered() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        DomainMetaStore savedMetaStore = zmsImpl.domainMetaStore;
        DomainMetaStore mockDomainMetaStore = Mockito.mock(DomainMetaStore.class);
        List<String> businessServicesList = Collections.singletonList("bservice");
        when(mockDomainMetaStore.getValidBusinessServices(anyString())).thenReturn(businessServicesList);

        zmsImpl.domainMetaStore = mockDomainMetaStore;
        ArgumentCaptor<String> userCapture = ArgumentCaptor.forClass(String.class);
        zmsImpl.getDomainMetaStoreValidValuesList(ctx, "businessService", "TestUser");
        verify(mockDomainMetaStore, times(1)).getValidBusinessServices(userCapture.capture());

        assertEquals(userCapture.getValue(), "testuser");
        zmsImpl.domainMetaStore = savedMetaStore;
    }

    @Test
    public void testGetUserAuthorityAttributeMap() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();

        Authority savedAuthority = zmsImpl.userAuthority;

        Authority authority = Mockito.mock(Authority.class);

        when(authority.booleanAttributesSupported()).thenReturn(new HashSet<>(Collections.singletonList("boolAttr1")));
        when(authority.dateAttributesSupported()).thenReturn(new HashSet<>(Collections.singletonList("dateAttr1")));
        zmsImpl.userAuthority = authority;
        UserAuthorityAttributeMap attributes = zmsImpl.getUserAuthorityAttributeMap(ctx);
        assertEquals(attributes.getAttributes().size(), 2);
        assertEquals(attributes.getAttributes().get("bool").getValues().size(), 1);
        assertEquals(attributes.getAttributes().get("bool").getValues().get(0), "boolAttr1");

        assertEquals(attributes.getAttributes().get("date").getValues().size(), 1);
        assertEquals(attributes.getAttributes().get("date").getValues().get(0), "dateAttr1");

        zmsImpl.userAuthority = savedAuthority;
    }

    @Test
    public void testPutAssertionConditions() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "put-assertion-conditions";
        String roleName = "role1";
        String polName = "pol1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,"Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john", "user.jane");
        Policy pol = zmsTestInitializer.createPolicyObject(domainName, polName, roleName, "action1", domainName + ":resource1", AssertionEffect.ALLOW);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);
        zmsImpl.putPolicy(ctx, domainName, polName, auditRef, false, null, pol);

        Policy policyResp = zmsImpl.getPolicy(ctx, domainName, polName);
        AssertionConditions acs = new AssertionConditions().setConditionsList(new ArrayList<>());
        AssertionCondition ac1 = createAssertionConditionObject(1, "instances", "HOST1,host2,Host3");
        ac1.getConditionsMap().put("enforcementState", new AssertionConditionData().setValue("ENFORCE")
                .setOperator(AssertionConditionOperator.EQUALS));
        ac1.getConditionsMap().put("scope", new AssertionConditionData().setValue("3")
                .setOperator(AssertionConditionOperator.EQUALS));
        acs.getConditionsList().add(ac1);

        AssertionCondition ac2 = createAssertionConditionObject(2, "instances", "HOST21,host22");
        ac2.getConditionsMap().put("enforcementState", new AssertionConditionData().setValue("REPORT")
                .setOperator(AssertionConditionOperator.EQUALS));
        ac2.getConditionsMap().put("scope", new AssertionConditionData().setValue("3")
                .setOperator(AssertionConditionOperator.EQUALS));
        acs.getConditionsList().add(ac2);

        zmsImpl.putAssertionConditions(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), auditRef, null, acs);

        Response response = zmsImpl.getSignedDomains(ctx, domainName, "false", null, true, true,null);
        SignedDomains sdoms = (SignedDomains) response.getEntity();
        AssertionConditions conditionsResp;
        AssertionCondition conditionResp = new AssertionCondition().setId(1).setConditionsMap(new HashMap<>());
        // zms is going to lowercase data
        conditionResp.getConditionsMap().put("instances", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
        .setValue("host1,host2,host3"));
        conditionResp.getConditionsMap().put("enforcementstate", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("enforce"));
        conditionResp.getConditionsMap().put("scope", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("3"));

        AssertionCondition conditionResp2 = new AssertionCondition().setId(2).setConditionsMap(new HashMap<>());
        // zms is going to lowercase data
        conditionResp2.getConditionsMap().put("instances", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("host21,host22"));
        conditionResp2.getConditionsMap().put("enforcementstate", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("report"));
        conditionResp2.getConditionsMap().put("scope", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("3"));

        for(Policy policy : sdoms.getDomains().get(0).getDomain().getPolicies().getContents().getPolicies()) {
            if ((domainName + ":policy." + polName).equals(policy.getName())) {
                conditionsResp = policy.getAssertions().get(0).getConditions();
                assertNotNull(conditionsResp);
                assertThat(conditionsResp.getConditionsList(), CoreMatchers.hasItems(conditionResp, conditionResp2));
            }
        }
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true).thenReturn(false);
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.putAssertionConditions(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), auditRef, null, acs);
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), ResourceException.BAD_REQUEST);
        }
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.putAssertionConditions(ctx, domainName, "admin", policyResp.getAssertions().get(0).getId(), auditRef, null, acs);
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), ResourceException.BAD_REQUEST);
        }
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutAssertionCondition() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "put-assertion-condition";
        String roleName = "role1";
        String polName = "pol1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,"Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john", "user.jane");
        Policy pol = zmsTestInitializer.createPolicyObject(domainName, polName, roleName, "action1", domainName + ":resource1", AssertionEffect.ALLOW);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);
        zmsImpl.putPolicy(ctx, domainName, polName, auditRef, false, null, pol);

        Policy policyResp = zmsImpl.getPolicy(ctx, domainName, polName);
        AssertionCondition ac1 = createAssertionConditionObject(1, "instances", "HOST1,host2,Host3");
        ac1.setId(null);//insert does not need id
        ac1.getConditionsMap().put("enforcementState", new AssertionConditionData().setValue("ENFORCE")
                .setOperator(AssertionConditionOperator.EQUALS));
        ac1.getConditionsMap().put("scope", new AssertionConditionData().setValue("3")
                .setOperator(AssertionConditionOperator.EQUALS));

        zmsImpl.putAssertionCondition(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), auditRef, null, ac1);

        Response response = zmsImpl.getSignedDomains(ctx, domainName, "false", null, true, true,null);
        SignedDomains sdoms = (SignedDomains) response.getEntity();
        AssertionConditions conditionsResp;
        AssertionCondition conditionResp = new AssertionCondition().setId(1).setConditionsMap(new HashMap<>());
        // zms is going to lowercase data
        conditionResp.getConditionsMap().put("instances", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("host1,host2,host3"));
        conditionResp.getConditionsMap().put("enforcementstate", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("enforce"));
        conditionResp.getConditionsMap().put("scope", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("3"));

        for(Policy policy : sdoms.getDomains().get(0).getDomain().getPolicies().getContents().getPolicies()) {
            if ((domainName + ":policy." + polName).equals(policy.getName())) {
                conditionsResp = policy.getAssertions().get(0).getConditions();
                assertNotNull(conditionsResp);
                assertThat(conditionsResp.getConditionsList(), CoreMatchers.hasItems(conditionResp));
            }
        }
        // update condition
        ac1.setId(1).setConditionsMap(new HashMap<>());
        ac1.getConditionsMap().put("newkey", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("MYVAL"));
        ac1.getConditionsMap().put("enforcementState", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("report"));
        zmsImpl.putAssertionCondition(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), auditRef, null, ac1);

        response = zmsImpl.getSignedDomains(ctx, domainName, "false", null, true, true,null);
        sdoms = (SignedDomains) response.getEntity();

        conditionResp = new AssertionCondition().setId(1).setConditionsMap(new HashMap<>());
        // zms is going to lowercase data
        conditionResp.getConditionsMap().put("enforcementstate", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("report"));
        conditionResp.getConditionsMap().put("newkey", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("myval"));

        for(Policy policy : sdoms.getDomains().get(0).getDomain().getPolicies().getContents().getPolicies()) {
            if ((domainName + ":policy." + polName).equals(policy.getName())) {
                conditionsResp = policy.getAssertions().get(0).getConditions();
                assertNotNull(conditionsResp);
                assertThat(conditionsResp.getConditionsList(), CoreMatchers.hasItems(conditionResp));
            }
        }
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true).thenReturn(false);
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.putAssertionCondition(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), auditRef, null, ac1);
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), ResourceException.BAD_REQUEST);
        }
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.putAssertionCondition(ctx, domainName, "admin", policyResp.getAssertions().get(0).getId(), auditRef, null, ac1);
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), ResourceException.BAD_REQUEST);
        }
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteAssertionConditions() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "delete-assertion-conditions";
        String roleName = "role1";
        String polName = "pol1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,"Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john", "user.jane");
        Policy pol = zmsTestInitializer.createPolicyObject(domainName, polName, roleName, "action1", domainName + ":resource1", AssertionEffect.ALLOW);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);
        zmsImpl.putPolicy(ctx, domainName, polName, auditRef, false, null, pol);

        Policy policyResp = zmsImpl.getPolicy(ctx, domainName, polName);
        AssertionConditions acs = new AssertionConditions().setConditionsList(new ArrayList<>());
        AssertionCondition ac1 = createAssertionConditionObject(1, "instances", "HOST1,host2,Host3");
        ac1.getConditionsMap().put("enforcementState", new AssertionConditionData().setValue("ENFORCE")
                .setOperator(AssertionConditionOperator.EQUALS));
        acs.getConditionsList().add(ac1);

        AssertionCondition ac2 = createAssertionConditionObject(2, "instances", "HOST21,host22");
        ac2.getConditionsMap().put("enforcementState", new AssertionConditionData().setValue("REPORT")
                .setOperator(AssertionConditionOperator.EQUALS));
        acs.getConditionsList().add(ac2);

        zmsImpl.putAssertionConditions(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), auditRef, null, acs);

        Response response = zmsImpl.getSignedDomains(ctx, domainName, "false", null, true, true,null);
        SignedDomains sdoms = (SignedDomains) response.getEntity();
        AssertionConditions conditionsResp;
        AssertionCondition conditionResp = new AssertionCondition().setId(1).setConditionsMap(new HashMap<>());
        // zms is going to lowercase data
        conditionResp.getConditionsMap().put("instances", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("host1,host2,host3"));
        conditionResp.getConditionsMap().put("enforcementstate", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("enforce"));

        // make sure assertion conditions are present first
        for(Policy policy : sdoms.getDomains().get(0).getDomain().getPolicies().getContents().getPolicies()) {
            if ((domainName + ":policy." + polName).equals(policy.getName())) {
                conditionsResp = policy.getAssertions().get(0).getConditions();
                assertNotNull(conditionsResp);
                assertThat(conditionsResp.getConditionsList(), CoreMatchers.hasItems(conditionResp));
            }
        }
        // now delete all condition
        zmsImpl.deleteAssertionConditions(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), auditRef, null);

        response = zmsImpl.getSignedDomains(ctx, domainName, "false", null, true, true,null);
        sdoms = (SignedDomains) response.getEntity();
        for(Policy policy : sdoms.getDomains().get(0).getDomain().getPolicies().getContents().getPolicies()) {
            if ((domainName + ":policy." + polName).equals(policy.getName())) {
                assertNull(policy.getAssertions().get(0).getConditions());
            }
        }
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true).thenReturn(false);
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.deleteAssertionConditions(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), auditRef, null);
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), ResourceException.BAD_REQUEST);
        }
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.deleteAssertionConditions(ctx, domainName, "admin", policyResp.getAssertions().get(0).getId(), auditRef, null);
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), ResourceException.BAD_REQUEST);
        }
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDeleteAssertionCondition() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        String domainName = "delete-assertion-condition";
        String roleName = "role1";
        String polName = "pol1";

        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,"Test Domain1", "testOrg",
                zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);

        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.john", "user.jane");
        Policy pol = zmsTestInitializer.createPolicyObject(domainName, polName, roleName, "action1", domainName + ":resource1", AssertionEffect.ALLOW);
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);
        zmsImpl.putPolicy(ctx, domainName, polName, auditRef, false, null, pol);

        Policy policyResp = zmsImpl.getPolicy(ctx, domainName, polName);
        AssertionCondition ac1 = createAssertionConditionObject(1, "instances", "HOST1,host2,Host3");
        ac1.setId(null);//insert does not need id
        ac1.getConditionsMap().put("enforcementState", new AssertionConditionData().setValue("ENFORCE")
                .setOperator(AssertionConditionOperator.EQUALS));

        zmsImpl.putAssertionCondition(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), auditRef, null, ac1);

        Response response = zmsImpl.getSignedDomains(ctx, domainName, "false", null, true, true,null);
        SignedDomains sdoms = (SignedDomains) response.getEntity();
        AssertionConditions conditionsResp;
        AssertionCondition conditionResp = new AssertionCondition().setId(1).setConditionsMap(new HashMap<>());
        // zms is going to lowercase data
        conditionResp.getConditionsMap().put("instances", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("host1,host2,host3"));
        conditionResp.getConditionsMap().put("enforcementstate", new AssertionConditionData().setOperator(AssertionConditionOperator.EQUALS)
                .setValue("enforce"));

        // make sure assertion conditions are present first
        for (Policy policy : sdoms.getDomains().get(0).getDomain().getPolicies().getContents().getPolicies()) {
            if ((domainName + ":policy." + polName).equals(policy.getName())) {
                conditionsResp = policy.getAssertions().get(0).getConditions();
                assertNotNull(conditionsResp);
                assertThat(conditionsResp.getConditionsList(), CoreMatchers.hasItems(conditionResp));
            }
        }

        // now delete all condition
        zmsImpl.deleteAssertionCondition(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), 1, auditRef, null);

        response = zmsImpl.getSignedDomains(ctx, domainName, "false", null, true, true,null);
        sdoms = (SignedDomains) response.getEntity();
        for(Policy policy : sdoms.getDomains().get(0).getDomain().getPolicies().getContents().getPolicies()) {
            if ((domainName + ":policy." + polName).equals(policy.getName())) {
                assertNull(policy.getAssertions().get(0).getConditions());
            }
        }
        DynamicConfigBoolean dynamicConfigBoolean = Mockito.mock(DynamicConfigBoolean.class);
        when(dynamicConfigBoolean.get()).thenReturn(true).thenReturn(false);
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.deleteAssertionCondition(ctx, domainName, polName, policyResp.getAssertions().get(0).getId(), 1, auditRef, null);
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), ResourceException.BAD_REQUEST);
        }
        zmsImpl.readOnlyMode = dynamicConfigBoolean;
        try {
            zmsImpl.deleteAssertionCondition(ctx, domainName, "admin", policyResp.getAssertions().get(0).getId(), 1, auditRef, null);
            fail();
        } catch(ResourceException re) {
            assertEquals(re.getCode(), ResourceException.BAD_REQUEST);
        }
        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testPutPolicyVersionDirectlyWithErrorCases() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        final String domainName = "put-policy-version-direct";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject(domainName,
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        addRoleNeededForTest(domainName, "Role1");
        addRoleNeededForTest(domainName, "Role2");

        Policy policy1 = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        policy1.setVersion("1");
        policy1.setActive(false);

        // this should be rejected as invalid as version is specified and marked non-active but no policy exists with that name

        try {
            zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // Setting active as null is the same as setting it true. When active and version both null - create new active poicy with version "0"

        policy1.setActive(null);
        policy1.setVersion(null);
        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1);

        Policy policy1NewActive = zmsTestInitializer.createPolicyObject(domainName, "policy1");
        policy1NewActive.setVersion("testversion");
        policy1NewActive.setActive(true);
        Assertion assertion = new Assertion();
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "Role1"));
        assertion.setResource(domainName + ":newpolicyversionnonzero");
        assertion.setAction("newpolicyaction");
        policy1NewActive.getAssertions().add(assertion);

        // this should be rejected as invalid as a policy exists with that name with an active policy version (users should use setActivePolicyVersion endpoint to change active version)

        try {
            zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1NewActive);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        // Same behaviour when active is set to null

        policy1NewActive.setActive(null);
        try {
            zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, policy1NewActive);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        //  now set a new policy name with this version, "testversion", and make it active / keep null - this will create a new policy with version "testversion" instead of the default 0
        policy1NewActive.setName("newpolicy1");
        zmsImpl.putPolicy(ctx, domainName, "newpolicy1", auditRef, false, null, policy1NewActive);
        Policy newpolicy1 = zmsImpl.getPolicy(ctx, domainName, "newpolicy1");
        assertEquals(newpolicy1.getName(), "put-policy-version-direct:policy.newpolicy1");
        assertEquals(newpolicy1.getVersion(), "testversion");
        List<Assertion> assertionsList = newpolicy1.getAssertions();
        assertEquals(assertionsList.size(), 2);
        Assertion originalAssertion = assertionsList.get(0);
        Assertion newAssertion = assertionsList.get(1);
        assertEquals(originalAssertion.getResource(), domainName + ":*");
        assertEquals(newAssertion.getResource(), domainName + ":newpolicyversionnonzero");

        // Make sure it's the only version for this policy
        PolicyList newpolicy11Versions = zmsImpl.getPolicyVersionList(ctx, domainName, "newpolicy1");
        assertEquals(newpolicy11Versions.getNames().size(), 1);
        assertEquals(newpolicy11Versions.getNames().get(0), "testversion");

        // Verify the same behaviour when setting Active as "True" instead of null

        policy1NewActive.setActive(true);
        policy1NewActive.setName("newpolicyactivetrue");
        zmsImpl.putPolicy(ctx, domainName, "newpolicyactivetrue", auditRef, false, null, policy1NewActive);
        newpolicy1 = zmsImpl.getPolicy(ctx, domainName, "newpolicyactivetrue");
        assertEquals(newpolicy1.getName(), "put-policy-version-direct:policy.newpolicyactivetrue");
        assertEquals(newpolicy1.getVersion(), "testversion");
        assertionsList = newpolicy1.getAssertions();
        assertEquals(assertionsList.size(), 2);
        originalAssertion = assertionsList.get(0);
        newAssertion = assertionsList.get(1);
        assertEquals(originalAssertion.getResource(), domainName + ":*");
        assertEquals(newAssertion.getResource(), domainName + ":newpolicyversionnonzero");

        // Make sure it's the only version for this policy
        newpolicy11Versions = zmsImpl.getPolicyVersionList(ctx, domainName, "newpolicyactivetrue");
        assertEquals(newpolicy11Versions.getNames().size(), 1);
        assertEquals(newpolicy11Versions.getNames().get(0), "testversion");

        // now make a copy to the active version which should be rejected as invalid

        try {
            zmsImpl.putPolicyVersion(ctx, domainName, "policy1", new PolicyOptions().setVersion("0"), auditRef, false, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        // make a copy from an unknown version which should be rejected

        try {
            PolicyOptions policyOptions = new PolicyOptions().setVersion("1").setFromVersion("2");
            zmsImpl.putPolicyVersion(ctx, domainName, "policy1", policyOptions, auditRef, false, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 404);
        }

        // make a valid copy of the policy

        zmsImpl.putPolicyVersion(ctx, domainName, "policy1", new PolicyOptions().setVersion("1"), auditRef, false, null);

        // now make a copy from the same version to itself which should be
        // rejected as invalid

        try {
            PolicyOptions policyOptions = new PolicyOptions().setVersion("1").setFromVersion("1");
            zmsImpl.putPolicyVersion(ctx, domainName, "policy1", policyOptions, auditRef, false, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        // try to override from one of the other versions which should be rejected

        try {
            PolicyOptions policyOptions = new PolicyOptions().setVersion("0").setFromVersion("1");
            zmsImpl.putPolicyVersion(ctx, domainName, "policy1", policyOptions, auditRef, false, null);
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }

        Policy activePolicy1 = zmsImpl.getPolicy(ctx, domainName, "policy1");

        Policy verPolicy1 = zmsImpl.getPolicyVersion(ctx, domainName, "policy1", "1");
        assertNotNull(verPolicy1);

        List<Assertion> list = new ArrayList<>();
        list.add(new Assertion().setRole(ResourceUtils.roleResourceName(domainName, "role1"))
                .setResource(domainName + ":resource1").setAction("read"));
        list.add(new Assertion().setRole(ResourceUtils.roleResourceName(domainName, "role2"))
                .setResource(domainName + ":resource2").setAction("write"));
        verPolicy1.setAssertions(list);

        // modify the given version policy

        zmsImpl.putPolicy(ctx, domainName, "policy1", auditRef, false, null, verPolicy1);

        // verify the active policy is not changed

        Policy activePolicy2 = zmsImpl.getPolicy(ctx, domainName, "policy1");
        assertEquals(activePolicy1, activePolicy2);

        // verify version 1 policy is updated

        Policy verPolicy2 = zmsImpl.getPolicyVersion(ctx, domainName, "policy1", "1");
        assertEquals(verPolicy1, verPolicy2);

        zmsImpl.deleteTopLevelDomain(ctx, domainName, auditRef, null);
    }

    @Test
    public void testDomainChangeMessages() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        SubDomain domSysNetwork = zmsTestInitializer.createSubDomainObject("network", "sys", "Test Domain",
                "testOrg", zmsTestInitializer.getAdminUser(), ctx.principal().getFullName());
        zmsImpl.postSubDomain(ctx, "sys", auditRef, null, domSysNetwork);

        // postTopLevelDomain events
        String domainName = "test-dom-change-msg";
        TopLevelDomain dom1 = zmsTestInitializer.createTopLevelDomainObject("test-dom-change-msg",
            "Test description Domain1", "testOrg", zmsTestInitializer.getAdminUser());
        dom1.setAuditEnabled(true);
        
        ctx = zmsTestInitializer.contextWithMockPrincipal("postTopLevelDomain");
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, dom1);
        
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), DOMAIN, domainName, domainName, "postTopLevelDomain");

        // putDomainTemplate events
        DomainTemplate domTemplate = new DomainTemplate();
        List<String> templates = new ArrayList<>();
        templates.add("vipng");
        domTemplate.setTemplateNames(templates);
        ctx = zmsTestInitializer.contextWithMockPrincipal("putDomainTemplate");
        zmsImpl.putDomainTemplate(ctx, domainName, auditRef, domTemplate);
        assertTemplateChanges(domainName, ctx.getDomainChangeMessages(), "putDomainTemplate");

        // deleteDomainTemplate events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteDomainTemplate");
        zmsImpl.deleteDomainTemplate(ctx, domainName, "vipng", auditRef);
        assertTemplateChanges(domainName, ctx.getDomainChangeMessages(), "deleteDomainTemplate");

        // putDomainTemplateExt events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putDomainTemplateExt");
        zmsImpl.putDomainTemplateExt(ctx, domainName, "vipng", auditRef, domTemplate);
        assertTemplateChanges(domainName, ctx.getDomainChangeMessages(), "putDomainTemplateExt");

        // putDomainMeta events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putDomainMeta");
        DomainMeta dm = new DomainMeta().setBusinessService("invalid");
        zmsImpl.putDomainMeta(ctx, domainName, auditRef, null, dm);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), DOMAIN, domainName, domainName, "putDomainMeta");

        // putDomainSystemMeta events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putDomainSystemMeta");
        DomainMeta meta = new DomainMeta().setAuditEnabled(true);
        zmsImpl.putDomainSystemMeta(ctx, domainName, "auditenabled", auditRef, meta);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), DOMAIN, domainName, domainName, "putDomainSystemMeta");

        // putEntity events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putEntity");
        Entity entity1 = zmsTestInitializer.createEntityObject(domainName, "Entity1");
        zmsImpl.putEntity(ctx, domainName, "Entity1", auditRef, entity1);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ENTITY, domainName, "entity1", "putEntity");

        // deleteEntity events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteEntity");
        zmsImpl.deleteEntity(ctx, domainName, "Entity1", auditRef);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ENTITY, domainName, "entity1", "deleteEntity");

        // putRole events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putRole");
        String roleName = "role-test1";
        Role role = zmsTestInitializer.createRoleObject(domainName, roleName, null, "user.user101", "user.todelete");
        zmsImpl.putRole(ctx, domainName, roleName, auditRef, false, null, role);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "putRole");

        // putRoleMeta events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putRoleMeta");
        RoleMeta rm = ZMSTestUtils.createRoleMetaObject(true);
        zmsImpl.putRoleMeta(ctx, domainName, roleName, "auditenabled", null, rm);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "putRoleMeta");

        // putMembership events using user.doe principal
        ctx = zmsTestInitializer.contextWithMockPrincipal("putMembership", "doe");
        
        Membership mbr = new Membership();
        mbr.setMemberName("user.doe");
        mbr.setActive(false);
        mbr.setApproved(false);

        zmsImpl.putMembership(ctx, domainName, roleName, "user.doe", auditRef, false, null, mbr);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "putMembership");
        
        // putRoleReview events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putRoleReview");
        
        Role inputRole = new Role().setName(roleName);
        List<RoleMember> inputMembers = new ArrayList<>();
        inputRole.setRoleMembers(inputMembers);
        inputMembers.add(new RoleMember().setMemberName("user.doe").setActive(false));
        zmsImpl.putRoleReview(ctx, domainName, roleName, auditRef, false, null, inputRole);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "putRoleReview");
        
        // putMembershipDecision events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putMembershipDecision");
        mbr.setActive(true);
        mbr.setApproved(true);
        zmsImpl.putMembershipDecision(ctx, domainName, roleName, "user.doe", auditRef, mbr);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "putMembershipDecision");

        // putMembership events using user.pend principal
        ctx = zmsTestInitializer.contextWithMockPrincipal("putMembership", "pend");

        Membership mbr1 = new Membership();
        mbr1.setMemberName("user.pend");
        mbr1.setActive(false);
        mbr1.setApproved(false);

        zmsImpl.putMembership(ctx, domainName, roleName, "user.pend", auditRef, false, null, mbr1);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "putMembership");

        // deletePendingMembership events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deletePendingMembership");
        zmsImpl.deletePendingMembership(ctx, domainName, roleName, "user.pend", auditRef);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "deletePendingMembership");
        
        // deleteMembership events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteMembership");
        zmsImpl.deleteMembership(ctx, domainName, roleName, "user.doe", auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "deleteMembership");

        // putRoleSystemMeta events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putRoleSystemMeta");
        RoleSystemMeta rsm = ZMSTestUtils.createRoleSystemMetaObject(true);
        zmsImpl.putRoleSystemMeta(ctx, domainName, roleName, "auditenabled", auditRef, rsm);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "putRoleSystemMeta");
    
        // deleteRole events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteRole");
        zmsImpl.deleteRole(ctx, domainName, roleName, auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, roleName, "deleteRole");

        // putDefaultAdmins events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putDefaultAdmins");
        List<String> adminList = Arrays.asList("user.newadmin", zmsTestInitializer.getAdminUser());
        DefaultAdmins admins = new DefaultAdmins().setAdmins(adminList);
        zmsImpl.putDefaultAdmins(ctx, domainName, auditRef, admins);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, "admin", "putDefaultAdmins");

        // putGroup events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putGroup");
        String groupName = "group-test1";
        Group group = zmsTestInitializer.createGroupObject(domainName, groupName, "user.user12", "user.user101");
        zmsImpl.putGroup(ctx, domainName, groupName, auditRef, false, null, group);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName, groupName, "putGroup");

        // putGroupMeta events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putGroupMeta");
        GroupMeta gm = new GroupMeta().setSelfServe(true);
        zmsImpl.putGroupMeta(ctx, domainName, groupName, "auditenabled", null, gm);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName, groupName, "putGroupMeta");

        // putGroupMembership events using user.doe principal
        ctx = zmsTestInitializer.contextWithMockPrincipal("putGroupMembership", "doe");

        GroupMembership gmbr = new GroupMembership();
        gmbr.setMemberName("user.doe");
        gmbr.setActive(false);
        gmbr.setApproved(false);

        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.doe", auditRef, false, null, gmbr);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName, groupName, "putGroupMembership");
        
        // putGroupReview events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putGroupReview");

        Group inputGroup = new Group().setName(groupName);
        List<GroupMember> gInputMembers = new ArrayList<>();
        inputGroup.setGroupMembers(gInputMembers);
        gInputMembers.add(new GroupMember().setMemberName("user.doe").setActive(false));
        zmsImpl.putGroupReview(ctx, domainName, groupName, auditRef, false, null, inputGroup);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName, groupName, "putGroupReview");

        // putGroupMembershipDecision events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putGroupMembershipDecision");
        mbr.setActive(true);
        mbr.setApproved(true);
        zmsImpl.putGroupMembershipDecision(ctx, domainName, groupName, "user.doe", auditRef, gmbr);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName,
                groupName, "putGroupMembershipDecision");

        // putGroupMembership events using user.pend principal
        ctx = zmsTestInitializer.contextWithMockPrincipal("putGroupMembership", "pend");

        GroupMembership gmbr1 = new GroupMembership();
        gmbr1.setMemberName("user.pend");
        gmbr1.setActive(false);
        gmbr1.setApproved(false);

        zmsImpl.putGroupMembership(ctx, domainName, groupName, "user.pend", auditRef, false, null, gmbr1);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName,
                groupName, "putGroupMembership");

        // deletePendingGroupMembership events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deletePendingGroupMembership");
        zmsImpl.deletePendingGroupMembership(ctx, domainName, groupName, "user.pend", auditRef);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName,
                groupName, "deletePendingGroupMembership");

        // deleteGroupMembership events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteGroupMembership");
        zmsImpl.deleteGroupMembership(ctx, domainName, groupName, "user.user12", auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName,
                groupName, "deleteGroupMembership");

        // putGroupSystemMeta events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putGroupSystemMeta");
        GroupSystemMeta gsm = createGroupSystemMetaObject(true);
        zmsImpl.putGroupSystemMeta(ctx, domainName, groupName, "auditenabled", auditRef, gsm);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName, groupName, "putGroupSystemMeta");

        // deleteGroup events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteGroup");
        zmsImpl.deleteGroup(ctx, domainName, groupName, auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), GROUP, domainName, groupName, "deleteGroup");

        // putPolicy events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putPolicy");
        String policyName = "test-policy";
        Policy policy = zmsTestInitializer.createPolicyObject(domainName, policyName);
        zmsImpl.putPolicy(ctx, domainName, policyName, auditRef, false, null, policy);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName, policyName, "putPolicy");

        // putAssertion events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putAssertion");
        Assertion assertion = new Assertion();
        assertion.setAction("update");
        assertion.setEffect(AssertionEffect.ALLOW);
        assertion.setResource(domainName + ":resource");
        assertion.setRole(ResourceUtils.roleResourceName(domainName, "admin"));
        assertion = zmsImpl.putAssertion(ctx, domainName, policyName, auditRef, null, assertion);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName, policyName, "putAssertion");

        // deleteAssertion events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteAssertion");
        zmsImpl.deleteAssertion(ctx, domainName, policyName, assertion.getId(), auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName, policyName, "deleteAssertion");
        
        // putPolicyVersion events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putPolicyVersion");
        String newVersion = "new-version";
        zmsImpl.putPolicyVersion(ctx, domainName, policyName,
                new PolicyOptions().setVersion(newVersion), auditRef, false, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName, policyName, "putPolicyVersion");

        // putAssertionPolicyVersion events
        addRoleNeededForTest(domainName, "Role1");
        ctx = zmsTestInitializer.contextWithMockPrincipal("putAssertionPolicyVersion");
        Assertion assertionWithVersion = new Assertion();
        assertionWithVersion.setAction("testAction");
        assertionWithVersion.setEffect(AssertionEffect.DENY);
        assertionWithVersion.setResource(domainName + ":test-resource");
        assertionWithVersion.setRole(ResourceUtils.roleResourceName(domainName, "Role1"));
        assertionWithVersion = zmsImpl.putAssertionPolicyVersion(ctx, domainName, policyName,
                newVersion, auditRef, null, assertionWithVersion);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName,
                policyName, "putAssertionPolicyVersion");

        // setActivePolicyVersion events
        ctx = zmsTestInitializer.contextWithMockPrincipal("setActivePolicyVersion");
        zmsImpl.setActivePolicyVersion(ctx, domainName, policyName,
                new PolicyOptions().setVersion(newVersion), auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName,
                policyName, "setActivePolicyVersion");

        // deleteAssertionPolicyVersion events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteAssertionPolicyVersion");
        zmsImpl.deleteAssertionPolicyVersion(ctx, domainName, policyName, newVersion,
                assertionWithVersion.getId(), auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName,
                policyName, "deleteAssertionPolicyVersion");

        // deletePolicyVersion events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deletePolicyVersion");
        zmsImpl.putPolicyVersion(ctx, domainName, policyName,
                new PolicyOptions().setVersion("versionToDelete"), auditRef, false, null);
        zmsImpl.deletePolicyVersion(ctx, domainName, policyName, "versionToDelete", auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName,
                policyName, "deletePolicyVersion");

        // putAssertionCondition events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putAssertionCondition");
        String policyConditionName = "test-policy-cond";
        Policy policyCondition = zmsTestInitializer.createPolicyObject(domainName, policyConditionName);
        zmsImpl.putPolicy(ctx, domainName, policyConditionName, auditRef, false, null, policyCondition);
        policyCondition = zmsImpl.getPolicy(ctx, domainName, policyConditionName);
        Long assertionId = policyCondition.getAssertions().get(0).getId();
        AssertionCondition ac = createAssertionConditionObject(1, "instances", "HOST1,host2,Host3");
        ac.setId(null);
        ac = zmsImpl.putAssertionCondition(ctx, domainName, policyConditionName, assertionId, auditRef, null, ac);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName,
                policyConditionName, "putAssertionCondition");

        // putAssertionConditions events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putAssertionConditions");
        AssertionConditions acs = new AssertionConditions().setConditionsList(Collections.singletonList(ac));
        zmsImpl.putAssertionConditions(ctx, domainName, policyConditionName, assertionId, auditRef, null, acs);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName,
                policyConditionName, "putAssertionConditions");

        // deleteAssertionCondition events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteAssertionCondition");
        zmsImpl.deleteAssertionCondition(ctx, domainName, policyConditionName, assertionId, 1, auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName,
                policyConditionName, "deleteAssertionCondition");
        
        // deleteAssertionConditions events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteAssertionConditions");
        zmsImpl.deleteAssertionConditions(ctx, domainName, policyConditionName, assertionId, auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName,
                policyConditionName, "deleteAssertionConditions");

        // deletePolicy events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deletePolicy");
        zmsImpl.deletePolicy(ctx, domainName, policyConditionName, auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, domainName,
                policyConditionName, "deletePolicy");
        
        // putServiceIdentity events
        String serviceName = "test-srv";
        ServiceIdentity service = zmsTestInitializer.createServiceObject(domainName, serviceName,
            "http://localhost", "/usr/bin/test", "root", "users", "host1");
        ctx = zmsTestInitializer.contextWithMockPrincipal("putServiceIdentity");
        zmsImpl.putServiceIdentity(ctx, domainName, serviceName, auditRef, false, null, service);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), SERVICE, domainName,
                serviceName, "putServiceIdentity");

        // putPublicKeyEntry events
        PublicKeyEntry keyEntry = new PublicKeyEntry();
        keyEntry.setId("1");
        keyEntry.setKey(zmsTestInitializer.getPubKeyK2());

        ctx = zmsTestInitializer.contextWithMockPrincipal("putPublicKeyEntry");
        zmsImpl.putPublicKeyEntry(ctx, domainName, serviceName, "1", auditRef, null, keyEntry);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), SERVICE, domainName,
                serviceName, "putPublicKeyEntry");

        // deletePublicKeyEntry events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deletePublicKeyEntry");
        zmsImpl.deletePublicKeyEntry(ctx, domainName, serviceName, "1", auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), SERVICE, domainName,
                serviceName, "deletePublicKeyEntry");

        // putServiceIdentitySystemMeta events
        ServiceIdentitySystemMeta srvIdMeta = new ServiceIdentitySystemMeta();
        srvIdMeta.setProviderEndpoint("https://localhost");
        ctx = zmsTestInitializer.contextWithMockPrincipal("putServiceIdentitySystemMeta");
        zmsImpl.putServiceIdentitySystemMeta(ctx, domainName, serviceName, "providerendpoint", auditRef, srvIdMeta);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), SERVICE, domainName,
                serviceName, "putServiceIdentitySystemMeta");

        // putTenancy events
        String tenantDomainName = domainName + "-tenant";
        TopLevelDomain tenDom = zmsTestInitializer.createTopLevelDomainObject(tenantDomainName,
            "Test Tenant Provider Domain", "testOrg", zmsTestInitializer.getAdminUser());
        zmsImpl.postTopLevelDomain(ctx, auditRef, null, tenDom);
        
        Tenancy tenancy = zmsTestInitializer.createTenantObject(tenantDomainName, domainName + "." + serviceName);
        ctx = zmsTestInitializer.contextWithMockPrincipal("putTenancy");
        zmsImpl.putTenancy(ctx, tenantDomainName, domainName + "." + serviceName, auditRef, tenancy);
        List<DomainChangeMessage> changeMsgs = ctx.getDomainChangeMessages();
        assertEquals(changeMsgs.size(), 2);
        ZMSTestUtils.assertChange(changeMsgs.get(0), ROLE, tenantDomainName,
                "test-dom-change-msg-tenant:role.tenancy.test-dom-change-msg.test-srv.admin", "putTenancy");
        ZMSTestUtils.assertChange(changeMsgs.get(1), POLICY, tenantDomainName,
                "test-dom-change-msg-tenant:policy.tenancy.test-dom-change-msg.test-srv.admin", "putTenancy");
        
        // deleteTenancy events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteTenancy");
        zmsImpl.deleteTenancy(ctx, tenantDomainName, domainName + "." + serviceName, auditRef);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), POLICY, tenantDomainName,
                "tenancy.test-dom-change-msg.test-srv.admin", "deleteTenancy");

        // putTenant events
        String tenantServiceName = serviceName + "-tenant";
        ServiceIdentity tenantService = zmsTestInitializer.createServiceObject(tenantDomainName, tenantServiceName,
            "http://localhost", "/usr/bin/test", "root", "users", "host1");
        zmsImpl.putServiceIdentity(ctx, tenantDomainName, tenantServiceName, auditRef, false, null, tenantService);
        
        ctx = zmsTestInitializer.contextWithMockPrincipal("putTenant");
        Tenancy tenant = new Tenancy().setDomain(tenantDomainName).setService(domainName + "." + serviceName);
        zmsImpl.putTenant(ctx, domainName, serviceName, tenantDomainName, auditRef, tenant);
        changeMsgs = ctx.getDomainChangeMessages();
        assertEquals(changeMsgs.size(), 2);
        ZMSTestUtils.assertChange(changeMsgs.get(0), ROLE, domainName,
                "test-srv.tenant.test-dom-change-msg-tenant.admin", "putTenant");
        ZMSTestUtils.assertChange(changeMsgs.get(1), POLICY, domainName,
                "test-srv.tenant.test-dom-change-msg-tenant.admin", "putTenant");
        
        // deleteTenant events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteTenant");
        zmsImpl.deleteTenant(ctx, domainName, serviceName, tenantDomainName, auditRef);
        changeMsgs = ctx.getDomainChangeMessages();
        assertEquals(changeMsgs.size(), 2);
        ZMSTestUtils.assertChange(changeMsgs.get(0), ROLE, domainName,
                "test-srv.tenant.test-dom-change-msg-tenant.admin", "deleteTenant");
        ZMSTestUtils.assertChange(changeMsgs.get(1), POLICY, domainName,
                "test-srv.tenant.test-dom-change-msg-tenant.admin", "deleteTenant");

        // putProviderResourceGroupRoles events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putProviderResourceGroupRoles");
        ProviderResourceGroupRoles providerRoles = new ProviderResourceGroupRoles()
            .setDomain(domainName).setService(serviceName)
            .setTenant(tenantDomainName).setRoles(Collections.singletonList(
                    new TenantRoleAction().setRole("role").setAction("action")))
            .setResourceGroup("set1-test");
        zmsImpl.putProviderResourceGroupRoles(ctx, tenantDomainName, domainName, serviceName,
                "set1-test", auditRef, providerRoles);
        changeMsgs = ctx.getDomainChangeMessages();
        assertEquals(changeMsgs.size(), 2);
        ZMSTestUtils.assertChange(changeMsgs.get(0), POLICY, tenantDomainName,
                "test-dom-change-msg-tenant:policy.tenancy.test-dom-change-msg.test-srv.admin",
                "putProviderResourceGroupRoles");
        ZMSTestUtils.assertChange(changeMsgs.get(1), ROLE, tenantDomainName,
                "test-dom-change-msg.test-srv.res_group.set1-test.role", "putProviderResourceGroupRoles");

        // putTenantResourceGroupRoles events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putTenantResourceGroupRoles");
        TenantResourceGroupRoles tenantRoles = new TenantResourceGroupRoles().setDomain(domainName)
            .setService(serviceName).setTenant(tenantDomainName)
            .setRoles(Collections.singletonList(new TenantRoleAction().setRole("role").setAction("action")))
            .setResourceGroup("set1-test");

        zmsImpl.putTenantResourceGroupRoles(ctx, domainName, serviceName,
                tenantDomainName, "set1-test", auditRef, tenantRoles);

        changeMsgs = ctx.getDomainChangeMessages();
        assertEquals(changeMsgs.size(), 2);
        ZMSTestUtils.assertChange(changeMsgs.get(0), ROLE, domainName,
                "test-srv.tenant.test-dom-change-msg-tenant.admin", "putTenantResourceGroupRoles");
        ZMSTestUtils.assertChange(changeMsgs.get(1), POLICY, domainName,
                "test-srv.tenant.test-dom-change-msg-tenant.admin", "putTenantResourceGroupRoles");

        // deleteTenantResourceGroupRoles events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteTenantResourceGroupRoles");
        zmsImpl.deleteTenantResourceGroupRoles(ctx, domainName, serviceName, tenantDomainName, "set1-test", auditRef);

        changeMsgs = ctx.getDomainChangeMessages();
        assertEquals(changeMsgs.size(), 2);
        ZMSTestUtils.assertChange(changeMsgs.get(0), ROLE, domainName,
                "test-srv.tenant.test-dom-change-msg-tenant.res_group.set1-test.role",
                "deleteTenantResourceGroupRoles");
        ZMSTestUtils.assertChange(changeMsgs.get(1), POLICY, domainName,
                "test-srv.tenant.test-dom-change-msg-tenant.res_group.set1-test.role",
                "deleteTenantResourceGroupRoles");

        // deleteProviderResourceGroupRoles events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteProviderResourceGroupRoles");
        zmsImpl.deleteProviderResourceGroupRoles(ctx, tenantDomainName, domainName,
                serviceName, "set1-test", auditRef);
        changeMsgs = ctx.getDomainChangeMessages();
        assertSingleChangeMessage(changeMsgs, POLICY, tenantDomainName,
                "tenancy.test-dom-change-msg.test-srv.res_group.set1-test.role",
                "deleteProviderResourceGroupRoles");
        
        // deleteTenant events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteTenant");
        zmsImpl.deleteTenant(ctx, domainName, serviceName, tenantDomainName, auditRef);
        changeMsgs = ctx.getDomainChangeMessages();
        assertEquals(changeMsgs.size(), 2);
        ZMSTestUtils.assertChange(changeMsgs.get(0), ROLE, domainName, "test-srv.tenant.test-dom-change-msg-tenant.admin",
                "deleteTenant");
        ZMSTestUtils.assertChange(changeMsgs.get(1), POLICY, domainName, "test-srv.tenant.test-dom-change-msg-tenant.admin",
                "deleteTenant");

        // deleteServiceIdentity events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteServiceIdentity");
        zmsImpl.deleteServiceIdentity(ctx, domainName, serviceName, auditRef, null);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), SERVICE, domainName, serviceName,
                "deleteServiceIdentity");

        // deleteDomainRoleMember events
        role = zmsTestInitializer.createRoleObject(domainName, "some-role", null, "user.user222", "user.todelete");
        zmsImpl.putRole(ctx, domainName, "some-role", auditRef, false, null, role);
        
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteDomainRoleMember");
        zmsImpl.deleteDomainRoleMember(ctx, domainName, "user.todelete", auditRef);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), ROLE, domainName, "some-role",
                "deleteDomainRoleMember");

        // putQuota events
        ctx = zmsTestInitializer.contextWithMockPrincipal("putQuota");
        Quota quota = new Quota().setName(domainName)
            .setRole(14).setRoleMember(15).setGroup(16);
        zmsImpl.putQuota(ctx, domainName, auditRef, quota);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), DOMAIN, domainName, domainName, "putQuota");

        // deleteQuota events
        ctx = zmsTestInitializer.contextWithMockPrincipal("deleteQuota");
        zmsImpl.deleteQuota(ctx, domainName, auditRef);
        assertSingleChangeMessage(ctx.getDomainChangeMessages(), DOMAIN, domainName, domainName, "deleteQuota");
        
        // postSubDomain events
        RsrcCtxWrapper subCtx = zmsTestInitializer.contextWithMockPrincipal("postSubDomain");

        SubDomain subDomain = zmsTestInitializer.createSubDomainObject("AddSubDom1", domainName,
            "Test Domain2", null, zmsTestInitializer.getAdminUser());
        zmsImpl.postSubDomain(subCtx,domainName, auditRef, null, subDomain);
        assertSingleChangeMessage(subCtx.getDomainChangeMessages(), DOMAIN, "test-dom-change-msg.addsubdom1",
                "test-dom-change-msg.addsubdom1", "postSubDomain");

        // deleteSubDomain events
        RsrcCtxWrapper deleteCtx = zmsTestInitializer.contextWithMockPrincipal("deleteSubDomain");
        zmsImpl.deleteSubDomain(deleteCtx, domainName, "AddSubDom1", auditRef, null);
        assertSingleChangeMessage(deleteCtx.getDomainChangeMessages(), DOMAIN, "test-dom-change-msg.addsubdom1",
                "test-dom-change-msg.addsubdom1", "deleteSubDomain");

        // deleteTopLevelDomain events
        deleteCtx = zmsTestInitializer.contextWithMockPrincipal("deleteTopLevelDomain");
        zmsImpl.deleteTopLevelDomain(deleteCtx, domainName, auditRef, null);
        assertSingleChangeMessage(deleteCtx.getDomainChangeMessages(), DOMAIN,
                domainName, domainName, "deleteTopLevelDomain");

        zmsImpl.deleteSubDomain(ctx, "sys", "network", auditRef, null);
    }
    
    private void assertSingleChangeMessage(List<DomainChangeMessage> changeMsgs, DomainChangeMessage.ObjectType objType,
                                           String domainName, String objName, String apiName) {
        assertEquals(changeMsgs.size(), 1);
        ZMSTestUtils.assertChange(changeMsgs.get(0), objType, domainName, objName, apiName);
    }

    private void assertTemplateChanges(String domainName, List<DomainChangeMessage> changeMsgs, String templateApi) {
        assertEquals(changeMsgs.size(), 2);
        ZMSTestUtils.assertChange(changeMsgs.get(0), ROLE, domainName, "vip_admin", templateApi);
        ZMSTestUtils.assertChange(changeMsgs.get(1), POLICY, domainName, "vip_admin", templateApi);
    }

    @Test
    public void testInvalidPublisherFactory() {
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES, "topic1,topic2");
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS, "com.yahoo.athenz.common.messaging.NonExistingFactory");

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        assertEquals(zmsImpl.domainChangePublishers.size(), 0);

        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES);
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS);
    }

    @Test
    public void testInvalidPublisher() {
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES, "topic1,topic2");
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS, "com.yahoo.athenz.zms.FaultyDomainChangeFactory");

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        assertEquals(zmsImpl.domainChangePublishers.size(), 0);

        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES);
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS);
    }

    @Test
    public void testNoConfiguredTopic() {
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES);
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        assertEquals(zmsImpl.domainChangePublishers.size(), 0);
    }

    @Test
    public void testMultipleTopics() {
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS, "com.yahoo.athenz.common.messaging.MockDomainChangePublisherFactory");
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES, "topic1 , topic2");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        assertNotNull(zmsImpl.domainChangePublishers);
        List<String> topicNames = zmsImpl.domainChangePublishers.stream()
            .map(publisher -> ((MockDomainChangePublisher) publisher).getTopicName())
            .collect(Collectors.toList());
        assertThat(topicNames, containsInAnyOrder("topic1", "topic2"));
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES);
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS);
    }

    @Test
    public void testPublishEvent() {
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS, "com.yahoo.athenz.common.messaging.MockDomainChangePublisherFactory");
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES, "topic1");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        assertNotNull(zmsImpl.domainChangePublishers);
        List<String> topicNames = zmsImpl.domainChangePublishers.stream()
            .map(publisher -> ((MockDomainChangePublisher) publisher).getTopicName())
            .collect(Collectors.toList());
        assertThat(topicNames, containsInAnyOrder("topic1"));

        ResourceContext mockContext = Mockito.mock(ResourceContext.class);
        when(mockContext.getApiName()).thenReturn("apiName");
        when(mockContext.getDomainChangeMessages()).
            thenReturn(Collections.singletonList(new DomainChangeMessage()
                .setDomainName("domainName")
                .setObjectName("objectName")
                .setObjectType(DOMAIN)
                .setApiName("apiName")
                .setPublished(Instant.now().toEpochMilli())
                .setMessageId(java.util.UUID.randomUUID().toString())
            ));
        zmsImpl.publishChangeMessage(mockContext, 200);

        // verify publish messages
        MockDomainChangePublisher.Recorder evtRecorder = getEventRecorder(zmsImpl);
        ArgumentCaptor<DomainChangeMessage> evtArgumentCaptor = ArgumentCaptor.forClass(DomainChangeMessage.class);
        verify(evtRecorder, Mockito.times(1)).record(evtArgumentCaptor.capture());
        DomainChangeMessage actual = evtArgumentCaptor.getValue();
        assertEquals(actual.getDomainName(), "domainName");
        assertEquals(actual.getApiName(), "apiName");
        assertEquals(actual.getObjectType(), DOMAIN);
        assertEquals(actual.getObjectName(), "objectName");

        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS);
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES);
    }

    private MockDomainChangePublisher.Recorder getEventRecorder(ZMSImpl zmsImpl) {
        return ((MockDomainChangePublisher) zmsImpl.domainChangePublishers.get(0)).getRecorder();
    }
    
    @Test
    public void testPublisherNonSuccessErrorCode() {
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS, "com.yahoo.athenz.common.messaging.MockDomainChangePublisherFactory");
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES, "topic1 , topic2");
        
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        String apiName = "postTopLevelDomain";
        ResourceContext mockContext = Mockito.mock(ResourceContext.class);
        when(mockContext.getApiName()).thenReturn(apiName);
        when(mockContext.getDomainChangeMessages()).thenReturn(Collections.singletonList(new DomainChangeMessage()));
        zmsImpl.publishChangeMessage(mockContext, 500);

        // verify no publish messages
        MockDomainChangePublisher.Recorder evtRecorder = getEventRecorder(zmsImpl);
        ArgumentCaptor<DomainChangeMessage> evtArgumentCaptor = ArgumentCaptor.forClass(DomainChangeMessage.class);
        verify(evtRecorder, Mockito.times(0)).record(evtArgumentCaptor.capture());
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS);
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES);
    }
    
    @Test
    public void testEmptyTopicName() {
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS, "com.yahoo.athenz.common.messaging.MockDomainChangePublisherFactory");
        System.setProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES, "topic1 , , topic2");
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        assertNotNull(zmsImpl.domainChangePublishers);
        assertEquals(zmsImpl.domainChangePublishers.size(), 2);
        List<String> topicNames = zmsImpl.domainChangePublishers.stream()
            .map(publisher -> ((MockDomainChangePublisher) publisher).getTopicName())
            .collect(Collectors.toList());
        assertThat(topicNames, containsInAnyOrder("topic1", "topic2"));
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_PUBLISHER_FACTORY_CLASS);
        System.clearProperty(ZMS_PROP_DOMAIN_CHANGE_TOPIC_NAMES);
    }

    @Test
    public void testNoPublishers() {
        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        String apiName = "postTopLevelDomain";
        ResourceContext mockContext = Mockito.mock(ResourceContext.class);
        when(mockContext.getApiName()).thenReturn(apiName);
        when(mockContext.getDomainChangeMessages()).thenReturn(Collections.singletonList(new DomainChangeMessage()));

        assertEquals(zmsImpl.domainChangePublishers.size(), 0);
        zmsImpl.publishChangeMessage(mockContext, 200);
    }

    @Test
    public void testPublisherException() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        String apiName = "postTopLevelDomain";
        ResourceContext mockContext = Mockito.mock(ResourceContext.class);
        when(mockContext.getApiName()).thenReturn(apiName);
        when(mockContext.getDomainChangeMessages()).thenReturn(Collections.singletonList(new DomainChangeMessage()));

        MockDomainChangePublisher mockDomainChangePublisher = new MockDomainChangePublisher("domainChanges");
        mockDomainChangePublisher.setThrowPublishExceptions(true);
        zmsImpl.domainChangePublishers = new ArrayList<>();
        zmsImpl.domainChangePublishers.add(mockDomainChangePublisher);

        // make sure no exceptions are thrown since we should catch and log them
        zmsImpl.publishChangeMessage(mockContext, 200);
    }

    @Test
    public void testTimerMetricException() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        String apiName = "postTopLevelDomain";
        RsrcCtxWrapper mockContext = Mockito.mock(RsrcCtxWrapper.class);
        when(mockContext.getApiName()).thenReturn(apiName);
        when(mockContext.getTimerMetric()).thenThrow(new IllegalArgumentException());

        // make sure no exceptions are thrown since we should catch and log them
        zmsImpl.recordMetrics(mockContext, 200);
    }

    @Test
    public void testIsSysAdminRoleMemberNotFoundRole() {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();

        DBService dbService = Mockito.mock(DBService.class);
        when(dbService.getRole("sys.auth", "admin", false, true, false)).thenReturn(null);
        zmsImpl.dbService = dbService;

        assertFalse(zmsImpl.isSysAdminRoleMember("user.testadminuser"));
    }

    @Test
    public void testGetInfo() throws URISyntaxException, FileNotFoundException {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.serverInfo = null;

        RsrcCtxWrapper mockContext = Mockito.mock(RsrcCtxWrapper.class);
        HttpServletRequest mockRequest = Mockito.mock(HttpServletRequest.class);
        when(mockRequest.isSecure()).thenReturn(true);
        when(mockContext.request()).thenReturn(mockRequest);
        ServletContext mockServletContext = Mockito.mock(ServletContext.class);
        when(mockContext.servletContext()).thenReturn(mockServletContext);

        FileInputStream inputStream = new FileInputStream(
                new File(getClass().getClassLoader().getResource("manifest.mf").toURI()));
        when(mockServletContext.getResourceAsStream("/META-INF/MANIFEST.MF")).thenReturn(inputStream);

        Info info = zmsImpl.getInfo(mockContext);
        assertNotNull(info);
        assertEquals(info.getImplementationVersion(), "1.11.0");
        assertEquals(info.getBuildJdkSpec(), "17");
        assertEquals(info.getImplementationTitle(), "zms");
        assertEquals(info.getImplementationVendor(), "athenz");

        // this should be no-op since we already have an info object

        zmsImpl.fetchInfoFromManifest(mockServletContext);

        // this should just return our previously generated info object

        info = zmsImpl.getInfo(mockContext);
        assertNotNull(info);
        assertEquals(info.getImplementationVersion(), "1.11.0");
        assertEquals(info.getBuildJdkSpec(), "17");
        assertEquals(info.getImplementationTitle(), "zms");
        assertEquals(info.getImplementationVendor(), "athenz");
    }

    @Test
    public void testGetInfoException() throws URISyntaxException, FileNotFoundException {

        ZMSImpl zmsImpl = zmsTestInitializer.zmsInit();
        zmsImpl.serverInfo = null;

        RsrcCtxWrapper mockContext = Mockito.mock(RsrcCtxWrapper.class);
        HttpServletRequest mockRequest = Mockito.mock(HttpServletRequest.class);
        when(mockRequest.isSecure()).thenReturn(true);
        when(mockContext.request()).thenReturn(mockRequest);
        ServletContext mockServletContext = Mockito.mock(ServletContext.class);
        when(mockContext.servletContext()).thenReturn(mockServletContext);
        when(mockServletContext.getResourceAsStream("/META-INF/MANIFEST.MF")).thenThrow(new IllegalArgumentException());

        Info info = zmsImpl.getInfo(mockContext);
        assertNotNull(info);
        assertNull(info.getImplementationVersion());
        assertNull(info.getBuildJdkSpec());
        assertNull(info.getImplementationTitle());
        assertNull(info.getImplementationVendor());
    }

    private void insertExpiredMembersToDB (ZMSImpl zms, ResourceContext ctx, String auditRef) {

        int memberPurgeExpiryDays = ZMS_PURGE_MEMBER_EXPIRY_DAYS_DEF + 150;

        List <RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(zmsTestInitializer.createRoleMemberWithExpiration("user.test1", true, memberPurgeExpiryDays));
        roleMembers.add(zmsTestInitializer.createRoleMemberWithExpiration("user.test2", true, memberPurgeExpiryDays - 10));
        roleMembers.add(zmsTestInitializer.createRoleMemberWithExpiration("user.test3", true, ZMS_PURGE_MEMBER_EXPIRY_DAYS_DEF - 1));
        roleMembers.add(zmsTestInitializer.createRoleMemberWithExpiration("user.test4", false, memberPurgeExpiryDays));
        roleMembers.add(new RoleMember().setMemberName("user.test5"));

        List <GroupMember> groupMembers = new ArrayList<>();
        groupMembers.add(zmsTestInitializer.createGroupMemberWithExpiration("user.test1", true, memberPurgeExpiryDays));
        groupMembers.add(zmsTestInitializer.createGroupMemberWithExpiration("user.test2", true, memberPurgeExpiryDays - 10));
        groupMembers.add(zmsTestInitializer.createGroupMemberWithExpiration("user.test3", true, ZMS_PURGE_MEMBER_EXPIRY_DAYS_DEF - 1));
        groupMembers.add(zmsTestInitializer.createGroupMemberWithExpiration("user.test4", false, memberPurgeExpiryDays));
        groupMembers.add(new GroupMember().setMemberName("user.test5"));

        // domain with configured member purge expiry days
        TopLevelDomain purgeExpiryDaysDom = zmsTestInitializer.createTopLevelDomainObject("test-domain1",
                "Test Domain1", "testOrg", zmsTestInitializer.getAdminUser(), memberPurgeExpiryDays);
        zms.postTopLevelDomain(ctx, auditRef, null, purgeExpiryDaysDom);

        Role role1 = zmsTestInitializer.createRoleObject("test-domain1", "role1", null, roleMembers);
        zms.putRole(ctx,"test-domain1", "role1", auditRef, false, null,  role1);

        Group group1 = zmsTestInitializer.createGroupObject("test-domain1", "group1", groupMembers);
        zms.putGroup(ctx,"test-domain1", "group1", auditRef, false, null,  group1);

        // domain with default member purge expiry days
        TopLevelDomain defaultPurgeExpiryDaysDom = zmsTestInitializer.createTopLevelDomainObject("test-domain2",
                "Test Domain2", "testOrg", zmsTestInitializer.getAdminUser());
        zms.postTopLevelDomain(ctx, auditRef, null, defaultPurgeExpiryDaysDom);

        Role role2 = zmsTestInitializer.createRoleObject("test-domain2", "role2", null, roleMembers);
        zms.putRole(ctx,"test-domain2", "role2", auditRef, false, null,  role2);

        Group group2 = zmsTestInitializer.createGroupObject("test-domain2", "group2", groupMembers);
        zms.putGroup(ctx,"test-domain2", "group2", auditRef, false, null,  group2);

        // domain disabled member purge expiry days
        TopLevelDomain disabledPurgeExpiryDaysDom = zmsTestInitializer.createTopLevelDomainObject("test-domain3",
                "Test Domain3", "testOrg", zmsTestInitializer.getAdminUser(), -1);
        zms.postTopLevelDomain(ctx, auditRef, null, disabledPurgeExpiryDaysDom);
        Role role3 = zmsTestInitializer.createRoleObject("test-domain3", "role3", null, roleMembers);
        zms.putRole(ctx,"test-domain3", "role3", auditRef, false, null,  role3);

        Group group3 = zmsTestInitializer.createGroupObject("test-domain3", "group3", groupMembers);
        zms.putGroup(ctx,"test-domain3", "group3", auditRef, false, null,  group3);
    }

    @Test
    public void testDeleteExpiredMembers() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        insertExpiredMembersToDB(zmsImpl, ctx, auditRef);
        zmsImpl.deleteExpiredMembers(ctx, null, auditRef, false);

        Role role1 = zmsImpl.getRole(ctx, "test-domain1", "role1", null, null, null);
        Group group1 = zmsImpl.getGroup(ctx, "test-domain1", "group1", null, null);
        assertEquals(role1.getRoleMembers().size(), 4);
        assertEquals(group1.getGroupMembers().size(), 4);

        Role role2 = zmsImpl.getRole(ctx, "test-domain2", "role2", null, null, null);
        Group group2 = zmsImpl.getGroup(ctx, "test-domain2", "group2", null, null);
        assertEquals(role2.getRoleMembers().size(), 3);
        assertEquals(group2.getGroupMembers().size(), 3);

        Role role3 = zmsImpl.getRole(ctx, "test-domain3", "role3", null, null, null);
        Group group3 = zmsImpl.getGroup(ctx, "test-domain3", "group3", null, null);
        assertEquals(role3.getRoleMembers().size(), 5);
        assertEquals(group3.getGroupMembers().size(), 5);

        // try with invalid flag

        try {
            zmsImpl.deleteExpiredMembers(ctx, 4, auditRef, false);
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("should be a number in [0-3]"));
        }

        zmsImpl.deleteTopLevelDomain(ctx, "test-domain1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "test-domain2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "test-domain3", auditRef, null);
    }

    @Test
    public void testDeleteExpiredMembersRolesOnly() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        insertExpiredMembersToDB(zmsImpl, ctx, auditRef);
        zmsImpl.deleteExpiredMembers(ctx, 1, auditRef, false);

        Role role1 = zmsImpl.getRole(ctx, "test-domain1", "role1", null, null, null);
        Group group1 = zmsImpl.getGroup(ctx, "test-domain1", "group1", null, null);
        assertEquals(role1.getRoleMembers().size(), 4);
        assertEquals(group1.getGroupMembers().size(), 5);

        Role role2 = zmsImpl.getRole(ctx, "test-domain2", "role2", null, null, null);
        Group group2 = zmsImpl.getGroup(ctx, "test-domain2", "group2", null, null);
        assertEquals(role2.getRoleMembers().size(), 3);
        assertEquals(group2.getGroupMembers().size(), 5);

        Role role3 = zmsImpl.getRole(ctx, "test-domain3", "role3", null, null, null);
        Group group3 = zmsImpl.getGroup(ctx, "test-domain3", "group3", null, null);
        assertEquals(role3.getRoleMembers().size(), 5);
        assertEquals(group3.getGroupMembers().size(), 5);

        zmsImpl.deleteTopLevelDomain(ctx, "test-domain1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "test-domain2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "test-domain3", auditRef, null);
    }

    @Test
    public void testDeleteExpiredMembersGroupsOnly() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        RsrcCtxWrapper ctx = zmsTestInitializer.getMockDomRsrcCtx();
        final String auditRef = zmsTestInitializer.getAuditRef();

        insertExpiredMembersToDB(zmsImpl, ctx, auditRef);
        zmsImpl.deleteExpiredMembers(ctx, 2, auditRef, false);

        Role role1 = zmsImpl.getRole(ctx, "test-domain1", "role1", null, null, null);
        Group group1 = zmsImpl.getGroup(ctx, "test-domain1", "group1", null, null);
        assertEquals(role1.getRoleMembers().size(), 5);
        assertEquals(group1.getGroupMembers().size(), 4);

        Role role2 = zmsImpl.getRole(ctx, "test-domain2", "role2", null, null, null);
        Group group2 = zmsImpl.getGroup(ctx, "test-domain2", "group2", null, null);
        assertEquals(role2.getRoleMembers().size(), 5);
        assertEquals(group2.getGroupMembers().size(), 3);

        Role role3 = zmsImpl.getRole(ctx, "test-domain3", "role3", null, null, null);
        Group group3 = zmsImpl.getGroup(ctx, "test-domain3", "group3", null, null);
        assertEquals(role3.getRoleMembers().size(), 5);
        assertEquals(group3.getGroupMembers().size(), 5);

        zmsImpl.deleteTopLevelDomain(ctx, "test-domain1", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "test-domain2", auditRef, null);
        zmsImpl.deleteTopLevelDomain(ctx, "test-domain3", auditRef, null);
    }

    @Test
    public void testValidateRoleAuditEnabledFlag() {
        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        RoleMeta meta = new RoleMeta().setAuditEnabled(true);
        Domain domain = new Domain().setAuditEnabled(false);

        // this should throw an exception since domain is not audit enabled

        try {
            zmsImpl.validateRoleMetaAuditEnabledFlag(meta, null, domain, "validateRoleAuditEnabledFlag");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Role cannot be set as audit-enabled if the domain is not audit-enabled"));
        }

        // mark the domain as audit-enabled but the role not
        // we should reject it if the role has members

        List<RoleMember> roleMembers = new ArrayList<>();
        roleMembers.add(new RoleMember().setMemberName("user.joe"));
        Role role = new Role().setAuditEnabled(false).setRoleMembers(roleMembers);
        domain.setAuditEnabled(true);

        try {
            zmsImpl.validateRoleMetaAuditEnabledFlag(meta, role, domain, "validateRoleAuditEnabledFlag");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Only system admins can set the role as audit-enabled if it already has members"));
        }

        // if the role is not audit enabled and the list is empty then we're good

        role.setAuditEnabled(false);
        role.setRoleMembers(Collections.emptyList());
        zmsImpl.validateRoleMetaAuditEnabledFlag(meta, role, domain, "validateRoleAuditEnabledFlag");

        // if the role is not audit enabled and the list is null then we're also good

        role.setAuditEnabled(false);
        role.setRoleMembers(null);
        zmsImpl.validateRoleMetaAuditEnabledFlag(meta, role, domain, "validateRoleAuditEnabledFlag");

        // if the role is audit enabled then we're good

        role.setAuditEnabled(true);
        role.setRoleMembers(roleMembers);
        zmsImpl.validateRoleMetaAuditEnabledFlag(meta, role, domain, "validateRoleAuditEnabledFlag");

        // if the role is not audit enabled but the member list is empty then we're good as well

        role.setRoleMembers(Collections.emptyList());
        zmsImpl.validateRoleMetaAuditEnabledFlag(meta, role, domain, "validateRoleAuditEnabledFlag");

        // if meta is set as audit disabled, then it must get the same value as the role

        meta.setAuditEnabled(false);
        role.setAuditEnabled(false);
        zmsImpl.validateRoleMetaAuditEnabledFlag(meta, role, domain, "validateRoleAuditEnabledFlag");
        assertFalse(meta.getAuditEnabled());

        role.setAuditEnabled(true);
        zmsImpl.validateRoleMetaAuditEnabledFlag(meta, role, domain, "validateRoleAuditEnabledFlag");
        assertTrue(meta.getAuditEnabled());
    }

    @Test
    public void testValidateGroupAuditEnabledFlag() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        GroupMeta meta = new GroupMeta().setAuditEnabled(true);
        Domain domain = new Domain().setAuditEnabled(false);

        // this should throw an exception since domain is not audit enabled

        try {
            zmsImpl.validateGroupMetaAuditEnabledFlag(meta, null, domain, "validateGroupAuditEnabledFlag");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Group cannot be set as audit-enabled if the domain is not audit-enabled"));
        }

        // mark the domain as audit-enabled but the group not
        // we should reject it if the group has members

        List<GroupMember> groupMembers = new ArrayList<>();
        groupMembers.add(new GroupMember().setMemberName("user.joe"));
        Group group = new Group().setAuditEnabled(false).setGroupMembers(groupMembers);
        domain.setAuditEnabled(true);

        try {
            zmsImpl.validateGroupMetaAuditEnabledFlag(meta, group, domain, "validateGroupAuditEnabledFlag");
            fail();
        } catch (ResourceException ex) {
            assertTrue(ex.getMessage().contains("Only system admins can set the group as audit-enabled if it already has members"));
        }

        // if the group is not audit enabled but the list empty then we're good

        group.setAuditEnabled(false);
        group.setGroupMembers(Collections.emptyList());
        zmsImpl.validateGroupMetaAuditEnabledFlag(meta, group, domain, "validateGroupAuditEnabledFlag");

        // if the group is not audit enabled and the list is null then we're good

        group.setAuditEnabled(false);
        group.setGroupMembers(null);
        zmsImpl.validateGroupMetaAuditEnabledFlag(meta, group, domain, "validateGroupAuditEnabledFlag");

        // if the group is audit enabled but the list is not empty then we're good

        group.setAuditEnabled(true);
        group.setGroupMembers(groupMembers);
        zmsImpl.validateGroupMetaAuditEnabledFlag(meta, group, domain, "validateGroupAuditEnabledFlag");

        // if the group is not audit enabled but the member list is empty then we're still good

        group.setGroupMembers(Collections.emptyList());
        zmsImpl.validateGroupMetaAuditEnabledFlag(meta, group, domain, "validateGroupAuditEnabledFlag");

        // if meta is set as audit disabled, then it must get the same value as the group

        meta.setAuditEnabled(false);
        group.setAuditEnabled(false);
        zmsImpl.validateGroupMetaAuditEnabledFlag(meta, group, domain, "validateGroupAuditEnabledFlag");
        assertFalse(meta.getAuditEnabled());

        group.setAuditEnabled(true);
        zmsImpl.validateGroupMetaAuditEnabledFlag(meta, group, domain, "validateGroupAuditEnabledFlag");
        assertTrue(meta.getAuditEnabled());
    }

    @Test
    public void testValidateGcpProjectDetails() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();

        assertTrue(zmsImpl.validateGcpProjectDetails("", ""));
        assertTrue(zmsImpl.validateGcpProjectDetails(null, ""));
        assertTrue(zmsImpl.validateGcpProjectDetails("", null));
        assertTrue(zmsImpl.validateGcpProjectDetails(null, null));
        assertTrue(zmsImpl.validateGcpProjectDetails("gcp", "123400"));

        assertFalse(zmsImpl.validateGcpProjectDetails("", "1234"));
        assertFalse(zmsImpl.validateGcpProjectDetails(null, "1234"));
        assertFalse(zmsImpl.validateGcpProjectDetails("1234", ""));
        assertFalse(zmsImpl.validateGcpProjectDetails("1234", null));
    }

    @Test
    public void testValidateResourceOwner() {

        ZMSImpl zmsImpl = zmsTestInitializer.getZms();
        // null values are ok
        zmsImpl.validateResourceOwner(null, "unit-test");
        zmsImpl.validateResourceOwner("", "unit-test");
        // valid values
        zmsImpl.validateResourceOwner("TF", "unit-test");
        zmsImpl.validateResourceOwner("ZTS-Server", "unit-test");
        zmsImpl.validateResourceOwner("ZTS_Server", "unit-test");
        // invalid values
        try {
            zmsImpl.validateResourceOwner("ZTS:Server", "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }
        try {
            zmsImpl.validateResourceOwner("ZTS.Server", "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }
        try {
            zmsImpl.validateResourceOwner("ZTS Server", "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
        }
        final String resourceOwner = "ResourceOwnerLongerThan32Characters";
        try {
            zmsImpl.validateResourceOwner(resourceOwner, "unit-test");
            fail();
        } catch (ResourceException ex) {
            assertEquals(ex.getCode(), 400);
            assertTrue(ex.getMessage().contains("Invalid resource owner: " + resourceOwner +
                " : name length cannot exceed 32 characters"));
        }
    }
}
