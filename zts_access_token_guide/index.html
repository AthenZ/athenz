
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Athenz User Guide">
      
      
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.0.1">
    
    
      
        <title>Obtaining OAuth2 Access Tokens from ZTS - Athenz</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.38780c08.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f72e892.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#accessid-token-request" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Athenz" class="md-header-nav__button md-logo" aria-label="Athenz">
      
  <img src="../images/athenz-icon.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Athenz
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Obtaining OAuth2 Access Tokens from ZTS
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/yahoo/athenz/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Athenz" class="md-nav__button md-logo" aria-label="Athenz">
      
  <img src="../images/athenz-icon.png" alt="logo">

    </a>
    Athenz
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/yahoo/athenz/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Getting Started
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Getting Started
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="About" class="md-nav__link">
      About
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dev_environment/" title="Development Environment" class="md-nav__link">
      Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-3" type="checkbox" id="nav-1-3">
    
    <label class="md-nav__link" for="nav-1-3">
      Local/Development Environment Setup
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Local/Development Environment Setup" data-md-level="2">
      <label class="md-nav__title" for="nav-1-3">
        <span class="md-nav__icon md-icon"></span>
        Local/Development Environment Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zms/" title="ZMS Server" class="md-nav__link">
      ZMS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zts/" title="ZTS Server" class="md-nav__link">
      ZTS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_ui/" title="UI Server" class="md-nav__link">
      UI Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-4" type="checkbox" id="nav-1-4">
    
    <label class="md-nav__link" for="nav-1-4">
      Production Environment Setup
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Production Environment Setup" data-md-level="2">
      <label class="md-nav__title" for="nav-1-4">
        <span class="md-nav__icon md-icon"></span>
        Production Environment Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zms_prod/" title="ZMS Server" class="md-nav__link">
      ZMS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zts_prod/" title="ZTS Server" class="md-nav__link">
      ZTS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_ui_prod/" title="UI Server" class="md-nav__link">
      UI Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-5" type="checkbox" id="nav-1-5">
    
    <label class="md-nav__link" for="nav-1-5">
      Service Identity Registration
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Service Identity Registration" data-md-level="2">
      <label class="md-nav__title" for="nav-1-5">
        <span class="md-nav__icon md-icon"></span>
        Service Identity Registration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials/" title="Using X.509 Certificates" class="md-nav__link">
      Using X.509 Certificates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reg_service_guide/" title="Using Public/Private Key Pairs" class="md-nav__link">
      Using Public/Private Key Pairs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Management
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Management" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../role_delegation/" title="Role Delegation" class="md-nav__link">
      Role Delegation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../token_expiration/" title="Access token Limit Expiry Support" class="md-nav__link">
      Access token Limit Expiry Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../role_cert_expiration/" title="Role Certificate Limit Expiry Support" class="md-nav__link">
      Role Certificate Limit Expiry Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../review_enabled_roles/" title="Review Enabled Roles" class="md-nav__link">
      Review Enabled Roles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../email_notifications/" title="Email Notifications" class="md-nav__link">
      Email Notifications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../member_expiration/" title="Role Member Auto Expiry and Notification Support" class="md-nav__link">
      Role Member Auto Expiry and Notification Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../member_soft_expiration/" title="Role Member Review Reminder Support" class="md-nav__link">
      Role Member Review Reminder Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../self_serve_roles/" title="Self-Served Roles" class="md-nav__link">
      Self-Served Roles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../athenz_templates/" title="Athenz Templates" class="md-nav__link">
      Athenz Templates
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Authentication
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Authentication" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Authentication
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws/" title="Athenz Service Identity X.509 Certificate for AWS EC2 instances" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS EC2 instances
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_ecs/" title="Athenz Service Identity X.509 Certificate for AWS ECS containers" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS ECS containers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_fargate/" title="Athenz Service Identity X.509 Certificate for AWS Fargate tasks" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS Fargate tasks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_eks/" title="Athenz Service Identity X.509 Certificate for AWS EKS pods" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS EKS pods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../service_x509_credentials_aws_lambda/" title="Athenz Service Identity X.509 Certificate for AWS Lambda functions" class="md-nav__link">
      Athenz Service Identity X.509 Certificate for AWS Lambda functions
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Obtaining OAuth2 Access Tokens from ZTS
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="Obtaining OAuth2 Access Tokens from ZTS" class="md-nav__link md-nav__link--active">
      Obtaining OAuth2 Access Tokens from ZTS
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#accessid-token-request" class="md-nav__link">
    Access/ID Token Request
  </a>
  
    <nav class="md-nav" aria-label="Access/ID Token Request">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#request" class="md-nav__link">
    Request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#response" class="md-nav__link">
    Response
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-token-format" class="md-nav__link">
    Access Token format
  </a>
  
    <nav class="md-nav" aria-label="Access Token format">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-token-header" class="md-nav__link">
    Access Token Header
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-token-payload" class="md-nav__link">
    Access Token Payload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-token-validation" class="md-nav__link">
    Access Token Validation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#id-token-format" class="md-nav__link">
    ID Token format
  </a>
  
    <nav class="md-nav" aria-label="ID Token format">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#id-token-header" class="md-nav__link">
    ID Token Header
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-token-payload" class="md-nav__link">
    ID Token Payload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-token-validation" class="md-nav__link">
    ID Token Validation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetching-access-tokens-with-java-client-library" class="md-nav__link">
    Fetching Access Tokens with Java Client Library
  </a>
  
    <nav class="md-nav" aria-label="Fetching Access Tokens with Java Client Library">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zts-client-object" class="md-nav__link">
    ZTS Client Object
  </a>
  
    <nav class="md-nav" aria-label="ZTS Client Object">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#athenz-issued-ca-certificate" class="md-nav__link">
    Athenz Issued CA certificate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obtaining-an-access-token" class="md-nav__link">
    Obtaining an Access Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-caching" class="md-nav__link">
    Token Caching
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#least-privilege-access" class="md-nav__link">
    Least Privilege Access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#command-line-utility-to-fetch-access-tokens" class="md-nav__link">
    Command Line Utility to Fetch Access Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      AWS Setup
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="AWS Setup" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        AWS Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_temp_creds/" title="AWS Temp Credentials" class="md-nav__link">
      AWS Temp Credentials
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_athenz_setup/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_zms_setup/" title="ZMS Server" class="md-nav__link">
      ZMS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_zts_setup/" title="ZTS Server" class="md-nav__link">
      ZTS Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_ui_setup/" title="UI Server" class="md-nav__link">
      UI Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Architecture
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Architecture" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../data_model/" title="Data Model" class="md-nav__link">
      Data Model
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../system_view/" title="System View" class="md-nav__link">
      System View
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../auth_flow/" title="Authorization Flow" class="md-nav__link">
      Authorization Flow
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Features
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Features" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Features
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../copper_argos/" title="Service Identity X.509 Certificates - Copper Argos" class="md-nav__link">
      Service Identity X.509 Certificates - Copper Argos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../capabilities/" title="Athenz Capabilities" class="md-nav__link">
      Athenz Capabilities
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Developer Guide
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Developer Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon"></span>
        Developer Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cent_authz_flow/" title="Centralized Authorization Flow" class="md-nav__link">
      Centralized Authorization Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../decent_authz_flow/" title="Decentralized Authorization Flow" class="md-nav__link">
      Decentralized Authorization Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../client_side_x509_credentials/" title="Client Side Service Identity Authentication" class="md-nav__link">
      Client Side Service Identity Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../server_side_x509_credentials/" title="Server Side Service Identity Authentication" class="md-nav__link">
      Server Side Service Identity Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example_java_centralized_access/" title="Java Client/Servlet Centralized Example" class="md-nav__link">
      Java Client/Servlet Centralized Example
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example_go_centralized_access/" title="Go Client/Server Example" class="md-nav__link">
      Go Client/Server Example
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example_java_decentralized_access/" title="Java Client/Servlet Decentralized Example" class="md-nav__link">
      Java Client/Servlet Decentralized Example
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Customizing Athenz
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Customizing Athenz" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon"></span>
        Customizing Athenz
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../principal_authentication/" title="Principal Authentication" class="md-nav__link">
      Principal Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../private_key_store/" title="Private Key Store" class="md-nav__link">
      Private Key Store
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cert_signer/" title="Certificate Signer" class="md-nav__link">
      Certificate Signer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../copper_argos_dev/" title="Service Identity X.509 Certificate Support Requirements - Copper Argos" class="md-nav__link">
      Service Identity X.509 Certificate Support Requirements - Copper Argos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      User Guide
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="User Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon"></span>
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../zms_client/" title="ZMS Client Utility" class="md-nav__link">
      ZMS Client Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup_zpu/" title="ZPU Utility" class="md-nav__link">
      ZPU Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_rolecert/" title="ZTS Role Certificate Client Utility" class="md-nav__link">
      ZTS Role Certificate Client Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_accesstoken/" title="ZTS OAuth2 Access Token Client" class="md-nav__link">
      ZTS OAuth2 Access Token Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reg_service_guide/" title="Registering ZMS Service Identity" class="md-nav__link">
      Registering ZMS Service Identity
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      References
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="References" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon"></span>
        References
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../zms_api/" title="ZMS REST API" class="md-nav__link">
      ZMS REST API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zts_api/" title="ZTS REST API" class="md-nav__link">
      ZTS REST API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#accessid-token-request" class="md-nav__link">
    Access/ID Token Request
  </a>
  
    <nav class="md-nav" aria-label="Access/ID Token Request">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#request" class="md-nav__link">
    Request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#response" class="md-nav__link">
    Response
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-token-format" class="md-nav__link">
    Access Token format
  </a>
  
    <nav class="md-nav" aria-label="Access Token format">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-token-header" class="md-nav__link">
    Access Token Header
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-token-payload" class="md-nav__link">
    Access Token Payload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-token-validation" class="md-nav__link">
    Access Token Validation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#id-token-format" class="md-nav__link">
    ID Token format
  </a>
  
    <nav class="md-nav" aria-label="ID Token format">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#id-token-header" class="md-nav__link">
    ID Token Header
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-token-payload" class="md-nav__link">
    ID Token Payload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-token-validation" class="md-nav__link">
    ID Token Validation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetching-access-tokens-with-java-client-library" class="md-nav__link">
    Fetching Access Tokens with Java Client Library
  </a>
  
    <nav class="md-nav" aria-label="Fetching Access Tokens with Java Client Library">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zts-client-object" class="md-nav__link">
    ZTS Client Object
  </a>
  
    <nav class="md-nav" aria-label="ZTS Client Object">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#athenz-issued-ca-certificate" class="md-nav__link">
    Athenz Issued CA certificate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obtaining-an-access-token" class="md-nav__link">
    Obtaining an Access Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-caching" class="md-nav__link">
    Token Caching
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#least-privilege-access" class="md-nav__link">
    Least Privilege Access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#command-line-utility-to-fetch-access-tokens" class="md-nav__link">
    Command Line Utility to Fetch Access Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/yahoo/athenz/edit/master/docs/zts_access_token_guide.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Obtaining OAuth2 Access Tokens from ZTS</h1>
                
                <p>Access Tokens are used to authorize access to service provider resources.
The Access Token contains the set of roles (identified in the token as
scopes) a client belongs to for a specified domain. So, when a client wants
to access a resource, this client
must obtain the appropriate Access Token from ZTS and use the token in the
header of the subsequent HTTP client request. If enabled, the service will
also return an ID Token if requested. ID Token identifies the authenticated
principal for a given Athenz Service Identity.</p>
<p>Support for accessing OAuth2 access/id tokens is based on Client Credentials
authentication workflow as defined in <a href="https://tools.ietf.org/html/rfc6749#section-4.4">RFC6749: The OAuth 2.0 Authorization Framework</a>.</p>
<h2 id="accessid-token-request">Access/ID Token Request</h2>
<h3 id="request">Request</h3>
<p>To request an access token from ZTS Server, the client will send a POST
request with <code>application/x-www-form-urlencoded</code> content-type to <code>/oauth2/token</code>
endpoint. The request body must contain the following parameters:</p>
<div class="codehilite"><pre><span></span><code><span class="n">grant_type</span> <span class="o">:</span> <span class="n">Value</span> <span class="n">MUST</span> <span class="n">be</span> <span class="kd">set</span> <span class="n">to</span> <span class="s2">&quot;client_credentials&quot;</span>
<span class="n">scope</span> <span class="o">:</span> <span class="n">list</span> <span class="n">of</span> <span class="n">scopes</span><span class="o">/</span><span class="n">roles</span> <span class="n">requested</span> <span class="k">in</span> <span class="n">the</span> <span class="n">access</span> <span class="n">token</span><span class="o">.</span> <span class="n">The</span> <span class="n">caller</span>
        <span class="n">can</span> <span class="n">either</span> <span class="n">specify</span> <span class="n">to</span> <span class="k">include</span> <span class="n">all</span> <span class="n">roles</span> <span class="n">the</span> <span class="n">principal</span> <span class="n">has</span> <span class="n">access</span>
        <span class="n">to</span> <span class="k">in</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">domain</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span> <span class="o">&lt;</span><span class="n">domain</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;:</span><span class="n">domain</span><span class="o">)</span> <span class="n">or</span> <span class="n">ask</span> <span class="k">for</span>
        <span class="n">specific</span> <span class="n">roles</span> <span class="n">only</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span> <span class="o">&lt;</span><span class="n">domain</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;:</span><span class="n">role</span><span class="o">.&lt;</span><span class="n">role1</span><span class="o">&gt;).</span> <span class="n">Scopes</span>
        <span class="n">are</span> <span class="n">separated</span> <span class="n">by</span> <span class="n">spaces</span><span class="o">.</span>
        <span class="n">To</span> <span class="n">request</span> <span class="n">an</span> <span class="n">ID</span> <span class="n">token</span><span class="o">,</span> <span class="n">the</span> <span class="n">scope</span> <span class="n">must</span> <span class="k">include</span> <span class="s1">&#39;openid&#39;</span> <span class="n">and</span> <span class="n">audience</span>
        <span class="n">service</span> <span class="n">name</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span> <span class="o">&lt;</span><span class="n">domain</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;:</span><span class="n">service</span><span class="o">.&lt;</span><span class="n">service</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;).</span> <span class="n">The</span> <span class="n">domain</span>
        <span class="n">name</span> <span class="k">in</span> <span class="n">id</span> <span class="n">token</span> <span class="n">request</span> <span class="n">match</span> <span class="n">the</span> <span class="n">domain</span> <span class="n">name</span> <span class="k">in</span> <span class="n">the</span> <span class="n">access</span> <span class="n">token</span>
        <span class="n">scope</span><span class="o">.</span>
<span class="n">expires_in</span> <span class="o">:</span> <span class="n">requested</span> <span class="n">expiry</span> <span class="n">time</span> <span class="k">for</span> <span class="n">access</span> <span class="n">token</span> <span class="k">in</span> <span class="n">seconds</span>
</code></pre></div>


<p>For example, when a principal requests an access token only for accessing
<code>demo</code> domain and wants to include all roles it has access to in that
domain, the request would be:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/zts/v1/oauth2/token</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">&lt;zts-address&gt;</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>

grant_type=client_credentials&amp;scope=demo%3Adomain
</code></pre></div>


<p>If the principal requests an access token only for accessing
<code>demo</code> domain and wants to include <code>readers</code> and <code>writers</code> roles it has access
to in that domain, the request would be:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/zts/v1/oauth2/token</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">&lt;zts-address&gt;</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>

grant_type=client_credentials&amp;scope=demo%3Arole.readers+sherpa%3Arole.writers
</code></pre></div>


<p>If the principal requests an access token along with an id token for accessing
<code>demo</code> domain for <code>backend</code> service and wants to include <code>readers</code> and <code>writers</code>
roles it has access to in that domain, the request would be:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/zts/v1/oauth2/token</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">&lt;zts-address&gt;</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>

grant_type=client_credentials&amp;scope=openid+demo%3Aservice.backend+demo%3Arole.readers+demo%3Arole.writers
</code></pre></div>


<h3 id="response">Response</h3>
<p>If the access token request is valid and authorized, the ZTS server issues
an access token (and id token if requested). The response contains the following
json document:</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;access_token&quot;:&quot;&lt;generated-token&gt;&quot;,</span>
<span class="err">  &quot;id_token&quot;:&quot;&lt;generated-token&gt;&quot;,</span>
<span class="err">  &quot;token_type&quot;:&quot;Bearer&quot;,</span>
<span class="err">  &quot;expires_in&quot;:3600</span>
<span class="err">}</span>
</code></pre></div>


<h2 id="access-token-format">Access Token format</h2>
<p>An access token is a <a href="https://tools.ietf.org/html/rfc7519">JSON web token (JWT)</a>
encoded in Base64 URL-encoded format that contains a header, payload, and signature.
An application server can authorize the principal to access specific resources based
on the scopes (roles) defined in the access token.</p>
<h3 id="access-token-header">Access Token Header</h3>
<p>The Access token header contains the Athenz ZTS Server Private key id and the
algorithm used to sign the payload.</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;alg&quot;: &quot;ES256&quot;,</span>
<span class="err">  &quot;kid&quot;: &quot;&lt;zts server private key id&gt;&quot;</span>
<span class="err">}</span>
</code></pre></div>


<h3 id="access-token-payload">Access Token Payload</h3>
<p>The Access Token Payload contains the following claims:</p>
<div class="codehilite"><pre><span></span><code><span class="n">ver</span> <span class="o">:</span> <span class="n">version</span> <span class="n">of</span> <span class="n">the</span> <span class="n">access</span> <span class="n">token</span>
<span class="n">iss</span> <span class="o">:</span> <span class="n">token</span> <span class="n">issuer</span>
<span class="n">aud</span> <span class="o">:</span> <span class="n">the</span> <span class="n">audience</span> <span class="o">(</span><span class="n">the</span> <span class="n">Athenz</span> <span class="n">Domain</span> <span class="n">name</span><span class="o">)</span> <span class="n">that</span> <span class="n">the</span> <span class="n">access</span> <span class="n">token</span> <span class="k">is</span> <span class="n">intended</span> <span class="k">for</span>
<span class="n">uid</span> <span class="o">:</span> <span class="n">unique</span> <span class="n">identifier</span> <span class="k">for</span> <span class="n">the</span> <span class="n">principal</span> <span class="o">(</span><span class="n">same</span> <span class="k">as</span> <span class="n">client</span> <span class="n">Id</span><span class="o">)</span>
<span class="n">sub</span> <span class="o">:</span> <span class="n">subject</span> <span class="n">of</span> <span class="n">the</span> <span class="n">access</span> <span class="n">token</span> <span class="o">(</span><span class="n">same</span> <span class="k">as</span> <span class="n">client</span> <span class="n">Id</span><span class="o">)</span>
<span class="n">iat</span> <span class="o">:</span> <span class="n">token</span> <span class="n">issue</span> <span class="n">time</span> <span class="k">in</span> <span class="n">seconds</span> <span class="o">(</span><span class="n">Unix</span> <span class="n">time</span><span class="o">)</span>
<span class="n">exp</span> <span class="o">:</span> <span class="n">token</span> <span class="n">expiry</span> <span class="n">time</span> <span class="k">in</span> <span class="n">seconds</span> <span class="o">(</span><span class="n">Unix</span> <span class="n">time</span><span class="o">)</span>
<span class="n">scp</span> <span class="o">:</span> <span class="n">array</span> <span class="n">of</span> <span class="n">scopes</span> <span class="n">are</span> <span class="n">granted</span> <span class="n">to</span> <span class="k">this</span> <span class="n">access</span> <span class="n">token</span><span class="o">.</span> <span class="n">This</span> <span class="k">is</span> <span class="n">the</span> <span class="n">list</span> <span class="n">of</span> <span class="n">roles</span> <span class="n">that</span> <span class="n">principal</span> <span class="n">can</span> <span class="n">assume</span> <span class="k">in</span> <span class="n">the</span> <span class="n">audience</span> <span class="n">domain</span>
<span class="n">client_id</span> <span class="o">:</span> <span class="n">client</span> <span class="n">ID</span> <span class="o">(</span><span class="n">Athenz</span> <span class="n">Principal</span><span class="o">)</span> <span class="n">of</span> <span class="n">the</span> <span class="n">client</span> <span class="n">that</span> <span class="n">requested</span> <span class="n">the</span> <span class="n">access</span> <span class="n">token</span>
</code></pre></div>


<p>Here is an example of an access token that <code>alpha.api</code> retrieved to access
some resource in <code>beta</code> domain. The principal <code>alpha.api</code> is authorized
to assume <code>readers</code> and <code>writers</code> roles in the <code>beta</code> domain.</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;ver&quot;: 1,</span>
<span class="err">  &quot;iss&quot;: &quot;athenz&quot;,</span>
<span class="err">  &quot;aud&quot;: &quot;beta&quot;,</span>
<span class="err">  &quot;client_id&quot;: &quot;alpha.api&quot;,</span>
<span class="err">  &quot;uid&quot;: &quot;alpha.api&quot;,</span>
<span class="err">  &quot;sub&quot;: &quot;alpha.api&quot;,</span>
<span class="err">  &quot;iat&quot;: 1554491974,</span>
<span class="err">  &quot;exp&quot;: 1554495574,</span>
<span class="err">  &quot;scp&quot;: [</span>
<span class="err">    &quot;readers&quot;,</span>
<span class="err">    &quot;writers&quot;</span>
<span class="err">  ]</span>
<span class="err">}</span>
</code></pre></div>


<h3 id="access-token-validation">Access Token Validation</h3>
<p>You can use any standards based JWT library to validate the access token
generated by ZTS Server. You can also implement your own verifier by
following the <a href="https://tools.ietf.org/html/rfc7519">RFC7519: Section 7.2:  Validating a JWT</a>.</p>
<h2 id="id-token-format">ID Token format</h2>
<p>An ID token is a <a href="https://tools.ietf.org/html/rfc7519">JSON web token (JWT)</a>
encoded in Base64 URL-encoded format that contains a header, payload, and
signature. The ID token, if enabled, can be issued for clients to authenticate
themselves along with their access token to the requested Athenz service.
ZTS Server never issues ID Tokens on its own. They're always returned along
with access tokens.</p>
<h3 id="id-token-header">ID Token Header</h3>
<p>The ID token header contains the Athenz ZTS Server Private key id and the
algorithm used to sign the payload.</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;alg&quot;: &quot;ES256&quot;,</span>
<span class="err">  &quot;kid&quot;: &quot;&lt;zts server private key id&gt;&quot;</span>
<span class="err">}</span>
</code></pre></div>


<h3 id="id-token-payload">ID Token Payload</h3>
<p>The ID Token Payload contains the following claims:</p>
<div class="codehilite"><pre><span></span><code><span class="n">ver</span> <span class="o">:</span> <span class="n">version</span> <span class="n">of</span> <span class="n">the</span> <span class="n">id</span> <span class="n">token</span>
<span class="n">iss</span> <span class="o">:</span> <span class="n">token</span> <span class="n">issuer</span>
<span class="n">aud</span> <span class="o">:</span> <span class="n">the</span> <span class="n">audience</span> <span class="o">(</span><span class="n">the</span> <span class="n">Athenz</span> <span class="n">Service</span> <span class="n">name</span><span class="o">)</span> <span class="n">that</span> <span class="n">the</span> <span class="n">id</span> <span class="n">token</span> <span class="k">is</span> <span class="n">intended</span> <span class="k">for</span>
<span class="n">sub</span> <span class="o">:</span> <span class="n">subject</span> <span class="n">of</span> <span class="n">the</span> <span class="n">id</span> <span class="n">token</span> <span class="o">-</span> <span class="n">athenz</span> <span class="n">pricnipal</span> <span class="n">name</span> <span class="n">requesting</span> <span class="n">the</span> <span class="n">token</span>
<span class="n">iat</span> <span class="o">:</span> <span class="n">token</span> <span class="n">issue</span> <span class="n">time</span> <span class="k">in</span> <span class="n">seconds</span> <span class="o">(</span><span class="n">Unix</span> <span class="n">time</span><span class="o">)</span>
<span class="n">exp</span> <span class="o">:</span> <span class="n">token</span> <span class="n">expiry</span> <span class="n">time</span> <span class="k">in</span> <span class="n">seconds</span> <span class="o">(</span><span class="n">Unix</span> <span class="n">time</span><span class="o">)</span>
<span class="n">auth_time</span><span class="o">:</span> <span class="n">authentication</span> <span class="n">time</span> <span class="k">in</span> <span class="n">seconds</span> <span class="o">(</span><span class="n">Unix</span> <span class="n">time</span><span class="o">)</span>
</code></pre></div>


<p>Here is an example of an id token that <code>alpha.api</code> retrieved for its
authorization request to <code>beta.backend</code> service.</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;ver&quot;: 1,</span>
<span class="err">  &quot;iss&quot;: &quot;athenz&quot;,</span>
<span class="err">  &quot;aud&quot;: &quot;beta.backend&quot;,</span>
<span class="err">  &quot;sub&quot;: &quot;alpha.api&quot;,</span>
<span class="err">  &quot;iat&quot;: 1554491974,</span>
<span class="err">  &quot;auth_time&quot;: 1554491974,</span>
<span class="err">  &quot;exp&quot;: 1554495574</span>
<span class="err">}</span>
</code></pre></div>


<h3 id="id-token-validation">ID Token Validation</h3>
<p>You can use any standards based JWT library to validate the id token
generated by ZTS Server. You can also implement your own verifier by
following the <a href="https://tools.ietf.org/html/rfc7519">RFC7519: Section 7.2:  Validating a JWT</a>.</p>
<h2 id="fetching-access-tokens-with-java-client-library">Fetching Access Tokens with Java Client Library</h2>
<p>First you need to update your Java project <code>pom.xml</code> file to indicate
the dependency on the Athenz zts java client library. Checkout the
<a href="https://bintray.com/yahoo/maven/athenz-zts-java-client/">Bintray ZTS Java Client Package</a>
page to make sure you're using the latest release version (You must use
1.8.37 or newer version of the client library). </p>
<h3 id="zts-client-object">ZTS Client Object</h3>
<p>ZTS Client Library provides several constructors. The recommended
approach is to use an SSL context that includes service's Athenz
issued CA certificate.</p>
<p>ZTSClient object must be closed to release any allocated resources.
ZTSClient class implements Closeable interface. However, to correctly
handle auto-refresh of access tokens, the client used to fetch
the token cannot be closed since the background tasks need to use
the same client to refresh the access token. Our general recommendation
is that you create a single ZTSClient object and use that for all
requests (it is thread safe) and then close the client when your
application is shutting down.</p>
<p><strong> Important </strong></p>
<p>During the shutdown of the application, <code>ZTSClient.cancelPrefetch()</code>
must be called to stop the timer thread that automatically fetches
and refreshes any cached tokens in the ZTS Client.</p>
<h4 id="athenz-issued-ca-certificate">Athenz Issued CA certificate</h4>
<p>You will need to provide the ZTSClient with the ZTS Server's URL and an SSLContext.
The following examples will show how to generate an SSLContext</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Constructs a new ZTSClient object with the given SSLContext object</span>
<span class="cm"> * and ZTS Server Url. Default read and connect timeout values are</span>
<span class="cm"> * 30000ms (30sec). The application can change these values by using the</span>
<span class="cm"> * athenz.zts.client.read_timeout and athenz.zts.client.connect_timeout</span>
<span class="cm"> * system properties. The values specified for timeouts must be in milliseconds.</span>
<span class="cm"> * @param ztsUrl ZTS Server&#39;s URL</span>
<span class="cm"> * @param sslContext SSLContext that includes service&#39;s private key and x.509 certificate</span>
<span class="cm"> * for authenticating requests</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="nf">ZTSClient</span><span class="p">(</span><span class="n">String</span> <span class="n">ztsUrl</span><span class="p">,</span> <span class="n">SSLContext</span> <span class="n">sslContext</span><span class="p">);</span>
</code></pre></div>


<p>First update your <code>pom.xml</code> to include dependency on <code>athenz-cert-refresher</code> package
which provides support to create a SSLContext object based on our private key
and certificate:</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="p">.</span><span class="na">yahoo</span><span class="p">.</span><span class="na">athenz</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">athenz</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">refresher</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="n">VERSION</span><span class="o">-</span><span class="n">NUMBER</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre></div>


<p>The SSLContext contains a KeyRefresher with the following arguments:
   - The service private key
   - The service public key
   - The path of the truststore containing the CA certificate
   - The password for the truststore containing the CA certificate</p>
<p>For example:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Create our SSL Context object based on our private key and</span>
<span class="c1">// certificate and jdk truststore</span>

<span class="n">KeyRefresher</span> <span class="n">keyRefresher</span> <span class="o">=</span> <span class="n">Utils</span><span class="p">.</span><span class="na">generateKeyRefresher</span><span class="p">(</span><span class="n">trustStorePath</span><span class="p">,</span> <span class="n">trustStorePassword</span><span class="p">,</span>
    <span class="n">certPath</span><span class="p">,</span> <span class="n">keyPath</span><span class="p">);</span>
<span class="n">SSLContext</span> <span class="n">sslContext</span> <span class="o">=</span> <span class="n">Utils</span><span class="p">.</span><span class="na">buildSSLContext</span><span class="p">(</span><span class="n">keyRefresher</span><span class="p">.</span><span class="na">getKeyManagerProxy</span><span class="p">(),</span>
    <span class="n">keyRefresher</span><span class="p">.</span><span class="na">getTrustManagerProxy</span><span class="p">());</span>
<span class="n">keyRefresher</span><span class="p">.</span><span class="na">startup</span><span class="p">();</span>

<span class="n">ZTSClient</span> <span class="n">ztsClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZTSClient</span><span class="p">(</span><span class="n">ztsUrl</span><span class="p">,</span> <span class="n">sslContext</span><span class="p">);</span>
</code></pre></div>


<h3 id="obtaining-an-access-token">Obtaining an Access Token</h3>
<p>To obtain an Access Token, the application would use the following method
from the <code>ZTSClient</code> class:</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * For the specified requester(user/service) return the corresponding Access Token that</span>
<span class="cm"> * includes the list of roles that the principal has access to in the specified domain</span>
<span class="cm"> * @param domainName name of the domain</span>
<span class="cm"> * @param roleNames (optional) only interested in roles with these names</span>
<span class="cm"> * @param expiryTime (optional) specifies that the returned Access must be</span>
<span class="cm"> *          at least valid for specified number of seconds. Pass 0 to use</span>
<span class="cm"> *          server default timeout.</span>
<span class="cm"> * @return ZTS generated Access Token Response object. ZTSClientException will be thrown in case of failure</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="n">AccessTokenResponse</span> <span class="nf">getAccessToken</span><span class="p">(</span><span class="n">String</span> <span class="n">domainName</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">roleNames</span><span class="p">,</span> <span class="kt">long</span> <span class="n">expiryTime</span><span class="p">);</span>
</code></pre></div>


<p>In the simplest case, the method only requires the caller to specify the
domain that the application will be accessing. Thus, it needs an Access
Token for that domain. For example, if the <code>alpha.storage</code> service
identifier is trying to access a resource from a domain <code>beta</code>, then
the API call to retrieve the access token valid for 4 hours would be the following:</p>
<div class="codehilite"><pre><span></span><code><span class="n">AccessTokenResponse</span> <span class="n">tokenResponse</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
   <span class="n">tokenResponse</span> <span class="o">=</span> <span class="n">ztsClient</span><span class="p">.</span><span class="na">getAccessToken</span><span class="p">(</span><span class="s">&quot;beta&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">14400</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ZTSClientException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// log error using ex.getCode() and ex.getMessage()</span>
<span class="p">}</span>
<span class="kd">final</span> <span class="n">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">tokenResponse</span><span class="p">.</span><span class="na">getAccess_token</span><span class="p">();</span>
</code></pre></div>


<p>Then the client will include the retrieved Access Token value as one of
its headers when submitting its request to the provider service.</p>
<h3 id="token-caching">Token Caching</h3>
<p>The ZTS Client Library automatically caches any tokens returned by the
ZTS Server, so any subsequent requests for an Access Token for the same
domain are fulfilled from the local cache as opposed to connecting to
the ZTS Server every time. This provides better performance by reusing
the same Access Token because they’re valid for two hours by default. The
client library will only return cached Access Tokens if they’re valid for
at least 1/4 of the requested timeout in minutes (default 30 minutes).</p>
<h3 id="least-privilege-access">Least Privilege Access</h3>
<p>By default, the method <code>getAccess</code> returns all the roles that the
given service identity can access within a domain. The method, however,
has the <code>roleNames</code> parameter that allow applications to request access tokens
for specific roles within a domain. Thus, the server need only check and
return an access token for the specified roles. For example, the service
has access to several roles within the <code>alpha</code> domain but is only interested
in two roles <code>readers</code> and <code>searchers</code>. With this use case, the api call
would be:</p>
<div class="codehilite"><pre><span></span><code><span class="n">AccessTokenResponse</span> <span class="n">tokenResponse</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">roles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">roles</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;readers);</span>
<span class="s">roles.add(&quot;</span><span class="n">searchers</span><span class="s">&quot;);</span>

<span class="s">try {</span>
<span class="s">   tokenResponse = ztsClient.getAccessToken(&quot;</span><span class="n">alpha</span><span class="err">&quot;</span><span class="p">,</span> <span class="n">roles</span><span class="p">,</span> <span class="mi">14400</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ZTSClientException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// log error using ex.getCode() and ex.getMessage()</span>
<span class="p">}</span>
<span class="kd">final</span> <span class="n">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">tokenResponse</span><span class="p">.</span><span class="na">getAccess_token</span><span class="p">();</span>
</code></pre></div>


<h2 id="command-line-utility-to-fetch-access-tokens">Command Line Utility to Fetch Access Tokens</h2>
<p>Athenz team also provides a command line utility called <code>zts-accesstoken</code>
that can be used to fetch access/id tokens from the ZTS Server for a given domain
and/or specific roles.</p>
<div class="codehilite"><pre><span></span><code>$ zts-accesstoken -domain alpha.prod -service api -svc-key-file beta.api.key.pem -svc-cert-file beta.api.cert.pem -zts https://&lt;zts-address&gt;/zts/v1
</code></pre></div>


<p>Check out the <a href="../zts_accesstoken/">zts-accesstoken</a> user guide for full details.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>When communicating with ZTS Server to obtain an Access Token, the ZTS Server
will return the following 4xx error codes if it's unable to successfully
process the request:</p>
<ul>
<li><strong>400</strong> The domain name specified in the request to issue an access token
    is inconsistent with other scopes.</li>
<li><strong>401</strong> The request could not be successfully authenticated.</li>
<li><strong>403</strong> The service identity does not have access to any resources
    in the specified domain.</li>
<li><strong>404</strong> The domain specified in the request to issue an Access Token for
    does not exist.</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../service_x509_credentials_aws_lambda/" title="Athenz Service Identity X.509 Certificate for AWS Lambda functions" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Athenz Service Identity X.509 Certificate for AWS Lambda functions
              </div>
            </div>
          </a>
        
        
          <a href="../aws_temp_creds/" title="AWS Temp Credentials" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                AWS Temp Credentials
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.77e55a48.min.js"></script>
      <script src="../assets/javascripts/bundle.aa3f9871.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>